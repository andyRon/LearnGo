Kuberneteså…¥é—¨å®æˆ˜è¯¾
---

https://time.geekbang.org/column/intro/100114501

å‘å¸ƒæ—¶é—´ï¼š2022

é…å¥—çš„å­¦ä¹ é¡¹ç›®ï¼šhttps://github.com/chronolaw/k8s_study

## å‰è¨€

ç°åœ¨Kuberneteså·²ç»æ²¡æœ‰äº†å®é™…æ„ä¹‰ä¸Šçš„ç«äº‰å¯¹æ‰‹ï¼Œå®ƒçš„åœ°ä½å°±å¦‚åŒLinuxä¸€æ ·ï¼Œæˆä¸ºäº†äº‹å®ä¸Šçš„äº‘åŸç”Ÿæ“ä½œç³»ç»Ÿï¼Œæ˜¯æ„å»ºç°ä»£åº”ç”¨çš„åŸºçŸ³ã€‚

ç°ä»£åº”ç”¨æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯å¾®æœåŠ¡ï¼Œæ˜¯æœåŠ¡ç½‘æ ¼ï¼Œè¿™äº›ç»Ÿç»Ÿè¦å›´ç»•ç€å®¹å™¨æ¥å¼€å‘ã€éƒ¨ç½²å’Œè¿è¡Œï¼Œè€Œä½¿ç”¨å®¹å™¨å°±å¿…ç„¶è¦ç”¨åˆ°å®¹å™¨ç¼–æ’æŠ€æœ¯ï¼Œåœ¨ç°åœ¨åªæœ‰å”¯ä¸€çš„é€‰é¡¹ï¼Œé‚£å°±æ˜¯Kubernetesã€‚

```
 ;
 ;
 ;
```



### å­¦ä¹ Kubernetesæœ‰å“ªäº›éš¾ç‚¹

Kubernetesæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ã€é›†ç¾¤åŒ–ã€äº‘æ—¶ä»£çš„ç³»ç»Ÿï¼Œæœ‰è®¸å¤šæ–°æ¦‚å¿µå’Œæ–°æ€ç»´æ–¹å¼ï¼Œå’Œæˆ‘ä»¬ä»¥å¾€ç»éªŒã€è®¤çŸ¥çš„å·®å¼‚å¾ˆå¤§ã€‚

KubernetesæŠ€æœ¯æ ˆçš„ç‰¹ç‚¹ï¼Œå››ä¸ªå­—æ¦‚æ‹¬ï¼šâ€œ**æŠ€æœ¯æ–°ã€é¢†åŸŸå¹¿ã€å®ç°æ‚ã€æ–¹å‘æ·±**â€

- â€œ**æ–°**â€æ˜¯æŒ‡Kubernetesç”¨åˆ°çš„åŸºæœ¬ä¸Šéƒ½æ˜¯æ¯”è¾ƒå‰æ²¿ã€é™Œç”Ÿçš„æŠ€æœ¯ï¼Œè€Œä¸”ç‰ˆæœ¬å‡çº§å¾ˆå¿«ï¼Œç»å¸¸å˜æ¥å˜å»ã€‚
- â€œ**å¹¿**â€æ˜¯æŒ‡Kubernetesæ¶‰åŠçš„åº”ç”¨é¢†åŸŸå¾ˆå¤šã€è¦†ç›–é¢éå¸¸å¹¿ï¼Œä¸å¤ªå¥½æ‰¾åˆ°åˆé€‚çš„åˆ‡å…¥ç‚¹æˆ–è€…çªç ´å£ã€‚
- â€œ**æ‚**â€æ˜¯æŒ‡Kubernetesçš„å„ç§å®ç°æ¯”è¾ƒæ‚ä¹±ï¼Œè°éƒ½å¯ä»¥ä¸Šæ¥â€œæºå’Œâ€ä¸€ä¸‹ï¼Œè®©äººçœ‹çš„çœ¼æ™•ã€‚
- â€œ**æ·±**â€æ˜¯æŒ‡Kubernetesé¢å¯¹çš„æ¯ä¸ªå…·ä½“é—®é¢˜å’Œæ–¹å‘ï¼Œéƒ½éœ€è¦æœ‰å¾ˆæ·±çš„æŠ€æœ¯èƒŒæ™¯å’Œåº•è•´ï¼Œæƒ³è¦åƒé€å¾ˆä¸å®¹æ˜“ã€‚





å¦‚æœä½ çœŸæƒ³åšKuberneteså¼€å‘ï¼Œç­‰å­¦ä¼šäº†Kubernetesçš„åŸºæœ¬æ¦‚å¿µå’Œç”¨æ³•ï¼Œå†å›å¤´å»å­¦Goè¯­è¨€ä¹Ÿå®Œå…¨æ¥å¾—åŠã€‚

å­¦ä¹ Kubernetesæœ€å¥½çš„æ–¹å¼æ˜¯**å°½å¿«å»ºç«‹ä¸€ä¸ªå…¨å±€è§‚å’Œå¤§å±€è§‚ï¼Œç­‰åˆ°ä½ å¯¹è¿™ä¸ªé™Œç”Ÿé¢†åŸŸçš„å…¨è²Œæœ‰äº†ç²—ç•¥ä½†å®Œæ•´çš„è®¤è¯†ä¹‹åï¼Œå†æŒ‘é€‰ä¸€ä¸ªè‡ªå·±æ„Ÿå…´è¶£çš„æ–¹å‘å»ç ”ç©¶ï¼Œæ‰æ˜¯æ€§ä»·æ¯”æœ€é«˜çš„åšæ³•**ã€‚



2022å¹´åˆå‘å¸ƒçš„Kubernetes 1.23.3ï¼Œæ˜¯æœ€åä¸€ä¸ªæ”¯æŒDockerçš„å¤§ç‰ˆæœ¬ï¼Œæ‰¿ä¸Šå¯ä¸‹ï¼Œå…·æœ‰å¾ˆå¤šçš„æ–°ç‰¹æ€§ï¼ŒåŒæ—¶ä¹Ÿä¿ç•™äº†è¶³å¤Ÿçš„å†å²å…¼å®¹æ€§ï¼Œéå¸¸é€‚åˆç”¨æ¥å­¦ä¹ Kubernetesã€‚

## åŠ¨æ‰‹å®è·µæ‰æ˜¯æœ€å¥½çš„å­¦ä¹ æ–¹å¼



Ubuntu 22.04 Jammy Jellyfish æ¡Œé¢ç‰ˆï¼ˆhttps://ubuntu.com/download/desktopï¼‰ï¼Œå®ƒæœ‰è¶³å¤Ÿæ–°çš„ç‰¹æ€§ï¼Œéå¸¸é€‚åˆè¿è¡ŒKubernetesï¼Œè€Œå†…ç½®çš„æµè§ˆå™¨ã€ç»ˆç«¯ç­‰å·¥å…·ä¹Ÿå¾ˆæ–¹ä¾¿æˆ‘ä»¬çš„è°ƒè¯•å’Œæµ‹è¯•ã€‚





# å…¥é—¨

## 1 åˆè¯†å®¹å™¨

### Dockerçš„è¯ç”Ÿ

é™¤äº† Dockerï¼Œå…¶ä»–å®¹å™¨æŠ€æœ¯è¿˜æœ‰ Kataã€gVisorã€rktã€podman ç­‰ï¼Œä½†éƒ½ä¸å¦‚ Docker æµè¡Œã€‚



æˆ‘ä»¬è¿˜å¯ä»¥é€‰æ‹©ä» Docker è½¯ä»¶ä»“åº“ï¼Œè€Œä¸æ˜¯Ubuntu è½¯ä»¶ä»“åº“æ¥å®‰è£… Docker Engine,Docker æä¾›äº†å®˜æ–¹çš„å®‰è£…è„šæœ¬ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ `curl -fsSL
https://get.docker.com | bash -s docker`ã€‚ç”¨â€œdocker versionâ€ ä¼šçœ‹åˆ°æœ‰â€œDocker Engine - Communityâ€çš„ä¿¡æ¯ï¼Œè¡¨ç¤ºç¤¾åŒºç‰ˆæœ¬ï¼ˆç›¸åº”åœ°è¿˜ä¼šæœ‰ä¸€ä¸ªä»˜è´¹çš„â€œDocker Engine - Enterpriseâ€ï¼‰ã€‚

busybox æ˜¯ä¸€ä¸ªå°å·§ç²¾è‡´çš„â€œå·¥å…·ç®±â€ï¼ŒæŠŠè¯¸å¤šLinux å‘½ä»¤æ•´åˆåœ¨ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶é‡Œï¼Œä½“ç§¯ä¸€èˆ¬ä¸è¶…è¿‡2MBï¼Œéå¸¸é€‚åˆæµ‹è¯•ä»»åŠ¡æˆ–è€…åµŒå…¥å¼ç³»ç»Ÿã€‚

Mobyæ˜¯åŸæ¥çš„Docker å¼€æºé¡¹ç›®ï¼Œå› ä¸º Docker å·²ç»æˆä¸ºäº†æ³¨å†Œå•†æ ‡ï¼Œæ‰€ä»¥åœ¨ 2017å¹´æ”¹äº†åå­—ï¼Œä½œä¸ºç›®å‰ Docker äº§å“çš„è¯•éªŒä¸Šæ¸¸è€Œå­˜åœ¨ï¼Œç±»ä¼¼ Fedora ä¸ CentOS/RHEL çš„å…³ç³»ã€‚

### Dockerçš„å½¢æ€

Docker Desktopä¹‹å‰ä¸€ç›´æ˜¯å¯ä»¥å…è´¹ä½¿ç”¨çš„ï¼Œä½†åœ¨2021å¹´8æœˆ31æ—¥ï¼ŒDocker å…¬å¸æ”¹å˜äº†ç­–ç•¥ï¼Œåªå¯¹ä¸ªäººã€æ•™è‚²å’Œå°å‹å…¬å¸å…è´¹ï¼Œå…¶ä»–å½¢å¼çš„å•†ä¸šä½¿ç”¨éœ€è¦é‡‡ç”¨è®¢é˜…åˆ¶ä»˜è´¹ã€‚

äº‹å®ä¸Šï¼ŒDocker Desktop å†…éƒ¨åŒ…å«äº† Docker Engineï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒDocker Engineæ˜¯Docker Desktopçš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ã€‚



### Dockerçš„å®‰è£…



```
{
    "dns": ["8.8.8.8", "8.8.4.4"],
    "registry-mirrors": [
        "https://docker.m.daocloud.io/",
        "https://huecker.io/",
        "https://dockerhub.timeweb.cloud",
        "https://noohub.ru/",
        "https://dockerproxy.com",
        "https://docker.mirrors.ustc.edu.cn",
        "https://docker.nju.edu.cn",
        "https://xx4bwyg2.mirror.aliyuncs.com",
        "http://f1361db2.m.daocloud.io",
        "https://registry.docker-cn.com",
        "http://hub-mirror.c.163.com"
    ]
}
```

### Dockerçš„ä½¿ç”¨

### Dockerçš„æ¶æ„



## 2 è¢«éš”ç¦»çš„è¿›ç¨‹ï¼šå®¹å™¨çš„æœ¬è´¨

å¹¿ä¹‰ä¸Šæ¥è¯´ï¼Œå®¹å™¨æŠ€æœ¯æ˜¯åŠ¨æ€çš„å®¹å™¨ã€é™æ€çš„é•œåƒå’Œè¿œç«¯çš„ä»“åº“è¿™ä¸‰è€…çš„ç»„åˆã€‚

### å®¹å™¨åˆ°åº•æ˜¯ä»€ä¹ˆ

é›†è£…ç®±çš„ä½œç”¨æ˜¯æ ‡å‡†åŒ–å°è£…å„ç§è´§ç‰©ï¼Œä¸€æ—¦æ‰“åŒ…å®Œæˆä¹‹åï¼Œå°±å¯ä»¥ä»ä¸€ä¸ªåœ°æ–¹è¿ç§»åˆ°ä»»æ„çš„å…¶ä»–åœ°æ–¹ã€‚ç›¸æ¯”æ•£è£…å½¢å¼è€Œè¨€ï¼Œé›†è£…ç®±éš”ç¦»äº†ç®±å†…ç®±å¤–ä¸¤ä¸ªä¸–ç•Œï¼Œä¿æŒäº†è´§ç‰©çš„åŸå§‹å½¢æ€ï¼Œé¿å…äº†å†…å¤–éƒ¨ç›¸äº’å¹²æ‰°ï¼Œæå¤§åœ°ç®€åŒ–äº†å•†å“çš„å­˜å‚¨ã€è¿è¾“ã€ç®¡ç†ç­‰å·¥ä½œã€‚

è®¡ç®—æœºä¸–ç•Œï¼Œå®¹å™¨ä¹Ÿå‘æŒ¥ç€åŒæ ·çš„ä½œç”¨ï¼Œä¸è¿‡å®ƒå°è£…çš„è´§ç‰©æ˜¯è¿è¡Œä¸­çš„**åº”ç”¨ç¨‹åº**ï¼Œä¹Ÿå°±æ˜¯**è¿›ç¨‹**ï¼ŒåŒæ ·å®ƒä¹Ÿä¼šæŠŠè¿›ç¨‹ä¸å¤–ç•Œéš”ç¦»å¼€ï¼Œè®©è¿›ç¨‹ä¸å¤–éƒ¨ç³»ç»Ÿäº’ä¸å½±å“ã€‚

```sh
docker pull ubuntu:18.04
docker run -it ubuntu:18.04 sh

# ä¸‹é¢çš„å‘½ä»¤éƒ½æ˜¯åœ¨å®¹å™¨å†…æ‰§è¡Œ
cat /etc/os-release
apt update
apt install -y wget redis
redis-server &
```



### ä¸ºä»€ä¹ˆè¦éš”ç¦»

è®¡ç®—æœºä¸–ç•Œé‡Œçš„éš”ç¦»ç›®çš„ä¹Ÿæ˜¯**ç³»ç»Ÿå®‰å…¨**ã€‚

å¯¹äºLinuxæ“ä½œç³»ç»Ÿæ¥è¯´ï¼Œä¸€ä¸ªä¸å—ä»»ä½•é™åˆ¶çš„åº”ç”¨ç¨‹åºæ˜¯ååˆ†å±é™©çš„ã€‚è¿™ä¸ªè¿›ç¨‹èƒ½å¤Ÿçœ‹åˆ°ç³»ç»Ÿé‡Œ**æ‰€æœ‰çš„æ–‡ä»¶ã€æ‰€æœ‰çš„è¿›ç¨‹ã€æ‰€æœ‰çš„ç½‘ç»œæµé‡ï¼Œè®¿é—®å†…å­˜é‡Œçš„ä»»ä½•æ•°æ®**ï¼Œé‚£ä¹ˆæ¶æ„ç¨‹åºå¾ˆå®¹æ˜“å°±ä¼šæŠŠç³»ç»Ÿæç˜«ç—ªï¼Œæ­£å¸¸ç¨‹åºä¹Ÿå¯èƒ½ä¼šå› ä¸ºæ— æ„çš„Bugå¯¼è‡´ä¿¡æ¯æ³„æ¼æˆ–è€…å…¶ä»–å®‰å…¨äº‹æ•…ã€‚è™½ç„¶Linuxæä¾›äº†ç”¨æˆ·æƒé™æ§åˆ¶ï¼Œèƒ½å¤Ÿé™åˆ¶è¿›ç¨‹åªè®¿é—®æŸäº›èµ„æºï¼Œä½†è¿™ä¸ªæœºåˆ¶è¿˜æ˜¯æ¯”è¾ƒè–„å¼±çš„ï¼Œå’ŒçœŸæ­£çš„â€œéš”ç¦»â€éœ€æ±‚ç›¸å·®å¾—å¾ˆè¿œã€‚

**ä½¿ç”¨å®¹å™¨æŠ€æœ¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®©åº”ç”¨ç¨‹åºè¿è¡Œåœ¨ä¸€ä¸ªæœ‰ä¸¥å¯†é˜²æŠ¤çš„â€œæ²™ç›’â€ï¼ˆSandboxï¼‰ç¯å¢ƒä¹‹å†…**ã€‚

**å®¹å™¨æŠ€æœ¯çš„å¦ä¸€ä¸ªæœ¬é¢†å°±æ˜¯ä¸ºåº”ç”¨ç¨‹åºåŠ ä¸Š==èµ„æºéš”ç¦»==ï¼Œåœ¨ç³»ç»Ÿé‡Œåˆ‡åˆ†å‡ºä¸€éƒ¨åˆ†èµ„æºï¼Œè®©å®ƒåªèƒ½ä½¿ç”¨æŒ‡å®šçš„é…é¢**ã€‚

### ä¸è™šæ‹Ÿæœºçš„åŒºåˆ«æ˜¯ä»€ä¹ˆ

å®¹å™¨å’Œè™šæ‹Ÿæœºé¢å¯¹çš„éƒ½æ˜¯ç›¸åŒçš„é—®é¢˜ï¼Œä½¿ç”¨çš„ä¹Ÿéƒ½æ˜¯è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œåªæ˜¯æ‰€åœ¨çš„**å±‚æ¬¡**ä¸åŒã€‚

![](images/b734f7d91bda055236b3467bc16f6302.jpg)

ï¼ˆè¿™å›¾å¹¶ä¸å¤ªå‡†ç¡®ï¼Œå®¹å™¨å¹¶ä¸ç›´æ¥è¿è¡Œåœ¨Dockerä¸Šï¼ŒDockeråªæ˜¯==è¾…åŠ©å»ºç«‹éš”ç¦»ç¯å¢ƒ==ï¼Œè®©å®¹å™¨åŸºäºLinuxæ“ä½œç³»ç»Ÿè¿è¡Œï¼‰

å®¹å™¨å’Œè™šæ‹Ÿæœºçš„ç›®çš„éƒ½æ˜¯éš”ç¦»èµ„æºï¼Œä¿è¯ç³»ç»Ÿå®‰å…¨ï¼Œç„¶åæ˜¯å°½é‡æé«˜èµ„æºçš„åˆ©ç”¨ç‡ã€‚

åœ¨æ•°æ®ä¸­å¿ƒçš„æœåŠ¡å™¨ä¸Šï¼Œè™šæ‹Ÿæœºè½¯ä»¶ï¼ˆå³å›¾ä¸­çš„`Hypervisor`ï¼‰åŒæ ·å¯ä»¥æŠŠä¸€å°ç‰©ç†æœåŠ¡å™¨è™šæ‹Ÿæˆå¤šå°é€»è¾‘æœåŠ¡å™¨ï¼Œè¿™äº›é€»è¾‘æœåŠ¡å™¨å½¼æ­¤ç‹¬ç«‹ï¼Œå¯ä»¥æŒ‰éœ€åˆ†éš”ç‰©ç†æœåŠ¡å™¨çš„èµ„æºï¼Œä¸ºä¸åŒçš„ç”¨æˆ·æ‰€ä½¿ç”¨ã€‚

ä»å®ç°çš„è§’åº¦æ¥çœ‹ï¼Œè™šæ‹Ÿæœºè™šæ‹ŸåŒ–å‡ºæ¥çš„æ˜¯**ç¡¬ä»¶**ï¼Œéœ€è¦åœ¨ä¸Šé¢å†å®‰è£…ä¸€ä¸ª**æ“ä½œç³»ç»Ÿ**åæ‰èƒ½å¤Ÿè¿è¡Œåº”ç”¨ç¨‹åºï¼Œè€Œç¡¬ä»¶è™šæ‹ŸåŒ–å’Œæ“ä½œç³»ç»Ÿéƒ½æ¯”è¾ƒâ€œé‡â€ï¼Œä¼šæ¶ˆè€—å¤§é‡çš„CPUã€å†…å­˜ã€ç¡¬ç›˜ç­‰ç³»ç»Ÿèµ„æºï¼Œä½†è¿™äº›æ¶ˆè€—å…¶å®å¹¶æ²¡æœ‰å¸¦æ¥ä»€ä¹ˆä»·å€¼ï¼Œå±äºâ€œé‡å¤åŠ³åŠ¨â€å’Œâ€œæ— ç”¨åŠŸâ€ï¼Œä¸è¿‡å¥½å¤„å°±æ˜¯éš”ç¦»ç¨‹åº¦éå¸¸é«˜ï¼Œæ¯ä¸ªè™šæ‹Ÿæœºä¹‹é—´å¯ä»¥åšåˆ°å®Œå…¨æ— å¹²æ‰°ã€‚

è€Œ**å®¹å™¨ï¼ˆDockerï¼‰ç›´æ¥åˆ©ç”¨äº†ä¸‹å±‚çš„è®¡ç®—æœºç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿ**ï¼Œå› ä¸ºæ¯”è™šæ‹Ÿæœºå°‘äº†ä¸€å±‚ï¼Œæ‰€ä»¥è‡ªç„¶å°±ä¼šèŠ‚çº¦CPUå’Œå†…å­˜ï¼Œæ˜¾å¾—éå¸¸è½»é‡çº§ï¼Œèƒ½å¤Ÿæ›´é«˜æ•ˆåœ°åˆ©ç”¨ç¡¬ä»¶èµ„æºã€‚

![](images/image-20240721194449779.png)



### éš”ç¦»æ˜¯æ€ä¹ˆå®ç°çš„

å®¹å™¨éš”ç¦»å¥¥ç§˜å°±åœ¨äºLinuxæ“ä½œç³»ç»Ÿå†…æ ¸ä¹‹ä¸­ï¼Œä¸ºèµ„æºéš”ç¦»æä¾›äº†ä¸‰ç§æŠ€æœ¯ï¼š**namespaceã€cgroupã€chroot**ï¼Œè™½ç„¶è¿™ä¸‰ç§æŠ€æœ¯çš„åˆè¡·å¹¶ä¸æ˜¯ä¸ºäº†å®ç°å®¹å™¨ï¼Œä½†å®ƒä»¬ä¸‰ä¸ªç»“åˆåœ¨ä¸€èµ·å°±ä¼šå‘ç”Ÿå¥‡å¦™çš„â€œåŒ–å­¦ååº”â€ã€‚

- ==namespace==æ˜¯2002å¹´ä»Linux 2.4.19å¼€å§‹å‡ºç°çš„ï¼Œå’Œç¼–ç¨‹è¯­è¨€é‡Œçš„namespaceæœ‰ç‚¹ç±»ä¼¼ï¼Œå®ƒå¯ä»¥åˆ›å»ºå‡ºç‹¬ç«‹çš„**æ–‡ä»¶ç³»ç»Ÿã€ä¸»æœºåã€è¿›ç¨‹å·ã€ç½‘ç»œ**ç­‰èµ„æºç©ºé—´ï¼Œç›¸å½“äºç»™è¿›ç¨‹ç›–äº†ä¸€é—´**å°æ¿æˆ¿**ï¼Œè¿™æ ·å°±å®ç°äº†ç³»ç»Ÿå…¨å±€èµ„æºå’Œè¿›ç¨‹å±€éƒ¨èµ„æºçš„éš”ç¦»ã€‚

- ==cgroup==æ˜¯2008å¹´ä»Linux 2.6.24å¼€å§‹å‡ºç°çš„ï¼Œå®ƒçš„å…¨ç§°æ˜¯Linux Control Groupï¼Œç”¨æ¥å®ç°**å¯¹è¿›ç¨‹çš„CPUã€å†…å­˜ç­‰èµ„æºçš„ä¼˜å…ˆçº§å’Œé…é¢é™åˆ¶**ï¼Œç›¸å½“äºç»™è¿›ç¨‹çš„å°æ¿æˆ¿åŠ äº†ä¸€ä¸ª**å¤©èŠ±æ¿**ã€‚

- ==chroot==çš„å†å²åˆ™è¦æ¯”å‰é¢çš„namespaceã€cgroupè¦å¤è€å¾—å¤šï¼Œæ—©åœ¨1979å¹´çš„UNIX V7å°±å·²ç»å‡ºç°äº†ï¼Œå®ƒå¯ä»¥**æ›´æ”¹è¿›ç¨‹çš„æ ¹ç›®å½•ï¼Œä¹Ÿå°±æ˜¯é™åˆ¶è®¿é—®æ–‡ä»¶ç³»ç»Ÿ**ï¼Œç›¸å½“äºç»™è¿›ç¨‹çš„å°æ¿æˆ¿é“ºä¸Šäº†**åœ°ç –**ã€‚





## 3 å®¹å™¨åŒ–çš„åº”ç”¨ï¼šä¼šäº†è¿™äº›ä½ å°±æ˜¯Dockeré«˜æ‰‹

### 3.1 ä»€ä¹ˆæ˜¯å®¹å™¨åŒ–çš„åº”ç”¨

ä»åŠŸèƒ½ä¸Šæ¥çœ‹ï¼Œé•œåƒå’Œå¸¸è§çš„tarã€rpmã€debç­‰å®‰è£…åŒ…ä¸€æ ·ï¼Œéƒ½æ‰“åŒ…äº†åº”ç”¨ç¨‹åºï¼Œ**ä½†æœ€å¤§çš„ä¸åŒç‚¹åœ¨äºå®ƒé‡Œé¢ä¸ä»…æœ‰åŸºæœ¬çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿˜æœ‰åº”ç”¨è¿è¡Œæ—¶çš„æ•´ä¸ªç³»ç»Ÿç¯å¢ƒã€‚è¿™å°±è®©é•œåƒå…·æœ‰äº†éå¸¸å¥½çš„è·¨å¹³å°ä¾¿æºæ€§å’Œå…¼å®¹æ€§**ï¼Œèƒ½å¤Ÿè®©å¼€å‘è€…åœ¨ä¸€ä¸ªç³»ç»Ÿä¸Šå¼€å‘ï¼ˆä¾‹å¦‚Ubuntuï¼‰ï¼Œç„¶åæ‰“åŒ…æˆé•œåƒï¼Œå†å»å¦ä¸€ä¸ªç³»ç»Ÿä¸Šè¿è¡Œï¼ˆä¾‹å¦‚CentOSï¼‰ï¼Œå®Œå…¨ä¸éœ€è¦è€ƒè™‘ç¯å¢ƒä¾èµ–çš„é—®é¢˜ï¼Œæ˜¯ä¸€ç§æ›´é«˜çº§çš„åº”ç”¨æ‰“åŒ…æ–¹å¼ã€‚

**æ‰€è°“çš„â€œå®¹å™¨åŒ–çš„åº”ç”¨â€ï¼Œæˆ–è€…â€œåº”ç”¨çš„å®¹å™¨åŒ–â€ï¼Œå°±æ˜¯æŒ‡åº”ç”¨ç¨‹åºä¸å†ç›´æ¥å’Œæ“ä½œç³»ç»Ÿæ‰“äº¤é“ï¼Œè€Œæ˜¯å°è£…æˆé•œåƒï¼Œå†äº¤ç»™å®¹å™¨ç¯å¢ƒå»è¿è¡Œ**ã€‚



### 3.2 å¸¸ç”¨çš„é•œåƒæ“ä½œæœ‰å“ªäº›

é•œåƒçš„å®Œæ•´åå­—ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼Œåå­—å’Œæ ‡ç­¾ï¼Œä¸­é—´ç”¨:è¿æ¥èµ·æ¥ã€‚





### 3.3 å¸¸ç”¨çš„å®¹å™¨æ“ä½œæœ‰å“ªäº›

`docker run` æ˜¯æœ€å¤æ‚çš„ä¸€ä¸ªå®¹å™¨æ“ä½œå‘½ä»¤ï¼Œæœ‰éå¸¸å¤šçš„é¢å¤–å‚æ•°ç”¨æ¥è°ƒæ•´å®¹å™¨çš„è¿è¡ŒçŠ¶æ€ï¼Œä½ å¯ä»¥åŠ ä¸Š `--help` æ¥çœ‹å®ƒçš„å¸®åŠ©ä¿¡æ¯ã€‚



![](images/image-20250113154507757.png)

[Dockerå®˜æ–¹æ–‡æ¡£](https://docs.docker.com/reference/)



## 4 åˆ›å»ºå®¹å™¨é•œåƒï¼šå¦‚ä½•ç¼–å†™æ­£ç¡®ã€é«˜æ•ˆçš„Dockerfile

> è¿™äº›é•œåƒæ˜¯æ€ä¹ˆåˆ›å»ºå‡ºæ¥çš„ï¼Ÿæˆ‘ä»¬èƒ½ä¸èƒ½å¤Ÿåˆ¶ä½œå±äºè‡ªå·±çš„é•œåƒå‘¢ï¼Ÿ

### 4.1 é•œåƒçš„å†…éƒ¨æœºåˆ¶æ˜¯ä»€ä¹ˆ

é•œåƒå°±æ˜¯ä¸€ä¸ªæ‰“åŒ…æ–‡ä»¶ï¼Œé‡Œé¢åŒ…å«äº†åº”ç”¨ç¨‹åºè¿˜æœ‰å®ƒè¿è¡Œæ‰€ä¾èµ–çš„ç¯å¢ƒï¼Œä¾‹å¦‚**æ–‡ä»¶ç³»ç»Ÿã€ç¯å¢ƒå˜é‡ã€é…ç½®å‚æ•°**ç­‰ç­‰ã€‚

ç¯å¢ƒå˜é‡ã€é…ç½®å‚æ•°ï¼Œéšä¾¿ç”¨ä¸€ä¸ªmanifestæ¸…å•å°±å¯ä»¥ç®¡ç†ã€‚ä¸ºäº†ä¿è¯å®¹å™¨è¿è¡Œç¯å¢ƒçš„ä¸€è‡´æ€§ï¼Œé•œåƒå¿…é¡»æŠŠåº”ç”¨ç¨‹åºæ‰€åœ¨æ“ä½œç³»ç»Ÿçš„æ ¹ç›®å½•ï¼Œä¹Ÿå°±æ˜¯rootfsï¼Œéƒ½åŒ…å«è¿›æ¥ã€‚

> å®¹å™¨å…±äº«äº†å®¿ä¸»æœºçš„å†…æ ¸ã€‚

åˆ†å±‚

å®¹å™¨é•œåƒå†…éƒ¨å¹¶ä¸æ˜¯ä¸€ä¸ªå¹³å¦çš„ç»“æ„ï¼Œè€Œæ˜¯ç”±è®¸å¤šçš„é•œåƒå±‚ç»„æˆçš„ï¼Œæ¯å±‚éƒ½æ˜¯åªè¯»ä¸å¯ä¿®æ”¹çš„ä¸€ç»„æ–‡ä»¶ï¼Œç›¸åŒçš„å±‚å¯ä»¥åœ¨é•œåƒä¹‹é—´å…±äº«ï¼Œç„¶åå¤šä¸ªå±‚åƒæ­ç§¯æœ¨ä¸€æ ·å †å èµ·æ¥ï¼Œå†ä½¿ç”¨ä¸€ç§å«â€œ**Union FSè”åˆæ–‡ä»¶ç³»ç»Ÿ**â€çš„æŠ€æœ¯æŠŠå®ƒä»¬åˆå¹¶åœ¨ä¸€èµ·ï¼Œå°±å½¢æˆäº†å®¹å™¨æœ€ç»ˆçœ‹åˆ°çš„æ–‡ä»¶ç³»ç»Ÿã€‚

![](images/c750a7795ff4787c6639dd42bf0a473f.png)

 é€šè¿‡`docker inspect` æ¥æŸ¥çœ‹é•œåƒçš„åˆ†å±‚ä¿¡æ¯ï¼Œåˆ†å±‚ä¿¡æ¯åœ¨â€œRootFSâ€éƒ¨åˆ†:

```sh
docker inspect nginx:alpine
```

```json
"RootFS": {
  "Type": "layers",
  "Layers": [
    "sha256:534a70dc82967ee32184e13d28ea485e909b20d3f13d553122bab3e4de03b50c",
    "sha256:b2910501c84396134537ff442a4e2222ab6486c6016ea4c1016ed96337ef64ef",
    "sha256:cbb38b57f14055b3acc7a4bae43e5a41bcd7621c1f56f3f920abb89a65c3c025",
    "sha256:e1482d48072939900a66dbbec794450822aff9176d11302592f230249da91238",
    "sha256:3bc38db2acdbab2b44537e4a354dbcb05ed3bbbcb54674993471ee0c7232f041",
    "sha256:20ca17bb1caf19cc991d7b4bc6915b25c9fbe1e1b297f04712ec692b53017c9a",
    "sha256:856b39837f15b572e89d179002698b4f4e7447d91740590718368b7ebec9ff63",
    "sha256:a81f475c8ce219c6b25147ee82b5b101144ee007c3bd849db063be67e6a78521"
	]
},
```

Dockerä¼šæ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„å±‚ï¼Œå¦‚æœæœ¬åœ°å·²ç»å­˜åœ¨å°±ä¸ä¼šé‡å¤ä¸‹è½½ï¼Œå¦‚æœå±‚è¢«å…¶ä»–é•œåƒå…±äº«å°±ä¸ä¼šåˆ é™¤ï¼Œè¿™æ ·å°±å¯ä»¥èŠ‚çº¦ç£ç›˜å’Œç½‘ç»œæˆæœ¬ã€‚

### 4.2 Dockerfileæ˜¯ä»€ä¹ˆ

æ¯”èµ·å®¹å™¨ã€é•œåƒæ¥è¯´ï¼ŒDockerfileéå¸¸æ™®é€šï¼Œå®ƒå°±æ˜¯ä¸€ä¸ª**çº¯æ–‡æœ¬**ï¼Œé‡Œé¢è®°å½•äº†ä¸€ç³»åˆ—çš„æ„å»ºæŒ‡ä»¤ï¼Œæ¯”å¦‚é€‰æ‹©åŸºç¡€é•œåƒã€æ‹·è´æ–‡ä»¶ã€è¿è¡Œè„šæœ¬ç­‰ç­‰ï¼Œ**æ¯ä¸ªæŒ‡ä»¤éƒ½ä¼šç”Ÿæˆä¸€ä¸ªLayer**ï¼Œè€ŒDockeré¡ºåºæ‰§è¡Œè¿™ä¸ªæ–‡ä»¶é‡Œçš„æ‰€æœ‰æ­¥éª¤ï¼Œæœ€åå°±ä¼šåˆ›å»ºå‡ºä¸€ä¸ªæ–°çš„é•œåƒå‡ºæ¥ã€‚

```dockerfile
# Dockerfile.busybox
FROM busybox                  # é€‰æ‹©åŸºç¡€é•œåƒ
CMD echo "hello world"        # å¯åŠ¨å®¹å™¨æ—¶é»˜è®¤è¿è¡Œçš„å‘½ä»¤
```

- ç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯ `FROM`ï¼Œæ‰€æœ‰çš„Dockerfileéƒ½è¦ä»å®ƒå¼€å§‹ï¼Œè¡¨ç¤ºé€‰æ‹©æ„å»ºä½¿ç”¨çš„åŸºç¡€é•œåƒï¼Œç›¸å½“äºâ€œæ‰“åœ°åŸºâ€ã€‚

- ç¬¬äºŒæ¡æŒ‡ä»¤æ˜¯ `CMD`ï¼Œå®ƒæŒ‡å®š `docker run` å¯åŠ¨å®¹å™¨æ—¶é»˜è®¤è¿è¡Œçš„å‘½ä»¤ã€‚

Dockerfileç›¸å½“äºâ€œæ–½å·¥å›¾çº¸â€ï¼Œè€Œ `docker build` å°±ç›¸å½“äºâ€œæ–½å·¥é˜Ÿâ€ï¼Œæ¥åˆ›å»ºå‡ºé•œåƒï¼š

```sh
$ docker build -f Dockerfile.busybox .

[+] Building 0.0s (5/5) FINISHED                                                                                              docker:default
 => [internal] load build definition from Dockerfile.busybox                                                                            0.0s
 => => transferring dockerfile: 81B                                                                                                     0.0s
 => [internal] load metadata for docker.io/library/busybox:latest                                                                       0.0s
 => [internal] load .dockerignore                                                                                                       0.0s
 => => transferring context: 2B                                                                                                         0.0s
 => [1/1] FROM docker.io/library/busybox:latest                                                                                         0.0s
 => exporting to image                                                                                                                  0.0s
 => => exporting layers                                                                                                                 0.0s
 => => writing image sha256:e8c55f4e1cdf24541ba7e31ba2b5363efa2b3c6f939cb370ff1cb5395b9105a5                                            0.0s
```



### 4.3 æ€æ ·ç¼–å†™æ­£ç¡®ã€é«˜æ•ˆçš„Dockerfile

`COPY`å‘½ä»¤çš„ç”¨æ³•å’ŒLinuxçš„cpå·®ä¸å¤šï¼Œä¸è¿‡æ‹·è´çš„æºæ–‡ä»¶å¿…é¡»æ˜¯â€œ**æ„å»ºä¸Šä¸‹æ–‡**â€è·¯å¾„é‡Œçš„ï¼Œä¸èƒ½éšæ„æŒ‡å®šæ–‡ä»¶ã€‚

```dockerfile
COPY ./a.txt  /tmp/a.txt    # æŠŠæ„å»ºä¸Šä¸‹æ–‡é‡Œçš„a.txtæ‹·è´åˆ°é•œåƒçš„/tmpç›®å½•
COPY /etc/hosts  /tmp       # é”™è¯¯ï¼ä¸èƒ½ä½¿ç”¨æ„å»ºä¸Šä¸‹æ–‡ä¹‹å¤–çš„æ–‡ä»¶
```

`RUN`æ˜¯Dockerfileé‡Œæœ€é‡è¦çš„ä¸€ä¸ªæŒ‡ä»¤ï¼Œå®ƒå¯ä»¥æ‰§è¡Œä»»æ„çš„Shellå‘½ä»¤ï¼Œæ¯”å¦‚æ›´æ–°ç³»ç»Ÿã€å®‰è£…åº”ç”¨ã€ä¸‹è½½æ–‡ä»¶ã€åˆ›å»ºç›®å½•ã€ç¼–è¯‘ç¨‹åºç­‰ç­‰ï¼Œå®ç°ä»»æ„çš„é•œåƒæ„å»ºæ­¥éª¤ï¼Œéå¸¸çµæ´»ã€‚

```dockerfile
RUN apt-get update \
    && apt-get install -y \
        build-essential \
        curl \
        make \
        unzip \
    && cd /tmp \
    && curl -fSL xxx.tar.gz -o xxx.tar.gz\
    && tar xzf xxx.tar.gz \
    && cd xxx \
    && ./config \
    && make \
    && make clean
```

å¤ªé•¿å¯ä»¥**æŠŠè¿™äº›Shellå‘½ä»¤é›†ä¸­åˆ°ä¸€ä¸ªè„šæœ¬æ–‡ä»¶é‡Œï¼Œç”¨ `COPY` å‘½ä»¤æ‹·è´è¿›å»å†ç”¨ `RUN` æ¥æ‰§è¡Œ**ï¼š

```dockerfile
COPY setup.sh  /tmp/                # æ‹·è´è„šæœ¬åˆ°/tmpç›®å½•

RUN cd /tmp && chmod +x setup.sh \  # æ·»åŠ æ‰§è¡Œæƒé™
    && ./setup.sh && rm setup.sh    # è¿è¡Œè„šæœ¬ç„¶åå†åˆ é™¤
```

`RUN`æŒ‡ä»¤å®é™…ä¸Šå°±æ˜¯Shellç¼–ç¨‹ï¼Œæœ‰å˜é‡çš„æ¦‚å¿µï¼Œå¯ä»¥å®ç°å‚æ•°åŒ–è¿è¡Œï¼Œéœ€è¦ä½¿ç”¨ä¸¤ä¸ªæŒ‡ä»¤ `ARG` å’Œ `ENV`ã€‚

**å®ƒä»¬åŒºåˆ«åœ¨äº `ARG` åˆ›å»ºçš„å˜é‡åªåœ¨é•œåƒæ„å»ºè¿‡ç¨‹ä¸­å¯è§ï¼Œå®¹å™¨è¿è¡Œæ—¶ä¸å¯è§ï¼Œè€Œ `ENV` åˆ›å»ºçš„å˜é‡ä¸ä»…èƒ½å¤Ÿåœ¨æ„å»ºé•œåƒçš„è¿‡ç¨‹ä¸­ä½¿ç”¨ï¼Œåœ¨å®¹å™¨è¿è¡Œæ—¶ä¹Ÿèƒ½å¤Ÿä»¥ç¯å¢ƒå˜é‡çš„å½¢å¼è¢«åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚**

ä¾‹å­ï¼Œä½¿ç”¨ `ARG` å®šä¹‰äº†åŸºç¡€é•œåƒçš„åå­—ï¼ˆå¯ä»¥ç”¨åœ¨â€œFROMâ€æŒ‡ä»¤é‡Œï¼‰ï¼Œä½¿ç”¨ `ENV` å®šä¹‰äº†ä¸¤ä¸ªç¯å¢ƒå˜é‡ï¼š

```dockerfile
ARG IMAGE_BASE="node"
ARG IMAGE_TAG="alpine"

ENV PATH=$PATH:/tmp
ENV DEBUG=OFF
```

 `EXPOSE`ä»¤ç”¨æ¥å£°æ˜å®¹å™¨å¯¹å¤–æœåŠ¡çš„ç«¯å£å·ï¼Œå¯¹ç°åœ¨åŸºäºNode.jsã€Tomcatã€Nginxã€Goç­‰å¼€å‘çš„å¾®æœåŠ¡ç³»ç»Ÿæ¥è¯´éå¸¸æœ‰ç”¨ï¼š

```dockerfile
EXPOSE 443           # é»˜è®¤æ˜¯tcpåè®®
EXPOSE 53/udp        # å¯ä»¥æŒ‡å®šudpåè®®
```

> æ³¨æ„ï¼šå› ä¸ºæ¯ä¸ªæŒ‡ä»¤éƒ½ä¼šç”Ÿæˆä¸€ä¸ªé•œåƒå±‚ï¼Œæ‰€ä»¥Dockerfileé‡Œæœ€å¥½ä¸è¦æ»¥ç”¨æŒ‡ä»¤ï¼Œå°½é‡ç²¾ç®€åˆå¹¶ï¼Œå¦åˆ™å¤ªå¤šçš„å±‚ä¼šå¯¼è‡´é•œåƒè‡ƒè‚¿ä¸å ªã€‚

### 4.4 docker buildæ˜¯æ€ä¹ˆå·¥ä½œçš„

Dockerfileå¿…é¡»è¦ç»è¿‡ `docker build` æ‰èƒ½ç”Ÿæ•ˆã€‚

å› ä¸ºå‘½ä»¤è¡Œâ€œdockerâ€æ˜¯ä¸€ä¸ªç®€å•çš„å®¢æˆ·ç«¯ï¼ŒçœŸæ­£çš„é•œåƒæ„å»ºå·¥ä½œæ˜¯ç”±æœåŠ¡å™¨ç«¯çš„â€œDocker daemonâ€æ¥å®Œæˆçš„ï¼Œæ‰€ä»¥â€œdockerâ€å®¢æˆ·ç«¯å°±åªèƒ½æŠŠâ€œæ„å»ºä¸Šä¸‹æ–‡â€ç›®å½•æ‰“åŒ…ä¸Šä¼ ï¼ˆæ˜¾ç¤ºä¿¡æ¯ `Sending build context to Docker daemon` ï¼‰ï¼Œè¿™æ ·æœåŠ¡å™¨æ‰èƒ½å¤Ÿè·å–æœ¬åœ°çš„è¿™äº›æ–‡ä»¶ã€‚

![](images/c8116066bdbf295a7c9fc25b87755dfe.jpg)

â€œæ„å»ºä¸Šä¸‹æ–‡â€å…¶å®ä¸Dockerfileå¹¶æ²¡æœ‰ç›´æ¥çš„å…³ç³»ï¼Œå®ƒå…¶å®æŒ‡å®šäº†è¦æ‰“åŒ…è¿›é•œåƒçš„ä¸€äº›ä¾èµ–æ–‡ä»¶ã€‚è€Œ `COPY` å‘½ä»¤ä¹Ÿåªèƒ½ä½¿ç”¨åŸºäºâ€œæ„å»ºä¸Šä¸‹æ–‡â€çš„ç›¸å¯¹è·¯å¾„ï¼Œå› ä¸ºâ€œDocker daemonâ€çœ‹ä¸åˆ°æœ¬åœ°ç¯å¢ƒï¼Œåªèƒ½çœ‹åˆ°æ‰“åŒ…ä¸Šä¼ çš„é‚£äº›æ–‡ä»¶ã€‚

ä½†è¿™ä¸ªæœºåˆ¶ä¹Ÿä¼šå¯¼è‡´ä¸€äº›éº»çƒ¦ï¼Œå¦‚æœç›®å½•é‡Œæœ‰çš„æ–‡ä»¶ï¼ˆä¾‹å¦‚readme/.git/.svnç­‰ï¼‰ä¸éœ€è¦æ‹·è´è¿›é•œåƒï¼Œdockerä¹Ÿä¼šä¸€è‚¡è„‘åœ°æ‰“åŒ…ä¸Šä¼ ï¼Œæ•ˆç‡å¾ˆä½ã€‚

ä¸ºäº†é¿å…è¿™ç§é—®é¢˜ï¼Œå¯ä»¥åœ¨â€œæ„å»ºä¸Šä¸‹æ–‡â€ç›®å½•é‡Œå†å»ºç«‹ä¸€ä¸ª `.dockerignore` æ–‡ä»¶ï¼Œè¯­æ³•ä¸ `.gitignore` ç±»ä¼¼ï¼Œæ’é™¤é‚£äº›ä¸éœ€è¦çš„æ–‡ä»¶ã€‚

`-t` å‚æ•°ï¼Œä¸ºé•œåƒèµ·ä¸€ä¸ªæœ‰æ„ä¹‰çš„åå­—ï¼Œæ–¹ä¾¿ç®¡ç†ã€‚



ä¾‹å­ï¼š

```dockerfile
# Dockerfile
# docker build -t ngx-app .
# docker build -t ngx-app:1.0 .

ARG IMAGE_BASE="nginx"
ARG IMAGE_TAG="1.21-alpine"

FROM ${IMAGE_BASE}:${IMAGE_TAG}

COPY ./default.conf /etc/nginx/conf.d/

RUN cd /usr/share/nginx/html \
    && echo "hello nginx" > a.txt

EXPOSE 8081 8082 8083
```



### æ€è€ƒé¢˜

> dockeré•œåƒé‡Œçš„å±‚éƒ½æ˜¯åªè¯»ä¸å¯ä¿®æ”¹çš„ï¼Œä½†å®¹å™¨è¿è¡Œçš„æ—¶å€™ç»å¸¸ä¼šå†™å…¥æ•°æ®ï¼Œè¿™ä¸ªå†²çªåº”è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ

- å½“ä½¿ç”¨ Docker è¿è¡Œä¸€ä¸ªå®¹å™¨æ—¶ï¼Œä¼šåœ¨é•œåƒä¹‹ä¸Šæ·»åŠ ä¸€ä¸ªå¯å†™å±‚ã€‚è¿™å°±æ˜¯ Docker è§£å†³é•œåƒå±‚åªè¯»ä½†å®¹å™¨éœ€è¦å†™å…¥æ•°æ®çš„æ–¹å¼ã€‚
- å½“åœ¨å®¹å™¨ä¸­åˆ›å»ºã€ä¿®æ”¹æˆ–åˆ é™¤æ–‡ä»¶æ—¶ï¼Œè¿™äº›æ“ä½œå®é™…ä¸Šæ˜¯åœ¨è¿™ä¸ªå¯å†™å±‚ä¸Šè¿›è¡Œçš„ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¿®æ”¹é•œåƒå±‚ã€‚

> é•œåƒçš„åˆ†å±‚ç»“æ„å¸¦æ¥äº†å“ªäº›å¥½å¤„?

1. é«˜æ•ˆå­˜å‚¨å’Œå…±äº«

**å¤ç”¨å±‚å‡å°‘å­˜å‚¨éœ€æ±‚**

**å¿«é€Ÿåˆ†å‘å’Œéƒ¨ç½²**

2. æ˜“äºæ›´æ–°å’Œç»´æŠ¤

**å¢é‡æ›´æ–°**

**ç‰ˆæœ¬æ§åˆ¶**

3. å¯ç§»æ¤æ€§å’Œéš”ç¦»æ€§

**è·¨å¹³å°ä¸€è‡´æ€§**

**éš”ç¦»æ€§**

4. å®‰å…¨æ€§å’Œå¯é æ€§

**åˆ†å±‚éªŒè¯**

**æ•…éšœéš”ç¦»**

## 5 é•œåƒä»“åº“ï¼šè¯¥æ€æ ·ç”¨å¥½Docker Hubè¿™ä¸ªå®è—

### ä»€ä¹ˆæ˜¯é•œåƒä»“åº“ï¼ˆRegistryï¼‰

![](images/c8116066bdbf295a7c9fc25b87755dfe.jpg)

Registryï¼Œç›´è¯‘å°±æ˜¯â€œæ³¨å†Œä¸­å¿ƒâ€ï¼Œæ„æ€æ˜¯æ‰€æœ‰é•œåƒçš„Repositoryéƒ½åœ¨è¿™é‡Œç™»è®°ä¿ç®¡ï¼Œå°±åƒæ˜¯ä¸€ä¸ªå·¨å¤§çš„æ¡£æ¡ˆé¦†ã€‚

å·¦è¾¹çš„â€œdocker pullâ€ï¼Œè™šçº¿æ˜¾ç¤ºäº†å®ƒçš„å·¥ä½œæµç¨‹ï¼Œå…ˆåˆ°â€œDocker daemonâ€ï¼Œå†åˆ°Registryï¼Œåªæœ‰å½“Registryé‡Œå­˜æœ‰é•œåƒæ‰èƒ½çœŸæ­£æŠŠå®ƒä¸‹è½½åˆ°æœ¬åœ°ã€‚

é•œåƒä»“åº“é™¤äº†èƒ½å¤Ÿæ‹‰å–é•œåƒï¼Œè¿˜å¯ä»¥ä¸Šä¼ ã€æŸ¥è¯¢ã€åˆ é™¤ç­‰ç­‰ã€‚



### ä»€ä¹ˆæ˜¯Docker Hub

â€œ**Docker Hub**â€ï¼ˆhttps://hub.docker.com/ï¼‰æ˜¯é»˜è®¤çš„å®˜æ–¹é•œåƒä»“åº“ã€‚



### å¦‚ä½•åœ¨Docker Hubä¸ŠæŒ‘é€‰é•œåƒ

Docker Hubä¸Šæœ‰**å®˜æ–¹é•œåƒ**ï¼ˆâ€œ**Official image**â€ï¼‰ã€**è®¤è¯é•œåƒ**ï¼ˆâ€œ**Verified publisher**â€ï¼‰å’Œ**éå®˜æ–¹é•œåƒ**çš„åŒºåˆ«ã€‚

å®˜æ–¹é•œåƒæ˜¯æŒ‡Dockerå…¬å¸å®˜æ–¹æä¾›çš„é«˜è´¨é‡é•œåƒï¼ˆhttps://github.com/docker-library/official-imagesï¼‰ï¼Œéƒ½ç»è¿‡äº†ä¸¥æ ¼çš„æ¼æ´æ‰«æå’Œå®‰å…¨æ£€æµ‹ï¼Œæ”¯æŒx86_64ã€arm64ç­‰å¤šç§ç¡¬ä»¶æ¶æ„ï¼Œè¿˜å…·æœ‰æ¸…æ™°æ˜“è¯»çš„æ–‡æ¡£ï¼Œä¸€èˆ¬æ¥è¯´æ˜¯æˆ‘ä»¬æ„å»ºé•œåƒçš„é¦–é€‰ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬ç¼–å†™Dockerfileçš„æœ€ä½³èŒƒä¾‹ã€‚

è®¤è¯é•œåƒï¼Œä¹Ÿå°±æ˜¯è®¤è¯å‘è¡Œå•†ï¼Œæ¯”å¦‚Bitnamiã€Rancherã€Ubuntuç­‰ã€‚å®ƒä»¬éƒ½æ˜¯é¢‡å…·è§„æ¨¡çš„å¤§å…¬å¸ï¼Œå…·æœ‰ä¸é€ŠäºDockerå…¬å¸çš„å®åŠ›ï¼Œæ‰€ä»¥å°±åœ¨Docker Hubä¸Šå¼€äº†ä¸ªè®¤è¯è´¦å·ï¼Œå‘å¸ƒè‡ªå·±æ‰“åŒ…çš„é•œåƒï¼Œæœ‰ç‚¹ç±»ä¼¼æˆ‘ä»¬å¾®åšä¸Šçš„â€œå¤§Vâ€ã€‚è¿™äº›é•œåƒæœ‰å…¬å¸èƒŒä¹¦ï¼Œå½“ç„¶ä¹Ÿå¾ˆå€¼å¾—ä¿¡èµ–ï¼Œä¸è¿‡å®ƒä»¬éš¾å…ä¼šå¸¦ä¸Šä¸€äº›å„è‡ªå…¬å¸çš„â€œçƒ™å°â€ï¼Œæ¯”å¦‚Bitnamiçš„é•œåƒå°±ç»Ÿä¸€ä»¥â€œminidebâ€ä¸ºåŸºç¡€ï¼Œçµæ´»æ€§ä¸Šæ¯”Dockerå®˜æ–¹é•œåƒç•¥å·®ï¼Œæœ‰çš„æ—¶å€™ä¹Ÿè®¸ä¼šä¸ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚ã€‚

éå®˜æ–¹é•œåƒå¯ä»¥åˆ†å‡ºä¸¤ç±»ï¼š

1. â€œ**åŠå®˜æ–¹**â€é•œåƒ
2. çº¯ç²¹çš„â€œ**æ°‘é—´**â€é•œåƒ



é•œåƒåŒºåˆ†ï¼šâ€œ**ç”¨æˆ·å/åº”ç”¨å**â€ï¼Œæ¯”å¦‚`bitnami/nginx`ã€`ubuntu/nginx`ã€`rancher/nginx` ç­‰ç­‰ã€‚



### Docker Hubä¸Šé•œåƒå‘½åçš„è§„åˆ™æ˜¯ä»€ä¹ˆ

å®˜æ–¹çš„Redisé•œåƒä½œä¸ºä¾‹å­ï¼Œè§£é‡Šä¸€ä¸‹æ ‡ç­¾ã€‚

![](images/1dd392b8f286507b83cd31400d5dccd5.png)

é€šå¸¸æ¥è¯´ï¼Œé•œåƒæ ‡ç­¾çš„æ ¼å¼æ˜¯**==åº”ç”¨çš„ç‰ˆæœ¬å·+æ“ä½œç³»ç»Ÿ==**ã€‚

ç‰ˆæœ¬å·åŸºæœ¬ä¸Šéƒ½æ˜¯**==ä¸»ç‰ˆæœ¬å·+æ¬¡ç‰ˆæœ¬å·+è¡¥ä¸å·==**çš„å½¢å¼ï¼Œæœ‰çš„è¿˜ä¼šåœ¨æ­£å¼å‘å¸ƒå‰å‡º==rc==ç‰ˆï¼ˆå€™é€‰ç‰ˆæœ¬ï¼Œrelease candidateï¼‰ã€‚è€Œæ“ä½œç³»ç»Ÿçš„æƒ…å†µç•¥å¾®å¤æ‚ä¸€äº›ï¼Œå› ä¸ºå„ä¸ªLinuxå‘è¡Œç‰ˆçš„å‘½åæ–¹å¼â€œèŠ±æ ·â€å¤ªå¤šäº†ã€‚

Alpineã€CentOSçš„å‘½åæ¯”è¾ƒç®€å•æ˜äº†ï¼Œå°±æ˜¯æ•°å­—çš„ç‰ˆæœ¬å·ï¼Œåƒè¿™é‡Œçš„ `alpine3.15` ï¼Œè€ŒUbuntuã€Debianåˆ™é‡‡ç”¨äº†ä»£å·çš„å½¢å¼ã€‚æ¯”å¦‚Ubuntu 18.04æ˜¯ `bionic`ï¼ŒUbuntu 20.04æ˜¯ `focal`ï¼ŒDebian 9æ˜¯ `stretch`ï¼ŒDebian 10æ˜¯ `buster`ï¼ŒDebian 11æ˜¯ `bullseye`ã€‚

**å¦å¤–ï¼Œæœ‰çš„æ ‡ç­¾è¿˜ä¼šåŠ ä¸Š `slim`ã€`fat`ï¼Œæ¥è¿›ä¸€æ­¥è¡¨ç¤ºè¿™ä¸ªé•œåƒçš„å†…å®¹æ˜¯ç»è¿‡ç²¾ç®€çš„ï¼Œè¿˜æ˜¯åŒ…å«äº†è¾ƒå¤šçš„è¾…åŠ©å·¥å…·**ã€‚é€šå¸¸ `slim` é•œåƒä¼šæ¯”è¾ƒå°ï¼Œè¿è¡Œæ•ˆç‡é«˜ï¼Œè€Œ `fat` é•œåƒä¼šæ¯”è¾ƒå¤§ï¼Œé€‚åˆç”¨æ¥å¼€å‘è°ƒè¯•ã€‚

å‡ ä¸ªæ ‡ç­¾çš„ä¾‹å­æ¥è¯´æ˜ä¸€ä¸‹ã€‚

- nginx:1.21.6-alpineï¼Œè¡¨ç¤ºç‰ˆæœ¬å·æ˜¯1.21.6ï¼ŒåŸºç¡€é•œåƒæ˜¯æœ€æ–°çš„Alpineã€‚
- redis:7.0-rc-bullseyeï¼Œè¡¨ç¤ºç‰ˆæœ¬å·æ˜¯7.0å€™é€‰ç‰ˆï¼ŒåŸºç¡€é•œåƒæ˜¯Debian 11ã€‚
- node:17-buster-slimï¼Œè¡¨ç¤ºç‰ˆæœ¬å·æ˜¯17ï¼ŒåŸºç¡€é•œåƒæ˜¯ç²¾ç®€çš„Debian 10ã€‚

### è¯¥æ€ä¹ˆä¸Šä¼ è‡ªå·±çš„é•œåƒğŸ”–

- ç¬¬ä¸€æ­¥ï¼Œåœ¨Docker Hubä¸Šæ³¨å†Œä¸€ä¸ªç”¨æˆ·
- ç¬¬äºŒæ­¥ï¼Œåœ¨æœ¬æœºä¸Šä½¿ç”¨ `docker login` å‘½ä»¤
- ç¬¬ä¸‰æ­¥ï¼Œä½¿ç”¨ `docker tag` å‘½ä»¤ï¼Œç»™é•œåƒæ”¹æˆå¸¦ç”¨æˆ·åçš„å®Œæ•´åå­—ï¼Œè¡¨ç¤ºé•œåƒæ˜¯å±äºè¿™ä¸ªç”¨æˆ·çš„ã€‚æˆ–è€…ç®€å•ä¸€ç‚¹ï¼Œç›´æ¥ç”¨ `docker build -t` åœ¨åˆ›å»ºé•œåƒçš„æ—¶å€™å°±èµ·å¥½åå­—ã€‚
- ç¬¬å››æ­¥ï¼Œç”¨ `docker push` æŠŠè¿™ä¸ªé•œåƒæ¨ä¸Šå»



### ç¦»çº¿ç¯å¢ƒè¯¥æ€ä¹ˆåŠğŸ”–

æœ€ä½³çš„æ–¹æ³•å°±æ˜¯åœ¨å†…ç½‘ç¯å¢ƒé‡Œä»¿é€ Docker Hubï¼Œåˆ›å»ºä¸€ä¸ªè‡ªå·±çš„ç§æœ‰RegistryæœåŠ¡ï¼Œç”±å®ƒæ¥ç®¡ç†æˆ‘ä»¬çš„é•œåƒï¼Œå°±åƒæˆ‘ä»¬è‡ªå·±æ­å»ºGitLabåšç‰ˆæœ¬ç®¡ç†ä¸€æ ·ã€‚

è‡ªå»ºRegistryå·²ç»æœ‰å¾ˆå¤šæˆç†Ÿçš„è§£å†³æ–¹æ¡ˆï¼Œæ¯”å¦‚**Docker Registry**ï¼Œè¿˜æœ‰**CNCF Harbor**ã€‚



## 6 æ‰“ç ´æ¬¡å…ƒå£ï¼šå®¹å™¨è¯¥å¦‚ä½•ä¸å¤–ç•Œäº’è”äº’é€š

### 6.1 å¦‚ä½•æ‹·è´å®¹å™¨å†…çš„æ•°æ®

```sh
# -dã€--rm è¡¨ç¤ºè¿è¡Œåœ¨åå°ï¼Œå®¹å™¨ç»“æŸåè‡ªåŠ¨åˆ é™¤
$ docker run -d --rm redis
e32062413b4aa0491aeec0f9d825e18074b3180c5cd4aac6a3f254e50ff4aff0

# æ‹·è´æ–‡ä»¶è¿›å…¥å®¹å™¨
$ docker cp a.txt e32:/tmp
$ docker exec -it e32 sh
# ls /tmp
a.txt


# ä»å®¹å™¨ä¸­æ‹·è´å‡ºæ–‡ä»¶
$ docker cp e32:/tmp/a.txt ./b.txt
```



### 6.2 å¦‚ä½•å…±äº«ä¸»æœºä¸Šçš„æ–‡ä»¶

`-v å®¿ä¸»æœºè·¯å¾„:å®¹å™¨å†…è·¯å¾„`

```sh
$ docker run -d --rm -v /tmp:/tmp redis
b905d006c3757df91434b9e24db36c653f7558e161ecddb4326ee3361650a6e2
$ docker exec -it b90 sh
```

> ç®€å•ä¾‹å­
>
> æ¯”å¦‚æˆ‘æœ¬æœºä¸Šåªæœ‰Python 2.7ï¼Œä½†æˆ‘æƒ³ç”¨Python 3å¼€å‘ï¼Œå¦‚æœåŒæ—¶å®‰è£…Python 2å’ŒPython 3å¾ˆå®¹æ˜“å°±ä¼šæŠŠç³»ç»Ÿæä¹±ï¼Œæ‰€ä»¥æˆ‘å°±å¯ä»¥è¿™ä¹ˆåšï¼š
>
> 1. å…ˆä½¿ç”¨ `docker pull` æ‹‰å–ä¸€ä¸ªPython 3çš„é•œåƒï¼Œå› ä¸ºå®ƒæ‰“åŒ…äº†å®Œæ•´çš„è¿è¡Œç¯å¢ƒï¼Œè¿è¡Œæ—¶æœ‰éš”ç¦»ï¼Œæ‰€ä»¥ä¸ä¼šå¯¹ç°æœ‰ç³»ç»Ÿçš„Python 2.7äº§ç”Ÿä»»ä½•å½±å“ã€‚
>
> 2. åœ¨æœ¬åœ°çš„æŸä¸ªç›®å½•ç¼–å†™Pythonä»£ç ï¼Œç„¶åç”¨ `-v` å‚æ•°è®©å®¹å™¨å…±äº«è¿™ä¸ªç›®å½•ã€‚
>
> 3. ç°åœ¨å°±å¯ä»¥åœ¨å®¹å™¨é‡Œä»¥Python 3æ¥å®‰è£…å„ç§åŒ…ï¼Œå†è¿è¡Œè„šæœ¬åšå¼€å‘äº†ã€‚
>
>    ```sh
>    docker pull python:alpine 
>    docker run -it â€“rm -v `pwd`:/tmp python:alpine sh
>    ```
>
> æ˜¾ç„¶ï¼Œè¿™ç§æ–¹å¼æ¯”æŠŠæ–‡ä»¶æ‰“åŒ…åˆ°é•œåƒæˆ–è€… `docker cp` ä¼šæ›´åŠ çµæ´»ï¼Œéå¸¸é€‚åˆæœ‰é¢‘ç¹ä¿®æ”¹çš„å¼€å‘æµ‹è¯•å·¥ä½œã€‚



### 6.3 å¦‚ä½•å®ç°ç½‘ç»œäº’é€š

ç½‘ç»œäº’é€šçš„å…³é”®åœ¨äºâ€œæ‰“é€šâ€å®¹å™¨å†…å¤–çš„ç½‘ç»œï¼Œè€Œå¤„ç†ç½‘ç»œé€šä¿¡æ— ç–‘æ˜¯è®¡ç®—æœºç³»ç»Ÿé‡Œæœ€æ£˜æ‰‹çš„å·¥ä½œä¹‹ä¸€ï¼Œæœ‰è®¸è®¸å¤šå¤šçš„åè¯ã€åè®®ã€å·¥å…·ï¼Œåœ¨è¿™é‡Œæˆ‘ä¹Ÿæ²¡æœ‰åŠæ³•ä¸€ä¸‹å­å°±æŠŠå®ƒéƒ½å®Œå…¨è¯´æ¸…æ¥šï¼Œæ‰€ä»¥åªèƒ½ä»â€œå®è§‚â€å±‚é¢è®²ä¸ªå¤§æ¦‚ï¼Œå¸®åŠ©ä½ å¿«é€Ÿç†è§£ã€‚

Dockeræä¾›äº†ä¸‰ç§ç½‘ç»œæ¨¡å¼ï¼š

- **==null==**æ˜¯æœ€ç®€å•çš„æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰ç½‘ç»œï¼Œä½†å…è®¸å…¶ä»–çš„ç½‘ç»œæ’ä»¶æ¥è‡ªå®šä¹‰ç½‘ç»œè¿æ¥ã€‚
- **==host==**æ˜¯ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œï¼Œç›¸å½“äºå»æ‰äº†å®¹å™¨çš„ç½‘ç»œéš”ç¦»ï¼ˆå…¶ä»–éš”ç¦»ä¾ç„¶ä¿ç•™ï¼‰ï¼Œæ‰€æœ‰çš„å®¹å™¨ä¼šå…±äº«å®¿ä¸»æœºçš„IPåœ°å€å’Œç½‘å¡ã€‚è¿™ç§æ¨¡å¼æ²¡æœ‰ä¸­é—´å±‚ï¼Œè‡ªç„¶é€šä¿¡æ•ˆç‡é«˜ï¼Œä½†ç¼ºå°‘äº†éš”ç¦»ï¼Œè¿è¡Œå¤ªå¤šçš„å®¹å™¨ä¹Ÿå®¹æ˜“å¯¼è‡´ç«¯å£å†²çªã€‚

```sh
$docker run -d --rm --net=host nginx:alpine
efc735d506599d135db234ed3c53c6162e8deea84783b2befa25c93a66502a05
```

```sh
ip addr                    # æœ¬æœºæŸ¥çœ‹ç½‘å¡
docker exec efc ip addr    # å®¹å™¨æŸ¥çœ‹ç½‘å¡
```

ç»“æœä¸¤ä¸ªç½‘å¡ä¿¡æ¯ç›¸åŒã€‚

- **==bridge==**ï¼Œä¹Ÿå°±æ˜¯æ¡¥æ¥æ¨¡å¼ï¼Œå®ƒæœ‰ç‚¹ç±»ä¼¼ç°å®ä¸–ç•Œé‡Œçš„äº¤æ¢æœºã€è·¯ç”±å™¨ï¼Œåªä¸è¿‡æ˜¯ç”±è½¯ä»¶è™šæ‹Ÿå‡ºæ¥çš„ï¼Œå®¹å™¨å’Œå®¿ä¸»æœºå†é€šè¿‡è™šæ‹Ÿç½‘å¡æ¥å…¥è¿™ä¸ªç½‘æ¡¥ï¼ˆå›¾ä¸­çš„docker0ï¼‰ï¼Œé‚£ä¹ˆå®ƒä»¬ä¹‹é—´ä¹Ÿå°±å¯ä»¥æ­£å¸¸çš„æ”¶å‘ç½‘ç»œæ•°æ®åŒ…äº†ã€‚ä¸è¿‡å’Œhostæ¨¡å¼ç›¸æ¯”ï¼Œbridgeæ¨¡å¼å¤šäº†**è™šæ‹Ÿç½‘æ¡¥å’Œç½‘å¡**ï¼Œé€šä¿¡æ•ˆç‡ä¼šä½ä¸€äº›ã€‚

![](images/image-20250114154005910.png)

`--net=bridge`è®¾ç½®ï¼Œä½†é»˜è®¤åŠ¨è½¦å®¢äººçš„ç½‘ç»œæ¨¡å¼å°±æ˜¯bridgeã€‚

```sh
$ docker run -d --rm nginx:alpine
5e69c563f6f9516553e801b3e912bbd54a8003368a15578bbe8a2b0845e6b0af
$ docker run -d --rm redis
8401b08d75e927ea960cb3bcc59d9ecea5ed2f1f5860a74a997bd8ccfe8c314c
$ docker exec 5e6 ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
18: eth0@if19: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1500 qdisc noqueue state UP 
    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
       valid_lft forever preferred_lft forever
```

ï¼ˆrediså®¹å™¨é‡Œæ²¡æœ‰ipå‘½ä»¤ï¼‰

eth0æ˜¯ä¸€ä¸ªè™šæ‹Ÿç½‘å¡ï¼ŒIPåœ°å€æ˜¯Bç±»ç§æœ‰åœ°å€â€œ172.17.0.2â€ã€‚

ç”¨ `docker inspect` ç›´æ¥æŸ¥çœ‹å®¹å™¨çš„ipåœ°å€ï¼š

![](images/image-20250114155033104.png)

ä¸¤ä¸ªå®¹å™¨çš„IPåœ°å€åˆ†åˆ«æ˜¯â€œ172.17.0.2â€å’Œâ€œ172.17.0.3â€ï¼Œè€Œå®¿ä¸»æœºçš„IPåœ°å€åˆ™æ˜¯â€œ172.17.0.1â€ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½åœ¨â€œ172.17.0.0/16â€è¿™ä¸ªDockerçš„é»˜è®¤ç½‘æ®µï¼Œå½¼æ­¤ä¹‹é—´å°±èƒ½å¤Ÿä½¿ç”¨IPåœ°å€æ¥å®ç°ç½‘ç»œé€šä¿¡äº†ã€‚

### 6.4 å¦‚ä½•åˆ†é…æœåŠ¡ç«¯å£å·

æœåŠ¡å™¨åº”ç”¨éƒ½å¿…é¡»è¦æœ‰ç«¯å£å·æ‰èƒ½å¯¹å¤–æä¾›æœåŠ¡ï¼Œæ¯”å¦‚HTTPåè®®ç”¨80ã€HTTPSç”¨443ã€Redisæ˜¯6379ã€MySQLæ˜¯3306ã€‚

**ç«¯å£å·æ˜ å°„éœ€è¦ä½¿ç”¨bridgeæ¨¡å¼ï¼Œå¹¶ä¸”åœ¨ `docker run` å¯åŠ¨å®¹å™¨æ—¶ä½¿ç”¨ `-p` å‚æ•°ï¼Œå½¢å¼å’Œå…±äº«ç›®å½•çš„ `-v` å‚æ•°å¾ˆç±»ä¼¼ï¼Œç”¨ `:` åˆ†éš”æœ¬æœºç«¯å£å’Œå®¹å™¨ç«¯å£**ã€‚

```sh
$ docker run -d -p 80:80 --rm nginx:alpine
9726b1db68c288a26d3461961e51cdbc30a7dcdf1ec59c82d01af8391f900bdf
$ docker run -d -p 8080:80 --rm nginx:alpine
1b042e8da44644a5e1e611b19759fd6f3217e87020f3872ddbf3df6a826e82d3
$ curl 127.1:8080 -I
HTTP/1.1 200 OK
Server: nginx/1.27.3
Date: Tue, 14 Jan 2025 07:56:08 GMT
Content-Type: text/html
Content-Length: 615
Last-Modified: Tue, 26 Nov 2024 17:22:24 GMT
Connection: keep-alive
ETag: "674603d0-267"
Accept-Ranges: bytes

$ curl 127.1:80 -I
HTTP/1.1 200 OK
Server: nginx/1.27.3
Date: Tue, 14 Jan 2025 07:56:13 GMT
Content-Type: text/html
Content-Length: 615
Last-Modified: Tue, 26 Nov 2024 17:22:24 GMT
Connection: keep-alive
ETag: "674603d0-267"
Accept-Ranges: bytes
```

![](images/image-20250114155739396.png)

### å°ç»“

```
docker cp
docker run -v
docker run -p
```

### æ€è€ƒé¢˜

>  `docker cp` å‘½ä»¤å’ŒDockerfileé‡Œçš„`COPY`æŒ‡ä»¤æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ



> hostæ¨¡å¼å’Œbridgeæ¨¡å¼å„æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Œåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹åº”ç”¨æœ€åˆé€‚ï¼Ÿ

- Bridge æ¨¡å¼

é€‚åˆå¤§å¤šæ•°å¼€å‘ã€æµ‹è¯•å’Œä¸€èˆ¬çš„ç”Ÿäº§åœºæ™¯ï¼Œæä¾›äº†è¾ƒå¥½çš„ç½‘ç»œéš”ç¦»æ€§å’Œçµæ´»çš„ç½‘ç»œé…ç½®ï¼Œä½†åœ¨æ€§èƒ½å’Œç½‘ç»œæ‹“æ‰‘å¤æ‚æ—¶éœ€è¦è€ƒè™‘æ€§èƒ½å’Œç½‘ç»œé…ç½®çš„å¤æ‚æ€§ã€‚

- Host æ¨¡å¼

é€‚åˆå¯¹æ€§èƒ½è¦æ±‚é«˜ã€éœ€è¦ä¸ä¸»æœºç½‘ç»œç´§å¯†äº¤äº’çš„åº”ç”¨ï¼Œä½†åœ¨ä½¿ç”¨æ—¶è¦æ³¨æ„ç½‘ç»œéš”ç¦»å’Œå®‰å…¨é£é™©ï¼Œé¿å…å¯¹ä¸»æœºç½‘ç»œé€ æˆå½±å“ã€‚

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œéœ€è¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡éœ€æ±‚ã€æ€§èƒ½è¦æ±‚å’Œå®‰å…¨è€ƒè™‘ï¼Œåˆç†é€‰æ‹© Docker çš„ç½‘ç»œæ¨¡å¼ï¼Œç¡®ä¿å®¹å™¨çš„ç½‘ç»œæ€§èƒ½å’Œå®‰å…¨ã€‚



## 7 å®æˆ˜æ¼”ç»ƒï¼šç©è½¬Docker

### 7.1 å®¹å™¨æŠ€æœ¯è¦ç‚¹å›é¡¾

å®¹å™¨æŠ€æœ¯æ˜¯åç«¯åº”ç”¨é¢†åŸŸçš„ä¸€é¡¹é‡å¤§åˆ›æ–°ï¼Œå®ƒå½»åº•å˜é©äº†åº”ç”¨çš„å¼€å‘ã€äº¤ä»˜ä¸éƒ¨ç½²æ–¹å¼ï¼Œæ˜¯â€œäº‘åŸç”Ÿâ€çš„æ ¹æœ¬ï¼ˆ[01è®²]ï¼‰ã€‚

å®¹å™¨åŸºäºLinuxåº•å±‚çš„namespaceã€cgroupã€chrootç­‰åŠŸèƒ½ï¼Œè™½ç„¶å®ƒä»¬å¾ˆæ—©å°±å‡ºç°äº†ï¼Œä½†ç›´åˆ°Dockerâ€œæ¨ªç©ºå‡ºä¸–â€ï¼ŒæŠŠå®ƒä»¬æ•´åˆåœ¨ä¸€èµ·ï¼Œå®¹å™¨æ‰çœŸæ­£èµ°è¿‘äº†å¤§ä¼—çš„è§†é‡ï¼Œé€æ¸ä¸ºå¹¿å¤§å¼€å‘è€…æ‰€ç†ŸçŸ¥ï¼ˆ[02è®²]ï¼‰ã€‚

å®¹å™¨æŠ€æœ¯ä¸­æœ‰ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š**å®¹å™¨ï¼ˆContainerï¼‰**ã€**é•œåƒï¼ˆImageï¼‰**ï¼Œä»¥åŠ**é•œåƒä»“åº“ï¼ˆRegistryï¼‰**ï¼ˆ[03è®²]ï¼‰ã€‚

ä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œå®¹å™¨å±äºè™šæ‹ŸåŒ–æŠ€æœ¯çš„ä¸€ç§ï¼Œå’Œè™šæ‹Ÿæœºï¼ˆVirtual Machineï¼‰å¾ˆç±»ä¼¼ï¼Œéƒ½èƒ½å¤Ÿåˆ†æ‹†ç³»ç»Ÿèµ„æºï¼Œéš”ç¦»åº”ç”¨è¿›ç¨‹ï¼Œä½†å®¹å™¨æ›´åŠ è½»é‡çº§ï¼Œè¿è¡Œæ•ˆç‡æ›´é«˜ï¼Œæ¯”è™šæ‹Ÿæœºæ›´é€‚åˆäº‘è®¡ç®—çš„éœ€æ±‚ã€‚

é•œåƒæ˜¯å®¹å™¨çš„é™æ€å½¢å¼ï¼Œå®ƒæŠŠåº”ç”¨ç¨‹åºè¿åŒä¾èµ–çš„æ“ä½œç³»ç»Ÿã€é…ç½®æ–‡ä»¶ã€ç¯å¢ƒå˜é‡ç­‰ç­‰éƒ½æ‰“åŒ…åˆ°äº†ä¸€èµ·ï¼Œå› è€Œèƒ½å¤Ÿåœ¨ä»»ä½•ç³»ç»Ÿä¸Šè¿è¡Œï¼Œå…é™¤äº†å¾ˆå¤šéƒ¨ç½²è¿ç»´å’Œå¹³å°è¿ç§»çš„éº»çƒ¦ã€‚

é•œåƒå†…éƒ¨ç”±å¤šä¸ªå±‚ï¼ˆLayerï¼‰ç»„æˆï¼Œæ¯ä¸€å±‚éƒ½æ˜¯ä¸€ç»„æ–‡ä»¶ï¼Œå¤šä¸ªå±‚ä¼šä½¿ç”¨Union FSæŠ€æœ¯åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¾›å®¹å™¨ä½¿ç”¨ã€‚è¿™ç§ç»†ç²’åº¦ç»“æ„çš„å¥½å¤„æ˜¯ç›¸åŒçš„å±‚å¯ä»¥å…±äº«ã€å¤ç”¨ï¼ŒèŠ‚çº¦ç£ç›˜å­˜å‚¨å’Œç½‘ç»œä¼ è¾“çš„æˆæœ¬ï¼Œä¹Ÿè®©æ„å»ºé•œåƒçš„å·¥ä½œå˜å¾—æ›´åŠ å®¹æ˜“ï¼ˆ[04è®²]ï¼‰ã€‚

ä¸ºäº†æ–¹ä¾¿ç®¡ç†é•œåƒï¼Œå°±å‡ºç°äº†é•œåƒä»“åº“ï¼Œå®ƒé›†ä¸­å­˜æ”¾å„ç§å®¹å™¨åŒ–çš„åº”ç”¨ï¼Œç”¨æˆ·å¯ä»¥ä»»æ„ä¸Šä¼ ä¸‹è½½ï¼Œæ˜¯åˆ†å‘é•œåƒçš„æœ€ä½³æ–¹å¼ï¼ˆ[05è®²]ï¼‰ã€‚

ç›®å‰æœ€çŸ¥åçš„å…¬å¼€é•œåƒä»“åº“æ˜¯Docker Hubï¼Œå…¶ä»–çš„è¿˜æœ‰quay.ioã€gcr.ioï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™äº›ç½‘ç«™ä¸Šæ‰¾åˆ°è®¸å¤šé«˜è´¨é‡é•œåƒï¼Œé›†æˆåˆ°æˆ‘ä»¬è‡ªå·±çš„åº”ç”¨ç³»ç»Ÿä¸­ã€‚

å®¹å™¨æŠ€æœ¯æœ‰å¾ˆå¤šå…·ä½“çš„å®ç°ï¼ŒDockeræ˜¯æœ€åˆä¹Ÿæ˜¯æœ€æµè¡Œçš„å®¹å™¨æŠ€æœ¯ï¼Œå®ƒçš„ä¸»è¦å½¢æ€æ˜¯è¿è¡Œåœ¨Linuxä¸Šçš„â€œDocker Engineâ€ã€‚æˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨çš„ `docker` å‘½ä»¤å…¶å®åªæ˜¯ä¸€ä¸ªå‰ç«¯å·¥å…·ï¼Œå®ƒå¿…é¡»ä¸åå°æœåŠ¡â€œDocker daemonâ€é€šä¿¡æ‰èƒ½å®ç°å„ç§åŠŸèƒ½ã€‚

æ“ä½œå®¹å™¨çš„å¸¸ç”¨å‘½ä»¤æœ‰ `docker ps`ã€`docker run`ã€`docker exec`ã€`docker stop` ç­‰ï¼›

æ“ä½œé•œåƒçš„å¸¸ç”¨å‘½ä»¤æœ‰ `docker images`ã€`docker rmi`ã€`docker build`ã€`docker tag` ç­‰ï¼›

æ“ä½œé•œåƒä»“åº“çš„å¸¸ç”¨å‘½ä»¤æœ‰ `docker pull`ã€`docker push` ç­‰ã€‚



### 7.2 å®æˆ˜1ï¼šå»ºç§æœ‰é•œåƒä»“åº“

é€‰æ‹©æœ€ç®€å•çš„[Docker Registry](https://registry.hub.docker.com/_/registry/)ã€‚

```
docker pull registry
```

å¯¹å¤–æš´éœ²ç«¯å£ï¼Œè¿™æ ·Docker Registryæ‰èƒ½æä¾›æœåŠ¡ï¼Œå®ƒçš„å®¹å™¨å†…ç«¯å£æ˜¯5000ï¼Œç®€å•èµ·è§ï¼Œåœ¨å¤–é¢ä¹Ÿå¯ä»¥ä½¿ç”¨åŒæ ·çš„5000ç«¯å£:

```sh
docker run -d -p 5000:5000 registry
24c8feddb2ce3c78ca87df0874b899a47d0278930b603b2e19fc59a0486ba30c

docker ps
CONTAINER ID   IMAGE          COMMAND                   CREATED          STATUS          PORTS                                       NAMES
24c8feddb2ce   registry       "/entrypoint.sh /etcâ€¦"   5 seconds ago    Up 4 seconds    0.0.0.0:5000->5000/tcp, :::5000->5000/tcp   jovial_rubin
```

ä½¿ç”¨ `docker tag` å‘½ä»¤ç»™é•œåƒæ‰“æ ‡ç­¾å†ä¸Šä¼ äº†ã€‚å› ä¸ºä¸Šä¼ çš„ç›®æ ‡ä¸æ˜¯é»˜è®¤çš„Docker Hubï¼Œè€Œæ˜¯æœ¬åœ°çš„ç§æœ‰ä»“åº“ï¼Œæ‰€ä»¥é•œåƒçš„åå­—å‰é¢è¿˜å¿…é¡»å†åŠ ä¸Šä»“åº“çš„åœ°å€ï¼ˆåŸŸåæˆ–è€…IPåœ°å€éƒ½è¡Œï¼‰ï¼Œå½¢å¼ä¸Šå’ŒHTTPçš„URLéå¸¸åƒï¼š

```sh
docker tag nginx:alpine 127.0.0.1:5000/nginx:alpine

docker images
REPOSITORY             TAG           IMAGE ID       CREATED         SIZE
127.0.0.1:5000/nginx   alpine        f9d642c42f7b   6 weeks ago     50.9MB
nginx                  alpine        f9d642c42f7b   6 weeks ago     50.9MB
```

ç°åœ¨ï¼Œè¿™ä¸ªé•œåƒæœ‰äº†ä¸€ä¸ªé™„åŠ ä»“åº“åœ°å€çš„å®Œæ•´åå­—ï¼Œå°±å¯ä»¥ç”¨ `docker push` æ¨ä¸Šå»äº†ï¼š

```sh
$ docker push 127.0.0.1:5000/nginx:alpine
The push refers to repository [127.0.0.1:5000/nginx]
a81f475c8ce2: Pushed 
856b39837f15: Pushed 
20ca17bb1caf: Pushed 
3bc38db2acdb: Pushed 
e1482d480729: Pushed 
cbb38b57f140: Pushed 
b2910501c843: Pushed 
534a70dc8296: Pushed 
alpine: digest: sha256:4311264dbcbc9f56fa0809d1b4c551827c64abbc717bcd7a76f4407bbfc863b6 size: 1989
```



ä¸ºäº†éªŒè¯æ˜¯å¦å·²ç»æˆåŠŸæ¨é€ï¼Œå¯ä»¥æŠŠåˆšæ‰æ‰“æ ‡ç­¾çš„é•œåƒåˆ æ‰ï¼Œå†é‡æ–°ä¸‹è½½ï¼š

```
docker rmi  127.0.0.1:5000/nginx:alpine
docker pull 127.0.0.1:5000/nginx:alpine
```

```sh
$ docker rmi  127.0.0.1:5000/nginx:alpine
Untagged: 127.0.0.1:5000/nginx:alpine
Untagged: 127.0.0.1:5000/nginx@sha256:4311264dbcbc9f56fa0809d1b4c551827c64abbc717bcd7a76f4407bbfc863b6

$ docker pull 127.0.0.1:5000/nginx:alpine
alpine: Pulling from nginx
Digest: sha256:4311264dbcbc9f56fa0809d1b4c551827c64abbc717bcd7a76f4407bbfc863b6
Status: Downloaded newer image for 127.0.0.1:5000/nginx:alpine
127.0.0.1:5000/nginx:alpine
```

åŸæ¥çš„å±‚åŸæœ¬å°±å·²ç»å­˜åœ¨ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰å®é™…çš„ä¸‹è½½åŠ¨ä½œï¼Œåªä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒæ ‡ç­¾ã€‚

Docker Registryè™½ç„¶æ²¡æœ‰å›¾å½¢ç•Œé¢ï¼Œä½†æä¾›äº†RESTful APIï¼Œä¹Ÿå¯ä»¥å‘é€HTTPè¯·æ±‚æ¥æŸ¥çœ‹ä»“åº“é‡Œçš„é•œåƒï¼Œå…·ä½“çš„ç«¯ç‚¹ä¿¡æ¯å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼ˆhttps://docs.docker.com/registry/spec/api/ï¼‰ï¼Œä¸‹é¢çš„è¿™ä¸¤æ¡curlå‘½ä»¤å°±åˆ†åˆ«è·å–äº†é•œåƒåˆ—è¡¨å’ŒNginxé•œåƒçš„æ ‡ç­¾åˆ—è¡¨ï¼š

```sh
curl 127.1:5000/v2/_catalog
curl 127.1:5000/v2/nginx/tags/list
```

```sh
curl 127.1:5000/v2/_catalog
{"repositories":["nginx"]}
curl 127.1:5000/v2/nginx/tags/list
{"name":"nginx","tags":["alpine"]}
```



### 7.3 å®æˆ˜2ï¼šæ­å»ºWordPressç½‘ç«™

```sh
docker pull wordpress:5
docker pull mariadb:10
docker pull nginx:alpine
```

![](images/59dfbe961bcd233b83e1c1ec064e2eca.png)

è¿™ä¸ªç³»ç»Ÿå¯ä»¥è¯´æ˜¯æ¯”è¾ƒå…¸å‹çš„ç½‘ç«™äº†ã€‚MariaDBä½œä¸ºåé¢çš„å…³ç³»å‹æ•°æ®åº“ï¼Œç«¯å£å·æ˜¯3306ï¼›WordPressæ˜¯ä¸­é—´çš„åº”ç”¨æœåŠ¡å™¨ï¼Œä½¿ç”¨MariaDBæ¥å­˜å‚¨æ•°æ®ï¼Œå®ƒçš„ç«¯å£æ˜¯80ï¼›Nginxæ˜¯å‰é¢çš„åå‘ä»£ç†ï¼Œå®ƒå¯¹å¤–æš´éœ²80ç«¯å£ï¼Œç„¶åæŠŠè¯·æ±‚è½¬å‘ç»™WordPressã€‚

ç”¨ `--env` å‚æ•°æ¥æŒ‡å®šå¯åŠ¨æ—¶çš„æ•°æ®åº“ã€ç”¨æˆ·åå’Œå¯†ç :

```
docker run -d --rm \
    --env MARIADB_DATABASE=db \
    --env MARIADB_USER=wp \
    --env MARIADB_PASSWORD=123 \
    --env MARIADB_ROOT_PASSWORD=123 \
    mariadb:10
```

ä½¿ç”¨ `docker exec` å‘½ä»¤ï¼Œæ‰§è¡Œæ•°æ®åº“çš„å®¢æˆ·ç«¯å·¥å…·â€œmysqlâ€ï¼ŒéªŒè¯æ•°æ®åº“æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š

```
docker exec -it 64d mysql -u wp -p
```



```sh
$ docker run -d --rm \
    --env MARIADB_DATABASE=db \
    --env MARIADB_USER=wp \
    --env MARIADB_PASSWORD=123 \
    --env MARIADB_ROOT_PASSWORD=123 \
    mariadb:10
64d53f78a94825e5f36fde8cf3f89215633a322e7075e491128cb3197053754c
$ docker exec -it 64d mysql -u wp -p
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 3
Server version: 10.11.10-MariaDB-ubu2204 mariadb.org binary distribution

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| db                 |
| information_schema |
+--------------------+
2 rows in set (0.001 sec)
```

Dockerçš„bridgeç½‘ç»œæ¨¡å¼çš„é»˜è®¤ç½‘æ®µæ˜¯â€œ172.17.0.0/16â€ï¼Œå®¿ä¸»æœºå›ºå®šæ˜¯â€œ172.17.0.1â€ï¼Œè€Œä¸”IPåœ°å€æ˜¯é¡ºåºåˆ†é…çš„ã€‚

```
docker inspect 64d | grep IPAddress
            "SecondaryIPAddresses": null,
            "IPAddress": "172.17.0.7",
                    "IPAddress": "172.17.0.7",
```



è¿è¡Œåº”ç”¨æœåŠ¡å™¨WordPressä¹Ÿè¦ç”¨ `--env` å‚æ•°æ¥æŒ‡å®šä¸€äº›ç¯å¢ƒå˜é‡æ‰èƒ½è¿æ¥åˆ°MariaDBï¼Œæ³¨æ„â€œWORDPRESS_DB_HOSTâ€å¿…é¡»æ˜¯MariaDBçš„IPåœ°å€ï¼Œå¦åˆ™ä¼šæ— æ³•è¿æ¥æ•°æ®åº“ï¼š

```sh
$ docker run -d --rm \
    --env WORDPRESS_DB_HOST=172.17.0.7 \
    --env WORDPRESS_DB_USER=wp \
    --env WORDPRESS_DB_PASSWORD=123 \
    --env WORDPRESS_DB_NAME=db \
    wordpress:5
    
36caa9db5e8f437d56fee2334ef0975dae71529331551e2b0c6fe59a4e330111  

$ docker inspect 36c | grep IPAddress
            "SecondaryIPAddresses": null,
            "IPAddress": "172.17.0.8",
                    "IPAddress": "172.17.0.8",
```

WordPresså®¹å™¨åœ¨å¯åŠ¨çš„æ—¶å€™å¹¶æ²¡æœ‰ä½¿ç”¨ `-p` å‚æ•°æ˜ å°„ç«¯å£å·ï¼Œæ‰€ä»¥å¤–ç•Œæ˜¯ä¸èƒ½ç›´æ¥è®¿é—®çš„ï¼Œéœ€è¦åœ¨å‰é¢é…ä¸€ä¸ªNginxåå‘ä»£ç†ï¼ŒæŠŠè¯·æ±‚è½¬å‘ç»™WordPressçš„80ç«¯å£ã€‚é…ç½®Nginxåå‘ä»£ç†å¿…é¡»è¦çŸ¥é“WordPressçš„IPåœ°å€ã€‚

nginxçš„é…ç½®æ–‡ä»¶ï¼ˆwp.confï¼‰ï¼š

```nginx
server {
  listen 80;
  default_type text/html;

  location / {
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_pass http://172.17.0.8;
  }
}
```

æœ‰äº†è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œå°±éœ€è¦ç”¨ `-p` å‚æ•°æŠŠæœ¬æœºçš„ç«¯å£æ˜ å°„åˆ°Nginxå®¹å™¨å†…éƒ¨çš„80ç«¯å£ï¼Œå†ç”¨ `-v` å‚æ•°æŠŠé…ç½®æ–‡ä»¶æŒ‚è½½åˆ°Nginxçš„â€œconf.dâ€ç›®å½•ä¸‹ã€‚è¿™æ ·ï¼ŒNginxå°±ä¼šä½¿ç”¨åˆšæ‰ç¼–å†™å¥½çš„é…ç½®æ–‡ä»¶ï¼Œåœ¨80ç«¯å£ä¸Šç›‘å¬HTTPè¯·æ±‚ï¼Œå†è½¬å‘åˆ°WordPressåº”ç”¨ï¼š

```sh
docker run -d --rm \
    -p 80:80 \
    -v `pwd`/wp.conf:/etc/nginx/conf.d/default.conf \
    nginx:alpine
```

![](images/image-20250114182801810.png)

å¯ä»¥çœ‹åˆ°ï¼ŒWordPresså’ŒMariaDBè™½ç„¶ä½¿ç”¨äº†80å’Œ3306ç«¯å£ï¼Œä½†è¢«å®¹å™¨éš”ç¦»ï¼Œå¤–ç•Œä¸å¯è§ï¼Œåªæœ‰Nginxæœ‰ç«¯å£æ˜ å°„ï¼Œèƒ½å¤Ÿä»å¤–ç•Œçš„80ç«¯å£æ”¶å‘æ•°æ®ï¼Œç½‘ç»œçŠ¶æ€å’Œæˆ‘ä»¬çš„æ¶æ„å›¾æ˜¯ä¸€è‡´çš„ã€‚



åœ¨æµè§ˆå™¨è®¿é—®http://10.211.55.6/ï¼Œå°±å¯ä»¥çœ‹åˆ°WordPressçš„ç•Œé¢ï¼ŒæŒ‰æ­¥éª¤åˆ›å»ºåŸºæœ¬çš„ç”¨æˆ·ã€åˆå§‹åŒ–ç½‘ç«™ä¹‹åï¼ŒMariaDBä¸­å°±æœ‰ç›¸åº”çš„è¡¨:

```sh
$ docker exec -it 64d mysql -u wp -p
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 3
Server version: 10.11.10-MariaDB-ubu2204 mariadb.org binary distribution

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]> use db;
Database changed
MariaDB [db]> show tables;
Empty set (0.000 sec)

MariaDB [db]> show tables;
+-----------------------+
| Tables_in_db          |
+-----------------------+
| wp_commentmeta        |
| wp_comments           |
| wp_links              |
| wp_options            |
| wp_postmeta           |
| wp_posts              |
| wp_term_relationships |
| wp_term_taxonomy      |
| wp_termmeta           |
| wp_terms              |
| wp_usermeta           |
| wp_users              |
+-----------------------+
12 rows in set (0.001 sec)
```



### å°ç»“

![](images/79f8c75e018e0a82eff432786110ef16.jpg)

åœ¨æ„Ÿå—å®¹å™¨ä¾¿åˆ©çš„åŒæ—¶ï¼Œè¿˜æ˜¯å­˜åœ¨ä¸€äº›é—æ†¾å‘¢ï¼Ÿæ¯”å¦‚è¯´ï¼š

- æˆ‘ä»¬è¿˜æ˜¯è¦æ‰‹åŠ¨è¿è¡Œä¸€äº›å‘½ä»¤æ¥å¯åŠ¨åº”ç”¨ï¼Œç„¶åå†äººå·¥ç¡®è®¤è¿è¡ŒçŠ¶æ€ã€‚
- è¿è¡Œå¤šä¸ªå®¹å™¨ç»„æˆçš„åº”ç”¨æ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦äººå·¥å¹²é¢„ï¼ˆå¦‚æ£€æŸ¥IPåœ°å€ï¼‰æ‰èƒ½ç»´æŠ¤ç½‘ç»œé€šä¿¡ã€‚
- ç°æœ‰çš„ç½‘ç»œæ¨¡å¼åŠŸèƒ½åªé€‚åˆå•æœºï¼Œå¤šå°æœåŠ¡å™¨ä¸Šè¿è¡Œåº”ç”¨ã€è´Ÿè½½å‡è¡¡è¯¥æ€ä¹ˆåšï¼Ÿ
- å¦‚æœè¦å¢åŠ åº”ç”¨æ•°é‡è¯¥æ€ä¹ˆåŠï¼Ÿè¿™æ—¶å®¹å™¨æŠ€æœ¯å®Œå…¨å¸®ä¸ä¸Šå¿™ã€‚

è¿™ä¸ªæ–¹æ¡ˆå·²ç»è¶…è¶Šäº†å®¹å™¨æŠ€æœ¯æœ¬èº«ï¼Œæ˜¯åœ¨æ›´é«˜çš„å±‚æ¬¡ä¸Šè§„åˆ’å®¹å™¨çš„è¿è¡Œæ¬¡åºã€ç½‘ç»œè¿æ¥ã€æ•°æ®æŒä¹…åŒ–ç­‰åº”ç”¨è¦ç´ ï¼Œä¹Ÿå°±æ˜¯ç°åœ¨æˆ‘ä»¬å¸¸è¯´çš„â€œ**å®¹å™¨ç¼–æ’**â€ï¼ˆContainer Orchestrationï¼‰çš„é›å½¢ï¼Œä¹Ÿæ­£æ˜¯åé¢è¦å­¦ä¹ çš„Kubernetesçš„ä¸»è¦å‡ºå‘ç‚¹ã€‚



## 8 è§†é¢‘ï¼šå…¥é—¨ç¯‡å®æ“æ€»ç»“

```
docker version
docker info æ˜¾ç¤ºçš„æ˜¯å½“å‰ç³»ç»Ÿç›¸å…³çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ CPUã€å†…å­˜ã€å®¹å™¨æ•°é‡ã€é•œåƒæ•°é‡ã€å®¹å™¨è¿è¡Œæ—¶ã€å­˜å‚¨æ–‡ä»¶ç³»ç»Ÿç­‰ç­‰ã€‚
```



### æ„å»ºè‡ªå·±çš„é•œåƒ

```dockerfile
ARG IMAGE_BASE="nginx"
ARG IMAGE_TAG="1.21-alpine"

FROM ${IMAGE_BASE}:${IMAGE_TAG}

ENV PATH=$PATH:/tmp
ENV DEBUG=OFF

COPY ./default.conf /etc/nginx/conf.d/

RUN cd /usr/share/nginx/html \
		&& echo "hello nginx" > a.txt

EXPOSE 8081 8082 8083

WORKDIR /etc/nginx
```



`expose` æ˜¯å£°æ˜å®¹å™¨å¯¹å¤–æœåŠ¡çš„ç«¯å£å·ï¼Œè€Œ `workdir` æ˜¯å®¹å™¨çš„å·¥ä½œç›®å½•ã€‚



```sh
docker build -t ngx-app:1.0 .

docker run -it --rm ngx-app:1.0 sh


```



è¿˜å¯ä»¥ç”¨ docker save/load å‘½ä»¤æŠŠå®ƒå¯¼å‡ºæˆå‹ç¼©åŒ…ï¼Œæ–¹ä¾¿ä¿å­˜å’Œä¼ è¾“ï¼š

```sh
docker save ngx-app:1.0 -o ngx.tar
docker load -i ngx.tar
```



### ä¸å¤–éƒ¨ç³»ç»Ÿäº’é€šçš„æ“ä½œ





# åˆçº§

## 9 èµ°è¿‘äº‘åŸç”Ÿï¼šå¦‚ä½•åœ¨æœ¬æœºæ­å»ºå°å·§å®Œå¤‡çš„Kubernetesç¯å¢ƒ

[kuberneteså®˜ç½‘](https://kubernetes.io/zh-cn/)

### 9.1 ä»€ä¹ˆæ˜¯å®¹å™¨ç¼–æ’

å®¹å™¨æŠ€æœ¯çš„æ ¸å¿ƒæ¦‚å¿µæ˜¯å®¹å™¨ã€é•œåƒã€ä»“åº“ï¼Œä½¿ç”¨å®ƒä»¬å¯ä»¥è½»æ¾åœ°å®Œæˆåº”ç”¨çš„æ‰“åŒ…ã€åˆ†å‘å·¥ä½œã€‚

ä¸è¿‡å®¹å™¨æŠ€æœ¯åœ¨é¢å¯¹æœåŠ¡å™¨é›†ç¾¤æ˜¯ï¼Œåªæ˜¯è§£å†³äº†è¿ç»´éƒ¨ç½²å·¥ä½œçš„å°é—®é¢˜ã€‚

ç°å®ç”Ÿäº§ç¯å¢ƒçš„å¤æ‚ç¨‹åº¦å®åœ¨æ˜¯å¤ªé«˜äº†ï¼Œé™¤äº†æœ€åŸºæœ¬çš„å®‰è£…ï¼Œè¿˜ä¼šæœ‰å„å¼å„æ ·çš„éœ€æ±‚ï¼Œæ¯”å¦‚**æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€çŠ¶æ€ç›‘æ§ã€å¥åº·æ£€æŸ¥ã€æ‰©å®¹ç¼©å®¹ã€åº”ç”¨è¿ç§»ã€é«˜å¯ç”¨**ç­‰ç­‰ã€‚

è™½ç„¶å®¹å™¨æŠ€æœ¯==å¼€å¯==äº†äº‘åŸç”Ÿæ—¶ä»£ï¼Œä½†å®ƒä¹Ÿåªèµ°å‡ºäº†ä¸€å°æ­¥ï¼Œå†ç»§ç»­å‰è¿›å°±æ— èƒ½ä¸ºåŠ›äº†ï¼Œå› ä¸ºè¿™å·²ç»ä¸å†æ˜¯éš”ç¦»ä¸€ä¸¤ä¸ªè¿›ç¨‹çš„æ™®é€šé—®é¢˜ï¼Œè€Œæ˜¯è¦**éš”ç¦»æ•°ä¸æ¸…çš„è¿›ç¨‹**ï¼Œè¿˜æœ‰å®ƒä»¬ä¹‹é—´**äº’ç›¸é€šä¿¡ã€äº’ç›¸åä½œ**çš„è¶…çº§é—®é¢˜ï¼Œå›°éš¾ç¨‹åº¦å¯ä»¥è¯´æ˜¯æŒ‡æ•°çº§åˆ«çš„ä¸Šå‡ã€‚

è¿™äº›å®¹å™¨ä¹‹ä¸Šçš„ç®¡ç†ã€è°ƒåº¦å·¥ä½œï¼Œå°±æ˜¯è¿™äº›å¹´æœ€æµè¡Œçš„è¯æ±‡ï¼šâ€œ**==å®¹å™¨ç¼–æ’==**â€ï¼ˆContainer Orchestrationï¼‰ã€‚

### 9.2 ä»€ä¹ˆæ˜¯Kubernetes

Google é›†ç¾¤åº”ç”¨ç®¡ç†ç³»ç»Ÿï¼Œä»£å·Borg

==2014==å¹´ï¼ŒGoogleå†…éƒ¨ç³»ç»Ÿè¦â€œå‡çº§æ¢ä»£â€ï¼Œä»åŸæ¥çš„Borgåˆ‡æ¢åˆ°Omegaã€‚

å› ä¸ºä¹‹å‰åœ¨å‘è¡¨MapReduceã€BigTableã€GFSæ—¶åƒè¿‡äºï¼ˆè¢«Yahooå¼€å‘çš„Hadoopå é¢†äº†å¸‚åœºï¼‰ï¼Œæ‰€ä»¥Googleå†³å®šå€Ÿç€Dockerçš„â€œä¸œé£â€ï¼Œåœ¨å‘è®ºæ–‡çš„åŒæ—¶ï¼ŒæŠŠC++å¼€å‘çš„Borgç³»ç»Ÿç”¨Goè¯­è¨€é‡å†™å¹¶å¼€æºï¼Œäºæ˜¯Kuberneteså°±è¿™æ ·è¯ç”Ÿäº†ã€‚

ç”±äºKubernetesèƒŒåæœ‰Borgç³»ç»Ÿåå¤šå¹´ç”Ÿäº§ç¯å¢ƒç»éªŒçš„æ”¯æŒï¼ŒæŠ€æœ¯åº•è•´æ·±åšï¼Œç†è®ºæ°´å¹³ä¹Ÿéå¸¸é«˜ï¼Œä¸€ç»æ¨å‡ºå°±å¼•èµ·äº†è½°åŠ¨ã€‚ç„¶ååœ¨==2015==å¹´ï¼ŒGoogleåˆè”åˆLinuxåŸºé‡‘ä¼šæˆç«‹äº†==CNCFï¼ˆCloud Native Computing Foundationï¼Œäº‘åŸç”ŸåŸºé‡‘ä¼šï¼‰==ï¼Œå¹¶æŠŠKubernetesæçŒ®å‡ºæ¥ä½œä¸ºç§å­é¡¹ç›®ã€‚

æœ‰äº†Googleå’ŒLinuxè¿™ä¸¤å¤§å®¶æ—çš„ä¿é©¾æŠ¤èˆªï¼Œå†åŠ ä¸Šå®½å®¹å¼€æ”¾çš„ç¤¾åŒºï¼Œä½œä¸ºCNCFçš„â€œå¤´æŠŠäº¤æ¤…â€ï¼ŒKubernetesæ——ä¸‹å¾ˆå¿«å°±æ±‡é›†äº†ä¼—å¤šè¡Œä¸šç²¾è‹±ï¼Œä»…ç”¨äº†ä¸¤å¹´çš„æ—¶é—´å°±æ‰“è´¥äº†åŒæœŸçš„ç«äº‰å¯¹æ‰‹Apache Mesoså’ŒDocker Swarmï¼Œæˆä¸ºäº†è¿™ä¸ªé¢†åŸŸçš„å”¯ä¸€éœ¸ä¸»ã€‚

ç®€å•æ¥è¯´ï¼ŒKuberneteså°±æ˜¯ä¸€ä¸ª**==ç”Ÿäº§çº§åˆ«çš„å®¹å™¨ç¼–æ’å¹³å°å’Œé›†ç¾¤ç®¡ç†ç³»ç»Ÿ==**ï¼Œä¸ä»…èƒ½å¤Ÿåˆ›å»ºã€è°ƒåº¦å®¹å™¨ï¼Œè¿˜èƒ½å¤Ÿç›‘æ§ã€ç®¡ç†æœåŠ¡å™¨ï¼Œå®ƒå‡èšäº†Googleç­‰å¤§å…¬å¸å’Œå¼€æºç¤¾åŒºçš„é›†ä½“æ™ºæ…§ï¼Œä»è€Œè®©ä¸­å°å‹å…¬å¸ä¹Ÿå¯ä»¥å…·å¤‡**è½»æ¾è¿ç»´æµ·é‡è®¡ç®—èŠ‚ç‚¹** â€”â€” ä¹Ÿå°±æ˜¯â€œäº‘è®¡ç®—â€çš„èƒ½åŠ›ã€‚

### 9.3 ä»€ä¹ˆæ˜¯minikube

Kubernetesä¸€èˆ¬éƒ½è¿è¡Œåœ¨å¤§è§„æ¨¡çš„è®¡ç®—é›†ç¾¤ä¸Šï¼Œç®¡ç†å¾ˆä¸¥æ ¼ï¼Œè¿™å°±å¯¹æˆ‘ä»¬ä¸ªäººæ¥è¯´é€ æˆäº†ä¸€å®šçš„éšœç¢ï¼Œæ²¡æœ‰å®é™…æ“ä½œç¯å¢ƒæ€ä¹ˆèƒ½å¤Ÿå­¦å¥½ç”¨å¥½å‘¢ï¼Ÿ

å¥½åœ¨Kuberneteså……åˆ†è€ƒè™‘åˆ°äº†è¿™æ–¹é¢çš„éœ€æ±‚ï¼Œæä¾›äº†ä¸€äº›å¿«é€Ÿæ­å»ºKubernetesç¯å¢ƒçš„å·¥å…·ï¼Œåœ¨[å®˜ç½‘](https://kubernetes.io/zh/docs/tasks/tools/)ä¸Šæ¨èçš„æœ‰ä¸¤ä¸ªï¼š**kind**å’Œ**minikube**ï¼Œå®ƒä»¬éƒ½å¯ä»¥åœ¨æœ¬æœºä¸Šè¿è¡Œå®Œæ•´çš„Kubernetesç¯å¢ƒã€‚

- ==kind==åŸºäºDockerï¼Œæ„æ€æ˜¯â€œ**Kubernetes in Docker**â€ã€‚å®ƒåŠŸèƒ½å°‘ï¼Œç”¨æ³•ç®€å•ï¼Œä¹Ÿå› æ­¤è¿è¡Œé€Ÿåº¦å¿«ï¼Œå®¹æ˜“ä¸Šæ‰‹ã€‚ä¸è¿‡å®ƒç¼ºå°‘å¾ˆå¤šKubernetesçš„æ ‡å‡†åŠŸèƒ½ï¼Œä¾‹å¦‚ä»ªè¡¨ç›˜ã€ç½‘ç»œæ’ä»¶ï¼Œä¹Ÿå¾ˆéš¾å®šåˆ¶åŒ–ï¼Œæ¯”è¾ƒé€‚åˆæœ‰ç»éªŒçš„Kubernetesç”¨æˆ·åšå¿«é€Ÿå¼€å‘æµ‹è¯•ï¼Œä¸å¤ªé€‚åˆå­¦ä¹ ç ”ç©¶ã€‚kindçš„åå­—ä¸Kubernetes YAMLé…ç½®é‡Œçš„å­—æ®µ `kind` é‡åï¼Œä¼šå¯¹åˆå­¦è€…é€ æˆè¯¯è§£ï¼Œå¹²æ‰°å­¦ä¹ ã€‚

- ==minikube==æ˜¯ä¸€ä¸ª==â€œè¿·ä½ â€ç‰ˆæœ¬çš„Kubernetes==ï¼Œè‡ªä»2016å¹´å‘å¸ƒä»¥æ¥ä¸€ç›´åœ¨ç§¯æåœ°å¼€å‘ç»´æŠ¤ï¼Œç´§è·ŸKubernetesçš„ç‰ˆæœ¬æ›´æ–°ï¼ŒåŒæ—¶ä¹Ÿå…¼å®¹è¾ƒæ—§çš„ç‰ˆæœ¬ï¼ˆæœ€å¤šåªåˆ°ä¹‹å‰çš„6ä¸ªå°ç‰ˆæœ¬ï¼‰ã€‚

  å¯æ‰§è¡Œæ–‡ä»¶ä»…æœ‰ä¸åˆ°100MBï¼Œè¿è¡Œé•œåƒä¹Ÿä¸è¿‡1GBï¼Œä½†å°±åœ¨è¿™ä¹ˆå°çš„ç©ºé—´é‡Œå´é›†æˆäº†Kubernetesçš„ç»å¤§å¤šæ•°åŠŸèƒ½ç‰¹æ€§ï¼Œä¸ä»…æœ‰æ ¸å¿ƒçš„å®¹å™¨ç¼–æ’åŠŸèƒ½ï¼Œè¿˜æœ‰ä¸°å¯Œçš„æ’ä»¶ï¼Œä¾‹å¦‚Dashboardã€GPUã€Ingressã€Istioã€Kongã€Registryç­‰ç­‰ï¼Œç»¼åˆæ¥çœ‹éå¸¸å®Œå–„ã€‚

### 9.4 å¦‚ä½•æ­å»ºminikubeç¯å¢ƒ

https://minikube.sigs.k8s.io/docs/

å®‰è£…:

```sh
# Linux Intel x86_64
curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64

# Apple arm64  è™šæ‹Ÿæœºä¸­çš„Linux
curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-arm64

sudo install minikube /usr/local/bin/
```

```sh
$ minikube version
minikube version: v1.34.0
commit: 210b148df93a80eb872ecbeb7e35281b3c582c61
```

minikubeåªèƒ½å¤Ÿæ­å»ºKubernetesç¯å¢ƒï¼Œè¦æ“ä½œKubernetesï¼Œéœ€è¦å®¢æˆ·ç«¯å·¥å…·â€œ**==kubectl==**â€ã€‚

[kubectl](https://github.com/kubernetes/kubectl)æ˜¯ä¸€ä¸ªä¸Kubernetesã€minikubeå½¼æ­¤ç‹¬ç«‹çš„é¡¹ç›®ï¼Œæ‰€ä»¥ä¸åŒ…å«åœ¨minikubeé‡Œï¼Œä½†minikubeæä¾›äº†å®‰è£…å®ƒçš„ç®€åŒ–æ–¹å¼:

```sh
minikube kubectl
```

å®ƒå°±ä¼šæŠŠä¸å½“å‰Kubernetesç‰ˆæœ¬åŒ¹é…çš„kubectlä¸‹è½½ä¸‹æ¥ï¼Œå­˜æ”¾åœ¨å†…éƒ¨ç›®å½•ï¼ˆä¾‹å¦‚ `.minikube/cache/linux/arm64/v1.23.3`ï¼‰ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å®ƒæ¥å¯¹Kubernetesâ€œå‘å·æ–½ä»¤â€äº†ã€‚

åœ¨minikubeç¯å¢ƒé‡Œï¼Œä¼šç”¨åˆ°ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼š`minikube`ç®¡ç†Kubernetesé›†ç¾¤ç¯å¢ƒï¼Œ`kubectl`æ“ä½œå®é™…çš„KubernetesåŠŸèƒ½:

![](images/image-20250115170248853.png)

### 9.5 å®é™…éªŒè¯minikubeç¯å¢ƒ

ç°åœ¨å¯ä»¥åœ¨æœ¬æœºä¸Šè¿è¡Œminikubeï¼Œåˆ›å»ºKuberneteså®éªŒç¯å¢ƒäº†ã€‚

å‘½ä»¤ `minikube start` ä¼šä»Docker Hubä¸Šæ‹‰å–é•œåƒï¼Œä»¥å½“å‰æœ€æ–°ç‰ˆæœ¬çš„Kuberneteså¯åŠ¨é›†ç¾¤ã€‚å¯ä»¥æŒ‡å®šç‰ˆæœ¬

```sh
minikube start --kubernetes-version=v1.23.3
```

ï¼ˆé€‰æ‹©ä¸minikubeç›¸å¯¹çš„æœ€æ–°çš„Kubernetesç‰ˆæœ¬ï¼‰

```sh
minikube start --kubernetes-version=v1.31.0
```

â€‹	





```sh
minikube status
minikube node list
```

```sh
$ minikube status
minikube
type: Control Plane
host: Running
kubelet: Running
apiserver: Running
kubeconfig: Configured

$ minikube node list
minikube	192.168.49.2
```

ä»ä¸Šé¢æ¥çœ‹ï¼ŒKubernetesé›†ç¾¤é‡Œç°åœ¨åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåå­—å°±å«â€œminikubeâ€ï¼Œç±»å‹æ˜¯â€œControl Planeâ€ï¼Œé‡Œé¢æœ‰hostã€kubeletã€apiserverä¸‰ä¸ªæœåŠ¡ï¼ŒIPåœ°å€æ˜¯192.168.49.2ã€‚





```sh
minikube ssh
uname -a
exit

minikube kubectl -- version 
```



```sh
alias kubectl="minikube kubectl --"
source <(kubectl completion bash)

kubectl  version --client
Client Version: v1.31.0
Kustomize Version: v5.4.2
```

**åœ¨Kubernetesé‡Œè¿è¡Œä¸€ä¸ªNginxåº”ç”¨ï¼Œå‘½ä»¤ä¸Dockerä¸€æ ·ï¼Œä¹Ÿæ˜¯ `run`ï¼Œä¸è¿‡å½¢å¼ä¸Šæœ‰ç‚¹åŒºåˆ«ï¼Œéœ€è¦ç”¨ `--image` æŒ‡å®šé•œåƒ**ï¼Œç„¶åKubernetesä¼šè‡ªåŠ¨æ‹‰å–å¹¶è¿è¡Œï¼š

```sh
$ kubectl run ngx --image=nginx:alpine
pod/ngx created
```

Kubernetesé‡Œçš„ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼š**Pod**ï¼Œä½ å¯ä»¥æš‚æ—¶æŠŠå®ƒç†è§£æˆæ˜¯â€œç©¿äº†é©¬ç”²â€çš„å®¹å™¨ï¼ŒæŸ¥çœ‹Podåˆ—è¡¨éœ€è¦ä½¿ç”¨å‘½ä»¤ `kubectl get pod`ï¼Œå®ƒçš„æ•ˆæœç±»ä¼¼ `docker ps`ï¼š

```sh
$ kubectl get pod 
NAME   READY   STATUS             RESTARTS   AGE
ngx    0/1     ImagePullBackOff   0          74s
```

çœ‹åˆ°åœ¨Kubernetesé›†ç¾¤é‡Œå°±æœ‰äº†ä¸€ä¸ªåå­—å«ngxçš„Podæ­£åœ¨è¿è¡Œï¼Œè¡¨ç¤ºæˆ‘ä»¬çš„è¿™ä¸ªå•èŠ‚ç‚¹minikubeç¯å¢ƒå·²ç»æ­å»ºæˆåŠŸã€‚

### å°ç»“

æ‰€è°“çš„â€œäº‘â€ï¼Œç°åœ¨å°±æŒ‡çš„æ˜¯Kubernetesï¼Œé‚£ä¹ˆâ€œäº‘åŸç”Ÿâ€çš„æ„æ€å°±æ˜¯**åº”ç”¨çš„å¼€å‘ã€éƒ¨ç½²ã€è¿ç»´ç­‰ä¸€ç³»åˆ—å·¥ä½œéƒ½è¦å‘Kubernetesçœ‹é½**ï¼Œä½¿ç”¨å®¹å™¨ã€å¾®æœåŠ¡ã€å£°æ˜å¼APIç­‰æŠ€æœ¯ï¼Œä¿è¯åº”ç”¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸéƒ½èƒ½å¤Ÿåœ¨Kubernetesç¯å¢ƒé‡Œé¡ºåˆ©å®æ–½ï¼Œä¸éœ€è¦é™„åŠ é¢å¤–çš„æ¡ä»¶ã€‚

æ¢å¥è¯è¯´ï¼Œâ€œäº‘åŸç”Ÿâ€å°±æ˜¯Kubernetesé‡Œçš„â€œåŸä½æ°‘â€ï¼Œè€Œä¸æ˜¯ä»å…¶ä»–ç¯å¢ƒè¿è¿‡æ¥çš„â€œç§»æ°‘â€ã€‚



1. å®¹å™¨æŠ€æœ¯åªè§£å†³äº†åº”ç”¨çš„æ‰“åŒ…ã€å®‰è£…é—®é¢˜ï¼Œé¢å¯¹å¤æ‚çš„ç”Ÿäº§ç¯å¢ƒå°±æŸæ‰‹æ— ç­–äº†ï¼Œè§£å†³ä¹‹é“å°±æ˜¯å®¹å™¨ç¼–æ’ï¼Œå®ƒèƒ½å¤Ÿç»„ç»‡ç®¡ç†å„ä¸ªåº”ç”¨å®¹å™¨ä¹‹é—´çš„å…³ç³»ï¼Œè®©å®ƒä»¬é¡ºåˆ©åœ°ååŒè¿è¡Œã€‚
2. Kubernetesæºè‡ªGoogleå†…éƒ¨çš„Borgç³»ç»Ÿï¼Œä¹Ÿæ˜¯å½“å‰å®¹å™¨ç¼–æ’é¢†åŸŸçš„äº‹å®æ ‡å‡†ã€‚minikubeå¯ä»¥åœ¨æœ¬æœºæ­å»ºKubernetesç¯å¢ƒï¼ŒåŠŸèƒ½å¾ˆå®Œå–„ï¼Œé€‚åˆå­¦ä¹ ç ”ç©¶ã€‚  
3. æ“ä½œKuberneteséœ€è¦ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·kubectlï¼Œåªæœ‰é€šè¿‡å®ƒæ‰èƒ½ä¸Kubernetesé›†ç¾¤äº¤äº’ã€‚
4. kubectlçš„ç”¨æ³•ä¸dockerç±»ä¼¼ï¼Œä¹Ÿå¯ä»¥æ‹‰å–é•œåƒè¿è¡Œï¼Œä½†æ“ä½œçš„ä¸æ˜¯ç®€å•çš„å®¹å™¨ï¼Œè€Œæ˜¯Podã€‚





## 10 è‡ªåŠ¨åŒ–çš„è¿ç»´ç®¡ç†ï¼šæ¢ç©¶Kuberneteså·¥ä½œæœºåˆ¶çš„å¥¥ç§˜

### 10.1 äº‘è®¡ç®—æ—¶ä»£çš„æ“ä½œç³»ç»Ÿ

Kubernetesæ˜¯**ä¸€ä¸ªç”Ÿäº§çº§åˆ«çš„å®¹å™¨ç¼–æ’å¹³å°å’Œé›†ç¾¤ç®¡ç†ç³»ç»Ÿ**ï¼Œèƒ½å¤Ÿåˆ›å»ºã€è°ƒåº¦å®¹å™¨ï¼Œç›‘æ§ã€ç®¡ç†æœåŠ¡å™¨ã€‚

å®¹å™¨æ˜¯è½¯ä»¶ï¼Œæ˜¯åº”ç”¨ï¼Œæ˜¯è¿›ç¨‹ã€‚æœåŠ¡å™¨æ˜¯ç¡¬ä»¶ï¼Œæ˜¯CPUã€å†…å­˜ã€ç¡¬ç›˜ã€ç½‘å¡ã€‚é‚£ä¹ˆï¼Œæ—¢å¯ä»¥ç®¡ç†è½¯ä»¶ï¼Œä¹Ÿå¯ä»¥ç®¡ç†ç¡¬ä»¶ï¼Œè¿™ä¸ªä¸œè¥¿å°±æ˜¯ä¸€ä¸ªæ“ä½œç³»ç»Ÿï¼ˆOperating Systemï¼‰ï¼

ä»æŸç§è§’åº¦æ¥çœ‹ï¼ŒKuberneteså¯ä»¥è¯´æ˜¯ä¸€ä¸ªé›†ç¾¤çº§åˆ«çš„æ“ä½œç³»ç»Ÿï¼Œä¸»è¦åŠŸèƒ½å°±æ˜¯**èµ„æºç®¡ç†å’Œä½œä¸šè°ƒåº¦**ã€‚ä½†Kubernetesä¸æ˜¯è¿è¡Œåœ¨å•æœºä¸Šç®¡ç†å•å°è®¡ç®—èµ„æºå’Œè¿›ç¨‹ï¼Œè€Œæ˜¯è¿è¡Œåœ¨å¤šå°æœåŠ¡å™¨ä¸Šç®¡ç†å‡ ç™¾å‡ åƒå°çš„è®¡ç®—èµ„æºï¼Œä»¥åŠåœ¨è¿™äº›èµ„æºä¸Šè¿è¡Œçš„ä¸Šä¸‡ä¸Šç™¾ä¸‡çš„è¿›ç¨‹ï¼Œè§„æ¨¡è¦å¤§å¾—å¤šã€‚

Linuxçš„ç”¨æˆ·é€šå¸¸æ˜¯ä¸¤ç±»äººï¼š**Dev**å’Œ**Ops**ï¼Œè€Œåœ¨Kubernetesé‡Œåˆ™åªæœ‰ä¸€ç±»äººï¼š**DevOps**ã€‚

### 10.2 Kubernetesçš„åŸºæœ¬æ¶æ„

æ“ä½œç³»ç»Ÿçš„ä¸€ä¸ªé‡è¦åŠŸèƒ½å°±æ˜¯**==æŠ½è±¡==**ï¼Œä»ç¹ççš„åº•å±‚äº‹åŠ¡ä¸­æŠ½è±¡å‡ºä¸€äº›ç®€æ´çš„æ¦‚å¿µï¼Œç„¶ååŸºäºè¿™äº›æ¦‚å¿µå»**ç®¡ç†ç³»ç»Ÿèµ„æº**ã€‚

Kubernetesä¹Ÿæ˜¯è¿™æ ·ï¼Œå®ƒçš„ç®¡ç†ç›®æ ‡æ˜¯==å¤§è§„æ¨¡çš„é›†ç¾¤å’Œåº”ç”¨==ï¼Œå¿…é¡»è¦èƒ½å¤ŸæŠŠç³»ç»ŸæŠ½è±¡åˆ°è¶³å¤Ÿé«˜çš„å±‚æ¬¡ï¼Œåˆ†è§£å‡ºä¸€äº›æ¾è€¦åˆçš„å¯¹è±¡ï¼Œæ‰èƒ½ç®€åŒ–ç³»ç»Ÿæ¨¡å‹ï¼Œå‡è½»ç”¨æˆ·çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚

æ‰€ä»¥ï¼ŒKubernetesæ‰®æ¼”çš„è§’è‰²å°±å¦‚åŒä¸€ä¸ª==â€œå¤§å¸ˆçº§åˆ«â€çš„ç³»ç»Ÿç®¡ç†å‘˜==ï¼Œå…·æœ‰ä¸°å¯Œçš„é›†ç¾¤è¿ç»´ç»éªŒï¼Œç‹¬åˆ›äº†è‡ªå·±çš„ä¸€å¥—å·¥ä½œæ–¹å¼ï¼Œä¸éœ€è¦å¤ªå¤šçš„å¤–éƒ¨å¹²é¢„ï¼Œå°±èƒ½å¤Ÿè‡ªä¸»å®ç°åŸå…ˆè®¸å¤šå¤æ‚çš„ç®¡ç†å·¥ä½œã€‚

![ä¸€å¼ è€å›¾](images/image-20240721231007199.png)

Kubernetesé‡‡ç”¨äº†ç°ä»Šæµè¡Œçš„â€œ**æ§åˆ¶é¢/æ•°æ®é¢**â€ï¼ˆControl Plane / Data Planeï¼‰æ¶æ„ï¼Œé›†ç¾¤é‡Œçš„è®¡ç®—æœºè¢«ç§°ä¸ºâ€œ**==èŠ‚ç‚¹==**â€ï¼ˆNodeï¼‰ï¼Œå¯ä»¥æ˜¯**å®æœº**ä¹Ÿå¯ä»¥æ˜¯**è™šæœº**ï¼Œå°‘é‡çš„èŠ‚ç‚¹ç”¨ä½œæ§åˆ¶é¢æ¥æ‰§è¡Œé›†ç¾¤çš„ç®¡ç†ç»´æŠ¤å·¥ä½œï¼Œå…¶ä»–çš„å¤§éƒ¨åˆ†èŠ‚ç‚¹éƒ½è¢«åˆ’å½’æ•°æ®é¢ï¼Œç”¨æ¥è·‘ä¸šåŠ¡åº”ç”¨ã€‚

æ§åˆ¶é¢çš„èŠ‚ç‚¹å«åš**==Master Node==**ï¼Œä¸€èˆ¬ç®€ç§°ä¸º**Master**ï¼Œå®ƒæ˜¯æ•´ä¸ªé›†ç¾¤é‡Œæœ€é‡è¦çš„éƒ¨åˆ†ï¼Œå¯ä»¥è¯´æ˜¯Kubernetesçš„å¤§è„‘å’Œå¿ƒè„ã€‚

æ•°æ®é¢çš„èŠ‚ç‚¹å«åš**==Worker Node==**ï¼Œä¸€èˆ¬å°±ç®€ç§°ä¸º**Worker**æˆ–è€…**Node**ï¼Œç›¸å½“äºKubernetesçš„æ‰‹å’Œè„šï¼Œåœ¨Masterçš„æŒ‡æŒ¥ä¸‹å¹²æ´»ã€‚

Nodeçš„æ•°é‡éå¸¸å¤šï¼Œæ„æˆäº†ä¸€ä¸ªèµ„æºæ± ï¼ŒKuberneteså°±åœ¨è¿™ä¸ªæ± é‡Œåˆ†é…èµ„æºï¼Œè°ƒåº¦åº”ç”¨ã€‚å› ä¸ºèµ„æºè¢«â€œ**æ± åŒ–**â€äº†ï¼Œæ‰€ä»¥ç®¡ç†ä¹Ÿå°±å˜å¾—æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥åœ¨é›†ç¾¤ä¸­ä»»æ„æ·»åŠ æˆ–è€…åˆ é™¤èŠ‚ç‚¹ã€‚

kubectl æ˜¯Kubernetesçš„å®¢æˆ·ç«¯å·¥å…·ï¼Œç”¨æ¥æ“ä½œKubernetesï¼Œä½†å®ƒä½äºé›†ç¾¤ä¹‹å¤–ï¼Œç†è®ºä¸Šä¸å±äºé›†ç¾¤ã€‚

æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ï¼š

```sh
$ kubectl get node
NAME       STATUS   ROLES           AGE    VERSION
minikube   Ready    control-plane   7d1h   v1.31.0
```



### 10.3 èŠ‚ç‚¹å†…éƒ¨çš„ç»“æ„

èŠ‚ç‚¹å†…éƒ¨ç”±å¾ˆå¤šçš„æ¨¡å—æ„æˆçš„ï¼Œè¿™äº›æ¨¡å—åˆå¯ä»¥åˆ†æˆ==ç»„ä»¶ï¼ˆComponentï¼‰==å’Œ==æ’ä»¶ï¼ˆAddonï¼‰==ä¸¤ç±»ã€‚

ç»„ä»¶å®ç°äº†Kubernetesçš„æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§ï¼Œæ²¡æœ‰è¿™äº›ç»„ä»¶Kuberneteså°±æ— æ³•å¯åŠ¨ï¼Œè€Œæ’ä»¶åˆ™æ˜¯Kubernetesçš„ä¸€äº›é™„åŠ åŠŸèƒ½ï¼Œå±äºâ€œé”¦ä¸Šæ·»èŠ±â€ï¼Œä¸å®‰è£…ä¹Ÿä¸ä¼šå½±å“Kubernetesçš„æ­£å¸¸è¿è¡Œã€‚

#### 10.3.1 Masteré‡Œçš„ç»„ä»¶æœ‰å“ªäº›

Masteré‡Œæœ‰4ä¸ªç»„ä»¶æ˜¯**==apiserver==**ã€**==etcd==**ã€**==scheduler==**ã€**==controller-manager==**ã€‚

![](images/330e03a66f636657c0d8695397c508c6.jpg)

- apiserveræ˜¯MasterèŠ‚ç‚¹â€”â€”åŒæ—¶ä¹Ÿæ˜¯æ•´ä¸ªKubernetesç³»ç»Ÿçš„**å”¯ä¸€å…¥å£**ï¼Œå®ƒå¯¹å¤–å…¬å¼€äº†ä¸€ç³»åˆ—çš„RESTful APIï¼Œå¹¶ä¸”åŠ ä¸Šäº†éªŒè¯ã€æˆæƒç­‰åŠŸèƒ½ï¼Œæ‰€æœ‰å…¶ä»–ç»„ä»¶éƒ½åªèƒ½å’Œå®ƒç›´æ¥é€šä¿¡ï¼Œå¯ä»¥è¯´æ˜¯Kubernetesé‡Œçš„è”ç»œå‘˜ã€‚

- etcdæ˜¯ä¸€ä¸ª**é«˜å¯ç”¨çš„åˆ†å¸ƒå¼Key-Valueæ•°æ®åº“**ï¼Œç”¨æ¥æŒä¹…åŒ–å­˜å‚¨ç³»ç»Ÿé‡Œçš„å„ç§**èµ„æºå¯¹è±¡å’ŒçŠ¶æ€**ï¼Œç›¸å½“äºKubernetesé‡Œçš„**é…ç½®ç®¡ç†å‘˜**ã€‚æ³¨æ„å®ƒ**åªä¸apiserveræœ‰ç›´æ¥è”ç³»**ï¼Œä¹Ÿå°±æ˜¯è¯´ä»»ä½•å…¶ä»–ç»„ä»¶æƒ³è¦è¯»å†™etcdé‡Œçš„æ•°æ®éƒ½å¿…é¡»ç»è¿‡apiserverã€‚

- schedulerè´Ÿè´£å®¹å™¨çš„**ç¼–æ’**å·¥ä½œï¼Œæ£€æŸ¥èŠ‚ç‚¹çš„èµ„æºçŠ¶æ€ï¼ŒæŠŠPodè°ƒåº¦åˆ°æœ€é€‚åˆçš„èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œç›¸å½“äºéƒ¨ç½²äººå‘˜ã€‚å› ä¸ºèŠ‚ç‚¹çŠ¶æ€å’ŒPodä¿¡æ¯éƒ½å­˜å‚¨åœ¨etcdé‡Œï¼Œæ‰€ä»¥schedulerå¿…é¡»é€šè¿‡apiserveræ‰èƒ½è·å¾—ã€‚

- controller-managerè´Ÿè´£ç»´æŠ¤å®¹å™¨å’ŒèŠ‚ç‚¹ç­‰èµ„æºçš„çŠ¶æ€ï¼Œå®ç°**æ•…éšœæ£€æµ‹ã€æœåŠ¡è¿ç§»ã€åº”ç”¨ä¼¸ç¼©**ç­‰åŠŸèƒ½ï¼Œç›¸å½“äºç›‘æ§è¿ç»´äººå‘˜ã€‚åŒæ ·åœ°ï¼Œå®ƒä¹Ÿå¿…é¡»é€šè¿‡apiserverè·å¾—å­˜å‚¨åœ¨etcdé‡Œçš„ä¿¡æ¯ï¼Œæ‰èƒ½å¤Ÿå®ç°å¯¹èµ„æºçš„å„ç§æ“ä½œã€‚

è¿™4ä¸ªç»„ä»¶ä¹Ÿéƒ½è¢«å®¹å™¨åŒ–äº†ï¼Œè¿è¡Œåœ¨é›†ç¾¤çš„Podé‡Œï¼Œå¯ä»¥ç”¨kubectlæ¥æŸ¥çœ‹å®ƒä»¬çš„çŠ¶æ€ï¼š

```sh
kubectl get pod -n kube-system
```

![](images/image-20250212113337954.png)

 `-n kube-system` å‚æ•°ï¼Œè¡¨ç¤ºæ£€æŸ¥â€œkube-systemâ€åå­—ç©ºé—´é‡Œçš„Podã€‚

#### 10.3.2 Nodeé‡Œçš„ç»„ä»¶æœ‰å“ªäº›

Masteré‡Œçš„apiserverã€schedulerç­‰ç»„ä»¶éœ€è¦è·å–èŠ‚ç‚¹çš„å„ç§ä¿¡æ¯æ‰èƒ½å¤Ÿä½œå‡ºç®¡ç†å†³ç­–ï¼Œé‚£è¿™äº›ä¿¡æ¯è¯¥æ€ä¹ˆæ¥å‘¢ï¼Ÿ

è¿™å°±éœ€è¦Nodeé‡Œçš„3ä¸ªç»„ä»¶äº†ï¼Œåˆ†åˆ«æ˜¯**kubelet**ã€**kube-proxy**ã€**container-runtime**ã€‚

- ==kubelet==æ˜¯Nodeçš„ä»£ç†ï¼Œè´Ÿè´£ç®¡ç†Nodeç›¸å…³çš„ç»å¤§éƒ¨åˆ†æ“ä½œï¼ŒNodeä¸Šåªæœ‰å®ƒèƒ½å¤Ÿä¸apiserveré€šä¿¡ï¼Œå®ç°çŠ¶æ€æŠ¥å‘Šã€å‘½ä»¤ä¸‹å‘ã€å¯åœå®¹å™¨ç­‰åŠŸèƒ½ï¼Œç›¸å½“äºæ˜¯Nodeä¸Šçš„ä¸€ä¸ªâ€œå°ç®¡å®¶â€ã€‚

- ==kube-proxy==çš„ä½œç”¨æœ‰ç‚¹ç‰¹åˆ«ï¼Œå®ƒæ˜¯Nodeçš„ç½‘ç»œä»£ç†ï¼Œåªè´Ÿè´£ç®¡ç†å®¹å™¨çš„ç½‘ç»œé€šä¿¡ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¸ºPodè½¬å‘TCP/UDPæ•°æ®åŒ…ï¼Œç›¸å½“äºæ˜¯ä¸“èŒçš„â€œå°é‚®å·®â€ã€‚

- ==container-runtime==æ˜¯å®¹å™¨å’Œé•œåƒçš„å®é™…ä½¿ç”¨è€…ï¼Œåœ¨kubeletçš„æŒ‡æŒ¥ä¸‹åˆ›å»ºå®¹å™¨ï¼Œç®¡ç†Podçš„ç”Ÿå‘½å‘¨æœŸï¼Œæ˜¯çœŸæ­£å¹²æ´»çš„â€œè‹¦åŠ›â€ã€‚

![](images/87bab507ce8381325e85570f3bc1d935.jpg)

Kubernetesçš„å®šä½æ˜¯å®¹å™¨ç¼–æ’å¹³å°ï¼Œæ‰€ä»¥å®ƒæ²¡æœ‰é™å®šcontainer-runtimeå¿…é¡»æ˜¯Dockerï¼Œå®Œå…¨å¯ä»¥æ›¿æ¢æˆä»»ä½•ç¬¦åˆæ ‡å‡†çš„å…¶ä»–å®¹å™¨è¿è¡Œæ—¶ï¼Œä¾‹å¦‚containerdã€CRI-Oç­‰ç­‰ã€‚

è¿™3ä¸ªç»„ä»¶ä¸­åªæœ‰kube-proxy**è¢«å®¹å™¨åŒ–**äº†ğŸ”–ï¼Œè€Œkubeletå› ä¸ºå¿…é¡»è¦ç®¡ç†æ•´ä¸ªèŠ‚ç‚¹ï¼Œå®¹å™¨åŒ–ä¼šé™åˆ¶å®ƒçš„èƒ½åŠ›ï¼Œæ‰€ä»¥å®ƒå¿…é¡»åœ¨container-runtimeä¹‹å¤–è¿è¡Œã€‚

ä½¿ç”¨ `minikube ssh` å‘½ä»¤ç™»å½•åˆ°èŠ‚ç‚¹åï¼Œå¯ä»¥ç”¨ `docker ps` çœ‹åˆ°kube-proxyï¼š

```sh
$ minikube ssh
docker@minikube:~$ docker ps  | grep kube-proxy
8099ff1d77e5   71d55d66fd4e                                                     "/usr/local/bin/kubeâ€¦"   7 days ago   Up 7 days             k8s_kube-proxy_kube-proxy-65tbs_kube-system_c8ecd249-8501-4296-8a56-016920cfdb1c_0
4e659bec4330   registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.10   "/pause"                 7 days ago   Up 7 days             k8s_POD_kube-proxy-65tbs_kube-system_c8ecd249-8501-4296-8a56-016920cfdb1c_0
```

è€Œkubeletç”¨ `docker ps` æ˜¯æ‰¾ä¸åˆ°çš„ã€‚



å†æŠŠNodeé‡Œçš„ç»„ä»¶å’ŒMasteré‡Œçš„ç»„ä»¶æ”¾åœ¨ä¸€èµ·æ¥çœ‹ï¼Œå°±èƒ½å¤Ÿæ˜ç™½Kubernetesçš„å¤§è‡´å·¥ä½œæµç¨‹äº†ï¼š

- æ¯ä¸ªNodeä¸Šçš„kubeletä¼šå®šæœŸå‘apiserverä¸ŠæŠ¥èŠ‚ç‚¹çŠ¶æ€ï¼Œapiserverå†å­˜åˆ°etcdé‡Œã€‚
- æ¯ä¸ªNodeä¸Šçš„kube-proxyå®ç°äº†TCP/UDPåå‘ä»£ç†ï¼Œè®©å®¹å™¨å¯¹å¤–æä¾›ç¨³å®šçš„æœåŠ¡ã€‚
- scheduleré€šè¿‡apiserverå¾—åˆ°å½“å‰çš„èŠ‚ç‚¹çŠ¶æ€ï¼Œè°ƒåº¦Podï¼Œç„¶åapiserverä¸‹å‘å‘½ä»¤ç»™æŸä¸ªNodeçš„kubeletï¼Œkubeletè°ƒç”¨container-runtimeå¯åŠ¨å®¹å™¨ã€‚
- controller-managerä¹Ÿé€šè¿‡apiserverå¾—åˆ°å®æ—¶çš„èŠ‚ç‚¹çŠ¶æ€ï¼Œç›‘æ§å¯èƒ½çš„å¼‚å¸¸æƒ…å†µï¼Œå†ä½¿ç”¨ç›¸åº”çš„æ‰‹æ®µå»è°ƒèŠ‚æ¢å¤ã€‚



![](images/344e0c6dc2141b12f99e61252110f6b7.png)

å…¶å®ï¼Œè¿™å’Œæˆ‘ä»¬åœ¨Kuberneteså‡ºç°ä¹‹å‰çš„æ“ä½œæµç¨‹ä¹Ÿå·®ä¸äº†å¤šå°‘ï¼Œä½†Kubernetesçš„é«˜æ˜ä¹‹å¤„å°±åœ¨äºæŠŠè¿™äº›éƒ½==æŠ½è±¡åŒ–è§„èŒƒåŒ–==äº†ã€‚

äºæ˜¯ï¼Œè¿™äº›ç»„ä»¶å°±å¥½åƒæ˜¯æ— æ•°ä¸ªä¸çŸ¥ç–²å€¦çš„è¿ç»´å·¥ç¨‹å¸ˆï¼ŒæŠŠåŸå…ˆç¹çä½æ•ˆçš„äººåŠ›å·¥ä½œæ¬è¿›äº†é«˜æ•ˆçš„è®¡ç®—æœºé‡Œï¼Œå°±èƒ½å¤Ÿéšæ—¶å‘ç°é›†ç¾¤é‡Œçš„å˜åŒ–å’Œå¼‚å¸¸ï¼Œå†äº’ç›¸åä½œï¼Œç»´æŠ¤é›†ç¾¤çš„å¥åº·çŠ¶æ€ã€‚

#### 10.3.3 æ’ä»¶ï¼ˆAddonsï¼‰æœ‰å“ªäº›

åªè¦æœåŠ¡å™¨èŠ‚ç‚¹ä¸Šè¿è¡Œäº†apiserverã€schedulerã€kubeletã€kube-proxyã€container-runtimeç­‰ç»„ä»¶ï¼Œå°±å¯ä»¥è¯´æ˜¯ä¸€ä¸ªåŠŸèƒ½é½å…¨çš„Kubernetesé›†ç¾¤äº†ã€‚

ä¸è¿‡å°±åƒLinuxä¸€æ ·ï¼Œæ“ä½œç³»ç»Ÿæä¾›çš„åŸºç¡€åŠŸèƒ½è™½ç„¶â€œå¯ç”¨â€ï¼Œä½†æƒ³è¾¾åˆ°â€œå¥½ç”¨â€çš„ç¨‹åº¦ï¼Œè¿˜æ˜¯è¦å†å®‰è£…ä¸€äº›é™„åŠ åŠŸèƒ½ï¼Œè¿™åœ¨Kubernetesé‡Œå°±æ˜¯æ’ä»¶ï¼ˆAddonï¼‰ã€‚

ç”±äºKubernetesæœ¬èº«çš„è®¾è®¡éå¸¸çµæ´»ï¼Œæ‰€ä»¥å°±æœ‰å¤§é‡çš„æ’ä»¶ç”¨æ¥æ‰©å±•ã€å¢å¼ºå®ƒå¯¹åº”ç”¨å’Œé›†ç¾¤çš„ç®¡ç†èƒ½åŠ›ã€‚

minikubeä¹Ÿæ”¯æŒå¾ˆå¤šçš„æ’ä»¶ï¼ŒæŸ¥çœ‹æ’ä»¶åˆ—è¡¨ï¼š

```sh
minikube addons list
```



### å°ç»“

![](images/65d38ac50b4f2f1fd4b6700d5b8e7be1.jpg)

1. Kubernetesèƒ½å¤Ÿåœ¨é›†ç¾¤çº§åˆ«ç®¡ç†åº”ç”¨å’ŒæœåŠ¡å™¨ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç§é›†ç¾¤æ“ä½œç³»ç»Ÿã€‚å®ƒä½¿ç”¨â€œæ§åˆ¶é¢/æ•°æ®é¢â€çš„åŸºæœ¬æ¶æ„ï¼ŒMasterèŠ‚ç‚¹å®ç°ç®¡ç†æ§åˆ¶åŠŸèƒ½ï¼ŒWorkerèŠ‚ç‚¹è¿è¡Œå…·ä½“ä¸šåŠ¡ã€‚
2. Kubernetesç”±å¾ˆå¤šæ¨¡å—ç»„æˆï¼Œå¯åˆ†ä¸ºæ ¸å¿ƒçš„ç»„ä»¶å’Œé€‰é…çš„æ’ä»¶ä¸¤ç±»ã€‚
3. Masteré‡Œæœ‰4ä¸ªç»„ä»¶ï¼Œåˆ†åˆ«æ˜¯apiserverã€etcdã€schedulerã€controller-managerã€‚
4. Nodeé‡Œæœ‰3ä¸ªç»„ä»¶ï¼Œåˆ†åˆ«æ˜¯kubeletã€kube-proxyã€container-runtimeã€‚
5. é€šå¸¸å¿…å¤‡çš„æ’ä»¶æœ‰DNSå’ŒDashboardã€‚





## 11 YAMLï¼šKubernetesä¸–ç•Œé‡Œçš„é€šç”¨è¯­

### 11.1 å£°æ˜å¼ä¸å‘½ä»¤å¼æ˜¯æ€ä¹ˆå›äº‹

â€œå£°æ˜å¼â€ï¼ˆDeclarativeï¼‰ï¼Œ â€œå‘½ä»¤å¼â€ï¼ˆImperativeï¼‰

Dockerå‘½ä»¤å’ŒDockerfileå°±å±äºâ€œå‘½ä»¤å¼â€ï¼Œå¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€ä¹Ÿå±äºå‘½ä»¤å¼ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯**äº¤äº’æ€§å¼ºï¼Œæ³¨é‡é¡ºåºå’Œè¿‡ç¨‹**ï¼Œä½ å¿…é¡»â€œå‘Šè¯‰â€è®¡ç®—æœºæ¯æ­¥è¯¥åšä»€ä¹ˆï¼Œæ‰€æœ‰çš„æ­¥éª¤éƒ½åˆ—æ¸…æ¥šï¼Œè¿™æ ·ç¨‹åºæ‰èƒ½å¤Ÿä¸€æ­¥æ­¥èµ°ä¸‹å»ï¼Œæœ€åå®Œæˆä»»åŠ¡ï¼Œæ˜¾å¾—è®¡ç®—æœºæœ‰ç‚¹â€œç¬¨â€ã€‚

â€œå£°æ˜å¼â€ï¼Œåœ¨Kuberneteså‡ºç°ä¹‹å‰æ¯”è¾ƒå°‘è§ï¼Œå®ƒä¸â€œå‘½ä»¤å¼â€å®Œå…¨ç›¸åï¼Œ**ä¸å…³å¿ƒå…·ä½“çš„è¿‡ç¨‹ï¼Œæ›´æ³¨é‡ç»“æœ**ã€‚æˆ‘ä»¬ä¸éœ€è¦â€œæ•™â€è®¡ç®—æœºè¯¥æ€ä¹ˆåšï¼Œåªè¦å‘Šè¯‰å®ƒä¸€ä¸ªç›®æ ‡çŠ¶æ€ï¼Œå®ƒè‡ªå·±å°±ä¼šæƒ³åŠæ³•å»å®Œæˆä»»åŠ¡ï¼Œç›¸æ¯”èµ·æ¥è‡ªåŠ¨åŒ–ã€æ™ºèƒ½åŒ–ç¨‹åº¦æ›´é«˜ã€‚

> ğŸŒ° æ‰“è½¦
>
> å‡è®¾ä½ è¦æ‰“è½¦å»é«˜é“ç«™ï¼Œä½†å¸æœºä¸ç†Ÿæ‚‰è·¯å†µï¼Œä½ å°±åªå¥½ä¸åŒå…¶çƒ¦åœ°å‘Šè¯‰ä»–è¯¥èµ°å“ªæ¡è·¯ã€åœ¨å“ªä¸ªè·¯å£è½¬å‘ã€åœ¨å“ªé‡Œè¿›å‡ºä¸»è·¯ã€åœå“ªä¸ªç«™å£ã€‚è™½ç„¶æœ€ååˆ°è¾¾äº†ç›®çš„åœ°ï¼Œä½†è¿™ä¸€è·¯ä¸Šä¹Ÿè´¹äº†å¾ˆå¤šå£èˆŒï¼Œå‘å‡ºäº†æ— æ•°çš„â€œå‘½ä»¤â€ã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™æ®µè·¯ç¨‹å°±å±äºâ€œå‘½ä»¤å¼â€ã€‚
>
> ç°åœ¨æˆ‘ä»¬æ¥æ¢ä¸€ç§æ–¹å¼ï¼ŒåŒæ ·æ˜¯å»é«˜é“ç«™ï¼Œä½†å¸æœºç»éªŒä¸°å¯Œï¼Œä»–çŸ¥é“å“ªé‡Œæœ‰æ‹¥å µã€å“ªæ¡è·¯çš„çº¢ç»¿ç¯å¤šã€å“ªæ®µè·¯æœ‰ä¸´æ—¶ç®¡æ§ã€å“ªé‡Œå¯ä»¥æŠ„å°é“ï¼Œæ­¤æ—¶ä½ å†å¤šå˜´æ— ç–‘ä¼šå¹²æ‰°ä»–çš„æ­£å¸¸é©¾é©¶ï¼Œæ‰€ä»¥ï¼Œä½ åªè¦ç»™ä»–ä¸€ä¸ªâ€œå£°æ˜â€ï¼šæˆ‘è¦å»é«˜é“ç«™ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥èˆ’èˆ’æœæœåœ°èººåœ¨ååº§ä¸Šä¼‘æ¯ï¼Œé¡ºåˆ©åˆ°è¾¾ç›®çš„åœ°äº†ã€‚

åœ¨è¿™ä¸ªâ€œæ‰“è½¦â€çš„ä¾‹å­é‡Œï¼ŒKuberneteså°±æ˜¯è¿™æ ·çš„ä¸€ä½ç†Ÿç»ƒçš„å¸æœºï¼ŒMaster/Nodeæ¶æ„è®©å®ƒå¯¹æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€äº†å¦‚æŒ‡æŒï¼Œå†…éƒ¨çš„ä¼—å¤šç»„ä»¶å’Œæ’ä»¶ä¹Ÿèƒ½å¤Ÿè‡ªåŠ¨ç›‘æ§ç®¡ç†åº”ç”¨ã€‚

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†ç”¨â€œå‘½ä»¤å¼â€è·Ÿå®ƒæ‰“äº¤é“å°±ä¸å¤ªåˆé€‚äº†ï¼Œå› ä¸ºå®ƒçŸ¥é“çš„ä¿¡æ¯æ¯”æˆ‘ä»¬æ›´å¤šæ›´å…¨é¢ï¼Œä¸éœ€è¦æˆ‘ä»¬è¿™ä¸ªå¤–è¡Œå»æŒ‡å¯¼å®ƒè¿™ä¸ªå†…è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€å¥½æ˜¯åšä¸€ä¸ªâ€œ**ç”©æ‰‹æŒæŸœ**â€ï¼Œç”¨â€œå£°æ˜å¼â€æŠŠä»»åŠ¡çš„ç›®æ ‡å‘Šè¯‰å®ƒï¼Œæ¯”å¦‚ä½¿ç”¨å“ªä¸ªé•œåƒã€ä»€ä¹ˆæ—¶å€™è¿è¡Œï¼Œè®©å®ƒè‡ªå·±å»å¤„ç†æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ç»†èŠ‚ã€‚

> è¯¥ç”¨ä»€ä¹ˆæ–¹å¼å»ç»™Kuberneteså‘å‡ºä¸€ä¸ªâ€œå£°æ˜â€å‘¢ï¼Ÿ
>
> å®¹å™¨æŠ€æœ¯é‡Œçš„Shellè„šæœ¬å’ŒDockerfileå¯ä»¥å¾ˆå¥½åœ°æè¿°â€œå‘½ä»¤å¼â€ï¼Œä½†å¯¹äºâ€œå£°æ˜å¼â€å°±ä¸å¤ªåˆé€‚äº†ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸“é—¨çš„YAMLè¯­è¨€ã€‚



### 11.2 ä»€ä¹ˆæ˜¯YAML

https://yaml.org/

**YAMLæ˜¯JSONçš„è¶…é›†**ï¼Œæ”¯æŒæ•´æ•°ã€æµ®ç‚¹æ•°ã€å¸ƒå°”ã€å­—ç¬¦ä¸²ã€æ•°ç»„å’Œå¯¹è±¡ç­‰æ•°æ®ç±»å‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»»ä½•åˆæ³•çš„JSONæ–‡æ¡£ä¹Ÿéƒ½æ˜¯YAMLæ–‡æ¡£ã€‚

![](images/image-20250212170635330.png)

### 11.3 ä»€ä¹ˆæ˜¯APIå¯¹è±¡

ä½œä¸ºä¸€ä¸ªé›†ç¾¤æ“ä½œç³»ç»Ÿï¼ŒKuberneteså½’çº³æ€»ç»“äº†Googleå¤šå¹´çš„ç»éªŒï¼Œåœ¨ç†è®ºå±‚é¢æŠ½è±¡å‡ºäº†å¾ˆå¤šä¸ªæ¦‚å¿µï¼Œç”¨æ¥æè¿°ç³»ç»Ÿçš„ç®¡ç†è¿ç»´å·¥ä½œï¼Œè¿™äº›æ¦‚å¿µå°±å«åšâ€œ**==APIå¯¹è±¡==**â€ã€‚å¯¹åº”**apiserver**ç»„ä»¶ã€‚

å› ä¸ºapiserveræ˜¯Kubernetesç³»ç»Ÿçš„å”¯ä¸€å…¥å£ï¼Œå¤–éƒ¨ç”¨æˆ·å’Œå†…éƒ¨ç»„ä»¶éƒ½å¿…é¡»å’Œå®ƒé€šä¿¡ï¼Œè€Œå®ƒé‡‡ç”¨äº†HTTPåè®®çš„URLèµ„æºç†å¿µï¼ŒAPIé£æ ¼ä¹Ÿç”¨RESTfulçš„GET/POST/DELETEç­‰ç­‰ï¼Œæ‰€ä»¥ï¼Œè¿™äº›æ¦‚å¿µå¾ˆè‡ªç„¶åœ°å°±è¢«ç§°ä¸ºæ˜¯â€œAPIå¯¹è±¡â€äº†ã€‚

æŸ¥çœ‹å½“å‰k8sç‰ˆæœ¬æ”¯æŒçš„æ‰€æœ‰å¯¹è±¡ï¼š

```sh
$ kubectl api-resources
NAME                                SHORTNAMES   APIVERSION                        NAMESPACED   KIND
bindings                                         v1                                true         Binding
componentstatuses                   cs           v1                                false        ComponentStatus
configmaps                          cm           v1                                true         ConfigMap
endpoints                           ep           v1                                true         Endpoints
events                              ev           v1                                true         Event
limitranges                         limits       v1                                true         LimitRange
namespaces                          ns           v1                                false        Namespace
nodes                               no           v1                                false        Node
persistentvolumeclaims              pvc          v1                                true         PersistentVolumeClaim
....

```

SHORTNAMESæ˜¯ç®€å†™ã€‚

kubectlå‘½ä»¤åŠ ä¸Šä¸€ä¸ªå‚æ•° `--v=9`ï¼Œå®ƒä¼šæ˜¾ç¤ºå‡ºè¯¦ç»†çš„å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹ï¼Œæ¸…æ¥šåœ°çœ‹åˆ°å‘å‡ºçš„HTTPè¯·æ±‚ï¼Œæ¯”å¦‚ï¼š

```sh
$ kubectl get pod --v=9
I0209 10:26:15.130170 2727143 loader.go:395] Config loaded from file:  /home/andyron/.kube/config
I0209 10:26:15.130779 2727143 cert_rotation.go:140] Starting client certificate rotation controller
I0209 10:26:15.133063 2727143 round_trippers.go:466] curl -v -XGET  -H "Accept: application/json;as=Table;v=v1;g=meta.k8s.io,application/json;as=Table;v=v1beta1;g=meta.k8s.io,application/json" -H "User-Agent: kubectl/v1.31.0 (linux/arm64) kubernetes/9edcffc" 'https://192.168.49.2:8443/api/v1/namespaces/default/pods?limit=500'
I0209 10:26:15.133696 2727143 round_trippers.go:510] HTTP Trace: Dial to tcp:192.168.49.2:8443 succeed
I0209 10:26:15.138413 2727143 round_trippers.go:553] GET https://192.168.49.2:8443/api/v1/namespaces/default/pods?limit=500 200 OK in 5 milliseconds
I0209 10:26:15.138472 2727143 round_trippers.go:570] HTTP Statistics: DNSLookup 0 ms Dial 0 ms TLSHandshake 2 ms ServerProcessing 0 ms Duration 5 ms
I0209 10:26:15.138553 2727143 round_trippers.go:577] Response Headers:
I0209 10:26:15.138608 2727143 round_trippers.go:580]     Content-Type: application/json
I0209 10:26:15.138666 2727143 round_trippers.go:580]     X-Kubernetes-Pf-Flowschema-Uid: bf098cf1-a120-4007-a528-c5cf24b2286d
I0209 10:26:15.138720 2727143 round_trippers.go:580]     X-Kubernetes-Pf-Prioritylevel-Uid: b4814726-cc88-4697-aefa-0d11c942e469
I0209 10:26:15.138777 2727143 round_trippers.go:580]     Date: Sun, 09 Feb 2025 02:26:15 GMT
I0209 10:26:15.138841 2727143 round_trippers.go:580]     Audit-Id: 66596758-d05a-43d2-a636-dda712aa4c6e
I0209 10:26:15.138893 2727143 round_trippers.go:580]     Cache-Control: no-cache, private
....
```



ç›®å‰çš„Kubernetes 1.23ç‰ˆæœ¬æœ‰50å¤šç§APIå¯¹è±¡ï¼Œå…¨é¢åœ°æè¿°äº†é›†ç¾¤çš„èŠ‚ç‚¹ã€åº”ç”¨ã€é…ç½®ã€æœåŠ¡ã€è´¦å·ç­‰ç­‰ä¿¡æ¯ï¼Œapiserverä¼šæŠŠå®ƒä»¬éƒ½å­˜å‚¨åœ¨æ•°æ®åº“etcdé‡Œï¼Œç„¶åkubeletã€schedulerã€controller-managerç­‰ç»„ä»¶é€šè¿‡apiserveræ¥æ“ä½œå®ƒä»¬ï¼Œå°±åœ¨APIå¯¹è±¡è¿™ä¸ªæŠ½è±¡å±‚æ¬¡å®ç°äº†å¯¹æ•´ä¸ªé›†ç¾¤çš„ç®¡ç†ã€‚

### 11.4 å¦‚ä½•æè¿°APIå¯¹è±¡

```sh
kubectl run ngx --image=nginx:alpine
```



```yaml
apiVersion: v1
kind: Pod
metadata:
  name: ngx-pod
  labels:
    env: demo
    owner: chrono

spec:
  containers:
  - image: nginx:alpine
    name: ngx
    ports:
    - containerPort: 80
```



### 11.5 å¦‚ä½•ç¼–å†™YAML

æ€ä¹ˆçŸ¥é“è¯¥ç”¨ä»€ä¹ˆapiVersionã€ä»€ä¹ˆkindï¼Ÿmetadataã€specé‡Œåˆè¯¥å†™å“ªäº›å­—æ®µå‘¢ï¼Ÿ

https://kubernetes.io/docs/reference/kubernetes-api/



```sh
kubectl explain pod
kubectl explain pod.metadata
kubectl explain pod.spec
kubectl explain pod.spec.containers
```



### å°ç»“

å£°æ˜å¼çš„è¯­è¨€èƒ½å¤Ÿæ›´å‡†ç¡®æ›´æ¸…æ™°åœ°æè¿°ç³»ç»ŸçŠ¶æ€ï¼Œé¿å…å¼•å…¥ç¹ççš„æ“ä½œæ­¥éª¤æ‰°ä¹±ç³»ç»Ÿï¼Œä¸Kubernetesé«˜åº¦è‡ªåŠ¨åŒ–çš„å†…éƒ¨ç»“æ„ç›¸å¾—ç›Šå½°ï¼Œè€Œä¸”çº¯æ–‡æœ¬å½¢å¼çš„YAMLä¹Ÿå¾ˆå®¹æ˜“ç‰ˆæœ¬åŒ–ï¼Œé€‚åˆCI/CDã€‚

å†…å®¹è¦ç‚¹ï¼š

1. YAMLæ˜¯JSONçš„è¶…é›†ï¼Œæ”¯æŒæ•°ç»„å’Œå¯¹è±¡ï¼Œèƒ½å¤Ÿæè¿°å¤æ‚çš„çŠ¶æ€ï¼Œå¯è¯»æ€§ä¹Ÿå¾ˆå¥½ã€‚
2. KubernetesæŠŠé›†ç¾¤é‡Œçš„ä¸€åˆ‡èµ„æºéƒ½å®šä¹‰ä¸ºAPIå¯¹è±¡ï¼Œé€šè¿‡RESTfulæ¥å£æ¥ç®¡ç†ã€‚æè¿°APIå¯¹è±¡éœ€è¦ä½¿ç”¨YAMLè¯­è¨€ï¼Œå¿…é¡»çš„å­—æ®µæ˜¯**apiVersionã€kindã€metadata**ã€‚
3. å‘½ä»¤ `kubectl api-resources` å¯ä»¥æŸ¥çœ‹å¯¹è±¡çš„apiVersionå’Œkindï¼Œå‘½ä»¤ `kubectl explain` å¯ä»¥æŸ¥çœ‹å¯¹è±¡å­—æ®µçš„è¯´æ˜æ–‡æ¡£ã€‚
4. å‘½ä»¤ `kubectl apply`ã€`kubectl delete` å‘é€HTTPè¯·æ±‚ï¼Œç®¡ç†APIå¯¹è±¡ã€‚
5. ä½¿ç”¨å‚æ•° `--dry-run=client -o yaml` å¯ä»¥ç”Ÿæˆå¯¹è±¡çš„YAMLæ¨¡æ¿ï¼Œç®€åŒ–ç¼–å†™å·¥ä½œã€‚





## 12 Podï¼šå¦‚ä½•ç†è§£è¿™ä¸ªKubernetesé‡Œæœ€æ ¸å¿ƒçš„æ¦‚å¿µï¼Ÿ

### 12.1 ä¸ºä»€ä¹ˆè¦æœ‰Pod

Pod â€œè±Œè±†èšâ€ â€œèˆ±å®¤â€â€œå¤ªç©ºèˆ±â€ç­‰



### 12.2 ä¸ºä»€ä¹ˆPodæ˜¯Kubernetesçš„æ ¸å¿ƒå¯¹è±¡

![](images/9ebab7d513a211a926dd69f7535ac175.png)

é‡æ–°ç”»ä¸€ä»½ä»¥Podä¸ºä¸­å¿ƒçš„Kubernetesèµ„æºå¯¹è±¡å…³ç³»å›¾ï¼š![](images/image-20240721234815253.png)



### 12.3 å¦‚ä½•ä½¿ç”¨YAMLæè¿°Pod





### 12.4 å¦‚ä½•ä½¿ç”¨kubectlæ“ä½œPod





### å°ç»“

Podå±è”½äº†å®¹å™¨çš„ä¸€äº›åº•å±‚ç»†èŠ‚ï¼ŒåŒæ—¶åˆå…·æœ‰è¶³å¤Ÿçš„æ§åˆ¶ç®¡ç†èƒ½åŠ›ï¼Œæ¯”èµ·å®¹å™¨çš„â€œç»†ç²’åº¦â€ã€è™šæ‹Ÿæœºçš„â€œç²—ç²’åº¦â€ï¼ŒPodå¯ä»¥è¯´æ˜¯â€œä¸­ç²’åº¦â€ï¼Œçµæ´»åˆè½»ä¾¿ï¼Œéå¸¸é€‚åˆåœ¨äº‘è®¡ç®—é¢†åŸŸä½œä¸ºåº”ç”¨è°ƒåº¦çš„åŸºæœ¬å•å…ƒï¼Œå› è€Œæˆä¸ºäº†Kubernetesä¸–ç•Œé‡Œæ„å»ºä¸€åˆ‡ä¸šåŠ¡çš„â€œåŸå­â€ã€‚

çŸ¥è¯†è¦ç‚¹ï¼š

1. ç°å®ä¸­ç»å¸¸ä¼šæœ‰å¤šä¸ªè¿›ç¨‹å¯†åˆ‡åä½œæ‰èƒ½å®Œæˆä»»åŠ¡çš„åº”ç”¨ï¼Œè€Œä»…ä½¿ç”¨å®¹å™¨å¾ˆéš¾æè¿°è¿™ç§å…³ç³»ï¼Œæ‰€ä»¥å°±å‡ºç°äº†Podï¼Œå®ƒâ€œæ‰“åŒ…â€ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ï¼Œä¿è¯é‡Œé¢çš„è¿›ç¨‹èƒ½å¤Ÿè¢«æ•´ä½“è°ƒåº¦ã€‚
2. Podæ˜¯Kubernetesç®¡ç†åº”ç”¨çš„æœ€å°å•ä½ï¼Œå…¶ä»–çš„æ‰€æœ‰æ¦‚å¿µéƒ½æ˜¯ä»Podè¡ç”Ÿå‡ºæ¥çš„ã€‚
3. Podä¹Ÿåº”è¯¥ä½¿ç”¨YAMLâ€œå£°æ˜å¼â€æè¿°ï¼Œå…³é”®å­—æ®µæ˜¯â€œspec.containersâ€ï¼Œåˆ—å‡ºåå­—ã€é•œåƒã€ç«¯å£ç­‰è¦ç´ ï¼Œå®šä¹‰å†…éƒ¨çš„å®¹å™¨è¿è¡ŒçŠ¶æ€ã€‚
4. æ“ä½œPodçš„å‘½ä»¤å¾ˆå¤šä¸Dockerç±»ä¼¼ï¼Œå¦‚ `kubectl run`ã€`kubectl cp`ã€`kubectl exec` ç­‰ï¼Œä½†æœ‰çš„å‘½ä»¤æœ‰äº›å°å·®å¼‚ï¼Œä½¿ç”¨çš„æ—¶å€™éœ€è¦æ³¨æ„ã€‚



åœ¨Kubernetesé‡Œé€šå¸¸å¹¶ä¸ä¼šç›´æ¥åˆ›å»ºPodï¼Œå› ä¸ºå®ƒåªæ˜¯å¯¹å®¹å™¨åšäº†ç®€å•çš„åŒ…è£…ï¼Œæ¯”è¾ƒè„†å¼±ï¼Œç¦»å¤æ‚çš„ä¸šåŠ¡éœ€æ±‚è¿˜æœ‰äº›è·ç¦»ï¼Œéœ€è¦Jobã€CronJobã€Deploymentç­‰å…¶ä»–å¯¹è±¡å¢æ·»æ›´å¤šçš„åŠŸèƒ½æ‰èƒ½æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ã€‚



## 13 Job_CronJobï¼šä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨Podæ¥å¤„ç†ä¸šåŠ¡ï¼Ÿ

### 13.1 ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨Pod



### 13.2 ä¸ºä»€ä¹ˆè¦æœ‰Job/CronJob



#### å¦‚ä½•ä½¿ç”¨YAMLæè¿°Job

![](images/image-20250107150724162.png)

#### å¦‚ä½•åœ¨Kubernetesé‡Œæ“ä½œJob





### 13.3 å¦‚ä½•ä½¿ç”¨YAMLæè¿°CronJob

![](images/image-20250107150906084.png)



### å°ç»“



1. Podæ˜¯Kubernetesçš„æœ€å°è°ƒåº¦å•å…ƒï¼Œä½†ä¸ºäº†ä¿æŒå®ƒçš„ç‹¬ç«‹æ€§ï¼Œä¸åº”è¯¥å‘å®ƒæ·»åŠ å¤šä½™çš„åŠŸèƒ½ã€‚
2. Kubernetesä¸ºç¦»çº¿ä¸šåŠ¡æä¾›äº†Jobå’ŒCronJobä¸¤ç§APIå¯¹è±¡ï¼Œåˆ†åˆ«å¤„ç†â€œä¸´æ—¶ä»»åŠ¡â€å’Œâ€œå®šæ—¶ä»»åŠ¡â€ã€‚
3. Jobçš„å…³é”®å­—æ®µæ˜¯ `spec.template`ï¼Œé‡Œé¢å®šä¹‰äº†ç”¨æ¥è¿è¡Œä¸šåŠ¡çš„Podæ¨¡æ¿ï¼Œå…¶ä»–çš„é‡è¦å­—æ®µæœ‰ `completions`ã€`parallelism` ç­‰
4. CronJobçš„å…³é”®å­—æ®µæ˜¯ `spec.jobTemplate` å’Œ `spec.schedule`ï¼Œåˆ†åˆ«å®šä¹‰äº†Jobæ¨¡æ¿å’Œå®šæ—¶è¿è¡Œçš„è§„åˆ™ã€‚



## 14 ConfigMap_Secretï¼šæ€æ ·é…ç½®ã€å®šåˆ¶æˆ‘çš„åº”ç”¨

### 14.1 ConfigMap/Secret

#### ä»€ä¹ˆæ˜¯ConfigMap



#### ä»€ä¹ˆæ˜¯Secret



### 14.2 å¦‚ä½•ä½¿ç”¨

#### å¦‚ä½•ä»¥ç¯å¢ƒå˜é‡çš„æ–¹å¼ä½¿ç”¨ConfigMap/Secret



#### å¦‚ä½•ä»¥Volumeçš„æ–¹å¼ä½¿ç”¨ConfigMap/Secret



## 15 å®æˆ˜æ¼”ç»ƒï¼šç©è½¬Kubernetesï¼ˆ1ï¼‰

### KubernetesæŠ€æœ¯è¦ç‚¹å›é¡¾

![](images/f429ca7114eebf140632409f3fbcbb05.png)

### WordPressç½‘ç«™åŸºæœ¬æ¶æ„

![](images/image-20250212173720568.png)

### WordPressç½‘ç«™æ­å»ºæ­¥éª¤



### ä½¿ç”¨Dashboardç®¡ç†Kubernetes



### å°ç»“





![](images/87a1d338340c8ca771a97d0fyy4b611f.jpg)

## 16 è§†é¢‘ï¼šåˆçº§ç¯‡å®æ“æ€»ç»“



# ä¸­çº§

## 17 æ›´çœŸå®çš„äº‘åŸç”Ÿï¼šå®é™…æ­å»ºå¤šèŠ‚ç‚¹çš„Kubernetesé›†ç¾¤





## 18 Deploymentï¼šè®©åº”ç”¨æ°¸ä¸å®•æœº

### ä¸ºä»€ä¹ˆè¦æœ‰Deployment

### å¦‚ä½•ä½¿ç”¨YAMLæè¿°Deployment

### Deploymentçš„å…³é”®å­—æ®µ

### å¦‚ä½•ä½¿ç”¨kubectlæ“ä½œDeployment



### å°ç»“

Deploymentï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯åœ¨çº¿ä¸šåŠ¡ï¼Œå’ŒJob/CronJobçš„ç»“æ„ç±»ä¼¼ï¼Œä¹ŸåŒ…è£…äº†Podå¯¹è±¡ï¼Œé€šè¿‡æ·»åŠ é¢å¤–çš„æ§åˆ¶åŠŸèƒ½å®ç°äº†åº”ç”¨æ°¸ä¸å®•æœºã€‚



1. Podåªèƒ½ç®¡ç†å®¹å™¨ï¼Œä¸èƒ½ç®¡ç†è‡ªèº«ï¼Œæ‰€ä»¥å°±å‡ºç°äº†Deploymentï¼Œç”±å®ƒæ¥ç®¡ç†Podã€‚
2. Deploymenté‡Œæœ‰ä¸‰ä¸ªå…³é”®å­—æ®µï¼Œå…¶ä¸­çš„templateå’ŒJobä¸€æ ·ï¼Œå®šä¹‰äº†è¦è¿è¡Œçš„Podæ¨¡æ¿ã€‚
3. replicaså­—æ®µå®šä¹‰äº†Podçš„â€œæœŸæœ›æ•°é‡â€ï¼ŒKubernetesä¼šè‡ªåŠ¨ç»´æŠ¤Podæ•°é‡åˆ°æ­£å¸¸æ°´å¹³ã€‚
4. selectorå­—æ®µå®šä¹‰äº†åŸºäºlabelsç­›é€‰Podçš„è§„åˆ™ï¼Œå®ƒå¿…é¡»ä¸templateé‡ŒPodçš„labelsä¸€è‡´ã€‚
5. åˆ›å»ºDeploymentä½¿ç”¨å‘½ä»¤ `kubectl apply`ï¼Œåº”ç”¨çš„æ‰©å®¹ã€ç¼©å®¹ä½¿ç”¨å‘½ä»¤ `kubectl scale`ã€‚







## 19 Daemonsetï¼šå¿ å®å¯é çš„çœ‹é—¨ç‹—

ä¸ºä»€ä¹ˆè¦æœ‰DaemonSet
å¦‚ä½•ä½¿ç”¨YAMLæè¿°DaemonSet
å¦‚ä½•åœ¨Kubernetesé‡Œä½¿ç”¨DaemonSet
ä»€ä¹ˆæ˜¯æ±¡ç‚¹ï¼ˆtaintï¼‰å’Œå®¹å¿åº¦ï¼ˆtolerationï¼‰
ä»€ä¹ˆæ˜¯é™æ€Pod



## 20 Serviceï¼šå¾®æœåŠ¡æ¶æ„çš„åº”å¯¹ä¹‹é“

ä¸ºä»€ä¹ˆè¦æœ‰Service
å¦‚ä½•ä½¿ç”¨YAMLæè¿°Service
å¦‚ä½•åœ¨Kubernetesé‡Œä½¿ç”¨Service
å¦‚ä½•ä»¥åŸŸåçš„æ–¹å¼ä½¿ç”¨Service
å¦‚ä½•è®©Serviceå¯¹å¤–æš´éœ²æœåŠ¡



## 21 Ingressï¼šé›†ç¾¤è¿›å‡ºæµé‡çš„æ€»ç®¡

ä¸ºä»€ä¹ˆè¦æœ‰Ingress
ä¸ºä»€ä¹ˆè¦æœ‰Ingress Controller
ä¸ºä»€ä¹ˆè¦æœ‰IngressClass
å¦‚ä½•ä½¿ç”¨YAMLæè¿°Ingress/Ingress Class
å¦‚ä½•åœ¨Kubernetesé‡Œä½¿ç”¨Ingress/Ingress Class
å¦‚ä½•åœ¨Kubernetesé‡Œä½¿ç”¨Ingress Controller





## 22 å®æˆ˜æ¼”ç»ƒï¼šç©è½¬Kubernetesï¼ˆ2ï¼‰





## 23 è§†é¢‘ï¼šä¸­çº§ç¯‡å®æ“æ€»ç»“



# é«˜çº§

## 24 PersistentVolumeï¼šæ€ä¹ˆè§£å†³æ•°æ®æŒä¹…åŒ–çš„éš¾é¢˜ï¼Ÿ

ä»€ä¹ˆæ˜¯PersistentVolume
ä»€ä¹ˆæ˜¯PersistentVolumeClaim/StorageClass
å¦‚ä½•ä½¿ç”¨YAMLæè¿°PersistentVolume
å¦‚ä½•ä½¿ç”¨YAMLæè¿°PersistentVolumeClaim
å¦‚ä½•åœ¨Kubernetesé‡Œä½¿ç”¨PersistentVolume
å¦‚ä½•ä¸ºPodæŒ‚è½½PersistentVolume



## 25 PersistentVolume + NFSï¼šæ€ä¹ˆä½¿ç”¨ç½‘ç»œå…±äº«å­˜å‚¨ï¼Ÿ

å¦‚ä½•å®‰è£…NFSæœåŠ¡å™¨
å¦‚ä½•å®‰è£…NFSå®¢æˆ·ç«¯
å¦‚ä½•ä½¿ç”¨NFSå­˜å‚¨å·
å¦‚ä½•éƒ¨ç½²NFS Provisoner
å¦‚ä½•ä½¿ç”¨NFSåŠ¨æ€å­˜å‚¨å·

## 26 StatefulSetï¼šæ€ä¹ˆç®¡ç†æœ‰çŠ¶æ€çš„åº”ç”¨ï¼Ÿ

ä»€ä¹ˆæ˜¯æœ‰çŠ¶æ€çš„åº”ç”¨
å¦‚ä½•ä½¿ç”¨YAMLæè¿°StatefulSet
å¦‚ä½•åœ¨Kubernetesé‡Œä½¿ç”¨StatefulSet
å¦‚ä½•å®ç°StatefulSetçš„æ•°æ®æŒä¹…åŒ–



## 27 æ»šåŠ¨æ›´æ–°ï¼šå¦‚ä½•åšåˆ°å¹³æ»‘çš„åº”ç”¨å‡çº§é™çº§ï¼Ÿ

Kuberneteså¦‚ä½•å®šä¹‰åº”ç”¨ç‰ˆæœ¬
Kuberneteså¦‚ä½•å®ç°åº”ç”¨æ›´æ–°
Kuberneteså¦‚ä½•ç®¡ç†åº”ç”¨æ›´æ–°
Kuberneteså¦‚ä½•æ·»åŠ æ›´æ–°æè¿°

## 28 åº”ç”¨ä¿éšœï¼šå¦‚ä½•è®©Podè¿è¡Œå¾—æ›´å¥åº·ï¼Ÿ

å®¹å™¨èµ„æºé…é¢
ä»€ä¹ˆæ˜¯å®¹å™¨çŠ¶æ€æ¢é’ˆ
å¦‚ä½•ä½¿ç”¨å®¹å™¨çŠ¶æ€æ¢é’ˆ

## 29 é›†ç¾¤ç®¡ç†ï¼šå¦‚ä½•ç”¨åå­—ç©ºé—´åˆ†éš”ç³»ç»Ÿèµ„æºï¼Ÿ

ä¸ºä»€ä¹ˆè¦æœ‰åå­—ç©ºé—´
å¦‚ä½•ä½¿ç”¨åå­—ç©ºé—´
ä»€ä¹ˆæ˜¯èµ„æºé…é¢
å¦‚ä½•ä½¿ç”¨èµ„æºé…é¢
é»˜è®¤èµ„æºé…é¢

## 30 ç³»ç»Ÿç›‘æ§ï¼šå¦‚ä½•ä½¿ç”¨Metrics Serverå’ŒPrometheusï¼Ÿ





## 31 ç½‘ç»œé€šä¿¡ï¼šCNIæ˜¯æ€ä¹ˆå›äº‹ï¼Ÿåˆæ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ

Kubernetesçš„ç½‘ç»œæ¨¡å‹
ä»€ä¹ˆæ˜¯CNI
CNIæ’ä»¶æ˜¯æ€ä¹ˆå·¥ä½œçš„
ä½¿ç”¨Calicoç½‘ç»œæ’ä»¶



## 32 å®æˆ˜æ¼”ç»ƒï¼šç©è½¬Kubernetesï¼ˆ3ï¼‰



## 33 è§†é¢‘ï¼šé«˜çº§ç¯‡å®æ“æ€»ç»“



## ç»“æŸè¯­ æ˜¯ç»ˆç‚¹ï¼Œæ›´æ˜¯èµ·ç‚¹



# è¡¥å……

## docker-composeï¼šå•æœºç¯å¢ƒä¸‹çš„å®¹å™¨ç¼–æ’å·¥å…·



## è°ˆè°ˆKong Ingress Controller

