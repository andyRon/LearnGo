Goè¯­è¨€æ›´å¤š
------



å‚è€ƒï¼š

1ï¸âƒ£[ã€ŠGOè¯­è¨€ä»å…¥é—¨åˆ°é¡¹ç›®å®è·µï¼ˆè¶…å€¼ç‰ˆï¼‰ã€‹ä½™å»ºç†™ 2022](http://www.tup.tsinghua.edu.cn/bookscenter/book_09281301.html)

2ï¸âƒ£[ã€ŠGoè¯­è¨€å¼€å‘å®æˆ˜ï¼ˆæ…•è¯¾ç‰ˆï¼‰ã€‹åƒé”‹æ•™è‚²é«˜æ•™äº§å“ç ”å‘éƒ¨ 2020](https://book.douban.com/subject/34956558/)

3ï¸âƒ£[ã€ŠGoè¯­è¨€ä»å…¥é—¨åˆ°é¡¹ç›®å®æˆ˜ï¼ˆè§†é¢‘ç‰ˆï¼‰ã€‹](https://book.douban.com/subject/36049170/) åˆ˜ç‘œ 2022

4ï¸âƒ£ [Goè¯­è¨€ç²¾è¿›ä¹‹è·¯1](https://book.douban.com/subject/35720728/) [Goè¯­è¨€ç²¾è¿›ä¹‹è·¯2](https://book.douban.com/subject/35720729/)  2021

# è¡¥å……1

## 47 Goæ ‡å‡†åº“

å‚è€ƒï¼š

https://www.topgoer.com/%E5%B8%B8%E7%94%A8%E6%A0%87%E5%87%86%E5%BA%93/

[Golangæ ‡å‡†åº“æ¡ˆä¾‹](https://github.com/polaris1119/The-Golang-Standard-Library-by-Example)

### 47.1 IO

### 47.1 fmtåŒ…

#### å‘å¤–è¾“å‡º

##### Printç³»åˆ—

åŒºåˆ«åœ¨äºPrintå‡½æ•°ç›´æ¥è¾“å‡ºå†…å®¹ï¼ŒPrintfå‡½æ•°æ”¯æŒæ ¼å¼åŒ–è¾“å‡ºå­—ç¬¦ä¸²ï¼ŒPrintlnå‡½æ•°ä¼šåœ¨è¾“å‡ºå†…å®¹çš„ç»“å°¾æ·»åŠ ä¸€ä¸ªæ¢è¡Œç¬¦ã€‚

```go
func Print(a ...interface{}) (n int, err error)
func Printf(format string, a ...interface{}) (n int, err error)
func Println(a ...interface{}) (n int, err error)
```

##### Fprintç³»åˆ—

Fprintç³»åˆ—å‡½æ•°ä¼šå°†å†…å®¹è¾“å‡ºåˆ°ä¸€ä¸ªio.Writeræ¥å£ç±»å‹çš„å˜é‡wä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ç”¨è¿™ä¸ªå‡½æ•°å¾€æ–‡ä»¶ä¸­å†™å…¥å†…å®¹ã€‚

```go
func Fprint(w io.Writer, a ...interface{}) (n int, err error)
func Fprintf(w io.Writer, format string, a ...interface{}) (n int, err error)
func Fprintln(w io.Writer, a ...interface{}) (n int, err error)
```

```go
// å‘æ ‡å‡†è¾“å‡ºå†™å…¥å†…å®¹
fmt.Fprintln(os.Stdout, "å‘æ ‡å‡†è¾“å‡ºå†™å…¥å†…å®¹")
fileObj, err := os.OpenFile("./xx.txt", os.O_CREATE|os.O_WRONLY|os.O_APPEND, 0644)
if err != nil {
    fmt.Println("æ‰“å¼€æ–‡ä»¶å‡ºé”™ï¼Œerr:", err)
    return
}
name := "æ¯è—¤"
// å‘æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„ä¸­å†™å…¥å†…å®¹
fmt.Fprintf(fileObj, "å¾€æ–‡ä»¶ä¸­å†™å¦‚ä¿¡æ¯ï¼š%s", name)
```

æ³¨æ„ï¼Œåªè¦æ»¡è¶³io.Writeræ¥å£çš„ç±»å‹éƒ½æ”¯æŒå†™å…¥ã€‚

##### Sprintç³»åˆ—

Sprintç³»åˆ—å‡½æ•°ä¼šæŠŠä¼ å…¥çš„æ•°æ®ç”Ÿæˆå¹¶è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚

```go
func Sprint(a ...interface{}) string
func Sprintf(format string, a ...interface{}) string
func Sprintln(a ...interface{}) string
```

##### Errorf

Errorfå‡½æ•°æ ¹æ®formatå‚æ•°ç”Ÿæˆæ ¼å¼åŒ–å­—ç¬¦ä¸²å¹¶è¿”å›ä¸€ä¸ªåŒ…å«è¯¥å­—ç¬¦ä¸²çš„é”™è¯¯ã€‚

```go
func Errorf(format string, a ...interface{}) error
```

é€šå¸¸ä½¿ç”¨è¿™ç§æ–¹å¼æ¥è‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼Œä¾‹å¦‚ï¼š

```go
err := fmt.Errorf("è¿™æ˜¯ä¸€ä¸ªé”™è¯¯")
```

#### æ ¼å¼åŒ–å ä½ç¬¦

`*printf`ç³»åˆ—å‡½æ•°éƒ½æ”¯æŒformatæ ¼å¼åŒ–å‚æ•°ã€‚

æŒ‰ç…§å ä½ç¬¦å°†è¢«æ›¿æ¢çš„å˜é‡ç±»å‹åˆ’åˆ†ï¼š

| é€šç”¨å ä½ç¬¦               | è¯´æ˜                                                         |
| ------------------------ | ------------------------------------------------------------ |
| %v                       | å€¼çš„é»˜è®¤æ ¼å¼è¡¨ç¤º                                             |
| %+v                      | ç±»ä¼¼%vï¼Œä½†è¾“å‡ºç»“æ„ä½“æ—¶ä¼šæ·»åŠ å­—æ®µå                           |
| %#v                      | å€¼çš„Goè¯­æ³•è¡¨ç¤º                                               |
| %T                       | æ‰“å°å€¼çš„ç±»å‹                                                 |
| %%                       | ç™¾åˆ†å·                                                       |
| **å¸ƒå°”å ä½ç¬¦**           |                                                              |
| %t                       | trueæˆ–false                                                  |
| **æ•´å‹å ä½ç¬¦**           |                                                              |
| %b                       | è¡¨ç¤ºä¸ºäºŒè¿›åˆ¶                                                 |
| %c                       | è¯¥å€¼å¯¹åº”çš„unicodeç å€¼                                        |
| %d                       | è¡¨ç¤ºä¸ºåè¿›åˆ¶                                                 |
| %o                       | è¡¨ç¤ºä¸ºå…«è¿›åˆ¶                                                 |
| %x                       | è¡¨ç¤ºä¸ºåå…­è¿›åˆ¶ï¼Œä½¿ç”¨a-f                                      |
| %X                       | è¡¨ç¤ºä¸ºåå…­è¿›åˆ¶ï¼Œä½¿ç”¨A-F                                      |
| %U                       | è¡¨ç¤ºä¸ºUnicodeæ ¼å¼ï¼šU+1234ï¼Œç­‰ä»·äºâ€U+%04Xâ€                    |
| %q                       | è¯¥å€¼å¯¹åº”çš„å•å¼•å·æ‹¬èµ·æ¥çš„goè¯­æ³•å­—ç¬¦å­—é¢å€¼ï¼Œå¿…è¦æ—¶ä¼šé‡‡ç”¨å®‰å…¨çš„è½¬ä¹‰è¡¨ç¤º |
| **æµ®ç‚¹æ•°ä¸å¤æ•°å ä½ç¬¦**   |                                                              |
| %b                       | æ— å°æ•°éƒ¨åˆ†ã€äºŒè¿›åˆ¶æŒ‡æ•°çš„ç§‘å­¦è®¡æ•°æ³•ï¼Œå¦‚-123456p-78            |
| %e                       | ç§‘å­¦è®¡æ•°æ³•ï¼Œå¦‚-1234.456e+78                                  |
| %E                       | ç§‘å­¦è®¡æ•°æ³•ï¼Œå¦‚-1234.456E+78                                  |
| %f                       | æœ‰å°æ•°éƒ¨åˆ†ä½†æ— æŒ‡æ•°éƒ¨åˆ†ï¼Œå¦‚123.456                            |
| %F                       | ç­‰ä»·äº%f                                                     |
| %g                       | æ ¹æ®å®é™…æƒ…å†µé‡‡ç”¨%eæˆ–%fæ ¼å¼ï¼ˆä»¥è·å¾—æ›´ç®€æ´ã€å‡†ç¡®çš„è¾“å‡ºï¼‰       |
| %G                       | æ ¹æ®å®é™…æƒ…å†µé‡‡ç”¨%Eæˆ–%Fæ ¼å¼ï¼ˆä»¥è·å¾—æ›´ç®€æ´ã€å‡†ç¡®çš„è¾“å‡ºï¼‰       |
| **å­—ç¬¦ä¸²å’Œ[]byteå ä½ç¬¦** |                                                              |
| %s                       | ç›´æ¥è¾“å‡ºå­—ç¬¦ä¸²æˆ–è€…[]byte                                     |
| %q                       | è¯¥å€¼å¯¹åº”çš„åŒå¼•å·æ‹¬èµ·æ¥çš„goè¯­æ³•å­—ç¬¦ä¸²å­—é¢å€¼ï¼Œå¿…è¦æ—¶ä¼šé‡‡ç”¨å®‰å…¨çš„è½¬ä¹‰è¡¨ç¤º |
| %x                       | æ¯ä¸ªå­—èŠ‚ç”¨ä¸¤å­—ç¬¦åå…­è¿›åˆ¶æ•°è¡¨ç¤ºï¼ˆä½¿ç”¨a-f                      |
| %X                       | æ¯ä¸ªå­—èŠ‚ç”¨ä¸¤å­—ç¬¦åå…­è¿›åˆ¶æ•°è¡¨ç¤ºï¼ˆä½¿ç”¨A-Fï¼‰                    |
| **æŒ‡é’ˆ**                 |                                                              |
| %p                       | è¡¨ç¤ºä¸ºåå…­è¿›åˆ¶ï¼Œå¹¶åŠ ä¸Šå‰å¯¼çš„0x                               |
|                          |                                                              |
|                          |                                                              |
|                          |                                                              |

##### å®½åº¦æ ‡è¯†ç¬¦

| å ä½ç¬¦ | è¯´æ˜               |
| ------ | ------------------ |
| %f     | é»˜è®¤å®½åº¦ï¼Œé»˜è®¤ç²¾åº¦ |
| %9f    | å®½åº¦9ï¼Œé»˜è®¤ç²¾åº¦    |
| %.2f   | é»˜è®¤å®½åº¦ï¼Œç²¾åº¦2    |
| %9.2f  | å®½åº¦9ï¼Œç²¾åº¦2       |
| %9.f   | å®½åº¦9ï¼Œç²¾åº¦0       |

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```go
n := 88.88
fmt.Printf("%f\n", n)
fmt.Printf("%9f\n", n)
fmt.Printf("%.2f\n", n)
fmt.Printf("%9.2f\n", n)
fmt.Printf("%9.f\n", n)
```

è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

```
    88.880000
    88.880000
    88.88
        88.88
           89
```

##### å…¶ä»–falg

| å ä½ç¬¦ | è¯´æ˜                                                         |
| ------ | ------------------------------------------------------------ |
| â€™+â€™    | æ€»æ˜¯è¾“å‡ºæ•°å€¼çš„æ­£è´Ÿå·ï¼›å¯¹%qï¼ˆ%+qï¼‰ä¼šç”Ÿæˆå…¨éƒ¨æ˜¯ASCIIå­—ç¬¦çš„è¾“å‡ºï¼ˆé€šè¿‡è½¬ä¹‰ï¼‰ï¼› |
| â€™ â€˜    | å¯¹æ•°å€¼ï¼Œæ­£æ•°å‰åŠ ç©ºæ ¼è€Œè´Ÿæ•°å‰åŠ è´Ÿå·ï¼›å¯¹å­—ç¬¦ä¸²é‡‡ç”¨%xæˆ–%Xæ—¶ï¼ˆ% xæˆ–% Xï¼‰ä¼šç»™å„æ‰“å°çš„å­—èŠ‚ä¹‹é—´åŠ ç©ºæ ¼ |
| â€™-â€™    | åœ¨è¾“å‡ºå³è¾¹å¡«å……ç©ºç™½è€Œä¸æ˜¯é»˜è®¤çš„å·¦è¾¹ï¼ˆå³ä»é»˜è®¤çš„å³å¯¹é½åˆ‡æ¢ä¸ºå·¦å¯¹é½ï¼‰ï¼› |
| â€™#â€™    | å…«è¿›åˆ¶æ•°å‰åŠ 0ï¼ˆ%#oï¼‰ï¼Œåå…­è¿›åˆ¶æ•°å‰åŠ 0xï¼ˆ%#xï¼‰æˆ–0Xï¼ˆ%#Xï¼‰ï¼ŒæŒ‡é’ˆå»æ‰å‰é¢çš„0xï¼ˆ%#pï¼‰å¯¹%qï¼ˆ%#qï¼‰ï¼Œå¯¹%Uï¼ˆ%#Uï¼‰ä¼šè¾“å‡ºç©ºæ ¼å’Œå•å¼•å·æ‹¬èµ·æ¥çš„goå­—é¢å€¼ï¼› |
| â€˜0â€™    | ä½¿ç”¨0è€Œä¸æ˜¯ç©ºæ ¼å¡«å……ï¼Œå¯¹äºæ•°å€¼ç±»å‹ä¼šæŠŠå¡«å……çš„0æ”¾åœ¨æ­£è´Ÿå·åé¢ï¼› |

ä¸¾ä¸ªä¾‹å­ï¼š

```go
s := "æ¯è—¤"
fmt.Printf("%s\n", s)
fmt.Printf("%5s\n", s)
fmt.Printf("%-5s\n", s)
fmt.Printf("%5.7s\n", s)
fmt.Printf("%-5.7s\n", s)
fmt.Printf("%5.2s\n", s)
fmt.Printf("%05s\n", s)
```

è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

```
    æ¯è—¤
       æ¯è—¤
    æ¯è—¤
       æ¯è—¤
    æ¯è—¤
       æ¯è—¤
    000æ¯è—¤
```

#### è·å–è¾“å…¥

fmtåŒ…ä¸‹æœ‰fmt.Scanã€fmt.Scanfã€fmt.Scanlnä¸‰ä¸ªå‡½æ•°ï¼Œå¯ä»¥åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ä»æ ‡å‡†è¾“å…¥è·å–ç”¨æˆ·çš„è¾“å…¥ã€‚

##### fmt.Scan

```go
func Scan(a ...interface{}) (n int, err error)
```

```go
func main() {
    var (
        name    string
        age     int
        married bool
    )
    fmt.Scan(&name, &age, &married)
    fmt.Printf("æ‰«æç»“æœ name:%s age:%d married:%t \n", name, age, married)
}
```

fmt.Scanä»æ ‡å‡†è¾“å…¥ä¸­æ‰«æç”¨æˆ·è¾“å…¥çš„æ•°æ®ï¼Œå°†ä»¥ç©ºç™½ç¬¦åˆ†éš”çš„æ•°æ®åˆ†åˆ«å­˜å…¥æŒ‡å®šçš„å‚æ•°ã€‚

##### fmt.Scanf

```go
func Scanf(format string, a ...interface{}) (n int, err error)
```

Scanfä»æ ‡å‡†è¾“å…¥æ‰«ææ–‡æœ¬ï¼Œæ ¹æ®formatå‚æ•°æŒ‡å®šçš„æ ¼å¼å»è¯»å–ç”±ç©ºç™½ç¬¦åˆ†éš”çš„å€¼ä¿å­˜åˆ°ä¼ é€’ç»™æœ¬å‡½æ•°çš„å‚æ•°ä¸­ã€‚

```go
func main() {
    var (
        name    string
        age     int
        married bool
    )
    fmt.Scanf("1:%s 2:%d 3:%t", &name, &age, &married)
    fmt.Printf("æ‰«æç»“æœ name:%s age:%d married:%t \n", name, age, married)
}
```

```
$ ./fmt3    
1:andy 2:19 3:true 
æ‰«æç»“æœ name:andy age:19 married:true 

```

fmt.Scanfä¸åŒäºfmt.Scanç®€å•çš„ä»¥ç©ºæ ¼ä½œä¸ºè¾“å…¥æ•°æ®çš„åˆ†éš”ç¬¦ï¼Œfmt.Scanfä¸ºè¾“å…¥æ•°æ®æŒ‡å®šäº†å…·ä½“çš„è¾“å…¥å†…å®¹æ ¼å¼ï¼Œåªæœ‰æŒ‰ç…§æ ¼å¼è¾“å…¥æ•°æ®æ‰ä¼šè¢«æ‰«æå¹¶å­˜å…¥å¯¹åº”å˜é‡ã€‚

##### fmt.Scanln

```go
func Scanln(a ...interface{}) (n int, err error)
```

Scanlnç±»ä¼¼Scanï¼Œå®ƒåœ¨é‡åˆ°æ¢è¡Œæ—¶æ‰åœæ­¢æ‰«æã€‚æœ€åä¸€ä¸ªæ•°æ®åé¢å¿…é¡»æœ‰æ¢è¡Œæˆ–è€…åˆ°è¾¾ç»“æŸä½ç½®ã€‚

```go
func main() {
	var (
		name    string
		age     int
		married bool
	)
	fmt.Scanln(&name, &age, &married)
	fmt.Printf("æ‰«æç»“æœ name:%s age:%d married:%t \n", name, age, married)
}
```

```
./fmt4
æå¾·èƒœ 36 true
æ‰«æç»“æœ name:æå¾·èƒœ age:36 married:true 
```

##### bufio.NewReader

æƒ³å®Œæ•´è·å–è¾“å…¥çš„å†…å®¹ï¼Œè€Œè¾“å…¥çš„å†…å®¹å¯èƒ½åŒ…å«ç©ºæ ¼ï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨bufioåŒ…æ¥å®ç°ã€‚



##### Fscanç³»åˆ—

ç±»ä¼¼ä¹‹å‰ä¸‰ä¸ªå‡½æ•°ï¼Œåªä¸è¿‡å®ƒä»¬ä¸æ˜¯ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–æ•°æ®è€Œæ˜¯ä»io.Readerä¸­è¯»å–æ•°æ®ã€‚

```go
func Fscan(r io.Reader, a ...interface{}) (n int, err error)
func Fscanln(r io.Reader, a ...interface{}) (n int, err error)
func Fscanf(r io.Reader, format string, a ...interface{}) (n int, err error)
```

##### Sscanç³»åˆ—

ä¸æ˜¯ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–æ•°æ®è€Œæ˜¯ä»æŒ‡å®šå­—ç¬¦ä¸²ä¸­è¯»å–æ•°æ®ã€‚

```go
func Sscan(str string, a ...interface{}) (n int, err error)
func Sscanln(str string, a ...interface{}) (n int, err error)
func Sscanf(str string, format string, a ...interface{}) (n int, err error)
```



### 47.2 æ–‡æœ¬





### 47.3 æ•°æ®ç»“æ„ä¸ç®—æ³•

#### æ’åº

åŒ…`sort`

```go
Len()
Less
Reverse
Swap

Sort()
IsSorted()
Search()
// sortåŒ…åŸç”Ÿæ”¯æŒ[]intã€[]float64 å’Œ[]string ä¸‰ç§å†…å»ºæ•°æ®ç±»å‹åˆ‡ç‰‡çš„æ’åºæ“ä½œ
IntSlice
Float64Slice
StringSlice

func Float64s(a []float64)  
func Float64sAreSorted(a []float64) bool
func SearchFloat64s(a []float64, x float64) int

func Strings(a []string)
func StringsAreSorted(a []string) bool
func SearchStrings(a []string, x string) int
```



`[]interface` æ’åºä¸æŸ¥æ‰¾

```go
func Slice(slice interface{}, less func(i, j int) bool) 
func SliceStable(slice interface{}, less func(i, j int) bool) 
func SliceIsSorted(slice interface{}, less func(i, j int) bool) bool 
func Search(n int, f func(int) bool) int
```



#### å®¹å™¨

åŒ…`container`



### 47.4 æ—¥æœŸå’Œæ—¶é—´

Go è¯­è¨€é€šè¿‡æ ‡å‡†åº“ `time` åŒ…å¤„ç†æ—¥æœŸå’Œæ—¶é—´ç›¸å…³çš„é—®é¢˜ã€‚

`time` åŒ…æä¾›äº†æ—¶é—´çš„æ˜¾ç¤ºå’Œè®¡é‡ç”¨çš„åŠŸèƒ½ã€‚æ—¥å†çš„è®¡ç®—é‡‡ç”¨çš„æ˜¯å…¬å†ã€‚æä¾›çš„ä¸»è¦ç±»å‹ï¼š

- `Location`ï¼Œä»£è¡¨ä¸€ä¸ªåœ°åŒºï¼Œå¹¶è¡¨ç¤ºè¯¥åœ°åŒºæ‰€åœ¨çš„æ—¶åŒºï¼ˆå¯èƒ½å¤šä¸ªï¼‰ã€‚`Location` é€šå¸¸ä»£è¡¨åœ°ç†ä½ç½®çš„åç§»ï¼Œæ¯”å¦‚ CEST å’Œ CET è¡¨ç¤ºä¸­æ¬§ã€‚

- `Time`ï¼Œä»£è¡¨ä¸€ä¸ªçº³ç§’ç²¾åº¦çš„æ—¶é—´ç‚¹ï¼Œæ˜¯å…¬å†æ—¶é—´ã€‚

- `Duration`ï¼Œä»£è¡¨ä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹é—´ç»è¿‡çš„æ—¶é—´ï¼Œä»¥çº³ç§’ä¸ºå•ä½ã€‚å¯è¡¨ç¤ºçš„æœ€é•¿æ—¶é—´æ®µå¤§çº¦ 290 å¹´ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœä¸¤ä¸ªæ—¶é—´ç‚¹ç›¸å·®è¶…è¿‡ 290 å¹´ï¼Œä¼šè¿”å› 290 å¹´ï¼Œä¹Ÿå°±æ˜¯ minDuration(-1 << 63) æˆ– maxDuration(1 << 63 - 1)ã€‚

  ç±»å‹å®šä¹‰ï¼š`type Duration int64`ã€‚

  å°† `Duration` ç±»å‹ç›´æ¥è¾“å‡ºæ—¶ï¼Œå› ä¸ºå®ç°äº† `fmt.Stringer` æ¥å£ï¼Œä¼šè¾“å‡ºäººç±»å‹å¥½çš„å¯è¯»å½¢å¼ï¼Œå¦‚ï¼š72h3m0.5sã€‚

- `Timer` å’Œ `Ticker`ï¼Œå®šæ—¶å™¨ç›¸å…³ç±»å‹

- `Weekday` å’Œ `Month`ï¼ŒåŸå§‹ç±»å‹éƒ½æ˜¯ intï¼Œå®ç° `fmt.Stringer` æ¥å£ï¼Œæ–¹ä¾¿è¾“å‡ºã€‚

  

47.2 timeåŒ…

![](images/time.png)

#### æ—¶é—´ç±»å‹



#### æ—¶é—´æˆ³



##### æ—¶é—´é—´éš”



##### æ—¶é—´æ“ä½œ

```
Add
Sub
Equal
Before
After
```

##### å®šæ—¶å™¨

ä½¿ç”¨time.Tick(æ—¶é—´é—´éš”)æ¥è®¾ç½®å®šæ—¶å™¨ï¼Œå®šæ—¶å™¨çš„æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé€šé“ï¼ˆchannelï¼‰ã€‚

```go
func tickDemo() {
    ticker := time.Tick(time.Second) //å®šä¹‰ä¸€ä¸ª1ç§’é—´éš”çš„å®šæ—¶å™¨
    for i := range ticker {
        fmt.Println(i)//æ¯ç§’éƒ½ä¼šæ‰§è¡Œçš„ä»»åŠ¡
    }
}
```

##### æ—¶é—´æ ¼å¼åŒ–

Goè¯­è¨€ä¸­æ ¼å¼åŒ–æ—¶é—´æ¨¡æ¿ä¸æ˜¯å¸¸è§çš„Y-m-d H:M:Sè€Œæ˜¯ä½¿ç”¨Goçš„è¯ç”Ÿæ—¶é—´2006å¹´1æœˆ2å·15ç‚¹04åˆ†ï¼ˆè®°å¿†å£è¯€ä¸º2006 1 2 3 4ï¼‰ã€‚

### 47.5 åŸºæœ¬æ•°å­¦å‡½æ•°

`math`

![](images/image-20250102224620500.png)



math åŒ…å®ç°çš„å°±æ˜¯æ•°å­¦å‡½æ•°è®¡ç®—ã€‚

#### ä¸‰è§’å‡½æ•° ####

æ­£å¼¦å‡½æ•°ï¼Œåæ­£å¼¦å‡½æ•°ï¼ŒåŒæ›²æ­£å¼¦ï¼ŒååŒæ›²æ­£å¼¦

```go
- func Sin(x float64) float64
- func Asin(x float64) float64
- func Sinh(x float64) float64
- func Asinh(x float64) float64
```

ä¸€æ¬¡æ€§è¿”å› sin,cos

- func Sincos(x float64) (sin, cos float64)

ä½™å¼¦å‡½æ•°ï¼Œåä½™å¼¦å‡½æ•°ï¼ŒåŒæ›²ä½™å¼¦ï¼ŒååŒæ›²ä½™å¼¦

```go
- func Cos(x float64) float64
- func Acos(x float64) float64
- func Cosh(x float64) float64
- func Acosh(x float64) float64
```

æ­£åˆ‡å‡½æ•°ï¼Œåæ­£åˆ‡å‡½æ•°ï¼ŒåŒæ›²æ­£åˆ‡ï¼ŒååŒæ›²æ­£åˆ‡

```go
- func Tan(x float64) float64
- func Atan(x float64) float64 å’Œ func Atan2(y, x float64) float64
- func Tanh(x float64) float64
- func Atanh(x float64) float64
```

#### å¹‚æ¬¡å‡½æ•° ####

```go
- func Cbrt(x float64) float64 // ç«‹æ–¹æ ¹å‡½æ•°
- func Pow(x, y float64) float64  // x çš„å¹‚å‡½æ•°
- func Pow10(e int) float64 // 10 æ ¹çš„å¹‚å‡½æ•°
- func Sqrt(x float64) float64 // å¹³æ–¹æ ¹
- func Log(x float64) float64 // å¯¹æ•°å‡½æ•°
- func Log10(x float64) float64 // 10 ä¸ºåº•çš„å¯¹æ•°å‡½æ•°
- func Log2(x float64) float64  // 2 ä¸ºåº•çš„å¯¹æ•°å‡½æ•°
- func Log1p(x float64) float64 // log(1 + x)
- func Logb(x float64) float64 // ç›¸å½“äº log2(x) çš„ç»å¯¹å€¼
- func Ilogb(x float64) int // ç›¸å½“äº log2(x) çš„ç»å¯¹å€¼çš„æ•´æ•°éƒ¨åˆ†
- func Exp(x float64) float64 // æŒ‡æ•°å‡½æ•°
- func Exp2(x float64) float64 // 2 ä¸ºåº•çš„æŒ‡æ•°å‡½æ•°
- func Expm1(x float64) float64 // Exp(x) - 1
```

#### ç‰¹æ®Šå‡½æ•° ####

```go
- func Inf(sign int) float64  // æ­£æ— ç©·
- func IsInf(f float64, sign int) bool // æ˜¯å¦æ­£æ— ç©·
- func NaN() float64 // æ— ç©·å€¼
- func IsNaN(f float64) (is bool) // æ˜¯å¦æ˜¯æ— ç©·å€¼
- func Hypot(p, q float64) float64 // è®¡ç®—ç›´è§’ä¸‰è§’å½¢çš„æ–œè¾¹é•¿
```

#### ç±»å‹è½¬åŒ–å‡½æ•° ####

```go
- func Float32bits(f float32) uint32  // float32 å’Œ unit32 çš„è½¬æ¢
- func Float32frombits(b uint32) float32 // uint32 å’Œ float32 çš„è½¬æ¢
- func Float64bits(f float64) uint64 // float64 å’Œ uint64 çš„è½¬æ¢
- func Float64frombits(b uint64) float64 // uint64 å’Œ float64 çš„è½¬æ¢
```

#### å…¶ä»–å‡½æ•° ####

```go
- func Abs(x float64) float64 // ç»å¯¹å€¼å‡½æ•°
- func Ceil(x float64) float64  // å‘ä¸Šå–æ•´
- func Floor(x float64) float64 // å‘ä¸‹å–æ•´
- func Mod(x, y float64) float64 // å–æ¨¡
- func Modf(f float64) (int float64, frac float64) // åˆ†è§£ fï¼Œä»¥å¾—åˆ° f çš„æ•´æ•°å’Œå°æ•°éƒ¨åˆ†
- func Frexp(f float64) (frac float64, exp int) // åˆ†è§£ fï¼Œå¾—åˆ° f çš„ä½æ•°å’ŒæŒ‡æ•°
- func Max(x, y float64) float64  // å–å¤§å€¼
- func Min(x, y float64) float64  // å–å°å€¼
- func Dim(x, y float64) float64 // å¤æ•°çš„ç»´æ•°
- func J0(x float64) float64  // 0 é˜¶è´å¡å°”å‡½æ•°
- func J1(x float64) float64  // 1 é˜¶è´å¡å°”å‡½æ•°
- func Jn(n int, x float64) float64 // n é˜¶è´å¡å°”å‡½æ•°
- func Y0(x float64) float64  // ç¬¬äºŒç±»è´å¡å°”å‡½æ•° 0 é˜¶
- func Y1(x float64) float64  // ç¬¬äºŒç±»è´å¡å°”å‡½æ•° 1 é˜¶
- func Yn(n int, x float64) float64 // ç¬¬äºŒç±»è´å¡å°”å‡½æ•° n é˜¶
- func Erf(x float64) float64 // è¯¯å·®å‡½æ•°
- func Erfc(x float64) float64 // ä½™è¡¥è¯¯å·®å‡½æ•°
- func Copysign(x, y float64) float64 // ä»¥ y çš„ç¬¦å·è¿”å› x å€¼
- func Signbit(x float64) bool // è·å– x çš„ç¬¦å·
- func Gamma(x float64) float64 // ä¼½ç›å‡½æ•°
- func Lgamma(x float64) (lgamma float64, sign int) // ä¼½ç›å‡½æ•°çš„è‡ªç„¶å¯¹æ•°
- func Ldexp(frac float64, exp int) float64 // value ä¹˜ä»¥ 2 çš„ exp æ¬¡å¹‚
- func Nextafter(x, y float64) (r float64) // è¿”å›å‚æ•° x åœ¨å‚æ•° y æ–¹å‘ä¸Šå¯ä»¥è¡¨ç¤ºçš„æœ€æ¥è¿‘çš„æ•°å€¼ï¼Œè‹¥ x ç­‰äº yï¼Œåˆ™è¿”å› x
- func Nextafter32(x, y float32) (r float32) // è¿”å›å‚æ•° x åœ¨å‚æ•° y æ–¹å‘ä¸Šå¯ä»¥è¡¨ç¤ºçš„æœ€æ¥è¿‘çš„æ•°å€¼ï¼Œè‹¥ x ç­‰äº yï¼Œåˆ™è¿”å› x
- func Remainder(x, y float64) float64 // å–ä½™è¿ç®—
- func Trunc(x float64) float64 // æˆªå–å‡½æ•°
```

### 47.6 æ–‡ä»¶ç³»ç»Ÿ

Go çš„æ ‡å‡†åº“æä¾›äº†å¾ˆå¤šå·¥å…·ï¼Œå¯ä»¥å¤„ç†æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ã€æ„é€ å’Œè§£ææ–‡ä»¶åç­‰ã€‚

å¤„ç†æ–‡ä»¶çš„ç¬¬ä¸€æ­¥æ˜¯ç¡®å®šè¦å¤„ç†çš„æ–‡ä»¶çš„åå­—ã€‚Go å°†æ–‡ä»¶åè¡¨ç¤ºä¸ºç®€å•çš„å­—ç¬¦ä¸²ï¼Œæä¾›äº† `path`ã€`filepath` ç­‰åº“æ¥æ“ä½œæ–‡ä»¶åæˆ–è·¯å¾„ã€‚ç”¨ `os` ä¸­ `File` ç»“æ„çš„ `Readdir` å¯ä»¥åˆ—å‡ºä¸€ä¸ªç›®å½•ä¸­çš„å†…å®¹ã€‚

å¯ä»¥ç”¨ `os.Stat` æˆ– `os.Lstat` æ¥æ£€æŸ¥æ–‡ä»¶çš„ä¸€äº›ç‰¹æ€§ï¼Œå¦‚æƒé™ã€å¤§å°ç­‰ã€‚

æœ‰æ—¶éœ€è¦åˆ›å»ºè‰ç¨¿æ–‡ä»¶æ¥ä¿å­˜ä¸´æ—¶æ•°æ®ï¼Œæˆ–å°†æ•°æ®ç§»åŠ¨åˆ°ä¸€ä¸ªæ°¸ä¹…ä½ç½®ä¹‹å‰éœ€è¦ä¸´æ—¶æ–‡ä»¶å­˜å‚¨ï¼Œ`os.TempDir` å¯ä»¥è¿”å›é»˜è®¤çš„ä¸´æ—¶ç›®å½•ï¼Œç”¨äºå­˜æ”¾ä¸´æ—¶æ–‡ä»¶ã€‚å…³äºä¸´æ—¶æ–‡ä»¶ï¼Œåœ¨ `ioutil` ä¸­å·²ç»è®²è§£äº†ã€‚

`os` åŒ…è¿˜åŒ…å«äº†å¾ˆå¤šå…¶ä»–æ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„æ“ä½œï¼Œæ¯”å¦‚åˆ›å»ºç›®å½•ã€é‡å‘½åã€ç§»åŠ¨æ–‡ä»¶ç­‰ç­‰ã€‚

> `os` åŒ…ä¸­è¿˜æœ‰å…³äºè¿›ç¨‹ç›¸å…³çŸ¥è¯†ã€‚

#### `os` â€” å¹³å°æ— å…³çš„æ“ä½œç³»ç»ŸåŠŸèƒ½å®ç°

`os` åŒ…æä¾›äº†å¹³å°æ— å…³çš„æ“ä½œç³»ç»ŸåŠŸèƒ½æ¥å£ã€‚å°½ç®¡é”™è¯¯å¤„ç†æ˜¯ go é£æ ¼çš„ï¼Œä½†è®¾è®¡æ˜¯ Unix é£æ ¼çš„ï¼›æ‰€ä»¥ï¼Œå¤±è´¥çš„è°ƒç”¨ä¼šè¿”å› `error` è€Œéé”™è¯¯ç ã€‚é€šå¸¸ `error` é‡Œä¼šåŒ…å«æ›´å¤šä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½¿ç”¨ä¸€ä¸ªæ–‡ä»¶åçš„è°ƒç”¨ï¼ˆå¦‚ Openã€Statï¼‰å¤±è´¥äº†ï¼Œæ‰“å°é”™è¯¯æ—¶ä¼šåŒ…å«è¯¥æ–‡ä»¶åï¼Œé”™è¯¯ç±»å‹å°†ä¸º `*PathError`ï¼Œå…¶å†…éƒ¨å¯ä»¥è§£åŒ…è·å¾—æ›´å¤šä¿¡æ¯ã€‚

os åŒ…è§„å®šä¸ºæ‰€æœ‰æ“ä½œç³»ç»Ÿå®ç°çš„æ¥å£éƒ½æ˜¯ä¸€è‡´çš„ã€‚æœ‰ä¸€äº›æŸä¸ªç³»ç»Ÿç‰¹å®šçš„åŠŸèƒ½ï¼Œéœ€è¦ä½¿ç”¨ `syscall` è·å–ã€‚å®é™…ä¸Šï¼Œ`os` ä¾èµ–äº `syscall`ã€‚åœ¨å®é™…ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥æ€»æ˜¯ä¼˜å…ˆä½¿ç”¨ `os` ä¸­æä¾›çš„åŠŸèƒ½ï¼Œè€Œä¸æ˜¯ `syscall`ã€‚



#### `path/filepath` â€” å…¼å®¹æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶è·¯å¾„æ“ä½œ

##### è§£æè·¯å¾„åå­—ç¬¦ä¸²



##### ç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„



##### è·¯å¾„çš„åˆ‡åˆ†å’Œæ‹¼æ¥



##### è§„æ•´åŒ–è·¯å¾„



##### ç¬¦å·é“¾æ¥æŒ‡å‘çš„è·¯å¾„å



##### æ–‡ä»¶è·¯å¾„åŒ¹é…



##### éå†ç›®å½•



##### Windows èµ·ä½œç”¨çš„å‡½æ•°



##### å…³äº path åŒ…



#### io/fs â€” æŠ½è±¡æ–‡ä»¶ç³»ç»Ÿ

Go è¯­è¨€ä» 1.16 å¼€å§‹å¢åŠ äº† io/fs åŒ…ï¼Œè¯¥åŒ…å®šä¹‰äº†ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿéœ€è¦çš„ç›¸å…³åŸºç¡€æ¥å£ï¼Œå› æ­¤æˆ‘ä»¬ç§°ä¹‹ä¸ºæŠ½è±¡æ–‡ä»¶ç³»ç»Ÿã€‚è¯¥æ–‡ä»¶ç³»ç»Ÿæ˜¯å±‚çº§æ–‡ä»¶ç³»ç»Ÿæˆ–å«æ ‘å½¢æ–‡ä»¶ç³»ç»Ÿï¼ŒUnix æ–‡ä»¶ç³»ç»Ÿå°±æ˜¯è¿™ç§ç±»å‹ã€‚



### 47.7 æ•°æ®æŒä¹…å­˜å‚¨ä¸äº¤æ¢

ç°ä»£ç¨‹åºç¦»ä¸å¼€æ•°æ®å­˜å‚¨ï¼Œç°é˜¶æ®µå¾ˆçƒ­çš„æ‰€è°“å¤§æ•°æ®å¤„ç†ã€äº‘ç›˜ç­‰ï¼Œæ›´æ˜¯ä»¥å­˜å‚¨ä¸ºä¾æ‰˜ã€‚æœ‰æ•°æ®å­˜å‚¨ï¼Œè‡ªç„¶éœ€è¦è¿›è¡Œæ•°æ®äº¤æ¢ï¼Œå·²è¾¾åˆ°æ•°æ®å…±äº«ç­‰ç›®çš„ã€‚

å…³ç³»å‹æ•°æ®åº“å‘å±•äº†å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼ŒSQL/SQL-like å·²ç»å¾ˆæˆç†Ÿï¼Œä½¿ç”¨ä¹Ÿå¾ˆå¹¿æ³›ï¼ŒGo è¯­è¨€æ ‡å‡†åº“æä¾›äº†å¯¹ SQL/SQL-like æ•°æ®åº“çš„æ“ä½œçš„æ ‡å‡†æ¥å£ï¼Œå³ [database/sql](http://docs.studygolang.com/pkg/database/sql) åŒ…ã€‚

åœ¨æ•°æ®äº¤æ¢æ–¹é¢ï¼Œæœ‰å¾ˆå¤šæˆç†Ÿçš„åè®®å¯ä»¥ä½¿ç”¨ï¼Œå¸¸ç”¨çš„æœ‰ï¼šJSONã€XML ç­‰ï¼Œä¼¼ä¹ Java ç¤¾åŒºæ›´å–œæ¬¢ XMLï¼Œè€Œç›®å‰ä¼¼ä¹ä½¿ç”¨æ›´å¤šçš„æ˜¯ JSONã€‚åœ¨äº¤æ¢åè®®é€‰æ‹©æ–¹é¢ï¼Œè€ƒè™‘çš„ä¸»è¦è¿™å‡ ä¸ªæ–¹é¢å› ç´ ï¼šæ€§èƒ½ã€è·¨è¯­è¨€ï¼ˆé€šç”¨æ€§ï¼‰ã€ä¼ è¾“é‡ç­‰ã€‚å› æ­¤ï¼Œå¯¹äºæ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯ï¼Œä¼šä½¿ç”¨ protobufã€msgpack ä¹‹ç±»çš„åè®®ã€‚ç”±äº JSON å’Œ XML ä½¿ç”¨å¾ˆå¹¿æ³›ï¼ŒGo è¯­è¨€æä¾›äº†è§£æå®ƒä»¬çš„æ ‡å‡†åº“ï¼›åŒæ—¶ï¼Œä¸ºäº†æ–¹ä¾¿ Go ç¨‹åºç›´æ¥æ•°æ®äº¤æ¢ï¼ŒGo ä¸“é—¨æä¾›äº† [gob](http://docs.studygolang.com/pkg/) è¿™ç§äº¤æ¢åè®®ã€‚

#### `database/sql` â€” SQL/SQL-Like æ•°æ®åº“æ“ä½œæ¥å£





#### `encoding/csv` â€” é€—å·åˆ†éš”å€¼æ–‡ä»¶



### 47.8 æ•°æ®å‹ç¼©ä¸å½’æ¡£







---



### 47.3 flagåŒ…

```go
func main() {
	if len(os.Args) > 0 {
		for index, arg := range os.Args {
			fmt.Printf("args[%d]=%v\n", index, arg)
		}
	}
}
```

```
./flag1 a b c d
args[0]=./flag1
args[1]=a
args[2]=b
args[3]=c
args[4]=d
```

#### flagå‚æ•°ç±»å‹

flagåŒ…æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°ç±»å‹æœ‰boolã€intã€int64ã€uintã€uint64ã€float float64ã€stringã€durationã€‚

| flagå‚æ•°     | æœ‰æ•ˆå€¼                                                       |
| ------------ | ------------------------------------------------------------ |
| å­—ç¬¦ä¸²flag   | åˆæ³•å­—ç¬¦ä¸²                                                   |
| æ•´æ•°flag     | 1234ã€0664ã€0x1234ç­‰ç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯è´Ÿæ•°ã€‚                     |
| æµ®ç‚¹æ•°flag   | åˆæ³•æµ®ç‚¹æ•°                                                   |
| boolç±»å‹flag | 1, 0, t, f, T, F, true, false, TRUE, FALSE, True, Falseã€‚    |
| æ—¶é—´æ®µflag   | ä»»ä½•åˆæ³•çš„æ—¶é—´æ®µå­—ç¬¦ä¸²ã€‚å¦‚â€300msâ€ã€â€-1.5hâ€ã€â€2h45mâ€ã€‚ åˆæ³•çš„å•ä½æœ‰â€nsâ€ã€â€usâ€ /â€œÂµsâ€ã€â€msâ€ã€â€sâ€ã€â€mâ€ã€â€hâ€ã€‚ |

#### ä¸¤ç§å®šä¹‰å‘½ä»¤è¡Œflagå‚æ•°çš„æ–¹æ³•

##### flag.Type()

`flag.Type(flagå, é»˜è®¤å€¼, å¸®åŠ©ä¿¡æ¯)*Type`

```go
name := flag.String("name", "å¼ ä¸‰", "å§“å")
age := flag.Int("age", 18, "å¹´é¾„")
married := flag.Bool("married", false, "å©šå¦")
delay := flag.Duration("d", 0, "æ—¶é—´é—´éš”")
```

æ­¤æ—¶nameã€ageã€marriedã€delayå‡ä¸ºå¯¹åº”ç±»å‹çš„æŒ‡é’ˆã€‚

##### flag.TypeVar()

`flag.TypeVar(TypeæŒ‡é’ˆ, flagå, é»˜è®¤å€¼, å¸®åŠ©ä¿¡æ¯)`

```go
var name string
var age int
var married bool
var delay time.Duration
flag.StringVar(&name, "name", "å¼ ä¸‰", "å§“å")
flag.IntVar(&age, "age", 18, "å¹´é¾„")
flag.BoolVar(&married, "married", false, "å©šå¦")
flag.DurationVar(&delay, "d", 0, "æ—¶é—´é—´éš”")
```



#### å…¶ä»–å‡½æ•°

##### flag.Parse()

å®šä¹‰å¥½å‘½ä»¤è¡Œflagå‚æ•°åï¼Œéœ€è¦é€šè¿‡è°ƒç”¨flag.Parse()æ¥å¯¹å‘½ä»¤è¡Œå‚æ•°è¿›è¡Œè§£æã€‚

æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°æ ¼å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š

- -flag xxx ï¼ˆä½¿ç”¨ç©ºæ ¼ï¼Œä¸€ä¸ª-ç¬¦å·ï¼‰
- --flag xxx ï¼ˆä½¿ç”¨ç©ºæ ¼ï¼Œä¸¤ä¸ª-ç¬¦å·ï¼‰
- -flag=xxx ï¼ˆä½¿ç”¨ç­‰å·ï¼Œä¸€ä¸ª-ç¬¦å·ï¼‰
- --flag=xxx ï¼ˆä½¿ç”¨ç­‰å·ï¼Œä¸¤ä¸ª-ç¬¦å·ï¼‰

å…¶ä¸­ï¼Œå¸ƒå°”ç±»å‹çš„å‚æ•°å¿…é¡»ä½¿ç”¨ç­‰å·çš„æ–¹å¼æŒ‡å®šã€‚

Flagè§£æåœ¨ç¬¬ä¸€ä¸ªéflagå‚æ•°ï¼ˆå•ä¸ªâ€-â€œä¸æ˜¯flagå‚æ•°ï¼‰ä¹‹å‰åœæ­¢ï¼Œæˆ–è€…åœ¨ç»ˆæ­¢ç¬¦â€â€“â€œä¹‹ååœæ­¢ã€‚



- flag.Args() ////è¿”å›å‘½ä»¤è¡Œå‚æ•°åçš„å…¶ä»–å‚æ•°ï¼Œä»¥[]stringç±»å‹
- flag.NArg() //è¿”å›å‘½ä»¤è¡Œå‚æ•°åçš„å…¶ä»–å‚æ•°ä¸ªæ•°
- flag.NFlag() //è¿”å›ä½¿ç”¨çš„å‘½ä»¤è¡Œå‚æ•°ä¸ªæ•°

#### ä½¿ç”¨æ¡ˆä¾‹

```go
func main() {
	// //å®šä¹‰å‘½ä»¤è¡Œå‚æ•°æ–¹å¼
	var name string
	var age int
	var married bool
	var delay time.Duration
	flag.StringVar(&name, "name", "andyron", "å§“å")
	flag.IntVar(&age, "age", 18, "å¹´é¾„")
	flag.BoolVar(&married, "married", false, "å©šå¦")
	flag.DurationVar(&delay, "d", 0, "å»¶è¿Ÿçš„æ—¶é—´é—´éš”")

	// è§£æå‘½ä»¤è¡Œå‚æ•°
	flag.Parse()
	fmt.Println(name, age, married, delay)
	// è¿”å›å‘½ä»¤è¡Œå‚æ•°åçš„å…¶ä»–å‚æ•°
	fmt.Println(flag.Args())
	// è¿”å›å‘½ä»¤è¡Œå‚æ•°åçš„å…¶ä»–å‚æ•°ä¸ªæ•°
	fmt.Println(flag.NArg())
	// è¿”å›ä½¿ç”¨çš„å‘½ä»¤è¡Œå‚æ•°ä¸ªæ•°
	fmt.Println(flag.NFlag())
}
```



å‘½ä»¤è¡Œå‚æ•°ä½¿ç”¨æç¤ºï¼š

```shell
./flag_demo -help
Usage of ./flag_demo:
  -age int
        å¹´é¾„ (default 18)
  -d duration
        å»¶è¿Ÿçš„æ—¶é—´é—´éš”
  -married
        å©šå¦
  -name string
        å§“å (default "andyron")
```

æ­£å¸¸ä½¿ç”¨å‘½ä»¤è¡Œflagå‚æ•°ï¼š

```shell
$ ./flag_demo -name pprof -age 19 -married=false -d=24s
pprof 19 false 24s
[]
0
4
```

ä½¿ç”¨éflagå‘½ä»¤è¡Œå‚æ•°ï¼š

```shell
$ ./flag_demo a c d
andyron 18 false 0s
[a c d]
3
0
```



### 47.4 stringsåŒ…â€”â€”å­—ç¬¦ä¸²å¤„ç†



#### æ£€ç´¢å­—ç¬¦ä¸²

![](images/image-20250102222004211.png)

#### åˆ†å‰²å­—ç¬¦ä¸²

![](images/image-20250102222415128.png)



#### å¤§å°å†™è½¬æ¢

![](images/image-20250102222439824.png)

#### ä¿®å‰ªå­—ç¬¦ä¸²

![](images/image-20250102222522187.png)

#### æ¯”è¾ƒå­—ç¬¦ä¸²

![](images/image-20250102222556733.png)





### 47.5 strconvåŒ…

å­—ç¬¦ä¸²ä¸å…¶ä»–åŸºæœ¬æ•°æ®ç±»å‹ä¹‹é—´çš„ç±»å‹è½¬æ¢ã€‚

#### Parseç±»å‡½æ•°

Parseç±»å‡½æ•°ä¸»è¦çš„åŠŸèƒ½æ˜¯å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå…¶ä»–ç±»å‹ã€‚

![](images/image-20250102222737543.png)



#### Formatç±»å‡½æ•°

Formatç±»å‡½æ•°ä¸»è¦çš„åŠŸèƒ½æ˜¯å°†å…¶ä»–ç±»å‹æ ¼å¼åŒ–æˆå­—ç¬¦ä¸²ã€‚

![](images/image-20250102224530130.png)





### 47.6 regexpæ­£åˆ™è¡¨è¾¾å¼åŒ…

#### æ­£åˆ™è¡¨è¾¾å¼ä¸­ä¸»è¦å…ƒå­—ç¬¦

![](images/epub_28438052_403.jpeg)

#### regexpåŒ…ä¸­æ ¸å¿ƒå‡½æ•°åŠæ–¹æ³•

ğŸ”–







### 47.8 éšæœºæ•°

â€œmath/randâ€åŒ…å®ç°äº†ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼Œèƒ½å¤Ÿç”Ÿæˆæ•´å‹å’Œæµ®ç‚¹å‹çš„éšæœºæ•°ã€‚ä½¿ç”¨éšæœºæ•°ç”Ÿæˆå™¨éœ€è¦æ”¾å…¥ç§å­ã€‚å¯ä»¥ä½¿ç”¨Seed()å‡½æ•°ç”Ÿæˆä¸€ä¸ªä¸ç¡®å®šçš„ç§å­æ”¾å…¥éšæœºæ•°ç”Ÿæˆå™¨ï¼Œè¿™æ ·æ¯æ¬¡è¿è¡Œéšæœºæ•°ç”Ÿæˆå™¨éƒ½ä¼šç”Ÿæˆä¸åŒçš„åºåˆ—ã€‚å¦‚æœæ²¡æœ‰åœ¨éšæœºæ•°ç”Ÿæˆå™¨ä¸­æ”¾å…¥ç§å­ï¼Œåˆ™é»˜è®¤ä½¿ç”¨å…·æœ‰ç¡®å®šæ€§çŠ¶æ€çš„ç§å­ï¼Œæ­¤æ—¶å¯ä»¥ç†è§£ä¸ºç§å­çš„å€¼æ˜¯ä¸€ä¸ªå¸¸æ•°1ï¼Œå³Seed(1)ã€‚

#### randåŒ…çš„æ ¸å¿ƒæ–¹æ³•

![](images/image-20250102225648425.png)

#### è·å–éšæœºæ•°çš„å‡ ç§æ–¹å¼



### 47.9 log



å…¶å®ƒ

`log/slog`

ç¬¬ä¸‰æ–¹æ—¥å¿—åº“

[zap](https://github.com/uber-go/zap)

[logrus](https://github.com/appleboy/gorush)

https://github.com/rs/zerolog



### netåŒ…

net/http



### æ–‡ä»¶æ“ä½œç›¸å…³

osåŒ…

io/ioutil åŒ…



### å¹¶å‘ç›¸å…³

**`sync` åŒ…**

**`context` åŒ…**





### æ•°æ®ç»“æ„ä¸ç®—æ³•ç›¸å…³

**`sort` åŒ…**

**`container` ç›®å½•ä¸‹çš„ç›¸å…³åŒ…ï¼ˆå¦‚ `list`ã€`map`ã€`heap` ç­‰ï¼‰**





### template



### encoding

æ•°æ®æ ¼å¼ï¼šJSONã€XMLã€MSGPackç­‰



### reflectåå°„



## 48 åå°„

å‚è€ƒï¼šã€ŠGoè¯­è¨€ä»å…¥é—¨åˆ°é¡¹ç›®å®æˆ˜ã€‹-10

åå°„æ˜¯æŒ‡åœ¨ç¨‹åºè¿è¡ŒæœŸå¯¹ç¨‹åºæœ¬èº«è¿›è¡Œè®¿é—®å’Œä¿®æ”¹çš„èƒ½åŠ›ã€‚ç¨‹åºåœ¨ç¼–è¯‘æ—¶ï¼Œå˜é‡è¢«è½¬æ¢ä¸ºå†…å­˜åœ°å€ï¼Œå˜é‡åä¸ä¼šè¢«ç¼–è¯‘å™¨å†™å…¥å¯æ‰§è¡Œéƒ¨åˆ†ã€‚åœ¨è¿è¡Œç¨‹åºæ—¶ï¼Œç¨‹åºæ— æ³•è·å–è‡ªèº«çš„ä¿¡æ¯ã€‚

æ”¯æŒåå°„çš„è¯­è¨€å¯ä»¥åœ¨ç¨‹åºç¼–è¯‘æœŸå°†å˜é‡çš„åå°„ä¿¡æ¯ï¼Œå¦‚å­—æ®µåç§°ã€ç±»å‹ä¿¡æ¯ã€ç»“æ„ä½“ä¿¡æ¯ç­‰æ•´åˆåˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå¹¶ç»™ç¨‹åºæä¾›æ¥å£è®¿é—®åå°„ä¿¡æ¯ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ç¨‹åºè¿è¡ŒæœŸè·å–ç±»å‹çš„åå°„ä¿¡æ¯ï¼Œå¹¶ä¸”æœ‰èƒ½åŠ›ä¿®æ”¹å®ƒä»¬ã€‚

Goè¯­è¨€ç¨‹åºåœ¨è¿è¡ŒæœŸä½¿ç”¨reflectåŒ…è®¿é—®ç¨‹åºçš„åå°„ä¿¡æ¯ã€‚

### 48.1ã€€ä½¿ç”¨åå°„è®¿é—®å˜é‡

`reflect`åŒ…

#### è·å–å˜é‡çš„ç±»å‹

#### è·å–å˜é‡çš„å€¼

#### åå°„å€¼çš„éç©ºå’Œæœ‰æ•ˆæ€§åˆ¤å®š



### 48.2 åå°„å€¼çš„éç©ºå’Œæœ‰æ•ˆæ€§åˆ¤å®š



### 48.3 ä½¿ç”¨åå°„è®¿é—®ç»“æ„ä½“



### 48.4 ä½¿ç”¨åå°„ä¿®æ”¹å€¼



### 48.5 ä½¿ç”¨åå°„è°ƒç”¨å‡½æ•°



### 48.6 ä½¿ç”¨åå°„åˆ›å»ºå˜é‡



## 48-2 åå°„2

refï¼š[Goè¯­è¨€ç²¾è¿›ä¹‹è·¯2](https://book.douban.com/subject/35720729/) 59æ¡

åå°„æ˜¯ç¨‹åºåœ¨è¿è¡Œæ—¶è®¿é—®ã€æ£€æµ‹å’Œä¿®æ”¹å®ƒæœ¬èº«çŠ¶æ€æˆ–è¡Œä¸ºçš„ä¸€ç§èƒ½åŠ›ï¼Œå„ç§ç¼–ç¨‹è¯­è¨€æ‰€å®ç°çš„åå°„æœºåˆ¶å„æœ‰ä¸åŒã€‚

Goè¯­è¨€çš„`interface{}`ç±»å‹å˜é‡å…·æœ‰æå‡ºä»»æ„ç±»å‹å˜é‡çš„ç±»å‹ä¿¡æ¯ï¼ˆtypeï¼‰å’Œå€¼ä¿¡æ¯ï¼ˆvalueï¼‰çš„èƒ½åŠ›ï¼ŒGoçš„åå°„æœ¬è´¨ä¸Šå°±æ˜¯**åˆ©ç”¨interface{}çš„è¿™ç§èƒ½åŠ›åœ¨è¿è¡Œæ—¶å¯¹ä»»æ„å˜é‡çš„==ç±»å‹å’Œå€¼ä¿¡æ¯==è¿›è¡Œæ£€è§†ç”šè‡³æ˜¯å¯¹å€¼è¿›è¡Œä¿®æ”¹çš„æœºåˆ¶**ã€‚

### 1 Goåå°„çš„ä¸‰å¤§æ³•åˆ™

åå°„è®©é™æ€ç±»å‹è¯­è¨€Goåœ¨è¿è¡Œæ—¶å…·å¤‡äº†æŸç§åŸºäºç±»å‹ä¿¡æ¯çš„**åŠ¨æ€ç‰¹æ€§**ã€‚

åˆ©ç”¨è¿™ç§ç‰¹æ€§ï¼Œfmt.Printlnåœ¨æ— æ³•æå‰è·çŸ¥ä¼ å…¥å‚æ•°çš„çœŸæ­£ç±»å‹çš„æƒ…å†µä¸‹ä¾æ—§å¯ä»¥å¯¹å…¶è¿›è¡Œæ­£ç¡®çš„æ ¼å¼åŒ–è¾“å‡ºï¼›

json.Marshalä¹Ÿæ˜¯é€šè¿‡è¿™ç§ç‰¹æ€§å¯¹ä¼ å…¥çš„ä»»æ„ç»“æ„ä½“ç±»å‹è¿›è¡Œè§£æ„å¹¶æ­£ç¡®ç”Ÿæˆå¯¹åº”çš„JSONæ–‡æœ¬ã€‚

é€šè¿‡ä¸€ä¸ªç®€å•çš„æ„å»ºSQLæŸ¥è¯¢è¯­å¥çš„ä¾‹å­æ¥ç›´è§‚æ„Ÿå—Goåå°„çš„â€œé­”æ³•â€:

```go
func main() {
	stmt, err := ConstructQueryStmt(&Product{})
	if err != nil {
		fmt.Println("construct query stmt for Product error: ", err)
		return
	}
	fmt.Println(stmt)

	stmt, err = ConstructQueryStmt(Person{})
	if err != nil {
		fmt.Println("construct query stmt for Person error: ", err)
		return
	}
	fmt.Println(stmt)
}

// ConstructQueryStmt å‚æ•°æ˜¯ç»“æ„ä½“å®ä¾‹ï¼Œå¾—åˆ°çš„æ˜¯è¯¥ç»“æ„ä½“å¯¹åº”çš„è¡¨çš„æ•°æ®æŸ¥è¯¢è¯­å¥æ–‡æœ¬
// é‡‡ç”¨äº†ä¸€ç§ORMï¼ˆObject Relational Mappingï¼Œå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰é£æ ¼çš„å®ç°ã€‚
// ConstructQueryStmté€šè¿‡åå°„è·å¾—ä¼ å…¥çš„å‚æ•°objçš„ç±»å‹ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼ˆå¯¼å‡ºï¼‰å­—æ®µæ•°é‡ã€å­—æ®µåã€å­—æ®µæ ‡ç­¾å€¼ç­‰ï¼Œå¹¶æ ¹æ®è¿™äº›ç±»å‹ä¿¡æ¯ç”ŸæˆSQLæŸ¥è¯¢è¯­å¥æ–‡æœ¬ã€‚å¦‚æœç»“æ„ä½“å­—æ®µå¸¦æœ‰ormæ ‡ç­¾ï¼Œè¯¥å‡½æ•°ä¼šä½¿ç”¨æ ‡ç­¾å€¼æ›¿ä»£é»˜è®¤åˆ—åï¼ˆå­—æ®µåï¼‰ã€‚
func ConstructQueryStmt(obj any) (stmt string, err error) {
	// ä»…æ”¯æŒstructæˆ–structæŒ‡é’ˆç±»å‹
	typ := reflect.TypeOf(obj)
	if typ.Kind() == reflect.Ptr {
		typ = typ.Elem()
	}
	if typ.Kind() != reflect.Struct {
		err = errors.New("only struct is supported")
		return
	}

	buffer := bytes.NewBufferString("")
	buffer.WriteString("SELECT ")

	if typ.NumField() == 0 {
		fmt.Errorf("the type[%s] has no fields", typ.Name())
		return
	}

	for i := 0; i < typ.NumField(); i++ {
		field := typ.Field(i)

		if i != 0 {
			buffer.WriteString(", ")
		}
		column := field.Name
		if tag := field.Tag.Get("orm"); tag != "" {
			column = tag
		}

		buffer.WriteString(column)
	}

	stmt = fmt.Sprintf("%s FROM %s", buffer.String(), typ.Name())
	return
}

type Product struct {
	ID        uint32
	Name      string
	Price     uint32
	LeftCount uint32 `orm:"left_count"`
	Batch     string `orm:"batch_number"`
	Updated   time.Time
}

type Person struct {
	ID      string
	Name    string
	Age     uint32
	Gender  string
	Addr    string `orm:"address"`
	Updated time.Time
}
```

Goåå°„ååˆ†é€‚åˆå¤„ç†è¿™ä¸€ç±»é—®é¢˜ï¼Œå…¸å‹ç‰¹ç‚¹ï¼š

- è¾“å…¥å‚æ•°çš„ç±»å‹æ— æ³•æå‰ç¡®å®šï¼›
- å‡½æ•°æˆ–æ–¹æ³•çš„å¤„ç†ç»“æœå› ä¼ å…¥å‚æ•°ï¼ˆçš„ç±»å‹ä¿¡æ¯å’Œå€¼ä¿¡æ¯ï¼‰çš„ä¸åŒè€Œå¼‚ã€‚

åå°„åœ¨å¸¦æ¥å¼ºå¤§åŠŸèƒ½çš„åŒæ—¶ï¼Œä¹Ÿæ˜¯å¾ˆå¤šå›°æ‰°ä½ çš„é—®é¢˜çš„æ ¹æºï¼Œæ¯”å¦‚ï¼š

- åå°„è®©ä½ çš„ä»£ç é€»è¾‘çœ‹èµ·æ¥ä¸é‚£ä¹ˆæ¸…æ™°ï¼Œéš¾äºç†è§£ï¼›
- åå°„è®©ä½ çš„ä»£ç è¿è¡Œå¾—æ›´æ…¢ï¼›
- åœ¨ç¼–è¯‘é˜¶æ®µï¼Œç¼–è¯‘å™¨æ— æ³•æ£€æµ‹åˆ°ä½¿ç”¨åå°„çš„ä»£ç ä¸­çš„é—®é¢˜ï¼ˆè¿™ç§é—®é¢˜åªèƒ½åœ¨Goç¨‹åºè¿è¡Œæ—¶æš´éœ²å‡ºæ¥ï¼Œå¹¶ä¸”ä¸€æ—¦æš´éœ²ï¼Œå¾ˆå¤§å¯èƒ½ä¼šå¯¼è‡´è¿è¡Œæ—¶çš„panicï¼‰ã€‚

Rob Pikeè¿˜ä¸ºGoåå°„çš„è§„èŒƒä½¿ç”¨å®šä¹‰äº†ä¸‰å¤§æ³•åˆ™ï¼Œå¦‚æœç»è¿‡è¯„ä¼°ï¼Œä½ å¿…é¡»ä½¿ç”¨åå°„æ‰èƒ½å®ç°ä½ è¦çš„åŠŸèƒ½ç‰¹æ€§ï¼Œé‚£ä¹ˆä½ åœ¨ä½¿ç”¨åå°„æ—¶éœ€è¦ç‰¢è®°è¿™ä¸‰æ¡æ³•åˆ™ã€‚

- åå°„ä¸–ç•Œçš„å…¥å£ï¼šç»ç”±æ¥å£ï¼ˆinterface{}ï¼‰ç±»å‹å˜é‡å€¼è¿›å…¥åå°„çš„ä¸–ç•Œå¹¶è·å¾—å¯¹åº”çš„åå°„å¯¹è±¡ï¼ˆreflect.Valueæˆ–reflect.Typeï¼‰ã€‚
- åå°„ä¸–ç•Œçš„å‡ºå£ï¼šåå°„å¯¹è±¡ï¼ˆreflect.Valueï¼‰é€šè¿‡åŒ–èº«ä¸ºä¸€ä¸ªæ¥å£ï¼ˆinterface{}ï¼‰ç±»å‹å˜é‡å€¼çš„å½¢å¼èµ°å‡ºåå°„ä¸–ç•Œã€‚
- ä¿®æ”¹åå°„å¯¹è±¡çš„å‰æï¼šåå°„å¯¹è±¡å¯¹åº”çš„reflect.Valueå¿…é¡»æ˜¯å¯è®¾ç½®çš„ï¼ˆ**Settable**ï¼‰ã€‚

å‰ä¸¤æ¡æ³•åˆ™å¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºï¼š

![](images/image-20250717150431598.png)

### 2 åå°„ä¸–ç•Œçš„å…¥å£

`reflect.TypeOf`å’Œ`reflect.ValueOf`æ˜¯è¿›å…¥åå°„ä¸–ç•Œä»…æœ‰çš„ä¸¤æ‰‡â€œå¤§é—¨â€ã€‚

é€šè¿‡reflect.TypeOfè¿™æ‰‡â€œé—¨â€è¿›å…¥åå°„ä¸–ç•Œï¼Œä½ å°†å¾—åˆ°ä¸€ä¸ªreflect.Typeå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸­åŒ…å«äº†è¢«åå°„çš„Goå˜é‡å®ä¾‹çš„**æ‰€æœ‰ç±»å‹ä¿¡æ¯**ï¼›

è€Œé€šè¿‡reflect.ValueOfè¿™æ‰‡â€œé—¨â€è¿›å…¥åå°„ä¸–ç•Œï¼Œä½ å°†å¾—åˆ°ä¸€ä¸ªreflect.Valueå¯¹è±¡ã€‚**`Value`å¯¹è±¡æ˜¯åå°„ä¸–ç•Œçš„æ ¸å¿ƒ**ï¼Œä¸ä»…è¯¥å¯¹è±¡ä¸­åŒ…å«äº†è¢«åå°„çš„Goå˜é‡å®ä¾‹çš„å€¼ä¿¡æ¯ï¼Œè€Œä¸”é€šè¿‡è°ƒç”¨è¯¥å¯¹è±¡çš„Typeæ–¹æ³•ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¾—åˆ°Goå˜é‡å®ä¾‹çš„ç±»å‹ä¿¡æ¯ï¼Œè¿™ä¸é€šè¿‡reflect.TypeOfè·å¾—ç±»å‹ä¿¡æ¯æ˜¯ç­‰ä»·çš„ï¼š

```go
// reflect.ValueOf().Type()ç­‰ä»·äºreflect.TypeOf()ï¿¼
var i int = 5ï¿¼
val := reflect.ValueOf(i)ï¿¼
typ := reflect.TypeOf(i)ï¿¼
fmt.Println(reflect.DeepEqual(typ, val.Type())) // true
```



### 3 åå°„ä¸–ç•Œçš„å‡ºå£

reflect.Value.Interface()æ˜¯reflect.ValueOf()çš„é€†è¿‡ç¨‹ï¼Œé€šè¿‡Interfaceæ–¹æ³•æˆ‘ä»¬å¯ä»¥å°†reflect.Valueå¯¹è±¡æ¢å¤æˆä¸€ä¸ªinterface{}ç±»å‹çš„å˜é‡å€¼ã€‚è¿™ä¸ªç¦»å¼€åå°„ä¸–ç•Œçš„è¿‡ç¨‹å®è´¨æ˜¯å°†reflect.Valueä¸­çš„ç±»å‹ä¿¡æ¯å’Œå€¼ä¿¡æ¯é‡æ–°æ‰“åŒ…æˆä¸€ä¸ªinterface{}çš„å†…éƒ¨è¡¨ç¤ºã€‚ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç±»å‹æ–­è¨€å¾—åˆ°ä¸€ä¸ªåå°„å‰çš„ç±»å‹å˜é‡å€¼



### 4 è¾“å‡ºå‚æ•°ã€interface{}ç±»å‹å˜é‡åŠåå°„å¯¹è±¡çš„å¯è®¾ç½®æ€§

reflect.Valueæä¾›äº†CanSetã€CanAddråŠCanInterfaceç­‰æ–¹æ³•æ¥å¸®åŠ©æˆ‘ä»¬åˆ¤æ–­åå°„å¯¹è±¡æ˜¯å¦å¯è®¾ç½®ï¼ˆSettableï¼‰ã€å¯å¯»å€ã€å¯æ¢å¤ä¸ºä¸€ä¸ªinterface{}ç±»å‹å˜é‡ã€‚



- å½“è¢«åå°„å¯¹è±¡ä»¥å€¼ç±»å‹ï¼ˆTï¼‰ä¼ é€’ç»™reflect.ValueOfæ—¶ï¼Œæ‰€å¾—åˆ°çš„åå°„å¯¹è±¡ï¼ˆValueï¼‰æ˜¯ä¸å¯è®¾ç½®å’Œä¸å¯å¯»å€çš„ã€‚
- å½“è¢«åå°„å¯¹è±¡ä»¥æŒ‡é’ˆç±»å‹ï¼ˆ`*T`æˆ–`&T`ï¼‰ä¼ é€’ç»™reflect.ValueOfæ—¶ï¼Œé€šè¿‡reflect.Valueçš„Elemæ–¹æ³•å¯ä»¥å¾—åˆ°ä»£è¡¨è¯¥æŒ‡é’ˆæ‰€æŒ‡å†…å­˜å¯¹è±¡çš„Valueåå°„å¯¹è±¡ã€‚è€Œè¿™ä¸ªåå°„å¯¹è±¡æ˜¯å¯è®¾ç½®å’Œå¯å¯»å€çš„ï¼Œå¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼ˆæ¯”å¦‚åˆ©ç”¨Valueçš„SetIntæ–¹æ³•ï¼‰å°†ä¼šåƒå‡½æ•°çš„è¾“å‡ºå‚æ•°é‚£æ ·ç›´æ¥ä¿®æ”¹è¢«åå°„å¯¹è±¡æ‰€æŒ‡å‘çš„å†…å­˜ç©ºé—´çš„å€¼ã€‚
- å½“ä¼ å…¥ç»“æ„ä½“æˆ–æ•°ç»„æŒ‡é’ˆæ—¶ï¼Œé€šè¿‡Fieldæˆ–Indexæ–¹æ³•å¾—åˆ°çš„ä»£è¡¨ç»“æ„ä½“å­—æ®µæˆ–æ•°ç»„å…ƒç´ çš„Valueåå°„å¯¹è±¡ä¹Ÿæ˜¯å¯è®¾ç½®å’Œå¯å¯»å€çš„ã€‚å¦‚æœç»“æ„ä½“ä¸­æŸä¸ªå­—æ®µæ˜¯éå¯¼å‡ºå­—æ®µï¼Œåˆ™è¯¥å­—æ®µæ˜¯å¯å¯»å€ä½†ä¸å¯è®¾ç½®çš„ï¼ˆæ¯”å¦‚ä¸Šé¢ä¾‹å­ä¸­çš„ageå­—æ®µï¼‰ã€‚
- å½“è¢«åå°„å¯¹è±¡çš„é™æ€ç±»å‹æ˜¯æ¥å£ç±»å‹æ—¶ï¼ˆå°±åƒä¸Šé¢çš„interface{}ç±»å‹å˜é‡iï¼‰ï¼Œè¯¥è¢«åå°„å¯¹è±¡çš„åŠ¨æ€ç±»å‹å†³å®šäº†å…¶è¿›å…¥åå°„ä¸–ç•Œåçš„å¯è®¾ç½®æ€§ã€‚å¦‚æœåŠ¨æ€ç±»å‹ä¸º`*T`æˆ–`&T`æ—¶ï¼Œå°±åƒä¸Šé¢ä¼ ç»™å˜é‡içš„æ˜¯`&Person{}`ï¼Œé‚£ä¹ˆé€šè¿‡Elemæ–¹æ³•è·å¾—çš„åå°„å¯¹è±¡å°±æ˜¯å¯è®¾ç½®å’Œå¯å¯»å€çš„ã€‚
- mapç±»å‹è¢«åå°„å¯¹è±¡æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒçš„keyå’Œvalueéƒ½æ˜¯ä¸å¯å¯»å€å’Œä¸å¯è®¾ç½®çš„ã€‚ä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡Valueæä¾›çš„SetMapIndexæ–¹æ³•å¯¹mapåå°„å¯¹è±¡è¿›è¡Œä¿®æ”¹ï¼Œè¿™ç§ä¿®æ”¹ä¼šåŒæ­¥åˆ°è¢«åå°„çš„mapå˜é‡ä¸­ã€‚





## 49 Goå¸¸ç”¨å·¥å…·

Ref: [Goè¯­è¨€ç²¾è¿›ä¹‹è·¯2](https://book.douban.com/subject/35720729/) 64



### 49.1 è·å–ä¸å®‰è£…

#### 1 `go get`

go get å‘½ä»¤çš„é»˜è®¤è¡Œä¸ºä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ ¸å¿ƒæ“ä½œï¼š

1. ä¸‹è½½ä¾èµ–åˆ°æ¨¡å—ç¼“å­˜

   ä»è¿œç¨‹ä»£ç ä»“åº“ï¼ˆå¦‚ GitHubã€GitLabï¼‰æ‹‰å–æŒ‡å®šçš„åŒ…åŠå…¶ä¾èµ–é¡¹ï¼Œå­˜å‚¨åˆ°æœ¬åœ°æ¨¡å—ç¼“å­˜ç›®å½•ï¼ˆé€šå¸¸ä¸º `$GOPATH/pkg/mod`ï¼‰ã€‚

   ç¼“å­˜çš„ä¾èµ–ä¼šæŒ‰ã€Œæ¨¡å—è·¯å¾„+ç‰ˆæœ¬ã€éš”ç¦»ï¼Œé¿å…ä¸åŒé¡¹ç›®é—´ä¾èµ–å†²çªã€‚

2. æ›´æ–° go.mod å’Œ go.sum æ–‡ä»¶

   ä¿®æ”¹ go.modï¼šåœ¨æ–‡ä»¶ä¸­æ·»åŠ æˆ–æ›´æ–°ä¾èµ–å£°æ˜ï¼Œæ ¼å¼ä¸º require <æ¨¡å—è·¯å¾„> <ç‰ˆæœ¬>ã€‚

   ç”Ÿæˆã€æ›´æ–° go.sumï¼šè®°å½•ä¾èµ–åŒ…çš„å“ˆå¸Œå€¼ï¼Œç”¨äºæ ¡éªŒä¾èµ–å®Œæ•´æ€§ï¼Œç¡®ä¿åç»­æ„å»ºæ—¶ä¾èµ–æœªè¢«ç¯¡æ”¹ã€‚

3. å®‰è£…å¯æ‰§è¡ŒåŒ…ï¼ˆè‹¥é€‚ç”¨ï¼‰

   å¦‚æœæ‹‰å–çš„åŒ…åŒ…å« main åŒ…ï¼ˆå³å¯æ‰§è¡Œç¨‹åºï¼Œå¦‚å‘½ä»¤è¡Œå·¥å…·ï¼‰ï¼Œgo get ä¼šå°†å…¶ç¼–è¯‘å¹¶å®‰è£…åˆ° `$GOPATH/bin` æˆ– `$GOBIN` ç›®å½•ï¼Œä½¿å…¶å¯ç›´æ¥é€šè¿‡å‘½ä»¤è¡Œè°ƒç”¨ã€‚

- `go get -u` å¼ºåˆ¶æ›´æ–°åŒ…è‡³æœ€æ–°ç‰ˆæœ¬ï¼Œéœ€æ³¨æ„ç‰ˆæœ¬å…¼å®¹æ€§é£é™©

> åœ¨bitbucket.orgä¸Šæ‰˜ç®¡çš„ä¸‰ä¸ªé¡¹ç›®pã€qå’Œrä¸ºä¾‹ï¼ˆpç›´æ¥ä¾èµ–qï¼Œqç›´æ¥ä¾èµ–rï¼‰

```shell
$ go get -u bitbucket.org/bigwhite/p
go: downloading bitbucket.org/bigwhite/p v0.0.0-20201018015115-ed01ba7d1494
go: downloading bitbucket.org/bigwhite/q v0.2.0
go: downloading bitbucket.org/bigwhite/r v0.2.0
go: added bitbucket.org/bigwhite/p v0.0.0-20201018015115-ed01ba7d1494
go: added bitbucket.org/bigwhite/q v0.2.0
go: added bitbucket.org/bigwhite/r v0.2.0

```

go get -uä¼šå°†pã€qåŠrçš„å½“å‰æœ€æ–°ç‰ˆæœ¬ä»£ç å…¨éƒ¨è·å–åˆ°æœ¬åœ°å¹¶ç¼–è¯‘å®‰è£…ã€‚

> åœ¨bitbucket.orgä¸Šæ‰˜ç®¡äº†ä¸‰ä¸ªmoduleï¼šsã€tå’Œuã€‚sä¾èµ–module tä¸­çš„åŒ…tã€module tä¸­çš„åŒ…tä¾èµ–module uä¸­çš„åŒ…uã€‚åˆå§‹çŠ¶æ€ä¸‹ï¼Œmodule tå’Œuéƒ½å‘å¸ƒäº†v1.0.0ç‰ˆæœ¬ã€‚

```sh
$ go get -u bitbucket.org/bigwhite/s
go: downloading bitbucket.org/bigwhite/s v0.0.0-20201022021324-e944764a88be
go: downloading bitbucket.org/bigwhite/t v1.1.0
go: downloading bitbucket.org/bigwhite/u v1.0.0
go: downloading bitbucket.org/bigwhite/u v1.1.0
go: added bitbucket.org/bigwhite/s v0.0.0-20201022021324-e944764a88be
go: added bitbucket.org/bigwhite/t v1.1.0
go: added bitbucket.org/bigwhite/u v1.1.0

```



```sh
$ ll ~/myfield/go/pkg/mod/bitbucket.org/bigwhite 
total 0
dr-xr-xr-x@ 4 andyron  staff   128B Aug  7 13:17 p@v0.0.0-20201018015115-ed01ba7d1494
dr-xr-xr-x@ 4 andyron  staff   128B Aug  7 13:17 q@v0.2.0
dr-xr-xr-x@ 4 andyron  staff   128B Aug  7 13:17 r@v0.2.0
dr-xr-xr-x@ 5 andyron  staff   160B Aug  7 13:29 s@v0.0.0-20201022021324-e944764a88be
dr-xr-xr-x@ 6 andyron  staff   192B Aug  7 13:30 t@v1.1.0
dr-xr-xr-x@ 5 andyron  staff   160B Aug  7 13:30 u@v1.0.0
dr-xr-xr-x@ 5 andyron  staff   160B Aug  7 13:30 u@v1.1.0

```



#### 2 `go install`

ç¼–è¯‘å¹¶å®‰è£…å‘½ä»¤Goç¨‹åºæˆ–åŒ…:

```go
go install
```

ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¼šè¢«æ”¾åˆ° `$GOPATH/bin` æˆ–æ¨¡å—æ¨¡å¼ä¸‹çš„ `GOBIN` è·¯å¾„ä¸­ã€‚

```sh
go install -x -v bitbucket.org/bigwhite/p
```

ç”±äºä¼ å…¥äº†-x -vé€‰é¡¹ï¼Œgo installä¼šè¾“å‡ºå¤§é‡æ—¥å¿—ã€‚

#### 3 `go get -u` ä¸ `go install` å¯¹æ¯” 

`go get -u`ï¼Œä¸‹è½½æˆ–æ›´æ–°ä¾èµ–åŒ…åˆ°æœ¬åœ°æ¨¡å—ç¼“å­˜ï¼ˆ$GOPATH/pkg/modï¼‰ï¼Œå°†ä¾èµ–ä¿¡æ¯å†™å…¥ go.mod å’Œ go.sumï¼ˆå¦‚æ·»åŠ æ–°ä¾èµ–æˆ–æ›´æ–°ç‰ˆæœ¬ï¼‰ã€‚

`go install`ï¼Œä»…ç¼–è¯‘å®‰è£…å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸ä¿®æ”¹é¡¹ç›®ä¾èµ–å…³ç³»ï¼Œè¾“å‡ºè·¯å¾„ç”± `$GOBIN` æˆ– `$GOPATH/bin` æ§åˆ¶ã€‚

|   **ç‰¹æ€§**   |              **`go get -u`**              |           **`go install`**            |
| :----------: | :---------------------------------------: | :-----------------------------------: |
| **ä¸»è¦ç›®çš„** |     æ·»åŠ /æ›´æ–°ä¾èµ–å¹¶ä¿®æ”¹ `go.mod` æ–‡ä»¶     | ç¼–è¯‘å®‰è£…å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¸ä¿®æ”¹ `go.mod`ï¼‰ |
| **ä¾èµ–ç®¡ç†** | âœ… æ›´æ–°ä¾èµ–ç‰ˆæœ¬ï¼Œä¿®æ”¹ `go.mod` å’Œ `go.sum` |           âŒ ä¸ä¿®æ”¹æ¨¡å—æ–‡ä»¶            |
| **å®‰è£…ä½ç½®** |    âŒ é»˜è®¤ä¸å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆGo 1.16+ï¼‰     |  âœ… å®‰è£…åˆ° `$GOPATH/bin` æˆ– `$GOBIN`   |
| **ç‰ˆæœ¬æŒ‡å®š** |     æ”¯æŒ `@v1.2.3`ã€`@latest` ç­‰è¯­æ³•      | **å¿…é¡»** æ˜¾å¼æŒ‡å®šç‰ˆæœ¬ï¼ˆå¦‚ `@latest`ï¼‰ |
| **é€‚ç”¨å¯¹è±¡** |           é¡¹ç›®ä¾èµ–ï¼ˆåº“æˆ–å·¥å…·ï¼‰            |   å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå…¨å±€å·¥å…·æˆ–æœ¬åœ°å‘½ä»¤ï¼‰    |



### 49.2 åŒ…æˆ–moduleæ£€è§†

`go list`ç”¨äºåˆ—å‡ºå…³äºåŒ…/moduleçš„å„ç±»ä¿¡æ¯ã€‚è¿™é‡ŒæŠŠè¾“å‡ºè¿™ç±»ä¿¡æ¯çš„è¡Œä¸ºç§°ä¸ºæ£€è§†ã€‚

#### 49.2.1 go liståŸºç¡€

go listé»˜è®¤åˆ—å‡ºå½“å‰è·¯å¾„ä¸‹çš„åŒ…çš„å¯¼å…¥è·¯å¾„ã€‚

å¦‚æœè¦åˆ—å‡º**å½“å‰è·¯å¾„åŠå…¶å­è·¯å¾„ï¼ˆé€’å½’ï¼‰ä¸‹çš„æ‰€æœ‰åŒ…**ï¼Œå¯ä»¥ç”¨`go list {å½“å‰è·¯å¾„}/...`ï¼š

```sh
âœ  gocmpp@v0.0.0-20240917054108-b238366bff0b $ go list ./...               
github.com/bigwhite/gocmpp
github.com/bigwhite/gocmpp/examples/cmpp2-client
github.com/bigwhite/gocmpp/examples/cmpp3-client
github.com/bigwhite/gocmpp/examples/cmpp3-server
github.com/bigwhite/gocmpp/fuzztest/fwd/gen
github.com/bigwhite/gocmpp/fuzztest/submit/gen
github.com/bigwhite/gocmpp/utils
```

ä¹Ÿå¯ä»¥ä½¿ç”¨`åŒ…å¯¼å…¥è·¯å¾„+...`çš„æ–¹å¼ï¼Œè¡¨ç¤ºåˆ—å‡ºè¯¥è·¯å¾„ä¸‹æ‰€æœ‰å­è·¯å¾„ä¸‹çš„åŒ…å¯¼å…¥è·¯å¾„ï¼š

```sh
âœ  gocmpp@v0.0.0-20240917054108-b238366bff0b $ go list github.com/bigwhite/gocmpp/examples/...
github.com/bigwhite/gocmpp/examples/cmpp2-client
github.com/bigwhite/gocmpp/examples/cmpp3-client
github.com/bigwhite/gocmpp/examples/cmpp3-server
```

GoåŸç”Ÿä¿ç•™äº†å‡ ä¸ªä»£è¡¨ç‰¹å®šåŒ…æˆ–åŒ…é›†åˆçš„è·¯å¾„å…³é”®å­—ï¼š**mainã€allã€cmdå’Œstd**ã€‚è¿™äº›ä¿ç•™çš„è·¯å¾„å…³é”®å­—ä¸è¦ç”¨äºGoåŒ…çš„æ„å»ºä¸­ã€‚

1. mainï¼šè¡¨ç¤ºç‹¬ç«‹å¯æ‰§è¡Œç¨‹åºçš„é¡¶å±‚åŒ…ã€‚
2. allï¼šå±•å¼€ä¸ºä¸»moduleï¼ˆå½“å‰è·¯å¾„ä¸‹çš„moduleï¼‰ä¸‹çš„æ‰€æœ‰åŒ…åŠå…¶æ‰€æœ‰ä¾èµ–åŒ…ï¼ŒåŒ…æ‹¬æµ‹è¯•ä»£ç çš„ä¾èµ–åŒ…

```sh
go list all
```

3. stdï¼šä»£è¡¨æ ‡å‡†åº“æ‰€æœ‰åŒ…çš„é›†åˆã€‚

```sh
go list std
```

4. cmdï¼šä»£ç Goè¯­è¨€è‡ªèº«é¡¹ç›®ä»“åº“ä¸‹çš„src/cmdä¸‹çš„æ‰€æœ‰åŒ…åŠinternalåŒ…ã€‚

```sh
go list cmd
```



é»˜è®¤æƒ…å†µä¸‹ï¼Œgo listè¾“å‡ºçš„éƒ½æ˜¯åŒ…çš„å¯¼å…¥è·¯å¾„ä¿¡æ¯ï¼Œå¦‚æœè¦åˆ—å‡º**moduleä¿¡æ¯**ï¼Œå¯ä»¥ä¸ºlistå‘½ä»¤ä¼ å…¥`-m`å‘½ä»¤è¡Œæ ‡å¿—é€‰é¡¹ï¼š

```sh
âœ  gocmpp@v0.0.0-20240917054108-b238366bff0b $ go list -m
github.com/bigwhite/gocmpp
âœ  gocmpp@v0.0.0-20240917054108-b238366bff0b $ go list -m all
github.com/bigwhite/gocmpp
github.com/dvyukov/go-fuzz v0.0.0-20190516070045-5cc3605ccbb6
github.com/yuin/goldmark v1.4.13
golang.org/x/crypto v0.0.0-20210921155107-089bfa567519
golang.org/x/mod v0.6.0-dev.0.20220419223038-86c51ed26bb4
golang.org/x/net v0.0.0-20220722155237-a158d28d115b
golang.org/x/sync v0.0.0-20220722155255-886fb9371eb4
golang.org/x/sys v0.0.0-20220722155257-8c9f86f7a55f
golang.org/x/term v0.0.0-20210927222741-03fcf44c2211
golang.org/x/text v0.3.8
golang.org/x/tools v0.1.12
golang.org/x/xerrors v0.0.0-20190717185122-a985d3407aa7

```

#### 49.2.2 å®šåˆ¶è¾“å‡ºå†…å®¹çš„æ ¼å¼

`-f`ç”¨äºå®šåˆ¶å…¶è¾“å‡ºå†…å®¹çš„æ ¼å¼ã€‚-fæ ‡å¿—é€‰é¡¹çš„å€¼æ˜¯ä¸€ä¸ªæ ¼å¼å­—ç¬¦ä¸²ï¼Œé‡‡ç”¨çš„æ˜¯Go templateåŒ…çš„è¯­æ³•ã€‚go listçš„é»˜è®¤è¾“å‡ºç­‰ä»·äºï¼š

```sh
go list -f '{{.ImportPath}}'
```

ImportPathè¿™ä¸ªå­—æ®µæ¥è‡ª`$GOROOT/src/cmd/go/internal/pkg.go`æ–‡ä»¶ä¸­çš„ç»“æ„ä½“ç±»å‹`PackagePublic`ï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š

```go
// $GOROOT/src/cmd/go/internal/pkg.go (go 1.14)
type PackagePublic struct {
	Dir           string `json:",omitempty"`  // åŒ…å«åŒ…æºç çš„ç›®å½•ï¿¼
  ImportPath    string `json:",omitempty"`  // dirä¸‹åŒ…çš„å¯¼å…¥è·¯å¾„
  ImportComment string `json:",omitempty"`  // åŒ…å£°æ˜è¯­å¥åé¢çš„æ³¨é‡Šä¸­çš„è·¯å¾„ï¿¼
  Name          string `json:",omitempty"`  // åŒ…åï¿¼
  Doc           string `json:",omitempty"`  // åŒ…æ–‡æ¡£å­—ç¬¦ä¸²ï¿¼
  Target        string `json:",omitempty"`  // è¯¥è½¯ä»¶åŒ…çš„å®‰è£…ç›®æ ‡ï¼ˆå¯ä»¥æ˜¯å¯æ‰§è¡Œçš„ï¼‰ï¿¼
  ...ï¿¼
  
  TestGoFiles  []string `json:",omitempty"` // åŒ…ä¸­çš„_test.goæ–‡ä»¶ï¿¼
  TestImports  []string `json:",omitempty"` // TestGoFileså¯¼å…¥çš„åŒ…ï¿¼
  XTestGoFiles []string `json:",omitempty"` // åŒ…å¤–çš„_test.goï¿¼
  XTestImports []string `json:",omitempty"` // XTestGoFileså¯¼å…¥çš„åŒ…ï¿¼
}
```

ç»“æ„ä½“åŒ…å«äº†åŒ…ç›¸å…³çš„å„ç±»ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦ä»¥Go templateåŒ…çš„è¯­æ³•æ ¼å¼æ¥è¾“å‡ºå„ç§åŒ…ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨æ¨¡æ¿è¯­æ³•ä¸­çš„å†…ç½®å‡½æ•°è¾“å‡ºä¸Šè¿°ç»“æ„ä½“çš„æ‰€æœ‰ä¿¡æ¯ã€‚ä»¥æ ‡å‡†åº“çš„fmtåŒ…ä¸ºä¾‹ï¼š

```sh
âœ  fmt git:(stable) go list -f '{{printf "%#v" .}}'
&load.PackagePublic{Dir:"/opt/homebrew/Cellar/go/1.24.2/libexec/src/fmt", ImportPath:"fmt", ImportComment:"", Name:"fmt", Doc:"Package fmt implements formatted I/O with functions analogous to C's printf and scanf.", Target:"", Shlib:"", Root:"/opt/homebrew/Cellar/go/1.24.2/libexec", ConflictDir:"", ForTest:"", Export:"", BuildID:"", Module:(*modinfo.ModulePublic)(nil), Match:[]string{"."}, Goroot:true, Standard:true, DepOnly:false, BinaryOnly:false, Incomplete:false, DefaultGODEBUG:"", Stale:false, StaleReason:"", GoFiles:[]string{"doc.go", "errors.go", "format.go", "print.go", "scan.go"}, CgoFiles:[]string(nil), CompiledGoFiles:[]string(nil), IgnoredGoFiles:[]string(nil), InvalidGoFiles:[]string(nil), IgnoredOtherFiles:[]string(nil), CFiles:[]string(nil), CXXFiles:[]string(nil), MFiles:[]string(nil), HFiles:[]string(nil), FFiles:[]string(nil), SFiles:[]string(nil), SwigFiles:[]string(nil), SwigCXXFiles:[]string(nil), SysoFiles:[]string(nil), EmbedPatterns:[]string{}, EmbedFiles:[]string(nil), CgoCFLAGS:[]string(nil), CgoCPPFLAGS:[]string(nil), CgoCXXFLAGS:[]string(nil), CgoFFLAGS:[]string(nil), CgoLDFLAGS:[]string(nil), CgoPkgConfig:[]string(nil), Imports:[]string{"errors", "internal/fmtsort", "io", "math", "os", "reflect", "slices", "strconv", "sync", "unicode/utf8"}, ImportMap:map[string]string(nil), Deps:[]string{"cmp", "errors", "internal/abi", "internal/asan", "internal/bisect", "internal/bytealg", "internal/byteorder", "internal/chacha8rand", "internal/coverage/rtcov", "internal/cpu", "internal/filepathlite", "internal/fmtsort", "internal/goarch", "internal/godebug", "internal/godebugs", "internal/goexperiment", "internal/goos", "internal/itoa", "internal/msan", "internal/oserror", "internal/poll", "internal/profilerecord", "internal/race", "internal/reflectlite", "internal/runtime/atomic", "internal/runtime/exithook", "internal/runtime/maps", "internal/runtime/math", "internal/runtime/sys", "internal/stringslite", "internal/sync", "internal/syscall/execenv", "internal/syscall/unix", "internal/testlog", "internal/unsafeheader", "io", "io/fs", "iter", "math", "math/bits", "os", "path", "reflect", "runtime", "slices", "strconv", "sync", "sync/atomic", "syscall", "time", "unicode", "unicode/utf8", "unsafe"}, Error:(*load.PackageError)(nil), DepsErrors:[]*load.PackageError{}, TestGoFiles:[]string{"export_test.go"}, TestImports:[]string(nil), TestEmbedPatterns:[]string{}, TestEmbedFiles:[]string(nil), XTestGoFiles:[]string{"errors_test.go", "example_test.go", "fmt_test.go", "gostringer_example_test.go", "scan_test.go", "state_test.go", "stringer_example_test.go", "stringer_test.go"}, XTestImports:[]string{"bufio", "bytes", "errors", "fmt", "internal/race", "io", "math", "os", "reflect", "regexp", "strings", "testing", "testing/iotest", "time", "unicode", "unicode/utf8"}, XTestEmbedPatterns:[]string{}, XTestEmbedFiles:[]string(nil)}

```

##### 1 ImportPath

ImportPathè¡¨ç¤ºå½“å‰è·¯å¾„ä¸‹çš„åŒ…çš„å¯¼å…¥è·¯å¾„ï¼Œè¯¥å­—æ®µå”¯ä¸€æ ‡è¯†ä¸€ä¸ªåŒ…ã€‚

##### 2 Target

Targetè¡¨ç¤ºåŒ…çš„å®‰è£…è·¯å¾„ï¼Œè¯¥å­—æ®µé‡‡ç”¨ç»å¯¹è·¯å¾„å½¢å¼ã€‚

##### 3 Root

Rootè¡¨ç¤ºåŒ…æ‰€åœ¨çš„GOROOTæˆ–GOPATHé¡¶å±‚è·¯å¾„ï¼Œæˆ–è€…åŒ…å«è¯¥åŒ…çš„moduleæ ¹è·¯å¾„ã€‚

```sh
$ go list -f '{{.Root}}'ï¿¼
/opt/homebrew/Cellar/go/1.24.2/libexecï¿¼

âœ  gofirst git:(main) $ go list -f '{{.Root}}'ï¿¼
...github/LearnGo/Goè¯­è¨€ç¬¬ä¸€è¯¾/gofirstï¿¼
```

##### 4 GoFiles

GoFilesè¡¨ç¤ºå½“å‰åŒ…åŒ…å«çš„Goæºæ–‡ä»¶åˆ—è¡¨ï¼Œä¸åŒ…å«å¯¼å…¥â€œCâ€çš„cgoæ–‡ä»¶ã€æµ‹è¯•ä»£ç æºæ–‡ä»¶ã€‚

```sh
// åœ¨GOROOT/src/os/userç›®å½•ä¸‹æ‰§è¡Œï¿¼
$ go list -f '{{.GoFiles}}'ï¿¼
[lookup.go user.go]
```

##### 5 CgoFiles

CgoFilesè¡¨ç¤ºå½“å‰åŒ…ä¸‹å¯¼å…¥äº†â€œCâ€çš„cgoæ–‡ä»¶ã€‚

##### 6 IgnoredGoFiles

IgnoredGoFilesè¡¨ç¤ºå½“å‰åŒ…ä¸­åœ¨å½“å‰æ„å»ºä¸Šä¸‹æ–‡çº¦æŸæ¡ä»¶ä¸‹è¢«å¿½ç•¥çš„Goæºæ–‡ä»¶ã€‚

```sh
// åœ¨GOROOT/src/os/userç›®å½•ä¸‹æ‰§è¡Œ
$ go list -f '{{.IgnoredGoFiles}}'
[cgo_lookup_cgo.go getgrouplist_unix.go listgroups_stub.go listgroups_unix.go listgroups_unix_test.go lookup_android.go lookup_plan9.go lookup_stubs.go lookup_unix.go lookup_unix_test.go lookup_windows.go user_windows_test.go]
```

##### 7 Imports

Importsè¡¨ç¤ºå½“å‰åŒ…å¯¼å…¥çš„ä¾èµ–åŒ…çš„å¯¼å…¥è·¯å¾„é›†åˆã€‚

```sh
// åœ¨GOROOT/src/os/userç›®å½•ä¸‹æ‰§è¡Œï¿¼
$ go list -f '{{.Imports}}'ï¿¼
[fmt internal/syscall/unix runtime strconv strings sync syscall unsafe]ï¿¼
```

##### 8 Deps

Depsè¡¨ç¤ºå½“å‰åŒ…çš„æ‰€æœ‰ä¾èµ–åŒ…å¯¼å…¥è·¯å¾„é›†åˆã€‚å’ŒImportsä¸åŒçš„æ˜¯ï¼ŒDepsæ˜¯é€’å½’æŸ¥è¯¢å½“å‰åŒ…çš„æ‰€æœ‰ä¾èµ–åŒ…ã€‚

```sh
go list -f '{{.Deps}}'ï¿¼
```

##### 9 TestGoFiles

TestGoFilesè¡¨ç¤ºå½“å‰åŒ…çš„åŒ…å†…æµ‹è¯•ä»£ç çš„æ–‡ä»¶é›†åˆã€‚

```sh
go list -f '{{.TestGoFiles}}'
```

##### 10 XTestGoFiles

XTestGoFilesè¡¨ç¤ºå½“å‰åŒ…çš„åŒ…å¤–æµ‹è¯•ä»£ç çš„æ–‡ä»¶é›†åˆã€‚

```sh
// åœ¨$GOPATH/src/github.com/bigwhite/gocmppç›®å½•ä¸‹æ‰§è¡Œï¿¼
$ go list -f '{{.XTestGoFiles}}'ï¿¼
[activetest_test.go conn_test.go connect_test.go deliver_test.go fwd_test.go receipt_test.go submit_fuzz_test.go submit_test.go terminate_test.go]ï¿¼
```



-jsonæ ‡å¿—é€‰é¡¹ä»¥å°†åŒ…çš„å…¨éƒ¨ä¿¡æ¯ä»¥JSONæ ¼å¼è¾“å‡ºï¼š

```sh
go list -json
```



#### 49.2.3 æœ‰å…³moduleçš„å¯ç”¨å‡çº§ç‰ˆæœ¬ä¿¡æ¯

`-m`æ ‡å¿—é€‰é¡¹ï¼Œå¯ä»¥è®©go liståˆ—å‡ºmoduleä¿¡æ¯ï¼Œå†ä¼ å…¥`-u`å¯ä»¥è·å–åˆ°å¯ç”¨çš„moduleå‡çº§ç‰ˆæœ¬ï¼š

```sh
// åœ¨$GOPATH/src/github.com/bigwhite/gocmppç›®å½•ä¸‹æ‰§è¡Œï¿¼
$ go list -m  all  
github.com/bigwhite/gocmpp
github.com/dvyukov/go-fuzz v0.0.0-20190516070045-5cc3605ccbb6
github.com/yuin/goldmark v1.4.13
golang.org/x/crypto v0.0.0-20210921155107-089bfa567519
golang.org/x/mod v0.6.0-dev.0.20220419223038-86c51ed26bb4
golang.org/x/net v0.0.0-20220722155237-a158d28d115b
golang.org/x/sync v0.0.0-20220722155255-886fb9371eb4
golang.org/x/sys v0.0.0-20220722155257-8c9f86f7a55f
golang.org/x/term v0.0.0-20210927222741-03fcf44c2211
golang.org/x/text v0.3.8
golang.org/x/tools v0.1.12
golang.org/x/xerrors v0.0.0-20190717185122-a985d3407aa7
$ go list -m -u all
github.com/bigwhite/gocmpp
github.com/dvyukov/go-fuzz v0.0.0-20190516070045-5cc3605ccbb6 [v0.0.0-20240924070022-e577bee5275c]
github.com/yuin/goldmark v1.4.13 [v1.7.13]
golang.org/x/crypto v0.0.0-20210921155107-089bfa567519 [v0.40.0]
golang.org/x/mod v0.6.0-dev.0.20220419223038-86c51ed26bb4 [v0.26.0]
golang.org/x/net v0.0.0-20220722155237-a158d28d115b [v0.42.0]
golang.org/x/sync v0.0.0-20220722155255-886fb9371eb4 [v0.16.0]
golang.org/x/sys v0.0.0-20220722155257-8c9f86f7a55f [v0.34.0]
golang.org/x/term v0.0.0-20210927222741-03fcf44c2211 [v0.33.0]
golang.org/x/text v0.3.8 [v0.27.0]
golang.org/x/tools v0.1.12 [v0.35.0]
golang.org/x/xerrors v0.0.0-20190717185122-a985d3407aa7 [v0.0.0-20240903120638-7835f813f4da]
```

### 49.3 æ„å»º

go build

go buildå‘½ä»¤å¸¸ç”¨å‚æ•°ï¼š

```
-v ç¼–è¯‘æ—¶æ˜¾ç¤ºåŒ…å
-p n æŒ‡å®šç¼–è¯‘æ—¶å¹¶å‘çš„æ•°é‡ï¼ˆä½¿ç”¨nè¡¨ç¤ºï¼‰ï¼Œè¯¥å€¼é»˜è®¤ä¸ºCPU çš„é€»
-a å¼ºåˆ¶è¿›è¡Œé‡æ–°æ„å»º
-n ä»…è¾“å‡ºç¼–è¯‘æ—¶æ‰§è¡Œçš„æ‰€æœ‰å‘½ä»¤
-x æ‰§è¡Œç¼–è¯‘å¹¶è¾“å‡ºç¼–è¯‘æ—¶æ‰§è¡Œçš„æ‰€æœ‰å‘½ä»¤
-race å¼€å¯ç«æ€æ£€æµ‹
```

- **åŸºæœ¬ç¼–è¯‘**ï¼š`go build main.go` ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆé»˜è®¤ä¸ç›®å½•åŒåï¼‰
- **ä¼˜åŒ–ä½“ç§¯**ï¼š`go build -ldflags "-s -w"` ç§»é™¤ç¬¦å·è¡¨å’Œè°ƒè¯•ä¿¡æ¯ï¼Œå‡å°‘äºŒè¿›åˆ¶æ–‡ä»¶å¤§å°
- **äº¤å‰ç¼–è¯‘**ï¼šGOOS=linux GOARCH=amd64 go build ç”Ÿæˆè·¨å¹³å°äºŒè¿›åˆ¶æ–‡ä»¶

#### 1 -x -vï¼šè®©æ„å»ºè¿‡ç¨‹ä¸€ç›®äº†ç„¶

go buildè¿‡ç¨‹ä¼šæ‰§è¡Œå¾ˆå¤šå‘½ä»¤

go buildæ‰§è¡Œå‘½ä»¤çš„é¡ºåºå¤§è‡´å¦‚ä¸‹ï¼š

1. åˆ›å»ºç”¨äºæ„å»ºçš„ä¸´æ—¶ç›®å½•ï¼›
2. ä¸‹è½½æ„å»ºmodule sä¾èµ–çš„module tå’Œuï¼›
3. åˆ†åˆ«ç¼–è¯‘module tå’Œuï¼Œå°†ç¼–è¯‘åçš„ç»“æœå­˜å‚¨åˆ°ä¸´æ—¶ç›®å½•åŠGOCACHEç›®å½•ä¸‹ï¼›
4. ç¼–è¯‘module sï¼›
5. å®šä½å’Œæ±‡æ€»module sçš„å„ä¸ªä¾èµ–åŒ…æ„å»ºåçš„ç›®æ ‡æ–‡ä»¶ï¼ˆ.aæ–‡ä»¶ï¼‰çš„ä½ç½®ï¼Œå½¢æˆimportcfg.linkæ–‡ä»¶ï¼Œä¾›åç»­é“¾æ¥å™¨ä½¿ç”¨ï¼›
6. é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶ï¼›
7. æ¸…ç†ä¸´æ—¶æ„å»ºç¯å¢ƒã€‚



ğŸ”–

### 49.4 è¿è¡Œä¸è¯Šæ–­



### 49.5 æŸ¥çœ‹æ–‡æ¡£

#### `go doc`

- æ–‡æ¡£æŸ¥è¯¢ï¼š`go doc fmt.Printf` æŸ¥çœ‹æ ‡å‡†åº“å‡½æ•°æ–‡æ¡£

```sh
go doc net/http
go doc http

go doc http.Get

go doc http.Request.Form
```

- æŸ¥çœ‹å½“å‰é¡¹ç›®æ–‡æ¡£

æŸ¥çœ‹å½“å‰è·¯å¾„ä¸‹çš„åŒ…çš„æ–‡æ¡£ï¼š

```sh
$ go doc
```

æŸ¥çœ‹å½“å‰è·¯å¾„ä¸‹åŒ…çš„å¯¼å‡ºå…ƒç´ çš„æ–‡æ¡£ï¼š

```sh
$ go doc core 
package core // import "github.com/flipped-aurora/gin-vue-admin/server/core"

func RunWindowsServer()
func Viper() *viper.Viper
func Zap() (logger *zap.Logger)
```

éå¯¼å‡ºå…ƒç´ çš„æ–‡æ¡£ï¼š

```sh
$ go doc -u core
package core // import "github.com/flipped-aurora/gin-vue-admin/server/core"

func RunWindowsServer()
func Viper() *viper.Viper
func Zap() (logger *zap.Logger)
func getConfigPath() (config string)
type server interface{ ... }
    func initServer(address string, router *gin.Engine) server
```

- æŸ¥çœ‹é¡¹ç›®ä¾èµ–çš„ç¬¬ä¸‰æ–¹moduleçš„æ–‡æ¡£

`go doc`åœ¨æŸ¥çœ‹é¡¹ç›®ä¾èµ–çš„ç¬¬ä¸‰æ–¹moduleçš„æ–‡æ¡£æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ°go mod cacheä¸­æ‰¾åˆ°è¯¥moduleï¼ˆå·²ç»ä¸‹è½½åˆ°æœ¬åœ°çš„ï¼‰ï¼Œå¹¶æ˜¾ç¤ºå…¶æ–‡æ¡£ï¼š

```sh
$ go doc github.com/casbin/casbin/v2
package casbin // import "github.com/casbin/casbin/v2"

func CasbinJsGetPermissionForUser(e IEnforcer, user string) (string, error)
func CasbinJsGetPermissionForUserOld(e IEnforcer, user string) ([]byte, error)
func GetCacheKey(params ...interface{}) (string, bool)
type CacheableParam interface{ ... }
...
```

- æŸ¥çœ‹æºç 

```sh
go doc -src fmt.Printf

go doc -src NewClient
go doc -u -src newPacketWriter
go doc -src github.com/casbin/casbin/v2 CasbinJsGetPermissionForUser
```

##### pkgsite

[pkgsite](https://github.com/golang/pkgsite)æ˜¯å®˜æ–¹æ¨å‡ºçš„æ–°ç‰ˆGoåŒ…æ–‡æ¡£ç«™ç‚¹ï¼ˆæœ¬åœ°ï¼‰ã€‚

```sh
$ go install golang.org/x/pkgsite/cmd/pkgsite@latest
$ cd myproject
$ pkgsite 
```

- æŸ¥çœ‹åŒ…å†…ç‰¹å®šå‡½æ•°/ç±»å‹çš„æ–‡æ¡£

```sh
go doc <åŒ…å>.<å‡½æ•°å/ç±»å‹å>
```

```sh
go doc slices.Delete
```

- æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£ï¼ˆåŒ…å«æœªå¯¼å‡ºæˆå‘˜ï¼Œé€šå¸¸ç”¨äºè°ƒè¯•ï¼‰

```sh
go doc -u <åŒ…å>.<ç›®æ ‡>
```

```sh
go doc -u slices.overlaps
```



- æŸ¥çœ‹åŒ…å†…æ‰€æœ‰å¯¼å‡ºæˆå‘˜çš„æ–‡æ¡£

```sh
go doc -all <åŒ…å>
```

```sh
go doc -all slices
```



### 49.6 æ¨¡å—ç®¡ç†

#### `go mod`

åŒ…ç®¡ç†ç³»ç»Ÿ

- åˆå§‹åŒ–æ¨¡å—ï¼š`go mod init <æ¨¡å—å>` åˆ›å»º go.mod æ–‡ä»¶ï¼Œå®šä¹‰æ¨¡å—è·¯å¾„å’Œç‰ˆæœ¬
- ä¾èµ–æ•´ç†ï¼š`go mod tidy` è‡ªåŠ¨æ¸…ç†æœªä½¿ç”¨çš„ä¾èµ–ï¼ŒåŒæ­¥ go.mod ä¸å®é™…ä»£ç çš„ä¾èµ–å…³ç³»
- ç¦»çº¿æ„å»ºï¼š`go mod vendor` å°†ä¾èµ–å¤åˆ¶åˆ°æœ¬åœ° vendor ç›®å½•ï¼Œæ”¯æŒæ— ç½‘ç»œç¯å¢ƒç¼–è¯‘
- æŸ¥çœ‹æ¨¡å—ä¾èµ–å›¾ï¼š`go mod graph`





### 49.7 è¿è¡Œ



#### `go run`

ç¼–è¯‘å¹¶ç«‹å³è¿è¡ŒGoç¨‹åºï¼Œé€‚åˆå¿«é€Ÿæµ‹è¯•ã€‚

æ‰§è¡Œgo runå‘½ä»¤æ—¶ä¹Ÿä¼šç¼–è¯‘Goæºç æ–‡ä»¶ï¼Œä½†ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶è¢«å­˜æ”¾åœ¨ä¸´æ—¶ç›®å½•ä¸­ï¼Œå¹¶è‡ªåŠ¨è¿è¡Œè¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚

```go
func main() {
	fmt.Println(os.Args)
}
```

```sh
go run main.go -color blue
[/var/folders/8k/ntbhdf615p34cflx1_qwv38r0000gn/T/go-build692689547/b001/exe/main -color blue]
```





### 49.8 ä»£ç è´¨é‡ä¸æµ‹è¯•

#### `go test`

- å•å…ƒæµ‹è¯•ï¼šè‡ªåŠ¨æ‰§è¡Œ `_test.go` æ–‡ä»¶ä¸­ä»¥ Test å¼€å¤´çš„å‡½æ•°
- è¦†ç›–ç‡åˆ†æï¼š`go test -coverprofile=cover.out` ç”Ÿæˆä»£ç è¦†ç›–ç‡æŠ¥å‘Šï¼Œé€šè¿‡ `go tool cover -html=cover.out` å¯è§†åŒ–
- åŸºå‡†æµ‹è¯•ï¼š`go test -bench=.` è¿è¡Œä»¥ Benchmark å¼€å¤´çš„æ€§èƒ½æµ‹è¯•å‡½æ•°

#### `go vet`

- é™æ€æ£€æŸ¥ï¼š`go vet ./...` æ£€æµ‹ä»£ç ä¸­çš„æ½œåœ¨é”™è¯¯ï¼ˆå¦‚æœªä½¿ç”¨çš„å˜é‡ã€é”™è¯¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼‰

#### `go fmt`

å¯¹Goæºä»£ç è¿›è¡Œæ ¼å¼åŒ–ï¼Œç¬¦åˆGoçš„å®˜æ–¹é£æ ¼ï¼š

```go
go fmt main.go
```

ç°åœ¨Golandå¯ä»¥è‡ªåŠ¨å®Œæˆã€‚



### 49.9 ç³»ç»Ÿäº¤äº’ä¸è°ƒè¯•

#### `go version`

#### `go env`

- æŸ¥çœ‹ç¯å¢ƒå˜é‡ï¼š`go env` æ˜¾ç¤º GOPATHã€GOROOT ç­‰å…³é”®é…ç½®
- åŠ¨æ€ä¿®æ”¹ï¼š`go env -w GOPROXY=https://goproxy.cn` è®¾ç½®å›½å†…é•œåƒåŠ é€Ÿä¾èµ–ä¸‹è½½

### 49.10 è¾…åŠ©å·¥å…·

#### `go clean`

æ¸…ç†æ‰€æœ‰ç¼–è¯‘ç”Ÿæˆçš„æ–‡ä»¶ï¼Œå…·ä½“åŒ…æ‹¬ï¼š

1. å½“å‰ç›®å½•ä¸‹ç”Ÿæˆçš„ä¸åŒ…åæˆ–Goæºç æ–‡ä»¶åç›¸åŒçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä»¥åŠå½“å‰ç›®å½•ä¸­çš„_objå’Œ_testç›®å½•ä¸­åç§°ä¸º_testmain.goã€test.outã€build.outã€a.outåŠåç¼€ä¸º.5ã€.6ã€.8ã€.aã€.oå’Œ.soçš„æ–‡ä»¶ã€‚è¿™äº›æ–‡ä»¶é€šå¸¸æ˜¯æ‰§è¡Œgo buildå‘½ä»¤åç”Ÿæˆçš„ã€‚
2. ä»¥å½“å‰ç›®å½•ä¸‹ç”Ÿæˆçš„åŒ…ååŠ â€œ.testâ€åç¼€ä¸ºåçš„æ–‡ä»¶ã€‚è¿™äº›æ–‡ä»¶é€šå¸¸æ˜¯æ‰§è¡Œgo testå‘½ä»¤åç”Ÿæˆçš„ã€‚
3. å·¥ä½œåŒºä¸­pkgå’Œbinç›®å½•çš„ç›¸åº”å½’æ¡£æ–‡ä»¶å’Œå¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™äº›æ–‡ä»¶é€šå¸¸æ˜¯æ‰§è¡Œgo installå‘½ä»¤åç”Ÿæˆçš„ã€‚

go cleanå‘½ä»¤é€šå¸¸ç”¨äºä½¿ç”¨VCSï¼ˆç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼Œå¦‚Gitï¼‰çš„å›¢é˜Ÿï¼Œåœ¨æäº¤ä»£ç å‰è¿è¡Œï¼Œä»¥å…å°†ç¼–è¯‘æ—¶ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶åŠç¼–è¯‘åç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ç­‰é”™è¯¯åœ°æäº¤åˆ°ä»£ç ä»“åº“ä¸­ã€‚

```
-i	æ¸…é™¤å…³è”çš„å®‰è£…åŒ…å’Œå¯è¿è¡Œæ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶é€šå¸¸æ˜¯æ‰§è¡Œ gQ install å‘½ä»¤åç”Ÿæˆçš„
-n	ä»…è¾“å‡ºæ¸…ç†æ—¶æ‰§è¡Œçš„æ‰€æœ‰å‘½ä»¤
-r	é€’å½’æ¸…é™¤åœ¨ import ä¸­å¼•å…¥çš„åŒ…
-x	æ‰§è¡Œæ¸…ç†å¹¶è¾“å‡ºæ¸…ç†æ—¶æ‰§è¡Œçš„æ‰€æœ‰å‘½ä»¤
-cache	æ¸…ç†ç¼“å­˜ï¼Œè¿™äº›ç¼“å­˜æ–‡ä»¶é€šå¸¸æ˜¯æ‰§è¡Œgo buildå‘½ä»¤åç”Ÿæˆçš„
-testcache	æ¸…ç†æµ‹è¯•ç»“æœ
```



- æ¸…ç†æ„å»ºäº§ç‰©ï¼š`go clean -modcache` åˆ é™¤æ¨¡å—ç¼“å­˜ï¼Œ`go clean -x` æ˜¾ç¤ºæ¸…ç†è¿‡ç¨‹ç»†èŠ‚

#### `go bug`

è·³è½¬åˆ°goçš„GitHubé¡µé¢ï¼ŒæŠ¥å‘Šbug





## 50 æ–‡ä»¶å¤„ç†

### 50.1 æ–‡ä»¶æ“ä½œ

å¤§å¤šæ•°æ–‡ä»¶æ“ä½œçš„å‡½æ•°éƒ½æ˜¯åœ¨osåŒ…ä¸­çš„ï¼Œå‡ ä¸ªç›®å½•æ“ä½œä¾‹å­ï¼š

```go
func Mkdir(name string, perm FileMode) error  // åˆ›å»ºåç§°ä¸ºnameçš„ç›®å½•ï¼Œæƒé™è®¾ç½®æ˜¯permï¼Œå¦‚0555
func MkdirAll(path string, perm FileMode) error // æ ¹æ®pathåˆ›å»ºå¤šçº§å­ç›®å½•ï¼Œå¦‚zuolan/test1/test2
func Remove(name string) error  // åˆ é™¤åç§°ä¸ºnameçš„ç›®å½•ï¼Œå½“ç›®å½•ä¸‹æœ‰æ–‡ä»¶æˆ–è€…å…¶ä»–ç›®å½•æ—¶ä¼šå‡ºé”™
func RemoveAll(path string) error  // æ ¹æ®pathåˆ é™¤å¤šçº§å­ç›®å½•ï¼Œå¦‚æœpathæ˜¯å•ä¸ªåç§°ï¼Œé‚£ä¹ˆè¯¥ç›®å½•ä¸‹çš„å­ç›®å½•å…¨éƒ¨åˆ é™¤
```

#### åˆ›å»ºæ–‡ä»¶ä¸æŸ¥çœ‹çŠ¶æ€

```go
// 1 æ–°å»ºæ–‡ä»¶
func Create(name string) (file *File, err Erroe)  // æ ¹æ®æä¾›çš„æ–‡ä»¶åç§°åˆ›å»ºæ–°çš„æ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡ï¼Œé»˜è®¤æƒé™æ˜¯0666çš„æ–‡ä»¶ï¼Œè¿”å›çš„æ–‡ä»¶å¯¹è±¡æ˜¯å¯è¯»å†™çš„
func NewFile(fd uintptr, name string) *File  // æ ¹æ®æ–‡ä»¶æè¿°ç¬¦åˆ›å»ºç›¸åº”çš„æ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡
// 2 æ–°å»ºæ–‡ä»¶å¤¹
func MkdirAll(path sring, perm FileMode) eror
// 3 æ–‡ä»¶/æ–‡ä»¶å¤¹çŠ¶æ€
func Stat(name string) (FileInfo, error)
```

åœ¨åˆ›å»ºæ–‡ä»¶å¤¹æˆ–è€…æ–‡ä»¶æ—¶ï¼Œæƒé™æ˜¯ä¸€æ¬¡æ€§æŒ‡å®šçš„ï¼Œåç»­è‹¥è¦ä¿®æ”¹æ–‡ä»¶æƒé™ï¼Œéœ€è¦ä½¿ç”¨å…¶ä»–å‡½æ•°ã€‚

åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¯ä»¥ä½¿ç”¨å‡½æ•°os.IsNotExit(err)ï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥é€šè¿‡ä¼ å…¥çš„ertå‚æ•°åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨å¹¶è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚



#### é‡å‘½åä¸ç§»åŠ¨

```go
func Rename(oldpath, newpath string) error
```



#### æ‰“å¼€ä¸å…³é—­

```go
// åªè¯»æ–¹å¼ï¼Œå†…éƒ¨è°ƒç”¨OpenFile()
func Open(name string) (file *File, err Error)
// flagæ˜¯æ‰“å¼€çš„æ–¹å¼ï¼ŒåŒ…æ‹¬åªè¯»ã€è¯»å†™ç­‰
func OpenFile(name string, flag int, perm uint32) (file *File, err Error)
```

flagå±æ€§å¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç»„åˆä½¿ç”¨:

```go
os.O_CREATE | os. O_APPEND
os.O_CREATE | os. O_TRUNC | os. O_WRONLY
//os. O_RDONLY      //åªè¯»
//os. O_WRONLY       //åªå†™
//os. O_RDWR         //è¯»å†™
//os. O_APPEND       //å¾€æ–‡ä»¶ä¸­æ·»åŠ ï¼ˆAppendï¼‰
//os. O_CREATE       //å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨åˆ™å…ˆåˆ›å»º
//os. O_TRUNC        //æ–‡ä»¶æ‰“å¼€æ—¶è£å‰ªæ–‡ä»¶
//os. O_EXCL         //å’ŒO_CREATEä¸€èµ·ä½¿ç”¨,æ–‡ä»¶ä¸èƒ½å­˜åœ¨
//os. O_SYNC         //ä»¥åŒæ­¥I/Oçš„æ–¹å¼æ‰“å¼€
```



#### åˆ é™¤ä¸æˆªæ–­

```go
err := os. Remove("test.txt")
if err !=nil{
  log. Fatal(err)
}
```

```go
err := os.Truncate("test.txt", 100)
if err !=nil{
  log. Fatal(err)
}
```

è£å‰ªä¸€ä¸ªæ–‡ä»¶åˆ°100Bï¼Œå¦‚æœæ–‡ä»¶æœ¬æ¥å°±å°‘äº100Bï¼Œåˆ™æ–‡ä»¶ä¸­åŸå§‹å†…å®¹å¾—ä»¥ä¿ç•™ï¼Œå‰©ä½™çš„å­—èŠ‚ä»¥nullå­—èŠ‚å¡«å……ã€‚

å¦‚æœæ–‡ä»¶æœ¬æ¥è¶…è¿‡100Bï¼Œåˆ™è¶…è¿‡çš„å­—èŠ‚ä¼šè¢«æŠ›å¼ƒï¼Œè¿™æ ·æ€»æ˜¯å¾—åˆ°ç²¾ç¡®çš„100Bçš„æ–‡ä»¶ã€‚è€Œå¦‚æœä¼ å…¥0ï¼Œåˆ™ä¼šæ¸…ç©ºæ–‡ä»¶ã€‚

#### è¯»å†™æ–‡ä»¶

è¯»å†™æ–‡ä»¶ä¸­æœ€å¸¸è§çš„æ“ä½œæœ‰å¤åˆ¶æ–‡ä»¶ã€ç¼–è¾‘ã€è·³è½¬ã€æ›¿æ¢ç­‰ã€‚

##### 1å¤åˆ¶æ–‡ä»¶

`io.Copy(dst Writer, src Reader) (written int64, err error)`

æ³¨æ„ï¼š

Createå‡½æ•°æ‰§è¡Œä¹‹åéœ€è¦Close()å‡½æ•°å…³é—­å›æ”¶èµ„æºã€‚

è°ƒç”¨ioåŒ…ä¸­çš„å¤åˆ¶å‡½æ•°ä¹‹åæ–‡ä»¶å†…å®¹å¹¶æ²¡æœ‰çœŸæ­£ä¿å­˜åœ¨æ–‡ä»¶ä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨Sync()å‡½æ•°åŒæ­¥ä¹‹åæ‰çœŸæ­£ä¿å­˜åˆ°ç¡¬ç›˜ä¸­ã€‚

##### 2è·³è½¬å‡½æ•°

Seek()å‡½æ•°çš„ç‰¹ç‚¹ç±»ä¼¼äºé¼ æ ‡å…‰æ ‡çš„å®šä½ï¼ŒæŒ‡å®šä½ç½®ä¹‹åå¯ä»¥æ‰§è¡Œå¤åˆ¶ã€å‰ªåˆ‡ã€ç²˜è´´ç­‰æ“ä½œã€‚

##### 3å†™å…¥å‡½æ•°

```go
func (file *File) Write(b []byte) (n int, err Error)             //å†™å…¥byteç±»å‹çš„ä¿¡æ¯åˆ°æ–‡ä»¶
func (file *File) WriteAt(b []byte, off int64) (n int, err Error)//åœ¨æŒ‡å®šä½ç½®å¼€å§‹å†™å…¥byteç±»å‹çš„ä¿¡æ¯
func (file *File) WriteString(s string) (ret int, err Error)     //å†™å…¥stringä¿¡æ¯åˆ°æ–‡ä»¶
```



#### æƒé™æ§åˆ¶





#### æ–‡ä»¶é“¾æ¥

åœ¨Linuxç³»ç»Ÿä¸­è‚¯å®šä¼šç»å¸¸é‡åˆ°ç¡¬é“¾æ¥æˆ–è€…è½¯é“¾æ¥ä¹‹ç±»çš„æ–‡ä»¶ï¼Œå¯¹äºä¸€ä¸ªæ™®é€šæ–‡ä»¶ï¼Œå®ƒå®é™…ä¸ŠæŒ‡å‘äº†ç¡¬ç›˜çš„ä¸€ä¸ªç´¢å¼•åœ°å€ã€‚ç¡¬é“¾æ¥ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æŒ‡é’ˆå¹¶ä¸”æŒ‡å‘åŒä¸€ä¸ªåœ°æ–¹ï¼Œç¡¬é“¾æ¥ä¼šä¿æŒä¸åŸæ–‡ä»¶åŒå‘åŒæ­¥ï¼Œå…¶ä¸­ä¸€ä¸ªæ–‡ä»¶æ”¹åŠ¨ï¼Œå¦ä¸€ä¸ªæ–‡ä»¶ä¹Ÿä¼šæ”¹åŠ¨ï¼Œä½†åªæœ‰æ‰€æœ‰çš„é“¾æ¥è¢«åˆ é™¤åæ–‡ä»¶æ‰ä¼šè¢«åˆ é™¤ï¼ˆå³ç§»åŠ¨å’Œé‡å‘½åéƒ½ä¸ä¼šå½±å“ç¡¬é“¾æ¥ï¼‰ã€‚ç¡¬é“¾æ¥åªåœ¨ç›¸åŒçš„æ–‡ä»¶ç³»ç»Ÿä¸­æ‰èƒ½å·¥ä½œã€‚

è½¯é“¾æ¥å’Œç¡¬é“¾æ¥ä¸ä¸€æ ·ï¼Œå®ƒä¸ç›´æ¥æŒ‡å‘ç¡¬ç›˜ä¸­ç›¸åŒçš„åœ°æ–¹ï¼Œè€Œæ˜¯é€šè¿‡åå­—å¼•ç”¨å…¶ä»–æ–‡ä»¶ï¼Œå®ƒä»¬å¯ä»¥æŒ‡å‘ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸åŒæ–‡ä»¶ã€‚Windowsæ“ä½œç³»ç»Ÿä¸æ”¯æŒè½¯é“¾æ¥ã€‚

```go
// åˆ›å»ºä¸€ä¸ªç¡¬é“¾æ¥
	// åˆ›å»ºååŒä¸€ä¸ªæ–‡ä»¶å†…å®¹ä¼šæœ‰ä¸¤ä¸ªæ–‡ä»¶å,æ”¹å˜ä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹ä¼šå½±å“å¦ä¸€ä¸ª
	// åˆ é™¤å’Œé‡å‘½åä¸ä¼šå½±å“å¦ä¸€ä¸ª
	hardLink := filePath + "_hl"
	err := os.Link(filePath, hardLink)
	if err != nil {
		log.Fatal(err)
	}
	fmt.Println("åˆ›å»ºç¡¬é“¾æ¥")
	// åˆ›å»ºä¸€ä¸ªè½¯é“¾æ¥
	softLink := filePath + "_sl"
	err = os.Symlink(fileName, softLink)
	if err != nil {
		log.Fatal(err)
	}
	fmt.Println("åˆ›å»ºè½¯é“¾æ¥")

	// Lstatè¿”å›ä¸€ä¸ªæ–‡ä»¶çš„ä¿¡æ¯,ä½†æ˜¯å½“æ–‡ä»¶æ˜¯ä¸€ä¸ªè½¯é“¾æ¥æ—¶,å®ƒè¿”å›è½¯é“¾æ¥çš„ä¿¡æ¯,è€Œä¸æ˜¯å¼•ç”¨çš„æ–‡ä»¶çš„ä¿¡æ¯
	// Symlinkåœ¨Windowsä¸­ä¸å·¥ä½œ
	fileInfo, err := os.Lstat(softLink)
	if err != nil {
		log.Fatal(err)
	}
	fmt.Printf("é“¾æ¥ä¿¡æ¯: %+v", fileInfo)
	// æ”¹å˜è½¯é“¾æ¥çš„æ‹¥æœ‰è€…ä¸ä¼šå½±å“åŸå§‹æ–‡ä»¶
	err = os.Lchown(softLink, os.Getuid(), os.Getgid())
	if err != nil {
		log.Fatal(err)
	}
```

os.Lstat()çš„å‡½æ•°åä¸­å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªé’ˆå¯¹è½¯é“¾æ¥çš„å‡½æ•°ï¼Œç”¨äºæŸ¥çœ‹è½¯é“¾æ¥è‡ªå·±çš„å±æ€§ï¼Œä½¿ç”¨os.Stat()å‡½æ•°ä¼šè·å–è½¯é“¾æ¥æŒ‡å‘çš„åŸæ–‡ä»¶ä¿¡æ¯ã€‚

éœ€è¦æ³¨æ„è½¯é“¾æ¥å’Œç¡¬é“¾æ¥å®ç°çš„å¼‚åŒï¼Œä»ä¸Šé¢è¿™ä¸¤ä¸ªå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ¥çœ‹ï¼Œè™½ç„¶éƒ½æ˜¯oldnameï¼Œä½†å®é™…ä¾‹å­ä¸­ä¼ é€’ç»™å‡½æ•°çš„å¹¶ä¸æ˜¯åŒä¸€ä¸ªå‡½æ•°ï¼Œç¡¬é“¾æ¥æ˜¯filePathï¼Œè€Œè½¯é“¾æ¥æ˜¯fileNameï¼Œå› ä¸ºç¡¬é“¾æ¥æ˜¯ä»é¡¹ç›®æ ¹ç›®å½•å¼€å§‹åˆ›å»ºç¡¬é“¾æ¥çš„ï¼Œè€Œè½¯é“¾æ¥æ˜¯æ ¹æ®ç›®æ ‡æ–‡ä»¶çš„ç›¸å¯¹ä½ç½®åˆ›å»ºè½¯é“¾æ¥çš„ã€‚

### 50.2 XMLæ–‡ä»¶å¤„ç†

```xml
<?xml version="1.0" encoding="utf-8"?>
<servers version="1">
    <server>
        <serverName>Local_Web</serverName>
        <serverIP>172.0.0.1</serverIP>
    </server>
    <server>
        <serverName> Local_DB</serverName>
        <serverIP>172.0.0.2</serverIP>
    </server>
</servers>
```

#### è§£æXML

```go
package main

import (
	"encoding/xml"
	"fmt"
	"io/ioutil"
	"os"
)

type Recurlyservers struct {
	XMLName     xml.Name `xml:"servers"`
	Version     string   `xml:"version,attr"`
	Svs         []server `xml:"server"`
	Description string   `xml:",innerxml"`
}
type server struct {
	XMLName    xml.Name `xml:"server"`
	ServerName string   `xml:"serverName"`
	ServerIP   string   `xml:"serverIP"`
}

func main() {
	file, err := os.Open("servers.xml")
	if err != nil {
		fmt.Printf("error: %v", err)
		return
	}
	defer file.Close()
	data, err := ioutil.ReadAll(file)
	if err != nil {
		fmt.Printf("error: %v", err)
		return
	}
	v := Recurlyservers{}
	err = xml.Unmarshal(data, &v)
	if err != nil {
		fmt.Printf("error: %v", err)
		return
	}
	fmt.Println(v)
}
```

ç»“æœï¼š

```sh
$ go run xml.go
{{ servers} 1 [{{ server} Local_Web 172.0.0.1} {{ server}  Local_DB 172.0.0.2}] 
    <server>
        <serverName>Local_Web</serverName>
        <serverIP>172.0.0.1</serverIP>
    </server>
    <server>
        <serverName> Local_DB</serverName>
        <serverIP>172.0.0.2</serverIP>
    </server>
}
```

XMLæ–‡ä»¶è§£ææˆå¯¹åº”çš„structå¯¹è±¡æ˜¯é€šè¿‡xmlåŒ…çš„Unmarshalå‡½æ•°æ¥è§£æXMLæ–‡ä»¶ï¼š

```go
func Unmarshal(data []byte, v interface{}) error
```

dataæ¥æ”¶çš„æ˜¯XMLæ•°æ®æµï¼Œvæ˜¯éœ€è¦è¾“å‡ºçš„ç»“æ„ï¼Œå®šä¹‰ä¸ºinterfaceï¼Œç›®å‰æ”¯æŒstructã€sliceå’Œstringï¼ŒxmlåŒ…å†…éƒ¨é‡‡ç”¨äº†åå°„è¿›è¡Œæ•°æ®çš„æ˜ å°„ï¼Œæ‰€ä»¥vä¸­çš„å­—æ®µå¿…é¡»æ˜¯å¯¼å‡ºçš„ã€‚Unmarshalè§£ææ—¶XMLå…ƒç´ å’Œå­—æ®µæ˜¯æ€æ ·å¯¹åº”èµ·æ¥çš„å‘¢ï¼Ÿè¿™æ˜¯æœ‰ä¸€ä¸ªä¼˜å…ˆçº§è¯»å–æµç¨‹çš„ï¼Œé¦–å…ˆä¼šè¯»å–struct tagï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆå°±ä¼šè¯»å–å¯¹åº”å­—æ®µåã€‚å¿…é¡»æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œè§£æçš„æ—¶å€™ï¼Œtagã€å­—æ®µåã€XMLå…ƒç´ éƒ½æ˜¯å¤§å°å†™æ•æ„Ÿçš„ï¼Œæ‰€ä»¥ï¼Œå­—æ®µå¿…é¡»ä¸€ä¸€å¯¹åº”ã€‚

Goè¯­è¨€çš„åå°„æœºåˆ¶ï¼Œå¯ä»¥åˆ©ç”¨è¿™äº›tagä¿¡æ¯å°†æ¥è‡ªXMLæ–‡ä»¶ä¸­çš„æ•°æ®åå°„æˆå¯¹åº”çš„structå¯¹è±¡ã€‚

è§£æXMLåˆ°structæ—¶éœ€è¦éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š

1. å¦‚æœstructçš„ä¸€ä¸ªå­—æ®µæ˜¯stringæˆ–è€…[]byteç±»å‹ï¼Œä¸”å®ƒçš„tagå«æœ‰",innerxml"ï¼ŒUnmarshalä¼šå°†æ­¤å­—æ®µæ‰€å¯¹åº”çš„å…ƒç´ å†…æ‰€æœ‰å†…åµŒçš„åŸå§‹XMLç´¯åŠ åˆ°æ­¤å­—æ®µä¸Šï¼Œå¦‚ä¸Šé¢ä¾‹å­ä¸­çš„Descriptionå®šä¹‰ï¼Œæœ€åçš„è¾“å‡ºå¦‚ä¸‹ï¼š

   ```xml
   		<server>
           <serverName>Local_Web</serverName>
           <serverIP>172.0.0.1</serverIP>
       </server>
       <server>
           <serverName> Local_DB</serverName>
           <serverIP>172.0.0.2</serverIP>
       </server>
   ```

2. å¦‚æœstructä¸­æœ‰ä¸€ä¸ªåä¸ºXMLNameï¼Œä¸”ç±»å‹ä¸ºxml.Nameçš„å­—æ®µï¼Œé‚£ä¹ˆåœ¨è§£ææ—¶å°±ä¼šä¿å­˜è¿™ä¸ªelementçš„åå­—åˆ°è¯¥å­—æ®µï¼Œå¦‚ä¸Šé¢ä¾‹å­ä¸­çš„serversã€‚

3. å¦‚æœæŸä¸ªstructå­—æ®µçš„tagå®šä¹‰ä¸­å«æœ‰XMLç»“æ„ä¸­elementçš„åç§°ï¼Œé‚£ä¹ˆè§£ææ—¶å°±ä¼šæŠŠç›¸åº”çš„elementå€¼èµ‹ç»™è¯¥å­—æ®µï¼Œå¦‚ä¸Šé¢ä¾‹å­ä¸­çš„serverNameå’ŒserverIPå®šä¹‰ã€‚

4. å¦‚æœæŸä¸ªstructå­—æ®µçš„tagå®šä¹‰äº†å«æœ‰",attr"ï¼Œé‚£ä¹ˆè§£ææ—¶å°±ä¼šå°†è¯¥ç»“æ„æ‰€å¯¹åº”çš„elementçš„ä¸å­—æ®µåŒåçš„å±æ€§çš„å€¼èµ‹ç»™è¯¥å­—æ®µï¼Œå¦‚ä¸Šversionå®šä¹‰ã€‚

5. å¦‚æœæŸä¸ªstructå­—æ®µçš„tagå®šä¹‰å½¢å¦‚"a>b>c"ï¼Œåˆ™è§£ææ—¶ï¼Œä¼šå°†XMLç»“æ„aä¸‹é¢çš„bä¸‹é¢çš„cå…ƒç´ çš„å€¼èµ‹ç»™è¯¥å­—æ®µã€‚

6. å¦‚æœæŸä¸ªstructå­—æ®µçš„tagå®šä¹‰äº†"-"ï¼Œé‚£ä¹ˆä¸ä¼šä¸ºè¯¥å­—æ®µè§£æåŒ¹é…ä»»ä½•XMLæ•°æ®ã€‚

7. å¦‚æœstructå­—æ®µåé¢çš„tagå®šä¹‰äº†",any"ï¼Œå½“å®ƒçš„å­å…ƒç´ åœ¨ä¸æ»¡è¶³å…¶ä»–è§„åˆ™æ—¶å°±ä¼šåŒ¹é…åˆ°è¿™ä¸ªå­—æ®µã€‚

8. å¦‚æœæŸä¸ªXMLå…ƒç´ åŒ…å«ä¸€æ¡æˆ–è€…å¤šæ¡æ³¨é‡Šï¼Œé‚£ä¹ˆè¿™äº›æ³¨é‡Šå°†è¢«ç´¯åŠ åˆ°ç¬¬ä¸€ä¸ªtagå«æœ‰",comments"çš„å­—æ®µä¸Šï¼Œè¿™ä¸ªå­—æ®µçš„ç±»å‹å¯èƒ½æ˜¯[]byteæˆ–stringï¼Œå¦‚æœæ²¡æœ‰è¿™æ ·çš„å­—æ®µå­˜åœ¨ï¼Œé‚£ä¹ˆæ³¨é‡Šå°†ä¼šè¢«æŠ›å¼ƒã€‚

#### ç”ŸæˆXML

```go
func Marshal(v interface{}) ([]byte, error)
func MarshalIndent(v interface{}, prefix, indent string) ([]byte, error)
```



```go
package main

import (
	"encoding/xml"
	"fmt"
	"os"
)

type servers struct {
	XMLName xml.Name `xml:"servers"`
	Version string   `xml:"version,attr"`
	Svs     []server `xml:"server"`
}
type server struct {
	ServerName string `xml:"serverName"`
	ServerIP   string `xml:"serverIP"`
}

func main() {
	v := &servers{Version: "1"}
	v.Svs = append(v.Svs, server{"Local_Web", "172.0.0.1"})
	v.Svs = append(v.Svs, server{"Local_DB", "172.0.0.2"})
	output, err := xml.MarshalIndent(v, "  ", "  ")
	if err != nil {
		fmt.Printf("error: %v\n", err)
	}
	os.Stdout.Write([]byte(xml.Header))
	os.Stdout.Write(output)
}
```

ç»“æœï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
  <servers version="1">
    <server>
      <serverName>Local_Web</serverName>
      <serverIP>172.0.0.1</serverIP>
    </server>
    <server>
      <serverName>Local_DB</serverName>
      <serverIP>172.0.0.2</serverIP>
    </server>
  </servers>
```



Marshalå‡½æ•°æ¥æ”¶çš„å‚æ•°væ˜¯interface{}ç±»å‹ï¼Œå³å®ƒå¯ä»¥æ¥æ”¶ä»»æ„ç±»å‹çš„å‚æ•°ï¼ŒxmlåŒ…ä¼šæ ¹æ®ä¸‹é¢çš„è§„åˆ™æ¥ç”Ÿæˆç›¸åº”çš„XMLæ–‡ä»¶ï¼š

1. å¦‚æœvæ˜¯arrayæˆ–è€…sliceï¼Œé‚£ä¹ˆä¾¿è¾“å‡ºæ¯ä¸€ä¸ªå…ƒç´ ï¼Œç±»ä¼¼äºvalueã€‚
2. å¦‚æœvæ˜¯æŒ‡é’ˆï¼Œé‚£ä¹ˆä¼šè¾“å‡ºMarshalæŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ï¼Œå¦‚æœæŒ‡é’ˆä¸ºç©ºï¼Œä»€ä¹ˆéƒ½ä¸è¾“å‡ºã€‚
3. å¦‚æœvæ˜¯interfaceï¼Œé‚£ä¹ˆå°±å¤„ç†interfaceæ‰€åŒ…å«çš„æ•°æ®ã€‚
4. å¦‚æœvæ˜¯å…¶ä»–æ•°æ®ç±»å‹ï¼Œå°±ä¼šè¾“å‡ºè¿™ä¸ªæ•°æ®ç±»å‹æ‰€æ‹¥æœ‰çš„å­—æ®µä¿¡æ¯ã€‚

ç”Ÿæˆçš„XMLæ–‡ä»¶ä¸­çš„elementçš„åå­—æ ¹æ®å¦‚ä¸‹ä¼˜å…ˆçº§ä»structä¸­è·å–ï¼š

1. å¦‚æœvæ˜¯structï¼ŒXMLNameçš„tagä¸­å®šä¹‰çš„åç§°ã€‚
2. ç±»å‹ä¸ºxml.Nameçš„åå«XMLNameçš„å­—æ®µçš„å€¼ã€‚
3. é€šè¿‡structä¸­å­—æ®µçš„tagæ¥è·å–ã€‚
4. é€šè¿‡structçš„å­—æ®µåæ¥è·å–ã€‚
5. marshallçš„ç±»å‹åç§°ã€‚

è®¾ç½®structä¸­å­—æ®µçš„tagä¿¡æ¯ä»¥æ§åˆ¶æœ€ç»ˆXMLæ–‡ä»¶çš„ç”Ÿæˆï¼š

1. XMLNameä¸ä¼šè¢«è¾“å‡ºã€‚

2. tagä¸­å«æœ‰"-"çš„å­—æ®µä¸ä¼šè¾“å‡ºã€‚

3. tagä¸­å«æœ‰"name,ttr"ï¼Œä¼šä»¥nameä½œä¸ºå±æ€§åï¼Œå­—æ®µå€¼ä½œä¸ºå€¼è¾“å‡ºä¸ºè¿™ä¸ªXMLå…ƒç´ çš„å±æ€§ï¼Œå¦‚ä¸Šversionå­—æ®µæ‰€æè¿°ã€‚

4. tagä¸­å«æœ‰",attr"ï¼Œä¼šä»¥è¿™ä¸ªstructçš„å­—æ®µåä½œä¸ºå±æ€§åè¾“å‡ºä¸ºXMLå…ƒç´ çš„å±æ€§ï¼Œç±»ä¼¼äºä¸Šä¸€æ¡ï¼Œåªæ˜¯è¿™ä¸ªnameé»˜è®¤æ˜¯å­—æ®µåã€‚

5. tagä¸­å«æœ‰",chardata"ï¼Œè¾“å‡ºä¸ºXMLçš„character dataè€Œéelementã€‚

6. tagä¸­å«æœ‰",innerxml"ï¼Œå°†ä¼šè¢«åŸæ ·è¾“å‡ºï¼Œè€Œä¸ä¼šè¿›è¡Œå¸¸è§„çš„ç¼–ç è¿‡ç¨‹ã€‚

7. tagä¸­å«æœ‰",comment"ï¼Œå°†è¢«å½“ä½œXMLæ³¨é‡Šæ¥è¾“å‡ºï¼Œè€Œä¸ä¼šè¿›è¡Œå¸¸è§„çš„ç¼–ç è¿‡ç¨‹ï¼Œå­—æ®µå€¼ä¸­ä¸èƒ½å«æœ‰"--"å­—ç¬¦ä¸²ã€‚

8. tagä¸­å«æœ‰"omitempty"ï¼Œå¦‚æœè¯¥å­—æ®µçš„å€¼ä¸ºç©ºå€¼ï¼Œé‚£ä¹ˆè¯¥å­—æ®µå°±ä¸ä¼šè¢«è¾“å‡ºåˆ°XMLï¼Œç©ºå€¼åŒ…æ‹¬falseã€0ã€nilæŒ‡é’ˆæˆ–nilæ¥å£ï¼Œä»¥åŠä»»ä½•é•¿åº¦ä¸º0çš„arrayã€sliceã€mapæˆ–è€…stringã€‚

9. tagä¸­å«æœ‰"a>b>c"ï¼Œé‚£ä¹ˆå°±ä¼šå¾ªç¯è¾“å‡º3ä¸ªå…ƒç´ ï¼ŒaåŒ…å«bï¼ŒbåŒ…å«cï¼Œä¾‹å¦‚ï¼š

   ```
       FirstName string `xml: "name>first"`
       LastName string `xml :"name>last"`
       <name>
           <first>Asta</first>
           <1ast>Xie</last>
       </name>
   ```

   

#### XMLæ–‡ä»¶çš„è¯»å†™æ“ä½œ



### 50.3 JSONæ–‡ä»¶å¤„ç†

#### è§£æJSON

è§£æJSONè§£æJSONæœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯è§£æåˆ°ç»“æ„ä½“ï¼Œå¦ä¸€ç§æ˜¯è§£æåˆ°æ¥å£ï¼Œå‰è€…æ˜¯åœ¨çŸ¥æ™“è¢«è§£æçš„JSONæ•°æ®ç»“æ„çš„å‰æä¸‹é‡‡å–çš„æ–¹æ¡ˆï¼Œå¦‚æœä¸çŸ¥é“è¢«è§£æçš„æ•°æ®çš„æ ¼å¼ï¼Œåˆ™åº”è¯¥é‡‡ç”¨è§£æåˆ°æ¥å£çš„æ–¹æ¡ˆã€‚

jsonåŒ…æœ‰å¯¹åº”çš„å‡½æ•°ï¼š

```go
func Unmarshal(data []byte, v interface{}) error
```





#### ç”ŸæˆJSON





#### JSONæ–‡ä»¶çš„è¯»å†™æ“ä½œ



### 50.4 æ—¥å¿—

```sh
go get -u github.com/sirupsen/logrus
```



### 50.5 å‹ç¼©

#### æ‰“åŒ…ä¸è§£åŒ…

`archive/zip`

æ‰“åŒ…

è§£åŒ…



#### å‹ç¼©ä¸è§£å‹

`compress/gzip`



## 51 Go Protobuf

https://geektutu.com/post/quick-go-protobuf.html

protobuf å³ Protocol Buffersï¼Œæ˜¯ä¸€ç§è½»ä¾¿é«˜æ•ˆçš„ç»“æ„åŒ–æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œä¸è¯­è¨€ã€å¹³å°æ— å…³ï¼Œå¯æ‰©å±•å¯åºåˆ—åŒ–ã€‚protobuf æ€§èƒ½å’Œæ•ˆç‡å¤§å¹…åº¦ä¼˜äº JSONã€XML ç­‰å…¶ä»–çš„ç»“æ„åŒ–æ•°æ®æ ¼å¼ã€‚

https://github.com/protocolbuffers/protobuf

protobuf æ˜¯ä»¥äºŒè¿›åˆ¶æ–¹å¼å­˜å‚¨çš„ï¼Œå ç”¨ç©ºé—´å°ï¼Œä½†ä¹Ÿå¸¦æ¥äº†å¯è¯»æ€§å·®çš„ç¼ºç‚¹ã€‚protobuf åœ¨é€šä¿¡åè®®å’Œæ•°æ®å­˜å‚¨ç­‰é¢†åŸŸåº”ç”¨å¹¿æ³›ã€‚ä¾‹å¦‚è‘—åçš„åˆ†å¸ƒå¼ç¼“å­˜å·¥å…· [Memcached](https://memcached.org/) çš„ Go è¯­è¨€ç‰ˆæœ¬[groupcache](https://github.com/golang/groupcache) å°±ä½¿ç”¨äº† protobuf ä½œä¸ºå…¶ RPC æ•°æ®æ ¼å¼ã€‚

Protobuf åœ¨ `.proto` å®šä¹‰éœ€è¦å¤„ç†çš„ç»“æ„åŒ–æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ `protoc` å·¥å…·ï¼Œå°† `.proto` æ–‡ä»¶è½¬æ¢ä¸º Cã€C++ã€Golangã€Javaã€Python ç­‰å¤šç§è¯­è¨€çš„ä»£ç ï¼Œå…¼å®¹æ€§å¥½ï¼Œæ˜“äºä½¿ç”¨ã€‚

### å®‰è£…

```sh
brew install protobuf

$ wget https://github.com/protocolbuffers/protobuf/releases/download/v3.11.2/protoc-3.11.2-linux-x86_64.zip
# è§£å‹åˆ° /usr/local ç›®å½•ä¸‹
$ sudo 7z x protoc-3.11.2-linux-x86_64.zip -o/usr/local

protoc --version
```

 Golangä¸­ä½¿ç”¨ protobufï¼Œè¿˜éœ€è¦å®‰è£…protoc-gen-goï¼Œè¿™ä¸ªå·¥å…·ç”¨æ¥å°† `.proto` æ–‡ä»¶è½¬æ¢ä¸º Golang ä»£ç ï¼š

```sh
go get -u github.com/golang/protobuf/protoc-gen-go
```



### å®šä¹‰æ¶ˆæ¯ç±»å‹

`student.proto`

```protobuf
syntax = "proto3";
package main;

option go_package ="./model";

// this is comment
message Student {
  string name = 1;
  int32 age = 2;
  repeated int32 scores = 3;
}
```

```sh
$ protoc --go_out=. *.proto
$ ls
student.pb.go  student.proto
```

å°†è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰çš„ .proto æ–‡ä»¶è½¬æ¢ä¸º Go ä»£ç ã€‚

```go
// ...
type Student struct {
	state         protoimpl.MessageState `protogen:"open.v1"`
	Name          string                 `protobuf:"bytes,1,opt,name=name,proto3" json:"name,omitempty"`
	Age           int32                  `protobuf:"varint,2,opt,name=age,proto3" json:"age,omitempty"`
	Scores        []int32                `protobuf:"varint,3,rep,packed,name=scores,proto3" json:"scores,omitempty"`
	unknownFields protoimpl.UnknownFields
	sizeCache     protoimpl.SizeCache
}
// ...
```



é€è¡Œè§£è¯»`student.proto`

- protobuf æœ‰2ä¸ªç‰ˆæœ¬ï¼Œé»˜è®¤ç‰ˆæœ¬æ˜¯ proto2ï¼Œå¦‚æœéœ€è¦ proto3ï¼Œåˆ™éœ€è¦åœ¨éç©ºéæ³¨é‡Šç¬¬ä¸€è¡Œä½¿ç”¨ `syntax = "proto3"` æ ‡æ˜ç‰ˆæœ¬ã€‚

- `package`ï¼Œå³åŒ…åå£°æ˜ç¬¦æ˜¯å¯é€‰çš„ï¼Œç”¨æ¥é˜²æ­¢ä¸åŒçš„æ¶ˆæ¯ç±»å‹æœ‰å‘½åå†²çªã€‚
- æ¶ˆæ¯ç±»å‹ ä½¿ç”¨ `message` å…³é”®å­—å®šä¹‰ï¼ŒStudent æ˜¯ç±»å‹åï¼Œname, male, scores æ˜¯è¯¥ç±»å‹çš„ 3 ä¸ªå­—æ®µï¼Œç±»å‹åˆ†åˆ«ä¸º string, bool å’Œ []int32ã€‚å­—æ®µå¯ä»¥æ˜¯æ ‡é‡ç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯åˆæˆç±»å‹ã€‚
- æ¯ä¸ªå­—æ®µçš„ä¿®é¥°ç¬¦é»˜è®¤æ˜¯ `singular`ï¼Œä¸€èˆ¬çœç•¥ä¸å†™ï¼Œ`repeated` è¡¨ç¤ºå­—æ®µå¯é‡å¤ï¼Œå³ç”¨æ¥è¡¨ç¤º Go è¯­è¨€ä¸­çš„æ•°ç»„ç±»å‹ã€‚
- æ¯ä¸ªå­—ç¬¦ `=`åé¢çš„æ•°å­—ç§°ä¸º**æ ‡è¯†ç¬¦**ï¼Œæ¯ä¸ªå­—æ®µéƒ½éœ€è¦æä¾›ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ã€‚æ ‡è¯†ç¬¦ç”¨æ¥åœ¨æ¶ˆæ¯çš„äºŒè¿›åˆ¶æ ¼å¼ä¸­è¯†åˆ«å„ä¸ªå­—æ®µï¼Œä¸€æ—¦ä½¿ç”¨å°±ä¸èƒ½å¤Ÿå†æ”¹å˜ï¼Œæ ‡è¯†ç¬¦çš„å–å€¼èŒƒå›´ä¸º `[1, 2^29 - 1]` ã€‚
- .proto æ–‡ä»¶å¯ä»¥å†™æ³¨é‡Šï¼Œå•è¡Œæ³¨é‡Š `//`ï¼Œå¤šè¡Œæ³¨é‡Š `/* ... */`
- ä¸€ä¸ª .proto æ–‡ä»¶ä¸­å¯ä»¥å†™å¤šä¸ªæ¶ˆæ¯ç±»å‹ï¼Œå³å¯¹åº”å¤šä¸ªç»“æ„ä½“(struct)ã€‚



æ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥åœ¨é¡¹ç›®ä»£ç ä¸­ç›´æ¥ä½¿ç”¨äº†ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ä¾‹å­ï¼Œå³è¯æ˜è¢«åºåˆ—åŒ–çš„å’Œååºåˆ—åŒ–åçš„å®ä¾‹ï¼ŒåŒ…å«ç›¸åŒçš„æ•°æ®ã€‚

```go
package main

import (
	. "ch51/model"
	"google.golang.org/protobuf/proto"
	"log"
)

func main() {
	test := &Student{
		Name: "andyron",
		Male: true,
		Scores: []int32{
			100, 99, 98,
		},
	}
	data, err := proto.Marshal(test)
	if err != nil {
		log.Fatal("marshaling error: ", err)
	}
	newTest := &Student{}
	err = proto.Unmarshal(data, newTest)
	if err != nil {
		log.Fatal("unmarshaling error: ", err)
	}

	if test.GetName() != newTest.GetName() {
		log.Fatalf("data mismatch %q != %q", test.GetName(), newTest.GetName())
	}
}
```



### å­—æ®µç±»å‹

#### æ ‡é‡ç±»å‹(Scalar)

| protoç±»å‹ | goç±»å‹  | å¤‡æ³¨                          | protoç±»å‹ | goç±»å‹  | å¤‡æ³¨                       |
| :-------- | :------ | :---------------------------- | :-------- | :------ | :------------------------- |
| double    | float64 |                               | float     | float32 |                            |
| int32     | int32   |                               | int64     | int64   |                            |
| uint32    | uint32  |                               | uint64    | uint64  |                            |
| sint32    | int32   | é€‚åˆè´Ÿæ•°                      | sint64    | int64   | é€‚åˆè´Ÿæ•°                   |
| fixed32   | uint32  | å›ºé•¿ç¼–ç ï¼Œé€‚åˆå¤§äº2^28çš„å€¼    | fixed64   | uint64  | å›ºé•¿ç¼–ç ï¼Œé€‚åˆå¤§äº2^56çš„å€¼ |
| sfixed32  | int32   | å›ºé•¿ç¼–ç                       | sfixed64  | int64   | å›ºé•¿ç¼–ç                    |
| bool      | bool    |                               | string    | string  | UTF8 ç¼–ç ï¼Œé•¿åº¦ä¸è¶…è¿‡ 2^32 |
| bytes     | []byte  | ä»»æ„å­—èŠ‚åºåˆ—ï¼Œé•¿åº¦ä¸è¶…è¿‡ 2^32 |           |         |                            |

æ ‡é‡ç±»å‹å¦‚æœæ²¡æœ‰è¢«èµ‹å€¼ï¼Œåˆ™ä¸ä¼šè¢«åºåˆ—åŒ–ï¼Œè§£ææ—¶ï¼Œä¼šèµ‹äºˆé»˜è®¤å€¼ã€‚

- stringsï¼šç©ºå­—ç¬¦ä¸²
- bytesï¼šç©ºåºåˆ—
- boolsï¼šfalse
- æ•°å€¼ç±»å‹ï¼š0

#### æšä¸¾(Enumerations)

æšä¸¾ç±»å‹é€‚ç”¨äºæä¾›ä¸€ç»„é¢„å®šä¹‰çš„å€¼ï¼Œé€‰æ‹©å…¶ä¸­ä¸€ä¸ªã€‚

```protobuf
message Student {

  enum Gender {
    FEMALE = 0;
    MALE = 1;
  }
  Gender gender = 5;
}
```

- æšä¸¾ç±»å‹çš„ç¬¬ä¸€ä¸ªé€‰é¡¹çš„æ ‡è¯†ç¬¦å¿…é¡»æ˜¯0ï¼Œè¿™ä¹Ÿæ˜¯æšä¸¾ç±»å‹çš„é»˜è®¤å€¼ã€‚
- åˆ«åï¼ˆAliasï¼‰ï¼Œå…è®¸ä¸ºä¸åŒçš„æšä¸¾å€¼èµ‹äºˆç›¸åŒçš„æ ‡è¯†ç¬¦ï¼Œç§°ä¹‹ä¸ºåˆ«åï¼Œéœ€è¦æ‰“å¼€`allow_alias`é€‰é¡¹ã€‚\

```protobuf
message EnumAllowAlias {
  enum Status {
    option allow_alias = true;
    UNKOWN = 0;
    STARTED = 1;
    RUNNING = 1;
  }
}
```

#### ä½¿ç”¨å…¶ä»–æ¶ˆæ¯ç±»å‹

`Result`æ˜¯å¦ä¸€ä¸ªæ¶ˆæ¯ç±»å‹ï¼Œåœ¨ SearchReponse ä½œä¸ºä¸€ä¸ªæ¶ˆæ¯å­—æ®µç±»å‹ä½¿ç”¨ã€‚

```protobuf
message SearchResponse {
  repeated Result results = 1; 
}

message Result {
  string url = 1;
  string title = 2;
  repeated string snippets = 3;
}
```

åµŒå¥—å†™ä¹Ÿæ˜¯æ”¯æŒçš„ï¼š

```protobuf
message SearchResponse {
  message Result {
    string url = 1;
    string title = 2;
    repeated string snippets = 3;
  }
  repeated Result results = 1;
}
```

å¦‚æœå®šä¹‰åœ¨å…¶ä»–æ–‡ä»¶ä¸­ï¼Œå¯ä»¥å¯¼å…¥å…¶ä»–æ¶ˆæ¯ç±»å‹æ¥ä½¿ç”¨ï¼š

```protobuf
import "myproject/other_protos.proto";
```

#### ä»»æ„ç±»å‹(Any)

Any å¯ä»¥è¡¨ç¤ºä¸åœ¨ .proto ä¸­å®šä¹‰ä»»æ„çš„å†…ç½®ç±»å‹ã€‚

```
import "google/protobuf/any.proto";

message ErrorStatus {
  string message = 1;
  repeated google.protobuf.Any details = 2;
}
```

#### oneof

```protobuf
message SampleMessage {
  oneof test_oneof {
    string name = 4;
    SubMessage sub_message = 9;
  }
}
```

#### map

```protobuf
message MapRequest {
  map<string, int32> points = 1;
}
```



### å®šä¹‰æœåŠ¡(Services)

å¦‚æœæ¶ˆæ¯ç±»å‹æ˜¯ç”¨æ¥è¿œç¨‹é€šä¿¡çš„(Remote Procedure Call, RPC)ï¼Œå¯ä»¥åœ¨ .proto æ–‡ä»¶ä¸­å®šä¹‰ RPC æœåŠ¡æ¥å£ã€‚ä¾‹å¦‚å®šä¹‰äº†ä¸€ä¸ªåä¸º SearchService çš„ RPC æœåŠ¡ï¼Œæä¾›äº† `Search` æ¥å£ï¼Œå…¥å‚æ˜¯ `SearchRequest` ç±»å‹ï¼Œè¿”å›ç±»å‹æ˜¯ `SearchResponse`

```protobuf
service SearchService {
  rpc Search (SearchRequest) returns (SearchResponse);
}
```

å®˜æ–¹ä»“åº“ä¹Ÿæä¾›äº†ä¸€ä¸ª[æ’ä»¶åˆ—è¡¨](https://github.com/protocolbuffers/protobuf/blob/master/docs/third_party.md)ï¼Œå¸®åŠ©å¼€å‘åŸºäº Protocol Buffer çš„ RPC æœåŠ¡ã€‚



### protoc å…¶ä»–å‚æ•°

å‘½ä»¤è¡Œä½¿ç”¨æ–¹æ³•

```
protoc --proto_path=IMPORT_PATH --<lang>_out=DST_DIR path/to/file.proto
```

- `--proto_path=IMPORT_PATH`ï¼šå¯ä»¥åœ¨ .proto æ–‡ä»¶ä¸­ import å…¶ä»–çš„ .proto æ–‡ä»¶ï¼Œproto_path å³ç”¨æ¥æŒ‡å®šå…¶ä»– .proto æ–‡ä»¶çš„æŸ¥æ‰¾ç›®å½•ã€‚å¦‚æœæ²¡æœ‰å¼•å…¥å…¶ä»–çš„ .proto æ–‡ä»¶ï¼Œè¯¥å‚æ•°å¯ä»¥çœç•¥ã€‚
- `--<lang>_out=DST_DIR`ï¼šæŒ‡å®šç”Ÿæˆä»£ç çš„ç›®æ ‡æ–‡ä»¶å¤¹ï¼Œä¾‹å¦‚ â€“go_out=. å³ç”Ÿæˆ GO ä»£ç åœ¨å½“å‰æ–‡ä»¶å¤¹ï¼Œå¦å¤–æ”¯æŒ cpp/java/python/ruby/objc/csharp/php ç­‰è¯­è¨€

### æ¨èé£æ ¼

- æ–‡ä»¶(Files)
  - æ–‡ä»¶åä½¿ç”¨å°å†™ä¸‹åˆ’çº¿çš„å‘½åé£æ ¼ï¼Œä¾‹å¦‚ lower_snake_case.proto
  - æ¯è¡Œä¸è¶…è¿‡ 80 å­—ç¬¦
  - ä½¿ç”¨ 2 ä¸ªç©ºæ ¼ç¼©è¿›
- åŒ…(Packages)
  - åŒ…ååº”è¯¥å’Œç›®å½•ç»“æ„å¯¹åº”ï¼Œä¾‹å¦‚æ–‡ä»¶åœ¨`my/package/`ç›®å½•ä¸‹ï¼ŒåŒ…ååº”ä¸º `my.package`
- æ¶ˆæ¯å’Œå­—æ®µ(Messages & Fields)
  - æ¶ˆæ¯åä½¿ç”¨é¦–å­—æ¯å¤§å†™é©¼å³°é£æ ¼(CamelCase)ï¼Œä¾‹å¦‚`message StudentRequest { ... }`
  - å­—æ®µåä½¿ç”¨å°å†™ä¸‹åˆ’çº¿çš„é£æ ¼ï¼Œä¾‹å¦‚ `string status_code = 1`
  - æšä¸¾ç±»å‹ï¼Œæšä¸¾åä½¿ç”¨é¦–å­—æ¯å¤§å†™é©¼å³°é£æ ¼ï¼Œä¾‹å¦‚ `enum FooBar`ï¼Œæšä¸¾å€¼ä½¿ç”¨å…¨å¤§å†™ä¸‹åˆ’çº¿éš”å¼€çš„é£æ ¼(CAPITALS_WITH_UNDERSCORES )ï¼Œä¾‹å¦‚ FOO_DEFAULT=1
- æœåŠ¡(Services)
  - RPC æœåŠ¡åå’Œæ–¹æ³•åï¼Œå‡ä½¿ç”¨é¦–å­—æ¯å¤§å†™é©¼å³°é£æ ¼ï¼Œä¾‹å¦‚`service FooService{ rpc GetSomething() }`

## 52 Goè¯­è¨€å¯†ç å­¦ç®—æ³•

refï¼š2ï¸âƒ£-13

### 52.1 Hashç®—æ³•

#### Hashçš„å®šä¹‰

Hashï¼ˆå“ˆå¸Œæˆ–æ•£åˆ—ï¼‰ç®—æ³•æ˜¯ITé¢†åŸŸéå¸¸åŸºç¡€ä¹Ÿéå¸¸é‡è¦çš„ä¸€ç±»ç®—æ³•ï¼Œå¯ä»¥å°†ä»»æ„é•¿åº¦çš„äºŒè¿›åˆ¶å€¼ï¼ˆæ˜æ–‡ï¼‰æ˜ å°„ä¸ºè¾ƒçŸ­çš„å›ºå®šé•¿åº¦çš„äºŒè¿›åˆ¶å€¼ï¼ˆHashå€¼ï¼‰ï¼Œå¹¶ä¸”ä¸åŒçš„æ˜æ–‡å¾ˆéš¾æ˜ å°„ä¸ºç›¸åŒçš„Hashå€¼ã€‚==Hashå€¼==åœ¨åº”ç”¨ä¸­åˆè¢«ç§°ä¸º**æ•°å­—æŒ‡çº¹ï¼ˆfingerprintï¼‰æˆ–æ•°å­—æ‘˜è¦ï¼ˆdigestï¼‰ã€æ¶ˆæ¯æ‘˜è¦**ã€‚

ä¸€ä¸ªä¼˜ç§€çš„Hashç®—æ³•ï¼Œåœ¨ç»™å®šæ˜æ–‡å’Œç®—æ³•çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥åŸºäºæœ‰é™æ—¶é—´å’Œæœ‰é™èµ„æºè®¡ç®—å‡ºHashå€¼ã€‚åœ¨ç»™å®šï¼ˆè‹¥å¹²ï¼‰Hashå€¼çš„æƒ…å†µä¸‹ï¼Œ**å¾ˆéš¾ï¼ˆåŸºæœ¬ä¸å¯èƒ½ï¼‰**åœ¨æœ‰é™æ—¶é—´å†…é€†æ¨å‡ºæ˜æ–‡ã€‚å³ä½¿ä¿®æ”¹ä¸€ç‚¹ç‚¹åŸå§‹è¾“å…¥ä¿¡æ¯ï¼Œä¹Ÿèƒ½ä½¿Hashå€¼å‘ç”Ÿå·¨å¤§çš„æ”¹å˜ã€‚ä¸åŒçš„è¾“å…¥ä¿¡æ¯å‡ ä¹ä¸å¯èƒ½äº§ç”Ÿç›¸åŒçš„Hashå€¼ã€‚

#### æµè¡Œçš„Hashç®—æ³•

Message Digestï¼ˆ==MD==ï¼‰ç³»åˆ—å’ŒSecure Hash Algorithmï¼ˆ==SHA==ï¼‰ç³»åˆ—ç®—æ³•ã€‚

MDç®—æ³•ä¸»è¦åŒ…æ‹¬MD4å’ŒMD5ä¸¤ä¸ªç®—æ³•ã€‚

- MD4ï¼ˆRFC 1320ï¼‰æ˜¯MITçš„Ronald L. Riveståœ¨1990å¹´è®¾è®¡çš„ï¼Œå…¶è¾“å‡ºä¸º128ä½ã€‚**MD4å·²è¢«è¯æ˜ä¸å¤Ÿå®‰å…¨**ã€‚
- MD5ï¼ˆRFC 1321ï¼‰æ˜¯Rivestäº1991å¹´å‘å¸ƒçš„MD4æ”¹è¿›ç‰ˆæœ¬ã€‚å®ƒå¯¹è¾“å…¥ä»ä»¥512ä½è¿›è¡Œåˆ†ç»„ï¼Œå…¶è¾“å‡ºæ˜¯128ä½ã€‚MD5æ¯”MD4æ›´åŠ å®‰å…¨ï¼Œä½†è¿‡ç¨‹æ›´åŠ å¤æ‚ï¼Œè®¡ç®—é€Ÿåº¦è¦æ…¢ä¸€ç‚¹ã€‚**MD5å·²äº2004å¹´è¢«æˆåŠŸç¢°æ’ï¼Œå…¶å®‰å…¨æ€§å·²ä¸è¶³ä»¥åº”ç”¨äºå•†ä¸šåœºæ™¯**ã€‚

SHAç®—æ³•ç”±ç¾å›½å›½å®¶æ ‡å‡†ä¸æŠ€æœ¯ç ”ç©¶é™¢ï¼ˆNational Institute of Standards and Technologyï¼ŒNISTï¼‰å¾é›†åˆ¶å®šã€‚

- SHA-0ç®—æ³•äº1993å¹´é—®ä¸–ï¼Œ1998å¹´å³é­ç ´è§£ã€‚éšåçš„ä¿®è®¢ç‰ˆæœ¬SHA-1ç®—æ³•åœ¨1995å¹´é¢ä¸–ï¼Œå®ƒçš„è¾“å‡ºä¸ºé•¿åº¦160ä½çš„Hashå€¼ï¼Œå®‰å…¨æ€§æ›´å¥½ã€‚
- SHA-1è®¾è®¡é‡‡ç”¨äº†MD4ç®—æ³•ç±»ä¼¼åŸç†ã€‚SHA-1å·²äº2005å¹´è¢«æˆåŠŸç¢°æ’ï¼Œæ„å‘³ç€æ— æ³•æ»¡è¶³å•†ç”¨éœ€æ±‚ã€‚
- ä¸ºäº†æé«˜å®‰å…¨æ€§ï¼ŒNISTåæ¥åˆ¶å®šå‡ºæ›´å®‰å…¨çš„SHA-224ã€SHA-256ã€SHA-384å’ŒSHA-512ç®—æ³•ï¼ˆç»Ÿç§°ä¸º**==SHA-2ç®—æ³•==**ï¼‰ã€‚
- æ–°ä¸€ä»£çš„**SHA-3ç®—æ³•**ä¹Ÿæ­£åœ¨ç ”ç©¶ä¸­ã€‚

ç›®å‰MD5å’ŒSHA-1å·²ç»ä¸å¤Ÿå®‰å…¨ï¼Œæ¨èè‡³å°‘ä½¿ç”¨SHA-256ç®—æ³•ã€‚**æ¯”ç‰¹å¸**ç³»ç»Ÿå°±æ˜¯ä½¿ç”¨==SHA-256ç®—æ³•==ã€‚

SHA-3ç®—æ³•åˆåKeccakç®—æ³•ã€‚Keccakçš„è¾“å‡ºé•¿åº¦æœ‰ï¼š512ä½ã€384ä½ã€256ä½ã€224ä½ã€‚

SHA-3å¹¶ä¸æ˜¯è¦å–ä»£SHA-2ï¼Œå› ä¸ºSHA-2ç›®å‰å¹¶æ²¡æœ‰æš´éœ²æ˜æ˜¾çš„å¼±ç‚¹ã€‚ç”±äºå¯¹MD5å‡ºç°æˆåŠŸçš„ç ´è§£ï¼Œä»¥åŠå¯¹SHA-1å‡ºç°ç†è®ºä¸Šç ´è§£çš„æ–¹æ³•ï¼ŒNISTè®¤ä¸ºéœ€è¦ä¸€ä¸ªä¸ä¹‹å‰ç®—æ³•ä¸åŒçš„ã€å¯æ›¿æ¢çš„åŠ å¯†æ‚å‡‘ç®—æ³•ï¼Œä¹Ÿå°±æ˜¯ç°åœ¨çš„SHA-3ã€‚**åŒºå—é“¾**ä¸­çš„ä»¥å¤ªåŠç³»ç»Ÿå°±æ˜¯ä½¿ç”¨==Keccak256ç®—æ³•==ã€‚



>  RIPEMD - 160å’ŒKeccak-256ç®—æ³•ï¼Œgolangæ ‡å‡†åº“æ²¡æœ‰ï¼Œéœ€è¦å¦å¤–ä¸‹è½½åŒ…ã€‚



#### Hashä¸åŠ å¯†è§£å¯†çš„åŒºåˆ«

Hashæ˜¯å°†ç›®æ ‡æ–‡æœ¬è½¬æ¢æˆå…·æœ‰ç›¸åŒé•¿åº¦çš„ã€ä¸å¯é€†çš„æ‚å‡‘å­—ç¬¦ä¸²ï¼Œè€ŒåŠ å¯†ï¼ˆEncryptï¼‰æ˜¯å°†ç›®æ ‡æ–‡æœ¬è½¬æ¢æˆå…·æœ‰ä¸åŒé•¿åº¦çš„ã€å¯é€†çš„å¯†æ–‡ã€‚

![](images/image-20250108230535753.png)

é€‰æ‹©Hashæˆ–åŠ å¯†çš„åŸºæœ¬åŸåˆ™ï¼š

- å¦‚æœè¢«ä¿æŠ¤æ•°æ®ä»…ä»…ç”¨äºæ¯”è¾ƒéªŒè¯ï¼Œä»¥åä¸éœ€è¦è¿˜åŸæˆæ˜æ–‡å½¢å¼ï¼Œåˆ™ä½¿ç”¨Hashã€‚
- å¦‚æœè¢«ä¿æŠ¤æ•°æ®ä»¥åéœ€è¦è¢«è¿˜åŸæˆæ˜æ–‡ï¼Œåˆ™ä½¿ç”¨åŠ å¯†ã€‚

å¯¹ç®€å•Hashçš„æ”»å‡»æ–¹æ³•ä¸»è¦æœ‰ä¸¤ç§ï¼š

1. å¯»æ‰¾ç¢°æ’æ³•

ç›®å‰å¯¹äºMD5å’ŒSHA-1å¹¶ä¸å­˜åœ¨æœ‰æ•ˆçš„å¯»æ‰¾ç¢°æ’æ–¹æ³•ã€‚æˆ‘å›½æ°å‡ºçš„æ•°å­¦å®¶ç‹å°äº‘æ•™æˆæ›¾ç»åœ¨å›½é™…å¯†ç å­¦ä¼šè®®ä¸Šå‘å¸ƒäº†é’ˆå¯¹MD5å’ŒSHA-1çš„å¯»æ‰¾ç¢°æ’æ”¹è¿›ç®—æ³•ï¼Œä½†è¿™ç§æ–¹æ³•å’Œâ€œç ´è§£â€ç›¸å»ç”šè¿œã€‚è¯¥ç†è®ºç›®å‰ä»…å…·æœ‰æ•°å­¦ä¸Šçš„æ„ä¹‰ï¼Œå¥¹å°†ç ´è§£MD5çš„é¢„æœŸæ­¥éª¤é™ä½äº†å¥½å‡ ä¸ªæ•°é‡çº§ï¼Œä½†å¯¹äºå®é™…åº”ç”¨æ¥è¯´ä»ç„¶æ˜¯ä¸€ä¸ªå¤©æ–‡æ•°å­—ã€‚

2. ç©·ä¸¾æ³•ï¼ˆæˆ–æš´åŠ›ç ´è§£æ³•ï¼‰

é€šä¿—åœ°è¯´ï¼Œç©·ä¸¾æ³•å°±æ˜¯å°†ä¸€ä¸ªèŒƒå›´å†…ï¼ˆå¦‚ä»000000åˆ°999999ï¼‰çš„æ‰€æœ‰å€¼ä¸€ä¸ªä¸€ä¸ªç”¨Hashç®—æ³•æ˜ å°„ï¼Œç„¶åå°†ç»“æœå’Œæ‚å‡‘ä¸²æ¯”è¾ƒï¼Œå¦‚æœç›¸åŒï¼Œåˆ™è¿™ä¸ªå€¼ä¸€å®šæ˜¯æºå­—ä¸²æˆ–æºå­—ä¸²çš„ä¸€ä¸ªç¢°æ’ï¼Œäºæ˜¯å°±å¯ä»¥ç”¨è¿™ä¸ªå€¼éæ³•ç™»å½•äº†ã€‚

ç©·ä¸¾æ³•çœ‹ä¼¼ç¬¨æ‹™ï¼Œä½†ç›®å‰å‡ ä¹æ‰€æœ‰çš„MD5ç ´è§£æœºæˆ–MD5åœ¨çº¿ç ´è§£éƒ½æ˜¯ç”¨è¿™ç§ç©·ä¸¾æ³•ã€‚ç©¶å…¶ç¼˜ç”±ï¼Œå°±æ˜¯ç›¸å½“ä¸€éƒ¨åˆ†å£ä»¤æ˜¯éå¸¸ç®€å•çš„ï¼Œå¦‚â€œ123456â€æˆ–â€œ000000â€ã€‚ç©·ä¸¾æ³•æ˜¯å¦èƒ½æˆåŠŸå¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºå£ä»¤çš„å¤æ‚æ€§ã€‚å› ä¸ºç©·ä¸¾æ³•æ‰«æçš„åŒºé—´å¾€å¾€æ˜¯å•å­—ç¬¦é›†ã€è§„åˆ™çš„åŒºé—´ï¼Œæˆ–è€…ç”±å­—å…¸æ•°æ®è¿›è¡Œç»„åˆï¼Œå› æ­¤ï¼Œå¦‚æœä½¿ç”¨å¤æ‚çš„å£ä»¤ï¼Œå¦‚â€œ!@#$%^ï¼†*()â€ï¼Œç©·ä¸¾æ³•å°±å¾ˆéš¾å¥æ•ˆäº†ã€‚



#### SHA-256

SHA-256ç®—æ³•è¾“å…¥æŠ¥æ–‡çš„æœ€å¤§é•¿åº¦æ˜¯2^64^ bitï¼Œäº§ç”Ÿçš„è¾“å‡ºæ˜¯ä¸€ä¸ª256bitçš„æŠ¥æ–‡æ‘˜è¦ã€‚æ­¥éª¤ï¼š

1. é™„åŠ å¡«å……æ¯”ç‰¹

   å¯¹æŠ¥æ–‡è¿›è¡Œå¡«å……ï¼Œä½¿æŠ¥æ–‡é•¿åº¦ä¸448æ¨¡512åŒä½™ï¼ˆé•¿åº¦=448 mod 512ï¼‰ï¼Œå¡«å……çš„æ¯”ç‰¹æ•°èŒƒå›´æ˜¯1åˆ°512ï¼Œå¡«å……æ¯”ç‰¹ä¸²çš„æœ€é«˜ä½ä¸º1ï¼Œå…¶ä½™ä½ä¸º0ã€‚å°±æ˜¯å…ˆåœ¨æŠ¥æ–‡åé¢åŠ ä¸€ä¸ª1ï¼Œå†åŠ å¾ˆå¤šä¸ª0ï¼Œç›´åˆ°é•¿åº¦æ»¡è¶³mod 512=448ã€‚ä¸ºä»€ä¹ˆæ˜¯448ï¼Ÿå› ä¸º448+64=512ã€‚ç¬¬äºŒæ­¥ä¼šåŠ ä¸Šä¸€ä¸ª64bitçš„åŸå§‹æŠ¥æ–‡çš„é•¿åº¦ä¿¡æ¯ã€‚

2. é™„åŠ é•¿åº¦å€¼

   å°†ç”¨64bitè¡¨ç¤ºçš„åˆå§‹æŠ¥æ–‡ï¼ˆå¡«å……å‰ï¼‰çš„ä½é•¿åº¦é™„åŠ åœ¨æ­¥éª¤1çš„ç»“æœåï¼ˆä½ä½å­—èŠ‚ä¼˜å…ˆï¼‰ã€‚

3. åˆå§‹åŒ–ç¼“å­˜

â€‹	ä½¿ç”¨ä¸€ä¸ª256bitçš„ç¼“å­˜æ¥å­˜æ”¾è¯¥Hashå‡½æ•°çš„ä¸­é—´åŠæœ€ç»ˆç»“æœã€‚è¯¥ç¼“å­˜è¡¨ç¤ºä¸ºA=0x6A09E667ï¼ŒB=0xBB67AE85ï¼ŒC=0x3C6EF372ï¼ŒD=0xA54FF53Aï¼ŒE=0x510E527Fï¼ŒF=0x9B05688Cï¼ŒG=0x1F83D9ABï¼ŒH=0x5BE0CD19ã€‚

4. å¤„ç†512bitï¼ˆ16ä¸ªå­—ï¼‰æŠ¥æ–‡åˆ†ç»„åºåˆ—

   è¯¥ç®—æ³•ä½¿ç”¨äº†6ç§åŸºæœ¬é€»è¾‘å‡½æ•°ï¼Œç”±64æ­¥è¿­ä»£è¿ç®—ç»„æˆã€‚æ¯æ­¥éƒ½ä»¥256bitç¼“å­˜å€¼ABCDEFGHä¸ºè¾“å…¥ï¼Œç„¶åæ›´æ–°ç¼“å­˜å†…å®¹ã€‚

æ¯æ­¥ä½¿ç”¨ä¸€ä¸ª32bit Ktï¼ˆå¸¸æ•°å€¼ï¼‰å’Œä¸€ä¸ª32bit Wtï¼ˆåˆ†ç»„åçš„æŠ¥æ–‡ï¼‰ã€‚

#### æ ¸å¿ƒä»£ç 

ğŸ”–

### 52.3 å¯¹ç§°åŠ å¯†ç®—æ³•

#### å¯¹ç§°åŠ å¯†ç®€ä»‹

å¯¹ç§°åŠ å¯†ï¼ˆä¹Ÿå«==ç§é’¥åŠ å¯†ç®—æ³•==ï¼‰æŒ‡åŠ å¯†å’Œè§£å¯†ä½¿ç”¨ç›¸åŒå¯†é’¥çš„åŠ å¯†ç®—æ³•ã€‚å®ƒè¦æ±‚å‘é€æ–¹å’Œæ¥æ”¶æ–¹åœ¨å®‰å…¨é€šä¿¡ä¹‹å‰ï¼Œå•†å®šä¸€ä¸ªå¯†é’¥ã€‚å¯¹ç§°ç®—æ³•çš„å®‰å…¨æ€§ä¾èµ–äºå¯†é’¥ï¼Œæ³„éœ²å¯†é’¥å°±æ„å‘³ç€ä»»ä½•äººéƒ½å¯ä»¥å¯¹ä»–ä»¬å‘é€æˆ–æ¥æ”¶çš„æ¶ˆæ¯è§£å¯†ï¼Œæ‰€ä»¥å¯†é’¥çš„ä¿å¯†æ€§å¯¹é€šä¿¡çš„å®‰å…¨æ€§è‡³å…³é‡è¦ã€‚

ä¼˜ç‚¹æ˜¯**è®¡ç®—é‡å°ï¼ŒåŠ å¯†é€Ÿåº¦å¿«ï¼ŒåŠ å¯†æ•ˆç‡é«˜**ã€‚

ä¸è¶³æ˜¯å‚ä¸æ–¹éœ€è¦æå‰æŒæœ‰å¯†é’¥ï¼Œä¸€æ—¦æœ‰äººæ³„éœ²åˆ™ç³»ç»Ÿå®‰å…¨æ€§è¢«ç ´åï¼›å¦å¤–ï¼Œå¦‚ä½•åœ¨ä¸å®‰å…¨é€šé“ä¸­æå‰åˆ†å‘å¯†é’¥ä¹Ÿæ˜¯ä¸ªé—®é¢˜ï¼Œå¯†é’¥ç®¡ç†éå¸¸å›°éš¾ã€‚

åŸºäºâ€œå¯¹ç§°å¯†é’¥â€çš„åŠ å¯†ç®—æ³•ä¸»è¦æœ‰**DESã€3DESï¼ˆTripleDESï¼‰ã€AESã€RC2ã€RC4ã€RC5å’ŒBlowfish**ç­‰ã€‚

![](images/image-20250109130902616.png)

#### DESå’Œ3DESç®—æ³•

æ•°æ®åŠ å¯†æ ‡å‡†ç®—æ³•ï¼ˆData Encryption Standardï¼ŒDESï¼‰  1975 IBM

DESç®—æ³•çš„å…¥å£å‚æ•°æœ‰3ä¸ªï¼š

- ==Key==æ˜¯DESç®—æ³•çš„å·¥ä½œå¯†é’¥ï¼Œ8ä¸ªå­—èŠ‚å…±64ä½ã€‚
- ==Data==æ˜¯è¦è¢«åŠ å¯†æˆ–è¢«è§£å¯†çš„æ•°æ®ã€‚
- ==Mode==ä¸ºDESçš„å·¥ä½œæ–¹å¼ï¼Œæœ‰ä¸¤ç§ï¼šåŠ å¯†æˆ–è§£å¯†ã€‚

åœ¨æ²¡æœ‰å¯†é’¥çš„æƒ…å†µä¸‹ï¼Œè§£å¯†è€—è´¹æ—¶é—´éå¸¸é•¿ï¼ŒåŸºæœ¬ä¸Šè®¤ä¸ºæ²¡æœ‰å¯èƒ½ã€‚åŠ å¯†è§£å¯†è€—æ—¶å’Œéœ€è¦åŠ å¯†çš„æ–‡æœ¬å¤§å°æˆæ­£æ¯”ï¼Œè¿™æ˜¯**Pé—®é¢˜**ã€‚çŸ¥é“æ˜æ–‡å’Œå¯¹åº”çš„å¯†æ–‡ï¼Œæ±‚è§£æ‰€ç”¨çš„å¯†é’¥ï¼Œè¿™æ˜¯**NPé—®é¢˜**ã€‚

ç›®å‰è¿˜æ²¡æœ‰NPçš„æ±‚è§£ç®—æ³•ï¼Œä½†æ˜¯å¯†é’¥å¾ˆå®¹æ˜“å¾—åˆ°éªŒè¯ã€‚æƒ³å¾—åˆ°NPçš„è§£ï¼Œåªèƒ½æš´åŠ›ç ´è§£ï¼ˆç©·ä¸¾ç ´è§£ï¼‰ï¼Œæ”»å‡»è€…ä½¿ç”¨è‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç å­—å…¸ï¼Œé€ä¸€å°è¯•ç™»å½•ã€‚ç©·ä¸¾éªŒè¯æ˜¯å¯¹ç§°åŠ å¯†ä»…æœ‰çš„æ±‚è§£æ–¹å¼ï¼Œæ±‚è§£æ—¶é—´å‘ˆæŒ‡æ•°çº§å¢é•¿ã€‚

DESç®—æ³•æŠŠ64ä½çš„æ˜æ–‡è¾“å…¥å—å˜ä¸ºæ•°æ®é•¿åº¦ä¸º64ä½çš„å¯†æ–‡è¾“å‡ºå—ï¼Œå…¶ä¸­8ä½ä¸ºå¥‡å¶æ ¡éªŒä½ï¼Œå¦å¤–56ä½ä½œä¸ºå¯†ç çš„é•¿åº¦ã€‚

é¦–å…ˆï¼ŒDESæŠŠè¾“å…¥çš„64ä½æ•°æ®å—æŒ‰ä½é‡æ–°ç»„åˆï¼Œå¹¶æŠŠè¾“å‡ºåˆ†ä¸ºL0ã€R0ä¸¤éƒ¨åˆ†ï¼Œæ¯éƒ¨åˆ†å„é•¿32ä½ï¼Œå¹¶è¿›è¡Œå‰åç½®æ¢ï¼Œæœ€ç»ˆç”±L0è¾“å‡ºå·¦32ä½ï¼ŒR0è¾“å‡ºå³32ä½ã€‚æ ¹æ®è¿™ä¸ªæ³•åˆ™ç»è¿‡16æ¬¡è¿­ä»£è¿ç®—åï¼Œå¾—åˆ°L16ã€R16ï¼Œå°†æ­¤ä½œä¸ºè¾“å…¥ï¼Œè¿›è¡Œä¸åˆå§‹ç½®æ¢ç›¸åçš„é€†ç½®æ¢ï¼Œå³å¾—åˆ°å¯†æ–‡è¾“å‡ºã€‚DESç®—æ³•å…·æœ‰æé«˜çš„å®‰å…¨æ€§ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œé™¤äº†ç”¨ç©·ä¸¾æœç´¢æ³•å¯¹DESç®—æ³•è¿›è¡Œæ”»å‡»å¤–ï¼Œè¿˜æ²¡æœ‰å‘ç°æ›´æœ‰æ•ˆçš„åŠæ³•ã€‚56ä½é•¿å¯†é’¥çš„ç©·ä¸¾ç©ºé—´ä¸º256ï¼Œè¿™æ„å‘³ç€å¦‚æœä¸€å°è®¡ç®—æœºçš„é€Ÿåº¦æ˜¯æ¯ç§’æ£€æµ‹100ä¸‡ä¸ªå¯†é’¥ï¼Œé‚£ä¹ˆå®ƒæœç´¢å®Œå…¨éƒ¨å¯†é’¥å°±éœ€è¦å°†è¿‘2285å¹´çš„æ—¶é—´ï¼Œå› æ­¤DESç®—æ³•æ˜¯ä¸€ç§å¾ˆå¯é çš„åŠ å¯†æ–¹æ³•ã€‚3DESå¯†é’¥æ˜¯24å­—èŠ‚ï¼Œå³192ä½äºŒè¿›åˆ¶ã€‚

#### AESç®—æ³•

é«˜çº§åŠ å¯†æ ‡å‡†ç®—æ³•ï¼ˆAdvanced Encryption Standardï¼ŒAESï¼‰  ç¾å›½å›½å®¶æ ‡å‡†ä¸æŠ€æœ¯ç ”ç©¶é™¢ï¼ˆNISTï¼‰  2002

2006å¹´ï¼ŒAESç®—æ³•å·²ç„¶æˆä¸ºå¯¹ç§°å¯†é’¥åŠ å¯†ä¸­æœ€æµè¡Œçš„ç®—æ³•ä¹‹ä¸€ã€‚

#### AESçš„åŠ å¯†æ¨¡å¼

- ECBï¼ˆElectronic Code Bookï¼Œç”µå­å¯†ç æœ¬æ¨¡å¼ï¼‰ï¼šæœ€åŸºæœ¬çš„åŠ å¯†æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯é€šå¸¸ç†è§£çš„åŠ å¯†ã€‚ç›¸åŒçš„æ˜æ–‡å°†æ°¸è¿œåŠ å¯†æˆç›¸åŒçš„å¯†æ–‡ï¼Œæ— åˆå§‹å‘é‡ï¼Œå®¹æ˜“å—åˆ°å¯†ç æœ¬é‡æ”¾æ”»å‡»ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å¾ˆå°‘ç”¨ã€‚
- CBCï¼ˆCipher Block Chainingï¼Œå¯†ç åˆ†ç»„é“¾æ¥æ¨¡å¼ï¼‰ï¼šæ˜æ–‡è¢«åŠ å¯†å‰è¦ä¸å‰é¢çš„å¯†æ–‡è¿›è¡Œå¼‚æˆ–è¿ç®—ï¼Œå› æ­¤åªè¦é€‰æ‹©ä¸åŒçš„åˆå§‹å‘é‡ï¼Œç›¸åŒçš„æ˜æ–‡åŠ å¯†åä¼šå½¢æˆä¸åŒçš„å¯†æ–‡ã€‚è¿™æ˜¯ç›®å‰åº”ç”¨æœ€å¹¿æ³›çš„æ¨¡å¼ã€‚CBCåŠ å¯†åçš„å¯†æ–‡æ˜¯ä¸Šä¸‹æ–‡ç›¸å…³çš„ï¼Œä½†æ˜æ–‡çš„é”™è¯¯ä¸ä¼šä¼ é€’åˆ°åç»­åˆ†ç»„ï¼›ä½†å¦‚æœä¸€ä¸ªåˆ†ç»„ä¸¢å¤±ï¼Œåé¢çš„åˆ†ç»„å°†å…¨éƒ¨ä½œåºŸï¼ˆåŒæ­¥é”™è¯¯ï¼‰ã€‚
- CFBï¼ˆCipher Feedback Modeï¼ŒåŠ å¯†åé¦ˆæ¨¡å¼ï¼‰ï¼šç±»ä¼¼äºè‡ªåŒæ­¥åºåˆ—å¯†ç ï¼Œåˆ†ç»„åŠ å¯†åï¼ŒæŒ‰8ä½åˆ†ç»„å°†å¯†æ–‡å’Œæ˜æ–‡è¿›è¡Œç§»ä½å¼‚æˆ–åå¾—åˆ°è¾“å‡ºï¼ŒåŒæ—¶åé¦ˆå›ç§»ä½å¯„å­˜å™¨ã€‚ä¼˜ç‚¹æ˜¯æœ€å°å¯ä»¥æŒ‰å­—èŠ‚è¿›è¡ŒåŠ è§£å¯†ï¼Œä¹Ÿå¯ä»¥æ˜¯nä½çš„ã€‚CFBä¹Ÿæ˜¯ä¸Šä¸‹æ–‡ç›¸å…³çš„ï¼ŒCFBæ¨¡å¼ä¸‹ï¼Œæ˜æ–‡çš„ä¸€ä¸ªé”™è¯¯ä¼šå½±å“åé¢çš„å¯†æ–‡ï¼ˆé”™è¯¯æ‰©æ•£ï¼‰ã€‚
- OFBï¼ˆOutput Feedback Modeï¼Œè¾“å‡ºåé¦ˆæ¨¡å¼ï¼‰ï¼šå°†åˆ†ç»„å¯†ç ä½œä¸ºåŒæ­¥åºåˆ—å¯†ç è¿è¡Œï¼Œå’ŒCFBç›¸ä¼¼ã€‚ä¸è¿‡OFBç”¨å‰ä¸€ä¸ªnä½å¯†æ–‡è¾“å‡ºåˆ†ç»„åé¦ˆå›ç§»ä½å¯„å­˜å™¨ï¼Œæ²¡æœ‰é”™è¯¯æ‰©æ•£é—®é¢˜ã€‚

#### å¡«å……æ–¹å¼

è¡Œä½¿DESã€3DESå’ŒAESä¸‰ç§å¯¹ç§°åŠ å¯†ç®—æ³•æ—¶ï¼Œå¸¸é‡‡ç”¨çš„æ˜¯PKCS5å¡«å……ã€Zeroså¡«å……ï¼ˆ0å¡«å……ï¼‰ã€‚

1. PKCS5å¡«å……

æ¯ä¸ªå¡«å……çš„å­—èŠ‚éƒ½è®°å½•äº†å¡«å……çš„æ€»å­—èŠ‚æ•°ã€‚

â€œaâ€å¡«å……åç»“æœä¸ºï¼š[97 7 7 7 7 7 7 7]ã€‚

â€œabâ€å¡«å……åç»“æœä¸ºï¼š[97 98 6 6 6 6 6 6]ã€‚

â€œâ€”aâ€å¡«å……åç»“æœä¸ºï¼š[228 184 128 97 4 4 4 4]ã€‚

2. Zeroså¡«å……

å…¨éƒ¨å¡«å……ä¸º0çš„å­—èŠ‚ã€‚

â€œaâ€å¡«å……åç»“æœä¸ºï¼š[97 0 0 0 0 0 0 0]ã€‚

â€œabâ€å¡«å……åç»“æœä¸ºï¼š[97 98 0 0 0 0 0 0]ã€‚

â€œâ€”aâ€å¡«å……åç»“æœä¸ºï¼š[228 184 128 97 0 0 0 0]ã€‚

#### æ ¸å¿ƒä»£ç 

ğŸ”–

### 52.3 éå¯¹ç§°åŠ å¯†ç®—æ³•

#### éå¯¹ç§°åŠ å¯†ç®€ä»‹

éå¯¹ç§°åŠ å¯†åˆå«ä½œ**å…¬å¼€å¯†é’¥åŠ å¯†**ï¼ˆPublic Key Cryptographyï¼‰æˆ–==å…¬é’¥åŠ å¯†==ï¼ŒæŒ‡åŠ å¯†å’Œè§£å¯†ä½¿ç”¨ä¸åŒå¯†é’¥çš„åŠ å¯†ç®—æ³•ã€‚å…¬é’¥åŠ å¯†éœ€è¦ä¸¤ä¸ªå¯†é’¥ï¼Œä¸€ä¸ªæ˜¯å…¬å¼€å¯†é’¥ï¼Œå¦ä¸€ä¸ªæ˜¯ç§æœ‰å¯†é’¥ï¼›ä¸€ä¸ªç”¨äºåŠ å¯†ï¼Œå¦ä¸€ä¸ªç”¨äºè§£å¯†ã€‚

==RSA==æ˜¯ç›®å‰æœ€æœ‰å½±å“åŠ›çš„å…¬é’¥åŠ å¯†ç®—æ³•ï¼Œå®ƒèƒ½å¤ŸæŠµæŠ—åˆ°ç›®å‰ä¸ºæ­¢å·²çŸ¥çš„æ‰€æœ‰å¯†ç æ”»å‡»ï¼Œå·²è¢«ISOæ¨èä¸ºå…¬é’¥æ•°æ®åŠ å¯†æ ‡å‡†ã€‚

å…¶ä»–å¸¸è§çš„å…¬é’¥åŠ å¯†ç®—æ³•æœ‰ï¼š**ElGamalã€èƒŒåŒ…ç®—æ³•ã€Rabinï¼ˆRSAçš„ç‰¹ä¾‹ï¼‰ã€æ¤­åœ†æ›²çº¿åŠ å¯†ç®—æ³•ï¼ˆElliptic Curve Cryptographyï¼ŒECCï¼‰**ã€‚

ç¼ºç‚¹æ˜¯åŠ è§£å¯†é€Ÿåº¦è¿œè¿œæ…¢äºå¯¹ç§°åŠ å¯†ï¼Œåœ¨æŸäº›æç«¯æƒ…å†µä¸‹ï¼Œéœ€è¦çš„æ—¶é—´ç”šè‡³æ˜¯å¯¹ç§°åŠ å¯†çš„1000å€ã€‚

![](images/image-20250109132146282.png)

#### éå¯¹ç§°åŠ å¯†ç®—æ³•å®ç°æ•°å­—ç­¾å

éå¯¹ç§°åŠ å¯†ä¸åŒäºåŠ å¯†å’Œè§£å¯†éƒ½ä½¿ç”¨åŒä¸€ä¸ªå¯†é’¥çš„å¯¹ç§°åŠ å¯†ï¼Œè™½ç„¶ä¸¤ä¸ªå¯†é’¥åœ¨æ•°å­¦ä¸Šç›¸å…³ï¼Œä½†å¦‚æœçŸ¥é“äº†å…¶ä¸­ä¸€ä¸ªï¼Œå¹¶ä¸èƒ½å‡­æ­¤è®¡ç®—å‡ºå¦å¤–ä¸€ä¸ªã€‚åŠ å¯†æ¶ˆæ¯çš„å¯†é’¥æ˜¯ä¸èƒ½è§£å¯†æ¶ˆæ¯çš„ã€‚å› æ­¤ä¸¤ä¸ªå¯†é’¥ä¸­ï¼Œä¸€ä¸ªå¯ä»¥å…¬å¼€ï¼Œç§°ä¸º==å…¬é’¥==ï¼›ä¸å…¬å¼€çš„å¯†é’¥ç§°ä¸º==ç§é’¥==ï¼Œå¿…é¡»ç”±ç”¨æˆ·è‡ªè¡Œä¸¥æ ¼ç§˜å¯†ä¿ç®¡ï¼Œç»ä¸é€šè¿‡ä»»ä½•é€”å¾„å‘ä»»ä½•äººæä¾›ã€‚

éå¯¹ç§°åŠ å¯†ç®—æ³•åˆ†ä¸ºä¸¤ç§ï¼š==å…¬é’¥åŠ å¯†ã€ç§é’¥è§£å¯†==å’Œ==ç§é’¥åŠ å¯†ã€å…¬é’¥è§£å¯†==ã€‚å‰è€…æ˜¯**æ™®é€šçš„éå¯¹ç§°ç®—æ³•**ï¼Œè€Œåè€…è¢«ç§°ä¸º==æ•°å­—ç­¾å==ã€‚

ç›®å‰ä¸»æµçš„æ•°å­—ç­¾åç®—æ³•æ˜¯æ¤­åœ†æ›²çº¿æ•°å­—ç­¾åç®—æ³•ï¼ˆECDSAï¼‰ã€‚

æ€»ä¹‹ï¼Œéå¯¹ç§°åŠ å¯†ç®—æ³•ä¸­ï¼Œå…¬é’¥çš„ä½œç”¨æ˜¯åŠ å¯†æ¶ˆæ¯å’ŒéªŒè¯ç­¾åï¼Œè€Œç§é’¥çš„ä½œç”¨æ˜¯è§£å¯†æ¶ˆæ¯å’Œè¿›è¡Œæ•°å­—ç­¾åã€‚

#### RSAç®—æ³•

RSAç®—æ³•åŸºäºä¸€ä¸ªååˆ†ç®€å•çš„æ•°è®ºäº‹å®ï¼š**å°†ä¸¤ä¸ªå¤§ç´ æ•°ç›¸ä¹˜ååˆ†å®¹æ˜“ï¼Œæƒ³è¦å¯¹å…¶ä¹˜ç§¯è¿›è¡Œå› å¼åˆ†è§£æå…¶å›°éš¾**ï¼Œå› æ­¤å¯ä»¥å°†ä¹˜ç§¯å…¬å¼€ä½œä¸ºåŠ å¯†å¯†é’¥ã€‚

å¯†é’¥å¯¹çš„ç”Ÿæˆæ­¥éª¤ï¼š

1. éšæœºé€‰æ‹©ä¸¤ä¸ªä¸ç›¸ç­‰çš„è´¨æ•°på’Œqï¼ˆæ¯”ç‰¹å¸ä¸­pé•¿åº¦ä¸º512ä½äºŒè¿›åˆ¶æ•°å€¼ï¼Œqé•¿åº¦ä¸º1024ä½ï¼‰ã€‚
2. è®¡ç®—på’Œqçš„ä¹˜ç§¯Nã€‚
3. è®¡ç®—p-1å’Œq-1çš„ä¹˜ç§¯Ï† (N)ã€‚
4. éšæœºé€‰ä¸€ä¸ªæ•´æ•°eï¼Œeä¸mè¦äº’è´¨ï¼Œä¸”0ï¼œeï¼œÏ† (N)ã€‚
5. è®¡ç®—eçš„æ¨¡åå…ƒç´ dã€‚
6. å…¬é’¥æ˜¯ï¼ˆN,eï¼‰ï¼Œç§é’¥æ˜¯ï¼ˆN,dï¼‰ã€‚

åŠ è§£å¯†æ­¥éª¤ï¼š

1. å‡è®¾ä¸€ä¸ªæ˜æ–‡mï¼ˆ0ï¼œ=mï¼œNï¼‰ã€‚
2. å¯¹æ˜æ–‡måŠ å¯†å¾—åˆ°å¯†æ–‡c
3. å¯¹å¯†æ–‡cè§£å¯†å¾—åˆ°æ˜æ–‡m

#### æ ¸å¿ƒä»£ç 

ğŸ”–

### 52.4 æ¤­åœ†æ›²çº¿åŠ å¯†ç®—æ³•å’Œæ¤­åœ†æ›²çº¿æ•°å­—ç­¾åç®—æ³•

#### æ¤­åœ†æ›²çº¿åŠ å¯†ç®€ä»‹

æ¤­åœ†æ›²çº¿åŠ å¯†ç®—æ³•ï¼ˆElliptic Curve Cryptographyï¼Œ==ECC==ï¼‰æ˜¯åŸºäºæ¤­åœ†æ›²çº¿æ•°å­¦ç†è®ºå®ç°çš„ä¸€ç§éå¯¹ç§°åŠ å¯†ç®—æ³•ã€‚

æ¤­åœ†æ›²çº¿ç®—æ³•åˆç»†åˆ†ä¸ºå¤šç§å…·ä½“çš„ç®—æ³•ã€‚Goè¯­è¨€å†…ç½®çš„æ˜¯**secp256R1ç®—æ³•**ï¼Œè€Œæ¯”ç‰¹å¸ç³»ç»Ÿä¸­ä½¿ç”¨**secp256K1ç®—æ³•**ã€‚ä»¥å¤ªåŠç³»ç»Ÿè™½ç„¶ä¹Ÿé‡‡ç”¨secp256K1ç®—æ³•ï¼Œä½†æ˜¯è·Ÿæ¯”ç‰¹å¸ç³»ç»Ÿçš„secp256K1ç®—æ³•ä¸Šåˆæœ‰æ‰€å·®å¼‚ã€‚

æ¤­åœ†æ›²çº¿å…¬é’¥ç³»ç»Ÿæ˜¯RSAçš„å¼ºæœ‰åŠ›ç«äº‰è€…ï¼Œä¸ç»å…¸çš„RSAå…¬é’¥å¯†ç ä½“åˆ¶ç›¸æ¯”ï¼Œæ¤­åœ†å¯†ç ä½“åˆ¶æœ‰æ˜æ˜¾çš„ä¼˜åŠ¿ã€‚

1. å®‰å…¨æ€§èƒ½æ›´é«˜ï¼ˆECCå¯ä»¥ä½¿ç”¨æ›´çŸ­çš„å¯†é’¥ï¼‰ã€‚åŒç­‰å®‰å…¨å¼ºåº¦ä¸‹ï¼Œä¸¤è€…å¯†é’¥é•¿åº¦çš„å¯¹æ¯”ï¼š

![](images/image-20250109133044905.png)

2. å¤„ç†é€Ÿåº¦å¿«ï¼Œè®¡ç®—é‡å°ã€‚åœ¨ç§é’¥çš„å¤„ç†é€Ÿåº¦ä¸Šï¼ˆè§£å¯†å’Œç­¾åï¼‰ï¼ŒECCè¿œæ¯”RSAå¿«å¾—å¤šã€‚
3. å­˜å‚¨ç©ºé—´å°ã€‚ECCçš„å¯†é’¥å°ºå¯¸å’Œç³»ç»Ÿå‚æ•°ä¸RSAç›¸æ¯”è¦å°å¾—å¤šï¼Œæ‰€ä»¥å ç”¨çš„å­˜å‚¨ç©ºé—´å°å¾—å¤šã€‚
4. å¸¦å®½è¦æ±‚ä½ä½¿å¾—ECCå…·æœ‰å¹¿æ³›çš„åº”ç”¨å‰æ™¯ã€‚

ECCçš„è¿™äº›ç‰¹ç‚¹ä½¿å®ƒå¿…å°†å–ä»£RSAï¼Œæˆä¸ºé€šç”¨çš„å…¬é’¥åŠ å¯†ç®—æ³•ã€‚

#### æ•°å­—ç­¾åçš„æ¦‚å¿µ

æ•°å­—ç­¾åï¼ˆDigital Signatureï¼‰åˆç§°å…¬å¼€å¯†é’¥æ•°å­—ç­¾åã€ç”µå­ç­¾ç« ï¼Œæ˜¯ä¸€ç§ç±»ä¼¼å†™åœ¨çº¸ä¸Šçš„æ™®é€šçš„ç‰©ç†ç­¾åï¼Œä½†æ˜¯ä½¿ç”¨äº†å…¬é’¥åŠ å¯†é¢†åŸŸçš„æŠ€æœ¯ï¼Œç”¨äºé‰´åˆ«æ•°å­—ä¿¡æ¯çš„æ–¹æ³•ã€‚ä¸€å¥—æ•°å­—ç­¾åé€šå¸¸å®šä¹‰ä¸¤ç§äº’è¡¥çš„è¿ç®—ï¼Œä¸€ä¸ªç”¨äº**ç­¾å**ï¼Œå¦ä¸€ä¸ªç”¨äº**éªŒè¯**ã€‚æ•°å­—ç­¾åå¯ä»¥éªŒè¯æ•°æ®çš„æ¥æºï¼Œå¯ä»¥éªŒè¯æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯å¦è¢«ä¿®æ”¹ã€‚

æ•°å­—ç­¾åæ˜¯é€šè¿‡éå¯¹ç§°åŠ å¯†ç®—æ³•ä¸­çš„ç§é’¥åŠ å¯†ã€å…¬é’¥è§£å¯†è¿‡ç¨‹æ¥å®ç°çš„ã€‚

ç§é’¥åŠ å¯†å°±æ˜¯ç§é’¥ç­¾åï¼Œå…¬é’¥è§£å¯†å°±æ˜¯å…¬é’¥éªŒè¯ç­¾åã€‚å› æ­¤æ•°å­—ç­¾åç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š

- ç¬¬ä¸€éƒ¨åˆ†æ˜¯ä½¿ç”¨ç§é’¥ä¸ºæ¶ˆæ¯åˆ›å»ºç­¾åçš„ç®—æ³•ï¼Œ
- ç¬¬äºŒéƒ¨åˆ†æ˜¯å…è®¸ä»»ä½•äººç”¨å…¬é’¥æ¥éªŒè¯ç­¾åçš„ç®—æ³•ã€‚

æ•°å­—ç­¾åçš„ä½¿ç”¨æµç¨‹å¦‚å›¾ï¼š
![](images/image-20250109133338541.png)

æ•°å­—ç­¾ååº”è¯¥æ»¡è¶³å¦‚ä¸‹è¦æ±‚ã€‚

- ç­¾åä¸å¯ä¼ªé€ ã€‚
- ç­¾åä¸å¯æŠµèµ–ã€‚
- ç­¾åçš„è¯†åˆ«å’Œåº”ç”¨ç›¸å¯¹å®¹æ˜“ï¼Œä»»ä½•äººéƒ½å¯ä»¥éªŒè¯ç­¾åçš„æœ‰æ•ˆæ€§ã€‚
- ç­¾åä¸å¯å¤åˆ¶ï¼Œç­¾åä¸åŸæ–‡æ˜¯ä¸å¯åˆ†å‰²çš„æ•´ä½“ã€‚
- ç­¾åæ¶ˆæ¯ä¸å¯ç¯¡æ”¹ï¼Œä»»æ„æ¯”ç‰¹æ•°æ®è¢«ç¯¡æ”¹ï¼Œå…¶ç­¾åä¾¿éšä¹‹æ”¹å˜ï¼Œä»»ä½•äººéƒ½å¯ä»¥ç»éªŒè¯è€Œæ‹’ç»æ¥å—æ­¤ç­¾åã€‚

#### æ ¸å¿ƒä»£ç ğŸ”–



### 52.5 å­—ç¬¦ç¼–ç ä¸è§£ç 

#### Base64

Base64æ˜¯ä¸€ç§åŸºäº64ä¸ªå¯æ‰“å°å­—ç¬¦æ¥è¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®çš„ç¼–ç æ–¹å¼ã€‚Base64ä½¿ç”¨äº†**26ä¸ªå°å†™å­—æ¯ã€26ä¸ªå¤§å†™å­—æ¯ã€10ä¸ªæ•°å­—ä»¥åŠ2ä¸ªç¬¦å·ï¼ˆå¦‚â€œ+â€å’Œâ€œ/â€ï¼‰**ï¼Œç”¨äºåœ¨ç”µå­é‚®ä»¶è¿™æ ·çš„åŸºäºæ–‡æœ¬çš„åª’ä»‹ä¸­ä¼ è¾“äºŒè¿›åˆ¶æ•°æ®ã€‚Base64é€šå¸¸ç”¨äºç¼–ç é‚®ä»¶ä¸­çš„é™„ä»¶ã€‚

Base64çš„ç¼–ç è¿‡ç¨‹:

![](images/image-20250109134356220.png)

æ­¥éª¤:

- å°†æ¯ä¸ªå­—ç¬¦è½¬æˆASCIIç¼–ç ï¼ˆåè¿›åˆ¶ï¼‰ã€‚
- å°†åè¿›åˆ¶ç¼–ç è½¬æˆäºŒè¿›åˆ¶ç¼–ç ã€‚
- å°†äºŒè¿›åˆ¶ç¼–ç æŒ‰ç…§6ä½ä¸€ç»„è¿›è¡Œå¹³åˆ†ã€‚
- å°†6ä½ä¸€ç»„çš„äºŒè¿›åˆ¶æ•°é«˜ä½è¡¥é›¶ï¼Œç„¶åè½¬æˆåè¿›åˆ¶æ•°ã€‚
- ä»¥åè¿›åˆ¶æ•°ä½œä¸ºç´¢å¼•ï¼Œä»Base64ç¼–ç è¡¨ä¸­æŸ¥æ‰¾å­—ç¬¦ã€‚
- æ¯3ä¸ªå­—ç¬¦çš„æ–‡æœ¬å°†ç¼–ç ä¸º4ä¸ªå­—ç¬¦é•¿åº¦ï¼ˆ3Ã—8=4Ã—6ï¼‰ã€‚è‹¥æ–‡æœ¬ä¸º3ä¸ªå­—ç¬¦ï¼Œåˆ™æ­£å¥½ç¼–ç ä¸º4ä¸ªå­—ç¬¦é•¿åº¦ï¼›è‹¥æ–‡æœ¬ä¸º2ä¸ªå­—ç¬¦ï¼Œåˆ™ç¼–ç ä¸º3ä¸ªå­—ç¬¦ï¼Œç”±äºä¸è¶³4ä¸ªå­—ç¬¦ï¼Œåˆ™åœ¨å°¾éƒ¨ç”¨ä¸€ä¸ªâ€œ=â€è¡¥é½ï¼›è‹¥æ–‡æœ¬ä¸º1ä¸ªå­—ç¬¦ï¼Œåˆ™ç¼–ç ä¸º2ä¸ªå­—ç¬¦ï¼Œç”±äºä¸è¶³4ä¸ªå­—ç¬¦ï¼Œåˆ™åœ¨å°¾éƒ¨ç”¨ä¸¤ä¸ªâ€œ=â€è¡¥é½ã€‚å¦‚å›¾13.15æ‰€ç¤ºã€‚

![](images/image-20250109134500738.png)

ğŸ”–

#### Base58

Base58æ˜¯ä¸€ç§åŸºäºæ–‡æœ¬çš„äºŒè¿›åˆ¶ç¼–ç æ–¹å¼ã€‚è¿™ç§ç¼–ç æ–¹å¼ä¸ä»…å®ç°äº†æ•°æ®å‹ç¼©ï¼Œä¿æŒäº†æ˜“è¯»æ€§ï¼Œè¿˜å…·æœ‰é”™è¯¯è¯Šæ–­åŠŸèƒ½ã€‚

==Base58æ˜¯Base64çš„å­é›†==ï¼ŒåŒæ ·ä½¿ç”¨å¤§å°å†™å­—æ¯å’Œ10ä¸ªæ•°å­—ï¼Œä½†èˆå¼ƒäº†ä¸€äº›å®¹æ˜“é”™è¯»å’Œåœ¨ç‰¹å®šå­—ä½“ä¸­å®¹æ˜“æ··æ·†çš„å­—ç¬¦ã€‚

Base58ä¸å«Base64ä¸­çš„**0ï¼ˆæ•°å­—0ï¼‰ã€Oï¼ˆå¤§å†™å­—æ¯Oï¼‰ã€lï¼ˆå°å†™å­—æ¯lï¼‰ã€Iï¼ˆå¤§å†™å­—æ¯Iï¼‰ï¼Œä»¥åŠâ€œ+â€å’Œâ€œ/â€ä¸¤ä¸ªå­—ç¬¦**ï¼Œç›®çš„å°±æ˜¯å»é™¤å®¹æ˜“æ··æ·†çš„å­—ç¬¦ã€‚ç®€è€Œè¨€ä¹‹ï¼ŒBase58ç”±ä¸åŒ…æ‹¬â€œ0â€â€œOâ€â€œlâ€â€œIâ€çš„å¤§å°å†™å­—æ¯å’Œæ•°å­—ç»„æˆã€‚

base58ç¼–ç çš„æ•´ä½“æ­¥éª¤å°±æ˜¯ä¸æ–­å°†æ•°å€¼å¯¹58å–æ¨¡ï¼Œå¦‚æœå•†å¤§äº58ï¼Œåˆ™å¯¹å•†ç»§ç»­å–æ¨¡ã€‚ä»¥å­—ç¬¦ä¸²â€œaâ€ä¸ºä¾‹ã€‚åœ¨ASCIIç ä¸­ï¼Œâ€œaâ€å¯¹åº”çš„åè¿›åˆ¶æ•°ä¸º97ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ã€‚

- 97å¯¹58å–æ¨¡ï¼Œä½™æ•°ä¸º39ï¼Œå•†ä¸º1ã€‚
- base58å­—ç¬¦é›†ä¸­ï¼Œç´¢å¼•ä¸‹æ ‡39ä¸ºgã€‚
- base58å­—ç¬¦é›†ä¸­ï¼Œç´¢å¼•ä¸‹æ ‡1ä¸º2ã€‚
- å¾—åˆ°ç»“æœä¸ºï¼šg2ã€‚
- ååºåˆ—åŒ–åä¸ºï¼š2gã€‚

ä»¥å­—ç¬¦ä¸²â€œabâ€ä¸ºä¾‹ã€‚â€œabâ€è½¬åå…­è¿›åˆ¶ä¸º6162ï¼Œå†è½¬åè¿›åˆ¶ä¸º24930ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ã€‚

- 24930å¯¹58å–æ¨¡ï¼Œä½™æ•°ä¸º48ï¼Œå•†ä¸º429ã€‚
- base58å­—ç¬¦é›†ä¸­ï¼Œç´¢å¼•ä¸‹æ ‡48ä¸ºqã€‚
- 429å¯¹58å–æ¨¡ï¼Œä½™æ•°ä¸º23ï¼Œå•†ä¸º7ã€‚
- base58å­—ç¬¦é›†ä¸­ï¼Œç´¢å¼•ä¸‹æ ‡23ä¸ºQã€‚
- base58å­—ç¬¦é›†ä¸­ï¼Œç´¢å¼•ä¸‹æ ‡7ä¸º8ã€‚
- å¾—åˆ°ç»“æœä¸ºï¼šqQ8ã€‚
- ååºåˆ—åŒ–åä¸ºï¼š8Qqã€‚

ğŸ”–

# æµ‹è¯•ã€æ€§èƒ½å‰–æä¸è°ƒè¯•

å‚è€ƒï¼šã€ŠGoè¯­è¨€ç²¾è¿›ä¹‹è·¯2ã€‹

## 53 ç†è§£åŒ…å†…æµ‹è¯•ä¸åŒ…å¤–æµ‹è¯•çš„å·®åˆ«

æµ‹è¯•ä»£ç ä¸åŒ…ä»£ç æ”¾åœ¨åŒä¸€ä¸ªåŒ…ç›®å½•ä¸‹ï¼Œå¹¶ä¸”Goè¦æ±‚æ‰€æœ‰æµ‹è¯•ä»£ç éƒ½å­˜æ”¾åœ¨ä»¥`*_test.go`ç»“å°¾çš„æ–‡ä»¶ä¸­ã€‚è¿™ä½¿Goå¼€å‘äººå‘˜ä¸€çœ¼å°±èƒ½åˆ†è¾¨å‡ºå“ªäº›æ–‡ä»¶å­˜æ”¾çš„æ˜¯==åŒ…ä»£ç ==ï¼Œå“ªäº›æ–‡ä»¶å­˜æ”¾çš„æ˜¯é’ˆå¯¹è¯¥åŒ…çš„==æµ‹è¯•ä»£ç ==ã€‚

`go test`å°†æ‰€æœ‰åŒ…ç›®å½•ä¸‹çš„`*_test.go`æ–‡ä»¶ç¼–è¯‘æˆä¸€ä¸ªä¸´æ—¶äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå¯ä»¥é€šè¿‡`go test -c`æ˜¾å¼ç¼–è¯‘å‡ºè¯¥æ–‡ä»¶ï¼‰ï¼Œå¹¶æ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œåè€…å°†æ‰§è¡Œå„ä¸ªæµ‹è¯•æºæ–‡ä»¶ä¸­åå­—æ ¼å¼ä¸º`TestXxx`çš„å‡½æ•°æ‰€ä»£è¡¨çš„æµ‹è¯•ç”¨ä¾‹å¹¶è¾“å‡ºæµ‹è¯•æ‰§è¡Œç»“æœã€‚

### å®˜æ–¹æ–‡æ¡£çš„â€œè‡ªç›¸çŸ›ç›¾â€

GoåŸç”Ÿæ”¯æŒæµ‹è¯•çš„ä¸¤å¤§è¦ç´ â€”â€”go testå‘½ä»¤å’ŒtestingåŒ…ã€‚

testingåŒ…çš„ä¸€æ®µå®˜æ–¹æ–‡æ¡£ï¼ˆGo 1.14ç‰ˆæœ¬ï¼‰æ‘˜å½•ï¼š

> è¦ç¼–å†™ä¸€ä¸ªæ–°çš„æµ‹è¯•é›†ï¼ˆtest suiteï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªåŒ…å«`TestXxx`å‡½æ•°çš„ä»¥_test.goä¸ºæ–‡ä»¶åç»“å°¾çš„æ–‡ä»¶ã€‚å°†è¿™ä¸ªæµ‹è¯•æ–‡ä»¶æ”¾åœ¨ä¸è¢«æµ‹è¯•åŒ…ç›¸åŒçš„åŒ…ä¸‹é¢ã€‚ç¼–è¯‘è¢«æµ‹è¯•åŒ…æ—¶ï¼Œè¯¥æ–‡ä»¶å°†è¢«æ’é™¤åœ¨å¤–ï¼›æ‰§è¡Œgo testæ—¶ï¼Œè¯¥æ–‡ä»¶å°†è¢«åŒ…å«åœ¨å†…ã€‚

go testå‘½ä»¤å®˜æ–¹æ–‡æ¡£ï¼š

> é‚£äº›åŒ…åä¸­å¸¦æœ‰_teståç¼€çš„æµ‹è¯•æ–‡ä»¶å°†è¢«ç¼–è¯‘æˆä¸€ä¸ªç‹¬ç«‹çš„åŒ…ï¼Œè¿™ä¸ªåŒ…ä¹‹åä¼šè¢«é“¾æ¥åˆ°ä¸»æµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å¹¶è¿è¡Œã€‚



â€œè‡ªç›¸çŸ›ç›¾â€çš„åœ°æ–¹ï¼štestingåŒ…æ–‡æ¡£å‘Šè¯‰æˆ‘ä»¬å°†æµ‹è¯•ä»£ç æ”¾å…¥ä¸è¢«æµ‹è¯•åŒ…åŒåçš„åŒ…ä¸­ï¼Œè€Œgo testå‘½ä»¤è¡Œå¸®åŠ©æ–‡æ¡£åˆ™æåˆ°ä¼šå°†åŒ…åä¸­å¸¦æœ‰_teståç¼€çš„æµ‹è¯•æ–‡ä»¶ç¼–è¯‘æˆä¸€ä¸ªç‹¬ç«‹çš„åŒ…ã€‚

ä¾‹å­æ¥ç›´è§‚è¯´æ˜ä¸€ä¸‹è¿™ä¸ªâ€œçŸ›ç›¾â€ï¼š

> å¦‚æœæˆ‘ä»¬è¦æµ‹è¯•çš„åŒ…ä¸ºfooï¼ŒtestingåŒ…çš„å¸®åŠ©æ–‡æ¡£å‘Šè¯‰æˆ‘ä»¬æŠŠå¯¹fooåŒ…çš„æµ‹è¯•ä»£ç **æ”¾åœ¨åŒ…åä¸ºfooçš„æµ‹è¯•æ–‡ä»¶**ä¸­ï¼›
>
> è€Œgo testå‘½ä»¤è¡Œå¸®åŠ©æ–‡æ¡£åˆ™å‘Šè¯‰æˆ‘ä»¬æŠŠfooåŒ…çš„æµ‹è¯•ä»£ç **æ”¾åœ¨åŒ…åä¸ºfoo_testçš„æµ‹è¯•æ–‡ä»¶**ä¸­ã€‚

å°†æµ‹è¯•ä»£ç æ”¾åœ¨ä¸è¢«æµ‹åŒ…åŒåçš„åŒ…ä¸­çš„æµ‹è¯•æ–¹æ³•ç§°ä¸ºâ€œ==åŒ…å†…æµ‹è¯•==â€ï¼š

```sh
$ go list -f={{.TestGoFiles}} . 
```

å°†æµ‹è¯•ä»£ç æ”¾åœ¨åä¸ºè¢«æµ‹åŒ…åŒ…å+"_test"çš„åŒ…ä¸­çš„æµ‹è¯•æ–¹æ³•ç§°ä¸ºâ€œ==åŒ…å¤–æµ‹è¯•==â€:

```sh
$ go list -f={{.XTestGoFiles}} .
```

```sh
$ cd cd /usr/local/go/src/sync
$ go list -f={{.TestGoFiles}} . 
[export_test.go]
$ go list -f={{.XTestGoFiles}} .
[cond_test.go example_pool_test.go example_test.go map_bench_test.go map_reference_test.go map_test.go mutex_test.go once_test.go oncefunc_test.go pool_test.go runtime_sema_test.go rwmutex_test.go waitgroup_test.go]
```



### åŒ…å†…æµ‹è¯•ä¸åŒ…å¤–æµ‹è¯•

#### Goæ ‡å‡†åº“ä¸­åŒ…å†…æµ‹è¯•å’ŒåŒ…å¤–æµ‹è¯•çš„ä½¿ç”¨æƒ…å†µ

```sh
// ç»Ÿè®¡æ ‡å‡†åº“ä¸­é‡‡ç”¨åŒ…å†…æµ‹è¯•çš„æµ‹è¯•æ–‡ä»¶æ•°é‡
$ find /usr/local/go/src  -name "*_test.go" | xargs grep package | grep ':package' | grep -v "_test$" | wc -l
    1019


// ç»Ÿè®¡æ ‡å‡†åº“ä¸­é‡‡ç”¨åŒ…å¤–æµ‹è¯•çš„æµ‹è¯•æ–‡ä»¶æ•°é‡
$ find /usr/local/go/src  -name "*_test.go" | xargs grep package | grep ':package' | grep  "_test$" | wc -l 
     658
```



#### åŒ…å†…æµ‹è¯•çš„ä¼˜åŠ¿ä¸ä¸è¶³

ç”±äºGoæ„å»ºå·¥å…·é“¾åœ¨ç¼–è¯‘åŒ…æ—¶ä¼šè‡ªåŠ¨æ ¹æ®æ–‡ä»¶åæ˜¯å¦å…·æœ‰_test.goåç¼€å°†åŒ…æºæ–‡ä»¶å’ŒåŒ…çš„æµ‹è¯•æºæ–‡ä»¶åˆ†å¼€ï¼Œæµ‹è¯•ä»£ç ä¸ä¼šè¿›å…¥åŒ…æ­£å¸¸æ„å»ºçš„èŒƒç•´ï¼Œå› æ­¤æµ‹è¯•ä»£ç ä½¿ç”¨ä¸è¢«æµ‹åŒ…åç›¸åŒçš„åŒ…å†…æµ‹è¯•æ–¹æ³•æ˜¯ä¸€ä¸ªå¾ˆè‡ªç„¶çš„é€‰æ‹©ã€‚

åŒ…å†…æµ‹è¯•è¿™ç§æ–¹æ³•æœ¬è´¨ä¸Šæ˜¯ä¸€ç§==ç™½ç›’æµ‹è¯•==æ–¹æ³•ã€‚ç”±äºæµ‹è¯•ä»£ç ä¸è¢«æµ‹åŒ…æºç åœ¨åŒä¸€åŒ…åä¸‹ï¼Œæµ‹è¯•ä»£ç å¯ä»¥è®¿é—®è¯¥åŒ…ä¸‹çš„æ‰€æœ‰ç¬¦å·ï¼Œæ— è®ºæ˜¯å¯¼å‡ºç¬¦å·è¿˜æ˜¯æœªå¯¼å‡ºç¬¦å·ï¼›å¹¶ä¸”ç”±äºåŒ…çš„å†…éƒ¨å®ç°é€»è¾‘å¯¹æµ‹è¯•ä»£ç æ˜¯é€æ˜çš„ï¼ŒåŒ…å†…æµ‹è¯•**å¯ä»¥æ›´ä¸ºç›´æ¥åœ°æ„é€ æµ‹è¯•æ•°æ®å’Œå®æ–½æµ‹è¯•é€»è¾‘**ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°è¾¾åˆ°è¾ƒé«˜çš„æµ‹è¯•è¦†ç›–ç‡ã€‚å› æ­¤å¯¹äºè¿½æ±‚é«˜æµ‹è¯•è¦†ç›–ç‡çš„é¡¹ç›®è€Œè¨€ï¼ŒåŒ…å†…æµ‹è¯•æ˜¯ä¸äºŒä¹‹é€‰ã€‚

ğŸ”–





## 54 æœ‰å±‚æ¬¡åœ°ç»„ç»‡æµ‹è¯•ä»£ç 

### 54.1 ç»å…¸æ¨¡å¼â€”â€”å¹³é“º

go testå¹¶æ²¡æœ‰å¯¹æµ‹è¯•ä»£ç çš„ç»„ç»‡æå‡ºä»»ä½•çº¦æŸæ¡ä»¶ã€‚

ä»¥æ ‡å‡†åº“stringsåŒ…ä¸ºä¾‹ï¼š

```sh
cd /usr/local/go/src/strings
go test -v .
=== RUN   TestBuilder
--- PASS: TestBuilder (0.00s)
=== RUN   TestBuilderString
--- PASS: TestBuilderString (0.00s)
=== RUN   TestBuilderReset
--- PASS: TestBuilderReset (0.00s)
=== RUN   TestBuilderGrow
--- PASS: TestBuilderGrow (0.00s)
=== RUN   TestBuilderWrite2
=== RUN   TestBuilderWrite2/Write
=== RUN   TestBuilderWrite2/WriteRune
=== RUN   TestBuilderWrite2/WriteRuneWide
=== RUN   TestBuilderWrite2/WriteString
--- PASS: TestBuilderWrite2 (0.00s)
    --- PASS: TestBuilderWrite2/Write (0.00s)
    --- PASS: TestBuilderWrite2/WriteRune (0.00s)
    --- PASS: TestBuilderWrite2/WriteRuneWide (0.00s)
    --- PASS: TestBuilderWrite2/WriteString (0.00s)
=== RUN   TestBuilderWriteByte
--- PASS: TestBuilderWriteByte (0.00s)
=== RUN   TestBuilderAllocs
--- PASS: TestBuilderAllocs (0.00s)
=== RUN   TestBuilderCopyPanic
--- PASS: TestBuilderCopyPanic (0.00s)
=== RUN   TestBuilderWriteInvalidRune
--- PASS: TestBuilderWriteInvalidRune (0.00s)
=== RUN   TestClone
--- PASS: TestClone (0.00s)

...
=== RUN   ExampleTrim
--- PASS: ExampleTrim (0.00s)
=== RUN   ExampleTrimSpace
--- PASS: ExampleTrimSpace (0.00s)
=== RUN   ExampleTrimPrefix
--- PASS: ExampleTrimPrefix (0.00s)
=== RUN   ExampleTrimSuffix
--- PASS: ExampleTrimSuffix (0.00s)
=== RUN   ExampleTrimFunc
--- PASS: ExampleTrimFunc (0.00s)
=== RUN   ExampleTrimLeft
--- PASS: ExampleTrimLeft (0.00s)
=== RUN   ExampleTrimLeftFunc
--- PASS: ExampleTrimLeftFunc (0.00s)
=== RUN   ExampleTrimRight
--- PASS: ExampleTrimRight (0.00s)
=== RUN   ExampleTrimRightFunc
--- PASS: ExampleTrimRightFunc (0.00s)
=== RUN   ExampleToValidUTF8
--- PASS: ExampleToValidUTF8 (0.00s)
PASS
ok      strings 1.100s

```

ä»¥stringsåŒ…çš„Compareå‡½æ•°ä¸ºä¾‹ï¼Œä¸ä¹‹å¯¹åº”çš„æµ‹è¯•å‡½æ•°æœ‰ä¸‰ä¸ªï¼šTestCompareã€TestCompareIdenticalStringå’ŒTestCompareStringsã€‚è¿™äº›æµ‹è¯•å‡½æ•°å„è‡ªç‹¬ç«‹ï¼Œæµ‹è¯•å‡½æ•°ä¹‹é—´æ²¡æœ‰å±‚çº§å…³ç³»ï¼Œ**æ‰€æœ‰æµ‹è¯•å¹³é“ºåœ¨é¡¶å±‚**ã€‚æµ‹è¯•å‡½æ•°åç§°**æ—¢ç”¨æ¥åŒºåˆ†æµ‹è¯•ï¼Œåˆç”¨æ¥å…³è”æµ‹è¯•**ã€‚

æˆ‘ä»¬é€šè¿‡æµ‹è¯•å‡½æ•°åçš„å‰ç¼€æ‰ä¼šçŸ¥é“ï¼ŒTestCompareã€TestCompareIdenticalStringå’ŒTestCompareStringsä¸‰ä¸ªå‡½æ•°æ˜¯é’ˆå¯¹stringsåŒ…Compareå‡½æ•°çš„æµ‹è¯•ã€‚

é€‰é¡¹-runæä¾›æ­£åˆ™è¡¨è¾¾å¼æ¥åŒ¹é…å¹¶é€‰æ‹©æ‰§è¡Œå“ªäº›æµ‹è¯•å‡½æ•°ã€‚

```sh
$ go test -run=TestCompare -v .
=== RUN   TestCompare
--- PASS: TestCompare (0.00s)
=== RUN   TestCompareIdenticalString
--- PASS: TestCompareIdenticalString (0.00s)
=== RUN   TestCompareStrings
--- PASS: TestCompareStrings (0.00s)
PASS
ok    strings     0.088s
```



å¹³é“ºæ¨¡å¼çš„æµ‹è¯•ä»£ç ç»„ç»‡æ–¹å¼çš„ä¼˜ç‚¹æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚

- ç®€å•ï¼šæ²¡æœ‰é¢å¤–çš„æŠ½è±¡ï¼Œä¸Šæ‰‹å®¹æ˜“ã€‚
- ç‹¬ç«‹ï¼šæ¯ä¸ªæµ‹è¯•å‡½æ•°éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œäº’ä¸å…³è”ï¼Œé¿å…ç›¸äº’å¹²æ‰°ã€‚

### 54.2 xUnitå®¶æ—æ¨¡å¼

åœ¨Javaã€Pythonã€C#ç­‰ä¸»æµç¼–ç¨‹è¯­è¨€ä¸­ï¼Œæµ‹è¯•ä»£ç çš„ç»„ç»‡å½¢å¼æ·±å—ç”±æé™ç¼–ç¨‹å€¡å¯¼è€…Kent Beckå’ŒErich Gammaå»ºç«‹çš„xUnitå®¶æ—æµ‹è¯•æ¡†æ¶ï¼ˆå¦‚JUnitã€PyUnitç­‰ï¼‰çš„å½±å“ã€‚

![](images/image-20250309224913768.png)

è¿™ç§æµ‹è¯•ä»£ç ç»„ç»‡å½¢å¼ä¸»è¦æœ‰==æµ‹è¯•å¥—ä»¶ï¼ˆTest Suiteï¼‰==å’Œ==æµ‹è¯•ç”¨ä¾‹ï¼ˆTest Caseï¼‰==ä¸¤ä¸ªå±‚çº§ã€‚

ä¸€ä¸ª**æµ‹è¯•å·¥ç¨‹ï¼ˆTest Projectï¼‰**ç”±è‹¥å¹²ä¸ªæµ‹è¯•å¥—ä»¶ç»„æˆï¼Œè€Œæ¯ä¸ªæµ‹è¯•å¥—ä»¶åˆåŒ…å«å¤šä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚

Go 1.7ä¸­åŠ å…¥çš„å¯¹subtestçš„æ”¯æŒè®©æˆ‘ä»¬åœ¨Goä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸Šé¢è¿™ç§æ–¹å¼ç»„ç»‡Goæµ‹è¯•ä»£ç ã€‚ä¹‹å‰ç‰ˆæœ¬ä¸å¯ä»¥ã€‚å¯¹æ ‡å‡†åº“stringsåŒ…çš„éƒ¨åˆ†æµ‹è¯•ä»£ç ç»„ç»‡å½¢å¼æ”¹é€ ä¸€ä¸‹ï¼š

```go
// ch54/compare_test.go

package strings_test

...

func testCompare(t *testing.T) {
	...
}

func testCompareIdenticalString(t *testing.T) {
	...
}

func testCompareStrings(t *testing.T) {
	...
}

func TestCompare(t *testing.T) {
	t.Run("Compare", testCompare)
	t.Run("CompareString", testCompareStrings)
	t.Run("CompareIdenticalString", testCompareIdenticalString)
}

// ch54/builder_test.go

package strings_test

...

func check(t *testing.T, b *strings.Builder, want string) {
	...
}

func testBuilder(t *testing.T) {
	...
}

func testBuilderString(t *testing.T) {
	...
}

func testBuilderReset(t *testing.T) {
	...
}

func testBuilderGrow(t *testing.T) {
	...
}

func TestBuilder(t *testing.T) {
	t.Run("TestBuilder", testBuilder)
	t.Run("TestBuilderString", testBuilderString)
	t.Run("TestBuilderReset", testBuilderReset)
	t.Run("TestBuilderGrow", testBuilderGrow)
}

```

æ”¹é€ å‰åæµ‹è¯•ä»£ç çš„ç»„ç»‡ç»“æ„å¯¹æ¯”:

![](images/image-20250413101147104.png)

æ”¹é€ åçš„åå­—å½¢å¦‚TestXxxçš„æµ‹è¯•å‡½æ•°å¯¹åº”ç€æµ‹è¯•å¥—ä»¶ï¼Œä¸€èˆ¬é’ˆå¯¹è¢«æµ‹åŒ…çš„ä¸€ä¸ªå¯¼å‡ºå‡½æ•°æˆ–æ–¹æ³•çš„æ‰€æœ‰æµ‹è¯•éƒ½æ”¾å…¥ä¸€ä¸ªæµ‹è¯•å¥—ä»¶ä¸­ã€‚å¹³é“ºæ¨¡å¼ä¸‹çš„æµ‹è¯•å‡½æ•°TestXxxéƒ½æ”¹åä¸ºtestXxxï¼Œå¹¶ä½œä¸ºæµ‹è¯•å¥—ä»¶å¯¹åº”çš„æµ‹è¯•å‡½æ•°å†…éƒ¨çš„å­æµ‹è¯•ï¼ˆsubtestï¼‰ã€‚

åŸå…ˆçš„TestBuilderStringå˜ä¸ºäº†testBuilderStringã€‚è¿™æ ·çš„ä¸€ä¸ªå­æµ‹è¯•ç­‰ä»·äºä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚

é€šè¿‡å¯¹æ¯”ï¼Œä»…é€šè¿‡æŸ¥çœ‹æµ‹è¯•å¥—ä»¶å†…çš„å­æµ‹è¯•ï¼ˆæµ‹è¯•ç”¨ä¾‹ï¼‰å³å¯å…¨é¢äº†è§£åˆ°ç©¶ç«Ÿå¯¹è¢«æµ‹å‡½æ•°/æ–¹æ³•è¿›è¡Œäº†å“ªäº›æµ‹è¯•ã€‚ä»…ä»…å¢åŠ äº†ä¸€ä¸ªå±‚æ¬¡ï¼Œæµ‹è¯•ä»£ç çš„ç»„ç»‡å°±æ›´åŠ æ¸…æ™°äº†ã€‚



### 54.3 æµ‹è¯•å›ºä»¶

==æµ‹è¯•å›ºä»¶ï¼ˆtest fixtureï¼‰==æ˜¯æŒ‡ä¸€ä¸ªäººé€ çš„ã€ç¡®å®šæ€§çš„ç¯å¢ƒï¼Œä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹æˆ–ä¸€ä¸ªæµ‹è¯•å¥—ä»¶ï¼ˆä¸‹çš„ä¸€ç»„æµ‹è¯•ç”¨ä¾‹ï¼‰åœ¨è¿™ä¸ªç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ï¼Œå…¶æµ‹è¯•ç»“æœæ˜¯å¯é‡å¤çš„ï¼ˆå¤šæ¬¡æµ‹è¯•è¿è¡Œçš„ç»“æœæ˜¯ç›¸åŒçš„ï¼‰ã€‚

ä¸€èˆ¬ä½¿ç”¨`setUp`å’Œ`tearDown`æ¥ä»£è¡¨æµ‹è¯•å›ºä»¶çš„**åˆ›å»º/è®¾ç½®ä¸æ‹†é™¤/é”€æ¯**çš„åŠ¨ä½œã€‚

ä½¿ç”¨æµ‹è¯•å›ºä»¶çš„å¸¸è§åœºæ™¯ï¼š

- å°†ä¸€ç»„å·²çŸ¥çš„ç‰¹å®šæ•°æ®åŠ è½½åˆ°æ•°æ®åº“ä¸­ï¼Œæµ‹è¯•ç»“æŸåæ¸…é™¤è¿™äº›æ•°æ®ï¼›
- å¤åˆ¶ä¸€ç»„ç‰¹å®šçš„å·²çŸ¥æ–‡ä»¶ï¼Œæµ‹è¯•ç»“æŸåæ¸…é™¤è¿™äº›æ–‡ä»¶ï¼›
- åˆ›å»ºä¼ªå¯¹è±¡ï¼ˆfake objectï¼‰æˆ–æ¨¡æ‹Ÿå¯¹è±¡ï¼ˆmock objectï¼‰ï¼Œå¹¶ä¸ºè¿™äº›å¯¹è±¡è®¾å®šæµ‹è¯•æ—¶æ‰€éœ€çš„ç‰¹å®šæ•°æ®å’ŒæœŸæœ›ç»“æœã€‚



```go
func setUp(testName string) func() {
	fmt.Printf("\tsetUp fixture for %s\n", testName)
	return func() {
		fmt.Printf("\ttearDown fixture for %s\n", testName)
	}
}

func TestFunc1(t *testing.T) {
	defer setUp(t.Name())()
	fmt.Printf("\tExecute test: %s\n", t.Name())
}

func TestFunc2(t *testing.T) {
	defer setUp(t.Name())()
	fmt.Printf("\tExecute test: %s\n", t.Name())
}

func TestFunc3(t *testing.T) {
	defer setUp(t.Name())()
	fmt.Printf("\tExecute test: %s\n", t.Name())
}
```

```sh
$ go test -v classic_testfixture_test.go 
=== RUN   TestFunc1
        setUp fixture for TestFunc1
        Execute test: TestFunc1
        tearDown fixture for TestFunc1
--- PASS: TestFunc1 (0.00s)
=== RUN   TestFunc2
        setUp fixture for TestFunc2
        Execute test: TestFunc2
        tearDown fixture for TestFunc2
--- PASS: TestFunc2 (0.00s)
=== RUN   TestFunc3
        setUp fixture for TestFunc3
        Execute test: TestFunc3
        tearDown fixture for TestFunc3
--- PASS: TestFunc3 (0.00s)
PASS
ok      command-line-arguments  0.438s
```

ä¸Šé¢çš„ç¤ºä¾‹**åœ¨è¿è¡Œæ¯ä¸ªæµ‹è¯•å‡½æ•°TestXxxæ—¶ï¼Œéƒ½ä¼šå…ˆé€šè¿‡setUpå‡½æ•°å»ºç«‹æµ‹è¯•å›ºä»¶ï¼Œå¹¶åœ¨deferå‡½æ•°ä¸­æ³¨å†Œæµ‹è¯•å›ºä»¶çš„é”€æ¯å‡½æ•°ï¼Œä»¥ä¿è¯åœ¨æ¯ä¸ªTestXxxæ‰§è¡Œå®Œæ¯•æ—¶ä¸ºä¹‹å»ºç«‹çš„æµ‹è¯•å›ºä»¶ä¼šè¢«é”€æ¯ï¼Œä½¿å¾—å„ä¸ªæµ‹è¯•å‡½æ•°ä¹‹é—´çš„æµ‹è¯•æ‰§è¡Œäº’ä¸å¹²æ‰°ã€‚**

åœ¨Go 1.14ç‰ˆæœ¬ä»¥å‰ï¼Œæµ‹è¯•å›ºä»¶çš„setUpä¸tearDownä¸€èˆ¬å®ç°æ ¼å¼ï¼š

```go
func setUp() func() {
	...
	return func() {
	}
}

func TestXxx(t *testing.T) {
	defer setUp()()
	...
}
```

åœ¨setUpä¸­è¿”å›åŒ¿åå‡½æ•°æ¥å®ç°tearDownçš„å¥½å¤„æ˜¯ï¼Œå¯ä»¥åœ¨setUpä¸­åˆ©ç”¨é—­åŒ…ç‰¹æ€§åœ¨ä¸¤ä¸ªå‡½æ•°é—´å…±äº«ä¸€äº›å˜é‡ï¼Œé¿å…äº†åŒ…çº§å˜é‡çš„ä½¿ç”¨ã€‚

Go 1.14ç‰ˆæœ¬testingåŒ…å¢åŠ äº†testing.Cleanupæ–¹æ³•ï¼Œä¸ºæµ‹è¯•å›ºä»¶çš„é”€æ¯æä¾›äº†åŒ…çº§åŸç”Ÿçš„æ”¯æŒï¼š

```go
func setUp() func() {
	...
	return func() {
	}
}

func TestXxx(t *testing.T) {
  t.Cleanup(setUp())
	...
}
```

æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å°†æ‰€æœ‰æµ‹è¯•å‡½æ•°æ”¾å…¥ä¸€ä¸ªæ›´å¤§èŒƒå›´çš„æµ‹è¯•å›ºä»¶ç¯å¢ƒä¸­æ‰§è¡Œï¼Œè¿™å°±æ˜¯==åŒ…çº§åˆ«æµ‹è¯•å›ºä»¶==ã€‚åœ¨Go 1.4ç‰ˆæœ¬ä»¥å‰ï¼Œæˆ‘ä»¬ä»…èƒ½åœ¨initå‡½æ•°ä¸­åˆ›å»ºæµ‹è¯•å›ºä»¶ï¼Œè€Œæ— æ³•é”€æ¯åŒ…çº§åˆ«æµ‹è¯•å›ºä»¶ã€‚Go 1.4ç‰ˆæœ¬å¼•å…¥äº†TestMainï¼Œä½¿å¾—åŒ…çº§åˆ«æµ‹è¯•å›ºä»¶çš„åˆ›å»ºå’Œé”€æ¯ç»ˆäºæœ‰äº†æ­£å¼çš„æ–½å±•èˆå°ã€‚ç¤ºä¾‹ï¼š

```go
// åŒ…çº§åˆ«æµ‹è¯•å›ºä»¶

// Go 1.14ç‰ˆæœ¬testingåŒ…å¢åŠ äº†testing.Cleanupæ–¹æ³•ï¼Œä¸ºæµ‹è¯•å›ºä»¶çš„é”€æ¯æä¾›äº†åŒ…çº§åŸç”Ÿçš„æ”¯æŒ
// Go 1.4ç‰ˆæœ¬å¼•å…¥äº†TestMainï¼Œä½¿å¾—åŒ…çº§åˆ«æµ‹è¯•å›ºä»¶çš„åˆ›å»ºå’Œé”€æ¯ç»ˆäºæœ‰äº†æ­£å¼çš„æ–½å±•èˆå°ã€‚

func setUp(testName string) func() {
	fmt.Printf("\tsetUp fixture for %s\n", testName)
	return func() {
		fmt.Printf("\ttearDown fixture for %s\n", testName)
	}
}

func TestFunc1(t *testing.T) {
	t.Cleanup(setUp(t.Name()))
	fmt.Printf("\tExecute test: %s\n", t.Name())
}

func TestFunc2(t *testing.T) {
	t.Cleanup(setUp(t.Name()))
	fmt.Printf("\tExecute test: %s\n", t.Name())
}

func TestFunc3(t *testing.T) {
	t.Cleanup(setUp(t.Name()))
	fmt.Printf("\tExecute test: %s\n", t.Name())
}

func pkgSetUp(pkgName string) func() {
	fmt.Printf("package SetUp fixture for %s\n", pkgName)
	return func() {
		fmt.Printf("package TearDown fixture for %s\n", pkgName)
	}
}

func TestMain(m *testing.M) {
	defer pkgSetUp("package demo_test")()
	m.Run()
}
```

```sh
$ go test -v classic_package_level_testfixture_test.go 
package SetUp fixture for package demo_test
=== RUN   TestFunc1
        setUp fixture for TestFunc1
        Execute test: TestFunc1
        tearDown fixture for TestFunc1
--- PASS: TestFunc1 (0.00s)
=== RUN   TestFunc2
        setUp fixture for TestFunc2
        Execute test: TestFunc2
        tearDown fixture for TestFunc2
--- PASS: TestFunc2 (0.00s)
=== RUN   TestFunc3
        setUp fixture for TestFunc3
        Execute test: TestFunc3
        tearDown fixture for TestFunc3
--- PASS: TestFunc3 (0.00s)
PASS
package TearDown fixture for package demo_test
ok      command-line-arguments  0.470s

```

ç»“æœæ˜¾ç¤ºï¼Œ**åœ¨æ‰€æœ‰æµ‹è¯•å‡½æ•°è¿è¡Œä¹‹å‰ï¼ŒåŒ…çº§åˆ«æµ‹è¯•å›ºä»¶è¢«åˆ›å»ºï¼›åœ¨æ‰€æœ‰æµ‹è¯•å‡½æ•°è¿è¡Œå®Œæ¯•åï¼ŒåŒ…çº§åˆ«æµ‹è¯•å›ºä»¶è¢«é”€æ¯**ã€‚

ç”¨å›¾æ¥æ€»ç»“ï¼ˆå¸¦æµ‹è¯•å›ºä»¶çš„ï¼‰å¹³é“ºæ¨¡å¼ä¸‹çš„æµ‹è¯•æ‰§è¡Œæµã€‚

![](images/image-20250801174006639.png)



æœ‰äº›æ—¶å€™ï¼Œä¸€äº›æµ‹è¯•å‡½æ•°æ‰€éœ€çš„æµ‹è¯•å›ºä»¶æ˜¯ç›¸åŒçš„ï¼Œåœ¨å¹³é“ºæ¨¡å¼ä¸‹ä¸ºæ¯ä¸ªæµ‹è¯•å‡½æ•°éƒ½å•ç‹¬åˆ›å»º/é”€æ¯ä¸€æ¬¡æµ‹è¯•å›ºä»¶å°±æ˜¾å¾—æœ‰äº›é‡å¤å’Œå†—ä½™ã€‚åœ¨è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•é‡‡ç”¨æµ‹è¯•å¥—ä»¶æ¥å‡å°‘æµ‹è¯•å›ºä»¶çš„é‡å¤åˆ›å»ºã€‚

![](images/image-20250801174452469.png)

## 55 ä¼˜å…ˆç¼–å†™è¡¨é©±åŠ¨çš„æµ‹è¯•

å‰ä¸¤ç« ä¸­ï¼Œæ˜ç¡®äº†**æµ‹è¯•ä»£ç æ”¾ç½®çš„ä½ç½®ï¼ˆåŒ…å†…æµ‹è¯•æˆ–åŒ…å¤–æµ‹è¯•ï¼‰ä»¥åŠå¦‚ä½•æ ¹æ®å®é™…æƒ…å†µæ›´æœ‰å±‚æ¬¡åœ°ç»„ç»‡æµ‹è¯•ä»£ç **ã€‚

è¿™ç« å°†èšç„¦äº**æµ‹è¯•å‡½æ•°çš„å†…éƒ¨ä»£ç è¯¥å¦‚ä½•ç¼–å†™**ã€‚

### 55.1 Goæµ‹è¯•ä»£ç çš„ä¸€èˆ¬é€»è¾‘

Goçš„æµ‹è¯•å‡½æ•°å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„Goå‡½æ•°ï¼ŒGoä»…å¯¹æµ‹è¯•å‡½æ•°çš„**å‡½æ•°åå’Œå‡½æ•°åŸå‹**æœ‰ç‰¹å®šè¦æ±‚ï¼Œå¯¹åœ¨æµ‹è¯•å‡½æ•°`TestXxx`æˆ–å…¶å­æµ‹è¯•å‡½æ•°ï¼ˆsubtestï¼‰ä¸­å¦‚ä½•ç¼–å†™æµ‹è¯•é€»è¾‘å¹¶æ²¡æœ‰æ˜¾å¼çš„çº¦æŸã€‚

å¯¹æµ‹è¯•å¤±è´¥ä¸å¦çš„åˆ¤æ–­åœ¨äºæµ‹è¯•ä»£ç é€»è¾‘æ˜¯å¦è¿›å…¥äº†åŒ…å«`Error/Errorf`ã€`Fatal/Fatalf`ç­‰æ–¹æ³•è°ƒç”¨çš„ä»£ç åˆ†æ”¯ã€‚ä¸€æ—¦è¿›å…¥è¿™äº›åˆ†æ”¯ï¼Œå³ä»£è¡¨è¯¥æµ‹è¯•å¤±è´¥ã€‚ä¸åŒçš„æ˜¯Error/Errorfå¹¶ä¸ä¼šç«‹åˆ»ç»ˆæ­¢å½“å‰goroutineçš„æ‰§è¡Œï¼Œè¿˜ä¼šç»§ç»­æ‰§è¡Œè¯¥goroutineåç»­çš„æµ‹è¯•ï¼Œè€ŒFatal/Fatalfåˆ™ä¼šç«‹åˆ»åœæ­¢å½“å‰goroutineçš„æµ‹è¯•æ‰§è¡Œã€‚

```go
func TestCompare(t *testing.T) {
	var a, b string
	var i int

	a, b = "", ""
	i = 0
	cmp := strings.Compare(a, b)
	if cmp != i {
		t.Errorf("want %v, but Compare(%q, %q) = %v", i, a, b, cmp)
	}

	a, b = "a", ""
	i = 1
	cmp = strings.Compare(a, b)
	if cmp != i {
		t.Errorf("want %v, but Compare(%q, %q) = %v", i, a, b, cmp)
	}

	a, b = "", "a"
	i = -1
	cmp = strings.Compare(a, b)
	if cmp != i {
		t.Errorf("want %v, but Compare(%q, %q) = %v", i, a, b, cmp)
	}
}
```

Goæµ‹è¯•ä»£ç çš„ä¸€èˆ¬é€»è¾‘æ˜¯==é’ˆå¯¹ç»™å®šçš„è¾“å…¥æ•°æ®ï¼Œæ¯”è¾ƒè¢«æµ‹å‡½æ•°/æ–¹æ³•è¿”å›çš„å®é™…ç»“æœå€¼ä¸é¢„æœŸå€¼ï¼Œå¦‚æœ‰å·®å¼‚ï¼Œåˆ™é€šè¿‡testingåŒ…æä¾›çš„ç›¸å…³å‡½æ•°è¾“å‡ºå·®å¼‚ä¿¡æ¯ã€‚==

### 55.2 è¡¨é©±åŠ¨çš„æµ‹è¯•å®è·µ

```go
func TestCompare2(t *testing.T) {
	compareTests := []struct {
		a, b string
		i    int
	}{
		{"", "", 0},
		{"a", "", 1},
		{"", "a", -1},
	}
	for _, tt := range compareTests {
		cmp := strings.Compare(tt.a, tt.b)
		if cmp != tt.i {
			t.Errorf("want %v, but Compare(%q, %q) = %v", tt.i, tt.a, tt.b, cmp)
		}
	}
}

```

æ”¹è¿›ï¼Œå°†é¢„ç½®çš„è¾“å…¥æ•°æ®æ”¾å…¥ä¸€ä¸ªè‡ªå®šä¹‰ç»“æ„ä½“ç±»å‹çš„åˆ‡ç‰‡ä¸­ã€‚

æ— é¡»æ”¹åŠ¨åé¢çš„æµ‹è¯•é€»è¾‘ï¼Œåªéœ€åœ¨åˆ‡ç‰‡ä¸­å¢åŠ æ•°æ®æ¡ç›®å³å¯ã€‚åœ¨è¿™ç§æµ‹è¯•è®¾è®¡ä¸­ï¼Œè¿™ä¸ªè‡ªå®šä¹‰ç»“æ„ä½“ç±»å‹çš„åˆ‡ç‰‡ï¼ˆä¸Šè¿°ç¤ºä¾‹ä¸­çš„compareTestsï¼‰å°±æ˜¯ä¸€ä¸ªè¡¨ï¼ˆè‡ªå®šä¹‰ç»“æ„ä½“ç±»å‹çš„å­—æ®µå°±æ˜¯åˆ—ï¼‰ï¼Œè€ŒåŸºäºè¿™ä¸ªæ•°æ®è¡¨çš„æµ‹è¯•è®¾è®¡å’Œå®ç°åˆ™è¢«ç§°ä¸ºâ€œ**è¡¨é©±åŠ¨çš„æµ‹è¯•**â€ã€‚

### 55.3 è¡¨é©±åŠ¨æµ‹è¯•çš„ä¼˜ç‚¹

è¡¨é©±åŠ¨æµ‹è¯•æœ¬èº«æ˜¯ç¼–ç¨‹è¯­è¨€æ— å…³çš„ã€‚Goæ ¸å¿ƒå›¢é˜Ÿå’ŒGoæ—©æœŸå¼€å‘è€…åœ¨å®è·µè¿‡ç¨‹ä¸­å‘ç°è¡¨é©±åŠ¨æµ‹è¯•ååˆ†é€‚åˆGoä»£ç æµ‹è¯•å¹¶åœ¨æ ‡å‡†åº“å’Œç¬¬ä¸‰æ–¹é¡¹ç›®ä¸­å¤§é‡ä½¿ç”¨æ­¤ç§æµ‹è¯•è®¾è®¡ï¼Œè¿™æ ·è¡¨é©±åŠ¨æµ‹è¯•ä¹Ÿå°±é€æ¸æˆä¸ºGoçš„ä¸€ä¸ªæƒ¯ç”¨æ³•ã€‚

ä¼˜ç‚¹ï¼š

- ç®€å•å’Œç´§å‡‘

- æ•°æ®å³æµ‹è¯•

  è¡¨é©±åŠ¨æµ‹è¯•çš„å®è´¨æ˜¯æ•°æ®é©±åŠ¨çš„æµ‹è¯•ï¼Œæ‰©å±•è¾“å…¥æ•°æ®é›†å³æ‰©å±•æµ‹è¯•ã€‚é€šè¿‡æ‰©å±•æ•°æ®é›†ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°å®ç°æé«˜è¢«æµ‹ç›®æ ‡æµ‹è¯•è¦†ç›–ç‡çš„ç›®çš„ã€‚

- ç»“åˆ**å­æµ‹è¯•**åï¼Œå¯å•ç‹¬è¿è¡ŒæŸä¸ªæ•°æ®é¡¹çš„æµ‹è¯•

```go
// è¡¨é©±åŠ¨æµ‹è¯•ä¸å­æµ‹è¯•ï¼ˆsubtestï¼‰ç»“åˆ

func TestCompare4(t *testing.T) {
	compareTests := []struct {
		name, a, b string
		i          int
	}{
		{`compareTwoEmptyString`, "", "", 0},
		{`compareSecondParamIsEmpty`, "a", "", 1},
		{`compareFirstParamIsEmpty`, "", "a", -1},
	}

	for _, tt := range compareTests {
		t.Run(tt.name, func(t *testing.T) {
			cmp := strings.Compare(tt.a, tt.b)
			if cmp != tt.i {
				t.Errorf(`want %v, but Compare(%q, %q) = %v`, tt.i, tt.a, tt.b, cmp)
			}
		})
	}
}
```

æµ‹è¯•ç»“æœçš„åˆ¤å®šé€»è¾‘æ”¾å…¥ä¸€ä¸ªå•ç‹¬çš„å­æµ‹è¯•ä¸­ï¼Œè¿™æ ·å¯ä»¥å•ç‹¬æ‰§è¡Œè¡¨ä¸­æŸé¡¹æ•°æ®çš„æµ‹è¯•ã€‚æ¯”å¦‚ï¼šå•ç‹¬æ‰§è¡Œè¡¨ä¸­ç¬¬ä¸€ä¸ªæ•°æ®é¡¹å¯¹åº”çš„æµ‹è¯•ï¼š

```sh
$ go test -v -run /TwoEmptyString table_driven_strings_with_subtest_test.go 
=== RUN   TestCompare4
=== RUN   TestCompare4/compareTwoEmptyString
--- PASS: TestCompare4 (0.00s)
    --- PASS: TestCompare4/compareTwoEmptyString (0.00s)
PASS
ok      command-line-arguments  0.278s

```



ç»¼ä¸Šï¼Œ**å»ºè®®åœ¨ç¼–å†™Goæµ‹è¯•ä»£ç æ—¶ä¼˜å…ˆç¼–å†™åŸºäºè¡¨é©±åŠ¨çš„æµ‹è¯•ã€‚**

### 55.4 è¡¨é©±åŠ¨æµ‹è¯•å®è·µä¸­çš„æ³¨æ„äº‹é¡¹

#### 1 è¡¨çš„å®ç°æ–¹å¼

è¡¨é™¤äº†ç”¨è‡ªå®šä¹‰ç»“æ„ä½“çš„åˆ‡ç‰‡å®ç°çš„ï¼Œè¡¨ä¹Ÿå¯ä»¥ä½¿ç”¨åŸºäºè‡ªå®šä¹‰ç»“æ„ä½“çš„å…¶ä»–**é›†åˆç±»å‹**ï¼ˆå¦‚mapï¼‰æ¥å®ç°ã€‚



**ä¸è¿‡ä½¿ç”¨mapä½œä¸ºæ•°æ®è¡¨æ—¶è¦æ³¨æ„ï¼Œè¡¨å†…æ•°æ®é¡¹çš„æµ‹è¯•å…ˆåé¡ºåºæ˜¯ä¸ç¡®å®šçš„ã€‚**

#### 2 æµ‹è¯•å¤±è´¥æ—¶çš„æ•°æ®é¡¹çš„å®šä½

å¯¹äºéè¡¨é©±åŠ¨çš„æµ‹è¯•ï¼Œåœ¨æµ‹è¯•å¤±è´¥æ—¶ï¼Œå¾€å¾€é€šè¿‡å¤±è´¥ç‚¹æ‰€åœ¨çš„è¡Œæ•°å³å¯åˆ¤å®šç©¶ç«Ÿæ˜¯å“ªå—æµ‹è¯•ä»£ç æœªé€šè¿‡ï¼š

```sh
$ go test -v non_table_driven_strings_test.go
=== RUN   TestCompare
    non_table_driven_strings_test.go:18: want 1, but Compare("", "") = 0
--- FAIL: TestCompare (0.00s)
FAIL
FAIL    command-line-arguments  0.387s
FAIL
```

ä½†åœ¨è¡¨é©±åŠ¨çš„æµ‹è¯•ä¸­ï¼Œç”±äºä¸€èˆ¬æƒ…å†µä¸‹è¡¨é©±åŠ¨çš„æµ‹è¯•çš„æµ‹è¯•ç»“æœæˆåŠŸä¸å¦çš„åˆ¤å®šé€»è¾‘æ˜¯å…±äº«çš„ï¼Œå› æ­¤å†é€šè¿‡è¡Œæ•°æ¥å®šä½é—®é¢˜å°±ä¸å¯è¡Œäº†ï¼Œå› ä¸ºæ— è®ºæ˜¯è¡¨ä¸­å“ªä¸€é¡¹å¯¼è‡´çš„æµ‹è¯•å¤±è´¥ï¼Œå¤±è´¥ç»“æœä¸­è¾“å‡ºçš„å¼•å‘é”™è¯¯çš„è¡Œå·éƒ½æ˜¯ç›¸åŒçš„ï¼š

```shell
$ go test -v table_driven_strings_test.go
=== RUN   TestCompare2
    table_driven_strings_test.go:20: want 1, but Compare("", "") = 0
    table_driven_strings_test.go:20: want 6, but Compare("a", "") = 1
    table_driven_strings_test.go:20: want 0, but Compare("", "a") = -1
--- FAIL: TestCompare2 (0.00s)
=== RUN   TestCompare3
--- PASS: TestCompare3 (0.00s)
FAIL
FAIL    command-line-arguments  0.276s
FAIL
```



éœ€è¦åœ¨æµ‹è¯•å¤±è´¥çš„è¾“å‡ºç»“æœä¸­è¾“å‡ºæ•°æ®è¡¨é¡¹çš„**å”¯ä¸€æ ‡è¯†**ã€‚æœ€ç®€å•çš„æ–¹æ³•æ˜¯é€šè¿‡è¾“å‡ºæ•°æ®è¡¨é¡¹åœ¨æ•°æ®è¡¨ä¸­çš„**åç§»é‡**æ¥è¾…åŠ©å®šä½â€œå…ƒå‡¶â€ï¼š

```go
func TestCompare6(t *testing.T) {
	compareTests := []struct {
		a, b string
		i    int
	}{
		{"", "", 7},
		{"a", "", 6},
		{"", "a", -1},
	}

	for i, tt := range compareTests {
		cmp := strings.Compare(tt.a, tt.b)
		if cmp != tt.i {
			t.Errorf(`[table offset: %v] want %v, but Compare(%q, %q) = %v`, i+1, tt.i, tt.a, tt.b, cmp)
		}
	}
}
```



```sh
$ go test -v table_driven_strings_by_offset_test.go 
=== RUN   TestCompare6
    table_driven_strings_by_offset_test.go:23: [table offset: 1] want 7, but Compare("", "") = 0
    table_driven_strings_by_offset_test.go:23: [table offset: 2] want 6, but Compare("a", "") = 1
--- FAIL: TestCompare6 (0.00s)
FAIL
FAIL    command-line-arguments  0.433s
FAIL

```

ä¸€ä¸ªæ›´ç›´è§‚çš„æ–¹å¼æ˜¯ä½¿ç”¨åå­—æ¥åŒºåˆ†ä¸åŒçš„æ•°æ®é¡¹ï¼š

```sh
$ go test -v table_driven_strings_by_name_test.go  
=== RUN   TestCompare7
    table_driven_strings_by_name_test.go:23: [compareTwoEmptyString] want 7, but Compare("", "") = 0
    table_driven_strings_by_name_test.go:23: [compareSecondStringEmpty] want 6, but Compare("a", "") = 1
--- FAIL: TestCompare7 (0.00s)
FAIL
FAIL    command-line-arguments  0.433s
FAIL

```



#### 3 Errorfè¿˜æ˜¯Fatalf

ä¸€èˆ¬è€Œè¨€ï¼Œå¦‚æœä¸€ä¸ªæ•°æ®é¡¹å¯¼è‡´çš„æµ‹è¯•å¤±è´¥ä¸ä¼šå¯¹åç»­æ•°æ®é¡¹çš„æµ‹è¯•ç»“æœé€ æˆå½±å“ï¼Œé‚£ä¹ˆæ¨èErrorfï¼Œè¿™æ ·å¯ä»¥é€šè¿‡æ‰§è¡Œä¸€æ¬¡æµ‹è¯•çœ‹åˆ°æ‰€æœ‰å¯¼è‡´æµ‹è¯•å¤±è´¥çš„æ•°æ®é¡¹ï¼›å¦åˆ™ï¼Œå¦‚æœæ•°æ®é¡¹å¯¼è‡´çš„æµ‹è¯•å¤±è´¥ä¼šç›´æ¥å½±å“åˆ°åç»­æ•°æ®é¡¹çš„æµ‹è¯•ç»“æœï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨Fatalfè®©æµ‹è¯•å°½å¿«ç»“æŸï¼Œå› ä¸ºç»§ç»­æ‰§è¡Œçš„æµ‹è¯•çš„æ„ä¹‰å·²ç»ä¸å¤§äº†ã€‚



## 56 ä½¿ç”¨testdataç®¡ç†æµ‹è¯•ä¾èµ–çš„å¤–éƒ¨æ•°æ®æ–‡ä»¶

æµ‹è¯•å›ºä»¶æ˜¯Goæµ‹è¯•æ‰§è¡Œæ‰€éœ€çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå…¶ä¸­æµ‹è¯•ä¾èµ–çš„**å¤–éƒ¨æ•°æ®**æ–‡ä»¶å°±æ˜¯ä¸€ç§å¸¸è§çš„æµ‹è¯•å›ºä»¶ï¼ˆå¯ä»¥ç†è§£ä¸ºé™æ€æµ‹è¯•å›ºä»¶ï¼Œå› ä¸ºæ— é¡»åœ¨æµ‹è¯•ä»£ç ä¸­ä¸ºå…¶å•ç‹¬ç¼–å†™å›ºä»¶çš„åˆ›å»ºå’Œæ¸…ç†è¾…åŠ©å‡½æ•°ï¼‰ã€‚

ä¸€äº›åŒ…å«æ–‡ä»¶I/Oçš„åŒ…çš„æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦ä»å¤–éƒ¨æ•°æ®æ–‡ä»¶ä¸­åŠ è½½æ•°æ®æˆ–å‘å¤–éƒ¨æ–‡ä»¶å†™å…¥ç»“æœæ•°æ®ä»¥æ»¡è¶³æµ‹è¯•å›ºä»¶çš„éœ€æ±‚ã€‚

å…¶ä»–ä¸»æµç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå¦‚ä½•ç®¡ç†æµ‹è¯•ä¾èµ–çš„å¤–éƒ¨æ•°æ®æ–‡ä»¶å¾€å¾€æ˜¯ç”±ç¨‹åºå‘˜è‡ªè¡Œå†³å®šçš„ï¼Œä½†Goè¯­è¨€æ˜¯ä¸€é—¨é¢å‘è½¯ä»¶å·¥ç¨‹çš„è¯­è¨€ã€‚ä»å·¥ç¨‹åŒ–çš„è§’åº¦å‡ºå‘ï¼ŒGoçš„è®¾è®¡è€…ä»¬å°†ä¸€äº›åœ¨ä¼ ç»Ÿè¯­è¨€ä¸­ç”±ç¨‹åºå‘˜è‡ªèº«ä¹ æƒ¯å†³å®šçš„äº‹æƒ…ä¸€ä¸€**è§„èŒƒåŒ–**äº†ï¼Œè¿™æ ·å¯ä»¥æœ€å¤§é™åº¦åœ°æå‡ç¨‹åºå‘˜é—´çš„åä½œæ•ˆç‡ã€‚

### 56.1 testdataç›®å½•

Goè¯­è¨€è§„å®šï¼š**Goå·¥å…·é“¾å°†å¿½ç•¥åä¸ºtestdataçš„ç›®å½•**ã€‚è¿™æ ·å¼€å‘è€…åœ¨ç¼–å†™æµ‹è¯•æ—¶ï¼Œå°±å¯ä»¥åœ¨åä¸ºtestdataçš„ç›®å½•ä¸‹**å­˜æ”¾å’Œç®¡ç†æµ‹è¯•ä»£ç ä¾èµ–çš„æ•°æ®æ–‡ä»¶**ã€‚

```go
f, err := os.Open(filepath.Join("testdata", "data-001.txt"))
```



åœ¨$GOROOT/srcè·¯å¾„ï¼š

```sh
 $ find . -name "testdata" -print
 ./cmd/vet/testdata
./cmd/objdump/testdata
./cmd/asm/internal/asm/testdata
...
./image/testdata
./image/png/testdata
./time/testdata
./mime/testdata
./mime/multipart/testdata
./os/testdata
./text/template/testdata
./debug/pe/testdata
./debug/macho/testdata
./debug/gosym/testdata
./debug/plan9obj/testdata
./debug/buildinfo/testdata

```



ç»å¸¸å°†é¢„æœŸç»“æœæ•°æ®ä¿å­˜åœ¨æ–‡ä»¶ä¸­å¹¶æ”¾ç½®åœ¨testdataä¸‹ï¼Œç„¶ååœ¨æµ‹è¯•ä»£ç ä¸­å°†è¢«æµ‹å¯¹è±¡è¾“å‡ºçš„æ•°æ®ä¸è¿™äº›é¢„ç½®åœ¨æ–‡ä»¶ä¸­çš„æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œä¸€è‡´åˆ™æµ‹è¯•é€šè¿‡ï¼›åä¹‹ï¼Œæµ‹è¯•å¤±è´¥ã€‚



### 56.2 goldenæ–‡ä»¶æƒ¯ç”¨æ³•

> èƒ½å¦æŠŠå°†é¢„æœŸæ•°æ®é‡‡é›†åˆ°æ–‡ä»¶çš„è¿‡ç¨‹ä¸æµ‹è¯•ä»£ç èåˆåˆ°ä¸€èµ·å‘¢ï¼Ÿ
>
> Goæ ‡å‡†åº“æä¾›äº†ä¸€ç§æƒ¯ç”¨æ³•ï¼š==goldenæ–‡ä»¶==ã€‚



## 57 æ­£ç¡®è¿ç”¨fakeã€stubå’Œmockç­‰è¾…åŠ©å•å…ƒæµ‹è¯•

> ä½ ä¸éœ€è¦ä¸€ä¸ªçœŸå®çš„æ•°æ®åº“æ¥æ»¡è¶³è¿è¡Œå•å…ƒæµ‹è¯•çš„éœ€æ±‚ã€‚ 

åœ¨å¯¹Goä»£ç è¿›è¡Œæµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œé™¤äº†ä¼šé‡åˆ°ä¸Šä¸€ç« ä¸­æ‰€æåˆ°çš„æµ‹è¯•ä»£ç å¯¹å¤–éƒ¨æ–‡ä»¶æ•°æ®çš„ä¾èµ–ä¹‹å¤–ï¼Œè¿˜ä¼šç»å¸¸é¢å¯¹**è¢«æµ‹ä»£ç å¯¹å¤–éƒ¨ä¸šåŠ¡ç»„ä»¶æˆ–æœåŠ¡çš„ä¾èµ–**ã€‚æ­¤å¤–ï¼Œ**è¶Šæ˜¯æ¥è¿‘ä¸šåŠ¡å±‚ï¼Œè¢«æµ‹ä»£ç å¯¹å¤–éƒ¨ç»„ä»¶æˆ–æœåŠ¡ä¾èµ–çš„å¯èƒ½æ€§è¶Šå¤§**ã€‚æ¯”å¦‚ï¼š

- è¢«æµ‹ä»£ç éœ€è¦è¿æ¥å¤–éƒ¨RedisæœåŠ¡ï¼›
- è¢«æµ‹ä»£ç ä¾èµ–ä¸€ä¸ªå¤–éƒ¨é‚®ä»¶æœåŠ¡å™¨æ¥å‘é€ç”µå­é‚®ä»¶ï¼›
- è¢«æµ‹ä»£ç éœ€ä¸å¤–éƒ¨æ•°æ®åº“å»ºç«‹è¿æ¥å¹¶è¿›è¡Œæ•°æ®æ“ä½œï¼›
- è¢«æµ‹ä»£ç ä½¿ç”¨äº†æŸä¸ªå¤–éƒ¨RESTfulæœåŠ¡ã€‚

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¸ºè¿è¡Œçš„ä¸šåŠ¡ä»£ç æä¾›å…¶ä¾èµ–çš„çœŸå®ç»„ä»¶æˆ–æœåŠ¡æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œä¹Ÿæ˜¯ç›¸å¯¹å®¹æ˜“çš„ã€‚ä½†æ˜¯åœ¨å¼€å‘æµ‹è¯•ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬æ— æ³•åƒåœ¨ç”Ÿäº§ç¯å¢ƒä¸­é‚£æ ·ï¼Œä¸ºæµ‹è¯•ï¼ˆå°¤å…¶æ˜¯å•å…ƒæµ‹è¯•ï¼‰æä¾›çœŸå®è¿è¡Œçš„å¤–éƒ¨ä¾èµ–ã€‚è¿™æ˜¯å› ä¸ºæµ‹è¯•ï¼ˆå°¤å…¶æ˜¯å•å…ƒæµ‹è¯•ï¼‰è¿è¡Œåœ¨å„ç±»**å¼€å‘ç¯å¢ƒã€æŒç»­é›†æˆæˆ–æŒç»­äº¤ä»˜ç¯å¢ƒ**ä¸­ï¼Œæˆ‘ä»¬å¾ˆéš¾è¦æ±‚æ‰€æœ‰ç¯å¢ƒä¸ºè¿è¡Œæµ‹è¯•è€Œæ­å»ºç»Ÿä¸€ç‰ˆæœ¬ã€ç»Ÿä¸€è®¿é—®æ–¹å¼ã€ç»Ÿä¸€è¡Œä¸ºæ§åˆ¶ä»¥åŠä¿æŒè¿”å›æ•°æ®ä¸€è‡´çš„çœŸå®å¤–éƒ¨ä¾èµ–ç»„ä»¶æˆ–æœåŠ¡ã€‚åè¿‡æ¥è¯´ï¼Œä¸ºè¢«æµ‹å¯¹è±¡å»ºç«‹ä¾èµ–çœŸå®å¤–éƒ¨ç»„ä»¶æˆ–æœåŠ¡çš„æµ‹è¯•ä»£ç æ˜¯ååˆ†ä¸æ˜æ™ºçš„ï¼Œå› ä¸ºè¿™ç§æµ‹è¯•ï¼ˆå°¤æŒ‡å•å…ƒæµ‹è¯•ï¼‰è¿è¡Œå¤±è´¥çš„æ¦‚ç‡è¦è¿œå¤§äºå…¶è¿è¡ŒæˆåŠŸçš„æ¦‚ç‡ï¼Œå¤±å»äº†å­˜åœ¨çš„æ„ä¹‰ã€‚

ä¸ºäº†èƒ½è®©å¯¹æ­¤ç±»è¢«æµ‹ä»£ç çš„æµ‹è¯•è¿›è¡Œä¸‹å»ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºè¿™äº›è¢«æµ‹ä»£ç æä¾›å…¶ä¾èµ–çš„å¤–éƒ¨ç»„ä»¶æˆ–æœåŠ¡çš„**æ›¿èº«**ï¼š

![](images/image-20250310143822732.png)

æ˜¾ç„¶ç”¨äºä»£ç æµ‹è¯•çš„â€œæ›¿èº«â€ä¸å¿…ä¸çœŸå®ç»„ä»¶æˆ–æœåŠ¡å®Œå…¨ç›¸åŒï¼Œæ›¿èº«åªéœ€è¦æä¾›ä¸çœŸå®ç»„ä»¶æˆ–æœåŠ¡ç›¸åŒçš„æ¥å£ï¼Œåªè¦è¢«æµ‹ä»£ç è®¤ä¸ºå®ƒæ˜¯çœŸå®çš„å³å¯ã€‚

æ›¿èº«çš„æ¦‚å¿µæ˜¯åœ¨[æµ‹è¯•é©±åŠ¨ç¼–ç¨‹](https://www.agilealliance.org/glossary/tdd)ç†è®ºä¸­è¢«æå‡ºçš„ã€‚ä½œä¸ºæµ‹è¯•é©±åŠ¨ç¼–ç¨‹ç†è®ºçš„æœ€ä½³å®è·µï¼ŒxUnitå®¶æ—æ¡†æ¶å°†æ›¿èº«çš„æ¦‚å¿µåœ¨å•å…ƒæµ‹è¯•ä¸­åº”ç”¨å¾—æ·‹æ¼“å°½è‡´ï¼Œå¹¶æ€»ç»“å‡ºå¤šç§æ›¿èº«ï¼Œæ¯”å¦‚fakeã€stubã€mockç­‰ã€‚è¿™äº›æ¦‚å¿µåŠå…¶åº”ç”¨æ¨¡å¼è¢«æ±‡é›†åœ¨[ã€ŠxUnit Test Patternsã€‹](https://book.douban.com/subject/1859393)ä¸€ä¹¦ä¸­ï¼Œè¯¥ä¹¦å·²æˆä¸ºæµ‹è¯•é©±åŠ¨å¼€å‘å’ŒxUnitæ¡†æ¶æ‹¥è¶¸äººæ‰‹ä¸€å†Œçš„â€œåœ£ç»â€ã€‚

åœ¨æœ¬ç« çœ‹ä¸€ä¸‹å¦‚ä½•å°†xUnitæœ€ä½³å®è·µä¸­çš„fakeã€stubå’Œmockç­‰æ¦‚å¿µåº”ç”¨åˆ°Goè¯­è¨€å•å…ƒæµ‹è¯•ä¸­ä»¥ç®€åŒ–æµ‹è¯•ï¼ˆåŒºåˆ«äºç›´æ¥ä¸ºè¢«æµ‹ä»£ç å»ºç«‹å…¶ä¾èµ–çš„çœŸå®å¤–éƒ¨ç»„ä»¶æˆ–æœåŠ¡ï¼‰ï¼Œä»¥åŠè¿™äº›æ¦‚å¿µæ˜¯å¦‚ä½•ä¿ƒè¿›è¢«æµ‹ä»£ç é‡æ„ä»¥æå‡å¯æµ‹è¯•æ€§çš„ã€‚

ä¸è¿‡fakeã€stubã€mockç­‰æ›¿èº«æ¦‚å¿µä¹‹é—´å¹¶éæ³¾æ¸­åˆ†æ˜çš„ï¼Œç†è§£è¿™äº›æ¦‚å¿µå¹¶æ¸…æ™°åŒºåˆ†å®ƒä»¬æœ¬èº«å°±æ˜¯ä¸€é“é—¨æ§›ã€‚æœ¬ç« å°½é‡ä¸æ¶‰åŠè¿™äº›æ¦‚å¿µé—´çš„äº¤é›†ä»¥é¿å…è®²è§£è¿‡äºçç¢ã€‚æƒ³è¦æ·±å…¥äº†è§£è¿™äº›æ¦‚å¿µé—´å·®åˆ«çš„è¯»è€…å¯ä»¥è‡ªè¡Œç²¾è¯»xUnit Test Patternsã€‚

### 57.1 fakeï¼šçœŸå®ç»„ä»¶æˆ–æœåŠ¡çš„ç®€åŒ–å®ç°ç‰ˆæ›¿èº«

fakeï¼ˆâ€œä¼ªé€ çš„â€â€œå‡çš„â€â€œä¼ªè£…çš„â€ï¼‰æµ‹è¯•å°±æ˜¯æŒ‡é‡‡ç”¨çœŸå®ç»„ä»¶æˆ–æœåŠ¡çš„ç®€åŒ–ç‰ˆå®ç°ä½œä¸ºæ›¿èº«ï¼Œä»¥æ»¡è¶³è¢«æµ‹ä»£ç çš„å¤–éƒ¨ä¾èµ–éœ€æ±‚ã€‚

æ¯”å¦‚ï¼šå½“è¢«æµ‹ä»£ç éœ€è¦è¿æ¥æ•°æ®åº“è¿›è¡Œç›¸å…³æ“ä½œæ—¶ï¼Œè™½ç„¶æˆ‘ä»¬åœ¨å¼€å‘æµ‹è¯•ç¯å¢ƒä¸­æ— æ³•æä¾›ä¸€ä¸ªçœŸå®çš„å…³ç³»æ•°æ®åº“æ¥æ»¡è¶³æµ‹è¯•éœ€æ±‚ï¼Œä½†æ˜¯å¯ä»¥åŸºäºå“ˆå¸Œè¡¨å®ç°ä¸€ä¸ªå†…å­˜ç‰ˆæ•°æ®åº“æ¥æ»¡è¶³æµ‹è¯•ä»£ç è¦æ±‚ï¼Œæˆ‘ä»¬ç”¨è¿™æ ·ä¸€ä¸ªä¼ªæ•°æ®åº“ä½œä¸ºçœŸå®æ•°æ®åº“çš„æ›¿èº«ï¼Œä½¿å¾—æµ‹è¯•é¡ºåˆ©è¿›è¡Œä¸‹å»ã€‚

Goæ ‡å‡†åº“ä¸­çš„`$GOROOT/src/database/sql/fakedb_test.go`å°±æ˜¯ä¸€ä¸ªsql.Driveræ¥å£çš„ç®€åŒ–ç‰ˆå®ç°ï¼Œå®ƒå¯ä»¥ç”¨æ¥æ‰“å¼€ä¸€ä¸ªåŸºäºå†…å­˜çš„æ•°æ®åº“ï¼ˆsql.fakeDBï¼‰çš„è¿æ¥å¹¶æ“ä½œè¯¥å†…å­˜æ•°æ®åº“ï¼š

```go
// $GOROOT/src/database/sql/fakedb_test.goï¿¼
...
type fakeDriver struct {
	mu         sync.Mutex // guards 3 following fields
	openCount  int        // conn opens
	closeCount int        // conn closes
	waitCh     chan struct{}
	waitingCh  chan struct{}
	dbs        map[string]*fakeDB
}
...
var fdriver driver.Driver = &fakeDriver{}

func init() {
	Register("test", fdriver)
}
```

åœ¨sql_test.goä¸­ï¼Œæ ‡å‡†åº“åˆ©ç”¨ä¸Šé¢çš„fakeDriverè¿›è¡Œç›¸å…³æµ‹è¯•ï¼š

```go
// $GOROOT/src/database/sql/sql_test.goï¿¼


const fakeDBName = "foo"

func newTestDB(t testing.TB, name string) *DB {
	return newTestDBConnector(t, &fakeConnector{name: fakeDBName}, name)
}

func newTestDBConnector(t testing.TB, fc *fakeConnector, name string) *DB {
	fc.name = fakeDBName
	db := OpenDB(fc)
	if _, err := db.Exec("WIPE"); err != nil {
		t.Fatalf("exec wipe: %v", err)
	}
	if name == "people" {
		exec(t, db, "CREATE|people|name=string,age=int32,photo=blob,dead=bool,bdate=datetime")
		exec(t, db, "INSERT|people|name=Alice,age=?,photo=APHOTO", 1)
		exec(t, db, "INSERT|people|name=Bob,age=?,photo=BPHOTO", 2)
		exec(t, db, "INSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?", 3, chrisBirthday)
	}
	if name == "magicquery" {
		// Magic table name and column, known by fakedb_test.go.
		exec(t, db, "CREATE|magicquery|op=string,millis=int32")
		exec(t, db, "INSERT|magicquery|op=sleep,millis=10")
	}
	if name == "tx_status" {
		// Magic table name and column, known by fakedb_test.go.
		exec(t, db, "CREATE|tx_status|tx_status=string")
		exec(t, db, "INSERT|tx_status|tx_status=invalid")
	}
	return db
}

...

func TestUnsupportedOptions(t *testing.T) {
	db := newTestDB(t, "people")
	defer closeDB(t, db)
	_, err := db.BeginTx(context.Background(), &TxOptions{
		Isolation: LevelSerializable, ReadOnly: true,
	})
	if err == nil {
		t.Fatal("expected error when using unsupported options, got nil")
	}
}
```

æ ‡å‡†åº“ä¸­fakeDriverçš„è¿™ä¸ªç®€åŒ–ç‰ˆå®ç°è¿˜æ˜¯æ¯”è¾ƒå¤æ‚ã€‚

çœ‹ä¸€ä¸ªè‡ªå®šä¹‰çš„ç®€å•ä¾‹å­æ¥è¿›ä¸€æ­¥ç†è§£fakeçš„æ¦‚å¿µåŠå…¶åœ¨Goå•å…ƒæµ‹è¯•ä¸­çš„åº”ç”¨ã€‚

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¢«æµ‹ä»£ç ä¸ºåŒ…mailclientä¸­ç»“æ„ä½“ç±»å‹mailClientçš„æ–¹æ³•ï¼šComposeAndSendï¼š

```go
// faketest1/mailclient.go
type mailClient struct {
	mlr mailer.Mailer
}

func New(mlr mailer.Mailer) *mailClient {
	return &mailClient{
		mlr: mlr,
	}
}

// è¢«æµ‹æ–¹æ³•
func (c *mailClient) ComposeAndSend(subject string, destinations []string, body string) (string, error) {
	signTxt := sign.Get()
	newBody := body + "\n" + signTxt

	for _, dest := range destinations {
		err := c.mlr.SendMail(subject, dest, newBody)
		if err != nil {
			return "", err
		}
	}
	return newBody, nil
}
```

å¯ä»¥çœ‹åˆ°åœ¨åˆ›å»ºmailClientå®ä¾‹çš„æ—¶å€™ï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ªmailer.Maileræ¥å£å˜é‡ï¼Œè¯¥æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š

```go
// faketest1/mailer/mailer.go
type Mailer interface {
	SendMail(subject, destination, body string) error
}
```

ComposeAndSendæ–¹æ³•å°†ä¼ å…¥çš„ç”µå­é‚®ä»¶å†…å®¹ï¼ˆbodyï¼‰ä¸ç­¾åï¼ˆsignTxtï¼‰ç¼–æ’åˆå¹¶åä¼ ç»™Maileræ¥å£å®ç°è€…çš„SendMailæ–¹æ³•ï¼Œç”±å…¶å°†é‚®ä»¶å‘é€å‡ºå»ã€‚

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œmailer.Maileræ¥å£çš„å®ç°è€…æ˜¯è¦ä¸è¿œç¨‹é‚®ä»¶æœåŠ¡å™¨å»ºç«‹è¿æ¥å¹¶é€šè¿‡ç‰¹å®šçš„ç”µå­é‚®ä»¶åè®®ï¼ˆå¦‚SMTPï¼‰å°†é‚®ä»¶å†…å®¹å‘é€å‡ºå»çš„ã€‚ä½†åœ¨å•å…ƒæµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬æ— æ³•æ»¡è¶³è¢«æµ‹ä»£ç çš„è¿™ä¸ªè¦æ±‚ï¼Œäºæ˜¯æˆ‘ä»¬ä¸ºmailClientå®ä¾‹æä¾›äº†ä¸¤ä¸ª**ç®€åŒ–ç‰ˆçš„å®ç°**ï¼šfakeOkMailerå’ŒfakeFailMailerï¼Œå‰è€…ä»£è¡¨å‘é€æˆåŠŸï¼Œåè€…ä»£è¡¨å‘é€å¤±è´¥ã€‚ä»£ç å¦‚ä¸‹ï¼š

```go
// faketest1/mailclient_test.goï¿¼
type fakeOkMailer struct{}
func (m *fakeOkMailer) SendMail(subject string, dest string, body string) error {
	return nil
}

type fakeFailMailer struct{}
func (m *fakeFailMailer) SendMail(subject string, dest string, body string) error {
	return fmt.Errorf("can not reach the mail server of dest [%s]", dest)
}
```

è¿™ä¸¤ä¸ªæ›¿èº«åœ¨æµ‹è¯•ä¸­çš„ä½¿ç”¨æ–¹æ³•ï¼š

```go
// faketest1/mailclient_test.goï¿¼
func TestComposeAndSendOk(t *testing.T) {
	m := &fakeOkMailer{}
	mc := mailclient.New(m)
	_, err := mc.ComposeAndSend("hello, fake test", []string{"xxx@example.com"}, "the test body")
	if err != nil {
		t.Errorf("want nil, got %v", err)
	}
}

func TestComposeAndSendFail(t *testing.T) {
	m := &fakeFailMailer{}
	mc := mailclient.New(m)
	_, err := mc.ComposeAndSend("hello, fake test", []string{"xxx@example.com"}, "the test body")
	if err == nil {
		t.Errorf("want non-nil, got nil")
	}
}
```

çœ‹åˆ°è¿™ä¸ªæµ‹è¯•ä¸­mailer.Mailerçš„fakeå®ç°çš„ç¡®å¾ˆç®€å•ï¼Œ**ç®€å•åˆ°åªæœ‰ä¸€ä¸ªè¿”å›è¯­å¥**ã€‚ä½†å°±è¿™æ ·ä¸€ä¸ªæå…¶ç®€åŒ–çš„å®ç°å´æ»¡è¶³äº†å¯¹ComposeAndSendæ–¹æ³•è¿›è¡Œæµ‹è¯•çš„æ‰€æœ‰éœ€æ±‚ã€‚
ä½¿ç”¨fakeæ›¿èº«è¿›è¡Œæµ‹è¯•çš„æœ€å¸¸è§ç†ç”±æ˜¯**åœ¨æµ‹è¯•ç¯å¢ƒæ— æ³•æ„é€ è¢«æµ‹ä»£ç æ‰€ä¾èµ–çš„å¤–éƒ¨ç»„ä»¶æˆ–æœåŠ¡ï¼Œæˆ–è€…è¿™äº›ç»„ä»¶/æœåŠ¡æœ‰å‰¯ä½œç”¨**ã€‚

fakeæ›¿èº«çš„å®ç°ä¹Ÿæœ‰ä¸¤ä¸ªæç«¯ï¼šè¦ä¹ˆåƒæ ‡å‡†åº“fakedb_test.goé‚£æ ·å®ç°ä¸€ä¸ªå…¨åŠŸèƒ½çš„ç®€åŒ–ç‰ˆå†…å­˜æ•°æ®åº“driverï¼Œè¦ä¹ˆåƒfaketest1ä¾‹å­ä¸­é‚£æ ·é’ˆå¯¹è¢«æµ‹ä»£ç çš„è°ƒç”¨è¯·æ±‚ä»…**è¿”å›ç¡¬ç¼–ç çš„æˆåŠŸæˆ–å¤±è´¥**ã€‚

è¿™ä¸¤ç§æç«¯å®ç°æœ‰ä¸€ä¸ªå…±åŒç‚¹ï¼š**å¹¶ä¸å…·å¤‡åœ¨æµ‹è¯•å‰å¯¹è¿”å›ç»“æœè¿›è¡Œé¢„è®¾ç½®çš„èƒ½åŠ›**ã€‚è¿™ä¹Ÿæ˜¯ä¸Šé¢ä¾‹å­ä¸­æˆ‘ä»¬é’ˆå¯¹æˆåŠŸå’Œå¤±è´¥ä¸¤ä¸ªç”¨ä¾‹åˆ†åˆ«å®ç°äº†ä¸€ä¸ªæ›¿èº«çš„åŸå› ã€‚ï¼ˆå¦‚æœéè¦è¯´æˆåŠŸå’Œå¤±è´¥ä¹Ÿæ˜¯é¢„è®¾ç½®çš„ï¼Œé‚£ä¹ˆfakeæ›¿èº«çš„é¢„è®¾ç½®èƒ½åŠ›ä¹Ÿä»…é™äºè®¾ç½®å•ä¸€çš„è¿”å›å€¼ï¼Œå³æ— è®ºè°ƒç”¨å¤šå°‘æ¬¡ï¼Œä¼ å…¥ä»€ä¹ˆå‚æ•°ï¼Œè¿”å›å€¼éƒ½æ˜¯ä¸€ä¸ªã€‚ï¼‰

### 57.2 stubï¼šå¯¹è¿”å›ç»“æœæœ‰ä¸€å®šé¢„è®¾æ§åˆ¶èƒ½åŠ›çš„æ›¿èº«ğŸ”–

stubä¹Ÿæ˜¯ä¸€ç§æ›¿èº«æ¦‚å¿µï¼Œå’Œfakeæ›¿èº«ç›¸æ¯”ï¼Œstubæ›¿èº«**å¢å¼ºäº†å¯¹æ›¿èº«è¿”å›ç»“æœçš„é—´æ¥æ§åˆ¶èƒ½åŠ›**ï¼Œè¿™ç§æ§åˆ¶å¯ä»¥é€šè¿‡æµ‹è¯•å‰å¯¹è°ƒç”¨ç»“æœ**é¢„è®¾ç½®**æ¥å®ç°ã€‚ä¸è¿‡ï¼Œstubæ›¿èº«é€šå¸¸ä»…é’ˆå¯¹**è®¡åˆ’ä¹‹å†…çš„ç»“æœ**è¿›è¡Œè®¾ç½®ï¼Œå¯¹è®¡åˆ’ä¹‹å¤–çš„è¯·æ±‚ä¹Ÿæ— èƒ½ä¸ºåŠ›ã€‚



### 57.3 mockï¼šä¸“ç”¨äºè¡Œä¸ºè§‚å¯Ÿå’ŒéªŒè¯çš„æ›¿èº«ğŸ”–

mockæ›¿èº«æ¯”ä¹‹å‰ä¸¤ä¸ªæ›´ä¸ºå¼ºå¤§ï¼šå®ƒé™¤äº†èƒ½æä¾›æµ‹è¯•å‰çš„é¢„è®¾ç½®è¿”å›ç»“æœèƒ½åŠ›ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å¯¹mockæ›¿èº«å¯¹è±¡åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­çš„è¡Œä¸ºè¿›è¡Œè§‚å¯Ÿå’ŒéªŒè¯ã€‚

ä¸è¿‡ç›¸æ¯”äºå‰ä¸¤ç§æ›¿èº«å½¢å¼ï¼Œmockå­˜åœ¨åº”ç”¨å±€é™ï¼ˆå°¤æŒ‡åœ¨Goä¸­ï¼‰ã€‚

- å’Œå‰ä¸¤ç§æ›¿èº«ç›¸æ¯”ï¼Œmockçš„åº”ç”¨èŒƒå›´è¦çª„å¾ˆå¤šï¼Œåªç”¨äºå®ç°æŸæ¥å£çš„å®ç°ç±»å‹çš„æ›¿èº«ã€‚
- ä¸€èˆ¬éœ€è¦é€šè¿‡ç¬¬ä¸‰æ–¹æ¡†æ¶å®ç°mockæ›¿èº«ã€‚Goå®˜æ–¹ç»´æŠ¤äº†ä¸€ä¸ªmockæ¡†æ¶â€”â€”[gomock](https://github.com/golang/mock)ï¼Œè¯¥æ¡†æ¶é€šè¿‡ä»£ç ç”Ÿæˆçš„æ–¹å¼ç”Ÿæˆå®ç°æŸæ¥å£çš„æ›¿èº«ç±»å‹ã€‚





## 58 ä½¿ç”¨æ¨¡ç³Šæµ‹è¯•è®©æ½œåœ¨bugæ— å¤„éå½¢

==æ¨¡ç³Šæµ‹è¯•ï¼ˆfuzz testingï¼‰==æ˜¯æŒ‡åŠè‡ªåŠ¨æˆ–è‡ªåŠ¨åœ°ä¸ºç¨‹åºæä¾›éæ³•çš„ã€éé¢„æœŸã€éšæœºçš„æ•°æ®ï¼Œå¹¶ç›‘æ§ç¨‹åºåœ¨è¿™äº›è¾“å…¥æ•°æ®ä¸‹æ˜¯å¦ä¼šå‡ºç°å´©æºƒã€å†…ç½®æ–­è¨€å¤±è´¥ã€å†…å­˜æ³„éœ²ã€å®‰å…¨æ¼æ´ç­‰æƒ…å†µã€‚

![](images/image-20250312232554891.png)

æ¨¡ç³Šæµ‹è¯•å§‹äº**1988**å¹´Barton Milleræ‰€åšçš„ä¸€é¡¹æœ‰å…³Unixéšæœºæµ‹è¯•çš„é¡¹ç›®ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå·²ç»æœ‰è®¸å¤šæœ‰å…³æ¨¡ç³Šæµ‹è¯•çš„ç†è®ºæ”¯æ’‘ï¼Œå¹¶ä¸”è¶Šæ¥è¶Šå¤šçš„ç¼–ç¨‹è¯­è¨€å¼€å§‹æä¾›å¯¹æ¨¡ç³Šæµ‹è¯•çš„æ”¯æŒï¼Œæ¯”å¦‚åœ¨ç¼–è¯‘å™¨å±‚é¢åŸç”Ÿæä¾›æ¨¡ç³Šæµ‹è¯•æ”¯æŒçš„LLVM fuzzeré¡¹ç›®libfuzzerã€å†å²æœ€æ‚ ä¹…çš„é¢å‘å®‰å…¨çš„fuzzeræ–¹æ¡ˆafl-fuzzã€è°·æ­Œå¼€æºçš„é¢å‘å¯ä¼¸ç¼©æ¨¡ç³Šæµ‹è¯•åŸºç¡€è®¾æ–½çš„ClusterFuzzç­‰ã€‚

**ä¼ ç»Ÿè½¯ä»¶æµ‹è¯•æŠ€æœ¯è¶Šæ¥è¶Šæ— æ³•æ»¡è¶³ç°ä»£è½¯ä»¶æ—¥ç›Šå¢é•¿çš„è§„æ¨¡ã€å¤æ‚æ€§ä»¥åŠå¯¹å¼€å‘é€Ÿåº¦çš„è¦æ±‚ã€‚**ä¼ ç»Ÿè½¯ä»¶æµ‹è¯•ä¸€èˆ¬ä¼šé’ˆå¯¹è¢«æµ‹ç›®æ ‡çš„ç‰¹æ€§è¿›è¡Œäººå·¥æµ‹è¯•è®¾è®¡ã€‚åœ¨è®¾è®¡ä¸€äº›å¼‚å¸¸æµ‹è¯•ç”¨ä¾‹çš„æ—¶å€™ï¼Œæµ‹è¯•ç”¨ä¾‹è´¨é‡å¥½åå¾€å¾€å–å†³äºæµ‹è¯•è®¾è®¡äººå‘˜å¯¹è¢«æµ‹ç³»ç»Ÿçš„ç†è§£ç¨‹åº¦åŠå…¶ä¸ªäººèƒ½åŠ›ã€‚å³ä¾¿æµ‹è¯•è®¾è®¡äººå‘˜ä¸ªäººèƒ½åŠ›å¾ˆå¼ºï¼Œå¯¹è¢«æµ‹ç³»ç»Ÿä¹Ÿæœ‰è¾ƒæ·±å…¥çš„ç†è§£ï¼Œä»–ä¹Ÿå¾ˆéš¾åœ¨æœ‰é™çš„æ—¶é—´å†…æƒ³åˆ°æ‰€æœ‰å¯èƒ½çš„å¼‚å¸¸ç»„åˆå’Œå¼‚å¸¸è¾“å…¥ï¼Œå°¤å…¶æ˜¯é¢å¯¹åºå¤§çš„åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ—¶å€™ã€‚ç³»ç»Ÿæ¶‰åŠçš„è‡ªèº«æœåŠ¡ç»„ä»¶ã€ä¸­é—´ä»¶ã€ç¬¬ä¸‰æ–¹ç³»ç»Ÿç­‰å¤šä¸”å¤æ‚ï¼Œè¿™äº›ç³»ç»Ÿä¸­çš„æ½œåœ¨bugæˆ–è€…ç»„åˆåå½¢æˆçš„æ½œåœ¨bugæ˜¯æˆ‘ä»¬æ— æ³•é¢„çŸ¥çš„ã€‚è€Œå°†éšæœºæµ‹è¯•ã€è¾¹ç•Œæµ‹è¯•ã€è¯•æ¢æ€§æ”»å‡»ç­‰æµ‹è¯•æŠ€æœ¯é›†äºä¸€èº«çš„æ¨¡ç³Šæµ‹è¯•å¯¹äºä¸Šè¿°ä¼ ç»Ÿæµ‹è¯•æŠ€æœ¯å­˜åœ¨çš„é—®é¢˜æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è¡¥å……å’Œè§£å†³æ–¹æ¡ˆ

### 58.1 æ¨¡ç³Šæµ‹è¯•åœ¨æŒ–æ˜Goä»£ç çš„æ½œåœ¨bugä¸­çš„ä½œç”¨

`go-fuzz`



### 58.2 go-fuzzçš„åˆæ­¥å·¥ä½œåŸç†

```go
func Fuzz(data []byte) int
```

go-fuzzè¿›ä¸€æ­¥å®Œå–„äº†Goå¼€å‘æµ‹è¯•å·¥å…·é›†ï¼Œå¾ˆå¤šè¾ƒæ—©æ¥å—Goè¯­è¨€çš„å…¬å¸ï¼ˆå¦‚Cloudflareç­‰ï¼‰å·²ç»å¼€å§‹ä½¿ç”¨go-fuzzæ¥æµ‹è¯•è‡ªå·±çš„äº§å“ä»¥æé«˜äº§å“è´¨é‡äº†ã€‚

go-fuzzçš„å·¥ä½œæµç¨‹ï¼š

1. ç”Ÿæˆéšæœºæ•°æ®ï¼›
2. å°†ä¸Šè¿°æ•°æ®ä½œä¸ºè¾“å…¥ä¼ é€’ç»™è¢«æµ‹ç¨‹åºï¼›
3. è§‚å¯Ÿæ˜¯å¦æœ‰å´©æºƒè®°å½•ï¼ˆcrashï¼‰ï¼Œå¦‚æœå‘ç°å´©æºƒè®°å½•ï¼Œåˆ™è¯´æ˜æ‰¾åˆ°äº†æ½œåœ¨çš„bugã€‚

ä¹‹åå¼€å‘è€…å¯ä»¥æ ¹æ®crashè®°å½•æƒ…å†µå»ç¡®è®¤å’Œä¿®å¤bugã€‚ä¿®å¤bugåï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šä¸ºè¢«æµ‹ä»£ç æ·»åŠ é’ˆå¯¹è¿™ä¸ªbugçš„å•å…ƒæµ‹è¯•ç”¨ä¾‹ä»¥éªŒè¯bugå·²ç»ä¿®å¤ã€‚

go-fuzzé‡‡ç”¨çš„æ˜¯**ä»£ç è¦†ç›–ç‡å¼•å¯¼çš„fuzzingç®—æ³•**ï¼ˆCoverage-guided fuzzingï¼‰ã€‚

go-fuzzè¿è¡Œèµ·æ¥åå°†è¿›å…¥ä¸€ä¸ªæ­»å¾ªç¯ï¼Œè¯¥å¾ªç¯ä¸­çš„é€»è¾‘çš„ä¼ªä»£ç å¤§è‡´å¦‚ä¸‹ï¼š

```go
// go-fuzz-buildåœ¨æ„å»ºç”¨äºgo-fuzzçš„äºŒè¿›åˆ¶æ–‡ä»¶(*.zip)çš„è¿‡ç¨‹ä¸­
// åœ¨è¢«æµ‹å¯¹è±¡ä»£ç ä¸­åŸ‹å…¥ç”¨äºç»Ÿè®¡ä»£ç è¦†ç›–ç‡çš„æ¡©ä»£ç åŠå…¶ä»–ä¿¡æ¯
Instrument program for code coverage

Collect initial corpus of inputs  // æ”¶é›†åˆå§‹è¾“å…¥æ•°æ®è¯­æ–™(ä½äºå·¥ä½œè·¯å¾„ä¸‹çš„corpusç›®å½•ä¸‹)
for {
  // ä»corpusä¸­è¯»å–è¯­æ–™å¹¶åšéšæœºå˜åŒ–
  Randomly mutate an input from the corpus
  
  // æ‰§è¡ŒFuzzï¼Œæ”¶é›†ä»£ç è¦†ç›–ç‡æ•°æ®
  Execute and collect coverage
  
  // å¦‚æœè¾“å…¥æ•°æ®æä¾›äº†æ–°çš„ä»£ç è¦†ç›–ç‡ï¼Œåˆ™å°†è¯¥è¾“å…¥æ•°æ®å­˜å…¥è¯­æ–™åº“(corpus)
  If the input gives new coverage, add it to corpus
}  
```

go-fuzzçš„æ ¸å¿ƒæ˜¯**å¯¹è¯­æ–™åº“çš„è¾“å…¥æ•°æ®å¦‚ä½•è¿›è¡Œå˜åŒ–**ã€‚go-fuzzå†…éƒ¨ä½¿ç”¨ä¸¤ç§å¯¹è¯­æ–™åº“çš„è¾“å…¥æ•°æ®è¿›è¡Œå˜åŒ–çš„æ–¹æ³•ï¼š**çªå˜ï¼ˆmutationï¼‰å’Œæ”¹å†™ï¼ˆversifyï¼‰**ã€‚

çªå˜æ˜¯ä¸€ç§ä½çº§æ–¹æ³•ï¼Œä¸»è¦æ˜¯å¯¹è¯­æ–™åº“çš„å­—èŠ‚è¿›è¡Œå°ä¿®æ”¹ã€‚ä¸‹é¢æ˜¯ä¸€äº›å¸¸è§çš„çªå˜ç­–ç•¥

- æ’å…¥/åˆ é™¤/é‡å¤/å¤åˆ¶éšæœºèŒƒå›´çš„éšæœºå­—èŠ‚ï¼›
- ä½ç¿»è½¬ï¼›
- äº¤æ¢2å­—èŠ‚ï¼›
- å°†ä¸€ä¸ªå­—èŠ‚è®¾ç½®ä¸ºéšæœºå€¼ï¼›
- ä»ä¸€ä¸ªbyte/uint16/uint32/uint64ä¸­æ·»åŠ /å‡å»ï¼›
- å°†ä¸€ä¸ªbyte/uint16/uint32æ›¿æ¢ä¸ºå¦ä¸€ä¸ªå€¼ï¼›
- å°†ä¸€ä¸ªASCIIæ•°å­—æ›¿æ¢ä¸ºå¦ä¸€ä¸ªæ•°å­—ï¼›
- æ‹¼æ¥å¦ä¸€ä¸ªè¾“å…¥ï¼›
- æ’å…¥å…¶ä»–è¾“å…¥çš„ä¸€éƒ¨åˆ†ï¼›
- æ’å…¥å­—ç¬¦ä¸²/æ•´æ•°å­—é¢å€¼ï¼›
- æ›¿æ¢ä¸ºå­—ç¬¦ä¸²/æ•´æ•°å­—é¢å€¼ã€‚

ä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯å¯¹è¾“å…¥è¯­æ–™é‡‡ç”¨çªå˜æ–¹æ³•çš„è¾“å…¥æ•°æ®æ¼”è¿›åºåˆ—ï¼š

```go
""
"", "A"
"", "A", "AB"
"", "A", "AB", "ABC"
"", "A", "AB", "ABC", "ABCD"
```

æ”¹å†™æ˜¯æ¯”è¾ƒå…ˆè¿›çš„é«˜çº§æ–¹æ³•ï¼Œå®ƒä¼šå­¦ä¹ æ–‡æœ¬çš„ç»“æ„ï¼Œå¯¹è¾“å…¥è¿›è¡Œç®€å•åˆ†æï¼Œè¯†åˆ«å‡ºè¾“å…¥è¯­æ–™æ•°æ®ä¸­å„ä¸ªéƒ¨åˆ†çš„ç±»å‹ï¼Œæ¯”å¦‚æ•°å­—ã€å­—æ¯æ•°å­—ã€åˆ—è¡¨ã€å¼•ç”¨ç­‰ï¼Œç„¶åé’ˆå¯¹ä¸åŒéƒ¨åˆ†è¿ç”¨çªå˜ç­–ç•¥ã€‚ 

ä¸‹é¢æ˜¯åº”ç”¨æ”¹å†™æ–¹æ³•è¿›è¡Œè¯­æ–™å¤„ç†çš„ä¾‹å­ï¼š

åŸå§‹è¯­æ–™è¾“å…¥ï¼š

```go
`<item name="foo"><prop name="price">100</prop></item>`
```

è¿ç”¨æ”¹å†™æ–¹æ³•åçš„è¾“å…¥æ•°æ®ä¾‹å­ï¼š

```html
<item name="rb54ana"><item name="foo"><prop name="price"></prop><prop/></item></item>
<item name=""><prop name="price">=</prop><prop/> </item>
<item name=""><prop F="">-026023767521520230564132665e0333302100</prop><prop/>
</item>
<item SN="foo_P"><prop name="_G_nx">510</prop><prop name="vC">-9e-07036514</prop></item>
<item name="foo"><prop name="c8">prop name="p"</prop>/}<prop name=" price">01e-6</prop></item>
<item name="foo"><item name="foo"><prop JY="">100</prop></item>8<prop/></item>
```

### 58.3 go-fuzzä½¿ç”¨æ–¹æ³•



### 58.4 ä½¿ç”¨go-fuzzå»ºç«‹æ¨¡ç³Šæµ‹è¯•çš„ç¤ºä¾‹



### 58.5 è®©æ¨¡ç³Šæµ‹è¯•æˆä¸ºâ€œä¸€ç­‰å…¬æ°‘â€



## 59 ä¸ºè¢«æµ‹å¯¹è±¡å»ºç«‹æ€§èƒ½åŸºå‡†

æ˜¯å¦ä¼˜åŒ–ã€ä½•æ—¶ä¼˜åŒ–å®è´¨ä¸Šæ˜¯ä¸€ä¸ª==å†³ç­–é—®é¢˜==ï¼Œä½†==å†³ç­–ä¸èƒ½é ç›´è§‰ï¼Œè¦é æ•°æ®è¯´è¯==ã€‚å€Ÿç”¨ä¸Šé¢åè¨€ä¸­çš„å¥å‹ï¼š**æ²¡æœ‰æ•°æ®æ”¯æ’‘çš„è¿‡æ—©å†³ç­–æ˜¯ä¸‡æ¶ä¹‹æº**ã€‚

ä½œä¸ºä¸€åGoå¼€å‘è€…ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•åšå‡ºæ˜¯å¦å¯¹ä»£ç è¿›è¡Œæ€§èƒ½ä¼˜åŒ–çš„å†³ç­–å‘¢ï¼Ÿå¯ä»¥é€šè¿‡**ä¸ºè¢«æµ‹å¯¹è±¡å»ºç«‹æ€§èƒ½åŸºå‡†çš„æ–¹å¼**å»è·å¾—å†³ç­–æ˜¯å¦ä¼˜åŒ–çš„æ”¯æ’‘æ•°æ®ï¼ŒåŒæ—¶å¯ä»¥æ ¹æ®è¿™äº›æ€§èƒ½åŸºå‡†æ•°æ®åˆ¤æ–­å‡ºå¯¹ä»£ç æ‰€åšçš„ä»»ä½•æ›´æ”¹æ˜¯å¦å¯¹ä»£ç æ€§èƒ½æœ‰æ‰€å½±å“ã€‚

### 59.1 æ€§èƒ½åŸºå‡†æµ‹è¯•åœ¨Goè¯­è¨€ä¸­æ˜¯â€œä¸€ç­‰å…¬æ°‘â€

**æ€§èƒ½åŸºå‡†æµ‹è¯•åœ¨Goè¯­è¨€ä¸­æ˜¯å’Œæ™®é€šçš„å•å…ƒæµ‹è¯•ä¸€æ ·è¢«åŸç”Ÿæ”¯æŒçš„**ï¼Œå¾—åˆ°çš„æ˜¯â€œä¸€ç­‰å…¬æ°‘â€çš„å¾…é‡ã€‚æˆ‘ä»¬å¯ä»¥åƒå¯¹æ™®é€šå•å…ƒæµ‹è¯•é‚£æ ·åœ¨*_test.goæ–‡ä»¶ä¸­åˆ›å»ºè¢«æµ‹å¯¹è±¡çš„æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼Œæ¯ä¸ªä»¥Benchmarkå‰ç¼€å¼€å¤´çš„å‡½æ•°éƒ½ä¼šè¢«å½“ä½œä¸€ä¸ªç‹¬ç«‹çš„æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼š

```go
func BenchmarkXxx(b *testing.B) {
  //...
}
```



### 59.2 é¡ºåºæ‰§è¡Œå’Œå¹¶è¡Œæ‰§è¡Œçš„æ€§èƒ½åŸºå‡†æµ‹è¯•

æ ¹æ®æ˜¯å¦å¹¶è¡Œæ‰§è¡Œï¼ŒGoçš„æ€§èƒ½åŸºå‡†æµ‹è¯•å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š**é¡ºåºæ‰§è¡Œçš„æ€§èƒ½åŸºå‡†æµ‹è¯•å’Œå¹¶è¡Œæ‰§è¡Œçš„æ€§èƒ½åŸºå‡†æµ‹è¯•**ã€‚

#### 1 é¡ºåºæ‰§è¡Œçš„æ€§èƒ½åŸºå‡†æµ‹è¯•

å…¶ä»£ç å†™æ³•å¦‚ä¸‹ï¼š

```go
func BenchmarkXxx(b *testing.B) {
  // ...
  for i := 0; i < b.N; i++ {
    // è¢«æµ‹å¯¹è±¡çš„æ‰§è¡Œä»£ç 
  }
}
```

ğŸ”–ğŸ”–





#### 2 å¹¶è¡Œæ‰§è¡Œçš„æ€§èƒ½åŸºå‡†æµ‹è¯•

```go
func BenchmarkXxx(b *testing.B) {
  // ...
	b.RunParallel(func(pb *testing.PB) {
		for pb.Next() {
			// è¢«æµ‹å¯¹è±¡çš„æ‰§è¡Œä»£ç 
		}
	})
}
```

å¹¶è¡Œæ‰§è¡Œçš„åŸºå‡†æµ‹è¯•ä¸»è¦ç”¨äºä¸ºåŒ…å«å¤šgoroutineåŒæ­¥è®¾æ–½ï¼ˆå¦‚äº’æ–¥é”ã€è¯»å†™é”ã€åŸå­æ“ä½œç­‰ï¼‰çš„è¢«æµ‹ä»£ç å»ºç«‹æ€§èƒ½åŸºå‡†ã€‚ç›¸æ¯”äºé¡ºåºæ‰§è¡Œçš„åŸºå‡†æµ‹è¯•ï¼Œå¹¶è¡Œæ‰§è¡Œçš„åŸºå‡†æµ‹è¯•æ›´èƒ½çœŸå®åæ˜ å‡ºå¤šgoroutineæƒ…å†µä¸‹ï¼Œè¢«æµ‹ä»£ç åœ¨goroutineåŒæ­¥ä¸Šçš„çœŸå®æ¶ˆè€—ã€‚

ğŸ”–ğŸ”–

### 59.3 ä½¿ç”¨æ€§èƒ½åŸºå‡†æ¯”è¾ƒå·¥å…·

#### 1 [benchcmp](https://github.com/golang/tools/tree/master/cmd/benchcmp) ã€deprecationã€‘

```sh
go install golang.org/x/tools/cmd/benchcmp@latest
```





ä¸è¿‡æ€§èƒ½åŸºå‡†æµ‹è¯•çš„è¾“å‡ºç»“æœå—åˆ°å¾ˆå¤šå› ç´ çš„å½±å“ï¼Œæ¯”å¦‚ï¼šåŒä¸€æµ‹è¯•çš„è¿è¡Œæ¬¡æ•°ï¼›æ€§èƒ½åŸºå‡†æµ‹è¯•ä¸å…¶ä»–æ­£åœ¨è¿è¡Œçš„ç¨‹åºå…±äº«ä¸€å°æœºå™¨ï¼›è¿è¡Œæµ‹è¯•çš„ç³»ç»Ÿæœ¬èº«å°±åœ¨è™šæ‹Ÿæœºä¸Šï¼Œä¸å…¶ä»–è™šæ‹Ÿæœºå…±äº«ç¡¬ä»¶ï¼›ç°ä»£æœºå™¨çš„ä¸€äº›èŠ‚èƒ½å’ŒåŠŸç‡ç¼©æ”¾ï¼ˆæ¯”å¦‚CPUçš„è‡ªåŠ¨é™é¢‘å’Œç¿é¢‘ï¼‰ç­‰ã€‚è¿™äº›å› ç´ éƒ½ä¼šé€ æˆå³ä¾¿æ˜¯å¯¹åŒä¸€ä¸ªåŸºå‡†æµ‹è¯•è¿›è¡Œå¤šæ¬¡è¿è¡Œï¼Œè¾“å‡ºçš„ç»“æœä¹Ÿå¯èƒ½æœ‰è¾ƒå¤§åå·®ã€‚ä½†benchcmpå·¥å…·å¹¶ä¸å…³å¿ƒè¿™äº›ç»“æœæ•°æ®åœ¨ç»Ÿè®¡å­¦å±‚é¢æ˜¯å¦æœ‰æ•ˆï¼Œåªå¯¹ç»“æœåšç®€å•æ¯”è¾ƒã€‚

#### 2 [benchstat](https://github.com/golang/perf/tree/master/benchstat)

ä¸ºäº†æé«˜å¯¹æ€§èƒ½åŸºå‡†æ•°æ®æ¯”è¾ƒçš„ç§‘å­¦æ€§ï¼ŒGoæ ¸å¿ƒå›¢é˜Ÿåˆå¼€å‘äº†benchstatè¿™æ¬¾å·¥å…·ä»¥æ›¿ä»£benchcmpã€‚

```sh
benchstat old.txt new.txt
name      old time/op    new time/op   deltaï¿¼
Strcat-8  92.3ns Â± 4%   52.2ns Â± 6%   -43.43%  (p=0.008 n=5+5
```

çœ‹åˆ°ï¼Œå³ä¾¿old.txtå’Œnew.txtä¸­å„è‡ªæœ‰5æ¬¡è¿è¡Œçš„æ•°æ®ï¼Œbenchstatä¹Ÿä¸ä¼šåƒbenchcmpé‚£æ ·è¾“å‡º5è¡Œæ¯”è¾ƒç»“æœï¼Œè€Œæ˜¯è¾“å‡ºä¸€è¡Œç»è¿‡ç»Ÿè®¡å­¦æ–¹æ³•å¤„ç†åçš„æ¯”è¾ƒç»“æœã€‚ä»¥ç¬¬äºŒåˆ—æ•°æ®92.3ns Â± 4%ä¸ºä¾‹ï¼Œè¿™æ˜¯benchcmpå¯¹old.txtä¸­çš„æ•°æ®è¿›è¡Œå¤„ç†åçš„ç»“æœï¼Œå…¶ä¸­Â±4%æ˜¯æ ·æœ¬æ•°æ®ä¸­æœ€å¤§å€¼å’Œæœ€å°å€¼è·æ ·æœ¬å¹³å‡å€¼çš„æœ€å¤§åå·®ç™¾åˆ†æ¯”ã€‚å¦‚æœè¿™ä¸ªåå·®ç™¾åˆ†æ¯”å¤§äº5%ï¼Œåˆ™è¯´æ˜æ ·æœ¬æ•°æ®è´¨é‡ä¸ä½³ï¼Œæœ‰äº›æ ·æœ¬æ•°æ®æ˜¯ä¸å¯ä¿¡çš„ã€‚ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œnew.txtä¸­çš„æ ·æœ¬æ•°æ®æ˜¯è´¨é‡ä¸ä½³çš„ã€‚

benchstatè¾“å‡ºç»“æœçš„æœ€åä¸€åˆ—ï¼ˆdeltaï¼‰ä¸ºä¸¤æ¬¡åŸºå‡†æµ‹è¯•å¯¹æ¯”çš„å˜åŒ–é‡ã€‚æˆ‘ä»¬çœ‹åˆ°ï¼Œé‡‡ç”¨strings.Joinæ–¹æ³•è¿æ¥å­—ç¬¦ä¸²çš„å¹³å‡è€—æ—¶æ¯”é‡‡ç”¨åŸç”Ÿæ“ä½œç¬¦è¿æ¥å­—ç¬¦ä¸²çŸ­43%ï¼Œè¿™ä¸ªæŒ‡æ ‡åé¢æ‹¬å·ä¸­çš„p=0.008æ˜¯ä¸€ä¸ªç”¨äºè¡¡é‡ä¸¤ä¸ªæ ·æœ¬é›†åˆçš„å‡å€¼æ˜¯å¦æœ‰æ˜¾è‘—å·®å¼‚çš„æŒ‡æ ‡ã€‚benchstatæ”¯æŒä¸¤ç§æ£€éªŒç®—æ³•ï¼šä¸€ç§æ˜¯UTestï¼ˆMann Whitney UTestï¼Œæ›¼-æƒ ç‰¹å°¼Uæ£€éªŒï¼‰ï¼ŒUTestæ˜¯é»˜è®¤çš„æ£€éªŒç®—æ³•ï¼›å¦å¤–ä¸€ç§æ˜¯Welch Tæ£€éªŒï¼ˆTTestï¼‰ã€‚ä¸€èˆ¬på€¼å°äº0.05çš„ç»“æœæ˜¯å¯æ¥å—çš„ã€‚



```sh
$ go test -run=NONE -count 5 -bench . strcat_test.go -benchmem > old_with_mem.txt
$ go test -run=NONE -count 5 -bench . strcat_test.go -benchmem > new_with_mem.txt

$ benchstat old_with_mem.txt new_with_mem.txt
goos: darwin
goarch: arm64
cpu: Apple M1
         â”‚ old_with_mem.txt â”‚          new_with_mem.txt           â”‚
         â”‚      sec/op      â”‚    sec/op     vs base               â”‚
Strcat-8       47.38n Â± âˆ Â¹   30.07n Â± âˆ Â¹  -36.53% (p=0.008 n=5)
Â¹ need >= 6 samples for confidence interval at level 0.95

         â”‚ old_with_mem.txt â”‚          new_with_mem.txt          â”‚
         â”‚       B/op       â”‚    B/op      vs base               â”‚
Strcat-8        80.00 Â± âˆ Â¹   48.00 Â± âˆ Â¹  -40.00% (p=0.008 n=5)
Â¹ need >= 6 samples for confidence interval at level 0.95

         â”‚ old_with_mem.txt â”‚          new_with_mem.txt          â”‚
         â”‚    allocs/op     â”‚  allocs/op   vs base               â”‚
Strcat-8        2.000 Â± âˆ Â¹   1.000 Â± âˆ Â¹  -50.00% (p=0.008 n=5)
Â¹ need >= 6 samples for confidence interval at level 0.95
```



### 59.4 æ’é™¤é¢å¤–å¹²æ‰°ï¼Œè®©åŸºå‡†æµ‹è¯•æ›´ç²¾ç¡®

æœ‰äº›å¤æ‚çš„åŸºå‡†æµ‹è¯•åœ¨çœŸæ­£æ‰§è¡ŒForå¾ªç¯ä¹‹å‰æˆ–è€…åœ¨æ¯ä¸ªå¾ªç¯ä¸­ï¼Œé™¤äº†æ‰§è¡ŒçœŸæ­£çš„è¢«æµ‹ä»£ç ä¹‹å¤–ï¼Œå¯èƒ½è¿˜éœ€è¦åšä¸€äº›æµ‹è¯•å‡†å¤‡å·¥ä½œï¼Œæ¯”å¦‚**å»ºç«‹åŸºå‡†æµ‹è¯•æ‰€éœ€çš„æµ‹è¯•ä¸Šä¸‹æ–‡ç­‰**ã€‚å¦‚æœä¸åšç‰¹æ®Šå¤„ç†ï¼Œè¿™äº›æµ‹è¯•å‡†å¤‡å·¥ä½œæ‰€æ¶ˆè€—çš„æ—¶é—´ä¹Ÿä¼šè¢«ç®—å…¥æœ€ç»ˆç»“æœä¸­ï¼Œè¿™å°±ä¼šå¯¼è‡´æœ€ç»ˆåŸºå‡†æµ‹è¯•çš„æ•°æ®å—åˆ°å¹²æ‰°è€Œä¸å¤Ÿç²¾ç¡®ã€‚ä¸ºæ­¤ï¼Œtesting.Bä¸­æä¾›äº†**å¤šç§çµæ´»æ“æ§åŸºå‡†æµ‹è¯•è®¡æ—¶å™¨çš„æ–¹æ³•ï¼Œé€šè¿‡è¿™äº›æ–¹æ³•å¯ä»¥æ’é™¤æ‰é¢å¤–å¹²æ‰°**ï¼Œè®©åŸºå‡†æµ‹è¯•ç»“æœæ›´èƒ½åæ˜ è¢«æµ‹ä»£ç çš„çœŸå®æ€§èƒ½ã€‚

```sh
$ go test -bench . benchmark_with_expensive_context_setup_test.go 
goos: darwin
goarch: arm64
cpu: Apple M1
BenchmarkStrcatWithTestContextSetup-8                   25617231                39.55 ns/op
BenchmarkStrcatWithTestContextSetupAndResetTimer-8      37295137                30.54 ns/op
BenchmarkStrcatWithTestContextSetupAndRestartTimer-8    37561339                31.29 ns/op
BenchmarkStrcat-8                                       39039942                31.76 ns/op
PASS
ok      command-line-arguments  11.767s

```

å¦‚æœä¸é€šè¿‡testing.Bæä¾›çš„è®¡æ•°å™¨æ§åˆ¶æ¥å£å¯¹æµ‹è¯•ä¸Šä¸‹æ–‡å¸¦æ¥çš„æ¶ˆè€—è¿›è¡Œéš”ç¦»ï¼Œæœ€ç»ˆåŸºå‡†æµ‹è¯•å¾—åˆ°çš„æ•°æ®ï¼ˆBenchmarkStrcatWithTestContextSetupï¼‰å°†åç¦»å‡†ç¡®æ•°æ®ï¼ˆBenchmarkStrcatï¼‰å¾ˆè¿œã€‚è€Œé€šè¿‡testing.Bæä¾›çš„è®¡æ•°å™¨æ§åˆ¶æ¥å£å¯¹æµ‹è¯•ä¸Šä¸‹æ–‡å¸¦æ¥çš„æ¶ˆè€—è¿›è¡Œéš”ç¦»åï¼Œå¾—åˆ°çš„åŸºå‡†æµ‹è¯•æ•°æ®ï¼ˆBenchmarkStrcatWithTestContextSetupAndResetTimerå’ŒBench-markStrcatWithTestContextSetupAndRestartTimerï¼‰åˆ™éå¸¸æ¥è¿‘çœŸå®æ•°æ®ã€‚

### å°ç»“

æ— è®ºä½ æ˜¯å¦è®¤ä¸ºæ€§èƒ½å¾ˆé‡è¦ï¼Œéƒ½è¯·ä½ ä¸ºè¢«æµ‹ä»£ç ï¼ˆå°¤å…¶æ˜¯ä½äºç³»ç»Ÿå…³é”®ä¸šåŠ¡è·¯å¾„ä¸Šçš„ä»£ç ï¼‰å»ºç«‹æ€§èƒ½åŸºå‡†ã€‚å¦‚æœä½ ç¼–å†™çš„æ˜¯ä¾›å…¶ä»–äººä½¿ç”¨çš„è½¯ä»¶åŒ…ï¼Œåˆ™æ›´åº”å¦‚æ­¤ã€‚åªæœ‰è¿™æ ·ï¼Œæˆ‘ä»¬æ‰èƒ½è‡³å°‘ä¿è¯åç»­å¯¹ä»£ç çš„ä¿®æ”¹ä¸ä¼šå¸¦æ¥æ€§èƒ½å›é€€ã€‚å·²ç»å»ºç«‹çš„æ€§èƒ½åŸºå‡†å¯ä»¥ä¸ºåç»­æ˜¯å¦è¿›ä¸€æ­¥ä¼˜åŒ–çš„å†³ç­–æä¾›æ•°æ®æ”¯æ’‘ï¼Œè€Œä¸æ˜¯é ç¨‹åºå‘˜çš„ç›´è§‰ã€‚



## 60 ä½¿ç”¨pprofå¯¹ç¨‹åºè¿›è¡Œæ€§èƒ½å‰–æ

Goæ˜¯â€œè‡ªå¸¦ç”µæ± â€ï¼ˆbattery includedï¼‰çš„ç¼–ç¨‹è¯­è¨€ï¼Œæ‹¥æœ‰ç€è®©å…¶ä»–ä¸»æµè¯­è¨€ç¾¡æ…•çš„å·¥å…·é“¾ï¼ŒGoè¿˜å†…ç½®äº†å¯¹ä»£ç è¿›è¡Œæ€§èƒ½å‰–æçš„å·¥å…·ï¼špprofã€‚

`pprof` çš„å…¨ç§°æ˜¯ **Performance Profiler**ï¼ˆæ€§èƒ½åˆ†æå™¨ï¼‰ï¼Œå®ƒæ˜¯ Go è¯­è¨€å®˜æ–¹æä¾›çš„**æ€§èƒ½åˆ†æå·¥å…·**ï¼Œä¸»è¦ç”¨äºè¯Šæ–­ç¨‹åºåœ¨ CPUã€å†…å­˜ã€é˜»å¡ã€åç¨‹ç­‰æ–¹é¢çš„æ€§èƒ½ç“¶é¢ˆã€‚

### 60.1 pprofçš„å·¥ä½œåŸç†

ä½¿ç”¨pprofå¯¹ç¨‹åºè¿›è¡Œæ€§èƒ½å‰–æçš„å·¥ä½œä¸€èˆ¬åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š**æ•°æ®é‡‡é›†å’Œæ•°æ®å‰–æ**ã€‚

![](images/image-20250413103954463.png)

#### 1 é‡‡é›†æ•°æ®ç±»å‹

åœ¨æ•°æ®é‡‡é›†é˜¶æ®µï¼ŒGoè¿è¡Œæ—¶ä¼šå®šæœŸå¯¹å‰–æé˜¶æ®µæ‰€éœ€çš„ä¸åŒç±»å‹æ•°æ®è¿›è¡Œé‡‡æ ·è®°å½•ã€‚å½“å‰ä¸»è¦æ”¯æŒçš„é‡‡æ ·æ•°æ®ç±»å‹æœ‰å¦‚ä¸‹å‡ ç§

1. CPUæ•°æ®ï¼ˆcpu.profï¼‰

CPUç±»å‹é‡‡æ ·æ•°æ®æ˜¯æ€§èƒ½å‰–æä¸­ååˆ†å¸¸è§çš„é‡‡æ ·æ•°æ®ç±»å‹ï¼Œå®ƒèƒ½å¸®åŠ©æˆ‘ä»¬è¯†åˆ«å‡ºä»£ç å…³é”®è·¯å¾„ä¸Šæ¶ˆè€—CPUæœ€å¤šçš„å‡½æ•°ã€‚ä¸€æ—¦å¯ç”¨CPUæ•°æ®é‡‡æ ·ï¼ŒGoè¿è¡Œæ—¶ä¼šæ¯éš”ä¸€æ®µçŸ­æš‚çš„æ—¶é—´ï¼ˆ10msï¼‰å°±ä¸­æ–­ä¸€æ¬¡ï¼ˆç”±SIGPROFä¿¡å·å¼•å‘ï¼‰å¹¶è®°å½•å½“å‰æ‰€æœ‰goroutineçš„å‡½æ•°æ ˆä¿¡æ¯ï¼ˆå­˜å…¥cpu.profï¼‰ã€‚

2. å †å†…å­˜åˆ†é…æ•°æ®ï¼ˆmem.profï¼‰

å †å†…å­˜åˆ†é…é‡‡æ ·æ•°æ®å’ŒCPUé‡‡æ ·æ•°æ®ä¸€æ ·ï¼Œä¹Ÿæ˜¯æ€§èƒ½å‰–æä¸­ååˆ†å¸¸è§çš„é‡‡æ ·æ•°æ®ç±»å‹ï¼Œå®ƒèƒ½å¸®åŠ©æˆ‘ä»¬äº†è§£Goç¨‹åºçš„å½“å‰å’Œå†å²å†…å­˜ä½¿ç”¨æƒ…å†µã€‚å †å†…å­˜åˆ†é…çš„é‡‡æ ·é¢‘ç‡å¯é…ç½®ï¼Œé»˜è®¤æ¯1000æ¬¡å †å†…å­˜åˆ†é…ä¼šåšä¸€æ¬¡é‡‡æ ·ï¼ˆå­˜å…¥mem.profï¼‰

3. é”ç«äº‰æ•°æ®ï¼ˆmutex.profï¼‰

é”ç«äº‰é‡‡æ ·æ•°æ®è®°å½•äº†å½“å‰Goç¨‹åºä¸­äº’æ–¥é”äº‰ç”¨å¯¼è‡´å»¶è¿Ÿçš„æ“ä½œã€‚å¦‚æœä½ è®¤ä¸ºå¾ˆå¤§å¯èƒ½æ˜¯äº’æ–¥é”äº‰ç”¨å¯¼è‡´CPUåˆ©ç”¨ç‡ä¸é«˜ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä¸º`go tool pprof`å·¥å…·æä¾›æ­¤ç±»é‡‡æ ·æ–‡ä»¶ä»¥ä¾›æ€§èƒ½å‰–æé˜¶æ®µä½¿ç”¨ã€‚è¯¥ç±»å‹é‡‡æ ·æ•°æ®åœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸å¯ç”¨çš„ï¼Œè¯·å‚è§`runtime.SetMutexProfileFraction`æˆ–`go test -bench . xxx_test.go -mutexprofile mutex.out`å¯ç”¨å®ƒã€‚

4. é˜»å¡æ—¶é—´æ•°æ®ï¼ˆblock.profï¼‰

è¯¥ç±»å‹é‡‡æ ·æ•°æ®è®°å½•çš„æ˜¯goroutineåœ¨æŸå…±äº«èµ„æºï¼ˆä¸€èˆ¬æ˜¯ç”±åŒæ­¥åŸè¯­ä¿æŠ¤ï¼‰ä¸Šçš„é˜»å¡æ—¶é—´ï¼ŒåŒ…æ‹¬ä»æ— ç¼“å†²channelæ”¶å‘æ•°æ®ã€é˜»å¡åœ¨ä¸€ä¸ªå·²ç»è¢«å…¶ä»–goroutineé”ä½çš„äº’æ–¥é”ã€å‘ä¸€ä¸ªæ»¡äº†çš„channelå‘é€æ•°æ®æˆ–ä»ä¸€ä¸ªç©ºçš„channelæ¥æ”¶æ•°æ®ç­‰ã€‚è¯¥ç±»å‹é‡‡æ ·æ•°æ®åœ¨é»˜è®¤æƒ…å†µä¸‹ä¹Ÿæ˜¯ä¸å¯ç”¨çš„ï¼Œè¯·å‚è§`runtime.SetBlockProfileRate`æˆ–`go test -bench . xxx_test.go -blockprofile block.out`å¯ç”¨å®ƒã€‚

#### 2 æ€§èƒ½æ•°æ®é‡‡é›†çš„æ–¹å¼

Goç›®å‰ä¸»è¦æ”¯æŒä¸¤ç§æ€§èƒ½æ•°æ®é‡‡é›†æ–¹å¼ï¼šæ€§èƒ½åŸºå‡†æµ‹è¯•å’Œç‹¬ç«‹ç¨‹åºã€‚

1. æ€§èƒ½åŸºå‡†æµ‹è¯•

ä¸ºåº”ç”¨ä¸­çš„å…³é”®å‡½æ•°/æ–¹æ³•å»ºç«‹èµ·æ€§èƒ½åŸºå‡†æµ‹è¯•ä¹‹åï¼Œä¾¿å¯ä»¥é€šè¿‡æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•é‡‡é›†åˆ°æ•´ä¸ªæµ‹è¯•æ‰§è¡Œè¿‡ç¨‹ä¸­æœ‰å…³è¢«æµ‹æ–¹æ³•çš„å„ç±»æ€§èƒ½æ•°æ®ã€‚è¿™ç§æ–¹å¼å°¤å…¶é€‚ç”¨äºå¯¹åº”ç”¨ä¸­å…³é”®è·¯å¾„ä¸Šå…³é”®å‡½æ•°/æ–¹æ³•æ€§èƒ½çš„å‰–æã€‚

ä»…éœ€ä¸ºgo testå¢åŠ ä¸€äº›å‘½ä»¤è¡Œé€‰é¡¹å³å¯åœ¨æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•çš„åŒæ—¶è¿›è¡Œæ€§èƒ½æ•°æ®é‡‡é›†ã€‚ä»¥CPUé‡‡æ ·æ•°æ®ç±»å‹ä¸ºä¾‹ï¼š

```sh
$ go test -bench . xxx_test.go -cpuprofile=cpu.prof
$ lsï¿¼
cpu.prof xxx.test* xxx_test.go
```

ä¸€æ—¦å¼€å¯æ€§èƒ½æ•°æ®é‡‡é›†ï¼ˆæ¯”å¦‚ä¼ å…¥-cpuprofileï¼‰ï¼Œgo testçš„-cå‘½ä»¤é€‰é¡¹ä¾¿ä¼šè‡ªåŠ¨å¼€å¯ï¼Œgo testå‘½ä»¤æ‰§è¡Œåä¼šè‡ªåŠ¨ç¼–è¯‘å‡ºä¸€ä¸ªä¸è¯¥æµ‹è¯•å¯¹åº”çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆè¿™é‡Œæ˜¯xxx.testï¼‰ã€‚è¯¥å¯æ‰§è¡Œæ–‡ä»¶å¯ä»¥åœ¨æ€§èƒ½æ•°æ®å‰–æè¿‡ç¨‹ä¸­æä¾›å‰–ææ‰€éœ€çš„ç¬¦å·ä¿¡æ¯ï¼ˆå¦‚æœæ²¡æœ‰è¯¥å¯æ‰§è¡Œæ–‡ä»¶ï¼Œgo tool pprofçš„disasmå‘½ä»¤å°†æ— æ³•ç»™å‡ºå¯¹åº”ç¬¦å·çš„æ±‡ç¼–ä»£ç ï¼‰ã€‚è€Œcpu.profå°±æ˜¯å­˜å‚¨CPUæ€§èƒ½é‡‡æ ·æ•°æ®çš„ç»“æœæ–‡ä»¶ï¼Œåç»­å°†ä½œä¸ºæ•°æ®å‰–æè¿‡ç¨‹çš„è¾“å…¥ã€‚

å…¶ä»–ç±»å‹çš„é‡‡æ ·æ•°æ®:

```sh
go test -bench . xxx_test.go -memprofile=mem.profï¿¼
go test -bench . xxx_test.go -blockprofile=block.profï¿¼
go test -bench . xxx_test.go -mutexprofile=mutex.prof
```

2. ç‹¬ç«‹ç¨‹åºçš„æ€§èƒ½æ•°æ®é‡‡é›†

å¯ä»¥é€šè¿‡1ï¸âƒ£æ ‡å‡†åº“`runtime/pprof`å’Œ`runtime`åŒ…æä¾›çš„ä½çº§APIå¯¹ç‹¬ç«‹ç¨‹åºè¿›è¡Œæ€§èƒ½æ•°æ®é‡‡é›†ã€‚



è¿™ç§ç‹¬ç«‹ç¨‹åºçš„æ€§èƒ½æ•°æ®é‡‡é›†æ–¹å¼**å¯¹ä¸šåŠ¡ä»£ç ä¾µå…¥è¾ƒå¤š**ï¼Œè¿˜è¦è‡ªå·±ç¼–å†™ä¸€äº›é‡‡é›†é€»è¾‘ï¼š**å®šä¹‰flagå˜é‡ã€åˆ›å»ºè¾“å‡ºæ–‡ä»¶ã€å…³é—­è¾“å‡ºæ–‡ä»¶**ç­‰ã€‚æ¯æ¬¡é‡‡é›†éƒ½è¦åœæ­¢ç¨‹åºæ‰èƒ½è·å–ç»“æœã€‚ï¼ˆå½“ç„¶å¯ä»¥é‡æ–°å®šä¹‰æ›´å¤æ‚çš„æ§åˆ¶é‡‡é›†æ—¶é—´çª—å£çš„é€»è¾‘ï¼Œå®ç°ä¸åœæ­¢ç¨‹åºä¹Ÿèƒ½è·å–é‡‡é›†æ•°æ®ç»“æœã€‚ï¼‰

Goåœ¨2ï¸âƒ£`net/http/pprof`åŒ…ä¸­è¿˜æä¾›äº†ä¸€ç§æ›´ä¸ºé«˜çº§çš„é’ˆå¯¹ç‹¬ç«‹ç¨‹åºçš„æ€§èƒ½æ•°æ®é‡‡é›†æ–¹å¼ï¼Œè¿™ç§æ–¹å¼å°¤å…¶é€‚åˆé‚£äº›**å†…ç½®äº†HTTPæœåŠ¡**çš„ç‹¬ç«‹ç¨‹åºã€‚net/http/pprofåŒ…å¯ä»¥ç›´æ¥åˆ©ç”¨å·²æœ‰çš„HTTPæœåŠ¡**å¯¹å¤–æä¾›ç”¨äºæ€§èƒ½æ•°æ®é‡‡é›†çš„æœåŠ¡ç«¯ç‚¹ï¼ˆendpointï¼‰**ã€‚

```go
package main

import (
	"context"
	"fmt"
	"net/http"
	_ "net/http/pprof"
	"os"
	"os/signal"
	"syscall"
)

func main() {
	http.Handle("/hello", http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		fmt.Println(*r)
		w.Write([]byte("hello"))
	}))
	s := http.Server{
		Addr: "localhost:8080",
	}
	c := make(chan os.Signal, 1)
	signal.Notify(c, syscall.SIGINT, syscall.SIGTERM)
	go func() {
		<-c
		s.Shutdown(context.Background())
	}()
	fmt.Println(s.ListenAndServe())
}
```





```go
// //$GOROOT/src/net/http/pprof/pprof.go

func init() {
	prefix := ""
	if godebug.New("httpmuxgo121").Value() != "1" {
		prefix = "GET "
	}
	http.HandleFunc(prefix+"/debug/pprof/", Index)
	http.HandleFunc(prefix+"/debug/pprof/cmdline", Cmdline)
	http.HandleFunc(prefix+"/debug/pprof/profile", Profile)
	http.HandleFunc(prefix+"/debug/pprof/symbol", Symbol)
	http.HandleFunc(prefix+"/debug/pprof/trace", Trace)
}
```

è¯¥åŒ…çš„initå‡½æ•°å‘httpåŒ…çš„é»˜è®¤è¯·æ±‚è·¯ç”±å™¨DefaultServeMuxæ³¨å†Œäº†å¤šä¸ªæœåŠ¡ç«¯ç‚¹å’Œå¯¹åº”çš„å¤„ç†å‡½æ•°ã€‚è€Œæ­£æ˜¯é€šè¿‡è¿™äº›æœåŠ¡ç«¯ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¯¥ç‹¬ç«‹ç¨‹åºè¿è¡ŒæœŸé—´è·å–å„ç§ç±»å‹çš„æ€§èƒ½é‡‡é›†æ•°æ®ã€‚ç°åœ¨æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®http://localhost:8080/debug/pprof/ã€‚

![net/http/pprofæä¾›çš„æ€§èƒ½é‡‡é›†é¡µé¢](images/image-20250723205116125.png)

è¿™ä¸ªé¡µé¢é‡Œåˆ—å‡ºäº†å¤šç§ç±»å‹çš„æ€§èƒ½é‡‡é›†æ•°æ®ï¼Œ**ç‚¹å‡»å…¶ä¸­ä»»ä½•ä¸€ä¸ªå³å¯å®Œæˆè¯¥ç§ç±»å‹æ€§èƒ½æ•°æ®çš„ä¸€æ¬¡é‡‡é›†**ã€‚profileæ˜¯CPUç±»å‹æ•°æ®çš„æœåŠ¡ç«¯ç‚¹ï¼Œç‚¹å‡»è¯¥ç«¯ç‚¹åï¼Œè¯¥æœåŠ¡é»˜è®¤ä¼šå‘èµ·ä¸€æ¬¡æŒç»­30ç§’çš„æ€§èƒ½é‡‡é›†ï¼Œå¾—åˆ°çš„æ•°æ®æ–‡ä»¶ä¼šç”±æµè§ˆå™¨è‡ªåŠ¨ä¸‹è½½åˆ°æœ¬åœ°ã€‚å¦‚æœæƒ³è‡ªå®šä¹‰é‡‡é›†æ—¶é•¿ï¼Œå¯ä»¥é€šè¿‡ä¸ºæœåŠ¡ç«¯ç‚¹ä¼ é€’æ—¶é•¿å‚æ•°å®ç°ï¼Œæ¯”å¦‚ä¸‹é¢å°±æ˜¯ä¸€ä¸ªé‡‡æ ·60ç§’çš„è¯·æ±‚ï¼š

```
http://localhost:8080/debug/pprof/profile?seconds=60
```



å¦‚æœç‹¬ç«‹ç¨‹åºçš„ä»£ç ä¸­æ²¡æœ‰ä½¿ç”¨httpåŒ…çš„é»˜è®¤è¯·æ±‚è·¯ç”±å™¨DefaultServeMuxï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦é‡æ–°åœ¨æ–°çš„è·¯ç”±å™¨ä¸Šä¸ºpprofåŒ…æä¾›çš„æ€§èƒ½æ•°æ®é‡‡é›†æ–¹æ³•æ³¨å†ŒæœåŠ¡ç«¯ç‚¹



å¦‚æœæ˜¯éHTTPæœåŠ¡ç¨‹åºï¼Œåˆ™åœ¨å¯¼å…¥åŒ…çš„åŒæ—¶è¿˜éœ€å•ç‹¬å¯åŠ¨ä¸€ä¸ªç”¨äºæ€§èƒ½æ•°æ®é‡‡é›†çš„goroutineã€‚



é€šè¿‡ä¸Šé¢å‡ ä¸ªç¤ºä¾‹æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œç›¸æ¯”ç¬¬ä¸€ç§æ–¹å¼ï¼Œå¯¼å…¥net/http/pprofåŒ…è¿›è¡Œç‹¬ç«‹ç¨‹åºæ€§èƒ½æ•°æ®é‡‡é›†çš„æ–¹å¼ä¾µå…¥æ€§æ›´å°ï¼Œä»£ç ä¹Ÿæ›´ä¸ºç‹¬ç«‹ï¼Œå¹¶ä¸”æ— é¡»åœæ­¢ç¨‹åºï¼Œé€šè¿‡é¢„ç½®å¥½çš„å„ç±»æ€§èƒ½æ•°æ®é‡‡é›†æœåŠ¡ç«¯ç‚¹å³å¯éšæ—¶è¿›è¡Œæ€§èƒ½æ•°æ®é‡‡é›†ã€‚

#### 3 æ€§èƒ½æ•°æ®çš„å‰–æ

Goå·¥å…·é“¾é€šè¿‡pprofå­å‘½ä»¤æä¾›äº†ä¸¤ç§æ€§èƒ½æ•°æ®å‰–ææ–¹æ³•ï¼š**å‘½ä»¤è¡Œäº¤äº’å¼å’ŒWebå›¾å½¢åŒ–**ã€‚å‘½ä»¤è¡Œäº¤äº’å¼çš„å‰–ææ–¹æ³•æ›´å¸¸ç”¨ï¼Œä¹Ÿæ˜¯åŸºæœ¬çš„æ€§èƒ½æ•°æ®å‰–ææ–¹æ³•ï¼›è€ŒåŸºäºWebå›¾å½¢åŒ–çš„å‰–ææ–¹æ³•åœ¨å‰–æç»“æœå±•ç¤ºä¸Šæ›´ä¸ºç›´è§‚ã€‚

##### å‘½ä»¤è¡Œäº¤äº’æ–¹å¼

ä¸‰ç§æ–¹å¼æ‰§è¡Œgo tool pprofä»¥è¿›å…¥é‡‡ç”¨å‘½ä»¤è¡Œäº¤äº’å¼çš„æ€§èƒ½æ•°æ®å‰–æç¯èŠ‚ï¼š

```sh
// å‰–æé€šè¿‡æ€§èƒ½åŸºå‡†æµ‹è¯•é‡‡é›†çš„æ•°æ®
$ go tool pprof xxx.test cpu.prof 
// å‰–æç‹¬ç«‹ç¨‹åºè¾“å‡ºçš„æ€§èƒ½é‡‡é›†æ•°æ®ï¿¼
$ go tool pprof standalone_app cpu.prof 
// é€šè¿‡net/http/pprofæ³¨å†Œçš„æ€§èƒ½é‡‡é›†æ•°æ®æœåŠ¡ç«¯ç‚¹è·å–æ•°æ®å¹¶å‰–æï¿¼
$ go tool pprof http://localhost:8080/debug/pprof/profile
```



ä»¥pprof_standalone1.goè¿™ä¸ªç¤ºä¾‹çš„æ€§èƒ½é‡‡é›†æ•°æ®ä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹åœ¨å‘½ä»¤è¡Œäº¤äº’å¼çš„å‰–æç¯èŠ‚ï¼Œæœ‰å“ªäº›å¸¸ç”¨å‘½ä»¤å¯ç”¨ã€‚

é¦–å…ˆç”ŸæˆCPUç±»å‹æ€§èƒ½é‡‡é›†æ•°æ®ï¼š

```sh
$ go build -o pprof_standalone1 pprof_standalone1.goï¿¼
$ ./pprof_standalone1 -cpuprofile pprof_standalone1_cpu.prof
^Cprogram exit
```

é€šè¿‡`go tool pprof`å‘½ä»¤è¿›å…¥å‘½ä»¤è¡Œäº¤äº’æ¨¡å¼ï¼š

```sh
$ go tool pprof pprof_standalone1 pprof_standalone1_cpu.prof
File: pprof_standalone1
Type: cpu
Time: 2025-07-23 21:36:26 CST
Duration: 6.73s, Total samples = 40ms ( 0.59%)
Entering interactive mode (type "help" for commands, "o" for options)
(pprof) 
```

ä»pprofå­å‘½ä»¤çš„è¾“å‡ºä¸­æˆ‘ä»¬çœ‹åˆ°ï¼šç¨‹åºè¿è¡Œ6.73sï¼Œé‡‡æ ·æ€»æ—¶é—´ä¸º40msï¼Œå æ€»æ—¶é—´çš„0.59%ã€‚

æœ€å¸¸ç”¨çš„å‘½ä»¤æ˜¯topNï¼ˆNä¸ºæ•°å­—ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤ç­‰äº10ï¼‰ï¼š

```sh
(pprof) top
Showing nodes accounting for 40ms, 100% of 40ms total
Showing top 10 nodes out of 16
      flat  flat%   sum%        cum   cum%
      20ms 50.00% 50.00%       20ms 50.00%  runtime.kevent
      10ms 25.00% 75.00%       10ms 25.00%  fmt.Fprintln
      10ms 25.00%   100%       10ms 25.00%  runtime.pthread_cond_signal
         0     0%   100%       10ms 25.00%  fmt.Println (inline)
         0     0%   100%       10ms 25.00%  main.main
         0     0%   100%       20ms 50.00%  runtime.findRunnable
         0     0%   100%       10ms 25.00%  runtime.main
         0     0%   100%       30ms 75.00%  runtime.mcall
         0     0%   100%       20ms 50.00%  runtime.netpoll
         0     0%   100%       10ms 25.00%  runtime.notewakeup
(pprof)
```

ğŸ”–

```sh
(pprof) top -cum
```



```sh
(pprof) list main.main
```



```sh
(pprof) list time.Sleepï¿¼
```



è¿˜å¯ä»¥ç”ŸæˆCPUé‡‡æ ·æ•°æ®çš„å‡½æ•°è°ƒç”¨å›¾:

```sh
(pprof) png
Generating report in profile001.png
```



##### Webå›¾å½¢åŒ–æ–¹å¼

```sh
$ go tool pprof -http=:9090 pprof_standalone1_cpu.prof
```



### 60.2 ä½¿ç”¨pprofè¿›è¡Œæ€§èƒ½å‰–æçš„å®ä¾‹ ğŸ”–ğŸ”–

#### 1 å¾…ä¼˜åŒ–ç¨‹åºï¼ˆstep0ï¼‰



#### 2 CPUç±»æ€§èƒ½æ•°æ®é‡‡æ ·åŠæ•°æ®å‰–æï¼ˆstep1ï¼‰



```sh
$ go test -v -run=^$ -bench=.
goos: darwin
goarch: arm64
pkg: gofirst/ch60pprof/2/step1
cpu: Apple M1
BenchmarkHi
BenchmarkHi-8             675636              1499 ns/op
PASS
ok      gofirst/ch60pprof/2/step1       1.240s

```



```sh
$ go test -v -run=^$ -bench=^BenchmarkHi$ -benchtime=2s -cpuprofile=cpu.prof
goos: darwin
goarch: arm64
pkg: gofirst/ch60pprof/2/step1
cpu: Apple M1
BenchmarkHi
BenchmarkHi-8            1585893              1561 ns/op
PASS
ok      gofirst/ch60pprof/2/step1       4.176s

$ go tool pprof step1.test cpu.prof
File: step1.test
Type: cpu
Time: 2025-07-23 22:01:33 CST
Duration: 3.73s, Total samples = 3.39s (90.85%)
Entering interactive mode (type "help" for commands, "o" for options)
(pprof) top -cum
Showing nodes accounting for 1.41s, 41.59% of 3.39s total
Dropped 56 nodes (cum <= 0.02s)
Showing top 10 nodes out of 131
      flat  flat%   sum%        cum   cum%
         0     0%     0%      2.38s 70.21%  gofirst/ch60pprof/2/step1.BenchmarkHi
     0.01s  0.29%  0.29%      2.38s 70.21%  gofirst/ch60pprof/2/step1.handleHi
         0     0%  0.29%      2.38s 70.21%  testing.(*B).launch
         0     0%  0.29%      2.38s 70.21%  testing.(*B).runN
     1.40s 41.30% 41.59%      1.40s 41.30%  runtime.memmove
         0     0% 41.59%      1.37s 40.41%  bytes.(*Buffer).Write
         0     0% 41.59%      1.37s 40.41%  net/http/httptest.(*ResponseRecorder).Write
         0     0% 41.59%      0.94s 27.73%  runtime.systemstack
         0     0% 41.59%      0.92s 27.14%  regexp.MatchString
         0     0% 41.59%      0.90s 26.55%  regexp.Compile (inline)
(pprof) list handleHi
Total: 3.39s
ROUTINE ======================== gofirst/ch60pprof/2/step1.handleHi in /Users/andyron/myfield/github/LearnGo/Goè¯­è¨€ç¬¬ä¸€è¯¾/gofirst/ch60pprof/2/step1/demo.go
      10ms      2.38s (flat, cum) 70.21% of Total
         .          .     13:func handleHi(w http.ResponseWriter, r *http.Request) {
      10ms      930ms     14:   if match, _ := regexp.MatchString(`^\w*$`, r.FormValue("color")); !match {
         .          .     15:           http.Error(w, "Optional color is invalid", http.StatusBadRequest)
         .          .     16:           return
         .          .     17:   }
         .          .     18:   visitNum := atomic.AddInt64(&visitors, 1)
         .       30ms     19:   w.Header().Set("Content-Type", "text/html; charset=utf-8")
         .      1.37s     20:   w.Write([]byte("<h1 style='color: " + r.FormValue("color") +
         .       50ms     21:           "'>Welcome!</h1>You are visitor number " + fmt.Sprint(visitNum) + "!"))
         .          .     22:}
         .          .     23:
         .          .     24:func main() {
         .          .     25:   log.Printf("Starting on port 8080")
         .          .     26:   http.HandleFunc("/hi", handleHi)
(pprof) 

```



#### 3 ç¬¬ä¸€æ¬¡ä¼˜åŒ–ï¼ˆstep2ï¼‰



```sh
$ go test -v -run=^$ -bench=.
goos: darwin
goarch: arm64
pkg: gofirst/ch60pprof/2/step2
cpu: Apple M1
BenchmarkHi
BenchmarkHi-8            5292670               226.6 ns/op           298 B/op          4 allocs/op
PASS
ok      gofirst/ch60pprof/2/step2       1.916s

```



#### 4 å†…å­˜åˆ†é…é‡‡æ ·æ•°æ®å‰–æ



#### 5 ç¬¬äºŒæ¬¡ä¼˜åŒ–ï¼ˆstep3ï¼‰



#### 6 é›¶å†…å­˜åˆ†é…ï¼ˆstep4ï¼‰



#### 7 æŸ¥çœ‹å¹¶å‘ä¸‹çš„é˜»å¡æƒ…å†µï¼ˆstep5ï¼‰





## 61 ä½¿ç”¨expvarè¾“å‡ºåº¦é‡æ•°æ®ï¼Œè¾…åŠ©å®šä½æ€§èƒ½ç“¶é¢ˆç‚¹

ä¸Šä¸€æ¡æåˆ°ï¼Œè¦æƒ³å¯¹Goåº”ç”¨å­˜åœ¨çš„**æ€§èƒ½ç“¶é¢ˆè¿›è¡Œå‰–æ**ï¼Œé¦–å…ˆå°±è¦å¯¹ä¸åŒç±»å‹çš„æ€§èƒ½æ•°æ®è¿›è¡Œæ”¶é›†å’Œé‡‡æ ·ã€‚

æœ‰ä¸¤ç§æ”¶é›†å’Œé‡‡æ ·æ•°æ®çš„æ–¹æ³•ã€‚åœ¨å¾®è§‚å±‚é¢ï¼Œé‡‡ç”¨é€šè¿‡è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•æ”¶é›†å’Œé‡‡æ ·æ•°æ®çš„æ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•é€‚ç”¨äº**å®šä½å‡½æ•°æˆ–æ–¹æ³•å®ç°**ä¸­å­˜åœ¨æ€§èƒ½ç“¶é¢ˆç‚¹çš„æƒ…å½¢ï¼›åœ¨å®è§‚å±‚é¢ï¼Œé‡‡ç”¨ç‹¬ç«‹ç¨‹åºæ”¶é›†å’Œé‡‡æ ·æ•°æ®çš„æ–¹æ³•ã€‚ä½†é€šè¿‡ç‹¬ç«‹ç¨‹åºè¿›è¡Œæ€§èƒ½æ•°æ®é‡‡æ ·æ—¶ï¼Œå¾€å¾€å¾ˆéš¾å¿«é€Ÿæ•æ‰åˆ°çœŸæ­£çš„ç“¶é¢ˆç‚¹ï¼Œå°¤å…¶æ˜¯å¯¹äºé‚£äº›**å†…éƒ¨ç»“æ„å¤æ‚ã€ä¸šåŠ¡é€»è¾‘è¿‡å¤šã€å†…éƒ¨æœ‰è¾ƒå¤šå¹¶å‘çš„**Goç¨‹åºã€‚æˆ‘ä»¬åœ¨å¯¹è¿™æ ·çš„ç¨‹åºè¿›è¡Œæ€§èƒ½é‡‡æ ·æ—¶ï¼ŒçœŸæ­£çš„ç“¶é¢ˆç‚¹å¾ˆå¯èƒ½è¢«å…¶ä»–æ•°æ®é®ç›–ã€‚

é‚£ä¹ˆ**å¦‚ä½•èƒ½æ›´é«˜æ•ˆåœ°æ•æ‰åˆ°åº”ç”¨çš„æ€§èƒ½ç“¶é¢ˆç‚¹å‘¢**ï¼Ÿ

éœ€è¦çŸ¥é“Goåº”ç”¨è¿è¡ŒçŠ¶æ€ï¼ˆä¸€èˆ¬ä»¥**åº¦é‡æ•°æ®**çš„å½¢å¼å‘ˆç°ï¼‰ã€‚é€šè¿‡äº†è§£åº”ç”¨**å…³é”®è·¯å¾„**ä¸Šçš„åº¦é‡æ•°æ®ï¼Œå¯ä»¥ç¡®å®šåœ¨æŸä¸ªåº¦é‡ç‚¹ä¸Šåº”ç”¨çš„æ€§èƒ½æ˜¯ç¬¦åˆé¢„æœŸæ€§èƒ½æŒ‡æ ‡è¿˜æ˜¯è¾ƒå¤§åç¦»é¢„æœŸï¼Œè¿™æ ·å°±å¯ä»¥æœ€å¤§é™åº¦åœ°ç¼©å°æ€§èƒ½ç“¶é¢ˆç‚¹çš„æœç´¢èŒƒå›´ï¼Œä»è€Œå¿«é€Ÿå®šä½åº”ç”¨ä¸­çš„ç“¶é¢ˆç‚¹å¹¶è¿›è¡Œä¼˜åŒ–ã€‚

è¿™äº›å¯ä»¥åæ˜ åº”ç”¨è¿è¡ŒçŠ¶æ€çš„æ•°æ®ä¹Ÿè¢«ç§°ä¸ºåº”ç”¨çš„==å†…çœï¼ˆintrospectionï¼‰æ•°æ®==ã€‚ç›¸æ¯”äºé€šè¿‡æŸ¥è¯¢åº”ç”¨å¤–éƒ¨ç‰¹å¾è€Œè·å–çš„==æ¢é’ˆç±»ï¼ˆprobingï¼‰æ•°æ®==ï¼ˆæ¯”å¦‚æŸ¥çœ‹åº”ç”¨æŸç«¯å£æ˜¯å¦æœ‰å“åº”å¹¶è¿”å›æ­£ç¡®çš„æ•°æ®æˆ–çŠ¶æ€ç ï¼‰ï¼Œå†…çœæ•°æ®å¯ä»¥ä¼ è¾¾æ›´ä¸ºä¸°å¯Œã€æ›´å¤šçš„æœ‰å…³åº”ç”¨ç¨‹åºçŠ¶æ€çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚è¿™äº›ä¸Šä¸‹æ–‡ä¿¡æ¯å¯ä»¥æ˜¯åº”ç”¨**å¯¹å„ç±»èµ„æºçš„å ç”¨ä¿¡**æ¯ï¼Œæ¯”å¦‚åº”ç”¨è¿è¡Œå ç”¨äº†å¤šå°‘å†…å­˜ç©ºé—´ï¼Œä¹Ÿå¯ä»¥æ˜¯**è‡ªå®šä¹‰çš„æ€§èƒ½æŒ‡æ ‡ä¿¡æ¯**ï¼Œæ¯”å¦‚<u>å•ä½æ—¶é—´å¤„ç†çš„å¤–éƒ¨è¯·æ±‚æ•°é‡ã€åº”ç­”å»¶è¿Ÿã€é˜Ÿåˆ—ç§¯å‹é‡ç­‰</u>ã€‚

ä¼ ç»Ÿç¼–ç¨‹è¯­è¨€ï¼ˆå¦‚C++ã€Javaç­‰ï¼‰å¹¶æ²¡æœ‰å†…ç½®è¾“å‡ºåº”ç”¨çŠ¶æ€åº¦é‡æ•°æ®çš„è®¾æ–½ï¼ˆæ¥å£æ–¹å¼ã€æŒ‡æ ‡å®šä¹‰æ–¹æ³•ã€æ•°æ®è¾“å‡ºæ ¼å¼ç­‰ï¼‰ï¼Œéœ€è¦å¼€å‘è€…è‡ªå·±é€šè¿‡ç¼–ç å®ç°æˆ–åˆ©ç”¨ç¬¬ä¸‰æ–¹åº“å®ç°ã€‚

Goæ ‡å‡†åº“æä¾›çš„`expvar`åŒ…å¯ä»¥**æŒ‰ç»Ÿä¸€æ¥å£ã€ç»Ÿä¸€æ•°æ®æ ¼å¼ã€ä¸€è‡´çš„æŒ‡æ ‡**å®šä¹‰æ–¹æ³•è¾“å‡ºè‡ªå®šä¹‰çš„åº¦é‡æ•°æ®ã€‚

> `expvar` åŒ…çš„å…¨ç§°æ˜¯ **Exported Variables**ï¼ˆå¯¼å‡ºå˜é‡ï¼‰ã€‚å…¶æ ¸å¿ƒåŠŸèƒ½ï¼š**å°† Go ç¨‹åºå†…éƒ¨çš„è¿è¡Œæ—¶å˜é‡ï¼ˆå¦‚è®¡æ•°å™¨ã€å†…å­˜çŠ¶æ€ã€è‡ªå®šä¹‰æŒ‡æ ‡ï¼‰ä»¥æ ‡å‡†åŒ–æ–¹å¼å¯¼å‡º**ï¼Œä¾›å¤–éƒ¨ç›‘æ§ç³»ç»Ÿè®¿é—®å’Œåˆ†æã€‚

### 61.1 expvaråŒ…çš„å·¥ä½œåŸç†

Goæ ‡å‡†åº“ä¸­çš„expvaråŒ…æä¾›äº†ä¸€ç§**è¾“å‡ºåº”ç”¨å†…éƒ¨çŠ¶æ€ä¿¡æ¯çš„==æ ‡å‡†åŒ–æ–¹æ¡ˆ==**ï¼š

- æ•°æ®è¾“å‡ºæ¥å£å½¢å¼ï¼›  
- è¾“å‡ºæ•°æ®çš„ç¼–ç æ ¼å¼ï¼›
- ç”¨æˆ·è‡ªå®šä¹‰æ€§èƒ½æŒ‡æ ‡çš„æ–¹æ³•ã€‚

![](images/image-20250413104838953.png)

å¯¼å…¥expvarï¼š

```go
import _ "expvar"
```

å’Œnet/http/pprofç±»ä¼¼ï¼ŒexpvaråŒ…ä¹Ÿåœ¨è‡ªå·±çš„initå‡½æ•°ä¸­å‘httpåŒ…çš„é»˜è®¤è¯·æ±‚â€œè·¯ç”±å™¨â€`DefaultServeMux`ğŸ”–æ³¨å†Œä¸€ä¸ªæœåŠ¡ç«¯ç‚¹/debug/varsï¼š

```
/ $GOROOT/src/expvar/expvar.go

func init() {
	http.HandleFunc("/debug/vars", expvarHandler)
	...
}
```

è¿™ä¸ªæœåŠ¡ç«¯ç‚¹å°±æ˜¯expvaræä¾›ç»™å¤–éƒ¨çš„è·å–åº”ç”¨å†…éƒ¨çŠ¶æ€çš„**å”¯ä¸€æ ‡å‡†æ¥å£**ï¼Œå¤–éƒ¨å·¥å…·ï¼ˆæ— è®ºæ˜¯å‘½ä»¤è¡Œè¿˜æ˜¯åŸºäºWebçš„å›¾å½¢åŒ–ç¨‹åºï¼‰éƒ½å¯ä»¥é€šè¿‡æ ‡å‡†çš„http getè¯·æ±‚ä»è¯¥æœåŠ¡ç«¯ç‚¹è·å–åº”ç”¨å†…éƒ¨çŠ¶æ€æ•°æ®ã€‚

```go
package main

import (
	_ "expvar"
	"fmt"
	"net/http"
)

func main() {
	http.Handle("/hi", http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		w.Write([]byte("hi"))
	}))
	fmt.Println(http.ListenAndServe("localhost:8080", nil))
}

// http://localhost:8080/debug/vars
```



```go
// æ‰‹åŠ¨å°†expvaråŒ…çš„æœåŠ¡ç«¯ç‚¹æ³¨å†Œåˆ°åº”ç”¨ç¨‹åºæ‰€ä½¿ç”¨çš„â€œè·¯ç”±å™¨â€ä¸Š
func main() {
	mux := http.NewServeMux()
	mux.Handle("/hi", http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		w.Write([]byte("hi2"))
	}))
	mux.Handle("/debug/vars", expvar.Handler())
	fmt.Println(http.ListenAndServe("localhost:8080", mux))
}
```



å¦‚æœåº”ç”¨ç¨‹åºæœ¬èº«å¹¶æ²¡æœ‰å¯åŠ¨HTTPæœåŠ¡ï¼Œé‚£ä¹ˆè¿˜éœ€åœ¨ä¸€ä¸ªå•ç‹¬çš„goroutineä¸­å¯åŠ¨ä¸€ä¸ªHTTPæœåŠ¡ï¼Œè¿™æ ·expvaræä¾›çš„æœåŠ¡æ‰èƒ½æœ‰æ•ˆã€‚



```json
{
  "cmdline": [
  "/var/folders/8k/ntbhdf615p34cflx1_qwv38r0000gn/T/go-build899428462/b001/exe/expvar_demo2"
  ],
  "memstats": {
    "Alloc": 272512,
    "TotalAlloc": 272512,
    "Sys": 6966288,
    "Lookups": 0,
    "Mallocs": 1201,
    "Frees": 90,
    "HeapAlloc": 272512,
    "HeapSys": 3899392,
    ...
  }
}
```

åœ¨é»˜è®¤è¿”å›çš„çŠ¶æ€æ•°æ®ä¸­åŒ…å«äº†ä¸¤ä¸ªå­—æ®µï¼šcmdlineå’Œmemstatsã€‚è¿™ä¸¤ä¸ªè¾“å‡ºæ•°æ®æ˜¯expvaråŒ…åœ¨initå‡½æ•°ä¸­å°±å·²ç»å‘å¸ƒï¼ˆPublishï¼‰äº†çš„å˜é‡ï¼š

```go
//$GOROOT/src/expvar/expvar.go

func init() {
  http.HandleFunc("/debug/vars", expvarHandler)
  Publish("cmdline", Func(cmdline))
  Publish("memstats", Func(memstats))
}
```

cmdlineå­—æ®µçš„å«ä¹‰æ˜¯è¾“å‡ºæ•°æ®çš„åº”ç”¨åï¼Œè¿™é‡Œå› ä¸ºæ˜¯é€šè¿‡go runè¿è¡Œçš„åº”ç”¨ï¼Œæ‰€ä»¥cmdlineçš„å€¼æ˜¯ä¸€ä¸ªä¸´æ—¶è·¯å¾„ä¸‹çš„åº”ç”¨ã€‚

è€Œmemstatsè¾“å‡ºçš„æ•°æ®å¯¹åº”çš„æ˜¯`runtime.Memstats`ç»“æ„ä½“ï¼Œåæ˜ çš„æ˜¯åº”ç”¨åœ¨**è¿è¡ŒæœŸé—´å †å†…å­˜åˆ†é…ã€æ ˆå†…å­˜åˆ†é…åŠGCçš„çŠ¶æ€**ã€‚runtime.Memstatsç»“æ„ä½“çš„å­—æ®µå¯èƒ½ä¼šéšç€Goç‰ˆæœ¬çš„æ¼”è¿›è€Œå‘ç”Ÿå˜åŒ–ï¼Œå…¶å­—æ®µå…·ä½“å«ä¹‰å¯ä»¥å‚è€ƒMemstatsç»“æ„ä½“ä¸­çš„æ³¨é‡Šã€‚

### 61.2 è‡ªå®šä¹‰åº”ç”¨é€šè¿‡expvarè¾“å‡ºçš„åº¦é‡æ•°æ®

ä¸Šæ–‡ä¸¤ä¸ªæ ‡å‡†ï¼š

- æ ‡å‡†çš„æ¥å£ï¼šé€šè¿‡http getï¼ˆé»˜è®¤ä»/debug/varsæœåŠ¡ç«¯ç‚¹è·å–æ•°æ®ï¼‰ã€‚
- æ ‡å‡†çš„æ•°æ®ç¼–ç æ ¼å¼ï¼šJSONã€‚

ç¬¬ä¸‰ä¸ªæ ‡å‡†ï¼š

- è‡ªå®šä¹‰è¾“å‡ºçš„åº¦é‡æ•°æ®çš„æ ‡å‡†æ–¹æ³•ã€‚

åœ¨å›¾48-1ä¸­æˆ‘ä»¬å‘ç°ï¼Œä»debug/varsæœåŠ¡ç«¯ç‚¹è·å–åˆ°çš„JSONç»“æœæ•°æ®ä¸­æœ‰ä¸€ä¸ªåä¸ºcustom_varçš„å­—æ®µï¼Œè¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„åº¦é‡æ•°æ®ã€‚

é€šè¿‡åœ¨initå‡½æ•°ä¸­æ·»åŠ å‘å¸ƒå‡½æ•°ï¼Œè€Œæ·»åŠ åˆ°è¿”å›ç»“æœä¸­ï¼š

```go
func init() {ï¿¼â€¨    expvar.Publish("custom_var", customVar)ï¿¼â€¨}
```

expvaråŒ…æä¾›äº†Publishå‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨äºå‘å¸ƒé€šè¿‡debug/varsæœåŠ¡ç«¯ç‚¹è¾“å‡ºçš„æ•°æ®ï¼Œä¸Šé¢expvarå†…ç½®è¾“å‡ºçš„cmdlineå’Œmemstatså°±æ˜¯é€šè¿‡Publishå‡½æ•°å‘å¸ƒçš„ã€‚Publishå‡½æ•°çš„åŸå‹å¦‚ä¸‹ï¼š

```go
// $GOROOT/src/expvar/expvar.go
func Publish(name string, v Var)

type Var interface {
  String() string
}
```

`name`æ˜¯å¯¹åº”å­—æ®µåœ¨è¾“å‡ºç»“æœä¸­çš„å­—æ®µåï¼Œè€Œvæ˜¯å­—æ®µå€¼ï¼Œç±»å‹ä¸ºæ¥å£`Var`ã€‚
æ‰€æœ‰å®ç°äº†`Var`æ¥å£ç±»å‹çš„å˜é‡éƒ½å¯ä»¥è¢«å‘å¸ƒå¹¶ä½œä¸ºè¾“å‡ºçš„åº”ç”¨å†…éƒ¨çŠ¶æ€çš„ä¸€éƒ¨åˆ†ã€‚

ğŸ”–

### 61.3 è¾“å‡ºæ•°æ®çš„å±•ç¤º

JSONæ ¼å¼æ–‡æœ¬å¾ˆå®¹æ˜“ååºåˆ—åŒ–ï¼Œå¼€å‘è€…å¯è‡ªè¡Œè§£æåä½¿ç”¨ï¼Œæ¯”å¦‚ï¼šç¼–å†™ä¸€ä¸ªPrometheus exporterï¼Œå°†æ•°æ®å¯¼å…¥PrometheusèƒŒåçš„å­˜å‚¨ï¼ˆæ¯”å¦‚InfluxDBï¼‰ä¸­ï¼Œå¹¶åˆ©ç”¨ä¸€äº›åŸºäºWebå›¾å½¢åŒ–çš„æ–¹å¼ç›´è§‚å±•ç¤ºå‡ºæ¥ï¼›æˆ–è€…å¯¼å…¥Elasticsearchï¼Œå†é€šè¿‡Kibanaæˆ–Grafanaçš„é¡µé¢å±•ç¤ºå‡ºæ¥ã€‚

Goå¼€å‘è€…Ivan Danilukå¼€å‘äº†ä¸€æ¬¾åä¸ºexpvarmonçš„å¼€æºå·¥å…·ï¼Œè¯¥å·¥å…·æ”¯æŒå°†ä»expvarè¾“å‡ºçš„æ•°æ®ä»¥åŸºäºç»ˆç«¯çš„å›¾å½¢åŒ–æ–¹å¼å±•ç¤ºå‡ºæ¥ã€‚

```sh
go install github.com/divan/expvarmon
```

è¿è¡Œexpvar_demo6ï¼Œç„¶åè¿è¡Œï¼š

```sh
$ expvarmon -ports="8080" -vars="custom:customVar.field1,custom:customVar.field2,mem:memstats.Alloc,mem:memstats.Sys,mem:memstats.HeapAlloc,mem:memstats.HeapInuse,duration:memstats.PauseNs,duration:memstats.PauseTotalNs"
```



## 62 ä½¿ç”¨Delveè°ƒè¯•Goä»£ç 

è½¯ä»¶å¼€å‘å¯ä¸åªæ˜¯ç¼–ç ï¼Œè°ƒè¯•ä¹Ÿæ˜¯æ¯ä¸ªç¨‹åºå‘˜çš„å¿…å¤‡æŠ€èƒ½ï¼Œå æ®äº†ç¨‹åºå‘˜å¾ˆå¤§ä¸€éƒ¨åˆ†ç²¾åŠ›ã€‚

è°ƒè¯•çš„ç›®æ ‡æ˜¯ä¿®æ­£ä»£ç ä¸­ç¡®è®¤å­˜åœ¨çš„bugã€‚

### 62.1 å…³äºè°ƒè¯•ï¼Œä½ é¦–å…ˆåº”è¯¥çŸ¥é“çš„å‡ ä»¶äº‹

#### 1 è°ƒè¯•å‰ï¼Œé¦–å…ˆåšå¥½å¿ƒç†å‡†å¤‡

#### 2 é¢„é˜²bugçš„å‘ç”Ÿï¼Œé™ä½bugçš„å‘ç”Ÿæ¦‚ç‡

bugå¯ç®€å•åˆ†ä¸º**äº§å“å‘å¸ƒå‰bugå’Œäº§å“å‘å¸ƒåçš„bug**ã€‚

æ— è®ºå“ªä¸€ç§ï¼Œéƒ½è¦ç»å†**æ”¶é›†æ•°æ®ã€é‡ç°bugã€å®šä½é—®é¢˜ã€ä¿®æ­£é—®é¢˜å’Œä¿®æ­£åçš„ç‰ˆæœ¬éªŒè¯**ç­‰å¤šä¸ªæ­¥éª¤ã€‚

è¿™å…¶ä¸­å‘å¸ƒåçš„bugèŠ±è´¹çš„æˆæœ¬æ›´é«˜ã€‚æ—¢ç„¶äº‹å®è¯æ˜**è°ƒè¯•bugçš„æˆæœ¬æ¯”ç¼–ç æ›´é«˜**ï¼Œé‚£æˆ‘ä»¬ä½•ä¸é‡‡ç”¨ä¸€äº›æ‰‹æ®µæ¥é¢„é˜²bugçš„å‘ç”Ÿï¼Œé™ä½bugå‘ç”Ÿçš„æ¦‚ç‡å‘¢ï¼Ÿ

è™½ç„¶ä»ä¸€ä¸ªè½¯ä»¶çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸæ¥çœ‹ï¼Œä¿è¯è½¯ä»¶è´¨é‡åº”ä»éœ€æ±‚å¼€å§‹ï¼Œä½†è¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨**ç¼–ç é˜¶æ®µ**ã€‚å¯¹äºä¸ªä½“å¼€å‘è€…ï¼Œå¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è€ƒè™‘ã€‚

- å……åˆ†çš„ä»£ç æ£€æŸ¥ã€‚

  å……åˆ†åˆ©ç”¨ä½ æ‰‹å¤´ä¸Šçš„å·¥å…·å¯¹ä½ ç¼–å†™çš„ä»£ç è¿›è¡Œä¸¥æ ¼çš„æ£€æŸ¥ï¼Œè¿™äº›å·¥å…·åŒ…æ‹¬ç¼–è¯‘å™¨ï¼ˆå°½å¯èƒ½å°†è­¦å‘Šçº§åˆ«æå‡åˆ°ä½ å¯ä»¥æ¥å—çš„æœ€é«˜çº§åˆ«ï¼‰ã€é™æ€ä»£ç æ£€æŸ¥å·¥å…·ï¼ˆlinterï¼Œå¦‚go vetï¼‰ç­‰ã€‚

- ä¸ºè°ƒè¯•ç‰ˆæ·»åŠ æ–­è¨€ã€‚

  åœ¨è°ƒè¯•ç‰ˆä»£ç ä¸­é€‚å½“çš„åœ°æ–¹æ·»åŠ æ–­è¨€ï¼ˆGoæ²¡æœ‰æä¾›åŸç”Ÿæ–­è¨€æœºåˆ¶ï¼Œå¯ä»¥è‡ªè¡Œç®€å•å®ç°æˆ–åˆ©ç”¨ç¬¬ä¸‰æ–¹åº“ï¼‰ï¼Œè¿™æ ·çš„æ–¹æ³•åŒæ ·å¯ä»¥å¸®åŠ©ä½ åŠæ—¶å‘ç°ä»£ç ä¸­éšè—çš„ç¼ºé™·ã€‚

- å……åˆ†çš„å•å…ƒæµ‹è¯•

- ä»£ç åŒçº§è¯„å®¡

#### 3 bugçš„åŸå› å®šä½å’Œä¿®æ­£

1. æ”¶é›†â€œç°åœºæ•°æ®â€

   é€šè¿‡ç¼–ç¨‹è¯­è¨€å†…ç½®çš„è¾“å‡ºè¯­å¥ï¼ˆå¦‚Goçš„printã€fmt.Printfç­‰ï¼‰è¾“å‡ºæˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯ï¼Œè€Œæ›´ä¸ºä¸“ä¸šçš„æ–¹æ³•æ˜¯é€šè¿‡ç¼–ç¨‹è¯­è¨€æä¾›çš„ä¸“ä¸šè°ƒè¯•å·¥å…·ï¼ˆå¦‚GDBï¼‰è®¾ç½®æ–­ç‚¹æ¥é‡‡é›†ç°åœºæ•°æ®æˆ–é‡ç°bugã€‚

2. å®šä½é—®é¢˜æ‰€åœ¨

   æœ‰äº†â€œç°åœºæ•°æ®â€ï¼Œæ¥ä¸‹æ¥ä½ éœ€è¦ç”¨â€œç«çœ¼é‡‘ç›â€ä»ä¸­æ‰¾å‡ºä½ çœŸæ­£éœ€è¦çš„æ•°æ®ã€‚å¦‚æœæ— æ³•ç›´æ¥è¯†åˆ«å‡ºçœŸæ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥æ ¹æ®æ•°æ®åšå‡ ç»„ä¸åŒæ•°æ®ç»„åˆçš„æ¨¡æ‹Ÿæµ‹è¯•ï¼Œåœ¨æ•°æ®å˜åŒ–ä¸­å»ä¼ªå­˜çœŸï¼Œæ‰¾åˆ°çœŸæ•°æ®ã€‚æœ‰äº†å¯ä¿¡èµ–çš„çœŸå®æ•°æ®ï¼Œä½ ä¸€èˆ¬éƒ½å¯ä»¥æ ¹æ®ä»£ç é€»è¾‘æ¨ç†å‡ºé—®é¢˜æ‰€åœ¨ã€‚ä½†æœ‰äº›æ—¶å€™è¿˜æ˜¯éœ€è¦é€šè¿‡éš”ç¦»ä»£ç ã€ç¼©å°å«Œç–‘ä»£ç èŒƒå›´ç­‰æ–¹æ³•æ‰èƒ½é”å®šä¸€äº›è¾ƒéš¾bugçš„å…·ä½“é—®é¢˜æ‰€åœ¨ã€‚

3. ä¿®æ­£å¹¶éªŒè¯

   æ—¢ç„¶æ‰¾åˆ°äº†é—®é¢˜æ‰€åœ¨ï¼Œé‚£å‰©ä¸‹çš„å·¥ä½œå°±æ˜¯ä¿®æ­£å®ƒå¹¶é‡ç°éªŒè¯ã€‚ä¸ºéªŒè¯é—®é¢˜å·²ç»ä¿®å¤è€Œæ·»åŠ çš„æ–°æµ‹è¯•ç”¨ä¾‹åŒæ—¶ä¹Ÿè¡¥å……äº†ä½ çš„å•å…ƒæµ‹è¯•ç”¨ä¾‹åº“ã€‚å¦‚æœä¿®æ­£å¤±è´¥ï¼Œé‚£å°±ä»å¤´å¼€å§‹æ–°ä¸€è½®åˆ†æã€‚

æœ€åï¼Œå®šæœŸå›é¡¾ä½ è‡ªå·±â€œå‡ºäº§â€çš„bugåˆ—è¡¨ï¼Œä½ å¯èƒ½ä¼šå‘ç°å¾ˆå¤šbugæ˜¯ä½ åœ¨é¢„é˜²é˜¶æ®µåšå¾—ä¸å¤Ÿå¥½å¯¼è‡´çš„ã€‚è¿™æ ·å›è¿‡å¤´æ¥æ€è€ƒå¦‚ä½•åœ¨ä¸Šä¸€ä¸ªé˜¶æ®µé¢„é˜²æ­¤ç±»â€œæ¼ç½‘ä¹‹é±¼â€ï¼Œå°±ä¼šå½¢æˆè‰¯æ€§å¾ªç¯ã€‚

### 62.2 Goè°ƒè¯•å·¥å…·çš„é€‰æ‹©

https://blog.golang.org/survey2019-results

![](images/image-20250724114950106.png)

å¸¸ç”¨çš„ä¸¤ç§è°ƒè¯•æ–¹å¼æ˜¯ä½¿ç”¨æ–‡æœ¬è¾“å‡ºï¼ˆfmt.Printç­‰ï¼‰è°ƒè¯•Goä»£ç ã€printæ´¾â€ã€‘å’Œä½¿ç”¨ä¸“ä¸šè°ƒè¯•å™¨ï¼ˆå¦‚Delveã€GDBï¼‰åœ¨æœ¬æœºä¸Šè°ƒè¯•Goä»£ç ã€â€œä¸“ä¸šå·¥å…·æ´¾â€ã€‘ã€‚

ç”¨printè¯­å¥è¾…åŠ©è°ƒè¯•ä¸é‡‡ç”¨ä¸“ä¸šè°ƒè¯•å™¨å¯¹ä»£ç è¿›è¡Œè°ƒè¯•å¹¶ä¸çŸ›ç›¾ï¼Œå®ƒä»¬ä¹‹é—´æ˜¯äº’ç›¸è¡¥å……å’Œç›¸è¾…ç›¸æˆçš„ã€‚

printè¾…åŠ©è°ƒè¯•â€æ›´å¤šç”¨äºä»£ç å¯ä¿®æ”¹çš„æœ¬åœ°ç¯å¢ƒï¼Œé€šè¿‡â€œ**åœ¨ç‰¹å®šä½ç½®æ·»åŠ æ‰“å°å€¼â†’ç¼–è¯‘æ‰§è¡Œâ†’æ ¹æ®è¾“å‡ºç»“æœè°ƒæŸ¥æ€è€ƒ**â€çš„è°ƒè¯•å¾ªç¯æ¥é€æ¸é€¼è¿‘â€œçœŸç›¸â€ã€‚é’ˆå¯¹æœ¬åœ°ç¯å¢ƒä¸‹çš„ä»£ç è°ƒè¯•ï¼Œä¸“ä¸šè°ƒè¯•å™¨å…·æœ‰åŒæ ·çš„åŠŸèƒ½ï¼Œåªæ˜¯è°ƒè¯•å¾ªç¯ç•¥çƒ¦çï¼ŒåŒ…æ‹¬**å¯åŠ¨è°ƒè¯•å™¨â†’è®¾ç½®æ–­ç‚¹â†’åœ¨è°ƒè¯•å™¨å†…è¿è¡Œç¨‹åºâ†’æ–­ç‚¹å¤„ä½¿ç”¨å‘½ä»¤æ‰“å°éœ€è¦çš„ä¿¡æ¯â†’å•æ­¥è°ƒè¯•ç­‰â†’é€€å‡ºè°ƒè¯•å™¨**ã€‚

ä½†ä¸“ä¸šè°ƒè¯•å™¨å¯ä»¥è¿ç”¨åœ¨â€œprintè¾…åŠ©è°ƒè¯•â€æ— æ³•èƒœä»»çš„åœºæ™¯ä¸‹ï¼Œæ¯”å¦‚ï¼š

- ä¸IDEé›†æˆï¼Œé€šè¿‡å›¾å½¢åŒ–æ“ä½œå¯å¤§å¹…ç®€åŒ–ä¸“ä¸šè°ƒè¯•å™¨çš„è°ƒè¯•å¾ªç¯ï¼Œæä¾›æ›´ä½³çš„ä½“éªŒï¼›
- äº‹åè°ƒæŸ¥ï¼ˆpostmortemï¼‰
- è°ƒè¯•core dumpæ–‡ä»¶ï¼›
- åœ¨ç”Ÿäº§ç¯å¢ƒé€šè¿‡æŒ‚æ¥ï¼ˆattachï¼‰åº”ç”¨è¿›ç¨‹ï¼Œæ·±å…¥åº”ç”¨è¿›ç¨‹å†…éƒ¨è¿›è¡Œè°ƒè¯•ã€‚



GDBæ˜¾ç„¶ä¹Ÿä¸æ˜¯Goè°ƒè¯•å·¥å…·çš„æœ€ä½³é€‰æ‹©ï¼Œè™½ç„¶å…¶é€‚ç”¨äºè°ƒè¯•å¸¦æœ‰cgoä»£ç çš„Goç¨‹åºæˆ–äº‹åè°ƒæŸ¥è°ƒè¯•ã€‚

Delveï¼ˆhttps://github.com/go-delve/delveï¼‰æ˜¯å¦ä¸€ä¸ªGoè¯­è¨€è°ƒè¯•å™¨ï¼Œè¯¥è°ƒè¯•å™¨å·¥ç¨‹äº2014å¹´ç”±Derek Parkeråˆ›å»ºã€‚Delveæ—¨åœ¨ä¸ºGoæä¾›ä¸€ä¸ªç®€å•ã€åŠŸèƒ½é½å…¨ã€æ˜“ç”¨ä½¿ç”¨å’Œè°ƒç”¨çš„è°ƒè¯•å·¥å…·ã€‚å®ƒç´§è·ŸGoè¯­è¨€ç‰ˆæœ¬æ¼”è¿›ï¼Œæ˜¯ç›®å‰Goè°ƒè¯•å™¨çš„äº‹å®æ ‡å‡†ã€‚å’ŒGDBç›¸æ¯”ï¼ŒDelveçš„ä¼˜åŠ¿åœ¨äºå®ƒå¯ä»¥**æ›´å¥½åœ°ç†è§£Goçš„ä¸€åˆ‡ï¼Œå¯¹å¹¶å‘ç¨‹åºæœ‰ç€å¾ˆå¥½çš„æ”¯æŒï¼Œæ”¯æŒè·¨å¹³å°ï¼ˆæ”¯æŒWindowsã€macOSã€Linuxä¸‰å¤§ä¸»æµå¹³å°ï¼‰ï¼Œè€Œä¸”å‰åç«¯åˆ†ç¦»çš„è®¾è®¡ä½¿å¾—å®ƒå¯ä»¥éå¸¸å®¹æ˜“åœ°è¢«é›†æˆåˆ°å„ç§IDEï¼ˆå¦‚GoLandï¼‰ã€ç¼–è¯‘å™¨æ’ä»¶ï¼ˆvscode goã€vim-goç­‰ï¼‰ã€å›¾å½¢åŒ–è°ƒè¯•å™¨å‰ç«¯ï¼ˆå¦‚gdlvï¼‰ä¸­**ã€‚

### 62.3 Delveè°ƒè¯•åŸºç¡€ã€åŸç†ä¸æ¶æ„ ğŸ”–



å¸¸ç”¨çš„æŸ¥çœ‹å‘½ä»¤ï¼š

- printï¼ˆç®€å†™ä¸ºpï¼‰ï¼šè¾“å‡ºæºç ä¸­å˜é‡çš„å€¼ã€‚
- whatisï¼šè¾“å‡ºåé¢çš„è¡¨è¾¾å¼çš„ç±»å‹ã€‚
- regsï¼šå½“å‰å¯„å­˜å™¨ä¸­çš„å€¼ã€‚
- localsï¼šå½“å‰å‡½æ•°æ ˆæœ¬åœ°å˜é‡åˆ—è¡¨ï¼ˆåŒ…æ‹¬å˜é‡çš„å€¼ï¼‰ã€‚
- argsï¼šå½“å‰å‡½æ•°æ ˆå‚æ•°å’Œè¿”å›å€¼åˆ—è¡¨ï¼ˆåŒ…æ‹¬å‚æ•°å’Œè¿”å›å€¼çš„å€¼ï¼‰ã€‚
- examinememï¼ˆç®€å†™ä¸ºxï¼‰ï¼šæŸ¥çœ‹æŸä¸€å†…å­˜åœ°å€ä¸Šçš„å€¼ã€‚



#### Delveæ¶æ„ä¸åŸç†

ä¸ºäº†ä¾¿äºå„ç§è°ƒè¯•å™¨å‰ç«¯ï¼ˆå‘½ä»¤è¡Œã€IDEã€ç¼–è¾‘å™¨æ’ä»¶ã€å›¾å½¢åŒ–å‰ç«¯ï¼‰ä¸Delveé›†æˆï¼ŒDelveé‡‡ç”¨äº†ä¸€ä¸ªå‰ååˆ†ç¦»çš„æ¶æ„

![](images/image-20250724115456585.png)

UI Layerå¯¹åº”çš„å°±æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„dlvå‘½ä»¤è¡Œæˆ–Goland/vim-goä¸­çš„è°ƒè¯•å™¨å‰ç«¯ï¼Œè€ŒService Layeræ˜¾ç„¶ç”¨äºå‰åç«¯é€šä¿¡ã€‚DelveçœŸæ­£æ–½å±•çš„â€œé­”æ³•â€æ˜¯ç”±Symbolic Layerå’ŒTarget Layerä¸¤å±‚åˆä½œå®ç°çš„ã€‚

Target Layeré€šè¿‡å„ä¸ªæ“ä½œç³»ç»Ÿæä¾›çš„ç³»ç»ŸAPIæ¥æ§åˆ¶è¢«è°ƒè¯•ç›®æ ‡è¿›ç¨‹ï¼Œå®ƒå¯¹è¢«è°ƒè¯•ç›®æ ‡çš„æºç æ²¡æœ‰ä»»ä½•äº†è§£ï¼Œå®ç°çš„åŠŸèƒ½åŒ…æ‹¬ï¼š

- æŒ‚æ¥ï¼ˆattachï¼‰/åˆ†ç¦»ï¼ˆdetachï¼‰ç›®æ ‡è¿›ç¨‹ï¼›
- æšä¸¾ç›®æ ‡è¿›ç¨‹ä¸­çš„çº¿ç¨‹ï¼›
- å¯åŠ¨/åœæ­¢å•ä¸ªçº¿ç¨‹ï¼ˆæˆ–æ•´ä¸ªè¿›ç¨‹ï¼‰ï¼›
- æ¥æ”¶å’Œå¤„ç†â€œè°ƒè¯•äº‹ä»¶â€ï¼ˆçº¿ç¨‹åˆ›å»º/é€€å‡ºä»¥åŠçº¿ç¨‹åœ¨æ–­ç‚¹å¤„æš‚åœï¼‰ï¼›
- è¯»å†™ç›®æ ‡è¿›ç¨‹çš„å†…å­˜ï¼›
- è¯»å†™åœæ­¢çº¿ç¨‹çš„CPUå¯„å­˜å™¨ï¼›
- è¯»å–core dumpæ–‡ä»¶ã€‚

çœŸæ­£äº†è§£è¢«è°ƒè¯•ç›®æ ‡æºç æ–‡ä»¶çš„æ˜¯Symbolic Layerï¼Œè¿™ä¸€å±‚é€šè¿‡è¯»å–Goç¼–è¯‘å™¨ï¼ˆåŒ…æ‹¬é“¾æ¥å™¨ï¼‰ä»¥DWARFæ ¼å¼ï¼ˆä¸€ç§æ ‡å‡†çš„è°ƒè¯•ä¿¡æ¯æ ¼å¼ï¼‰å†™å…¥ç›®æ ‡äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„è°ƒè¯•ç¬¦å·ä¿¡æ¯æ¥äº†è§£è¢«è°ƒè¯•ç›®æ ‡æºç ï¼Œå¹¶å®ç°äº†è¢«è°ƒè¯•ç›®æ ‡è¿›ç¨‹ä¸­çš„åœ°å€ã€äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„è°ƒè¯•ç¬¦å·åŠæºç ç›¸å…³ä¿¡æ¯ä¸‰è€…ä¹‹é—´çš„å…³ç³»æ˜ å°„ï¼š

![](images/image-20250724115717904.png)

### 62.4 å¹¶å‘ã€Coredumpæ–‡ä»¶ä¸æŒ‚æ¥è¿›ç¨‹è°ƒè¯•







# Goç½‘ç»œç¼–ç¨‹



## 63 ç†è§£Go TCP Socketç½‘ç»œç¼–ç¨‹æ¨¡å‹

æ—¥å¸¸ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°Goè¯­è¨€ä¸­çš„netåŒ…åŠå…¶å­ç›®å½•ä¸‹çš„åŒ…ï¼ˆå¦‚httpï¼‰å‡è‡ªå¸¦é«˜é¢‘å’Œåˆšéœ€çš„ä¸»è§’å…‰ç¯ã€‚è€Œ**åŸºäºTCP Socketï¼ˆå¥—æ¥å­—ï¼‰çš„é€šä¿¡åˆ™æ˜¯ç½‘ç»œç¼–ç¨‹çš„ä¸»æµ**ï¼Œå³ä¾¿ä½ æ²¡æœ‰ç›´æ¥ç”¨è¿‡netåŒ…ä¸­æœ‰å…³TCP Socketçš„å‡½æ•°/æ–¹æ³•æˆ–æ¥å£ï¼Œä½ ä¹Ÿæ€»ç”¨è¿‡net/httpåŒ…ã€‚httpåŒ…å®ç°çš„æ˜¯HTTPè¿™ä¸ªåº”ç”¨å±‚åè®®ï¼Œå…¶**åœ¨ä¼ è¾“å±‚ä½¿ç”¨çš„ä¾æ—§æ˜¯TCP Socket**ã€‚

Goæ˜¯è‡ªå¸¦è¿è¡Œæ—¶çš„è·¨å¹³å°ç¼–ç¨‹è¯­è¨€ï¼ŒGoä¸­æš´éœ²ç»™è¯­è¨€ä½¿ç”¨è€…çš„TCP Socketæ¥å£æ˜¯å»ºç«‹åœ¨**æ“ä½œç³»ç»ŸåŸç”ŸTCP Socketæ¥å£**ä¹‹ä¸Šçš„ã€‚ç”±äºGoè¿è¡Œæ—¶è°ƒåº¦çš„éœ€è¦ï¼ŒGoè®¾è®¡äº†ä¸€å¥—é€‚åˆè‡ªå·±çš„TCP Socketç½‘ç»œç¼–ç¨‹æ¨¡å‹ã€‚

### 63.1 TCP Socketç½‘ç»œç¼–ç¨‹æ¨¡å‹

ç½‘ç»œI/Oæ¨¡å‹å®šä¹‰çš„æ˜¯**åº”ç”¨çº¿ç¨‹ä¸æ“ä½œç³»ç»Ÿå†…æ ¸ä¹‹é—´çš„äº¤äº’è¡Œä¸ºæ¨¡å¼**ã€‚

é€šå¸¸ç”¨**é˜»å¡ï¼ˆBlockingï¼‰å’Œéé˜»å¡ï¼ˆNon-Blockingï¼‰**æ¥æè¿°ç½‘ç»œI/Oæ¨¡å‹ã€‚ä¸åŒæ ‡å‡†å¯¹äºç½‘ç»œI/Oæ¨¡å‹çš„è¯´æ³•æœ‰æ‰€ä¸åŒï¼Œæ¯”å¦‚POSIX.1æ ‡å‡†è¿˜å®šä¹‰äº†åŒæ­¥ï¼ˆSyncï¼‰å’Œå¼‚æ­¥ï¼ˆAsyncï¼‰è¿™ä¸¤ä¸ªæœ¯è¯­æ¥æè¿°æ¨¡å‹ã€‚

é˜»å¡å’Œéé˜»å¡æ˜¯**ä»¥==å†…æ ¸æ˜¯å¦ç­‰æ•°æ®å…¨éƒ¨å°±ç»ªæ‰è¿”å›==ï¼ˆç»™å‘èµ·ç³»ç»Ÿè°ƒç”¨çš„åº”ç”¨çº¿ç¨‹ï¼‰æ¥åŒºåˆ†çš„**ã€‚å¦‚æœå†…æ ¸ä¸€ç›´ç­‰åˆ°å…¨éƒ¨æ•°æ®å°±ç»ªæ‰è¿”å›ï¼Œåˆ™è¿™ç§è¡Œä¸ºæ¨¡å¼ç§°ä¸º**é˜»å¡ï¼ˆBlockingï¼‰**ï¼›å¦‚æœå†…æ ¸æŸ¥çœ‹æ•°æ®å°±ç»ªçŠ¶æ€åï¼Œå³ä¾¿æ²¡æœ‰å°±ç»ªä¹Ÿç«‹å³è¿”å›é”™è¯¯ï¼ˆç»™å‘èµ·ç³»ç»Ÿè°ƒç”¨çš„åº”ç”¨çº¿ç¨‹ï¼‰ï¼Œåˆ™è¿™ç§è¡Œä¸ºæ¨¡å¼ç§°ä¸º**éé˜»å¡ï¼ˆNon-Blockingï¼‰**ã€‚

å¸¸ç”¨çš„ç½‘ç»œI/Oæ¨¡å‹åŒ…æ‹¬:

#### 1 é˜»å¡I/Oæ¨¡å‹

![](images/image-20250724120738254.png)

åœ¨é˜»å¡I/Oæ¨¡å‹ä¸‹ï¼Œåœ¨ç”¨æˆ·ç©ºé—´åº”ç”¨çº¿ç¨‹å‘æ“ä½œç³»ç»Ÿå†…æ ¸å‘èµ·I/Oè¯·æ±‚åï¼ˆä¸€èˆ¬ä¸ºæ“ä½œç³»ç»Ÿæä¾›çš„I/Oç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œå†…æ ¸å°†å°è¯•æ‰§è¡Œè¯¥I/Oæ“ä½œï¼Œå¹¶ç­‰æ‰€æœ‰æ•°æ®å°±ç»ªåï¼Œå°†æ•°æ®ä»å†…æ ¸ç©ºé—´å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼Œæœ€åç³»ç»Ÿè°ƒç”¨ä»å†…æ ¸ç©ºé—´è¿”å›ã€‚è€Œåœ¨è¿™æœŸé—´ï¼Œç”¨æˆ·ç©ºé—´åº”ç”¨çº¿ç¨‹å°†é˜»å¡åœ¨è¯¥I/Oç³»ç»Ÿè°ƒç”¨ä¸Šï¼Œæ— æ³•è¿›è¡Œåç»­å¤„ç†ï¼Œåªèƒ½ç­‰å¾…ã€‚

å› æ­¤ï¼Œåœ¨è¿™æ ·çš„æ¨¡å‹ä¸‹ï¼Œ**æ‰€æœ‰Socketé»˜è®¤éƒ½æ˜¯é˜»å¡çš„**ã€‚ä¸€ä¸ªçº¿ç¨‹ä»…èƒ½å¤„ç†ä¸€ä¸ªç½‘ç»œè¿æ¥ä¸Šçš„æ•°æ®é€šä¿¡ã€‚å³ä¾¿è¿æ¥ä¸Šæ²¡æœ‰æ•°æ®ï¼Œçº¿ç¨‹ä¹Ÿåªèƒ½é˜»å¡åœ¨å¯¹Socketçš„è¯»æ“ä½œä¸Šï¼Œç­‰å¾…å¯¹ç«¯çš„æ•°æ®ã€‚ä¸è¿‡ï¼Œè™½ç„¶è¯¥æ¨¡å‹å¯¹åº”ç”¨æ•´ä½“è€Œè¨€æ˜¯ä½æ•ˆçš„ï¼Œä½†å¯¹å¼€å‘äººå‘˜æ¥è¯´ï¼ŒåŸºäºè¯¥æ¨¡å‹å¼€å‘ç½‘ç»œé€šä¿¡åº”ç”¨å´æ˜¯æœ€å®¹æ˜“çš„ã€‚

#### 2 éé˜»å¡I/Oæ¨¡å‹

![](images/image-20250724120817766.png)

åœ¨éé˜»å¡æ¨¡å‹ä¸‹ï¼Œåœ¨ç”¨æˆ·ç©ºé—´çº¿ç¨‹å‘æ“ä½œç³»ç»Ÿå†…æ ¸å‘èµ·I/Oè¯·æ±‚åï¼Œå†…æ ¸ä¼šæ‰§è¡Œè¯¥I/Oæ“ä½œã€‚å¦‚æœæ­¤åˆ»æ•°æ®å°šæœªå°±ç»ªï¼Œåˆ™ä¼šç«‹å³å°†â€œæœªå°±ç»ªâ€çš„çŠ¶æ€ä»¥é”™è¯¯ç å½¢å¼ï¼ˆå¦‚EAGAIN/EWOULDBLOCKï¼‰è¿”å›ç»™æ­¤æ¬¡I/Oç³»ç»Ÿè°ƒç”¨çš„å‘èµ·è€…ã€‚è€Œåè€…åˆ™æ ¹æ®ç³»ç»Ÿè°ƒç”¨çš„è¿”å›çŠ¶æ€å†³å®šä¸‹ä¸€æ­¥å¦‚ä½•åšã€‚

åœ¨éé˜»å¡æ¨¡å‹ä¸‹ï¼Œä½äºç”¨æˆ·ç©ºé—´çš„I/Oè¯·æ±‚å‘èµ·è€…é€šå¸¸ä¼šé€šè¿‡**è½®è¯¢**çš„æ–¹å¼ä¸€æ¬¡æ¬¡å‘èµ·I/Oè¯·æ±‚ï¼Œç›´åˆ°è¯»åˆ°æ‰€éœ€çš„æ•°æ®ã€‚ä¸è¿‡ï¼Œè¿™æ ·çš„è½®è¯¢æ˜¯å¯¹CPUè®¡ç®—èµ„æºçš„æå¤§æµªè´¹ï¼Œå› æ­¤**éé˜»å¡I/Oæ¨¡å‹å•ç‹¬åº”ç”¨çš„æ¯”ä¾‹å¹¶ä¸é«˜**ã€‚é˜»å¡çš„Socketé»˜è®¤å¯ä»¥é€šè¿‡`fcntl`è°ƒç”¨è½¬å˜ä¸ºéé˜»å¡Socketã€‚

#### 3 I/Oå¤šè·¯å¤ç”¨æ¨¡å‹

ä¸ºäº†é¿å…éé˜»å¡I/Oæ¨¡å‹è½®è¯¢å¯¹è®¡ç®—èµ„æºçš„æµªè´¹ä»¥åŠé˜»å¡I/Oæ¨¡å‹çš„ä½æ•ˆï¼Œå¼€å‘äººå‘˜å¼€å§‹é¦–é€‰I/Oå¤šè·¯å¤ç”¨æ¨¡å‹ä½œä¸ºç½‘ç»œI/Oæ¨¡å‹ã€‚

I/Oå¤šè·¯å¤ç”¨æ¨¡å‹å»ºç«‹åœ¨æ“ä½œç³»ç»Ÿæä¾›çš„`select/poll`ç­‰å¤šè·¯å¤ç”¨å‡½æ•°ï¼ˆä»¥åŠæ€§èƒ½æ›´å¥½çš„`epoll`ç­‰å‡½æ•°ï¼‰çš„åŸºç¡€ä¸Šã€‚

![](images/image-20250724120849800.png)

è¯¥æ¨¡å‹ä¸‹ï¼Œåº”ç”¨çº¿ç¨‹é¦–å…ˆå°†éœ€è¦è¿›è¡ŒI/Oæ“ä½œçš„Socketéƒ½æ·»åŠ åˆ°**å¤šè·¯å¤ç”¨å‡½æ•°**ä¸­ï¼ˆè¿™é‡Œä»¥selectä¸ºä¾‹ï¼‰ï¼Œæ¥ç€é˜»å¡ï¼Œç­‰å¾…selectç³»ç»Ÿè°ƒç”¨è¿”å›ã€‚å½“å†…æ ¸å‘ç°æœ‰æ•°æ®åˆ°è¾¾æ—¶ï¼Œå¯¹åº”çš„Socketå…·å¤‡é€šä¿¡æ¡ä»¶ï¼Œselectå‡½æ•°è¿”å›ã€‚ç„¶åç”¨æˆ·çº¿ç¨‹é’ˆå¯¹è¯¥Socketå†æ¬¡å‘èµ·ç½‘ç»œI/Oè¯·æ±‚ï¼ˆå¦‚readï¼‰ã€‚ç”±äºæ•°æ®å·²å°±ç»ªï¼Œå› æ­¤å³ä¾¿Socketæ˜¯é˜»å¡çš„ï¼Œç¬¬äºŒæ¬¡ç½‘ç»œI/Oæ“ä½œä¹Ÿéå¸¸å¿«ã€‚

é˜»å¡æ¨¡å‹ä¸€ä¸ªçº¿ç¨‹ä»…èƒ½å¤„ç†ä¸€ä¸ªSocketï¼Œè€Œåœ¨I/Oå¤šè·¯å¤ç”¨æ¨¡å‹ä¸­ï¼Œåº”ç”¨çº¿ç¨‹å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªSocketï¼›è™½ç„¶å¯åŒæ—¶å¤„ç†å¤šä¸ªSocketï¼Œä½†I/Oå¤šè·¯å¤ç”¨æ¨¡å‹**ç”±å†…æ ¸å®ç°å¯è¯»/å¯å†™äº‹ä»¶çš„é€šçŸ¥**ï¼Œé¿å…äº†éé˜»å¡æ¨¡å‹ä¸­è½®è¯¢å¸¦æ¥çš„CPUè®¡ç®—èµ„æºçš„æµªè´¹ã€‚

#### 4 å¼‚æ­¥I/Oæ¨¡å‹

åœ¨å¼‚æ­¥I/Oæ¨¡å‹ä¸‹ï¼Œç”¨æˆ·åº”ç”¨çº¿ç¨‹ä¸æ“ä½œç³»ç»Ÿå†…æ ¸çš„äº¤äº’è¡Œä¸ºæ¨¡å¼ä¸åœ¨å‰å‡ ç§æ¨¡å‹ä¸‹å·®å¼‚è¾ƒå¤§ï¼š

![](images/image-20250724120916210.png)

ç”¨æˆ·åº”ç”¨çº¿ç¨‹å‘èµ·å¼‚æ­¥I/Oè°ƒç”¨åï¼Œå†…æ ¸å°†å¯åŠ¨ç­‰å¾…æ•°æ®çš„æ“ä½œ**å¹¶é©¬ä¸Šè¿”å›**ã€‚

ä¹‹åï¼Œç”¨æˆ·åº”ç”¨çº¿ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œ**æ—¢æ— é¡»é˜»å¡ï¼Œä¹Ÿæ— é¡»è½®è¯¢å¹¶å†æ¬¡å‘èµ·I/Oè°ƒç”¨**ã€‚åœ¨å†…æ ¸ç©ºé—´æ•°æ®å°±ç»ªå¹¶è¢«ä»å†…æ ¸ç©ºé—´å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´åï¼Œå†…æ ¸ä¼šä¸»åŠ¨ç”Ÿæˆä¿¡å·ä»¥é©±åŠ¨æ‰§è¡Œç”¨æˆ·çº¿ç¨‹åœ¨å¼‚æ­¥I/Oè°ƒç”¨æ—¶æ³¨å†Œçš„ä¿¡å·å¤„ç†å‡½æ•°ï¼Œæˆ–ä¸»åŠ¨æ‰§è¡Œç”¨æˆ·çº¿ç¨‹æ³¨å†Œçš„å›è°ƒå‡½æ•°ï¼Œè®©ç”¨æˆ·çº¿ç¨‹å®Œæˆå¯¹æ•°æ®çš„å¤„ç†ã€‚

ç›¸è¾ƒäºä¸Šè¿°å‡ ä¸ªæ¨¡å‹ï¼Œå¼‚æ­¥I/Oæ¨¡å‹å—å„ä¸ªå¹³å°çš„æ”¯æŒç¨‹åº¦ä¸ä¸€ï¼Œä¸”**ä½¿ç”¨èµ·æ¥å¤æ‚åº¦è¾ƒé«˜**ï¼Œåœ¨å¦‚ä½•è¿›è¡Œ**å†…å­˜ç®¡ç†ã€ä¿¡å·å¤„ç†/å›è°ƒå‡½æ•°**ç­‰é€»è¾‘è®¾è®¡ä¸Šä¼šç»™å¼€å‘äººå‘˜å¸¦æ¥ä¸å°çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚

æœ‰äº›æ ‡å‡†ä½¿ç”¨åŒæ­¥å’Œå¼‚æ­¥æ¥æè¿°ç½‘ç»œI/Oæ“ä½œæ¨¡å‹ã€‚æ‰€è°“**åŒæ­¥I/OæŒ‡çš„æ˜¯èƒ½å¼•èµ·è¯·æ±‚çº¿ç¨‹é˜»å¡ï¼Œç›´åˆ°I/Oæ“ä½œå®Œæˆï¼›è€Œå¼‚æ­¥I/Oåˆ™ä¸å¼•èµ·è¯·æ±‚çº¿ç¨‹çš„é˜»å¡**ã€‚æŒ‰ç…§è¿™ä¸ªè¯´æ³•ï¼Œå‰é¢æåˆ°çš„<u>é˜»å¡I/Oã€éé˜»å¡I/Oã€I/Oå¤šè·¯å¤ç”¨å‡å¯çœ‹æˆåŒæ­¥I/Oæ¨¡å‹ï¼Œè€Œåªæœ‰å¼‚æ­¥I/Oæ‰æ˜¯åå‰¯å…¶å®çš„â€œå¼‚æ­¥I/Oâ€æ¨¡å‹</u>ã€‚

ä¼´éšç€æ¨¡å‹çš„æ¼”è¿›ï¼ŒæœåŠ¡ç¨‹åºæ„ˆå‘å¼ºå¤§ï¼Œå¯ä»¥æ”¯æŒæ›´å¤šçš„è¿æ¥ï¼Œè·å¾—æ›´å¥½çš„å¤„ç†æ€§èƒ½ã€‚ç›®å‰**ä¸»æµç½‘ç»œæœåŠ¡å™¨é‡‡ç”¨çš„å¤šæ˜¯I/Oå¤šè·¯å¤ç”¨æ¨¡å‹**ï¼Œæœ‰çš„ä¹Ÿç»“åˆäº†å¤šçº¿ç¨‹ã€‚ä¸è¿‡I/Oå¤šè·¯å¤ç”¨æ¨¡å‹åœ¨æ”¯æŒæ›´å¤šè¿æ¥ã€æå‡I/Oæ“ä½œæ•ˆç‡çš„åŒæ—¶ï¼Œä¹Ÿç»™ä½¿ç”¨è€…å¸¦æ¥äº†ä¸ä½çš„å¤æ‚æ€§ï¼Œä»¥è‡³äºå‡ºç°äº†è®¸å¤šé«˜æ€§èƒ½çš„I/Oå¤šè·¯å¤ç”¨æ¡†æ¶ï¼ˆå¦‚libeventã€libevã€libuvç­‰ï¼‰ä»¥é™ä½å¼€å‘å¤æ‚æ€§ï¼Œå‡è½»å¼€å‘è€…çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚

ä¸è¿‡Goè¯­è¨€çš„è®¾è®¡è€…è®¤ä¸ºI/Oå¤šè·¯å¤ç”¨çš„è¿™ç§**é€šè¿‡å›è°ƒå‰²è£‚æ§åˆ¶æµçš„æ¨¡å‹ä¾æ—§å¤æ‚**ï¼Œä¸”æœ‰æ‚–äºä¸€èˆ¬é¡ºåºçš„é€»è¾‘è®¾è®¡ï¼Œä¸ºæ­¤ä»–ä»¬ç»“åˆGoè¯­è¨€çš„è‡ªèº«ç‰¹ç‚¹ï¼Œå°†è¯¥â€œå¤æ‚æ€§â€éšè—åœ¨äº†Goè¿è¡Œæ—¶ä¸­ã€‚è¿™æ ·ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒGoå¼€å‘è€…æ— é¡»å…³å¿ƒSocketæ˜¯ä¸æ˜¯é˜»å¡çš„ï¼Œä¹Ÿæ— é¡»äº²è‡ªå°†Socketæ–‡ä»¶æè¿°ç¬¦çš„å›è°ƒå‡½æ•°æ³¨å†Œåˆ°ç±»ä¼¼selectè¿™æ ·çš„ç³»ç»Ÿè°ƒç”¨ä¸­ï¼Œè€Œåªéœ€åœ¨æ¯ä¸ªè¿æ¥å¯¹åº”çš„goroutineä¸­ä»¥æœ€ç®€å•ã€æœ€æ˜“ç”¨çš„é˜»å¡I/Oæ¨¡å‹çš„æ–¹å¼è¿›è¡ŒSocketæ“ä½œå³å¯ï¼Œè¿™ç§è®¾è®¡å¤§å¤§å‡è½»äº†ç½‘ç»œåº”ç”¨å¼€å‘äººå‘˜çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚

ä¸€ä¸ªå…¸å‹çš„Goç½‘ç»œæœåŠ¡ç«¯ç¨‹åºå¤§è‡´å¦‚ä¸‹ï¼š

```go
func handleConn(c net.Conn) {
	defer c.Close()
	for {
		// read from the connection
		// ... ...
		// write to the connection
		//... ...
	}
}

func main() {
	l, err := net.Listen("tcp", ":8888")
	if err != nil {
		fmt.Println("listen error:", err)
		return
	}

	for {
		c, err := l.Accept()
		if err != nil {
			fmt.Println("accept error:", err)
			break
		}
		// å¯åŠ¨ä¸€ä¸ªæ–°çš„goroutineå¤„ç†è¿™ä¸ªæ–°è¿æ¥ï¿¼
		go handleConn(c)
	}
}
```

åœ¨Goç¨‹åºçš„**ç”¨æˆ·å±‚**ï¼ˆç›¸å¯¹äºGo**è¿è¡Œæ—¶å±‚**ï¼‰çœ‹æ¥ï¼Œgoroutineé‡‡ç”¨äº†â€œé˜»å¡I/Oæ¨¡å‹â€è¿›è¡Œç½‘ç»œI/Oæ“ä½œï¼ŒSocketéƒ½æ˜¯â€œé˜»å¡â€çš„ã€‚ä½†å®é™…ä¸Šï¼Œè¿™æ ·çš„å‡è±¡æ˜¯Goè¿è¡Œæ—¶ä¸­çš„**netpollerï¼ˆç½‘ç»œè½®è¯¢å™¨ï¼‰**é€šè¿‡I/Oå¤šè·¯å¤ç”¨æœºåˆ¶æ¨¡æ‹Ÿå‡ºæ¥çš„ï¼Œå¯¹åº”çš„åº•å±‚æ“ä½œç³»ç»ŸSocketå®é™…ä¸Šæ˜¯éé˜»å¡çš„ï¼š

```go
// $GOROOT/src/net/sock_cloexec.go
func sysSocket(family, sotype, proto int) (int, error) {
  ...
  if err = syscall.SetNonblock(s, true); err != nil {
		poll.CloseFunc(s)
    return -1, os.NewSyscallError("setnonblock", err)
  }
  ...
}
```

åªæ˜¯è¿è¡Œæ—¶æ‹¦æˆªäº†é’ˆå¯¹åº•å±‚Socketçš„ç³»ç»Ÿè°ƒç”¨è¿”å›çš„é”™è¯¯ç ï¼Œå¹¶é€šè¿‡netpollerå’Œgoroutineè°ƒåº¦è®©goroutineâ€œé˜»å¡â€åœ¨ç”¨æˆ·å±‚æ‰€çœ‹åˆ°çš„Socketæè¿°ç¬¦ä¸Šã€‚

æ¯”å¦‚ï¼šå½“ç”¨æˆ·å±‚é’ˆå¯¹æŸä¸ªSocketæè¿°ç¬¦å‘èµ·readæ“ä½œæ—¶ï¼Œå¦‚æœè¯¥Socketå¯¹åº”çš„è¿æ¥ä¸Šå°šæ— æ•°æ®ï¼Œé‚£ä¹ˆGoè¿è¡Œæ—¶ä¼šå°†è¯¥Socketæè¿°ç¬¦åŠ å…¥netpollerä¸­ç›‘å¬ï¼Œç›´åˆ°Goè¿è¡Œæ—¶æ”¶åˆ°è¯¥Socketæ•°æ®å¯è¯»çš„é€šçŸ¥ï¼ŒGoè¿è¡Œæ—¶æ‰ä¼šé‡æ–°å”¤é†’ç­‰å¾…åœ¨è¯¥Socketä¸Šå‡†å¤‡è¯»æ•°æ®çš„é‚£ä¸ªgoroutineã€‚è€Œè¿™ä¸ªè¿‡ç¨‹ä»goroutineçš„è§†è§’æ¥çœ‹ï¼Œå°±åƒæ˜¯readæ“ä½œä¸€ç›´é˜»å¡åœ¨é‚£ä¸ªSocketæè¿°ç¬¦ä¸Šä¼¼çš„ã€‚

Goè¯­è¨€åœ¨netpollerä¸­é‡‡ç”¨äº†I/Oå¤šè·¯å¤ç”¨æ¨¡å‹ã€‚è€ƒè™‘åˆ°æœ€å¸¸è§çš„å¤šè·¯å¤ç”¨ç³»ç»Ÿè°ƒç”¨selectæœ‰æ¯”è¾ƒå¤šçš„é™åˆ¶ï¼Œæ¯”å¦‚**ç›‘å¬Socketçš„æ•°é‡æœ‰ä¸Šé™ï¼ˆ1024ï¼‰ã€æ—¶é—´å¤æ‚åº¦é«˜**ç­‰ï¼ŒGoè¿è¡Œæ—¶é€‰æ‹©äº†åœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸Šä½¿ç”¨æ“ä½œç³»ç»Ÿå„è‡ªå®ç°çš„é«˜æ€§èƒ½å¤šè·¯å¤ç”¨å‡½æ•°ï¼Œæ¯”å¦‚Linuxä¸Šçš„`epoll`ã€Windowsä¸Šçš„`iocp`ã€FreeBSD/macOSä¸Šçš„`kqueue`ã€Solarisä¸Šçš„`event port`ç­‰ï¼Œè¿™æ ·å¯ä»¥æœ€å¤§é™åº¦åœ°æé«˜netpollerçš„è°ƒåº¦å’Œæ‰§è¡Œæ€§èƒ½ã€‚

### 63.2 TCPè¿æ¥çš„å»ºç«‹

ä¼—æ‰€å‘¨çŸ¥ï¼Œå»ºç«‹TCP Socketè¿æ¥éœ€è¦ç»å†å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ã€‚åœ¨è¿æ¥çš„å»ºç«‹è¿‡ç¨‹ä¸­ï¼ŒæœåŠ¡ç«¯æ˜¯ä¸€ä¸ªæ ‡å‡†çš„**Listen+Accept**çš„ç»“æ„ï¼ˆå¯å‚è€ƒä¸Šé¢çš„ä»£ç ï¼‰ï¼Œè€Œåœ¨å®¢æˆ·ç«¯Goè¯­è¨€ä½¿ç”¨**Dialæˆ–DialTimeoutå‡½æ•°**å‘èµ·è¿æ¥å»ºç«‹è¯·æ±‚ã€‚

Dialåœ¨è°ƒç”¨åå°†ä¸€ç›´é˜»å¡ï¼Œç›´åˆ°è¿æ¥å»ºç«‹æˆåŠŸæˆ–å¤±è´¥ã€‚

```go
conn, err := net.Dial("tcp", "taobao.com:80")
if err != nil {
  // å¤„ç†é”™è¯¯
}
// è¿æ¥å»ºç«‹æˆåŠŸï¼Œå¯ä»¥è¿›è¡Œè¯»å†™æ“ä½œ
```

DialTimeoutæ˜¯å¸¦æœ‰è¶…æ—¶æœºåˆ¶çš„Dialï¼š

```go
conn, err := net.DialTimeout("tcp", "localhost:8080", 2 * time.Second)
if err != nil {
  // å¤„ç†é”™è¯¯
}
// è¿æ¥å»ºç«‹æˆåŠŸï¼Œå¯ä»¥è¿›è¡Œè¯»å†™æ“ä½œ
```

å¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œå»ºç«‹è¿æ¥æ—¶å¯èƒ½ä¼šé‡åˆ°å¦‚ä¸‹å‡ ç§æƒ…å½¢ã€‚

#### 1 ç½‘ç»œä¸å¯è¾¾æˆ–å¯¹æ–¹æœåŠ¡æœªå¯åŠ¨

å¦‚æœä¼ ç»™Dialçš„æœåŠ¡ç«¯åœ°å€æ˜¯ç½‘ç»œä¸å¯è¾¾çš„ï¼Œæˆ–è€…æœåŠ¡åœ°å€ä¸­ç«¯å£å¯¹åº”çš„æœåŠ¡å¹¶æ²¡æœ‰å¯åŠ¨ï¼Œç«¯å£æœªè¢«ç›‘å¬ï¼ˆListenï¼‰ï¼Œåˆ™Dialå‡ ä¹ä¼šç«‹å³è¿”å›é”™è¯¯ã€‚

```go
func main() {
	log.Println("begin dial...")
	conn, err := net.Dial("tcp", ":8888")
	if err != nil {
		log.Println("dial error:", err)
		return
	}
	defer conn.Close()
	log.Println("dial ok")
}
```

```
2025/08/08 11:06:31 begin dial...
2025/08/08 11:06:31 dial error: dial tcp :8888: connect: connection refused
```

#### 2 å¯¹æ–¹æœåŠ¡çš„listen backlogé˜Ÿåˆ—æ»¡äº†

è¿˜æœ‰ä¸€ç§åœºæ™¯æ˜¯å¯¹æ–¹æœåŠ¡å™¨å¾ˆå¿™ï¼Œç¬é—´æœ‰å¤§é‡å®¢æˆ·ç«¯å°è¯•ä¸æœåŠ¡ç«¯å»ºç«‹è¿æ¥ï¼ŒæœåŠ¡ç«¯å¯èƒ½ä¼šå‡ºç°listen backlogé˜Ÿåˆ—æ»¡äº†ï¼Œæ¥æ”¶è¿æ¥ï¼ˆacceptï¼‰ä¸åŠæ—¶çš„æƒ…å†µï¼Œè¿™å°†å¯¼è‡´å®¢æˆ·ç«¯çš„Dialè°ƒç”¨é˜»å¡ã€‚ï¼ˆé€šå¸¸ï¼Œå³ä¾¿æœåŠ¡ç«¯ä¸è°ƒç”¨acceptæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œåœ¨backlogæ•°é‡èŒƒå›´ä¹‹å†…ï¼Œå®¢æˆ·ç«¯çš„è¿æ¥æ“ä½œä¹Ÿéƒ½æ˜¯ä¼šæˆåŠŸçš„ï¼Œå› ä¸ºæ–°çš„è¿æ¥å·²ç»åŠ å…¥æœåŠ¡ç«¯çš„å†…æ ¸listené˜Ÿåˆ—ä¸­äº†ï¼Œacceptæ“ä½œåªæ˜¯ä»è¿™ä¸ªé˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªè¿æ¥è€Œå·²ã€‚ï¼‰



```sh
$ sysctl -a | grep kern.ipc.somaxconn
kern.ipc.somaxconn: 128
```



#### 3 è‹¥ç½‘ç»œå»¶è¿Ÿè¾ƒå¤§ï¼ŒDialå°†é˜»å¡å¹¶è¶…æ—¶

å¦‚æœç½‘ç»œå»¶è¿Ÿè¾ƒå¤§ï¼ŒTCPæ¡æ‰‹è¿‡ç¨‹å°†æ›´åŠ è‰°éš¾åå·ï¼ˆç»å†å„ç§ä¸¢åŒ…ï¼‰ï¼Œæ—¶é—´æ¶ˆè€—è‡ªç„¶ä¹Ÿä¼šæ›´é•¿ï¼ŒDialæ­¤æ—¶ä¼šé˜»å¡ã€‚å¦‚æœç»è¿‡é•¿æ—¶é—´é˜»å¡åä¾æ—§æ— æ³•å»ºç«‹è¿æ¥ï¼Œé‚£ä¹ˆDialä¹Ÿä¼šè¿”å›ç±»ä¼¼â€œgetsockopt: operation timed outâ€çš„é”™è¯¯ã€‚

åœ¨è¿æ¥å»ºç«‹é˜¶æ®µï¼Œå¤šæ•°æƒ…å†µä¸‹Dialæ˜¯å¯ä»¥æ»¡è¶³éœ€æ±‚çš„ï¼Œå³ä¾¿æ˜¯é˜»å¡ä¸€å°ä¼šå„¿ã€‚ä½†å¯¹äºé‚£äº›æœ‰ä¸¥æ ¼çš„è¿æ¥æ—¶é—´é™å®šçš„Goåº”ç”¨ï¼Œå¦‚æœä¸€å®šæ—¶é—´å†…æ²¡èƒ½æˆåŠŸå»ºç«‹è¿æ¥ï¼Œç¨‹åºå¯èƒ½éœ€è¦æ‰§è¡Œä¸€æ®µå¼‚å¸¸å¤„ç†é€»è¾‘ï¼Œä¸ºæ­¤æˆ‘ä»¬å°±éœ€è¦DialTimeoutå‡½æ•°äº†ã€‚





### 63.3 Socketè¯»å†™ğŸ”–

**è¿æ¥å»ºç«‹èµ·æ¥åï¼Œå°±è¦åœ¨è¿æ¥ä¸Šè¿›è¡Œè¯»å†™ä»¥å®Œæˆä¸šåŠ¡é€»è¾‘ã€‚**

å‰é¢è¯´è¿‡ï¼Œ**Goè¿è¡Œæ—¶éšè—äº†I/Oå¤šè·¯å¤ç”¨çš„å¤æ‚æ€§**ã€‚

è¯­è¨€ä½¿ç”¨è€…åªéœ€é‡‡ç”¨goroutine+é˜»å¡I/Oæ¨¡å‹å³å¯æ»¡è¶³å¤§éƒ¨åˆ†åœºæ™¯éœ€æ±‚ã€‚Dialè¿æ¥æˆåŠŸåä¼šè¿”å›ä¸€ä¸ªnet.Connæ¥å£ç±»å‹çš„å˜é‡å€¼ï¼Œè¿™ä¸ªæ¥å£å˜é‡çš„åº•å±‚ç±»å‹ä¸ºä¸€ä¸ª`*TCPConn`:

```go
//$GOROOT/src/net/tcpsock_posix.go
type TCPConn struct {
  conn
}
```

TCPConnå†…åµŒäº†ä¸€ä¸ªéå¯¼å‡ºç±»å‹connï¼Œå› æ­¤â€œç»§æ‰¿â€äº†connç±»å‹çš„Readå’ŒWriteæ–¹æ³•ï¼Œåç»­é€šè¿‡Dialå‡½æ•°è¿”å›å€¼è°ƒç”¨çš„Writeå’ŒReadæ–¹æ³•å‡æ˜¯net.connçš„æ–¹æ³•ï¼š

```go
//$GOROOT/src/net/net.go
type conn struct {
	fd *netFD
}

func (c *conn) ok() bool { return c != nil && c.fd != nil }

// å®ç°Connæ¥å£ï¿¼

func (c *conn) Read(b []byte) (int, error) {
	if !c.ok() {
		return 0, syscall.EINVAL
	}
	n, err := c.fd.Read(b)
	if err != nil && err != io.EOF {
		err = &OpError{Op: "read", Net: c.fd.net, Source: c.fd.laddr, Addr: c.fd.raddr, Err: err}
	}
	return n, err
}

func (c *conn) Write(b []byte) (int, error) {
	if !c.ok() {
		return 0, syscall.EINVAL
	}
	n, err := c.fd.Write(b)
	if err != nil {
		err = &OpError{Op: "write", Net: c.fd.net, Source: c.fd.laddr, Addr: c.fd.raddr, Err: err}
	}
	return n, err
}
```

é€šè¿‡å‡ ä¸ªåœºæ™¯æ¥æ€»ç»“ä¸€ä¸‹conn.Readçš„è¡Œä¸ºç‰¹ç‚¹

#### 1 Socketä¸­æ— æ•°æ®

è¿æ¥å»ºç«‹åï¼Œå¦‚æœå®¢æˆ·ç«¯æœªå‘é€æ•°æ®ï¼ŒæœåŠ¡ç«¯ä¼šé˜»å¡åœ¨Socketçš„è¯»æ“ä½œä¸Šï¼Œè¿™å’Œå‰é¢æåˆ°çš„é˜»å¡I/Oæ¨¡å‹çš„è¡Œä¸ºæ¨¡å¼æ˜¯ä¸€è‡´çš„ã€‚æ‰§è¡Œè¯¥è¯»æ“ä½œçš„goroutineä¹Ÿä¼šè¢«æŒ‚èµ·ã€‚Goè¿è¡Œæ—¶ä¼šç›‘è§†è¯¥Socketï¼Œç›´åˆ°å…¶æœ‰æ•°æ®è¯»äº‹ä»¶æ‰ä¼šé‡æ–°è°ƒåº¦è¯¥Socketå¯¹åº”çš„goroutineå®Œæˆè¯»æ“ä½œã€‚



#### 2 Socketä¸­æœ‰éƒ¨åˆ†æ•°æ®

å¦‚æœSocketä¸­æœ‰éƒ¨åˆ†æ•°æ®å°±ç»ªï¼Œä¸”æ•°æ®æ•°é‡å°äºä¸€æ¬¡è¯»æ“ä½œæ‰€æœŸæœ›è¯»å‡ºçš„æ•°æ®é•¿åº¦ï¼Œé‚£ä¹ˆè¯»æ“ä½œå°†ä¼šæˆåŠŸè¯»å‡ºè¿™éƒ¨åˆ†æ•°æ®å¹¶è¿”å›ï¼Œè€Œä¸æ˜¯ç­‰å¾…æœŸæœ›é•¿åº¦æ•°æ®å…¨éƒ¨è¯»å–åå†è¿”å›ã€‚



#### 3 Socketä¸­æœ‰è¶³å¤Ÿå¤šçš„æ•°æ®

å¦‚æœè¿æ¥ä¸Šæœ‰æ•°æ®ï¼Œä¸”æ•°æ®é•¿åº¦å¤§äºæˆ–ç­‰äºä¸€æ¬¡Readæ“ä½œæ‰€æœŸæœ›è¯»å‡ºçš„æ•°æ®é•¿åº¦ï¼Œé‚£ä¹ˆReadå°†ä¼šæˆåŠŸè¯»å‡ºè¿™éƒ¨åˆ†æ•°æ®å¹¶è¿”å›ã€‚



#### 4 Socketå…³é—­



#### 5 è¯»æ“ä½œè¶…æ—¶



#### 6 æˆåŠŸå†™



#### 7 å†™é˜»å¡



#### 8 å†™å…¥éƒ¨åˆ†æ•°æ®



#### 9 å†™å…¥è¶…æ—¶



#### 10 goroutineå®‰å…¨çš„å¹¶å‘è¯»å†™





### 63.4 Socketå±æ€§

åŸç”ŸSocket APIæä¾›äº†ä¸°å¯Œçš„sockoptè®¾ç½®æ¥å£ï¼Œè€ŒGoæœ‰è‡ªå·±çš„ç½‘ç»œç¼–ç¨‹æ¨¡å‹ã€‚Goæä¾›çš„socket optionsæ¥å£ä¹Ÿæ˜¯åŸºäºä¸Šè¿°æ¨¡å‹çš„å¿…è¦çš„å±æ€§è®¾ç½®ï¼ŒåŒ…æ‹¬SetKeepAliveã€SetKeep-AlivePeriodã€SetLingerã€SetNoDelay ï¼ˆé»˜è®¤ä¸ºno delayï¼‰ã€SetWriteBufferã€SetReadBufferã€‚

ä¸è¿‡ä¸Šé¢çš„æ–¹æ³•æ˜¯TCPConnç±»å‹çš„ï¼Œè€Œä¸æ˜¯Connç±»å‹çš„ã€‚è¦ä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•ï¼Œéœ€è¦è¿›è¡Œç±»å‹æ–­è¨€ï¼ˆtype assertionï¼‰æ“ä½œï¼š

```go
tcpConn, ok := c.(*TCPConn)
if !ok {
  // é”™è¯¯å¤„ç†
}

tcpConn.SetNoDelay(true)
```

å¯¹äºlistenerçš„ç›‘å¬Socketï¼ŒGoé»˜è®¤è®¾ç½®äº†SO_REUSEADDRï¼Œè¿™æ ·å½“ä½ é‡å¯æœåŠ¡ç¨‹åºæ—¶ï¼Œä¸ä¼šå› ä¸ºaddress in useçš„é”™è¯¯è€Œé‡å¯å¤±è´¥ã€‚

### 63.5 å…³é—­è¿æ¥



## 64 ä½¿ç”¨net/httpåŒ…å®ç°å®‰å…¨é€šä¿¡

### 64.1 HTTPSï¼šåœ¨å®‰å…¨ä¼ è¾“å±‚ä¸Šè¿è¡Œçš„HTTPåè®®

![](images/image-20250908113649468.png)

![](images/image-20250908113723024.png)

HTTPSåè®®å°±æ˜¯ç”¨æ¥è§£å†³ä¼ ç»ŸHTTPåè®®æ˜æ–‡ä¼ è¾“ä¸å®‰å…¨çš„é—®é¢˜çš„ã€‚ä¸æ™®é€šHTTPåè®®ä¸åŒï¼ŒHTTPSåè®®åœ¨ä¼ è¾“å±‚ï¼ˆTCPåè®®ï¼‰å’Œåº”ç”¨å±‚ï¼ˆHTTPåè®®ï¼‰ä¹‹é—´å¢åŠ äº†ä¸€ä¸ª==å®‰å…¨ä¼ è¾“å±‚==ï¼š

![](images/image-20250724123229454.png)

å®‰å…¨ä¼ è¾“å±‚é€šå¸¸é‡‡ç”¨**SSLï¼ˆSecure Socket Layerï¼‰**æˆ–**TLSï¼ˆTransport Layer Securityï¼‰**åè®®å®ç°ï¼ˆGoæ ‡å‡†åº“æ”¯æŒTLS 1.3ç‰ˆæœ¬åè®®ï¼‰ã€‚è¿™ä¸€å±‚è´Ÿè´£HTTPåè®®ä¼ è¾“çš„**å†…å®¹åŠ å¯†ã€é€šä¿¡åŒæ–¹èº«ä»½éªŒè¯**ç­‰ã€‚æœ‰äº†è¿™ä¸€å±‚åï¼ŒHTTPåè®®å°±æ‘‡èº«ä¸€å˜ï¼Œæˆä¸ºæ‹¥æœ‰**åŠ å¯†ã€è¯ä¹¦èº«ä»½éªŒè¯å’Œå†…å®¹å®Œæ•´æ€§ä¿æŠ¤åŠŸèƒ½**çš„HTTPSåè®®äº†ã€‚æˆ–è€…åè¿‡æ¥è¯´ï¼Œ==HTTPSåè®®å°±æ˜¯åœ¨å®‰å…¨ä¼ è¾“å±‚ä¸Šè¿è¡Œçš„HTTPåè®®==ã€‚

Goæ ‡å‡†åº“net/httpåŒ…åŒæ ·æä¾›äº†å¯¹é‡‡ç”¨HTTPSåè®®çš„WebæœåŠ¡çš„æ”¯æŒã€‚åªéœ€ä¿®æ”¹ä¸€è¡Œä»£ç å°±èƒ½å°†ä¸Šé¢ç¤ºä¾‹ä¸­çš„é‚£ä¸ªåŸºäºHTTPåè®®çš„WebæœåŠ¡æ”¹ä¸ºä¸€ä¸ªé‡‡ç”¨HTTPSåè®®çš„WebæœåŠ¡ï¼š

```go
func main() {
	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		w.Write([]byte("hello https"))
		fmt.Fprintf(w, " golang \n")
	})
	fmt.Println(http.ListenAndServeTLS(":8081", "server.crt", "server.key", nil))
}
```

`http.ListenAndServeTLS`æœ‰ä¸¤ä¸ªå‚æ•°certFileå’ŒkeyFileï¼Œæ˜¯httpåŒ…é’ˆå¯¹HTTPSåè®®è¿›è¡Œå†…å®¹åŠ å¯†ã€èº«ä»½éªŒè¯å’Œå†…å®¹å®Œæ•´æ€§éªŒè¯çš„å‰æã€‚

ç”¨opensslå·¥å…·å¯ä»¥ç”Ÿæˆè¯¥ç¤ºä¾‹ä¸­HTTPS WebæœåŠ¡æ‰€éœ€çš„server.keyå’Œserver.crtï¼Œå¹¶è®©è¿™ä¸ªç¤ºä¾‹ä¸­çš„æœåŠ¡è¿è¡Œèµ·æ¥ï¼š

```sh
$ openssl genrsa -out server.key 2048
$ openssl req -new -x509 -key server.key -out server.crt -days 365
```

https://localhost:8081/ï¼Œæµè§ˆå™¨ä¼šæ˜¾ç¤ºè­¦å‘Šé¡µé¢ï¼ˆå› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯è‡ªç­¾åè¯ä¹¦ï¼‰

ä½¿ç”¨curlè®¿é—®è¦åŠ -kã€‚

```sh
$ curl -k https://localhost:8081/
hello https golang 
$ curl https://localhost:8081/
curl: (60) SSL certificate problem: self signed certificate
More details here: https://curl.se/docs/sslcerts.html

curl failed to verify the legitimacy of the server and therefore could not
establish a secure connection to it. To learn more about this situation and
how to fix it, please visit the web page mentioned above.
```

æŠ¥é”™çš„ä¸»è¦åŸå› æ˜¯ç¤ºä¾‹ä¸­HTTPS WebæœåŠ¡æ‰€ä½¿ç”¨è¯ä¹¦ï¼ˆserver.crtï¼‰æ˜¯æˆ‘ä»¬è‡ªå·±ç”Ÿæˆçš„è‡ªç­¾åè¯ä¹¦ï¼Œcurlä½¿ç”¨æµ‹è¯•ç¯å¢ƒç³»ç»Ÿä¸­å†…ç½®çš„å„ç§æ•°å­—è¯ä¹¦æˆæƒæœºæ„çš„å…¬é’¥è¯ä¹¦æ— æ³•å¯¹å…¶è¿›è¡ŒéªŒè¯ã€‚è€Œ-ké€‰é¡¹åˆ™è¡¨ç¤ºå¿½ç•¥å¯¹ç¤ºä¾‹ä¸­HTTPS WebæœåŠ¡çš„æœåŠ¡ç«¯è¯ä¹¦çš„æ ¡éªŒã€‚

### 64.2 HTTPSå®‰å…¨ä¼ è¾“å±‚çš„å·¥ä½œæœºåˆ¶

HTTPSæ˜¯å»ºæ„åœ¨åŸºäºSSL/TLSåè®®å®ç°çš„ä¼ è¾“å®‰å…¨å±‚ä¹‹ä¸Šçš„HTTPåè®®ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦é€šä¿¡åŒæ–¹åœ¨ä¼ è¾“å®‰å…¨å±‚ä¸ŠæˆåŠŸå»ºç«‹è¿æ¥ï¼Œé‚£ä¹ˆ**åç»­çš„é€šä¿¡å°±å’Œæ™®é€šHTTPåè®®ä¸€æ ·**ï¼Œåªä¸è¿‡æ‰€æœ‰çš„HTTPåè®®æ•°æ®ç»è¿‡å®‰å…¨å±‚ä¼ è¾“æ—¶éƒ½ä¼šè¢«è‡ªåŠ¨åŠ å¯†/è§£å¯†ã€‚

å®‰å…¨ä¼ è¾“å±‚æ˜¯æ•´ä¸ªHTTPSåè®®çš„æ ¸å¿ƒï¼Œäº†è§£å…¶å·¥ä½œæœºåˆ¶å¯¹ç†è§£HTTPSåè®®è‡³å…³é‡è¦ã€‚

é€šè¿‡curlå‘½ä»¤æ¢ç©¶å®‰å…¨ä¼ è¾“å±‚è¿æ¥çš„å»ºç«‹è¿‡ç¨‹:

```sh
$ curl -v -k https://127.0.0.1:8081/
*   Trying 127.0.0.1:8081...
* Connected to 127.0.0.1 (127.0.0.1) port 8081
* ALPN: curl offers h2,http/1.1
* (304) (OUT), TLS handshake, Client hello (1):
* (304) (IN), TLS handshake, Server hello (2):
* (304) (IN), TLS handshake, Unknown (8):
* (304) (IN), TLS handshake, Certificate (11):
* (304) (IN), TLS handshake, CERT verify (15):
* (304) (IN), TLS handshake, Finished (20):
* (304) (OUT), TLS handshake, Finished (20):
* SSL connection using TLSv1.3 / AEAD-CHACHA20-POLY1305-SHA256 / [blank] / UNDEF
* ALPN: server accepted h2
* Server certificate:
*  subject: C=AU; ST=Some-State; O=Internet Widgits Pty Ltd
*  start date: Sep  8 03:47:07 2025 GMT
*  expire date: Sep  8 03:47:07 2026 GMT
*  issuer: C=AU; ST=Some-State; O=Internet Widgits Pty Ltd
*  SSL certificate verify result: self signed certificate (18), continuing anyway.
* using HTTP/2
* [HTTP/2] [1] OPENED stream for https://127.0.0.1:8081/
* [HTTP/2] [1] [:method: GET]
* [HTTP/2] [1] [:scheme: https]
* [HTTP/2] [1] [:authority: 127.0.0.1:8081]
* [HTTP/2] [1] [:path: /]
* [HTTP/2] [1] [user-agent: curl/8.7.1]
* [HTTP/2] [1] [accept: */*]
> GET / HTTP/2
> Host: 127.0.0.1:8081
> User-Agent: curl/8.7.1
> Accept: */*
> 
* Request completely sent off
< HTTP/2 200 
< content-type: text/plain; charset=utf-8
< content-length: 20
< date: Mon, 08 Sep 2025 03:54:55 GMT
< 
hello https golang 
* Connection #0 to host 127.0.0.1 left intact
```

![](images/image-20250724124600204.png)

å®‰å…¨ä¼ è¾“å±‚å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ä¹Ÿç§°ä¸º**â€œæ¡æ‰‹é˜¶æ®µâ€ï¼ˆhandshakeï¼‰**ï¼Œæ¶‰åŠå››è½®é€šä¿¡ï¼š

1. ClientHelloï¼ˆå®¢æˆ·ç«¯ â†’ æœåŠ¡ç«¯ï¼‰

   å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘å‡ºå»ºç«‹å®‰å…¨å±‚ä¼ è¾“è¿æ¥ï¼Œæ„å»ºåŠ å¯†é€šä¿¡é€šé“çš„è¯·æ±‚ã€‚åœ¨è¿™ä¸ªè¯·æ±‚ä¸­ï¼Œå®¢æˆ·ç«¯ä¼šå‘æœåŠ¡ç«¯æä¾›æœ¬åœ°æœ€æ–°TLSç‰ˆæœ¬ã€æ”¯æŒçš„åŠ å¯†ç®—æ³•ç»„åˆçš„é›†åˆï¼ˆæ¯”å¦‚ä¸Šé¢curlç¤ºä¾‹æ‰€å»ºç«‹çš„å®‰å…¨å±‚ä¼ è¾“ä¼šè¯æœ€ç»ˆé€‰æ‹©çš„ECDHE-RSA-AES128-GCM-SHA256ç»„åˆï¼‰ä»¥åŠéšæœºæ•°ç­‰ã€‚

2. ServerHello & Server certificate &ServerKeyExchangeï¼ˆæœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯ï¼‰

   è¿™ä¸€è½®é€šä¿¡åˆ†ä¸ºä¸‰ä¸ªé‡è¦æ­¥éª¤ã€‚

   - ç¬¬ä¸€æ­¥ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯å‘è¿‡æ¥çš„ClientHelloè¯·æ±‚åï¼Œç”¨å®¢æˆ·ç«¯å‘æ¥çš„ä¿¡æ¯ä¸è‡ªå·±æœ¬åœ°æ”¯æŒçš„TLSç‰ˆæœ¬ã€åŠ å¯†ç®—æ³•ç»„åˆçš„é›†åˆåšæ¯”è¾ƒï¼Œé€‰å‡ºä¸€ä¸ªTLSç‰ˆæœ¬å’Œä¸€ä¸ªåˆé€‚çš„åŠ å¯†ç®—æ³•ç»„åˆï¼Œç„¶åç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œä¸€èµ·æ‰“åŒ…åˆ°ServerHelloä¸­è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

   - ç¬¬äºŒæ­¥ï¼ŒæœåŠ¡å™¨ä¼šå°†è‡ªå·±çš„æœåŠ¡ç«¯å…¬é’¥è¯ä¹¦å‘é€ç»™å®¢æˆ·ç«¯ï¼ˆServer certificateï¼‰ï¼Œè¿™ä¸ªæœåŠ¡ç«¯å…¬é’¥è¯ä¹¦èº«å…¼ä¸¤å¤§èŒè´£ï¼šå®¢æˆ·ç«¯å¯¹æœåŠ¡ç«¯èº«ä»½çš„éªŒè¯ä»¥åŠåç»­åŒæ–¹ä¼šè¯å¯†é’¥çš„åå•†å’Œç”Ÿæˆã€‚

     å¦‚æœæœåŠ¡ç«¯è¦éªŒè¯å®¢æˆ·ç«¯èº«ä»½ï¼ˆå¯é€‰çš„ï¼‰ï¼Œé‚£ä¹ˆè¿™é‡ŒæœåŠ¡ç«¯è¿˜ä¼šå‘é€ä¸€ä¸ªCertificateRequestçš„è¯·æ±‚ç»™å®¢æˆ·ç«¯ï¼Œè¦æ±‚å¯¹å®¢æˆ·ç«¯çš„å…¬é’¥è¯ä¹¦è¿›è¡ŒéªŒè¯ã€‚

   - ç¬¬ä¸‰æ­¥ï¼Œå‘é€å¼€å¯åŒæ–¹ä¼šè¯å¯†é’¥åå•†çš„è¯·æ±‚ï¼ˆServerKeyExchangeï¼‰ã€‚ç›¸æ¯”éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œå¯¹ç§°åŠ å¯†ç®—æ³•çš„æ€§èƒ½è¦é«˜å‡ºå‡ ä¸ªæ•°é‡çº§ï¼Œå› æ­¤HTTPSåœ¨å¼€å§‹çœŸæ­£ä¼ è¾“åº”ç”¨å±‚çš„ç”¨æˆ·æ•°æ®ä¹‹å‰ï¼Œé€‰æ‹©äº†åœ¨éå¯¹ç§°åŠ å¯†ç®—æ³•çš„å¸®åŠ©ä¸‹åå•†ä¸€ä¸ªåŸºäºå¯¹ç§°åŠ å¯†ç®—æ³•çš„å¯†é’¥ã€‚åœ¨å¯†é’¥åå•†ç¯èŠ‚ï¼Œé€šå¸¸ä¼šä½¿ç”¨åˆ°Diffie-Hellmanï¼ˆDHï¼‰å¯†é’¥äº¤æ¢ç®—æ³•ï¼Œè¿™æ˜¯ä¸€ç§å¯†é’¥åå•†çš„åè®®ï¼Œæ”¯æŒé€šä¿¡åŒæ–¹åœ¨ä¸å®‰å…¨çš„é€šé“ä¸Šç”Ÿæˆå¯¹ç§°åŠ å¯†ç®—æ³•æ‰€éœ€çš„å…±äº«å¯†é’¥ã€‚å› æ­¤ï¼Œåœ¨è¿™ä¸ªæ­¥éª¤çš„è¯·æ±‚ä¸­ï¼ŒæœåŠ¡ç«¯ä¼šå‘å®¢æˆ·ç«¯å‘é€å¯†é’¥äº¤æ¢ç®—æ³•çš„ç›¸å…³å‚æ•°ä¿¡æ¯ã€‚

   - æœ€åï¼ŒæœåŠ¡ç«¯ä»¥Server Finishedï¼ˆåˆç§°ä¸ºServerDoneï¼‰ä½œä¸ºè¯¥è½®é€šä¿¡çš„ç»“æŸæ ‡å¿—ã€‚

3. ClientKeyExchange & ClientChangeCipher & Finished ï¼ˆå®¢æˆ·ç«¯ â†’ æœåŠ¡ç«¯ï¼‰

   å®¢æˆ·ç«¯åœ¨æ”¶åˆ°æœåŠ¡ç«¯çš„å…¬é’¥è¯ä¹¦åä¼šå¯¹æœåŠ¡ç«¯çš„èº«ä»½è¿›è¡ŒéªŒè¯ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©ä¸éªŒè¯ï¼‰ï¼Œå¦‚æœéªŒè¯å¤±è´¥ï¼Œåˆ™æ­¤æ¬¡å®‰å…¨ä¼ è¾“å±‚è¿æ¥å»ºç«‹å°±ä¼šä»¥å¤±è´¥å‘Šç»ˆã€‚

   å¦‚æœéªŒè¯é€šè¿‡ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å°†ä»è¯ä¹¦ä¸­æå–å‡ºæœåŠ¡ç«¯çš„å…¬é’¥ï¼Œç”¨äºåŠ å¯†åç»­åå•†å¯†é’¥æ—¶å‘é€ç»™æœåŠ¡ç«¯çš„ä¿¡æ¯ã€‚

   å¦‚æœæœåŠ¡ç«¯è¦æ±‚å¯¹å®¢æˆ·ç«¯è¿›è¡Œèº«ä»½éªŒè¯ï¼ˆæ¥åˆ°æœåŠ¡ç«¯å‘é€çš„CertificateRequestè¯·æ±‚ï¼‰ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯è¿˜éœ€é€šè¿‡ClientCertificateå°†è‡ªå·±çš„å…¬é’¥è¯ä¹¦å‘é€ç»™æœåŠ¡ç«¯è¿›è¡ŒéªŒè¯ã€‚

   æ”¶åˆ°æœåŠ¡ç«¯å¯¹ç§°åŠ å¯†å…±äº«å¯†é’¥åå•†çš„è¯·æ±‚åï¼Œå®¢æˆ·ç«¯æ ¹æ®ä¹‹å‰çš„éšæœºæ•°ã€ç¡®å®šçš„åŠ å¯†ç®—æ³•ç»„åˆä»¥åŠæœåŠ¡ç«¯å‘æ¥çš„å‚æ•°è®¡ç®—å‡ºæœ€ç»ˆçš„ä¼šè¯å¯†é’¥ï¼Œç„¶åå°†æœåŠ¡ç«¯å•ç‹¬è®¡ç®—å‡ºä¼šè¯å¯†é’¥æ‰€éœ€çš„ä¿¡æ¯ç”¨æœåŠ¡ç«¯çš„å…¬é’¥åŠ å¯†åä»¥ClientKeyExchangeè¯·æ±‚å‘é€ç»™æœåŠ¡ç«¯ã€‚

   éšåå®¢æˆ·ç«¯ç”¨ClientChangeCipheré€šçŸ¥æœåŠ¡ç«¯ä»ç°åœ¨å¼€å§‹å‘é€çš„æ¶ˆæ¯éƒ½æ˜¯åŠ å¯†è¿‡çš„ã€‚

   æœ€åï¼Œä¼´éšç€ClientChangeCipheræ¶ˆæ¯ï¼Œæ€»ä¼šæœ‰ä¸€ä¸ªFinishedæ¶ˆæ¯æ¥éªŒè¯åŒæ–¹çš„å¯¹ç§°åŠ å¯†å…±äº«å¯†é’¥åå•†æ˜¯å¦æˆåŠŸã€‚å…¶éªŒè¯çš„æ–¹æ³•å°±æ˜¯é€šè¿‡åå•†å¥½çš„æ–°å…±äº«å¯†é’¥å’Œå¯¹ç§°åŠ å¯†ç®—æ³•å¯¹ä¸€æ®µç‰¹å®šå†…å®¹è¿›è¡ŒåŠ å¯†ï¼Œå¹¶ä»¥æœåŠ¡ç«¯æ˜¯å¦èƒ½å¤Ÿæ­£ç¡®è§£å¯†è¯¥è¯·æ±‚æŠ¥æ–‡ä½œä¸ºå¯†é’¥åå•†æˆåŠŸä¸å¦çš„åˆ¤å®šæ ‡å‡†ã€‚è€Œè¢«åŠ å¯†çš„è¿™æ®µç‰¹å®šå†…å®¹åŒ…å«çš„æ˜¯è¿æ¥è‡³ä»Šçš„å…¨éƒ¨æŠ¥æ–‡å†…å®¹ã€‚FinishedæŠ¥æ–‡ä½œä¸ºè¯¥è½®é€šä¿¡çš„ç»“æŸæ ‡å¿—ï¼Œä¹Ÿæ˜¯å®¢æˆ·ç«¯å‘å‡ºçš„ç¬¬ä¸€æ¡ä½¿ç”¨åå•†å¯†é’¥åŠ å¯†çš„ä¿¡æ¯ã€‚

4. ServerChangeCipher & Finishedï¼ˆæœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯ï¼‰

   æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯å‘è¿‡æ¥çš„ClientKeyExchangeä¸­çš„å‚æ•°åï¼Œä¹Ÿå°†å•ç‹¬è®¡ç®—å‡ºä¼šè¯å¯†é’¥ã€‚ä¹‹åå’Œå®¢æˆ·ç«¯ä¸€æ ·ï¼ŒæœåŠ¡ç«¯ç”¨ServerChangeCipheré€šçŸ¥å®¢æˆ·ç«¯ä»ç°åœ¨å¼€å§‹å‘é€çš„æ¶ˆæ¯éƒ½æ˜¯åŠ å¯†è¿‡çš„ã€‚

   æœ€åï¼ŒæœåŠ¡ç«¯ç”¨ä¸€ä¸ªFinishedæ¶ˆæ¯è·Ÿåœ¨ServerChangeCipheråé¢ï¼Œæ—¢ç”¨äºæ ‡è¯†è¯¥è½®æ¡æ‰‹ç»“æŸï¼Œä¹Ÿç”¨äºéªŒè¯å¯¹æ–¹è®¡ç®—å‡ºæ¥çš„å…±äº«å¯†é’¥æ˜¯å¦æœ‰æ•ˆã€‚è¿™ä¹Ÿæ˜¯æœåŠ¡ç«¯å‘å‡ºçš„ç¬¬ä¸€æ¡ä½¿ç”¨åå•†å¯†é’¥åŠ å¯†çš„ä¿¡æ¯ã€‚

   ä¸€æ—¦HTTPSå®‰å…¨ä¼ è¾“å±‚çš„è¿æ¥æˆåŠŸå»ºç«‹èµ·æ¥ï¼Œåç»­åŒæ–¹é€šä¿¡çš„å†…å®¹ï¼ˆåº”ç”¨å±‚çš„HTTPåè®®ï¼‰å°±ä¼šåœ¨ä¸€ä¸ªç»è¿‡åŠ å¯†å¤„ç†çš„å®‰å…¨é€šé“ä¸­å¾—ä»¥ä¼ è¾“ã€‚

### 64.3 éå¯¹ç§°åŠ å¯†å’Œå…¬é’¥è¯ä¹¦ ğŸ”–

åœ¨ä¸Šé¢HTTPSå®‰å…¨ä¼ è¾“å±‚è¿æ¥çš„å»ºç«‹è¿‡ç¨‹ä¸­ï¼ŒæœåŠ¡ç«¯çš„å…¬é’¥è¯ä¹¦åœ¨éªŒè¯æœåŠ¡ç«¯èº«ä»½ä»¥åŠè¾…åŠ©å¯¹ç§°åŠ å¯†ç®—æ³•å…±äº«å¯†é’¥çš„åå•†å’Œç”Ÿæˆæ–¹é¢èµ·åˆ°äº†å…³é”®ä½œç”¨ã€‚

å…¬é’¥è¯ä¹¦ï¼ˆpublic-key certificateï¼‰æ˜¯éå¯¹ç§°åŠ å¯†ä½“ç³»çš„é‡è¦å†…å®¹ã€‚æ‰€è°“éå¯¹ç§°åŠ å¯†ä½“ç³»ï¼Œåˆç§°å…¬é’¥åŠ å¯†ä½“ç³»ï¼Œæ˜¯å’Œæˆ‘ä»¬ç†ŸçŸ¥çš„å¯¹ç§°åŠ å¯†ä½“ç³»ç›¸å¯¹çš„ï¼Œä¸¤è€…çš„å¯¹æ¯”è§å›¾51-6ã€‚

ä»å›¾51-6ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼šå¯¹ç§°åŠ å¯†æŒ‡çš„æ˜¯é€šä¿¡åŒæ–¹ä½¿ç”¨ä¸€ä¸ªå…±äº«å¯†é’¥ï¼Œè¯¥å¯†é’¥æ—¢ç”¨äºä¼ è¾“æ•°æ®çš„åŠ å¯†ï¼ˆå‘é€æ–¹ï¼‰ï¼Œä¹Ÿç”¨äºæ•°æ®çš„è§£å¯†ï¼ˆæ¥æ”¶æ–¹ï¼‰ï¼›è€Œéå¯¹ç§°åŠ å¯†åˆ™æŒ‡é€šä¿¡çš„æ¯ä¸€æ–¹éƒ½æœ‰ä¸¤ä¸ªå¯†é’¥ï¼Œä¸€ä¸ªå…¬é’¥ï¼ˆpublic keyï¼‰ï¼Œä¸€ä¸ªç§é’¥ï¼ˆprivate keyï¼‰ã€‚é€šä¿¡çš„å‘é€æ–¹ï¼ˆå¦‚å›¾51-6ä¸­çš„Aï¼‰ä½¿ç”¨å¯¹æ–¹ï¼ˆå¦‚å›¾51-6ä¸­çš„Bï¼‰çš„å…¬é’¥å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œæ•°æ®æ¥æ”¶æ–¹ï¼ˆå¦‚å›¾51-6ä¸­Bï¼‰ä½¿ç”¨è‡ªå·±çš„ç§é’¥å¯¹æ•°æ®è¿›è¡Œè§£å¯†ã€‚

å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†å„æœ‰ä¼˜ç¼ºç‚¹ã€‚

å¯¹ç§°åŠ å¯†æ€§èƒ½å¥½ï¼Œä½†å¯†é’¥çš„ä¿å­˜ã€ç®¡ç†å’Œåˆ†å‘å­˜åœ¨è¾ƒå¤§å®‰å…¨é£é™©ï¼›è€Œéå¯¹ç§°åŠ å¯†å°±æ˜¯ä¸ºäº†è§£å†³å¯¹ç§°åŠ å¯†çš„å¯†é’¥åˆ†å‘å®‰å…¨éšæ‚£è€Œè®¾è®¡çš„ã€‚

åœ¨éå¯¹ç§°åŠ å¯†ä½“ç³»ä¸­ï¼Œä»»ä½•å‚ä¸é€šä¿¡çš„ä¸€æ–¹éƒ½æœ‰ä¸¤æŠŠå¯†é’¥ï¼Œä¸€æŠŠæ˜¯éœ€è¦è‡ªå·±ä¿å­˜å¥½çš„ç§é’¥ï¼Œä¸€æŠŠåˆ™æ˜¯å¯¹å¤–å…¬å¼€çš„ã€ç”¨äºåŠ å¯†çš„å…¬é’¥ã€‚ä»¥å›¾51-6ä¸­çš„Aä¸ºä¾‹ï¼Œä»»ä½•æƒ³ä¸Aé€šä¿¡çš„å¦ä¸€æ–¹éƒ½å¯ä»¥è·å–åˆ°Açš„å…¬é’¥ï¼Œå¹¶å°†é€šè¿‡è¿™æŠŠå…¬é’¥åŠ å¯†çš„æ¶ˆæ¯å‘ç»™Aã€‚Aä½¿ç”¨è‡ªå·±çš„ç§é’¥å¯ä»¥å¯¹æ”¶åˆ°çš„æ¶ˆæ¯è¿›è¡Œè§£å¯†ã€‚ç”±äºå…¬é’¥æ˜¯å…¬å¼€çš„ï¼Œå› æ­¤å…¶åˆ†å‘çš„å®‰å…¨é£é™©æ˜¾ç„¶è¦æ¯”å¯¹ç§°åŠ å¯†ä½å¾ˆå¤šã€‚ä¸è¿‡ï¼Œéå¯¹ç§°åŠ å¯†çš„æ€§èƒ½ç›¸è¾ƒäºå¯¹ç§°åŠ å¯†è¦å·®å¾ˆå¤šï¼Œè¿™ä¹Ÿæ˜¯åœ¨å®é™…åº”ç”¨ï¼ˆæ¯”å¦‚HTTPSçš„ä¼ è¾“å®‰å…¨å±‚ï¼‰ä¸­ä¼šå°†ä¸¤ç§åŠ å¯†æ–¹å¼ç»“åˆä½¿ç”¨çš„åŸå› ã€‚

![](images/image-20250724124658281.png)

éå¯¹ç§°åŠ å¯†ä½“ç³»çš„å…¬é’¥æ˜¯å¯¹å¤–å…¬å¼€çš„ï¼Œè¿™å¤§å¤§é™ä½äº†å¯†é’¥åˆ†å‘çš„å¤æ‚æ€§ã€‚ä½†ç›´æ¥åˆ†å‘å…¬é’¥ä¿¡æ¯ä»ç„¶å¯èƒ½å­˜åœ¨å®‰å…¨éšæ‚£ã€‚æ¯”å¦‚ä¸Šé¢HTTPSåè®®å®‰å…¨ä¼ è¾“å±‚è¿æ¥å»ºç«‹çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚ä½•ä¿è¯HTTPSæœåŠ¡ç«¯å‘é€ç»™å®¢æˆ·ç«¯çš„å…¬é’¥ä¿¡æ¯æ²¡æœ‰è¢«ç¯¡æ”¹å‘¢ï¼Ÿæˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†HTTPSå»ºç«‹è¿æ¥çš„è¿‡ç¨‹å¹¶éç›´æ¥ä¼ è¾“å…¬é’¥ä¿¡æ¯ï¼Œè€Œæ˜¯ä½¿ç”¨æºå¸¦å…¬é’¥ä¿¡æ¯çš„æ•°å­—è¯ä¹¦æ¥ä¿è¯å…¬é’¥ä¿¡æ¯çš„æ­£ç¡®æ€§å’Œå®Œæ•´æ€§ã€‚

==æ•°å­—è¯ä¹¦==ï¼Œè¢«ç§°ä¸ºäº’è”ç½‘ä¸Šçš„â€œèº«ä»½è¯â€ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†ç½‘ç»œä¸Šçš„ä¸€ä¸ªåŸŸååœ°å€æˆ–ä¸€å°æœåŠ¡å™¨ä¸»æœºï¼Œè¿™å°±å¥½æ¯”æˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­ä½¿ç”¨çš„â€œå±…æ°‘èº«ä»½è¯â€ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªå…¬æ°‘ã€‚æœåŠ¡ç«¯å°†åŒ…å«å…¬é’¥ä¿¡æ¯çš„æ•°å­—è¯ä¹¦ä¼ è¾“ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å¦‚ä½•æ ¡éªŒè¿™ä¸ªè¯ä¹¦çš„çœŸä¼ªå‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“å±…æ°‘èº«ä»½è¯æ˜¯ç”±å›½å®¶ç»Ÿä¸€åˆ¶ä½œå’Œé¢å‘çš„ï¼Œä¸ªä½“å…¬æ°‘å‘æˆ·å£æ‰€åœ¨åœ°å…¬å®‰æœºå…³ç”³è¯·åŠç†ã€‚åªæœ‰å›½å®¶é¢å‘çš„èº«ä»½è¯æ‰æ˜¯å…·æœ‰æ³•å¾‹æ•ˆåŠ›çš„ï¼Œåœ¨ä¸­å›½å¢ƒå†…è¿™ä¸ªèº«ä»½è¯éƒ½æ˜¯æœ‰æ•ˆå’Œå¯è¢«æ¥çº³çš„ã€‚å¤§æ‚¦åŸçš„ä¼šå‘˜å¡ä¹Ÿæ˜¯ä¸€ç§èº«ä»½æ ‡è¯†ï¼Œä½†ä½ ä¸èƒ½ç”¨å®ƒå»ä¹°æœºç¥¨ï¼Œå› ä¸ºèˆªç©ºå…¬å¸ä¸è®¤å¤§æ‚¦åŸçš„ä¼šå‘˜å¡ï¼Œåªè®¤å±…æ°‘èº«ä»½è¯ã€‚ç½‘ç«™çš„è¯ä¹¦ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ•°å­—è¯ä¹¦æ˜¯ä»å—ä¿¡çš„æƒå¨è¯ä¹¦æˆæƒæœºæ„ï¼ˆCAï¼‰ä¹°æ¥çš„ï¼Œå½“ç„¶ä¹Ÿæœ‰å…è´¹çš„ã€‚ä¸€èˆ¬æµè§ˆå™¨æˆ–æ“ä½œç³»ç»Ÿåœ¨å‡ºå‚æ—¶å°±å†…ç½®äº†è¯¸å¤šçŸ¥åCAï¼ˆå¦‚Verisignã€GoDaddyã€CNNICç­‰ï¼‰çš„å…¬é’¥æ•°å­—è¯ä¹¦ï¼Œè¿™äº›CAçš„å…¬é’¥è¯ä¹¦å¯ä»¥ç”¨äºéªŒè¯è¿™äº›CAæœºæ„ä¸ºç½‘ç«™é¢å‘çš„å…¬é’¥è¯ä¹¦ã€‚å¯¹äºè¿™äº›å†…ç½®CAå…¬é’¥è¯ä¹¦æ— æ³•è¯†åˆ«çš„è¯ä¹¦ï¼Œæµè§ˆå™¨å°±ä¼šæŠ¥é”™ï¼Œå°±åƒä¸Šé¢Chromeæµè§ˆå™¨é’ˆå¯¹æˆ‘ä»¬çš„é‚£ä¸ªè‡ªç­¾åè¯ä¹¦æŠ¥é”™é‚£æ ·ã€‚

é‚£ä¹ˆCAçš„å…¬é’¥è¯ä¹¦æ˜¯å¦‚ä½•æ ¡éªŒæœåŠ¡ç«¯å…¬é’¥è¯ä¹¦çš„æœ‰æ•ˆæ€§çš„å‘¢ï¼Ÿè¿™å°±æ¶‰åŠæ•°å­—å…¬é’¥è¯ä¹¦åˆ°åº•æ˜¯ä»€ä¹ˆçš„é—®é¢˜äº†ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡æµè§ˆå™¨ä¸­çš„â€œHTTPS/SSLè¯ä¹¦ç®¡ç†â€æ¥æŸ¥çœ‹è¯ä¹¦çš„å†…å®¹ã€‚ä¸€èˆ¬å…¬é’¥è¯ä¹¦éƒ½ä¼šåŒ…å«ç«™ç‚¹çš„åç§°ã€ä¸»æœºåã€å…¬é’¥ã€è¯ä¹¦ç­¾å‘æœºæ„ï¼ˆCAï¼‰åç§°å’Œæ¥è‡ªç­¾å‘æœºæ„çš„ç­¾åç­‰ã€‚æˆ‘ä»¬é‡ç‚¹å…³æ³¨æ¥è‡ªç­¾å‘æœºæ„çš„ç­¾åï¼Œå› ä¸ºå¯¹äºå…¬é’¥è¯ä¹¦çš„æ ¡éªŒæ–¹æ³•å°±æ˜¯ä½¿ç”¨æœ¬åœ°CAå…¬é’¥è¯ä¹¦æ¥éªŒè¯æ¥è‡ªé€šä¿¡å¯¹ç«¯çš„å…¬é’¥è¯ä¹¦ä¸­çš„ç­¾åæ˜¯ä¸æ˜¯è¿™ä¸ªCAç­¾çš„ã€‚

ä¸‹é¢å°±æ¥çœ‹çœ‹å…¬é’¥è¯ä¹¦çš„ç”³è¯·ä¸æ ¡éªŒè¿‡ç¨‹ï¼Œå¦‚å›¾51-7æ‰€ç¤ºã€‚

![](images/image-20250724124801528.png)



ğŸ”–

### 64.4 å¯¹æœåŠ¡ç«¯å…¬é’¥è¯ä¹¦çš„æ ¡éªŒ









### 64.5 å¯¹å®¢æˆ·ç«¯å…¬é’¥è¯ä¹¦çš„æ ¡éªŒ









# è¡¥å……2

## 65 æŒæ¡å­—ç¬¦é›†çš„åŸç†å’Œå­—ç¬¦ç¼–ç æ–¹æ¡ˆé—´çš„è½¬æ¢

Goè¯­è¨€æºç é»˜è®¤ä½¿ç”¨Unicodeå­—ç¬¦é›†ï¼Œå¹¶é‡‡ç”¨UTF-8ç¼–ç æ–¹æ¡ˆï¼ŒGoè¿˜æä¾›äº†runeåŸç”Ÿç±»å‹æ¥è¡¨ç¤ºUnicodeå­—ç¬¦ã€‚

### 65.1 å­—ç¬¦ä¸å­—ç¬¦é›†



![](images/image-20250716134517907.png)





### 65.2 Unicodeå­—ç¬¦é›†çš„è¯ç”Ÿä¸UTF-8ç¼–ç æ–¹æ¡ˆ



![](images/image-20250716134706633.png)





### 65.3 å­—ç¬¦ç¼–ç æ–¹æ¡ˆé—´çš„è½¬æ¢



![](images/image-20250716134850402.png)







![](images/image-20250716135038704.png)



## 66 timeåŒ… ğŸ”–

å¸¸è§çš„æ—¶é—´æ“ä½œæœ‰è·å–å½“å‰æ—¶é—´ã€æ—¶é—´æ¯”è¾ƒã€æ—¶åŒºç›¸å…³çš„æ—¶é—´æ“ä½œã€æ—¶é—´æ ¼å¼åŒ–ã€å®šæ—¶å™¨ï¼ˆä¸€æ¬¡æ€§å®šæ—¶å™¨timerå’Œé‡å¤å®šæ—¶å™¨tickerï¼‰çš„ä½¿ç”¨ç­‰ã€‚

### 66.1 æ—¶é—´çš„åŸºç¡€æ“ä½œ

#### 1 è·å–æ—¶é—´

```go
time.Now()
```

timeåŒ…å°†Timeç±»å‹ç”¨ä½œå¯¹ä¸€ä¸ª**å³æ—¶æ—¶é—´ï¼ˆtime instantï¼‰**çš„æŠ½è±¡ã€‚

```go
type Time struct {
  wall uint64
  ext  int64
  loc *Locationï¿¼
}
```

ç”±ä¸‰ä¸ªå­—æ®µç»„æˆçš„Timeç»“æ„ä½“è¦åŒæ—¶è¡¨ç¤ºä¸¤ç§æ—¶é—´â€”â€”==æŒ‚é’Ÿæ—¶é—´ï¼ˆwall timeï¼‰==å’Œ==å•è°ƒæ—¶é—´ï¼ˆmonotonic timeï¼‰==ï¼Œå¹¶ä¸”ç²¾åº¦çº§åˆ«ä¸ºçº³ç§’ã€‚

é—°ç§’ğŸ”–



time.Timeç»“æ„ä½“å­—æ®µwallçš„æœ€é«˜æ¯”ç‰¹ä½æ˜¯ä¸€ä¸ªåä¸º`hasMonotonic`çš„**æ ‡å¿—æ¯”ç‰¹ä½**ã€‚å½“hasMonotonicè¢«ç½®ä¸º1æ—¶ï¼Œtime.Timeè¡¨ç¤ºçš„å³æ—¶æ—¶é—´ä¸­æ—¢åŒ…å«æŒ‚é’Ÿæ—¶é—´ï¼Œä¹ŸåŒ…å«å•è°ƒæ—¶é—´ã€‚ä¸‹å›¾æ˜¯å½“TimeåŒæ—¶åŒ…å«è¿™ä¸¤ç§æ—¶é—´è¡¨ç¤ºæ—¶ï¼ˆhasMonotonicæ¯”ç‰¹ä½è¢«ç½®ä¸º1ï¼‰çš„åŸç†ç¤ºæ„å›¾ï¼ˆåŸºäºGo 1.14ç‰ˆæœ¬ï¼‰ã€‚

![](images/image-20250715214524353.png)

ğŸ”–

![](images/image-20250715214622244.png)



#### 2 è·å–ç‰¹å®šæ—¶åŒºçš„å½“å‰æ—¶é—´



#### 3 æ—¶é—´çš„æ¯”è¾ƒä¸è¿ç®—



### 66.2 æ—¶é—´çš„æ ¼å¼åŒ–è¾“å‡º

![](images/image-20250715220121597.png)



### 66.3 å®šæ—¶å™¨çš„ä½¿ç”¨

Timerçš„ä¸‰ç§åˆ›å»ºæ–¹å¼ï¼šNewTimerã€AfterFuncå’ŒAfterã€‚

![](images/image-20250715220618832.png)



## 67 å¯¹ç³»ç»Ÿä¿¡å·çš„å¤„ç†

Goå¤šç”¨äºåç«¯åº”ç”¨ç¼–ç¨‹ï¼Œè€Œåç«¯åº”ç”¨å¤šä»¥å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonï¼‰çš„æ–¹å¼è¿è¡Œäºæœºå™¨ä¸Šã€‚å®ˆæŠ¤ç¨‹åºå¯¹å¥å£®æ€§çš„è¦æ±‚ç”šé«˜ï¼Œå³ä¾¿æ˜¯åœ¨é€€å‡ºæ—¶ä¹Ÿè¦æ±‚åšå¥½æ”¶å°¾å’Œæ¸…ç†å·¥ä½œï¼Œç§°ä¹‹ä¸º==ä¼˜é›…é€€å‡º==ã€‚åœ¨Goä¸­ï¼Œé€šè¿‡ç³»ç»Ÿä¿¡å·æ˜¯å®ç°ä¼˜é›…é€€å‡ºçš„ä¸€ç§å¸¸è§æ‰‹æ®µã€‚

### 67.1 ä¸ºä»€ä¹ˆä¸èƒ½å¿½ç•¥å¯¹ç³»ç»Ÿä¿¡å·çš„å¤„ç†

==ç³»ç»Ÿä¿¡å·ï¼ˆsignalï¼‰==æ˜¯ä¸€ç§è½¯ä»¶ä¸­æ–­ï¼Œå®ƒæä¾›äº†ä¸€ç§å¼‚æ­¥çš„äº‹ä»¶å¤„ç†æœºåˆ¶ï¼Œç”¨äºæ“ä½œç³»ç»Ÿå†…æ ¸æˆ–å…¶ä»–åº”ç”¨è¿›ç¨‹é€šçŸ¥æŸä¸€åº”ç”¨è¿›ç¨‹å‘ç”Ÿäº†æŸç§äº‹ä»¶ã€‚

æ¯”å¦‚ï¼šä¸€ä¸ªåœ¨ç»ˆç«¯å‰å°å¯åŠ¨çš„ç¨‹åºï¼Œå½“ç”¨æˆ·æŒ‰ä¸‹ä¸­æ–­é”®ï¼ˆä¸€èˆ¬æ˜¯ctrl+cï¼‰æ—¶ï¼Œè¯¥ç¨‹åºçš„è¿›ç¨‹å°†ä¼šæ”¶åˆ°å†…æ ¸å‘æ¥çš„ä¸­æ–­ä¿¡å·ï¼ˆSIGINTï¼‰ã€‚

```go
func main() {
	var wg sync.WaitGroup
	errChan := make(chan error, 1)
	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		fmt.Fprintf(w, "Hello, Singal!\n")
	})
	wg.Add(1)
	go func() {
		defer wg.Done()
		errChan <- http.ListenAndServe(":8080", nil)
	}()

	select {
	case <-time.After(2 * time.Second):
		fmt.Println("web server start ok")
	case err := <-errChan:
		fmt.Printf("web server start failed: %v\n", err)

	}
	wg.Wait()
	fmt.Println("web server shutdown ok")
}
```

```sh
$ go build -o httpserv signal.go
./httpserv
web server start ok
```



åº”ç”¨ç¨‹åºæ”¶åˆ°ç³»ç»Ÿä¿¡å·åï¼Œä¸€èˆ¬æœ‰ä¸‰ç§å¤„ç†æ–¹å¼ã€‚

1. æ‰§è¡Œç³»ç»Ÿé»˜è®¤å¤„ç†åŠ¨ä½œ

å¯¹äºä¸­æ–­é”®è§¦å‘çš„SIGINTä¿¡å·ï¼Œç³»ç»Ÿçš„é»˜è®¤å¤„ç†åŠ¨ä½œæ˜¯ç»ˆæ­¢è¯¥åº”ç”¨è¿›ç¨‹ï¼Œè¿™æ˜¯ä»¥ä¸Šç¤ºä¾‹é‡‡ç”¨çš„ä¿¡å·å¤„ç†æ–¹å¼ï¼Œä¹Ÿæ˜¯ä»¥ä¸Šç¤ºä¾‹æ²¡æœ‰è¾“å‡ºé€€å‡ºæç¤ºå°±é€€å‡ºäº†çš„åŸå› ã€‚å¯¹äºå¤§å¤šæ•°ç³»ç»Ÿä¿¡å·ï¼Œç³»ç»Ÿé»˜è®¤çš„å¤„ç†åŠ¨ä½œæ˜¯ç»ˆæ­¢è¯¥è¿›ç¨‹ã€‚

2. å¿½ç•¥ä¿¡å·

3. æ•æ‰ä¿¡å·å¹¶æ‰§è¡Œè‡ªå®šä¹‰å¤„ç†åŠ¨ä½œ

å¯ä»¥**é¢„å…ˆæä¾›ä¸€ä¸ªåŒ…å«è‡ªå®šä¹‰å¤„ç†åŠ¨ä½œçš„å‡½æ•°**ï¼Œå¹¶å‘ŠçŸ¥ç³»ç»Ÿåœ¨æ¥æ”¶åˆ°æŸäº›ä¿¡å·æ—¶è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚ç³»ç»Ÿä¸­æœ‰ä¸¤ä¸ªç³»ç»Ÿä¿¡å·æ˜¯ä¸èƒ½è¢«æ•æ‰çš„ï¼šç»ˆæ­¢ç¨‹åºä¿¡å·SIGKILLå’ŒæŒ‚èµ·ç¨‹åºä¿¡å·SIGSTOPã€‚

**æœåŠ¡ç«¯ç¨‹åº**ä¸€èˆ¬éƒ½æ˜¯ä»¥**å®ˆæŠ¤è¿›ç¨‹**çš„å½¢å¼è¿è¡Œåœ¨åå°çš„ï¼Œå¹¶ä¸”ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡ç³»ç»Ÿä¿¡å·é€šçŸ¥è¿™äº›å®ˆæŠ¤ç¨‹åºæ‰§è¡Œé€€å‡ºæ“ä½œçš„ã€‚

åœ¨è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œå¦‚æœé€‰æ‹©ä»¥ç³»ç»Ÿé»˜è®¤å¤„ç†æ–¹å¼å¤„ç†è¿™äº›é€€å‡ºé€šçŸ¥ä¿¡å·ï¼Œé‚£ä¹ˆå®ˆæŠ¤è¿›ç¨‹å°†ä¼šè¢«ç›´æ¥æ€æ­»ï¼Œæ²¡æœ‰ä»»ä½•æœºä¼šæ‰§è¡Œæ¸…ç†å’Œæ”¶å°¾å·¥ä½œï¼Œæ¯”å¦‚ï¼š**ç­‰å¾…å°šæœªå¤„ç†å®Œçš„äº‹åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå°†æœªä¿å­˜çš„æ•°æ®å¼ºåˆ¶è½ç›˜ï¼Œå°†æŸäº›å°šæœªå¤„ç†çš„æ¶ˆæ¯åºåˆ—åŒ–åˆ°ç£ç›˜ï¼ˆç­‰ä¸‹æ¬¡å¯åŠ¨åå¤„ç†ï¼‰**ç­‰ã€‚è¿™å°†å¯¼è‡´æŸäº›å¤„ç†è¿‡ç¨‹è¢«å¼ºåˆ¶ä¸­æ–­è€Œä¸¢å¤±æ¶ˆæ¯ï¼Œç•™ä¸‹æ— æ³•æ¢å¤çš„ç°åœºï¼Œå¯¼è‡´æ¶ˆæ¯è¢«ç ´åï¼Œç”šè‡³ä¼šå½±å“ä¸‹æ¬¡åº”ç”¨çš„å¯åŠ¨è¿è¡Œã€‚

å› æ­¤ï¼Œå¯¹äºè¿è¡Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹çš„ç¨‹åºï¼Œä¸è¦å¿½ç•¥å¯¹ç³»ç»Ÿä¿¡å·çš„å¤„ç†ï¼Œ**è€Œåº”é‡‡ç”¨æ•æ‰é€€å‡ºä¿¡å·çš„æ–¹å¼æ‰§è¡Œè‡ªå®šä¹‰çš„æ”¶å°¾å¤„ç†å‡½æ•°**ã€‚

### 67.2 Goè¯­è¨€å¯¹ç³»ç»Ÿä¿¡å·å¤„ç†çš„æ”¯æŒ

**ä¿¡å·æœºåˆ¶**çš„å†å²ä¹…è¿œï¼Œæ—©åœ¨æœ€åˆçš„Unixç³»ç»Ÿç‰ˆæœ¬ä¸Šå°±èƒ½çœ‹åˆ°å®ƒçš„èº«å½±ã€‚ä¿¡å·æœºåˆ¶ä¹Ÿä¸€ç›´åœ¨æ¼”è¿›ï¼Œä»æœ€åˆçš„**ä¸å¯é ä¿¡å·æœºåˆ¶**åˆ°åæ¥çš„**å¯é ä¿¡å·æœºåˆ¶**ï¼Œç›´åˆ°POSIX.1å°†å…¶æ ‡å‡†åŒ–ï¼Œç³»ç»Ÿä¿¡å·æœºåˆ¶æ‰ç¨³å®šä¸‹æ¥ï¼Œä½†å„ä¸ªå¹³å°å¯¹ä¿¡å·æœºåˆ¶çš„æ”¯æŒä»æœ‰å·®å¼‚ã€‚å¯ä»¥é€šè¿‡`kill -l`å‘½ä»¤æŸ¥çœ‹å„ä¸ªç³»ç»Ÿå¯¹ä¿¡å·çš„æ”¯æŒæƒ…å†µï¼š

```sh
// Ubuntu 18.04ï¿¼
$kill -lï¿¼
1) SIGHUP        2) SIGINT          3) SIGQUIT        4) SIGILL         5) SIGTRAPï¿¼
6) SIGABRT       7) SIGBUS          8) SIGFPE         9) SIGKILL       10) SIGUSR1ï¿¼
11) SIGSEGV      12) SIGUSR2        13) SIGPIPE       14) SIGALRM       15) SIGTERMï¿¼
16) SIGSTKFLT    17) SIGCHLD        18) SIGCONT       19) SIGSTOP       20) SIGTSTPï¿¼
21) SIGTTIN      22) SIGTTOU        23) SIGURG        24) SIGXCPU       25) SIGXFSZï¿¼
26) SIGVTALRM    27) SIGPROF        28) SIGWINCH      29) SIGIO         30) SIGPWRï¿¼
31) SIGSYS       34) SIGRTMIN       35) SIGRTMIN+1    36) SIGRTMIN+2    37) SIGRTMIN+3ï¿¼
38) SIGRTMIN+4   39) SIGRTMIN+5     40) SIGRTMIN+6    41) SIGRTMIN+7    42) SIGRTMIN+8ï¿¼
43) SIGRTMIN+9   44) SIGRTMIN+10    45) SIGRTMIN+11   46) SIGRTMIN+12   47) SIGRTMIN+13ï¿¼
48) SIGRTMIN+14  49) SIGRTMIN+15    50) SIGRTMAX-14   51) SIGRTMAX-13   52) SIGRTMAX-12ï¿¼
53) SIGRTMAX-11  54) SIGRTMAX-10    55) SIGRTMAX-9    56) SIGRTMAX-8    57) SIGRTMAX-7ï¿¼
58) SIGRTMAX-6   59) SIGRTMAX-5     60) SIGRTMAX-4    61) SIGRTMAX-3    62) SIGRTMAX-2ï¿¼
63) SIGRTMAX-1   64) SIGRTMAX   ï¿¼

// macOS 10.14.6ï¿¼
$kill -lï¿¼
HUP INT QUIT ILL TRAP ABRT EMT FPE KILL BUS SEGV SYS PIPE ALRM TERM URG STOP TSTP CONT CHLD TTIN TTOU IO XCPU XFSZ VTALRM PROF WINCH INFO USR1 USR2
```

å…¶ä¸­æ¯ä¸ªä¿¡å·éƒ½åŒ…å«**ä¿¡å·åç§°**ï¼ˆsignal nameï¼Œæ¯”å¦‚ï¼šSIGINTï¼‰å’Œ**ä¿¡å·ç¼–å·**ï¼ˆsignal numberï¼Œæ¯”å¦‚ï¼šSIGINTçš„ç¼–å·æ˜¯2ï¼‰ã€‚

killå‘½ä»¤å¯ä»¥å°†ç‰¹å®šä¿¡å·ï¼ˆé€šè¿‡ä¿¡å·åç§°æˆ–ä¿¡å·ç¼–å·ï¼‰å‘é€ç»™æŸåº”ç”¨è¿›ç¨‹ï¼š

```sh
$kill -s signal_name pid // å¦‚kill -s SIGINT 20023ï¿¼
$kill -signal_number pid // å¦‚kill -2 20023
```

ä¿¡å·æœºåˆ¶ç»è¿‡å¤šå¹´æ¼”è¿›ï¼Œå·²ç»å˜å¾—ååˆ†å¤æ‚å’Œçƒ¦çï¼ˆè€ƒè™‘å¤šç§å¹³å°å¯¹æ ‡å‡†çš„æ”¯æŒç¨‹åº¦ä¸ä¸€ï¼‰ï¼Œæ¯”å¦‚ä¸å¯é ä¿¡å·ã€å¯é ä¿¡å·ã€é˜»å¡ä¿¡å·ã€ä¿¡å·å¤„ç†å‡½æ•°çš„å¯é‡å…¥ç­‰ã€‚å¦‚æœè®©å¼€å‘äººå‘˜è‡ªå·±æ¥å¤„ç†è¿™äº›å¤æ‚æ€§ï¼Œé‚£ä¹ˆåŠ¿å¿…æ˜¯ä¸€ä»½ä¸å°çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚Goè¯­è¨€å°†è¿™äº›å¤æ‚æ€§ç•™ç»™äº†è¿è¡Œæ—¶å±‚ï¼Œä¸ºç”¨æˆ·å±‚æä¾›äº†ä½“éªŒç›¸å½“å‹å¥½æ¥å£â€”â€”`os/signal`åŒ…ã€‚

```go
func Notify(c chan<- os.Signal, sig ...os.Signal)
```

è¯¥å‡½æ•°ç”¨æ¥è®¾ç½®æ•æ‰é‚£äº›åº”ç”¨å…³æ³¨çš„ç³»ç»Ÿä¿¡å·ï¼Œå¹¶åœ¨Goè¿è¡Œæ—¶å±‚ä¸Goç”¨æˆ·å±‚ä¹‹é—´ç”¨ä¸€ä¸ªchannelç›¸è¿ã€‚Goè¿è¡Œæ—¶æ•æ‰åˆ°åº”ç”¨å…³æ³¨çš„ä¿¡å·åï¼Œä¼šå°†ä¿¡å·å†™å…¥channelï¼Œè¿™æ ·ç›‘å¬è¯¥channelçš„ç”¨æˆ·å±‚ä»£ç ä¾¿å¯æ”¶åˆ°è¯¥ä¿¡å·é€šçŸ¥ã€‚ä¸‹å›¾å½¢è±¡åœ°å±•ç¤ºäº†Goè¿è¡Œæ—¶è¿›è¡Œç³»ç»Ÿä¿¡å·å¤„ç†ä»¥åŠä¸ç”¨æˆ·å±‚äº¤äº’çš„åŸç†ã€‚

![](images/image-20250716125131290.png)

Goè¿è¡Œæ—¶ä¸ç”¨æˆ·å±‚æœ‰ä¸¤ä¸ªäº¤äº’ç‚¹ï¼Œä¸€ä¸ªæ˜¯ä¸Šé¢æ‰€è¯´çš„æ‰¿è½½ä¿¡å·äº¤äº’çš„channelï¼Œè€Œå¦ä¸€ä¸ªåˆ™æ˜¯è¿è¡Œæ—¶å±‚å¼•å‘çš„panicã€‚

Goå°†ä¿¡å·åˆ†ä¸ºä¸¤å¤§ç±»ï¼š

1. åŒæ­¥ä¿¡å·

   åŒæ­¥ä¿¡å·æ˜¯æŒ‡é‚£äº›ç”±**ç¨‹åºæ‰§è¡Œé”™è¯¯**å¼•å‘çš„ä¿¡å·ï¼ŒåŒ…æ‹¬SIGBUSï¼ˆæ€»çº¿é”™è¯¯/ç¡¬ä»¶å¼‚å¸¸ï¼‰ã€SIGFPEï¼ˆç®—æœ¯å¼‚å¸¸ï¼‰å’ŒSIGSEGVï¼ˆæ®µé”™è¯¯/æ— æ•ˆå†…å­˜å¼•ç”¨ï¼‰ã€‚ä¸€æ—¦åº”ç”¨è¿›ç¨‹ä¸­çš„Goè¿è¡Œæ—¶æ”¶åˆ°è¿™ä¸‰ä¸ªä¿¡å·ä¸­çš„ä¸€ä¸ªï¼Œæ„å‘³ç€åº”ç”¨æå¤§å¯èƒ½å‡ºç°äº†ä¸¥é‡bugï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œä¸‹å»ï¼Œè¿™æ—¶Goè¿è¡Œæ—¶ä¸ä¼šç®€å•åœ°å°†ä¿¡å·é€šè¿‡channelå‘é€åˆ°ç”¨æˆ·å±‚å¹¶ç­‰å¾…ç”¨æˆ·å±‚çš„å¼‚æ­¥å¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥å°†ä¿¡å·è½¬æ¢æˆä¸€ä¸ªè¿è¡Œæ—¶panicå¹¶æŠ›å‡ºã€‚å¦‚æœç”¨æˆ·å±‚æ²¡æœ‰ä¸“é—¨çš„panicæ¢å¤ä»£ç ï¼Œé‚£ä¹ˆGoåº”ç”¨å°†é»˜è®¤å¼‚å¸¸é€€å‡ºã€‚

2. å¼‚æ­¥ä¿¡å·

   åŒæ­¥ä¿¡å·ä¹‹å¤–çš„ä¿¡å·éƒ½è¢«Goåˆ’å½’ä¸ºå¼‚æ­¥ä¿¡å·ã€‚å¼‚æ­¥ä¿¡å·ä¸æ˜¯ç”±ç¨‹åºæ‰§è¡Œé”™è¯¯å¼•èµ·çš„ï¼Œè€Œæ˜¯ç”±**å…¶ä»–ç¨‹åºæˆ–æ“ä½œç³»ç»Ÿå†…æ ¸**å‘å‡ºçš„ã€‚å¼‚æ­¥ä¿¡å·çš„é»˜è®¤å¤„ç†è¡Œä¸ºå› ä¿¡å·è€Œå¼‚ã€‚

   SIGHUPã€SIGINTå’ŒSIGTERMè¿™ä¸‰ä¸ªä¿¡å·å°†å¯¼è‡´ç¨‹åºç›´æ¥é€€å‡ºï¼›

   SIGQUITã€SIGILLã€SIGTRAPã€SIGABRTã€SIGSTKFLTã€SIGEMTå’ŒSIGSYSåœ¨å¯¼è‡´ç¨‹åºé€€å‡ºçš„åŒæ—¶ï¼Œè¿˜ä¼šå°†ç¨‹åºé€€å‡ºæ—¶çš„æ ˆçŠ¶æ€æ‰“å°å‡ºæ¥ï¼›

   SIGPROFä¿¡å·åˆ™æ˜¯è¢«Goè¿è¡Œæ—¶ç”¨äºå®ç°**è¿è¡Œæ—¶CPUæ€§èƒ½å‰–ææŒ‡æ ‡é‡‡é›†**ã€‚

   å…¶ä»–ä¿¡å·ä¸å¸¸ç”¨ï¼Œå‡é‡‡ç”¨æ“ä½œç³»ç»Ÿçš„é»˜è®¤å¤„ç†åŠ¨ä½œã€‚å¯¹äºç”¨æˆ·å±‚é€šè¿‡Notifyå‡½æ•°æ•è·çš„ä¿¡å·ï¼ŒGoè¿è¡Œæ—¶åˆ™é€šè¿‡channelå°†ä¿¡å·å‘ç»™ç”¨æˆ·å±‚ã€‚

Notifyæ— æ³•æ•æ‰SIGKILLå’ŒSIGSTOPï¼ˆæ“ä½œç³»ç»Ÿæœºåˆ¶å†³å®šçš„ï¼‰ï¼Œä¹Ÿæ— æ³•æ•æ‰åŒæ­¥ä¿¡å·ï¼ˆGoè¿è¡Œæ—¶å†³å®šçš„ï¼‰ï¼Œåªæœ‰æ•æ‰å¼‚æ­¥ä¿¡å·æ‰æ˜¯æœ‰æ„ä¹‰çš„ã€‚ä¸‹é¢çš„ä¾‹å­ç›´è§‚å±•ç¤ºäº†æ— æ³•è¢«æ•è·çš„ä¿¡å·ã€åŒæ­¥ä¿¡å·åŠå¼‚æ­¥ä¿¡å·çš„è¿ä½œæœºåˆ¶ï¼š

```go
package main

import (
	"fmt"
	"os"
	"os/signal"
	"sync"
	"syscall"
	"time"
)

// ç›´è§‚å±•ç¤ºäº†æ— æ³•è¢«æ•è·çš„ä¿¡å·ã€åŒæ­¥ä¿¡å·åŠå¼‚æ­¥ä¿¡å·çš„è¿ä½œæœºåˆ¶

func catchAsyncSignal(c chan os.Signal) {
	for {
		s := <-c
		fmt.Println("æ”¶åˆ°å¼‚æ­¥ä¿¡å·:", s)
	}
}

func triggerSyncSignal() {
	time.Sleep(3 * time.Second)
	defer func() {
		if e := recover(); e != nil {
			fmt.Println("æ¢å¤panic:", e)
			return
		}
	}()
	var a, b = 1, 0
	fmt.Println(a / b)
}

func main() {
	var wg sync.WaitGroup
	c := make(chan os.Signal, 1)
	signal.Notify(c, syscall.SIGFPE, syscall.SIGINT, syscall.SIGKILL)

	wg.Add(2)
	go func() {
		catchAsyncSignal(c)
		wg.Done()
	}()

	go func() {
		triggerSyncSignal()
		wg.Done()
	}()

	wg.Wait()
}
```

ğŸ”–



å¦‚æœå¤šæ¬¡è°ƒç”¨Notifyæ‹¦æˆªæŸä¿¡å·ï¼Œä½†æ¯æ¬¡è°ƒç”¨ä½¿ç”¨çš„channelä¸åŒï¼Œé‚£ä¹ˆå½“åº”ç”¨è¿›ç¨‹æ”¶åˆ°å¼‚æ­¥ä¿¡å·æ—¶ï¼ŒGoè¿è¡Œæ—¶ä¼šç»™æ¯ä¸ªchannelå‘é€ä¸€ä»½å¼‚æ­¥ä¿¡å·å‰¯æœ¬ï¼š

```
```

ğŸ”–



### 67.3 ä½¿ç”¨ç³»ç»Ÿä¿¡å·å®ç°ç¨‹åºçš„ä¼˜é›…é€€å‡º

**==ä¼˜é›…é€€å‡ºï¼ˆgracefully exitï¼‰==**æŒ‡ç¨‹åºåœ¨é€€å‡ºå‰æœ‰æœºä¼šç­‰å¾…å°šæœªå®Œæˆçš„äº‹åŠ¡å¤„ç†ã€æ¸…ç†èµ„æºï¼ˆæ¯”å¦‚å…³é—­æ–‡ä»¶æè¿°ç¬¦ã€å…³é—­socketï¼‰ã€ä¿å­˜å¿…è¦ä¸­é—´çŠ¶æ€ã€æŒä¹…åŒ–å†…å­˜æ•°æ®ï¼ˆæ¯”å¦‚å°†å†…å­˜ä¸­çš„æ•°æ®è½ç›˜åˆ°æ–‡ä»¶ä¸­ï¼‰ç­‰ã€‚

ä¸ä¼˜é›…é€€å‡ºå¯¹ç«‹çš„æ˜¯==å¼ºåˆ¶é€€å‡º==ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„ä½¿ç”¨kill -9ï¼Œå³kill -s SIGKILL pidã€‚

ğŸ”–



## 68 ç†è§£æ ‡å‡†åº“çš„è¯»å†™æ¨¡å‹

Goæ ‡å‡†åº“è¯»å†™æ¨¡å‹

GoåŸºäºio.Writerå’Œio.Readerè¿™ä¸¤ä¸ªç®€å•çš„æ¥å£ç±»å‹æ„å»ºäº†ä¸‹å›¾æ‰€ç¤ºçš„Goæ ‡å‡†åº“è¯»å†™æ¨¡å‹ã€‚

![Goæ ‡å‡†åº“è¯»å†™æ¨¡å‹](images/Goæ ‡å‡†åº“è¯»å†™æ¨¡å‹.jpeg)

### ç›´æ¥è¯»å†™å­—èŠ‚åºåˆ—





### ç›´æ¥è¯»å†™æŠ½è±¡æ•°æ®ç±»å‹å®ä¾‹





### é€šè¿‡åŒ…è£¹ç±»å‹è¯»å†™æ•°æ®



## 69 æŒæ¡unsafeåŒ…çš„å®‰å…¨ä½¿ç”¨æ¨¡å¼

Cè¯­è¨€æ˜¯ä¸€é—¨é™æ€ç±»å‹è¯­è¨€ï¼Œ**ä½†å®ƒå´ä¸æ˜¯ç±»å‹å®‰å…¨çš„è¯­è¨€**ï¼Œå¯ä»¥é€šè¿‡åˆæ³•çš„è¯­æ³•è½»æ˜“â€œåˆºé€â€å…¶==ç±»å‹ç³»ç»Ÿ==ï¼š

```c
int main() {
    int a = 0x12345678;
    unsigned char *p = (unsigned char *)&a;
    printf("0x%x\n", a);
    *p = 0x23;
    *(p + 1) = 0x45;
    *(p+2) = 0x67;
    *(p+3) = 0x8a;
    printf("0x%x\n", a); // 0x8a674523 (æ³¨ï¼šåœ¨å°ç«¯å­—èŠ‚åºç³»ç»Ÿä¸­è¾“å‡ºæ­¤å€¼)ï¿¼
}
```

åŸæœ¬è¢«è§£é‡Šæˆintç±»å‹çš„ä¸€æ®µå†…å­˜æ•°æ®ï¼ˆåœ°å€ä¸º&aï¼‰è¢«é‡æ–°è§£é‡Šæˆäº†unsigned charç±»å‹æ•°ç»„å¹¶å¯è¢«ä»»æ„ä¿®æ”¹ã€‚

ä½†åœ¨Goè¯­è¨€ä¸­ï¼Œæ— æ³•é€šè¿‡**å¸¸è§„è¯­æ³•æ‰‹æ®µ**ç©¿é€Goåœ¨ç±»å‹ç³»ç»Ÿå±‚é¢å¯¹å†…å­˜æ•°æ®çš„ä¿æŠ¤çš„:

```go
func main() {
	a := 0x12345678
	fmt.Printf("%x\n", a)

	var p *byte = (*byte)(&a) // é”™è¯¯ï¼ä¸å…è®¸å°†&aä»*intç±»å‹æ˜¾å¼è½¬å‹ä¸º*byteç±»å‹

	*p = 0x23
	var b byte = byte(a)    // bæ˜¯ä¸€ä¸ªæ–°å˜é‡ï¼Œæœ‰è‡ªå·±æ‰€è§£é‡Šçš„å†…å­˜ç©ºé—´
	b = 0x23                // å³ä¾¿å¼ºåˆ¶è¿›è¡Œç±»å‹è½¬æ¢ï¼ŒåŸå˜é‡aæ‰€è§£é‡Šçš„å†…å­˜ç©ºé—´çš„æ•°æ®ä¾ç„¶ä¸å˜
	fmt.Printf("0x%x\n", b) // 0x23
	fmt.Printf("0x%x\n", a) // 0x12345678ï¿¼
}
```

ä¸Cè¯­è¨€ç›¸æ¯”ï¼Œ**Goåœ¨å¸¸è§„æ“ä½œä¸‹æ˜¯ç±»å‹å®‰å…¨çš„**ï¼ˆæ³¨ï¼šå¹¶éç»å¯¹çš„ç±»å‹å®‰å…¨ï¼Œç»å¯¹çš„ç±»å‹å®‰å…¨éœ€è¦åœ¨æ•°å­¦ä¸Šçš„å½¢å¼åŒ–è¯æ˜ï¼‰ã€‚

æ‰€è°“==ç±»å‹å®‰å…¨==æ˜¯æŒ‡ä¸€å—å†…å­˜æ•°æ®ä¸€æ—¦è¢«ç‰¹å®šçš„ç±»å‹æ‰€è§£é‡Šï¼ˆè¯¥å†…å­˜æ•°æ®ä¸è¯¥ç±»å‹å˜é‡å»ºç«‹å…³è”ï¼Œä¹Ÿå°±æ˜¯å˜é‡å®šä¹‰ï¼‰ï¼Œå®ƒå°±ä¸èƒ½å†è¢«è§£é‡Šä¸ºå…¶ä»–ç±»å‹ï¼Œä¸èƒ½å†ä¸å…¶ä»–ç±»å‹å˜é‡å»ºç«‹å…³è”ã€‚å°±åƒä¸Šé¢ç¤ºä¾‹ä¸­çš„å˜é‡aï¼Œä¸€æ—¦è¢«è§£é‡Šä¸ºintç±»å‹ï¼ˆa := 0x12345678ï¼‰ï¼Œå®ƒå°±ä¸æŸå—å†…å­˜ï¼ˆèµ·å§‹åœ°å€ä¸º&aï¼Œé•¿åº¦ä¸ºintç±»å‹çš„å¤§å°ï¼‰å»ºç«‹äº†å…³è”ï¼Œé‚£ä¹ˆè¿™å—å†…å­˜ï¼ˆ&aï¼‰å°±ä¸èƒ½å†ä¸å…¶ä»–ç±»å‹ï¼ˆå¦‚byteï¼‰å˜é‡å»ºç«‹å…³è”ã€‚

Goè¯­è¨€çš„ç±»å‹å®‰å…¨æ˜¯å»ºç«‹åœ¨**Goç¼–è¯‘å™¨çš„é™æ€æ£€æŸ¥ä»¥åŠGoè¿è¡Œæ—¶åˆ©ç”¨ç±»å‹ä¿¡æ¯è¿›è¡Œçš„è¿è¡Œæ—¶æ£€æŸ¥**ä¹‹ä¸Šçš„ã€‚åœ¨è¯­æ³•å±‚é¢ï¼Œä¸ºäº†å®ç°å¸¸è§„æ“ä½œä¸‹çš„ç±»å‹å®‰å…¨ï¼ŒGoå¯¹è¯­æ³•åšäº†è¯¸å¤šé™åˆ¶ã€‚

1. æ”¯æŒéšå¼ç±»å‹è½¬æ¢ï¼Œæ‰€æœ‰ç±»å‹è½¬æ¢å¿…é¡»æ˜¾å¼è¿›è¡Œ

```go
var i int = 17ï¿¼
var j uint64 = i             // é”™è¯¯ï¼šintç±»å‹å€¼ä¸èƒ½ç›´æ¥èµ‹å€¼ç»™uint64ç±»å‹å˜é‡ï¿¼
var j uint64 = uint64(i)         // æ²¡é—®é¢˜
```

åªæœ‰**åº•å±‚ç±»å‹ï¼ˆunderlying typeï¼‰**ç›¸åŒçš„ä¸¤ä¸ªç±»å‹çš„æŒ‡é’ˆä¹‹é—´æ‰èƒ½è¿›è¡Œç±»å‹è½¬æ¢ã€‚

```go
var i int = 11ï¿¼
var p *uint64 = (*uint64)(&i)     // é”™è¯¯ï¼š*intç±»å‹ä¸èƒ½è½¬æ¢ä¸º*uint64ç±»å‹ï¿¼
type MyInt intï¿¼
var p *MyInt = (*MyInt)(&i)    // æ²¡é—®é¢˜ï¼ŒMyIntçš„åº•å±‚ç±»å‹ä¸ºint
```

2. ä¸æ”¯æŒæŒ‡é’ˆè¿ç®—

```go
var a [100]intï¿¼
var p *int = &a[0]ï¿¼
*(p+1) = 10             // é”™è¯¯ï¼š*intç±»å‹ä¸intç±»å‹æ— æ³•ç›¸åŠ ï¼Œå³ä¸èƒ½è·¨è¶Šæ•°ç»„å…ƒç´ çš„è¾¹ç•Œ
```

ä¸è¿‡ï¼ŒGoæœ€åˆçš„å®šä½æ˜¯**ç³»ç»Ÿç¼–ç¨‹è¯­è¨€**ï¼Œåœ¨è€ƒè™‘ç±»å‹å®‰å…¨çš„åŒæ—¶ï¼Œè¯­è¨€çš„è®¾è®¡è€…ä»¬è¿˜è¦å…¼é¡¾æ€§èƒ½ä»¥åŠå¦‚ä½•å®ç°ä¸æ“ä½œç³»ç»Ÿã€Cä»£ç ç­‰äº’æ“ä½œçš„ä½çº§ä»£ç ç­‰é—®é¢˜ã€‚æœ€ç»ˆï¼ŒGoè¯­è¨€çš„è®¾è®¡è€…ä»¬é€‰æ‹©äº†åœ¨ç±»å‹ç³»ç»Ÿä¸Šå¼€ä¸€é“â€œåé—¨â€çš„æ–¹æ¡ˆï¼Œå³åœ¨æ ‡å‡†åº“ä¸­å†…ç½®ä¸€ä¸ªç‰¹æ®Šçš„GoåŒ…â€”â€”`unsafeåŒ…`ã€‚

â€œåé—¨â€æ„å‘³ç€**æ”¶ç›Šä¸é£é™©å¹¶å­˜**ã€‚ä½¿ç”¨unsafeåŒ…å¯ä»¥å®ç°**æ€§èƒ½æ›´é«˜ã€ä¸åº•å±‚ç³»ç»Ÿäº¤äº’æ›´å®¹æ˜“çš„ä½çº§ä»£ç **ï¼Œä½†unsafeåŒ…çš„å­˜åœ¨ä¹Ÿè®©æˆ‘ä»¬æœ‰äº†ç»•è¿‡Goç±»å‹å®‰å…¨å±éšœçš„â€œè·¯å¾„â€ã€‚ä¸€æ—¦ä½¿ç”¨è¯¥åŒ…ä¸å½“ï¼Œä¾¿å¯èƒ½ä¼šå¯¼è‡´å¼•å…¥å®‰å…¨æ¼æ´ã€å¼•å‘ç¨‹åºå´©æºƒï¼ˆpanicï¼‰ç­‰é—®é¢˜ï¼Œå¹¶ä¸”éš¾äºå‘ç°å’Œè°ƒè¯•ã€‚

ä¸ºæ­¤ï¼ŒGoè®¾è®¡è€…ä»¬æ˜ç¡®äº†unsafeåŒ…çš„å®‰å…¨ä½¿ç”¨æ¨¡å¼ã€‚åœ¨æœ¬æ¡ä¸­ï¼Œæˆ‘ä»¬å°±æ¥ä¸€èµ·äº†è§£ä¸€ä¸‹ä½¿ç”¨unsafeåŒ…ç¼–å†™å‡ºå®‰å…¨ä»£ç çš„æ¨¡å¼ã€‚

### 69.1 ç®€æ´çš„unsafeåŒ…

```go
// $GOROOT/src/unsafe/unsafe.go
package unsafe
func Alignof(x ArbitraryType) uintptr
func Offsetof(x ArbitraryType) uintptr
func Sizeof(x ArbitraryType) uintptr
type ArbitraryType int
type Pointer *ArbitraryTyp
```

è™½ç„¶ä½äºunsafeåŒ…ä¸­ï¼Œä½†Alignofã€Offsetofå’ŒSizeofè¿™ä¸‰ä¸ªå‡½æ•°çš„ä½¿ç”¨æ˜¯ç»å¯¹å®‰å…¨çš„ã€‚

- `Sizeof`ç”¨äºè·å–ä¸€ä¸ªè¡¨è¾¾å¼å€¼çš„å¤§å°

```go
func main() {
	type Foo struct {
		a int
		b string
		c [10]byte
		d float64
	}
	var i int = 5
	var a = [100]int{}
	var sl = a[:]
	var f Foo

	fmt.Println(unsafe.Sizeof(i))           // 8ï¿¼
	fmt.Println(unsafe.Sizeof(a))           // 800
	fmt.Println(unsafe.Sizeof(sl))          // 24 (æ³¨ï¼šè¿”å›çš„æ˜¯åˆ‡ç‰‡æè¿°ç¬¦çš„å¤§å°)
	fmt.Println(unsafe.Sizeof(f))           // 48
	fmt.Println(unsafe.Sizeof(f.c))         // 10
	fmt.Println(unsafe.Sizeof((*int)(nil))) // 8
	fmt.Println(unsafe.Sizeof(f.b))			// 16
}
```

Sizeofå‡½æ•°ä¸æ”¯æŒç›´æ¥ä¼ å…¥æ— ç±»å‹ä¿¡æ¯çš„nilå€¼ï¼Œæˆ‘ä»¬å¿…é¡»æ˜¾å¼å‘ŠçŸ¥Sizeofä¼ å…¥çš„nilç©¶ç«Ÿæ˜¯ä»€ä¹ˆç±»å‹ï¼Œè¦ä¹ˆåƒä¸Šé¢ä»£ç é‚£æ ·è¿›è¡Œæ˜¾å¼è½¬å‹ï¼Œè¦ä¹ˆä¼ å…¥ä¸€ä¸ªå€¼ä¸ºnilä½†ç±»å‹æ˜ç¡®çš„å˜é‡ï¼Œæ¯”å¦‚`var p *int = nil`ã€‚

- Alignofç”¨äºè·å–ä¸€ä¸ªè¡¨è¾¾å¼çš„å†…å­˜åœ°å€å¯¹é½ç³»æ•°ã€‚

**==å¯¹é½ç³»æ•°ï¼ˆalignment factorï¼‰==**æ˜¯ä¸€ä¸ªè®¡ç®—æœºä½“ç³»æ¶æ„ï¼ˆcomputer architectureï¼‰å±‚é¢çš„æœ¯è¯­ã€‚åœ¨ä¸åŒçš„è®¡ç®—æœºä½“ç³»ç»“æ„ä¸‹ï¼Œå¤„ç†å™¨å¯¹å˜é‡åœ°å€éƒ½æœ‰ç€å¯¹é½è¦æ±‚ï¼Œå³==å˜é‡çš„åœ°å€å¿…é¡»å¯è¢«è¯¥å˜é‡çš„å¯¹é½ç³»æ•°æ•´é™¤==ã€‚å¯ä»¥ç”¨Goä»£ç è¡¨è¿°è¿™ä¸€è¦æ±‚ï¼š

```go
var x unsafe.ArbitraryType // unsafe.ArbitraryTypeè¡¨ç¤ºä»»æ„ç±»å‹ï¿¼
b := uintptr(unsafe.Pointer(&x)) % unsafe.Alignof(x) == 0
fmt.Println(b) // true
```



```go
	fmt.Println(unsafe.Alignof(i))          // 8ï¿¼
	fmt.Println(unsafe.Alignof(a))          // 8
	fmt.Println(unsafe.Alignof(sl))         // 8
	fmt.Println(unsafe.Alignof(f))          // 8
	fmt.Println(unsafe.Alignof(f.c))        // 1
	fmt.Println(unsafe.Alignof(struct{}{})) // 1  (æ³¨ï¼šç©ºç»“æ„ä½“çš„å¯¹é½ç³»æ•°ä¸º1)ï¿¼
	fmt.Println(unsafe.Alignof([0]int{}))   // 8 (æ³¨ï¼šé•¿åº¦ä¸º0çš„æ•°ç»„ï¼Œå…¶å¯¹é½ç³»æ•°ä¾ç„¶ä¸å…¶å…ƒç´ ç±»å‹çš„å¯¹é½ç³»æ•°ç›¸åŒ)
```



- Offsetofç”¨äºè·å–ç»“æ„ä½“ä¸­æŸå­—æ®µçš„åœ°å€åç§»é‡ï¼ˆç›¸å¯¹äºç»“æ„ä½“å˜é‡çš„åœ°å€ï¼‰

```go
	fmt.Println(unsafe.Offsetof(f.a)) // 0
	fmt.Println(unsafe.Offsetof(f.b)) // 8
	fmt.Println(unsafe.Offsetof(f.c)) // 24
	fmt.Println(unsafe.Offsetof(f.d)) // 40
```



unsafeåŒ…ä¹‹æ‰€ä»¥è¢«å‘½åä¸ºunsafeï¼Œä¸»è¦æ˜¯å› ä¸ºè¯¥åŒ…ä¸­å®šä¹‰äº†`unsafe.Pointer`ç±»å‹ã€‚unsafe.Pointer**å¯ç”¨äºè¡¨ç¤ºä»»æ„ç±»å‹çš„æŒ‡é’ˆ**ï¼Œå¹¶ä¸”å®ƒå…·å¤‡ä¸‹é¢å››æ¡å…¶ä»–æŒ‡é’ˆç±»å‹æ‰€ä¸å…·å¤‡çš„æ€§è´¨ï¼š

1. ä»»æ„ç±»å‹çš„æŒ‡é’ˆå€¼éƒ½å¯ä»¥è¢«è½¬æ¢ä¸ºunsafe.Pointerã€‚

```go
var a int = 5
var b float64 = 5.89
var arr [10]string
var f Foo

p1 := (unsafe.Pointer)(&a)     // *int -> unsafe.Pointer
p2 := (unsafe.Pointer)(&b)     // *float64 -> unsafe.Pointer
p3 := (unsafe.Pointer)(&arr)     // *[10]string -> unsafe.Pointer
p4 := (unsafe.Pointer)(&f)     // *Foo -> unsafe.Pointer
```

2. unsafe.Pointerä¹Ÿå¯ä»¥è¢«è½¬æ¢ä¸ºä»»æ„ç±»å‹çš„æŒ‡é’ˆå€¼ã€‚

```go
var pa = (*int)(p1)         // unsafe.Pointer -> *int
var pb = (*float64)(p2)         // unsafe.Pointer -> *float64
var parr = (*[10]string)(p3) // unsafe.Pointer -> *[10]string
var pf = (*Foo)(p4) // unsafe.Pointer -> *Foo
```

3. uintptrç±»å‹å€¼å¯ä»¥è¢«è½¬æ¢ä¸ºä¸€ä¸ªunsafe.Pointerã€‚

```go
var i uintptr = 0x80010203
p := unsafe.Pointer(i)
```

4. unsafe.Pointerä¹Ÿå¯ä»¥è¢«è½¬æ¢ä¸ºä¸€ä¸ªuintptrç±»å‹å€¼ã€‚

```go
p := unsafe.Pointer(&a)ï¿¼
var i = uintptr(p)
```

ç»¼åˆunsafe.Pointerçš„å››ä¸ªæ€§è´¨ï¼Œæˆ‘ä»¬å‘ç°é€šè¿‡unsafe.Pointerï¼Œå¯ä»¥å¾ˆå®¹æ˜“ç©¿é€Goçš„ç±»å‹å®‰å…¨ä¿æŠ¤ï¼š

```go
// go_is_not_type_safe.go
func main() {
	var a uint32 = 0x12345678
	fmt.Printf("0x%x\n", a)

	p := (unsafe.Pointer)(&a) // åˆ©ç”¨unsafe.Pointerçš„æ€§è´¨1

	b := (*[4]byte)(p) // åˆ©ç”¨unsafe.Pointerçš„æ€§è´¨2
	b[0] = 0x23
	b[1] = 0x45
	b[2] = 0x67
	b[3] = 0x8a

	fmt.Printf("0x%x\n", a)  // 0x8a674523 (æ³¨ï¼šåœ¨å°ç«¯å­—èŠ‚åºç³»ç»Ÿä¸­è¾“å‡ºæ­¤å€¼)
}
```

åŸæœ¬è¢«è§£é‡Šä¸ºuint32ç±»å‹çš„ä¸€æ®µå†…å­˜ï¼ˆèµ·å§‹åœ°å€ä¸º&aï¼Œé•¿åº¦ä¸º4å­—èŠ‚ï¼‰ï¼Œé€šè¿‡unsafe.Pointerè¢«é‡æ–°è§£é‡Šæˆäº†[4]byteå¹¶ä¸”é€šè¿‡å˜é‡bï¼ˆ*[4]byteç±»å‹ï¼‰å¯ä»¥å¯¹è¯¥æ®µå†…å­˜è¿›è¡Œä¿®æ”¹ã€‚

### 69.2ã€€unsafeåŒ…çš„å…¸å‹åº”ç”¨

Goè¯­è¨€éœ€è¦unsafeåŒ…è¿™æ ·ä¸€ç§æœºåˆ¶æ¥å®ç°ä¸€äº›**ä½çº§ä»£ç **ï¼Œä»¥æ»¡è¶³è¿è¡Œæ—¶æˆ–æ€§èƒ½æ•æ„Ÿç³»ç»Ÿå¯¹**æ€§èƒ½**çš„éœ€æ±‚ã€‚

#### 1 reflectåŒ…ä¸­unsafeåŒ…çš„å…¸å‹åº”ç”¨

ValueOfå’ŒTypeOfå‡½æ•°æ˜¯reflectåŒ…ä¸­ç”¨å¾—æœ€å¤šçš„ä¸¤ä¸ªAPIï¼Œå®ƒä»¬æ˜¯è¿›å…¥è¿è¡Œæ—¶åå°„å±‚ã€è·å–åå°„å±‚ä¿¡æ¯çš„å…¥å£ã€‚è¿™ä¸¤ä¸ªå‡½æ•°å‡å°†ä»»æ„ç±»å‹å˜é‡è½¬æ¢ä¸ºä¸€ä¸ªinterface{}ç±»å‹å˜é‡ï¼Œå†åˆ©ç”¨unsafe.Pointerå°†è¿™ä¸ªå˜é‡ç»‘å®šçš„å†…å­˜åŒºåŸŸé‡æ–°è§£é‡Šä¸ºreflect.emptyInterfaceç±»å‹ï¼Œä»¥è·å¾—ä¼ å…¥å˜é‡çš„ç±»å‹å’Œå€¼çš„ä¿¡æ¯ã€‚

```go
// $GOROOT/src/reflect/value.go

// emptyInterfaceç”¨äºè¡¨ç¤ºä¸€ä¸ªinterface{}ç±»å‹çš„å€¼çš„å¤´éƒ¨
type emptyInterface struct {
  typ  *rtypeï¿¼
  word unsafe.Pointer
}

func ValueOf(i interface{}) Value {
  ...
  return unpackEface(i)
}

// unpackEfaceå°†empty interfaceå˜é‡iè½¬æ¢æˆä¸€ä¸ªreflect.Value
func unpackEface(i interface{}) Value {
  e := (*emptyInterface)(unsafe.Pointer(&i))
  ...
  return Value{t, e.word, f}
}

// $GOROOT/src/reflect/type.go

// TypeOfè¿”å›interface{}ç±»å‹å˜é‡içš„åŠ¨æ€ç±»å‹ä¿¡æ¯
func TypeOf(i interface{}) Type {
  eface := *(*emptyInterface)(unsafe.Pointer(&i))
  return toType(eface.typ)
}
```

#### 2 syncåŒ…ä¸­unsafeåŒ…çš„å…¸å‹åº”ç”¨

sync.Poolæ˜¯ä¸€ä¸ªå¹¶å‘å®‰å…¨çš„é«˜æ€§èƒ½ä¸´æ—¶å¯¹è±¡ç¼“å†²æ± ã€‚sync.Poolä¸ºæ¯ä¸ªPåˆ†é…äº†ä¸€ä¸ªæœ¬åœ°ç¼“å†²æ± ï¼Œå¹¶é€šè¿‡ä¸‹é¢å‡½æ•°å®ç°å¿«é€Ÿå®šä½Pçš„æœ¬åœ°ç¼“å†²æ± ï¼š

```go
// $GOROOT/src/sync/pool.go
func indexLocal(l unsafe.Pointer, i int) *poolLocal {
  lp := unsafe.Pointer(uintptr(l) + uintptr(i)*unsafe.Sizeof(poolLocal{}))
  return (*poolLocal)(lp)
}
```

indexLocalå‡½æ•°çš„æœ¬åœ°ç¼“å†²æ± å¿«é€Ÿå®šä½æ˜¯é€šè¿‡ç»“åˆunsafe.Pointerä¸uintptrçš„æŒ‡é’ˆè¿ç®—å®ç°çš„ã€‚

#### 3 syscallåŒ…ä¸­unsafeåŒ…çš„å…¸å‹åº”ç”¨

syscallåŒ…å°è£…äº†ä¸æ“ä½œç³»ç»Ÿäº¤äº’çš„ç³»ç»Ÿè°ƒç”¨æ¥å£ï¼Œæ¯”å¦‚Statã€Listenã€Selectç­‰ï¼š



#### 4 runtimeåŒ…ä¸­unsafeåŒ…çš„å…¸å‹åº”ç”¨

runtimeåŒ…å®ç°çš„goroutineè°ƒåº¦å’Œå†…å­˜ç®¡ç†ï¼ˆåŒ…æ‹¬GCï¼‰éƒ½æœ‰unsafeåŒ…çš„èº«å½±ã€‚



#### ä½¿ç”¨åœºæ™¯

åœ¨å…¶ä»–Goå¼€æºé¡¹ç›®ä¸­ï¼ŒGopherå¯¹unsafeåŒ…ä¹Ÿæ˜¯é’çæœ‰åŠ ã€‚æœ‰ä¸“é—¨çš„ç ”ç©¶è¡¨æ˜ï¼Œåœ¨ç”¨Goè¯­è¨€å¼€å‘çš„å¼€æºé¡¹ç›®ä¸­ï¼Œæœ‰20%ä»¥ä¸Šçš„é¡¹ç›®åœ¨æºç ä¸­ç›´æ¥ä½¿ç”¨äº†unsafeåŒ…ï¼ˆä¸åŒ…æ‹¬vendorç›®å½•ï¼‰ï¼Œå¹¶ä¸”éšç€è¿™äº›é¡¹ç›®çš„æ¼”è¿›ï¼Œé¡¹ç›®ä¸­unsafeåŒ…ä½¿ç”¨çš„é¢‘åº¦æœ‰é€æ¸æé«˜çš„è¶‹åŠ¿ã€‚**Go bindingé¡¹ç›®**ï¼ˆä¸ä¸æ˜¯ç”¨Goå®ç°çš„é¡¹ç›®è¿›è¡Œé›†æˆï¼Œå¦‚gocvã€gotk3ç­‰ï¼‰ã€ç½‘ç»œé¢†åŸŸé¡¹ç›®å’Œæ•°æ®åº“é¢†åŸŸé¡¹ç›®æ˜¯unsafeçš„é‡åº¦â€œç”¨æˆ·â€ã€‚`unsafe.Pointer`åˆ™æ˜¯unsafeåŒ…ä¸­è¢«ä½¿ç”¨æœ€å¤šçš„ç‰¹æ€§ï¼Œå æ®9æˆä»¥ä¸Šä»½é¢ï¼Œè€Œå…¶ä»–ä¸‰ä¸ªå‡½æ•°åˆ™ä½¿ç”¨è¾ƒå°‘ã€‚unsafeåŒ…åœ¨è¿™äº›é¡¹ç›®ä¸­ä¸»è¦è¢«ç”¨äºå¦‚ä¸‹ä¸¤ä¸ªåœºæ™¯ã€‚

##### 1 æ“ä½œç³»ç»Ÿä»¥åŠéGoç¼–å†™çš„ä»£ç çš„é€šä¿¡

Goç¼–å†™çš„ä»£ç çš„é€šä¿¡åˆ™ä¸»è¦é€šè¿‡cgoæ–¹å¼ã€‚

##### 2 é«˜æ•ˆç±»å‹è½¬æ¢

ä½¿ç”¨unsafeåŒ…ï¼ŒGopherå¯ä»¥ç»•å¼€Goç±»å‹ç³»ç»Ÿçš„å®‰å…¨æ£€æŸ¥ï¼Œå› æ­¤å¯ä»¥é€šè¿‡unsafeåŒ…å®ç°æ€§èƒ½æ›´å¥½çš„ç±»å‹è½¬æ¢ã€‚æœ€å¸¸è§çš„ç±»å‹è½¬æ¢æ˜¯**stringä¸[]byteç±»å‹é—´çš„ç›¸äº’è½¬æ¢**ï¼š

```go
func Bytes2String(b []byte) string {
  return *(*string)(unsafe.Pointer(&b))
}

func String2Bytes(s string) []byte {
  sh := (*reflect.StringHeader)(unsafe.Pointer(&s))
  bh := reflect.SliceHeader{
    Data: sh.Data,
    Len:  sh.Len,
    Cap:  sh.Len,
  }ï¿¼
  return *(*[]byte)(unsafe.Pointer(&bh))
}
```

åœ¨Goä¸­ï¼Œstringç±»å‹å˜é‡æ˜¯**ä¸å¯å˜çš„ï¼ˆimmutableï¼‰**ï¼Œé€šè¿‡å¸¸è§„æ–¹æ³•å°†ä¸€ä¸ªstringç±»å‹å˜é‡è½¬æ¢ä¸º[]byteç±»å‹ï¼ŒGoä¼šä¸º[]byteç±»å‹å˜é‡åˆ†é…ä¸€å—æ–°å†…å­˜ï¼Œå¹¶å°†stringç±»å‹å˜é‡çš„å€¼å¤åˆ¶åˆ°è¿™å—æ–°å†…å­˜ä¸­ã€‚

è€Œé€šè¿‡ä¸Šé¢åŸºäºunsafeåŒ…å®ç°çš„String2Byteså‡½æ•°ï¼Œè¿™ç§è½¬æ¢å¹¶**ä¸éœ€è¦é¢å¤–çš„å†…å­˜å¤åˆ¶**ï¼šè½¬æ¢åçš„[]byteå˜é‡ä¸è¾“å…¥å‚æ•°ä¸­çš„stringç±»å‹å˜é‡å…±äº«åº•å±‚å­˜å‚¨ï¼ˆä½†æ³¨æ„ï¼Œæˆ‘ä»¬ä¾æ—§æ— æ³•é€šè¿‡å¯¹è¿”å›çš„åˆ‡ç‰‡çš„ä¿®æ”¹æ¥æ”¹å˜åŸå­—ç¬¦ä¸²ï¼‰ã€‚è€Œå°†[]byteå˜é‡è½¬æ¢ä¸ºstringç±»å‹åˆ™æ›´ä¸ºç®€å•ï¼Œå› ä¸º[]byteçš„å†…éƒ¨è¡¨ç¤ºæ˜¯ä¸€ä¸ªä¸‰å…ƒç»„(ptr, len, cap)ï¼Œstringçš„å†…éƒ¨è¡¨ç¤ºä¸ºä¸€ä¸ªäºŒå…ƒç»„(ptr, len)ï¼Œé€šè¿‡unsafe.Pointerå°†[]byteçš„å†…éƒ¨è¡¨ç¤ºé‡æ–°è§£é‡Šä¸ºstringçš„å†…éƒ¨è¡¨ç¤ºï¼Œè¿™å°±æ˜¯Bytes2Stringçš„åŸç†ã€‚

æ­¤å¤–unsafeåœ¨**è‡ªå®šä¹‰é«˜æ€§èƒ½åºåˆ—åŒ–å‡½æ•°ï¼ˆmarshalï¼‰ã€åŸå­æ“ä½œï¼ˆatomicï¼‰åŠå†…å­˜æ“ä½œï¼ˆæŒ‡é’ˆè¿ç®—ï¼‰**ä¸Šéƒ½æœ‰ä¸€å®šç¨‹åº¦çš„åº”ç”¨ã€‚

### 69.3 æ­£ç¡®ç†è§£unsafe.Pointerä¸uintptr ğŸ”–

unsafeåŒ…åœ¨å¸¦æ¥å¼ºå¤§çš„ä½çº§ç¼–ç¨‹èƒ½åŠ›çš„åŒæ—¶ï¼Œä¹Ÿæå®¹æ˜“å¯¼è‡´ä»£ç å‡ºç°é”™è¯¯ã€‚è€Œå‡ºç°è¿™äº›é”™è¯¯çš„ä¸»è¦åŸå› å¯å½’ç»“ä¸ºå¯¹**unsafe.Pointerå’Œuintptrçš„ç†è§£ä¸åˆ°ä½**ã€‚

Goè¯­è¨€å†…å­˜ç®¡ç†æ˜¯åŸºäºåƒåœ¾å›æ”¶çš„ï¼Œåƒåœ¾å›æ”¶ä¾‹ç¨‹ä¼šå®šæœŸæ‰§è¡Œã€‚å¦‚æœä¸€å—å†…å­˜æ²¡æœ‰è¢«ä»»ä½•å¯¹è±¡å¼•ç”¨ï¼Œå®ƒå°±ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚è€Œå¯¹è±¡å¼•ç”¨æ˜¯é€šè¿‡æŒ‡é’ˆå®ç°çš„ã€‚

unsafe.Pointerå’Œå…¶ä»–å¸¸è§„ç±»å‹æŒ‡é’ˆä¸€æ ·ï¼Œå¯ä»¥ä½œä¸ºå¯¹è±¡å¼•ç”¨ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡ä»ç„¶è¢«æŸä¸ªunsafe.Pointerå˜é‡å¼•ç”¨ç€ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡æ˜¯ä¸ä¼šè¢«åƒåœ¾å›æ”¶çš„ã€‚ä½†æ˜¯uintptrå¹¶ä¸æ˜¯æŒ‡é’ˆï¼Œå®ƒä»…ä»…æ˜¯ä¸€ä¸ªæ•´å‹å€¼ï¼Œå³ä¾¿å®ƒå­˜å‚¨çš„æ˜¯æŸä¸ªå¯¹è±¡çš„å†…å­˜åœ°å€ï¼Œå®ƒä¹Ÿä¸ä¼šè¢«ç®—ä½œå¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨ã€‚<u>å¦‚æœè®¤ä¸ºå°†å¯¹è±¡åœ°å€å­˜å‚¨åœ¨ä¸€ä¸ªuintptrå˜é‡ä¸­ï¼Œè¯¥å¯¹è±¡å°±ä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ï¼Œé‚£å°±æ˜¯å¯¹uintptrçš„æœ€å¤§è¯¯è§£</u>ã€‚



### 69.4ã€€unsafe.Pointerçš„å®‰å…¨ä½¿ç”¨æ¨¡å¼ ğŸ”–ğŸ”–

æ¨¡å¼1ï¼š`*T1 -> unsafe.Pointer -> *T2`



æ¨¡å¼2ï¼šunsafe.Poiner -> uintptr



æ¨¡å¼3ï¼šæ¨¡æ‹ŸæŒ‡é’ˆè¿ç®—



æ¨¡å¼4ï¼šè°ƒç”¨syscall.Syscallç³»åˆ—å‡½æ•°æ—¶æŒ‡é’ˆç±»å‹åˆ°uintptrç±»å‹å‚æ•°çš„è½¬æ¢



æ¨¡å¼5ï¼šå°†reflect.Value.Pointeræˆ–reflect.Value.UnsafeAddrè½¬æ¢ä¸ºæŒ‡é’ˆ



æ¨¡å¼6ï¼šreflect.SliceHeaderå’Œreflect.StringHeaderå¿…é¡»é€šè¿‡æ¨¡å¼1æ„å»º



## 70 äº†è§£cgoçš„åŸç†å’Œä½¿ç”¨å¼€é”€

å¦‚ä¸‹ä¸€äº›åœºæ™¯ä¸­ï¼Œå¾ˆå¤§å¯èƒ½ç”šè‡³æ˜¯ä¸å¯é¿å…åœ°ä¼šä½¿ç”¨åˆ°cgoæ¥å®ç°Goä¸Cçš„äº’æ“ä½œï¼š

- ä¸ºäº†æå‡**å±€éƒ¨ä»£ç æ€§èƒ½**ï¼Œç”¨Cä»£ç æ›¿æ¢ä¸€äº›Goä»£ç ã€‚åœ¨æ€§èƒ½æ–¹é¢ï¼ŒCä»£ç ä¹‹äºGoå°±å¥½æ¯”æ±‡ç¼–ä»£ç ä¹‹äºCã€‚
- å¯¹Goå†…å­˜GCçš„å»¶è¿Ÿæ•æ„Ÿï¼Œéœ€è¦è‡ªå·±æ‰‹åŠ¨è¿›è¡Œå†…å­˜ç®¡ç†ï¼ˆåˆ†é…å’Œé‡Šæ”¾ï¼‰ï¼›
- ä¸º**ä¸€äº›Cè¯­è¨€ä¸“æœ‰çš„ä¸”æ²¡æœ‰Goæ›¿ä»£å“çš„åº“**åˆ¶ä½œGoç»‘å®šï¼ˆbindingï¼‰æˆ–åŒ…è£…ã€‚æ¯”å¦‚ï¼šOracleæä¾›äº†Cç‰ˆæœ¬OCIåº“ï¼ˆOracle Call Interfaceï¼‰ï¼Œä½†å¹¶æœªæä¾›Goç‰ˆæœ¬çš„OCIåº“ä»¥åŠè¿æ¥æ•°æ®åº“çš„åè®®ç»†èŠ‚ï¼Œå› æ­¤æˆ‘ä»¬åªèƒ½é€šè¿‡åŒ…è£…Cè¯­è¨€çš„OCIç‰ˆæœ¬ä¸Oracleæ•°æ®åº“é€šä¿¡ã€‚ç±»ä¼¼çš„æƒ…å†µè¿˜æœ‰ä¸€äº›**å›¾å½¢é©±åŠ¨ç¨‹åº**ä»¥åŠ**å›¾å½¢åŒ–çš„çª—å£ç³»ç»Ÿæ¥å£**ï¼ˆå¦‚OpenGLåº“ç­‰ï¼‰ã€‚
- ä¸é—ç•™çš„ä¸”å¾ˆéš¾é‡å†™æˆ–æ›¿æ¢çš„Cä»£ç è¿›è¡Œäº¤äº’ã€‚

### 70.1 Goè°ƒç”¨Cä»£ç çš„åŸç†

```go
package main

// #include <stdio.h>
// #include <stdlib.h>
//
// void print(char* s) {
// 	printf("%s\n", s);
// }
import "C"
import "unsafe"

func main() {
	s := "Hello, Cgo"
	cs := C.CString(s)
	defer C.free(unsafe.Pointer(cs))
	C.print(cs)
}
```

å¸¸è§„çš„Goä»£ç ç›¸æ¯”ï¼Œä¸Šè¿°ä»£ç æœ‰å‡ å¤„ç‰¹æ®Šçš„åœ°æ–¹ï¼š

- Cä»£ç ç›´æ¥å‡ºç°åœ¨Goæºæ–‡ä»¶ä¸­ï¼Œåªæ˜¯éƒ½ä»¥æ³¨é‡Šçš„å½¢å¼å­˜åœ¨ï¼›
- ç´§é‚»æ³¨é‡Šäº†çš„Cä»£ç å—ä¹‹åï¼ˆä¸­é—´æ²¡æœ‰ç©ºè¡Œï¼‰ï¼Œæˆ‘ä»¬å¯¼å…¥äº†ä¸€ä¸ªåä¸ºCçš„åŒ…ï¼›
- åœ¨mainå‡½æ•°ä¸­é€šè¿‡Cè¿™ä¸ªåŒ…è°ƒç”¨äº†Cä»£ç ä¸­å®šä¹‰çš„å‡½æ•°printã€‚

è¿™é‡Œçš„â€œ`C`â€ä¸æ˜¯åŒ…åï¼Œè€Œæ˜¯ä¸€ç§ç±»ä¼¼åå­—ç©ºé—´çš„æ¦‚å¿µï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºä¼ªåŒ…åï¼ŒCè¯­è¨€æ‰€æœ‰è¯­æ³•å…ƒç´ å‡åœ¨è¯¥ä¼ªåŒ…ä¸‹é¢ã€‚

ç¼–è¯‘è¿™ä¸ªå¸¦æœ‰Cä»£ç çš„Goæºæ–‡ä»¶ä¸å¸¸è§„çš„Goæºæ–‡ä»¶æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œä¾æ—§å¯ä»¥ç›´æ¥é€šè¿‡go buildæˆ–go runæ¥ç¼–è¯‘å’Œæ‰§è¡Œã€‚

å¯ä»¥é€šè¿‡`go build -x -v`è¾“å‡ºå¸¦æœ‰cgoä»£ç çš„Goæºæ–‡ä»¶çš„æ„å»ºç»†èŠ‚ï¼š

```sh
$ go build -x -v how_cgo_works.go 
...
```

æ„å»ºè¿‡ç¨‹è¾“å‡ºçš„å†…å®¹å¾ˆå¤šï¼Œç”¨ä¸‹å›¾æ¥æç»˜ä¸€ä¸‹æ„å»ºçš„æ€»ä½“è„‰ç»œï¼š

![](images/image-20250508180720176.png)

çœ‹åˆ°åœ¨å®é™…ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œgo buildè°ƒç”¨äº†åä¸ºcgoçš„å·¥å…·ï¼Œcgoä¼šè¯†åˆ«å’Œè¯»å–Goæºæ–‡ä»¶ï¼ˆhow_cgo_works.goï¼‰ä¸­çš„Cä»£ç ï¼Œå¹¶å°†å…¶æå–åäº¤ç»™å¤–éƒ¨çš„Cç¼–è¯‘å™¨ï¼ˆclangæˆ–gccï¼‰ç¼–è¯‘ï¼Œæœ€åä¸Goæºç ç¼–è¯‘åçš„ç›®æ ‡æ–‡ä»¶é“¾æ¥æˆä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºã€‚

### 70.2 åœ¨Goä¸­ä½¿ç”¨Cè¯­è¨€çš„ç±»å‹

#### 1 åŸç”Ÿç±»å‹

##### æ•°å€¼ç±»å‹

```go
C.char,ï¿¼
C.schar (signed char),ï¿¼
C.uchar (unsigned char),ï¿¼
C.short,ï¿¼
C.ushort (unsigned short),ï¿¼
C.int, C.uint (unsigned int),ï¿¼
C.long,ï¿¼
C.ulong (unsigned long),ï¿¼
C.longlong (long long),ï¿¼
C.ulonglong (unsigned long long),ï¿¼
C.float,ï¿¼
C.double
```

Goçš„æ•°å€¼ç±»å‹ä¸Cä¸­çš„æ•°å€¼ç±»å‹ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå› æ­¤åœ¨ä½¿ç”¨å¯¹æ–¹ç±»å‹å˜é‡æ—¶å°‘ä¸äº†æ˜¾å¼ç±»å‹è½¬æ¢æ“ä½œ

##### æŒ‡é’ˆç±»å‹

åŸç”Ÿæ•°å€¼ç±»å‹çš„æŒ‡é’ˆç±»å‹å¯æŒ‰Goè¯­æ³•åœ¨ç±»å‹å‰é¢åŠ ä¸Šæ˜Ÿå·`*`ï¼Œæ¯”å¦‚`var p *C.int`ã€‚ä½†`void*`æ¯”è¾ƒç‰¹æ®Šï¼Œåœ¨Goä¸­ç”¨`unsafe.Pointer`è¡¨ç¤ºå®ƒï¼Œè¿™æ˜¯å› ä¸ºä»»ä½•ç±»å‹çš„æŒ‡é’ˆå€¼éƒ½å¯ä»¥è½¬æ¢ä¸ºunsafe.Pointerç±»å‹ï¼Œè€Œunsafe.Pointerç±»å‹ä¹Ÿå¯ä»¥è½¬æ¢å›ä»»æ„ç±»å‹çš„æŒ‡é’ˆç±»å‹ã€‚

##### å­—ç¬¦ä¸²ç±»å‹

Cè¯­è¨€ä¸­å¹¶ä¸å­˜åœ¨åŸç”Ÿçš„å­—ç¬¦ä¸²ç±»å‹ï¼Œåœ¨Cä¸­ç”¨å¸¦ç»“å°¾`'\0'`çš„å­—ç¬¦æ•°ç»„æ¥è¡¨ç¤ºå­—ç¬¦ä¸²ï¼›è€Œåœ¨Goä¸­ï¼Œstringç±»å‹æ˜¯è¯­è¨€çš„åŸç”Ÿç±»å‹ï¼Œå› æ­¤è¿™ä¸¤ç§è¯­è¨€çš„äº’æ“ä½œåŠ¿å¿…è¦è¿›è¡Œå­—ç¬¦ä¸²ç±»å‹çš„è½¬æ¢ã€‚
é€šè¿‡C.CStringå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å°†Goçš„stringç±»å‹è½¬æ¢ä¸ºCçš„â€œå­—ç¬¦ä¸²â€ç±»å‹åå†ä¼ ç»™Cå‡½æ•°ä½¿ç”¨ã€‚

```go
s := "Hello, Cgo\n"ï¿¼
cs := C.CString(s)ï¿¼
C.print(cs)
```

ä¸è¿‡è¿™ä¸ªè½¬å‹ç›¸å½“äºåœ¨Cè¯­è¨€ä¸–ç•Œçš„å †ä¸Šåˆ†é…ä¸€å—æ–°å†…å­˜ç©ºé—´ï¼Œè¿™æ ·è½¬å‹åæ‰€å¾—åˆ°çš„Cå­—ç¬¦ä¸²cså¹¶ä¸èƒ½ç”±Goçš„GCï¼ˆåƒåœ¾å›æ”¶å™¨ï¼‰ç®¡ç†ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ä½¿ç”¨åæ‰‹åŠ¨é‡Šæ”¾csæ‰€å ç”¨çš„å†…å­˜ï¼Œè¿™å°±æ˜¯ä¾‹å­ä¸­é€šè¿‡deferè°ƒç”¨C.freeé‡Šæ”¾æ‰csçš„åŸå› ã€‚å†æ¬¡å¼ºè°ƒï¼Œ**å¯¹äºåœ¨Cå†…éƒ¨åˆ†é…çš„å†…å­˜ï¼ŒGoä¸­çš„GCæ˜¯æ— æ³•æ„ŸçŸ¥åˆ°çš„ï¼Œå› æ­¤è¦è®°ç€åœ¨ä½¿ç”¨åæ‰‹åŠ¨é‡Šæ”¾**ã€‚

é€šè¿‡C.GoStringå¯å°†Cçš„å­—ç¬¦ä¸²`ï¼ˆ*C.charï¼‰`è½¬æ¢ä¸ºGoçš„stringç±»å‹:

```go
package main

// #include <stdio.h>
// #include <stdlib.h>
// char *foo = "helloChina";
import "C"
import "fmt"

func main() {
	fmt.Printf("%T", C.GoString(C.foo))  // string
}
```

è¿™ç›¸å½“äºåœ¨Goä¸–ç•Œé‡æ–°åˆ†é…ä¸€å—å†…å­˜å¯¹è±¡ï¼Œå¹¶å¤åˆ¶äº†Cçš„å­—ç¬¦ä¸²ï¼ˆfooï¼‰çš„ä¿¡æ¯ï¼Œåç»­è¿™ä¸ªä½äºGoä¸–ç•Œçš„æ–°çš„stringç±»å‹å¯¹è±¡å°†å’Œå…¶ä»–Goå¯¹è±¡ä¸€æ ·æ¥å—GCçš„ç®¡ç†ã€‚

##### æ•°ç»„ç±»å‹

Cè¯­è¨€ä¸­çš„æ•°ç»„ä¸Goè¯­è¨€ä¸­çš„æ•°ç»„å·®å¼‚è¾ƒå¤§ï¼Œåè€…æ˜¯åŸç”Ÿçš„å€¼ç±»å‹ï¼Œè€Œå‰è€…ä¸Cä¸­çš„æŒ‡é’ˆåœ¨å¤§éƒ¨åˆ†åœºåˆå¯ä»¥éšæ„è½¬æ¢ã€‚Goä»…æä¾›äº†C.GoBytesæ¥å°†Cä¸­çš„charç±»å‹æ•°ç»„è½¬æ¢ä¸ºGoä¸­çš„[]byteåˆ‡ç‰‡ç±»å‹ï¼š

```go
package main

// char cArray[] = {'a', 'b', 'c', 'd', 'e', 'f'};
import "C"
import (
	"fmt"
	"unsafe"
)

func main() {
	goArray := C.GoBytes(unsafe.Pointer(&C.cArray[0]), 6)
	fmt.Printf("%c\n", goArray) // [a b c d e f]
}
```

è€Œå¯¹äºå…¶ä»–ç±»å‹çš„Cæ•°ç»„ï¼Œç›®å‰ä¼¼ä¹æ— æ³•ç›´æ¥æ˜¾å¼åœ°åœ¨ä¸¤è€…ä¹‹é—´è¿›è¡Œç±»å‹è½¬æ¢ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ç‰¹å®šè½¬æ¢å‡½æ•°æ¥å°†Cçš„ç‰¹å®šç±»å‹æ•°ç»„è½¬æ¢ä¸ºGoçš„åˆ‡ç‰‡ç±»å‹ï¼ˆGoä¸­æ•°ç»„æ˜¯å€¼ç±»å‹ï¼Œå…¶å¤§å°æ˜¯é™æ€çš„ï¼Œè½¬æ¢ä¸ºåˆ‡ç‰‡æ›´ä¸ºé€šç”¨ï¼‰ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå°†Cæ•´å‹æ•°ç»„è½¬æ¢ä¸ºGo[]int32åˆ‡ç‰‡ç±»å‹çš„ä¾‹å­ï¼š

```go
package main

// int cArray[] = {1, 2, 3, 4, 5, 6, 7, 8};
import "C"
import (
	"fmt"
	"unsafe"
)

// å°†Cæ•´å‹æ•°ç»„è½¬æ¢ä¸ºGo[]int32åˆ‡ç‰‡ç±»å‹
func main() {
	goArray := CArrayToGoArray(unsafe.Pointer(&C.cArray[0]), unsafe.Sizeof(C.cArray[0]), 8)
	fmt.Println(goArray) // [1 2 3 4 5 6 7 8]
}

func CArrayToGoArray(cArray unsafe.Pointer, elemSize uintptr, len int) (goArray []int32) {
	for i := 0; i < len; i++ {
		j := *(*int32)((unsafe.Pointer)(uintptr(cArray) + uintptr(i)*elemSize))
		goArray = append(goArray, j)
	}
	return
}
```

æ³¨æ„ï¼šGoç¼–è¯‘å™¨å¹¶ä¸èƒ½å°†Cçš„cArrayè‡ªåŠ¨è½¬æ¢ä¸ºæ•°ç»„çš„åœ°å€ï¼Œæ‰€ä»¥ä¸èƒ½åƒåœ¨Cä¸­ä½¿ç”¨æ•°ç»„é‚£æ ·å°†æ•°ç»„å˜é‡ç›´æ¥ä¼ é€’ç»™å‡½æ•°ï¼Œè€Œæ˜¯å°†æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€ä¼ é€’ç»™å‡½æ•°ã€‚

#### 2 è‡ªå®šä¹‰ç±»å‹

##### æšä¸¾ï¼ˆenumï¼‰

å¯¹äºå…·åçš„Cæšä¸¾ç±»å‹xxï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`C.enum_xx`æ¥è®¿é—®è¯¥ç±»å‹ï¼›å¦‚æœæ˜¯åŒ¿åæšä¸¾ï¼Œåˆ™åªèƒ½è®¿é—®å…¶å­—æ®µäº†ã€‚

##### ç»“æ„ä½“ï¼ˆstructï¼‰

é€šè¿‡C.struct_xxæ¥è®¿é—®Cä¸­å®šä¹‰çš„ç»“æ„ä½“ç±»å‹xx

```go
package main

// #include <stdlib.h>
//
// struct employee {
//   char *id;
//   int age;
// };
import "C"
import (
	"fmt"
	"unsafe"
)

func main() {
	id := C.CString("123456")
	defer C.free(unsafe.Pointer(id))

	var p = C.struct_employee{
		id:  id,
		age: 18,
	}
	// %#v ä»¥ Go è¯­æ³•æ ¼å¼è¾“å‡ºå€¼
	fmt.Printf("%#v\n", p)  // main._Ctype_struct_employee{id:(*main._Ctype_char)(0x600002efc000), age:18, _:[4]uint8{0x0, 0x0, 0x0, 0x0}}
}
```

##### è”åˆä½“ï¼ˆunionï¼‰



##### åˆ«åç±»å‹ï¼ˆtypedefï¼‰

```go
// typedef int myint;ï¿¼
var a C.myint = 5ï¿¼
fmt.Println(a)

// typedef struct employee myemployee;ï¿¼
var m C.struct_myemployee
```

#### 3 Goä¸­è·å–Cç±»å‹å¤§å°

Goæä¾›äº†`C.sizeof_T`æ¥è·å–`C.T`ç±»å‹çš„å¤§å°ã€‚å¦‚æœæ˜¯ç»“æ„ä½“ã€æšä¸¾åŠè”åˆä½“ç±»å‹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨Tå‰é¢åˆ†åˆ«åŠ ä¸Š`struct_`ã€`enum_`å’Œ`union_`çš„å‰ç¼€ï¼š

```go
package main

// struct employee {
//   char *id;
//   int age;
// };
import "C"
import "fmt"

func main() {
	fmt.Printf("%#v\n", C.sizeof_int)             // 4
	fmt.Printf("%#v\n", C.sizeof_char)            // 1
	fmt.Printf("%#v\n", C.sizeof_struct_employee) // 16
}
```

### 70.3 åœ¨Goä¸­é“¾æ¥å¤–éƒ¨Cåº“

ä»ä»£ç ç»“æ„ä¸Šæ¥è®²ï¼Œåœ¨Goæºæ–‡ä»¶ä¸­å¤§é‡ç¼–å†™Cä»£ç å¹¶ä¸æ˜¯Goæ¨èçš„æƒ¯ç”¨æ³•ã€‚

Goæä¾›äº†`#cgo`æŒ‡ç¤ºç¬¦ï¼Œå¯ä»¥ç”¨å®ƒæŒ‡å®šGoæºç åœ¨ç¼–è¯‘åä¸å“ªäº›å…±äº«åº“è¿›è¡Œé“¾æ¥ã€‚

```go
// foo.go
package main

// #cgo CFLAGS: -I${SRCDIR}
// #cgo LDFLAGS: -L${SRCDIR} -lfoo
// #include <stdio.h>
// #include <stdlib.h>
// #include "foo.h"
import "C"
import "fmt"

func main() {
	fmt.Println(C.count)
	C.foo()
}
```

é€šè¿‡#cgoæŒ‡ç¤ºç¬¦å‘Šè¯‰Goç¼–è¯‘å™¨åœ¨å½“å‰æºç ç›®å½•ï¼ˆ`${SRCDIR}`ä¼šåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­è‡ªåŠ¨è½¬æ¢ä¸ºå½“å‰æºç æ‰€åœ¨ç›®å½•çš„ç»å¯¹è·¯å¾„ï¼‰ä¸‹æŸ¥æ‰¾å¤´æ–‡ä»¶`foo.h`ï¼Œå¹¶é“¾æ¥å½“å‰æºç ç›®å½•ä¸‹çš„libfooå…±äº«åº“ã€‚`C.count`å˜é‡å’ŒC.fooå‡½æ•°çš„å®šä¹‰éƒ½åœ¨libfooå…±äº«åº“ä¸­ã€‚åˆ›å»ºè¿™ä¸ªå…±äº«åº“ï¼š

```c
// foo.h
extern int count;
void foo();
```

```c
// foo.c
#include <stdio.h>
#include "foo.h"

int count = 100;
void foo() {
    printf("hello world, I'm foo!\n");
}
```

ç”¨arå·¥å…·åˆ›å»ºä¸€ä¸ª==é™æ€å…±äº«åº“==æ–‡ä»¶`libfoo.a`:

```sh
$ gcc -c foo.cï¿¼
$ ar rv libfoo.a foo.o
```

æ„å»ºå¹¶è¿è¡Œfoo.goï¼š

```shell
$ go build foo.go
$ ./foo 
100
hello world, I'm foo!
```

çœ‹åˆ°foo.goæˆåŠŸé“¾æ¥åˆ°libfoo.aå¹¶ç”Ÿæˆæœ€ç»ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶fooã€‚

GoåŒæ ·æ”¯æŒé“¾æ¥==åŠ¨æ€å…±äº«åº“==ï¼Œç”¨ä¸‹é¢çš„å‘½ä»¤å°†ä¸Šé¢çš„foo.cç¼–è¯‘ä¸ºä¸€ä¸ªåŠ¨æ€å…±äº«åº“ï¼š

```sh
$ gcc -c foo.cï¿¼
// $ gcc -shared -Wl,-soname,libfoo.so -o libfoo.so  foo.o (åœ¨linuxä¸Š)ï¿¼
$ gcc -shared -o libfoo.so  foo.o
```

é‡æ–°ç¼–è¯‘foo.goï¼Œå¹¶æŸ¥çœ‹ï¼ˆåœ¨Linuxä¸Šå¯ä»¥ä½¿ç”¨`ldd`ï¼Œåœ¨macOSä¸Šä½¿ç”¨`otool`ï¼‰é‡æ–°ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶fooçš„åŠ¨æ€å…±äº«åº“ä¾èµ–æƒ…å†µï¼š

```sh
$ go build foo.go               
$ otool -L foo
foo:
        libfoo.so (compatibility version 0.0.0, current version 0.0.0)
        /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation (compatibility version 150.0.0, current version 3502.1.255)
        /usr/lib/libresolv.9.dylib (compatibility version 1.0.0, current version 1.0.0)
        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1351.0.0)
```



æ³¨æ„ï¼ŒGoæ”¯æŒå¤šè¿”å›å€¼ï¼Œè€ŒCå¹¶ä¸æ”¯æŒï¼Œå› æ­¤å½“å°†Cå‡½æ•°ç”¨åœ¨å¤šè¿”å›å€¼çš„Goè°ƒç”¨ä¸­æ—¶ï¼ŒCçš„errnoå°†ä½œä¸ºå‡½æ•°è¿”å›å€¼åˆ—è¡¨ä¸­æœ€åé‚£ä¸ªerrorè¿”å›å€¼è¿”å›ã€‚ä¸‹é¢æ˜¯ä¸ªä¾‹å­ï¼š

```go
// c_errno.go

package main

// #include <stdlib.h>
// #include <stdio.h>
// #include <errno.h>
// int foo(int i) {
//   errno = 0;
//   if (i > 5) {
//     errno = 8;
//     return i - 5;
//   } else {
//     return i;
//   }
// }
import "C"
import "fmt"

func main() {
	i, err := C.foo(C.int(8))
	if err != nil {
		fmt.Println(err)
	} else {
		fmt.Println(i)
	}
}
```



```sh
$g o run c_errno.goï¿¼
exec format error
```

`exec format error`å°±æ˜¯errnoä¸º8æ—¶çš„é”™è¯¯æè¿°ä¿¡æ¯ã€‚

### 70.4 åœ¨Cä¸­ä½¿ç”¨Goå‡½æ•°

åœ¨Cä¸­ä½¿ç”¨Goå‡½æ•°çš„åœºåˆæå°‘ã€‚åœ¨Goä¸­ï¼Œå¯ä»¥ä½¿ç”¨`export + å‡½æ•°å`æ¥å¯¼å‡ºGoå‡½æ•°ä¸ºCæ‰€ç”¨ã€‚ç›®å‰Goçš„å¯¼å‡ºå‡½æ•°ä¾›Cä½¿ç”¨çš„åŠŸèƒ½è¿˜ååˆ†æœ‰é™ï¼Œä¸¤ç§è¯­è¨€çš„è°ƒç”¨çº¦å®šä¸åŒï¼Œç±»å‹æ— æ³•ä¸€ä¸€å¯¹åº”ï¼ŒGoä¸­ç±»ä¼¼åƒåœ¾å›æ”¶è¿™æ ·çš„é«˜çº§åŠŸèƒ½è®©å¯¼å‡ºGoå‡½æ•°è¿™ä¸€ç‰¹æ€§éš¾äºå®Œç¾å®ç°ï¼Œå¯¼å‡ºçš„å‡½æ•°ä¾æ—§æ— æ³•å®Œå…¨è„±ç¦»Goçš„ç¯å¢ƒï¼Œå› æ­¤å…¶å®ç”¨æ€§å¤§æ‰“æŠ˜æ‰£ã€‚

### 70.5 ä½¿ç”¨cgoçš„å¼€é”€

#### 1 ä¸èƒ½å¿½è§†çš„è°ƒç”¨å¼€é”€

åœ¨Goä»£ç ä¸­è°ƒç”¨Cå‡½æ•°çœ‹èµ·æ¥ä¼¼ä¹å¾ˆå¹³æ»‘ï¼Œä½†å®é™…ä¸Šè¿™ç§è°ƒç”¨çš„å¼€é”€è¦æ¯”è°ƒç”¨Goå‡½æ•°å¤šå‡º**ä¸€ä¸ªç”šè‡³å¤šä¸ªæ•°é‡çº§**ã€‚



```sh
$ go test -bench . -gcflags '-l'
goos: darwin
goarch: arm64
pkg: gofirst/ch70cgo/5
cpu: Apple M1
BenchmarkCGO-8          43136834                28.16 ns/op
BenchmarkGO-8           546780799                2.199 ns/op
PASS
ok      gofirst/ch70cgo/5       3.686s

```



#### 2 å¢åŠ çº¿ç¨‹æ•°é‡æš´æ¶¨çš„å¯èƒ½æ€§ğŸ”–



#### 3 å¤±å»è·¨å¹³å°äº¤å‰æ„å»ºèƒ½åŠ›ğŸ”–



#### 4 å…¶ä»–å¼€é”€





### 70.6 ä½¿ç”¨cgoä»£ç çš„é™æ€æ„å»ºğŸ”–

æ‰€è°“é™æ€æ„å»ºå°±æ˜¯æŒ‡æ„å»ºåçš„åº”ç”¨è¿è¡Œæ‰€éœ€çš„æ‰€æœ‰ç¬¦å·ã€æŒ‡ä»¤å’Œæ•°æ®éƒ½åŒ…å«åœ¨è‡ªèº«çš„äºŒè¿›åˆ¶æ–‡ä»¶å½“ä¸­ï¼Œæ²¡æœ‰ä»»ä½•å¯¹å¤–éƒ¨åŠ¨æ€å…±äº«åº“çš„ä¾èµ–ã€‚é™æ€æ„å»ºå‡ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ç”±äºåŒ…å«æ‰€æœ‰ç¬¦å·ã€æŒ‡ä»¤å’Œæ•°æ®ï¼Œå› è€Œé€šå¸¸è¦æ¯”éé™æ€æ„å»ºçš„åº”ç”¨å¤§è®¸å¤šã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒGoæ²¡æœ‰é‡‡ç”¨é™æ€æ„å»ºã€‚



## 71 ä½¿ç”¨cryptoä¸‹çš„å¯†ç å­¦åŒ…æ„å»ºå®‰å…¨åº”ç”¨

å¯†ç å­¦ï¼ˆcryptographyï¼‰æ˜¯**å¯¹ä¿¡æ¯åŠå…¶ä¼ è¾“çš„æ•°å­¦æ€§ç ”ç©¶**ã€‚

åœ¨äººç±»è¿›å…¥ä¿¡æ¯ç¤¾ä¼šï¼Œå°¤å…¶æ˜¯æ­¥å…¥è®¡ç®—æœºäº’è”ç½‘æ—¶ä»£ä¹‹åï¼Œ**ç°ä»£å¯†ç å­¦ä¾¿æˆä¸ºæ•´ä¸ªäº’è”ç½‘å®‰å…¨çš„åŸºçŸ³**ï¼Œä¸ºäººç±»åœ¨æ•°å­—ä¸–ç•Œçš„æ´»åŠ¨ä¿é©¾æŠ¤èˆªã€‚è¿‘å‡ å¹´æ–°å…´çš„äº’è”ç½‘æŠ€æœ¯ï¼Œå¦‚åŒºå—é“¾ç­‰ï¼Œæ— ä¸æ˜¯å»ºæ„åœ¨ç°ä»£å¯†ç å­¦çš„åŸºç¡€ä¹‹ä¸Šçš„ã€‚å¯ä»¥è¯´ï¼Œå¯†ç å­¦æ˜¯äº’è”ç½‘çš„ä¿¡ä»»ä¹‹æºã€‚

å¯†ç å­¦æœ¬è´¨ä¸Šæ˜¯==æ•°å­¦==ï¼Œå¯†ç å­¦çš„ç®—æ³•å¤šç”±ä¸“ä¸šçš„å¯†ç å­¦ç ”ç©¶äººå‘˜è®¾è®¡å’Œå®ç°ã€‚å› æ­¤å¤§å¤šæ•°å¼€å‘äººå‘˜æ— é¡»äº²è‡ªè®¾è®¡å’Œå®ç°åŠ å¯†ç®—æ³•ï¼Œä»…éœ€äº†è§£å¯†ç å­¦çš„åŸºç¡€çŸ¥è¯†å¹¶ä½¿ç”¨ç°æˆçš„å¯†ç å­¦ç®—æ³•å®ç°å»æ„å»ºå®‰å…¨åº”ç”¨å³å¯ã€‚

### 71.1 Goå¯†ç å­¦åŒ…æ¦‚è§ˆä¸è®¾è®¡åŸåˆ™

åˆ†ç»„å¯†ç ï¼ˆblock cipherï¼‰

å…¬é’¥å¯†ç ï¼ˆpublic-key cryptographyï¼Œäº¦ç§°éå¯¹ç§°å¯†ç asymmetric cryptographyï¼‰ä¸æ•°å­—ç­¾åï¼ˆdigital signatureï¼‰

å•å‘æ•£åˆ—å‡½æ•°ï¼Œäº¦ç§°æ¶ˆæ¯æ‘˜è¦ï¼ˆdigestï¼‰æˆ–æŒ‡çº¹ï¼ˆfingerprintï¼‰

æ¶ˆæ¯è®¤è¯ç ï¼ˆMessage Authentication Codeï¼ŒMACï¼‰

éšæœºæ•°ç”Ÿæˆ





### 71.2 åˆ†ç»„å¯†ç ç®—æ³•

å¯†ç ç®—æ³•å¯ä»¥åˆ†ä¸º**åˆ†ç»„å¯†ç ï¼ˆblock cipherï¼‰**å’Œ**æµå¯†ç ï¼ˆstream cipherï¼‰**ä¸¤ç§ã€‚

æµå¯†ç æ˜¯å¯¹æ•°æ®æµè¿›è¡Œè¿ç»­å¤„ç†çš„ä¸€ç±»ç®—æ³•ï¼Œè€Œæˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨æœ€å¤šçš„DESã€AESåŠ å¯†ç®—æ³•åˆ™éƒ½å½’äºåˆ†ç»„å¯†ç ç®—æ³•èŒƒç•´ã€‚

åˆ†ç»„å¯†ç æ˜¯ä¸€ç§ä¸€æ¬¡ä»…èƒ½å¤„ç†å›ºå®šé•¿åº¦æ•°æ®å—çš„ç®—æ³•ã€‚è€Œè¿™ä¸ªæ•°æ®å—çš„å›ºå®šé•¿åº¦ï¼ˆæ¯”ç‰¹æ•°é‡ï¼‰åˆ™ç§°ä¸ºè¯¥åˆ†ç»„å¯†ç ç®—æ³•çš„åˆ†ç»„é•¿åº¦ï¼ˆblock lengthï¼‰ã€‚

![](images/image-20250719231508738.png)



![](images/image-20250719231547753.png)



![](images/image-20250719231629596.png)





![](images/image-20250719231647501.png)



### 71.3 å…¬é’¥å¯†ç 



![](images/image-20250719231714917.png)



![](images/image-20250719231733299.png)

### 71.4 å•å‘æ•£åˆ—å‡½æ•°

å•å‘æ•£åˆ—å‡½æ•°ï¼ˆone-way hash functionï¼‰æ˜¯ä¸€ä¸ªæ¥å—ä¸å®šé•¿è¾“å…¥ä½†äº§ç”Ÿå®šé•¿è¾“å‡ºçš„å‡½æ•°ï¼Œè¿™ä¸ªå®šé•¿è¾“å‡ºè¢«ç§°ä¸ºâ€œæ‘˜è¦â€ï¼ˆdigestï¼‰æˆ–â€œæŒ‡çº¹â€ï¼ˆfingerprintï¼‰ã€‚

![](images/image-20250719231837453.png)





### 71.5 æ¶ˆæ¯è®¤è¯ç 

![](images/image-20250719231921298.png)





![](images/image-20250719231950141.png)





### 71.6 æ•°å­—ç­¾å



![](images/image-20250719232015249.png)



![](images/image-20250719232037939.png)



### 71.7 éšæœºæ•°ç”Ÿæˆ





## 72 ä½¿ç”¨go generateé©±åŠ¨ä»£ç ç”Ÿæˆ

æŠŠGoå·¥å…·é“¾ä¸­ä»£ç ç”Ÿæˆå·¥å…·ï¼ˆgo generateï¼‰å•ç‹¬ä»‹ç»ä½¿ç”¨ã€‚

### 72.1 go generateï¼šGoåŸç”Ÿçš„ä»£ç ç”Ÿæˆâ€œé©±åŠ¨å™¨â€

æ„å»ºä¸­å°è§„æ¨¡çš„Goé¡¹ç›®æ—¶é€šå¸¸æ— é¡»å€ŸåŠ©å¤–éƒ¨æ„å»ºç®¡ç†å·¥å…·ï¼ˆæ¯”å¦‚shellè„šæœ¬ã€makeç­‰ï¼‰ï¼ŒGoå·¥å…·é“¾ä¾¿å¯ä»¥å¾ˆå¥½åœ°æ»¡è¶³æˆ‘ä»¬å…³äºæ„å»ºçš„å¤§å¤šæ•°éœ€æ±‚ã€‚

ä½†æœ‰äº›æ—¶å€™ï¼Œç›®æ ‡çš„æ„å»ºéœ€è¦ä¾èµ–ä¸€äº›é¢å¤–çš„==å‰ç½®åŠ¨ä½œ==ï¼ˆå¦‚ä»£ç ç”Ÿæˆç­‰ï¼‰ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå•é go buildæˆ‘ä»¬æ— æ³•é©±åŠ¨å‰ç½®åŠ¨ä½œçš„æ‰§è¡Œã€‚

#### make

ä»¥å¾€å¯ä»¥å€ŸåŠ©å¤–éƒ¨æ„å»ºç®¡ç†å·¥å…·ï¼Œæ¯”å¦‚`make`ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå€ŸåŠ©makeå·¥å…·å¯¹ä¸€ä¸ªä¾èµ–ä»£ç ç”Ÿæˆçš„é¡¹ç›®è¿›è¡Œæ„å»ºçš„ç¤ºä¾‹ï¼š

```shell
$ tree protobuf-makeï¿¼
protobuf-makeï¿¼
â”œâ”€â”€ IDLï¿¼
â”‚    â””â”€â”€ msg.protoï¿¼
â”œâ”€â”€ Makefileï¿¼
â”œâ”€â”€ go.modï¿¼
â”œâ”€â”€ go.sumï¿¼
â”œâ”€â”€ main.goï¿¼
â””â”€â”€ msg
		 â””â”€â”€ msg.pb.go // å¾…ç”Ÿæˆçš„Goæºæ–‡ä»¶
```

```makefile
// ch72/protobuf-make/Makefile
all: build

build: gen-protobuf
	go build

gen-protobuf:
	protoc -I ./IDL msg.proto --gofast_out=./msg
```

```protobuf
// ch72/protobuf-make/IDL/msg.proto

syntax = "proto3";
  
package msg;

message request {
        string msgID = 1;
        string field1 = 2;
        repeated string field2 = 3;
}
```

makeå‘½ä»¤é€šè¿‡Makefileç›®æ ‡ï¼ˆtargetï¼‰ä¹‹é—´çš„ä¾èµ–å…³ç³»å®ç°äº†åœ¨çœŸæ­£æ„å»ºï¼ˆgo buildï¼‰ä¹‹å‰å…ˆç”Ÿæˆ`msg/msg.pb.go`æ–‡ä»¶ï¼Œè¿™æ ·go buildæ‰§è¡Œæ—¶å°±èƒ½æ­£å¸¸æ‰¾åˆ°msgåŒ…çš„æºæ–‡ä»¶äº†ï¼ˆç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶`protobuf-make`ï¼‰ã€‚

```sh
$ make 
protoc -I ./IDL msg.proto --gofast_out=./msg
go build
```



> ä¸Šè¿°ç¤ºä¾‹åŸºäºprotobufæè¿°æ–‡ä»¶ï¼ˆmsg.protoï¼‰ç”ŸæˆGoæºç ï¼ˆmsg.pb.goï¼‰ã€‚è¿™ä¸ªç”Ÿæˆè¿‡ç¨‹ä¾èµ–ä¸¤ä¸ªå·¥å…·ï¼š
>
> ä¸€ä¸ªæ˜¯protobufç¼–è¯‘å™¨protocï¼ˆhttps://github.com/protocolbuffers/protobufï¼‰ï¼Œ
>
> å¦ä¸€ä¸ªæ˜¯protobuf goæ’ä»¶protoc-gen-gofast
>
> ```sh
> go install github.com/gogo/protobuf/protoc-gen-gofast@latest
> ```

#### go generate

Go 1.4ç‰ˆæœ¬çš„Goå·¥å…·é“¾ä¸­ä¹Ÿå¢åŠ äº†è¿™ç§åœ¨æ„å»ºä¹‹å‰é©±åŠ¨æ‰§è¡Œå‰ç½®åŠ¨ä½œçš„èƒ½åŠ›ï¼Œè¿™å°±æ˜¯`go generate`å‘½ä»¤ã€‚

```sh
$ tree protobuf-go-generate 
protobuf-go-generate
â”œâ”€â”€ IDL
â”‚Â Â  â””â”€â”€ msg.proto
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ main.go
â””â”€â”€ msg
		 â””â”€â”€ msg.pb.go // å¾…ç”Ÿæˆçš„Goæºæ–‡ä»¶
```

```go
// ch72/protobuf-go-generate/main.go

package main

//go:generate protoc -I ./IDL msg.proto --gofast_out=./msg
func main() {
}
```

åˆ é™¤äº†Makefileï¼Œç„¶åmainåŒ…çš„æºæ–‡ä»¶ä¸­æ·»åŠ äº†å¦‚ä¸‹ä¸€è¡Œç‰¹æ®Šçš„æ³¨é‡Šã€‚

è¿™å°±æ˜¯é¢„å…ˆâ€œåŸ‹â€åœ¨ä»£ç ä¸­çš„å¯ä»¥è¢«go generateå‘½ä»¤è¯†åˆ«çš„**æŒ‡ç¤ºç¬¦ï¼ˆdirectiveï¼‰**ã€‚

æ‰§è¡Œgo generateå‘½ä»¤æ—¶ï¼Œä¸Šé¢è¿™è¡ŒæŒ‡ç¤ºç¬¦ä¸­çš„å‘½ä»¤å°†è¢«go generateè¯†åˆ«å¹¶è¢«é©±åŠ¨æ‰§è¡Œï¼Œæ‰§è¡Œçš„ç»“æœå°±æ˜¯protocåŸºäºIDLç›®å½•ä¸‹çš„msg.protoç”Ÿæˆäº†mainåŒ…æ‰€éœ€è¦çš„msgåŒ…æºç ã€‚ã€-xå’Œ-vç”¨äºæŸ¥çœ‹æ‰§è¡Œè¿‡ç¨‹ã€‘

```sh
$ go generate -x -v
main.go
protoc -I ./IDL msg.proto --gofast_out=./msg
```

ä»£ç ç”Ÿæˆåï¼Œç¼–å†™ç›¸å…³ä»£ç ï¼š

```go
package main

import (
	"fmt"
	msg "protobuf-go-generate/msg"
)

//go:generate protoc -I ./IDL msg.proto --gofast_out=./msg
func main() {
	var m = msg.Request{
		MsgID:  "xxxx",
		Field1: "field1",
		Field2: []string{"field2-1", "field2-2"},
	}
	fmt.Println(m)
}
```

æ„å»ºå¹¶è¿è¡Œç¨‹åº:

```sh
$ go build
$ ./protobuf-go-generate 
{xxxx field1 [field2-1 field2-2] {} [] 0}
```

### 72.2 go generateçš„å·¥ä½œåŸç†

go generateç›¸è¾ƒäºmakeè¿™æ ·çš„å·¥å…·èƒ½åŠ›å’Œç‰¹æ€§æ¯”è¾ƒå•ä¸€ï¼Œä½†â€œ**å®ƒæ˜¯Goå·¥å…·é“¾å†…ç½®çš„ï¼Œå¤©ç„¶é€‚é…Goç”Ÿæ€ç³»ç»Ÿï¼Œæ— é¡»é¢å¤–å®‰è£…å…¶ä»–å·¥å…·ã€‚**â€ã€‚

go generateå¹¶ä¸ä¼šæŒ‰Goè¯­æ³•æ ¼å¼è§„èŒƒå»è§£æGoæºç æ–‡ä»¶ï¼Œå®ƒåªæ˜¯å°†Goæºç æ–‡ä»¶å½“æˆæ™®é€šæ–‡æœ¬è¯»å–å¹¶è¯†åˆ«å…¶ä¸­å¯ä»¥ä¸ä¸‹é¢å­—ç¬¦ä¸²æ¨¡å¼åŒ¹é…çš„å†…å®¹ï¼ˆgo generateæŒ‡ç¤ºç¬¦ï¼‰ï¼š

```go
//go:generate command arg...
```

æ³¨é‡Šç¬¦å·//å‰é¢æ²¡æœ‰ç©ºæ ¼ï¼Œä¸go:generateä¹‹é—´äº¦æ— ä»»ä½•ç©ºæ ¼ã€‚

ä¸Šé¢çš„go generateæŒ‡ç¤ºç¬¦å¯ä»¥æ”¾åœ¨Goæºæ–‡ä»¶ä¸­çš„ä»»æ„ä½ç½®ï¼Œå¹¶ä¸”ä¸€ä¸ªGoæºæ–‡ä»¶ä¸­å¯ä»¥æœ‰å¤šä¸ªgo generateæŒ‡ç¤ºç¬¦ï¼Œgo generateå‘½ä»¤ä¼šæŒ‰å…¶å‡ºç°çš„é¡ºåºé€ä¸ªè¯†åˆ«å’Œæ‰§è¡Œï¼š1ï¸âƒ£

```go
// multi_go_generate_directive.goï¿¼

//go:generate echo "top"
package main

import "fmt"

//go:generate echo "middle"
func main() {
	fmt.Println("hello, go generate")
}

//go:generate echo "tail"
```

```sh
$ go generate multi_go_generate_directive.go 
top
middle
tail
```

å¯ä»¥åƒä¸Šé¢ç¤ºä¾‹é‚£æ ·ç›´æ¥å°†**Goæºæ–‡ä»¶**ä½œä¸ºå‚æ•°ä¼ ç»™go generateå‘½ä»¤ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨**åŒ…**ä½œä¸ºgo generateçš„å‚æ•°ã€‚

2ï¸âƒ£ä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºäº†ä¸åŒgo generateå¯æ¥å—çš„ä¸åŒå‚æ•°å½¢å¼ï¼š

```sh
$ tree generate-args 
generate-args
â”œâ”€â”€ go.mod
â”œâ”€â”€ main.go
â”œâ”€â”€ subpkg1
â”‚Â Â  â””â”€â”€ subpkg1.go
â””â”€â”€ subpkg2
    â””â”€â”€ subpkg2.go

```

main.goã€subpkg1.goå’Œsubpkg2.goä¸‰ä¸ªæºæ–‡ä»¶ä¸­éƒ½æœ‰ä¸€è¡Œgo generateæŒ‡ç¤ºç¬¦ï¼š

```go
//go:generate pwd
```

go generateæ‰§è¡Œè¯¥æŒ‡ç¤ºç¬¦ä¸­çš„å‘½ä»¤æ—¶ä¼šè¾“å‡ºå½“å‰å·¥ä½œç›®å½•ï¼ˆWorking Directoryï¼‰ï¼š

```sh
// 1 ä¼ å…¥æŸä¸ªæ–‡ä»¶
$ go generate -x -v main.go 
main.go
pwd
/Users/.../gofirst/ch72/generate-args

// 2 ä¼ å…¥å½“å‰moduleï¼ŒåŒ¹é…åˆ°moduleçš„main packageä¸”ä»…å¤„ç†è¯¥main packageçš„æºæ–‡ä»¶ï¿¼
$ go generate -x -v
main.go
pwd
/Users/.../gofirst/ch72/generate-args

// 3 ä¼ å…¥æœ¬åœ°è·¯å¾„ï¼ŒåŒ¹é…è¯¥è·¯å¾„ä¸‹çš„åŒ…çš„æ‰€æœ‰æºæ–‡ä»¶ï¿¼
$ go generate -x -v ./subpkg1 
subpkg1/subpkg1.go
pwd
/Users/.../gofirst/ch72/generate-args/subpkg1

// 4 ä¼ å…¥åŒ…ï¼Œç”±äºæ˜¯moduleçš„æ ¹è·¯å¾„ï¼Œå› æ­¤åªå¤„ç†è¯¥moduleä¸‹çš„mainåŒ…
$ go generate -x -v github.com/andyron/generate-args
main.go
pwd
/Users/.../gofirst/ch72/generate-args

// 5 ä¼ å…¥åŒ…ï¼Œå¤„ç†subpkg1åŒ…ä¸‹çš„æ‰€æœ‰æºæ–‡ä»¶ï¿¼
$ go generate -x -v github.com/andyron/generate-args/subpkg1
subpkg1/subpkg1.go
pwd
/Users/.../gofirst/ch72/generate-args/subpkg1

// 6 ä¼ å…¥./...æ¨¡å¼ï¼ŒåŒ¹é…å½“å‰è·¯å¾„åŠå…¶å­è·¯å¾„ä¸‹çš„æ‰€æœ‰åŒ…ï¿¼
$ go generate -x -v ./...                                   
main.go
pwd
/Users/.../gofirst/ch72/generate-args
subpkg1/subpkg1.go
pwd
/Users/.../gofirst/ch72/generate-args/subpkg1
subpkg2/subpkg2.go
pwd
/Users/.../gofirst/ch72/generate-args/subpkg2
```



3ï¸âƒ£ go generateè¿˜å¯ä»¥é€šè¿‡-runä½¿ç”¨æ­£åˆ™å¼å»åŒ¹é…å„æºæ–‡ä»¶ä¸­go generateæŒ‡ç¤ºç¬¦ä¸­çš„å‘½ä»¤ï¼Œå¹¶ä»…æ‰§è¡ŒåŒ¹é…æˆåŠŸçš„å‘½ä»¤ï¼š

```sh
// æœªåŒ¹é…åˆ°ä»»ä½•go generateæŒ‡ç¤ºç¬¦ä¸­çš„å‘½ä»¤ï¿¼
$ go generate -x -v -run "protoc" ./...
```



### 72.3 go generateçš„åº”ç”¨åœºæ™¯

ä¸Šé¢åŸºäºprotobufå®šä¹‰æ–‡ä»¶ï¼ˆ*.protoï¼‰ç”ŸæˆGoæºç æ–‡ä»¶çš„ç¤ºä¾‹å°±æ˜¯go generateä¸€ä¸ªæä¸ºå…¸å‹çš„åº”ç”¨ã€‚æ­¤å¤–å¹¿æ³›çš„åº”ç”¨è¿˜æœ‰ï¼š

#### 1 åˆ©ç”¨stringerå·¥å…·è‡ªåŠ¨ç”Ÿæˆæšä¸¾ç±»å‹çš„Stringæ–¹æ³•

> å®‰è£…stringerå·¥å…·
>
> ```
> go get golang.org/x/tools/cmd/stringer
> ```
>
> or
>
> ```sh
> go install golang.org/x/tools/cmd/stringer
> ```



```go
// enum-demo/main.goï¿¼

type Weekday int

const (
	Sunday Weekday = iota
	Monday
	Tuesday
	Wednesday
	Thursday
	Friday
	Saturday
)
```

é€šå¸¸ä¼šä¸ºWeekdayç±»å‹æ‰‹å†™Stringæ–¹æ³•ï¼Œè¿™æ ·åœ¨æ‰“å°ä¸Šé¢æšä¸¾å¸¸é‡æ—¶èƒ½è¾“å‡ºæœ‰æ„ä¹‰çš„å†…å®¹ï¼š

```go
func (d Weekday) String() string {
	switch d {
	case Sunday:
		return "Sunday"
	case Monday:
		return "Monday"
	case Tuesday:
		return "Tuesday"
	case Wednesday:
		return "Wednesday"
	case Thursday:
		return "Thursday"
	case Friday:
		return "Friday"
	case Saturday:
		return "Saturday"
	}

	return "Sunday" //default 0 -> "Sunday"
}
```

å¦‚æœä¸€ä¸ªé¡¹ç›®ä¸­æšä¸¾å¸¸é‡ç±»å‹æœ‰å¾ˆå¤šï¼Œé€ä¸ªä¸ºå…¶æ‰‹å†™Stringæ–¹æ³•è´¹æ—¶è´¹åŠ›ã€‚å½“æšä¸¾å¸¸é‡æœ‰å˜åŒ–çš„æ—¶å€™ï¼Œæ‰‹åŠ¨ç»´æŠ¤Stringæ–¹æ³•ååˆ†çƒ¦çä¸”æ˜“é”™ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œä½¿ç”¨go generateé©±åŠ¨stringerå·¥å…·ä¸ºè¿™äº›æšä¸¾ç±»å‹è‡ªåŠ¨ç”ŸæˆStringæ–¹æ³•çš„å®ç°ä¸å¤±ä¸ºä¸€ä¸ªè¾ƒä¸ºç†æƒ³çš„æ–¹æ¡ˆã€‚

å¯¹ä¸Šé¢ç¤ºä¾‹çš„æ”¹é€ ï¼š

```go
package main

import "fmt"

type Weekday int

const (
	Sunday Weekday = iota
	Monday
	Tuesday
	Wednesday
	Thursday
	Friday
	Saturday
)

//go:generate stringer -type=Weekday
func main() {
	var d Weekday
	fmt.Println(d)
	fmt.Println(Weekday(1))
}
```



```go
$ go generate main.go 
```

ç”Ÿæˆä¸€ä¸ªweekday_string.go æ–‡ä»¶ï¼š

```go
// Code generated by "stringer -type=Weekday"; DO NOT EDIT.

package main

import "strconv"

func _() {
	// An "invalid array index" compiler error signifies that the constant values have changed.
	// Re-run the stringer command to generate them again.
	var x [1]struct{}
	_ = x[Sunday-0]
	_ = x[Monday-1]
	_ = x[Tuesday-2]
	_ = x[Wednesday-3]
	_ = x[Thursday-4]
	_ = x[Friday-5]
	_ = x[Saturday-6]
}

const _Weekday_name = "SundayMondayTuesdayWednesdayThursdayFridaySaturday"

var _Weekday_index = [...]uint8{0, 6, 12, 19, 28, 36, 42, 50}

func (i Weekday) String() string {
	if i < 0 || i >= Weekday(len(_Weekday_index)-1) {
		return "Weekday(" + strconv.FormatInt(int64(i), 10) + ")"
	}
	return _Weekday_name[_Weekday_index[i]:_Weekday_index[i+1]]
}
```

ç¼–è¯‘æ‰§è¡Œï¼š

```sh
$ go build
$ ./enum-demo         
Sunday
Monday
```



#### 2 go generateé©±åŠ¨ä»é™æ€èµ„æºæ–‡ä»¶æ•°æ®åˆ°Goæºç çš„è½¬æ¢

è¯­è¨€çš„ä¼˜ç‚¹ä¹‹ä¸€æ˜¯å¯ä»¥å°†æºç ç¼–è¯‘æˆä¸€ä¸ªå¯¹å¤–éƒ¨æ²¡æœ‰ä»»ä½•ä¾èµ–æˆ–åªæœ‰è¾ƒå°‘ä¾èµ–çš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿™å¤§å¤§é™ä½äº†Gopheråœ¨éƒ¨ç½²é˜¶æ®µçš„å¿ƒæ™ºè´Ÿæ‹…ã€‚è€Œä¸ºäº†å°†è¿™ä¸€ä¼˜åŠ¿å‘æŒ¥åˆ°æè‡´ï¼ŒGoç¤¾åŒºç”šè‡³å¼€å§‹ç€æ‰‹å°†é™æ€èµ„æºæ–‡ä»¶ä¹ŸåµŒå…¥å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå°¤å…¶æ˜¯åœ¨Webå¼€å‘é¢†åŸŸï¼ŒGopherå¸Œæœ›å°†ä¸€äº›é™æ€èµ„æºæ–‡ä»¶ï¼ˆæ¯”å¦‚CSSæ–‡ä»¶ç­‰ï¼‰åµŒå…¥æœ€ç»ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ä¸€èµ·å‘å¸ƒå’Œéƒ¨ç½²ã€‚

åˆ©ç”¨go-bindataå·¥å…·å°†æ•°æ®æ–‡ä»¶åµŒå…¥Goæºç ä¸­ã€‚å®‰è£…ï¼š`go get -u github.com/go-bindata/go-bindata/...`æˆ–è€…`go install github.com/go-bindata/go-bindata/v3/go-bindata@latest`ã€‚

> è¯´æ˜ï¼šGo 1.16ç‰ˆæœ¬å†…ç½®äº†é™æ€æ–‡ä»¶åµŒå…¥ï¼ˆembeddingï¼‰åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨Goæºç ä¸­é€šè¿‡`go:embed`æŒ‡ç¤ºç¬¦å°†é™æ€èµ„æºæ–‡ä»¶åµŒå…¥ï¼Œæ— é¡»å†ä½¿ç”¨æœ¬æ–¹æ³•ã€‚

```go
//go:generate go-bindata -o static.go static/img/go-mascot.jpg

func main() {
}
```

```sh
$ go generate  
```

go generateå‘½ä»¤ä¼šæ‰§è¡Œmain.goä¸­æŒ‡ç¤ºç¬¦ä¸­çš„å‘½ä»¤ï¼Œå³åŸºäºstatic/img/go-mascot.jpgæ–‡ä»¶æ•°æ®ç”Ÿæˆstatic.goæºæ–‡ä»¶ã€‚



```go
//go:generate go-bindata -o static.go static/img/go-mascot.jpg

func main() {
	data, err := Asset("static/img/go-mascot.jpg")
	if err != nil {
		fmt.Println("Asset invoke error:", err)
		return
	}

	http.HandleFunc("/", func(w http.ResponseWriter, req *http.Request) {
		w.Write(data)
	})

	http.ListenAndServe(":8080", nil)
}
```

```sh
$ go build
./bindata-demo
```

æ­¤æ—¶è®¿é—®localhost:8080å¯æŸ¥çœ‹å›¾ç‰‡ã€‚

è¿™æ—¶å³ä¾¿ä½ åˆ é™¤bindata-demo/static/imgç›®å½•ä¸‹çš„go-mascot.jpgä¹Ÿä¸ä¼šå½±å“åˆ°bindata-demoçš„åº”ç­”è¿”å›ç»“æœï¼Œå› ä¸ºå›¾ç‰‡æ•°æ®å·²ç»åµŒå…¥bindata-demoè¿™ä¸ªäºŒè¿›åˆ¶ç¨‹åºå½“ä¸­äº†ï¼Œgo-mascot.jpgå°†éšç€bindata-demoè¿™ä¸ªäºŒè¿›åˆ¶ç¨‹åºä¸€å¹¶åˆ†å‘ä¸éƒ¨ç½²ã€‚

### å°ç»“

go generateè¿™ä¸ªå·¥å…·é€šå¸¸æ˜¯ç”±GoåŒ…çš„ä½œè€…ä½¿ç”¨å’Œæ‰§è¡Œçš„ï¼Œå…¶ç”Ÿæˆçš„Goæºç ä¸€èˆ¬ä¼šæäº¤åˆ°ä»£ç ä»“åº“ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯¹ç”Ÿæˆçš„åŒ…çš„ä½¿ç”¨è€…æ¥è¯´æ˜¯é€æ˜çš„ã€‚ä¸ºäº†æé†’ä½¿ç”¨è€…è¿™æ˜¯ä¸€ä¸ªä»£ç è‡ªåŠ¨ç”Ÿæˆçš„æºæ–‡ä»¶ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šåœ¨æºæ–‡ä»¶çš„å¼€å§‹å¤„ä»¥æ³¨é‡Šçš„å½¢å¼å†™å…¥ç±»ä¼¼ä¸‹é¢çš„æ–‡å­—ï¼š

```go
// Code generated by XXX. DO NOT EDIT.
```



## 73 å†…å­˜ç®¡ç†

refï¼š[ã€ŠGoè¯­è¨€è®¾è®¡ä¸å®ç°ã€‹7ç« ](https://draven.co/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/)

### 73.1 å†…å­˜åˆ†é…å™¨

ç¨‹åºä¸­çš„æ•°æ®å’Œå˜é‡éƒ½ä¼šè¢«åˆ†é…åˆ°ç¨‹åºæ‰€åœ¨çš„è™šæ‹Ÿå†…å­˜ä¸­ï¼Œå†…å­˜ç©ºé—´åŒ…å«ä¸¤ä¸ªé‡è¦åŒºåŸŸï¼š**æ ˆåŒºï¼ˆStackï¼‰å’Œå †åŒºï¼ˆHeapï¼‰**ã€‚<u>å‡½æ•°è°ƒç”¨çš„å‚æ•°ã€è¿”å›å€¼ä»¥åŠå±€éƒ¨å˜é‡</u>å¤§éƒ½ä¼šè¢«åˆ†é…åˆ°æ ˆä¸Šï¼Œè¿™éƒ¨åˆ†å†…å­˜ä¼šç”±**ç¼–è¯‘å™¨**è¿›è¡Œç®¡ç†ï¼›ä¸åŒç¼–ç¨‹è¯­è¨€ä½¿ç”¨ä¸åŒçš„æ–¹æ³•**ç®¡ç†å †åŒºçš„å†…å­˜**ï¼ŒC++ç­‰ç¼–ç¨‹è¯­è¨€ä¼šç”±å·¥ç¨‹å¸ˆä¸»åŠ¨ç”³è¯·å’Œé‡Šæ”¾å†…å­˜ï¼ŒGo ä»¥åŠ Java ç­‰ç¼–ç¨‹è¯­è¨€ä¼šç”±**å·¥ç¨‹å¸ˆå’Œç¼–è¯‘å™¨å…±åŒç®¡ç†**ï¼Œå †ä¸­çš„å¯¹è±¡ç”±**å†…å­˜åˆ†é…å™¨**åˆ†é…å¹¶ç”±åƒåœ¾æ”¶é›†å™¨å›æ”¶ã€‚

ä¸åŒçš„ç¼–ç¨‹è¯­è¨€ä¼šé€‰æ‹©ä¸åŒçš„æ–¹å¼ç®¡ç†å†…å­˜ï¼Œæœ¬èŠ‚ä¼šä»‹ç»Goè¯­è¨€å†…å­˜åˆ†é…å™¨ï¼Œè¯¦ç»†åˆ†æå†…å­˜åˆ†é…çš„è¿‡ç¨‹ä»¥åŠå…¶èƒŒåçš„è®¾è®¡ä¸å®ç°åŸç†ã€‚

#### 73.1.1 è®¾è®¡åŸç†

å†…å­˜ç®¡ç†ä¸€èˆ¬åŒ…å«ä¸‰ä¸ªä¸åŒçš„ç»„ä»¶ï¼Œåˆ†åˆ«æ˜¯==ç”¨æˆ·ç¨‹åºï¼ˆMutatorï¼‰==ã€==åˆ†é…å™¨ï¼ˆAllocatorï¼‰==å’Œ==æ”¶é›†å™¨ï¼ˆCollector)==ï¼Œå½“ç”¨æˆ·ç¨‹åºç”³è¯·å†…å­˜æ—¶ï¼Œå®ƒä¼šé€šè¿‡å†…å­˜åˆ†é…å™¨ç”³è¯·æ–°å†…å­˜ï¼Œè€Œåˆ†é…å™¨ä¼šè´Ÿè´£ä»å †ä¸­åˆå§‹åŒ–ç›¸åº”çš„å†…å­˜åŒºåŸŸã€‚

Goè¯­è¨€çš„å†…å­˜åˆ†é…å™¨å®ç°éå¸¸å¤æ‚ã€‚

##### 1ï¸âƒ£åˆ†é…æ–¹æ³•

ç¼–ç¨‹è¯­è¨€çš„å†…å­˜åˆ†é…å™¨ä¸€èˆ¬åŒ…å«ä¸¤ç§åˆ†é…æ–¹æ³•ï¼Œ

- ä¸€ç§æ˜¯**çº¿æ€§åˆ†é…å™¨ï¼ˆSequential Allocatorï¼ŒBump Allocatorï¼‰**ï¼Œ
- å¦ä¸€ç§æ˜¯**ç©ºé—²é“¾è¡¨åˆ†é…å™¨ï¼ˆFree-List Allocatorï¼‰**ï¼Œ

è¿™ä¸¤ç§åˆ†é…æ–¹æ³•æœ‰ç€ä¸åŒçš„å®ç°æœºåˆ¶å’Œç‰¹æ€§ã€‚

###### çº¿æ€§åˆ†é…å™¨

çº¿æ€§åˆ†é…ï¼ˆBump Allocatorï¼‰æ˜¯ä¸€ç§é«˜æ•ˆçš„å†…å­˜åˆ†é…æ–¹æ³•ï¼Œä½†æ˜¯æœ‰è¾ƒå¤§çš„å±€é™æ€§ã€‚å½“æˆ‘ä»¬ä½¿ç”¨çº¿æ€§åˆ†é…å™¨æ—¶ï¼Œåªéœ€è¦åœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªæŒ‡å‘å†…å­˜ç‰¹å®šä½ç½®çš„æŒ‡é’ˆï¼Œå¦‚æœç”¨æˆ·ç¨‹åºå‘åˆ†é…å™¨ç”³è¯·å†…å­˜ï¼Œåˆ†é…å™¨åªéœ€è¦æ£€æŸ¥å‰©ä½™çš„ç©ºé—²å†…å­˜ã€è¿”å›åˆ†é…çš„å†…å­˜åŒºåŸŸå¹¶ä¿®æ”¹æŒ‡é’ˆåœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œå³ç§»åŠ¨ä¸‹å›¾ä¸­çš„æŒ‡é’ˆï¼š

![](images/image-20250807214234348.png)

è™½ç„¶çº¿æ€§åˆ†é…å™¨å®ç°ä¸ºå®ƒå¸¦æ¥äº†è¾ƒå¿«çš„æ‰§è¡Œé€Ÿåº¦ä»¥åŠè¾ƒä½çš„å®ç°å¤æ‚åº¦ï¼Œä½†æ˜¯çº¿æ€§åˆ†é…å™¨**æ— æ³•åœ¨å†…å­˜è¢«é‡Šæ”¾æ—¶é‡ç”¨å†…å­˜**ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¦‚æœå·²ç»åˆ†é…çš„å†…å­˜è¢«å›æ”¶ï¼Œçº¿æ€§åˆ†é…å™¨æ— æ³•é‡æ–°åˆ©ç”¨çº¢è‰²çš„å†…å­˜ï¼š

![](images/image-20250807214323841.png)

å› ä¸ºçº¿æ€§åˆ†é…å™¨å…·æœ‰ä¸Šè¿°ç‰¹æ€§ï¼Œæ‰€ä»¥**éœ€è¦ä¸åˆé€‚çš„åƒåœ¾å›æ”¶ç®—æ³•é…åˆä½¿ç”¨**ï¼Œä¾‹å¦‚ï¼š**æ ‡è®°å‹ç¼©ï¼ˆMark-Compactï¼‰ã€å¤åˆ¶å›æ”¶ï¼ˆCopying GCï¼‰å’Œåˆ†ä»£å›æ”¶ï¼ˆGenerational GCï¼‰**ç­‰ç®—æ³•ï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡æ‹·è´çš„æ–¹å¼æ•´ç†å­˜æ´»å¯¹è±¡çš„ç¢ç‰‡ï¼Œå°†ç©ºé—²å†…å­˜å®šæœŸåˆå¹¶ï¼Œè¿™æ ·å°±èƒ½åˆ©ç”¨çº¿æ€§åˆ†é…å™¨çš„æ•ˆç‡æå‡å†…å­˜åˆ†é…å™¨çš„æ€§èƒ½äº†ã€‚

å› ä¸ºçº¿æ€§åˆ†é…å™¨éœ€è¦ä¸å…·æœ‰**æ‹·è´ç‰¹æ€§**çš„åƒåœ¾å›æ”¶ç®—æ³•é…åˆï¼Œæ‰€ä»¥ C å’Œ C++ ç­‰éœ€è¦**ç›´æ¥å¯¹å¤–æš´éœ²æŒ‡é’ˆ**çš„è¯­è¨€å°±æ— æ³•ä½¿ç”¨è¯¥ç­–ç•¥ã€‚

###### ç©ºé—²é“¾è¡¨åˆ†é…å™¨

ç©ºé—²é“¾è¡¨åˆ†é…å™¨ï¼ˆFree-List Allocatorï¼‰å¯ä»¥é‡ç”¨å·²ç»è¢«é‡Šæ”¾çš„å†…å­˜ï¼Œå®ƒåœ¨å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ªç±»ä¼¼é“¾è¡¨çš„æ•°æ®ç»“æ„ã€‚å½“ç”¨æˆ·ç¨‹åºç”³è¯·å†…å­˜æ—¶ï¼Œ**ç©ºé—²é“¾è¡¨**åˆ†é…å™¨ä¼šä¾æ¬¡éå†ç©ºé—²çš„å†…å­˜å—ï¼Œæ‰¾åˆ°è¶³å¤Ÿå¤§çš„å†…å­˜ï¼Œç„¶åç”³è¯·æ–°çš„èµ„æºå¹¶ä¿®æ”¹é“¾è¡¨ï¼š

![free-list-allocator](images/2020-02-29-15829868066446-free-list-allocator.png)

å› ä¸ºä¸åŒçš„å†…å­˜å—é€šè¿‡æŒ‡é’ˆæ„æˆäº†é“¾è¡¨ï¼Œæ‰€ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼çš„åˆ†é…å™¨å¯ä»¥é‡æ–°åˆ©ç”¨å›æ”¶çš„èµ„æºï¼Œä½†æ˜¯å› ä¸ºåˆ†é…å†…å­˜æ—¶éœ€è¦éå†é“¾è¡¨ï¼Œæ‰€ä»¥å®ƒçš„æ—¶é—´å¤æ‚åº¦æ˜¯ ğ‘‚(ğ‘›)ã€‚ç©ºé—²é“¾è¡¨åˆ†é…å™¨å¯ä»¥é€‰æ‹©**ä¸åŒçš„ç­–ç•¥åœ¨é“¾è¡¨ä¸­çš„å†…å­˜å—ä¸­è¿›è¡Œé€‰æ‹©**ï¼Œæœ€å¸¸è§çš„æ˜¯ä»¥ä¸‹å››ç§ï¼š

- é¦–æ¬¡é€‚åº”ï¼ˆFirst-Fitï¼‰â€” ä»é“¾è¡¨å¤´å¼€å§‹éå†ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¤§å°å¤§äºç”³è¯·å†…å­˜çš„å†…å­˜å—ï¼›
- å¾ªç¯é¦–æ¬¡é€‚åº”ï¼ˆNext-Fitï¼‰â€” ä»ä¸Šæ¬¡éå†çš„ç»“æŸä½ç½®å¼€å§‹éå†ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¤§å°å¤§äºç”³è¯·å†…å­˜çš„å†…å­˜å—ï¼›
- æœ€ä¼˜é€‚åº”ï¼ˆBest-Fitï¼‰â€” ä»é“¾è¡¨å¤´éå†æ•´ä¸ªé“¾è¡¨ï¼Œé€‰æ‹©æœ€åˆé€‚çš„å†…å­˜å—ï¼›
- ==éš”ç¦»é€‚åº”ï¼ˆSegregated-Fitï¼‰==â€” å°†å†…å­˜åˆ†å‰²æˆå¤šä¸ªé“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨ä¸­çš„å†…å­˜å—å¤§å°ç›¸åŒï¼Œç”³è¯·å†…å­˜æ—¶å…ˆæ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„é“¾è¡¨ï¼Œå†ä»é“¾è¡¨ä¸­é€‰æ‹©åˆé€‚çš„å†…å­˜å—ï¼›

Goè¯­è¨€ä½¿ç”¨çš„å†…å­˜åˆ†é…ç­–ç•¥ä¸ç¬¬å››ç§ç­–ç•¥æœ‰äº›ç›¸ä¼¼ï¼š

![](images/image-20250807214654652.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¯¥ç­–ç•¥ä¼šå°†å†…å­˜åˆ†å‰²æˆç”± 4ã€8ã€16ã€32 å­—èŠ‚çš„å†…å­˜å—ç»„æˆçš„é“¾è¡¨ï¼Œå½“æˆ‘ä»¬å‘å†…å­˜åˆ†é…å™¨ç”³è¯· 8 å­—èŠ‚çš„å†…å­˜æ—¶ï¼Œå®ƒä¼šåœ¨ä¸Šå›¾ä¸­æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„ç©ºé—²å†…å­˜å—å¹¶è¿”å›ã€‚éš”ç¦»é€‚åº”çš„åˆ†é…ç­–ç•¥å‡å°‘äº†éœ€è¦éå†çš„å†…å­˜å—æ•°é‡ï¼Œæé«˜äº†å†…å­˜åˆ†é…çš„æ•ˆç‡ã€‚

##### 2ï¸âƒ£åˆ†çº§åˆ†é…

çº¿ç¨‹ç¼“å­˜åˆ†é…ï¼ˆThread-Caching Mallocï¼ŒTCMallocï¼‰æ˜¯ç”¨äºåˆ†é…å†…å­˜çš„æœºåˆ¶ï¼Œå®ƒæ¯”`glibc`ä¸­çš„`malloc`è¿˜è¦å¿«å¾ˆå¤šã€‚Goè¯­è¨€çš„å†…å­˜åˆ†é…å™¨å°±å€Ÿé‰´äº† `TCMalloc`çš„è®¾è®¡å®ç°é«˜é€Ÿçš„å†…å­˜åˆ†é…ï¼Œå®ƒçš„æ ¸å¿ƒç†å¿µæ˜¯**ä½¿ç”¨å¤šçº§ç¼“å­˜å°†å¯¹è±¡æ ¹æ®å¤§å°åˆ†ç±»ï¼Œå¹¶æŒ‰ç…§ç±»åˆ«å®æ–½ä¸åŒçš„åˆ†é…ç­–ç•¥**ã€‚

###### å¯¹è±¡å¤§å°

Goè¯­è¨€çš„å†…å­˜åˆ†é…å™¨ä¼šæ ¹æ®ç”³è¯·åˆ†é…çš„å†…å­˜å¤§å°é€‰æ‹©ä¸åŒçš„å¤„ç†é€»è¾‘ï¼Œè¿è¡Œæ—¶æ ¹æ®å¯¹è±¡çš„å¤§å°å°†å¯¹è±¡åˆ†æˆå¾®å¯¹è±¡ã€å°å¯¹è±¡å’Œå¤§å¯¹è±¡ä¸‰ç§ï¼š

|  ç±»åˆ«  |     å¤§å°      |
| :----: | :-----------: |
| å¾®å¯¹è±¡ |  `(0, 16B)`   |
| å°å¯¹è±¡ | `[16B, 32KB]` |
| å¤§å¯¹è±¡ | `(32KB, +âˆ)`  |

å› ä¸ºç¨‹åºä¸­çš„ç»å¤§å¤šæ•°å¯¹è±¡çš„å¤§å°éƒ½åœ¨32KBä»¥ä¸‹ï¼Œè€Œç”³è¯·çš„å†…å­˜å¤§å°å½±å“Goè¯­è¨€è¿è¡Œæ—¶åˆ†é…å†…å­˜çš„è¿‡ç¨‹å’Œå¼€é”€ï¼Œæ‰€ä»¥åˆ†åˆ«å¤„ç†å¤§å¯¹è±¡å’Œå°å¯¹è±¡æœ‰åˆ©äºæé«˜å†…å­˜åˆ†é…å™¨çš„æ€§èƒ½ã€‚

###### å¤šçº§ç¼“å­˜

å†…å­˜åˆ†é…å™¨ä¸ä»…ä¼šåŒºåˆ«å¯¹å¾…å¤§å°ä¸åŒçš„å¯¹è±¡ï¼Œè¿˜ä¼šå°†å†…å­˜åˆ†æˆä¸åŒçš„çº§åˆ«åˆ†åˆ«ç®¡ç†ï¼ŒTCMallocå’ŒGoè¿è¡Œæ—¶åˆ†é…å™¨éƒ½ä¼šå¼•å…¥**çº¿ç¨‹ç¼“å­˜ï¼ˆThread Cacheï¼‰ã€ä¸­å¿ƒç¼“å­˜ï¼ˆCentral Cacheï¼‰å’Œé¡µå †ï¼ˆPage Heapï¼‰**ä¸‰ä¸ªç»„ä»¶åˆ†çº§ç®¡ç†å†…å­˜ï¼š

![](images/image-20250807215051784.png)

**çº¿ç¨‹ç¼“å­˜å±äºæ¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ï¼Œå®ƒèƒ½å¤Ÿæ»¡è¶³çº¿ç¨‹ä¸Šç»å¤§å¤šæ•°çš„å†…å­˜åˆ†é…éœ€æ±‚ï¼Œå› ä¸ºä¸æ¶‰åŠå¤šçº¿ç¨‹ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦ä½¿ç”¨äº’æ–¥é”æ¥ä¿æŠ¤å†…å­˜ï¼Œè¿™èƒ½å¤Ÿå‡å°‘é”ç«äº‰å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚å½“çº¿ç¨‹ç¼“å­˜ä¸èƒ½æ»¡è¶³éœ€æ±‚æ—¶ï¼Œè¿è¡Œæ—¶ä¼šä½¿ç”¨ä¸­å¿ƒç¼“å­˜ä½œä¸ºè¡¥å……è§£å†³å°å¯¹è±¡çš„å†…å­˜åˆ†é…ï¼Œåœ¨é‡åˆ° 32KB ä»¥ä¸Šçš„å¯¹è±¡æ—¶ï¼Œå†…å­˜åˆ†é…å™¨ä¼šé€‰æ‹©é¡µå †ç›´æ¥åˆ†é…å¤§å†…å­˜ã€‚**

è¿™ç§å¤šå±‚çº§çš„å†…å­˜åˆ†é…è®¾è®¡ä¸è®¡ç®—æœºæ“ä½œç³»ç»Ÿä¸­çš„**å¤šçº§ç¼“å­˜**æœ‰äº›ç±»ä¼¼ï¼Œå› ä¸ºå¤šæ•°çš„å¯¹è±¡éƒ½æ˜¯å°å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡çº¿ç¨‹ç¼“å­˜å’Œä¸­å¿ƒç¼“å­˜æä¾›è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ï¼Œå‘ç°èµ„æºä¸è¶³æ—¶ä»ä¸Šä¸€çº§ç»„ä»¶ä¸­è·å–æ›´å¤šçš„å†…å­˜èµ„æºã€‚

##### 3ï¸âƒ£è™šæ‹Ÿå†…å­˜å¸ƒå±€

è¿™é‡Œä¼šä»‹ç»Goè¯­è¨€å †åŒºå†…å­˜åœ°å€ç©ºé—´çš„è®¾è®¡ä»¥åŠæ¼”è¿›è¿‡ç¨‹ï¼Œåœ¨ Go è¯­è¨€ 1.10 ä»¥å‰çš„ç‰ˆæœ¬ï¼Œå †åŒºçš„å†…å­˜ç©ºé—´éƒ½æ˜¯è¿ç»­çš„ï¼›ä½†æ˜¯åœ¨ 1.11 ç‰ˆæœ¬ï¼ŒGo å›¢é˜Ÿä½¿ç”¨**ç¨€ç–çš„å †å†…å­˜**ç©ºé—´æ›¿ä»£äº†è¿ç»­çš„å†…å­˜ï¼Œè§£å†³äº†è¿ç»­å†…å­˜å¸¦æ¥çš„é™åˆ¶ä»¥åŠåœ¨ç‰¹æ®Šåœºæ™¯ä¸‹å¯èƒ½å‡ºç°çš„é—®é¢˜ã€‚

###### çº¿æ€§å†…å­˜

Go è¯­è¨€ç¨‹åºçš„ 1.10 ç‰ˆæœ¬åœ¨å¯åŠ¨æ—¶ä¼šåˆå§‹åŒ–æ•´ç‰‡è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œå¦‚ä¸‹æ‰€ç¤ºçš„ä¸‰ä¸ªåŒºåŸŸ `spans`ã€`bitmap` å’Œ `arena` åˆ†åˆ«é¢„ç•™äº† 512MBã€16GB ä»¥åŠ 512GB çš„å†…å­˜ç©ºé—´ï¼Œè¿™äº›å†…å­˜å¹¶ä¸æ˜¯çœŸæ­£å­˜åœ¨çš„ç‰©ç†å†…å­˜ï¼Œè€Œæ˜¯è™šæ‹Ÿå†…å­˜ï¼š

![](images/image-20250807215333666.png)

- spans åŒºåŸŸå­˜å‚¨äº†æŒ‡å‘å†…å­˜ç®¡ç†å•å…ƒ runtime.mspan çš„æŒ‡é’ˆï¼Œæ¯ä¸ªå†…å­˜å•å…ƒä¼šç®¡ç†å‡ é¡µçš„å†…å­˜ç©ºé—´ï¼Œæ¯é¡µå¤§å°ä¸º 8KBï¼›
- bitmap ç”¨äºæ ‡è¯† arena åŒºåŸŸä¸­çš„é‚£äº›åœ°å€ä¿å­˜äº†å¯¹è±¡ï¼Œä½å›¾ä¸­çš„æ¯ä¸ªå­—èŠ‚éƒ½ä¼šè¡¨ç¤ºå †åŒºä¸­çš„ 32 å­—èŠ‚æ˜¯å¦ç©ºé—²ï¼›
- arena åŒºåŸŸæ˜¯çœŸæ­£çš„å †åŒºï¼Œè¿è¡Œæ—¶ä¼šå°† 8KB çœ‹åšä¸€é¡µï¼Œè¿™äº›å†…å­˜é¡µä¸­å­˜å‚¨äº†æ‰€æœ‰åœ¨å †ä¸Šåˆå§‹åŒ–çš„å¯¹è±¡ï¼›

å¯¹äºä»»æ„ä¸€ä¸ªåœ°å€ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥æ ¹æ® arena çš„åŸºåœ°å€è®¡ç®—è¯¥åœ°å€æ‰€åœ¨çš„é¡µæ•°å¹¶é€šè¿‡ spans æ•°ç»„è·å¾—ç®¡ç†è¯¥ç‰‡å†…å­˜çš„ç®¡ç†å•å…ƒ `runtime.mspan`ï¼Œspans æ•°ç»„ä¸­å¤šä¸ªè¿ç»­çš„ä½ç½®å¯èƒ½å¯¹åº”åŒä¸€ä¸ª `runtime.mspan` ç»“æ„ã€‚

Go è¯­è¨€åœ¨åƒåœ¾å›æ”¶æ—¶ä¼šæ ¹æ®æŒ‡é’ˆçš„åœ°å€åˆ¤æ–­å¯¹è±¡æ˜¯å¦åœ¨å †ä¸­ï¼Œå¹¶é€šè¿‡ä¸Šä¸€æ®µä¸­ä»‹ç»çš„è¿‡ç¨‹æ‰¾åˆ°ç®¡ç†è¯¥å¯¹è±¡çš„ runtime.mspanã€‚è¿™äº›éƒ½å»ºç«‹åœ¨**å †åŒºçš„å†…å­˜æ˜¯è¿ç»­**çš„è¿™ä¸€å‡è®¾ä¸Šã€‚è¿™ç§è®¾è®¡è™½ç„¶ç®€å•å¹¶ä¸”æ–¹ä¾¿ï¼Œä½†æ˜¯åœ¨ C å’Œ Go æ··åˆä½¿ç”¨æ—¶ä¼šå¯¼è‡´ç¨‹åºå´©æºƒï¼š

1. åˆ†é…çš„å†…å­˜åœ°å€ä¼šå‘ç”Ÿå†²çªï¼Œå¯¼è‡´å †çš„åˆå§‹åŒ–å’Œæ‰©å®¹å¤±è´¥ï¼›
2. æ²¡æœ‰è¢«é¢„ç•™çš„å¤§å—å†…å­˜å¯èƒ½ä¼šè¢«åˆ†é…ç»™ C è¯­è¨€çš„äºŒè¿›åˆ¶ï¼Œå¯¼è‡´æ‰©å®¹åçš„å †ä¸è¿ç»­ï¼›

çº¿æ€§çš„å †å†…å­˜éœ€è¦é¢„ç•™å¤§å—çš„å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯ç”³è¯·å¤§å—çš„å†…å­˜ç©ºé—´è€Œä¸ä½¿ç”¨æ˜¯ä¸åˆ‡å®é™…çš„ï¼Œä¸é¢„ç•™å†…å­˜ç©ºé—´å´ä¼šåœ¨ç‰¹æ®Šåœºæ™¯ä¸‹é€ æˆç¨‹åºå´©æºƒã€‚è™½ç„¶è¿ç»­å†…å­˜çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯è¿™äº›é—®é¢˜ä¹Ÿæ²¡æœ‰åŠæ³•å¿½ç•¥ã€‚

###### ç¨€ç–å†…å­˜

ç¨€ç–å†…å­˜æ˜¯ Go è¯­è¨€åœ¨ 1.11 ä¸­æå‡ºçš„æ–¹æ¡ˆï¼Œä½¿ç”¨ç¨€ç–çš„å†…å­˜å¸ƒå±€ä¸ä»…èƒ½ç§»é™¤å †å¤§å°çš„ä¸Šé™5ï¼Œè¿˜èƒ½è§£å†³ C å’Œ Go æ··åˆä½¿ç”¨æ—¶çš„åœ°å€ç©ºé—´å†²çªé—®é¢˜6ã€‚ä¸è¿‡å› ä¸ºåŸºäºç¨€ç–å†…å­˜çš„å†…å­˜ç®¡ç†å¤±å»äº†å†…å­˜çš„è¿ç»­æ€§è¿™ä¸€å‡è®¾ï¼Œè¿™ä¹Ÿä½¿å†…å­˜ç®¡ç†å˜å¾—æ›´åŠ å¤æ‚ï¼š

![](images/image-20250807215553762.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¿è¡Œæ—¶ä½¿ç”¨äºŒç»´çš„ [`runtime.heapArena`](https://draven.co/golang/tree/runtime.heapArena) æ•°ç»„ç®¡ç†æ‰€æœ‰çš„å†…å­˜ï¼Œæ¯ä¸ªå•å…ƒéƒ½ä¼šç®¡ç† 64MB çš„å†…å­˜ç©ºé—´ï¼š

```go
type heapArena struct {
	bitmap       [heapArenaBitmapBytes]byte
	spans        [pagesPerArena]*mspan
	pageInUse    [pagesPerArena / 8]uint8
	pageMarks    [pagesPerArena / 8]uint8
	pageSpecials [pagesPerArena / 8]uint8
	checkmarks   *checkmarksMap
	zeroedBase   uintptr
}
```

è¯¥ç»“æ„ä½“ä¸­çš„ `bitmap` å’Œ `spans` ä¸çº¿æ€§å†…å­˜ä¸­çš„ `bitmap` å’Œ `spans` åŒºåŸŸä¸€ä¸€å¯¹åº”ï¼Œ`zeroedBase` å­—æ®µæŒ‡å‘äº†è¯¥ç»“æ„ä½“ç®¡ç†çš„å†…å­˜çš„åŸºåœ°å€ã€‚ä¸Šè¿°è®¾è®¡å°†åŸæœ‰çš„è¿ç»­å¤§å†…å­˜åˆ‡åˆ†æˆç¨€ç–çš„å°å†…å­˜ï¼Œè€Œç”¨äºç®¡ç†è¿™äº›å†…å­˜çš„å…ƒä¿¡æ¯ä¹Ÿè¢«åˆ‡æˆäº†å°å—ã€‚

ä¸åŒå¹³å°å’Œæ¶æ„çš„äºŒç»´æ•°ç»„å¤§å°å¯èƒ½å®Œå…¨ä¸åŒï¼Œå¦‚æœæˆ‘ä»¬çš„ Go è¯­è¨€æœåŠ¡åœ¨ Linux çš„ x86-64 æ¶æ„ä¸Šè¿è¡Œï¼ŒäºŒç»´æ•°ç»„çš„ä¸€ç»´å¤§å°ä¼šæ˜¯ 1ï¼Œè€ŒäºŒç»´å¤§å°æ˜¯ 4,194,304ï¼Œå› ä¸ºæ¯ä¸€ä¸ªæŒ‡é’ˆå ç”¨ 8 å­—èŠ‚çš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥å…ƒä¿¡æ¯çš„æ€»å¤§å°ä¸º 32MBã€‚ç”±äºæ¯ä¸ª [`runtime.heapArena`](https://draven.co/golang/tree/runtime.heapArena) éƒ½ä¼šç®¡ç† 64MB çš„å†…å­˜ï¼Œæ•´ä¸ªå †åŒºæœ€å¤šå¯ä»¥ç®¡ç† 256TB çš„å†…å­˜ï¼Œè¿™æ¯”ä¹‹å‰çš„ 512GB å¤šå¥½å‡ ä¸ªæ•°é‡çº§ã€‚

Go è¯­è¨€å›¢é˜Ÿåœ¨ 1.11 ç‰ˆæœ¬ä¸­é€šè¿‡ä»¥ä¸‹å‡ ä¸ªæäº¤å°†çº¿æ€§å†…å­˜å˜æˆç¨€ç–å†…å­˜ï¼Œç§»é™¤äº† 512GB çš„å†…å­˜ä¸Šé™ä»¥åŠå †åŒºå†…å­˜è¿ç»­æ€§çš„å‡è®¾ï¼š

- [runtime: use sparse mappings for the heap](https://github.com/golang/go/commit/2b415549b813ba36caafa34fc34d72e47ee8335c)
- [runtime: fix various contiguous bitmap assumptions](https://github.com/golang/go/commit/f61057c497e9ccb88dae093778d97aeee941af13)
- [runtime: make the heap bitmap sparse](https://github.com/golang/go/commit/c0392d2e7fbdcd38aafb959e94daf6bbafe2e4e9)
- [runtime: abstract remaining mheap.spans access](https://github.com/golang/go/commit/0de5324d61ba6d4c362f9fa76b6522e28155c83d)
- [runtime: make span map sparse](https://github.com/golang/go/commit/d6e821858157b7cb4ece22fcc1a5c8604478ebaa)
- [runtime: eliminate most uses of mheap*.arena**](https://github.com/golang/go/commit/45ffeab549fa4b03b231a0872025364e13c7f7f0)
- [runtime: remove non-reserved heap logic](https://github.com/golang/go/commit/51ae88ee2f9a1063c272a497527751d786291c89)
- [runtime: move comment about address space sizes to malloc.go](https://github.com/golang/go/commit/90666b8a3d5545f4295d9c2517ad607ce5d45e52)

ç”±äºå†…å­˜çš„ç®¡ç†å˜å¾—æ›´åŠ å¤æ‚ï¼Œä¸Šè¿°æ”¹åŠ¨å¯¹åƒåœ¾å›æ”¶ç¨æœ‰å½±å“ï¼Œå¤§çº¦ä¼šå¢åŠ  1% çš„åƒåœ¾å›æ”¶å¼€é”€ï¼Œä¸è¿‡è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸ºäº†è§£å†³å·²æœ‰é—®é¢˜å¿…é¡»ä»˜å‡ºçš„æˆæœ¬ã€‚

##### 4ï¸âƒ£åœ°å€ç©ºé—´

å› ä¸ºæ‰€æœ‰çš„å†…å­˜æœ€ç»ˆéƒ½æ˜¯è¦ä»æ“ä½œç³»ç»Ÿä¸­ç”³è¯·çš„ï¼Œæ‰€ä»¥Goè¯­è¨€çš„è¿è¡Œæ—¶æ„å»ºäº†**æ“ä½œç³»ç»Ÿçš„å†…å­˜ç®¡ç†æŠ½è±¡å±‚**ï¼Œè¯¥æŠ½è±¡å±‚å°†è¿è¡Œæ—¶ç®¡ç†çš„åœ°å€ç©ºé—´åˆ†æˆä»¥ä¸‹å››ç§çŠ¶æ€ï¼š

|    çŠ¶æ€    |                             è§£é‡Š                             |
| :--------: | :----------------------------------------------------------: |
|   `None`   |         å†…å­˜æ²¡æœ‰è¢«ä¿ç•™æˆ–è€…æ˜ å°„ï¼Œæ˜¯åœ°å€ç©ºé—´çš„é»˜è®¤çŠ¶æ€         |
| `Reserved` |        è¿è¡Œæ—¶æŒæœ‰è¯¥åœ°å€ç©ºé—´ï¼Œä½†æ˜¯è®¿é—®è¯¥å†…å­˜ä¼šå¯¼è‡´é”™è¯¯        |
| `Prepared` | å†…å­˜è¢«ä¿ç•™ï¼Œä¸€èˆ¬æ²¡æœ‰å¯¹åº”çš„ç‰©ç†å†…å­˜è®¿é—®è¯¥ç‰‡å†…å­˜çš„è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„å¯ä»¥å¿«é€Ÿè½¬æ¢åˆ° `Ready` çŠ¶æ€ |
|  `Ready`   |                        å¯ä»¥è¢«å®‰å…¨è®¿é—®                        |

æ¯ä¸ªä¸åŒçš„æ“ä½œç³»ç»Ÿéƒ½ä¼šåŒ…å«ä¸€ç»„ç”¨äºç®¡ç†å†…å­˜çš„ç‰¹å®šæ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¯ä»¥è®©å†…å­˜åœ°å€ç©ºé—´åœ¨ä¸åŒçš„çŠ¶æ€ä¹‹é—´è½¬æ¢ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹å›¾äº†è§£ä¸åŒçŠ¶æ€ä¹‹é—´çš„è½¬æ¢è¿‡ç¨‹ï¼š

![](images/image-20250807220011975.png)

è¿è¡Œæ—¶ä¸­åŒ…å«å¤šä¸ªæ“ä½œç³»ç»Ÿå®ç°çš„çŠ¶æ€è½¬æ¢æ–¹æ³•ï¼Œæ‰€æœ‰çš„å®ç°éƒ½åŒ…å«åœ¨ä»¥ `mem_` å¼€å¤´çš„æ–‡ä»¶ä¸­ï¼Œæœ¬èŠ‚å°†ä»‹ç» Linux æ“ä½œç³»ç»Ÿå¯¹ä¸Šå›¾ä¸­æ–¹æ³•çš„å®ç°ï¼šğŸ”–

- [`runtime.sysAlloc`](https://draven.co/golang/tree/runtime.sysAlloc) ä¼šä»æ“ä½œç³»ç»Ÿä¸­è·å–ä¸€å¤§å—å¯ç”¨çš„å†…å­˜ç©ºé—´ï¼Œå¯èƒ½ä¸ºå‡ ç™¾ KB æˆ–è€…å‡  MBï¼›
- [`runtime.sysFree`](https://draven.co/golang/tree/runtime.sysFree) ä¼šåœ¨ç¨‹åºå‘ç”Ÿå†…å­˜ä¸è¶³ï¼ˆOut-of Memoryï¼ŒOOMï¼‰æ—¶è°ƒç”¨å¹¶æ— æ¡ä»¶åœ°è¿”å›å†…å­˜ï¼›
- [`runtime.sysReserve`](https://draven.co/golang/tree/runtime.sysReserve) ä¼šä¿ç•™æ“ä½œç³»ç»Ÿä¸­çš„ä¸€ç‰‡å†…å­˜åŒºåŸŸï¼Œè®¿é—®è¿™ç‰‡å†…å­˜ä¼šè§¦å‘å¼‚å¸¸ï¼›
- [`runtime.sysMap`](https://draven.co/golang/tree/runtime.sysMap) ä¿è¯å†…å­˜åŒºåŸŸå¯ä»¥å¿«é€Ÿè½¬æ¢è‡³å°±ç»ªçŠ¶æ€ï¼›
- [`runtime.sysUsed`](https://draven.co/golang/tree/runtime.sysUsed) é€šçŸ¥æ“ä½œç³»ç»Ÿåº”ç”¨ç¨‹åºéœ€è¦ä½¿ç”¨è¯¥å†…å­˜åŒºåŸŸï¼Œä¿è¯å†…å­˜åŒºåŸŸå¯ä»¥å®‰å…¨è®¿é—®ï¼›
- [`runtime.sysUnused`](https://draven.co/golang/tree/runtime.sysUnused) é€šçŸ¥æ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜å¯¹åº”çš„ç‰©ç†å†…å­˜å·²ç»ä¸å†éœ€è¦ï¼Œå¯ä»¥é‡ç”¨ç‰©ç†å†…å­˜ï¼›
- [`runtime.sysFault`](https://draven.co/golang/tree/runtime.sysFault) å°†å†…å­˜åŒºåŸŸè½¬æ¢æˆä¿ç•™çŠ¶æ€ï¼Œä¸»è¦ç”¨äºè¿è¡Œæ—¶çš„è°ƒè¯•ï¼›

è¿è¡Œæ—¶ä½¿ç”¨ Linux æä¾›çš„ `mmap`ã€`munmap` å’Œ `madvise` ç­‰ç³»ç»Ÿè°ƒç”¨å®ç°äº†æ“ä½œç³»ç»Ÿçš„å†…å­˜ç®¡ç†æŠ½è±¡å±‚ï¼ŒæŠ¹å¹³äº†ä¸åŒæ“ä½œç³»ç»Ÿçš„å·®å¼‚ï¼Œä¸ºè¿è¡Œæ—¶æä¾›äº†æ›´åŠ æ–¹ä¾¿çš„æ¥å£ï¼Œé™¤äº† Linux ä¹‹å¤–ï¼Œè¿è¡Œæ—¶è¿˜å®ç°äº† BSDã€Darwinã€Plan9 ä»¥åŠ Windows ç­‰å¹³å°ä¸ŠæŠ½è±¡å±‚ã€‚

#### 73.1.2 å†…å­˜ç®¡ç†ç»„ä»¶

Go è¯­è¨€çš„å†…å­˜åˆ†é…å™¨åŒ…å«ï¼š**å†…å­˜ç®¡ç†å•å…ƒã€çº¿ç¨‹ç¼“å­˜ã€ä¸­å¿ƒç¼“å­˜å’Œé¡µå †**ï¼Œåˆ†åˆ«å¯¹åº”çš„æ•°æ®ç»“æ„ï¼š`runtime.mspan`ã€`runtime.mcache`ã€`runtime.mcentral` å’Œ `runtime.mheap`ã€‚

![å›¾ 7-10 Go ç¨‹åºçš„å†…å­˜å¸ƒå±€](images/image-20250807220146592.png)

æ‰€æœ‰çš„ Go è¯­è¨€ç¨‹åºéƒ½ä¼šåœ¨å¯åŠ¨æ—¶åˆå§‹åŒ–å¦‚ä¸Šå›¾æ‰€ç¤ºçš„å†…å­˜å¸ƒå±€ï¼Œæ¯ä¸€ä¸ªå¤„ç†å™¨éƒ½ä¼šåˆ†é…ä¸€ä¸ªçº¿ç¨‹ç¼“å­˜ [`runtime.mcache`](https://draven.co/golang/tree/runtime.mcache) ç”¨äºå¤„ç†å¾®å¯¹è±¡å’Œå°å¯¹è±¡çš„åˆ†é…ï¼Œå®ƒä»¬ä¼šæŒæœ‰å†…å­˜ç®¡ç†å•å…ƒ [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan)ã€‚

æ¯ä¸ªç±»å‹çš„å†…å­˜ç®¡ç†å•å…ƒéƒ½ä¼šç®¡ç†ç‰¹å®šå¤§å°çš„å¯¹è±¡ï¼Œå½“å†…å­˜ç®¡ç†å•å…ƒä¸­ä¸å­˜åœ¨ç©ºé—²å¯¹è±¡æ—¶ï¼Œå®ƒä»¬ä¼šä» [`runtime.mheap`](https://draven.co/golang/tree/runtime.mheap) æŒæœ‰çš„ 134 ä¸ªä¸­å¿ƒç¼“å­˜ [`runtime.mcentral`](https://draven.co/golang/tree/runtime.mcentral) ä¸­è·å–æ–°çš„å†…å­˜å•å…ƒï¼Œä¸­å¿ƒç¼“å­˜å±äºå…¨å±€çš„å †ç»“æ„ä½“ [`runtime.mheap`](https://draven.co/golang/tree/runtime.mheap)ï¼Œå®ƒä¼šä»æ“ä½œç³»ç»Ÿä¸­ç”³è¯·å†…å­˜ã€‚

åœ¨ amd64 çš„ Linux æ“ä½œç³»ç»Ÿä¸Šï¼Œ[`runtime.mheap`](https://draven.co/golang/tree/runtime.mheap) ä¼šæŒæœ‰ 4,194,304 [`runtime.heapArena`](https://draven.co/golang/tree/runtime.heapArena)ï¼Œæ¯ä¸ª [`runtime.heapArena`](https://draven.co/golang/tree/runtime.heapArena) éƒ½ä¼šç®¡ç† 64MB çš„å†…å­˜ï¼Œå•ä¸ª Go è¯­è¨€ç¨‹åºçš„å†…å­˜ä¸Šé™ä¹Ÿå°±æ˜¯ 256TBã€‚

##### 73.1.2.1 å†…å­˜ç®¡ç†å•å…ƒ

[`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) æ˜¯ Go è¯­è¨€å†…å­˜ç®¡ç†çš„åŸºæœ¬å•å…ƒï¼Œè¯¥ç»“æ„ä½“ä¸­åŒ…å« `next` å’Œ `prev` ä¸¤ä¸ªå­—æ®µï¼Œå®ƒä»¬åˆ†åˆ«æŒ‡å‘äº†å‰ä¸€ä¸ªå’Œåä¸€ä¸ª [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan)ï¼š

```go
type mspan struct {
	next *mspan
	prev *mspan
	...
}
```

ä¸²è”åçš„ä¸Šè¿°ç»“æ„ä½“ä¼šæ„æˆå¦‚ä¸‹åŒå‘é“¾è¡¨ï¼Œè¿è¡Œæ—¶ä¼šä½¿ç”¨ [`runtime.mSpanList`](https://draven.co/golang/tree/runtime.mSpanList) å­˜å‚¨åŒå‘é“¾è¡¨çš„å¤´ç»“ç‚¹å’Œå°¾èŠ‚ç‚¹å¹¶åœ¨çº¿ç¨‹ç¼“å­˜ä»¥åŠä¸­å¿ƒç¼“å­˜ä¸­ä½¿ç”¨ã€‚

![å†…å­˜ç®¡ç†å•å…ƒä¸åŒå‘é“¾è¡¨](images/image-20250807220537860.png)

###### é¡µå’Œå†…å­˜

æ¯ä¸ª [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) éƒ½ç®¡ç† `npages` ä¸ªå¤§å°ä¸º 8KB çš„é¡µï¼Œè¿™é‡Œçš„é¡µä¸æ˜¯æ“ä½œç³»ç»Ÿä¸­çš„å†…å­˜é¡µï¼Œå®ƒä»¬æ˜¯æ“ä½œç³»ç»Ÿå†…å­˜é¡µçš„æ•´æ•°å€ï¼Œè¯¥ç»“æ„ä½“ä¼šä½¿ç”¨ä¸‹é¢è¿™äº›å­—æ®µæ¥ç®¡ç†å†…å­˜é¡µçš„åˆ†é…å’Œå›æ”¶ï¼š

```go
type mspan struct {
	startAddr uintptr // èµ·å§‹åœ°å€
	npages    uintptr // é¡µæ•°
	freeindex uintptr

	allocBits  *gcBits
	gcmarkBits *gcBits
	allocCache uint64
	...
}
```

- `startAddr` å’Œ `npages` â€”â€” ç¡®å®šè¯¥ç»“æ„ä½“ç®¡ç†çš„å¤šä¸ªé¡µæ‰€åœ¨çš„å†…å­˜ï¼Œæ¯ä¸ªé¡µçš„å¤§å°éƒ½æ˜¯ 8KBï¼›
- `freeindex` â€”â€” æ‰«æé¡µä¸­ç©ºé—²å¯¹è±¡çš„åˆå§‹ç´¢å¼•ï¼›
- `allocBits` å’Œ `gcmarkBits` â€”â€” åˆ†åˆ«ç”¨äºæ ‡è®°å†…å­˜çš„å ç”¨å’Œå›æ”¶æƒ…å†µï¼›
- `allocCache` â€”â€” `allocBits` çš„è¡¥ç ï¼Œå¯ä»¥ç”¨äºå¿«é€ŸæŸ¥æ‰¾å†…å­˜ä¸­æœªè¢«ä½¿ç”¨çš„å†…å­˜ï¼›

[`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) ä¼šä»¥ä¸¤ç§ä¸åŒçš„è§†è§’çœ‹å¾…ç®¡ç†çš„å†…å­˜ï¼Œå½“ç»“æ„ä½“ç®¡ç†çš„å†…å­˜ä¸è¶³æ—¶ï¼Œè¿è¡Œæ—¶ä¼šä»¥é¡µä¸ºå•ä½å‘å †ç”³è¯·å†…å­˜ï¼š

![å†…å­˜ç®¡ç†å•å…ƒä¸é¡µ](images/image-20250819190902914.png)

å½“ç”¨æˆ·ç¨‹åºæˆ–è€…çº¿ç¨‹å‘ [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) ç”³è¯·å†…å­˜æ—¶ï¼Œå®ƒä¼šä½¿ç”¨ `allocCache` å­—æ®µä»¥å¯¹è±¡ä¸ºå•ä½åœ¨ç®¡ç†çš„å†…å­˜ä¸­å¿«é€ŸæŸ¥æ‰¾å¾…åˆ†é…çš„ç©ºé—´ï¼š

![å›¾ 7-13 å†…å­˜ç®¡ç†å•å…ƒä¸å¯¹è±¡](images/image-20250819190951112.png)

å¦‚æœæˆ‘ä»¬èƒ½åœ¨å†…å­˜ä¸­æ‰¾åˆ°ç©ºé—²çš„å†…å­˜å•å…ƒä¼šç›´æ¥è¿”å›ï¼Œå½“å†…å­˜ä¸­ä¸åŒ…å«ç©ºé—²çš„å†…å­˜æ—¶ï¼Œä¸Šä¸€çº§çš„ç»„ä»¶ [`runtime.mcache`](https://draven.co/golang/tree/runtime.mcache) ä¼šä¸ºè°ƒç”¨ [`runtime.mcache.refill`](https://draven.co/golang/tree/runtime.mcache.refill) æ›´æ–°å†…å­˜ç®¡ç†å•å…ƒä»¥æ»¡è¶³ä¸ºæ›´å¤šå¯¹è±¡åˆ†é…å†…å­˜çš„éœ€æ±‚ã€‚

###### çŠ¶æ€ 

è¿è¡Œæ—¶ä¼šä½¿ç”¨ [`runtime.mSpanStateBox`](https://draven.co/golang/tree/runtime.mSpanStateBox) å­˜å‚¨å†…å­˜ç®¡ç†å•å…ƒçš„çŠ¶æ€ [`runtime.mSpanState`](https://draven.co/golang/tree/runtime.mSpanState)ï¼š

```go
type mspan struct {
	...
	state       mSpanStateBox
	...
}
```

è¯¥çŠ¶æ€å¯èƒ½å¤„äº `mSpanDead`ã€`mSpanInUse`ã€`mSpanManual` å’Œ `mSpanFree` å››ç§æƒ…å†µã€‚å½“ [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) åœ¨ç©ºé—²å †ä¸­ï¼Œå®ƒä¼šå¤„äº `mSpanFree` çŠ¶æ€ï¼›å½“ [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) å·²ç»è¢«åˆ†é…æ—¶ï¼Œå®ƒä¼šå¤„äº `mSpanInUse`ã€`mSpanManual` çŠ¶æ€ï¼Œè¿è¡Œæ—¶ä¼šéµå¾ªä¸‹é¢çš„è§„åˆ™è½¬æ¢è¯¥çŠ¶æ€ï¼š

- åœ¨åƒåœ¾å›æ”¶çš„ä»»æ„é˜¶æ®µï¼Œå¯èƒ½ä» `mSpanFree` è½¬æ¢åˆ° `mSpanInUse` å’Œ `mSpanManual`ï¼›
- åœ¨åƒåœ¾å›æ”¶çš„æ¸…é™¤é˜¶æ®µï¼Œå¯èƒ½ä» `mSpanInUse` å’Œ `mSpanManual` è½¬æ¢åˆ° `mSpanFree`ï¼›
- åœ¨åƒåœ¾å›æ”¶çš„æ ‡è®°é˜¶æ®µï¼Œä¸èƒ½ä» `mSpanInUse` å’Œ `mSpanManual` è½¬æ¢åˆ° `mSpanFree`ï¼›

è®¾ç½® [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) çŠ¶æ€çš„æ“ä½œå¿…é¡»æ˜¯åŸå­æ€§çš„ä»¥é¿å…åƒåœ¾å›æ”¶é€ æˆçš„çº¿ç¨‹ç«äº‰é—®é¢˜ã€‚

###### è·¨åº¦ç±»

[`runtime.spanClass`](https://draven.co/golang/tree/runtime.spanClass) æ˜¯ [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) çš„è·¨åº¦ç±»ï¼Œå®ƒå†³å®šäº†å†…å­˜ç®¡ç†å•å…ƒä¸­å­˜å‚¨çš„å¯¹è±¡å¤§å°å’Œä¸ªæ•°ï¼š

```go
type mspan struct {
	...
	spanclass   spanClass
	...
}
```

Go è¯­è¨€çš„å†…å­˜ç®¡ç†æ¨¡å—ä¸­ä¸€å…±åŒ…å« 67 ç§è·¨åº¦ç±»ï¼Œæ¯ä¸€ä¸ªè·¨åº¦ç±»éƒ½ä¼šå­˜å‚¨ç‰¹å®šå¤§å°çš„å¯¹è±¡å¹¶ä¸”åŒ…å«ç‰¹å®šæ•°é‡çš„é¡µæ•°ä»¥åŠå¯¹è±¡ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½ä¼šè¢«é¢„é€‰è®¡ç®—å¥½å¹¶å­˜å‚¨åœ¨ [`runtime.class_to_size`](https://draven.co/golang/tree/runtime.class_to_size) å’Œ [`runtime.class_to_allocnpages`](https://draven.co/golang/tree/runtime.class_to_allocnpages) ç­‰å˜é‡ä¸­ï¼š

**è¡¨ 7-3 è·¨åº¦ç±»çš„æ•°æ®**

| class | bytes/obj | bytes/span | objects | tail waste | max waste |
| :---: | --------: | ---------: | ------: | :--------: | :-------: |
|   1   |         8 |       8192 |    1024 |     0      |  87.50%   |
|   2   |        16 |       8192 |     512 |     0      |  43.75%   |
|   3   |        24 |       8192 |     341 |     0      |  29.24%   |
|   4   |        32 |       8192 |     256 |     0      |  46.88%   |
|   5   |        48 |       8192 |     170 |     32     |  31.52%   |
|   6   |        64 |       8192 |     128 |     0      |  23.44%   |
|   7   |        80 |       8192 |     102 |     32     |  19.07%   |
|   â€¦   |         â€¦ |          â€¦ |       â€¦ |     â€¦      |     â€¦     |
|  67   |     32768 |      32768 |       1 |     0      |  12.50%   |

ä¸Šè¡¨å±•ç¤ºäº†å¯¹è±¡å¤§å°ä» 8B åˆ° 32KBï¼Œæ€»å…± 67 ç§è·¨åº¦ç±»çš„å¤§å°ã€å­˜å‚¨çš„å¯¹è±¡æ•°ä»¥åŠæµªè´¹çš„å†…å­˜ç©ºé—´ï¼Œä»¥è¡¨ä¸­çš„ç¬¬å››ä¸ªè·¨åº¦ç±»ä¸ºä¾‹ï¼Œè·¨åº¦ç±»ä¸º 5 çš„ [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) ä¸­å¯¹è±¡çš„å¤§å°ä¸Šé™ä¸º 48 å­—èŠ‚ã€ç®¡ç† 1 ä¸ªé¡µã€æœ€å¤šå¯ä»¥å­˜å‚¨ 170 ä¸ªå¯¹è±¡ã€‚å› ä¸ºå†…å­˜éœ€è¦æŒ‰ç…§é¡µè¿›è¡Œç®¡ç†ï¼Œæ‰€ä»¥åœ¨å°¾éƒ¨ä¼šæµªè´¹ 32 å­—èŠ‚çš„å†…å­˜ï¼Œå½“é¡µä¸­å­˜å‚¨çš„å¯¹è±¡éƒ½æ˜¯ 33 å­—èŠ‚æ—¶ï¼Œæœ€å¤šä¼šæµªè´¹ 31.52% çš„èµ„æºï¼š

$$\frac{(48 - 33) * 170 + 32}{8192} = 0.31518$$

![å›¾ 7-14 è·¨åº¦ç±»æµªè´¹çš„å†…å­˜](images/image-20250819191338008.png)

é™¤äº†ä¸Šè¿° 67 ä¸ªè·¨åº¦ç±»ä¹‹å¤–ï¼Œè¿è¡Œæ—¶ä¸­è¿˜åŒ…å« ID ä¸º 0 çš„ç‰¹æ®Šè·¨åº¦ç±»ï¼Œå®ƒèƒ½å¤Ÿç®¡ç†å¤§äº 32KB çš„ç‰¹æ®Šå¯¹è±¡ï¼Œæˆ‘ä»¬ä¼šåœ¨åé¢è¯¦ç»†ä»‹ç»å¤§å¯¹è±¡çš„åˆ†é…è¿‡ç¨‹ï¼Œåœ¨è¿™é‡Œå°±ä¸å±•å¼€è¯´æ˜äº†ã€‚

è·¨åº¦ç±»ä¸­é™¤äº†å­˜å‚¨ç±»åˆ«çš„ ID ä¹‹å¤–ï¼Œå®ƒè¿˜ä¼šå­˜å‚¨ä¸€ä¸ª `noscan` æ ‡è®°ä½ï¼Œè¯¥æ ‡è®°ä½è¡¨ç¤ºå¯¹è±¡æ˜¯å¦åŒ…å«æŒ‡é’ˆï¼Œåƒåœ¾å›æ”¶ä¼šå¯¹åŒ…å«æŒ‡é’ˆçš„ [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) ç»“æ„ä½“è¿›è¡Œæ‰«æã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‡ ä¸ªå‡½æ•°å’Œæ–¹æ³•äº†è§£ ID å’Œæ ‡è®°ä½çš„åº•å±‚å­˜å‚¨æ–¹å¼ï¼š

```go
func makeSpanClass(sizeclass uint8, noscan bool) spanClass {
	return spanClass(sizeclass<<1) | spanClass(bool2int(noscan))
}

func (sc spanClass) sizeclass() int8 {
	return int8(sc >> 1)
}

func (sc spanClass) noscan() bool {
	return sc&1 != 0
}
```

[`runtime.spanClass`](https://draven.co/golang/tree/runtime.spanClass) æ˜¯ä¸€ä¸ª `uint8` ç±»å‹çš„æ•´æ•°ï¼Œå®ƒçš„å‰ 7 ä½å­˜å‚¨ç€è·¨åº¦ç±»çš„ IDï¼Œæœ€åä¸€ä½è¡¨ç¤ºæ˜¯å¦åŒ…å«æŒ‡é’ˆï¼Œè¯¥ç±»å‹æä¾›çš„ä¸¤ä¸ªæ–¹æ³•èƒ½å¤Ÿå¸®æˆ‘ä»¬å¿«é€Ÿè·å–å¯¹åº”çš„å­—æ®µã€‚

##### 73.1.2.2 çº¿ç¨‹ç¼“å­˜

[`runtime.mcache`](https://draven.co/golang/tree/runtime.mcache) æ˜¯ Go è¯­è¨€ä¸­çš„çº¿ç¨‹ç¼“å­˜ï¼Œå®ƒä¼šä¸çº¿ç¨‹ä¸Šçš„å¤„ç†å™¨ä¸€ä¸€ç»‘å®šï¼Œä¸»è¦ç”¨æ¥ç¼“å­˜ç”¨æˆ·ç¨‹åºç”³è¯·çš„å¾®å°å¯¹è±¡ã€‚æ¯ä¸€ä¸ªçº¿ç¨‹ç¼“å­˜éƒ½æŒæœ‰ 68 * 2 ä¸ª [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan)ï¼Œè¿™äº›å†…å­˜ç®¡ç†å•å…ƒéƒ½å­˜å‚¨åœ¨ç»“æ„ä½“çš„ `alloc` å­—æ®µä¸­ï¼š

![å›¾ 7-15 çº¿ç¨‹ç¼“å­˜ä¸å†…å­˜ç®¡ç†å•å…ƒ](images/image-20250819191535765.png)

çº¿ç¨‹ç¼“å­˜åœ¨åˆšåˆšè¢«åˆå§‹åŒ–æ—¶æ˜¯ä¸åŒ…å« [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) çš„ï¼Œåªæœ‰å½“ç”¨æˆ·ç¨‹åºç”³è¯·å†…å­˜æ—¶æ‰ä¼šä»ä¸Šä¸€çº§ç»„ä»¶è·å–æ–°çš„ [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) æ»¡è¶³å†…å­˜åˆ†é…çš„éœ€æ±‚ã€‚

###### åˆå§‹åŒ– 

è¿è¡Œæ—¶åœ¨åˆå§‹åŒ–å¤„ç†å™¨æ—¶ä¼šè°ƒç”¨ [`runtime.allocmcache`](https://draven.co/golang/tree/runtime.allocmcache) åˆå§‹åŒ–çº¿ç¨‹ç¼“å­˜ï¼Œè¯¥å‡½æ•°ä¼šåœ¨ç³»ç»Ÿæ ˆä¸­ä½¿ç”¨ [`runtime.mheap`](https://draven.co/golang/tree/runtime.mheap) ä¸­çš„çº¿ç¨‹ç¼“å­˜åˆ†é…å™¨åˆå§‹åŒ–æ–°çš„ [`runtime.mcache`](https://draven.co/golang/tree/runtime.mcache) ç»“æ„ä½“ï¼š

```go
func allocmcache() *mcache {
	var c *mcache
	systemstack(func() {
		lock(&mheap_.lock)
		c = (*mcache)(mheap_.cachealloc.alloc())
		c.flushGen = mheap_.sweepgen
		unlock(&mheap_.lock)
	})
	for i := range c.alloc {
		c.alloc[i] = &emptymspan
	}
	c.nextSample = nextSample()
	return c
}
```

å°±åƒæˆ‘ä»¬åœ¨ä¸Šé¢æåˆ°çš„ï¼Œåˆå§‹åŒ–åçš„ [`runtime.mcache`](https://draven.co/golang/tree/runtime.mcache) ä¸­çš„æ‰€æœ‰ [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) éƒ½æ˜¯ç©ºçš„å ä½ç¬¦ `emptymspan`ã€‚

###### æ›¿æ¢

[`runtime.mcache.refill`](https://draven.co/golang/tree/runtime.mcache.refill) ä¼šä¸ºçº¿ç¨‹ç¼“å­˜è·å–ä¸€ä¸ªæŒ‡å®šè·¨åº¦ç±»çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œè¢«æ›¿æ¢çš„å•å…ƒä¸èƒ½åŒ…å«ç©ºé—²çš„å†…å­˜ç©ºé—´ï¼Œè€Œè·å–çš„å•å…ƒä¸­éœ€è¦è‡³å°‘åŒ…å«ä¸€ä¸ªç©ºé—²å¯¹è±¡ç”¨äºåˆ†é…å†…å­˜ï¼š

```go
func (c *mcache) refill(spc spanClass) {
	s := c.alloc[spc]
	s = mheap_.central[spc].mcentral.cacheSpan()
	c.alloc[spc] = s
}
```

å¦‚ä¸Šè¿°ä»£ç æ‰€ç¤ºï¼Œè¯¥æ–¹æ³•ä¼šä»ä¸­å¿ƒç¼“å­˜ä¸­ç”³è¯·æ–°çš„ [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) å­˜å‚¨åˆ°çº¿ç¨‹ç¼“å­˜ä¸­ï¼Œè¿™ä¹Ÿæ˜¯å‘çº¿ç¨‹ç¼“å­˜æ’å…¥å†…å­˜ç®¡ç†å•å…ƒçš„å”¯ä¸€æ–¹æ³•ã€‚

###### å¾®åˆ†é…å™¨

çº¿ç¨‹ç¼“å­˜ä¸­è¿˜åŒ…å«å‡ ä¸ªç”¨äºåˆ†é…å¾®å¯¹è±¡çš„å­—æ®µï¼Œä¸‹é¢çš„è¿™ä¸‰ä¸ªå­—æ®µç»„æˆäº†å¾®å¯¹è±¡åˆ†é…å™¨ï¼Œä¸“é—¨ç®¡ç† 16 å­—èŠ‚ä»¥ä¸‹çš„å¯¹è±¡ï¼š

```go
type mcache struct {
	tiny             uintptr
	tinyoffset       uintptr
	local_tinyallocs uintptr
}
```

å¾®åˆ†é…å™¨åªä¼šç”¨äºåˆ†é…éæŒ‡é’ˆç±»å‹çš„å†…å­˜ï¼Œä¸Šè¿°ä¸‰ä¸ªå­—æ®µä¸­ `tiny` ä¼šæŒ‡å‘å †ä¸­çš„ä¸€ç‰‡å†…å­˜ï¼Œ`tinyOffset` æ˜¯ä¸‹ä¸€ä¸ªç©ºé—²å†…å­˜æ‰€åœ¨çš„åç§»é‡ï¼Œæœ€åçš„ `local_tinyallocs` ä¼šè®°å½•å†…å­˜åˆ†é…å™¨ä¸­åˆ†é…çš„å¯¹è±¡ä¸ªæ•°ã€‚



##### 73.1.2.3 ä¸­å¿ƒç¼“å­˜

[`runtime.mcentral`](https://draven.co/golang/tree/runtime.mcentral) æ˜¯å†…å­˜åˆ†é…å™¨çš„ä¸­å¿ƒç¼“å­˜ï¼Œä¸çº¿ç¨‹ç¼“å­˜ä¸åŒï¼Œè®¿é—®ä¸­å¿ƒç¼“å­˜ä¸­çš„å†…å­˜ç®¡ç†å•å…ƒéœ€è¦ä½¿ç”¨äº’æ–¥é”ï¼š

```go
type mcentral struct {
	spanclass spanClass
	partial  [2]spanSet
	full     [2]spanSet
}
```

æ¯ä¸ªä¸­å¿ƒç¼“å­˜éƒ½ä¼šç®¡ç†æŸä¸ªè·¨åº¦ç±»çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œå®ƒä¼šåŒæ—¶æŒæœ‰ä¸¤ä¸ª [`runtime.spanSet`](https://draven.co/golang/tree/runtime.spanSet)ï¼Œåˆ†åˆ«å­˜å‚¨åŒ…å«ç©ºé—²å¯¹è±¡å’Œä¸åŒ…å«ç©ºé—²å¯¹è±¡çš„å†…å­˜ç®¡ç†å•å…ƒã€‚

###### å†…å­˜ç®¡ç†å•å…ƒ 

çº¿ç¨‹ç¼“å­˜ä¼šé€šè¿‡ä¸­å¿ƒç¼“å­˜çš„ [`runtime.mcentral.cacheSpan`](https://draven.co/golang/tree/runtime.mcentral.cacheSpan) æ–¹æ³•è·å–æ–°çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œè¯¥æ–¹æ³•çš„å®ç°æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶åˆ†æˆä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

1. è°ƒç”¨ [`runtime.mcentral.partialSwept`](https://draven.co/golang/tree/runtime.mcentral.partialSwept) ä»æ¸…ç†è¿‡çš„ã€åŒ…å«ç©ºé—²ç©ºé—´çš„ [`runtime.spanSet`](https://draven.co/golang/tree/runtime.spanSet) ç»“æ„ä¸­æŸ¥æ‰¾å¯ä»¥ä½¿ç”¨çš„å†…å­˜ç®¡ç†å•å…ƒï¼›
2. è°ƒç”¨ [`runtime.mcentral.partialUnswept`](https://draven.co/golang/tree/runtime.mcentral.partialUnswept) ä»æœªè¢«æ¸…ç†è¿‡çš„ã€æœ‰ç©ºé—²å¯¹è±¡çš„ [`runtime.spanSet`](https://draven.co/golang/tree/runtime.spanSet) ç»“æ„ä¸­æŸ¥æ‰¾å¯ä»¥ä½¿ç”¨çš„å†…å­˜ç®¡ç†å•å…ƒï¼›
3. è°ƒç”¨ [`runtime.mcentral.fullUnswept`](https://draven.co/golang/tree/runtime.mcentral.fullUnswept) è·å–æœªè¢«æ¸…ç†çš„ã€ä¸åŒ…å«ç©ºé—²ç©ºé—´çš„ [`runtime.spanSet`](https://draven.co/golang/tree/runtime.spanSet) ä¸­è·å–å†…å­˜ç®¡ç†å•å…ƒå¹¶é€šè¿‡ [`runtime.mspan.sweep`](https://draven.co/golang/tree/runtime.mspan.sweep) æ¸…ç†å®ƒçš„å†…å­˜ç©ºé—´ï¼›
4. è°ƒç”¨ [`runtime.mcentral.grow`](https://draven.co/golang/tree/runtime.mcentral.grow) ä»å †ä¸­ç”³è¯·æ–°çš„å†…å­˜ç®¡ç†å•å…ƒï¼›
5. æ›´æ–°å†…å­˜ç®¡ç†å•å…ƒçš„ `allocCache` ç­‰å­—æ®µå¸®åŠ©å¿«é€Ÿåˆ†é…å†…å­˜ï¼›

é¦–å…ˆæˆ‘ä»¬ä¼šåœ¨ä¸­å¿ƒç¼“å­˜çš„ç©ºé—²é›†åˆä¸­æŸ¥æ‰¾å¯ç”¨çš„ [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan)ï¼Œè¿è¡Œæ—¶æ€»æ˜¯ä¼šå…ˆä»è·å–æ¸…ç†è¿‡çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œåæ£€æŸ¥æœªæ¸…ç†çš„å†…å­˜ç®¡ç†å•å…ƒï¼š

```go
func (c *mcentral) cacheSpan() *mspan {
	sg := mheap_.sweepgen
	spanBudget := 100

	var s *mspan
	if s = c.partialSwept(sg).pop(); s != nil {
		goto havespan
	}

	for ; spanBudget >= 0; spanBudget-- {
		s = c.partialUnswept(sg).pop()
		if s == nil {
			break
		}
		if atomic.Load(&s.sweepgen) == sg-2 && atomic.Cas(&s.sweepgen, sg-2, sg-1) {
ã€			s.sweep(true)
			goto havespan
		}
	}
	...
}
```

å½“æ‰¾åˆ°éœ€è¦å›æ”¶çš„å†…å­˜å•å…ƒæ—¶ï¼Œè¿è¡Œæ—¶ä¼šè§¦å‘ [`runtime.mspan.sweep`](https://draven.co/golang/tree/runtime.mspan.sweep) è¿›è¡Œæ¸…ç†ï¼Œå¦‚æœåœ¨åŒ…å«ç©ºé—²ç©ºé—´çš„é›†åˆä¸­æ²¡æœ‰æ‰¾åˆ°ç®¡ç†å•å…ƒï¼Œé‚£ä¹ˆè¿è¡Œæ—¶å°è¯•ä¼šä»æœªæ¸…ç†çš„é›†åˆä¸­è·å–ï¼š

```go
func (c *mcentral) cacheSpan() *mspan {
	...
	for ; spanBudget >= 0; spanBudget-- {
		s = c.fullUnswept(sg).pop()
		if s == nil {
			break
		}
		if atomic.Load(&s.sweepgen) == sg-2 && atomic.Cas(&s.sweepgen, sg-2, sg-1) {
ã€			s.sweep(true)
ã€			freeIndex := s.nextFreeIndex()
			if freeIndex != s.nelems {
				s.freeindex = freeIndex
				goto havespan
			}
ã€			c.fullSwept(sg).push(s)
		}
ã€	}
	...
}
```

å¦‚æœ [`runtime.mcentral`](https://draven.co/golang/tree/runtime.mcentral) é€šè¿‡ä¸Šè¿°ä¸¤ä¸ªé˜¶æ®µéƒ½æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„å•å…ƒï¼Œå®ƒä¼šè°ƒç”¨ [`runtime.mcentral.grow`](https://draven.co/golang/tree/runtime.mcentral.grow) è§¦å‘æ‰©å®¹ä»å †ä¸­ç”³è¯·æ–°çš„å†…å­˜ï¼š

```go
func (c *mcentral) cacheSpan() *mspan {
	...
	s = c.grow()
	if s == nil {
		return nil
	}

havespan:
	freeByteBase := s.freeindex &^ (64 - 1)
	whichByte := freeByteBase / 8
	s.refillAllocCache(whichByte)

	s.allocCache >>= s.freeindex % 64

	return s
}
```

æ— è®ºé€šè¿‡å“ªç§æ–¹æ³•è·å–åˆ°äº†å†…å­˜å•å…ƒï¼Œè¯¥æ–¹æ³•çš„æœ€åéƒ½ä¼šæ›´æ–°å†…å­˜å•å…ƒçš„ `allocBits` å’Œ `allocCache` ç­‰å­—æ®µï¼Œè®©è¿è¡Œæ—¶åœ¨åˆ†é…å†…å­˜æ—¶èƒ½å¤Ÿå¿«é€Ÿæ‰¾åˆ°ç©ºé—²çš„å¯¹è±¡ã€‚

###### æ‰©å®¹

ä¸­å¿ƒç¼“å­˜çš„æ‰©å®¹æ–¹æ³• [`runtime.mcentral.grow`](https://draven.co/golang/tree/runtime.mcentral.grow) ä¼šæ ¹æ®é¢„å…ˆè®¡ç®—çš„ `class_to_allocnpages` å’Œ `class_to_size` è·å–å¾…åˆ†é…çš„é¡µæ•°ä»¥åŠè·¨åº¦ç±»å¹¶è°ƒç”¨ [`runtime.mheap.alloc`](https://draven.co/golang/tree/runtime.mheap.alloc) è·å–æ–°çš„ [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) ç»“æ„ï¼š

```go
func (c *mcentral) grow() *mspan {
	npages := uintptr(class_to_allocnpages[c.spanclass.sizeclass()])
	size := uintptr(class_to_size[c.spanclass.sizeclass()])

	s := mheap_.alloc(npages, c.spanclass, true)
	if s == nil {
		return nil
	}

	n := (npages << _PageShift) >> s.divShift * uintptr(s.divMul) >> s.divShift2
	s.limit = s.base() + size*n
	heapBitsForAddr(s.base()).initSpan(s)
	return s
}
```

è·å–äº† [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) åï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸Šè¿°æ–¹æ³•ä¸­åˆå§‹åŒ– `limit` å­—æ®µå¹¶æ¸…é™¤è¯¥ç»“æ„åœ¨å †ä¸Šå¯¹åº”çš„ä½å›¾ã€‚

##### 73.1.2.4 é¡µå †

[`runtime.mheap`](https://draven.co/golang/tree/runtime.mheap) æ˜¯å†…å­˜åˆ†é…çš„æ ¸å¿ƒç»“æ„ä½“ï¼ŒGo è¯­è¨€ç¨‹åºä¼šå°†å…¶ä½œä¸ºå…¨å±€å˜é‡å­˜å‚¨ï¼Œè€Œå †ä¸Šåˆå§‹åŒ–çš„æ‰€æœ‰å¯¹è±¡éƒ½ç”±è¯¥ç»“æ„ä½“ç»Ÿä¸€ç®¡ç†ï¼Œè¯¥ç»“æ„ä½“ä¸­åŒ…å«ä¸¤ç»„éå¸¸é‡è¦çš„å­—æ®µï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯å…¨å±€çš„ä¸­å¿ƒç¼“å­˜åˆ—è¡¨ `central`ï¼Œå¦ä¸€ä¸ªæ˜¯ç®¡ç†å †åŒºå†…å­˜åŒºåŸŸçš„ `arenas` ä»¥åŠç›¸å…³å­—æ®µã€‚

é¡µå †ä¸­åŒ…å«ä¸€ä¸ªé•¿åº¦ä¸º 136 çš„ [`runtime.mcentral`](https://draven.co/golang/tree/runtime.mcentral) æ•°ç»„ï¼Œå…¶ä¸­ 68 ä¸ªä¸ºè·¨åº¦ç±»éœ€è¦ `scan` çš„ä¸­å¿ƒç¼“å­˜ï¼Œå¦å¤–çš„ 68 ä¸ªæ˜¯ `noscan` çš„ä¸­å¿ƒç¼“å­˜ï¼š

![å›¾ 7-17 é¡µå †ä¸ä¸­å¿ƒç¼“å­˜åˆ—è¡¨](images/image-20250819192011437.png)

åœ¨è®¾è®¡åŸç†ä¸€èŠ‚ä¸­å·²ç»ä»‹ç»è¿‡ Go è¯­è¨€æ‰€æœ‰çš„å†…å­˜ç©ºé—´éƒ½ç”±å¦‚ä¸‹æ‰€ç¤ºçš„äºŒç»´çŸ©é˜µ [`runtime.heapArena`](https://draven.co/golang/tree/runtime.heapArena) ç®¡ç†ï¼Œè¿™ä¸ªäºŒç»´çŸ©é˜µç®¡ç†çš„å†…å­˜å¯ä»¥æ˜¯ä¸è¿ç»­çš„ï¼š

![é¡µå †ç®¡ç†çš„å†…å­˜åŒºåŸŸ](images/image-20250819192245918.png)

åœ¨é™¤äº† Windows ä»¥å¤–çš„ 64 ä½æ“ä½œç³»ç»Ÿä¸­ï¼Œæ¯ä¸€ä¸ª [`runtime.heapArena`](https://draven.co/golang/tree/runtime.heapArena) éƒ½ä¼šç®¡ç† 64MB çš„å†…å­˜ç©ºé—´ï¼Œå¦‚ä¸‹æ‰€ç¤ºçš„è¡¨æ ¼å±•ç¤ºäº†ä¸åŒå¹³å°ä¸Š Go è¯­è¨€ç¨‹åºç®¡ç†çš„å †åŒºå¤§å°ä»¥åŠ [`runtime.heapArena`](https://draven.co/golang/tree/runtime.heapArena) å ç”¨çš„å†…å­˜ç©ºé—´ï¼š

|           å¹³å° | åœ°å€ä½æ•° | Arena å¤§å° | ä¸€ç»´å¤§å° |   äºŒç»´å¤§å° |
| -------------: | -------: | ---------: | -------: | ---------: |
|       */64-bit |       48 |       64MB |        1 |  4M (32MB) |
| windows/64-bit |       48 |        4MB |       64 |   1M (8MB) |
|       */32-bit |       32 |        4MB |        1 | 1024 (4KB) |
|     */mips(le) |       31 |        4MB |        1 |  512 (2KB) |

**è¡¨ 7-3 å¹³å°ä¸é¡µå †å¤§å°çš„å…³ç³»**

æœ¬èŠ‚å°†ä»‹ç»é¡µå †çš„åˆå§‹åŒ–ã€å†…å­˜åˆ†é…ä»¥åŠå†…å­˜ç®¡ç†å•å…ƒåˆ†é…çš„è¿‡ç¨‹ï¼Œè¿™äº›è¿‡ç¨‹èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬ç†è§£å…¨å±€å˜é‡é¡µå †ä¸å…¶ä»–ç»„ä»¶çš„å…³ç³»ä»¥åŠå®ƒç®¡ç†å†…å­˜çš„æ–¹å¼ã€‚

###### åˆå§‹åŒ–

å †åŒºçš„åˆå§‹åŒ–ä¼šä½¿ç”¨ [`runtime.mheap.init`](https://draven.co/golang/tree/runtime.mheap.init) æ–¹æ³•ï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°è¯¥æ–¹æ³•åˆå§‹åŒ–äº†éå¸¸å¤šçš„ç»“æ„ä½“å’Œå­—æ®µï¼Œä¸è¿‡å…¶ä¸­åˆå§‹åŒ–çš„ä¸¤ç±»å˜é‡æ¯”è¾ƒé‡è¦ï¼š

1. `spanalloc`ã€`cachealloc` ä»¥åŠ `arenaHintAlloc` ç­‰ [`runtime.fixalloc`](https://draven.co/golang/tree/runtime.fixalloc) ç±»å‹çš„ç©ºé—²é“¾è¡¨åˆ†é…å™¨ï¼›
2. `central` åˆ‡ç‰‡ä¸­ [`runtime.mcentral`](https://draven.co/golang/tree/runtime.mcentral) ç±»å‹çš„ä¸­å¿ƒç¼“å­˜ï¼›

```go
func (h *mheap) init() {
	h.spanalloc.init(unsafe.Sizeof(mspan{}), recordspan, unsafe.Pointer(h), &memstats.mspan_sys)
	h.cachealloc.init(unsafe.Sizeof(mcache{}), nil, nil, &memstats.mcache_sys)
	h.specialfinalizeralloc.init(unsafe.Sizeof(specialfinalizer{}), nil, nil, &memstats.other_sys)
	h.specialprofilealloc.init(unsafe.Sizeof(specialprofile{}), nil, nil, &memstats.other_sys)
	h.arenaHintAlloc.init(unsafe.Sizeof(arenaHint{}), nil, nil, &memstats.other_sys)

	h.spanalloc.zero = false

	for i := range h.central {
		h.central[i].mcentral.init(spanClass(i))
	}

	h.pages.init(&h.lock, &memstats.gc_sys)
}
```

å †ä¸­åˆå§‹åŒ–çš„å¤šä¸ªç©ºé—²é“¾è¡¨åˆ†é…å™¨ä¸è®¾è®¡åŸç†ä¸­æåˆ°çš„åˆ†é…å™¨æ²¡æœ‰å¤ªå¤šåŒºåˆ«ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ [`runtime.fixalloc.init`](https://draven.co/golang/tree/runtime.fixalloc.init) åˆå§‹åŒ–åˆ†é…å™¨æ—¶ï¼Œéœ€è¦ä¼ å…¥å¾…åˆå§‹åŒ–çš„ç»“æ„ä½“å¤§å°ç­‰ä¿¡æ¯ï¼Œè¿™ä¼šå¸®åŠ©åˆ†é…å™¨åˆ†å‰²å¾…åˆ†é…çš„å†…å­˜ï¼Œå®ƒæä¾›äº†ä»¥ä¸‹ä¸¤ä¸ªç”¨äºåˆ†é…å’Œé‡Šæ”¾å†…å­˜çš„æ–¹æ³•ï¼š

1. [`runtime.fixalloc.alloc`](https://draven.co/golang/tree/runtime.fixalloc.alloc) â€” è·å–ä¸‹ä¸€ä¸ªç©ºé—²çš„å†…å­˜ç©ºé—´ï¼›
2. [`runtime.fixalloc.free`](https://draven.co/golang/tree/runtime.fixalloc.free) â€” é‡Šæ”¾æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ç©ºé—´ï¼›

é™¤äº†è¿™äº›ç©ºé—²é“¾è¡¨åˆ†é…å™¨ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜ä¼šåœ¨è¯¥æ–¹æ³•ä¸­åˆå§‹åŒ–æ‰€æœ‰çš„ä¸­å¿ƒç¼“å­˜ï¼Œè¿™äº›ä¸­å¿ƒç¼“å­˜ä¼šç»´æŠ¤å…¨å±€çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œå„ä¸ªçº¿ç¨‹ä¼šé€šè¿‡ä¸­å¿ƒç¼“å­˜è·å–æ–°çš„å†…å­˜å•å…ƒã€‚

###### å†…å­˜ç®¡ç†å•å…ƒ

[`runtime.mheap`](https://draven.co/golang/tree/runtime.mheap) æ˜¯å†…å­˜åˆ†é…å™¨ä¸­çš„æ ¸å¿ƒç»„ä»¶ï¼Œè¿è¡Œæ—¶ä¼šé€šè¿‡å®ƒçš„ [`runtime.mheap.alloc`](https://draven.co/golang/tree/runtime.mheap.alloc) æ–¹æ³•åœ¨ç³»ç»Ÿæ ˆä¸­è·å–æ–°çš„ [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) å•å…ƒï¼š

```go
func (h *mheap) alloc(npages uintptr, spanclass spanClass, needzero bool) *mspan {
	var s *mspan
	systemstack(func() {
		if h.sweepdone == 0 {
			h.reclaim(npages)
		}
		s = h.allocSpan(npages, false, spanclass, &memstats.heap_inuse)
	})
	...
	return s
}
```

ä¸ºäº†é˜»æ­¢å†…å­˜çš„å¤§é‡å ç”¨å’Œå †çš„å¢é•¿ï¼Œæˆ‘ä»¬åœ¨åˆ†é…å¯¹åº”é¡µæ•°çš„å†…å­˜å‰éœ€è¦å…ˆè°ƒç”¨ [`runtime.mheap.reclaim`](https://draven.co/golang/tree/runtime.mheap.reclaim) æ–¹æ³•å›æ”¶ä¸€éƒ¨åˆ†å†…å­˜ï¼Œéšåè¿è¡Œæ—¶é€šè¿‡ [`runtime.mheap.allocSpan`](https://draven.co/golang/tree/runtime.mheap.allocSpan) åˆ†é…æ–°çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œæˆ‘ä»¬ä¼šå°†è¯¥æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹æ‹†åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼š

1. ä»å †ä¸Šåˆ†é…æ–°çš„å†…å­˜é¡µå’Œå†…å­˜ç®¡ç†å•å…ƒ [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan)ï¼›
2. åˆå§‹åŒ–å†…å­˜ç®¡ç†å•å…ƒå¹¶å°†å…¶åŠ å…¥ [`runtime.mheap`](https://draven.co/golang/tree/runtime.mheap) æŒæœ‰å†…å­˜å•å…ƒåˆ—è¡¨ï¼›

é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨å †ä¸Šç”³è¯· `npages` æ•°é‡çš„å†…å­˜é¡µå¹¶åˆå§‹åŒ– [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan)ï¼š

```go
func (h *mheap) allocSpan(npages uintptr, typ spanAllocType, spanclass spanClass) (s *mspan) {
	gp := getg()
	base, scav := uintptr(0), uintptr(0)
	pp := gp.m.p.ptr()
	if pp != nil && npages < pageCachePages/4 {
		c := &pp.pcache
		base, scav = c.alloc(npages)
		if base != 0 {
			s = h.tryAllocMSpan()
			if s != nil && gcBlackenEnabled == 0 && (manual || spanclass.sizeclass() != 0) {
				goto HaveSpan
			}
		}
	}

	if base == 0 {
		base, scav = h.pages.alloc(npages)
		if base == 0 {
			h.grow(npages)
            base, scav = h.pages.alloc(npages)
			if base == 0 {
				throw("grew heap, but no adequate free space found")
			}
		}
	}
	if s == nil {
		s = h.allocMSpanLocked()
	}
	...
}
```

ä¸Šè¿°æ–¹æ³•ä¼šé€šè¿‡å¤„ç†å™¨çš„é¡µç¼“å­˜ [`runtime.pageCache`](https://draven.co/golang/tree/runtime.pageCache) æˆ–è€…å…¨å±€çš„é¡µåˆ†é…å™¨ [`runtime.pageAlloc`](https://draven.co/golang/tree/runtime.pageAlloc) ä¸¤ç§é€”å¾„ä»å †ä¸­ç”³è¯·å†…å­˜ï¼š

1. å¦‚æœç”³è¯·çš„å†…å­˜æ¯”è¾ƒå°ï¼Œè·å–ç”³è¯·å†…å­˜çš„å¤„ç†å™¨å¹¶å°è¯•è°ƒç”¨ [`runtime.pageCache.alloc`](https://draven.co/golang/tree/runtime.pageCache.alloc) è·å–å†…å­˜åŒºåŸŸçš„åŸºåœ°å€å’Œå¤§å°ï¼›
2. å¦‚æœç”³è¯·çš„å†…å­˜æ¯”è¾ƒå¤§æˆ–è€…çº¿ç¨‹çš„é¡µç¼“å­˜ä¸­å†…å­˜ä¸è¶³ï¼Œä¼šé€šè¿‡ [`runtime.pageAlloc.alloc`](https://draven.co/golang/tree/runtime.pageAlloc.alloc) åœ¨é¡µå †ä¸Šç”³è¯·å†…å­˜ï¼›
3. å¦‚æœå‘ç°é¡µå †ä¸Šçš„å†…å­˜ä¸è¶³ï¼Œä¼šå°è¯•é€šè¿‡`runtime.mheap.grow`æ‰©å®¹å¹¶é‡æ–°è°ƒç”¨`runtime.pageAlloc.alloc`ç”³è¯·å†…å­˜ï¼›
   1. å¦‚æœç”³è¯·åˆ°å†…å­˜ï¼Œæ„å‘³ç€æ‰©å®¹æˆåŠŸï¼›
   2. å¦‚æœæ²¡æœ‰ç”³è¯·åˆ°å†…å­˜ï¼Œæ„å‘³ç€æ‰©å®¹å¤±è´¥ï¼Œå®¿ä¸»æœºå¯èƒ½ä¸å­˜åœ¨ç©ºé—²å†…å­˜ï¼Œè¿è¡Œæ—¶ä¼šç›´æ¥ä¸­æ­¢å½“å‰ç¨‹åºï¼›

æ— è®ºé€šè¿‡å“ªç§æ–¹å¼è·å¾—å†…å­˜é¡µï¼Œæˆ‘ä»¬éƒ½ä¼šåœ¨è¯¥å‡½æ•°ä¸­åˆ†é…æ–°çš„ [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) ç»“æ„ä½“ï¼›è¯¥æ–¹æ³•çš„å‰©ä½™éƒ¨åˆ†ä¼šé€šè¿‡é¡µæ•°ã€å†…å­˜ç©ºé—´ä»¥åŠè·¨åº¦ç±»ç­‰å‚æ•°åˆå§‹åŒ–å®ƒçš„å¤šä¸ªå­—æ®µï¼š

```go
func (h *mheap) alloc(npages uintptr, spanclass spanClass, needzero bool) *mspan {
	...
HaveSpan:
	s.init(base, npages)

	...

	s.freeindex = 0
	s.allocCache = ^uint64(0)
	s.gcmarkBits = newMarkBits(s.nelems)
	s.allocBits = newAllocBits(s.nelems)
	h.setSpans(s.base(), npages, s)
	return s
}
```

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨ [`runtime.mspan.init`](https://draven.co/golang/tree/runtime.mspan.init) è®¾ç½®å‚æ•°åˆå§‹åŒ–åˆšåˆšåˆ†é…çš„ [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan) ç»“æ„å¹¶é€šè¿‡ [`runtime.mheaps.setSpans`](https://draven.co/golang/tree/runtime.mheaps.setSpans) å»ºç«‹é¡µå †ä¸å†…å­˜å•å…ƒçš„è”ç³»ã€‚

###### æ‰©å®¹

[`runtime.mheap.grow`](https://draven.co/golang/tree/runtime.mheap.grow) ä¼šå‘æ“ä½œç³»ç»Ÿç”³è¯·æ›´å¤šçš„å†…å­˜ç©ºé—´ï¼Œä¼ å…¥çš„é¡µæ•°ç»è¿‡å¯¹é½å¯ä»¥å¾—åˆ°æœŸæœ›çš„å†…å­˜å¤§å°ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¯¥æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹åˆ†æˆä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

1. é€šè¿‡ä¼ å…¥çš„é¡µæ•°è·å–æœŸæœ›åˆ†é…çš„å†…å­˜ç©ºé—´å¤§å°ä»¥åŠå†…å­˜çš„åŸºåœ°å€ï¼›
2. å¦‚æœ `arena` åŒºåŸŸæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œè°ƒç”¨ [`runtime.mheap.sysAlloc`](https://draven.co/golang/tree/runtime.mheap.sysAlloc) ä»æ“ä½œç³»ç»Ÿä¸­ç”³è¯·æ›´å¤šçš„å†…å­˜ï¼›
3. æ‰©å®¹ [`runtime.mheap`](https://draven.co/golang/tree/runtime.mheap) æŒæœ‰çš„ `arena` åŒºåŸŸå¹¶æ›´æ–°é¡µåˆ†é…å™¨çš„å…ƒä¿¡æ¯ï¼›
4. åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œè°ƒç”¨ [`runtime.pageAlloc.scavenge`](https://draven.co/golang/tree/runtime.pageAlloc.scavenge) å›æ”¶ä¸å†ä½¿ç”¨çš„ç©ºé—²å†…å­˜é¡µï¼›

åœ¨é¡µå †æ‰©å®¹çš„è¿‡ç¨‹ä¸­ï¼Œ[`runtime.mheap.sysAlloc`](https://draven.co/golang/tree/runtime.mheap.sysAlloc) æ˜¯é¡µå †ç”¨æ¥ç”³è¯·è™šæ‹Ÿå†…å­˜çš„æ–¹æ³•ï¼Œæˆ‘ä»¬ä¼šåˆ†å‡ éƒ¨åˆ†ä»‹ç»è¯¥æ–¹æ³•çš„å®ç°ã€‚é¦–å…ˆï¼Œè¯¥æ–¹æ³•ä¼šå°è¯•åœ¨é¢„ä¿ç•™çš„åŒºåŸŸç”³è¯·å†…å­˜ï¼š

```go
func (h *mheap) sysAlloc(n uintptr) (v unsafe.Pointer, size uintptr) {
	n = alignUp(n, heapArenaBytes)

	v = h.arena.alloc(n, heapArenaBytes, &memstats.heap_sys)
	if v != nil {
		size = n
		goto mapped
	}
	...
}
```

ä¸Šè¿°ä»£ç ä¼šè°ƒç”¨çº¿æ€§åˆ†é…å™¨çš„ [`runtime.linearAlloc.alloc`](https://draven.co/golang/tree/runtime.linearAlloc.alloc) åœ¨é¢„å…ˆä¿ç•™çš„å†…å­˜ä¸­ç”³è¯·ä¸€å—å¯ä»¥ä½¿ç”¨çš„ç©ºé—´ã€‚å¦‚æœæ²¡æœ‰å¯ç”¨çš„ç©ºé—´ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®é¡µå †çš„ `arenaHints` åœ¨ç›®æ ‡åœ°å€ä¸Šå°è¯•æ‰©å®¹ï¼š

```go
func (h *mheap) sysAlloc(n uintptr) (v unsafe.Pointer, size uintptr) {
	...
	for h.arenaHints != nil {
		hint := h.arenaHints
		p := hint.addr
		v = sysReserve(unsafe.Pointer(p), n)
		if p == uintptr(v) {
			hint.addr = p
			size = n
			break
		}
		h.arenaHints = hint.next
		h.arenaHintAlloc.free(unsafe.Pointer(hint))
	}
	...
	sysMap(v, size, &memstats.heap_sys)
	...
}
```

[`runtime.sysReserve`](https://draven.co/golang/tree/runtime.sysReserve) å’Œ [`runtime.sysMap`](https://draven.co/golang/tree/runtime.sysMap) æ˜¯ä¸Šè¿°ä»£ç çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒä»¬ä¼šä»æ“ä½œç³»ç»Ÿä¸­ç”³è¯·å†…å­˜å¹¶å°†å†…å­˜è½¬æ¢è‡³ `Prepared` çŠ¶æ€ã€‚

```go
func (h *mheap) sysAlloc(n uintptr) (v unsafe.Pointer, size uintptr) {
	...
mapped:
	for ri := arenaIndex(uintptr(v)); ri <= arenaIndex(uintptr(v)+size-1); ri++ {
		l2 := h.arenas[ri.l1()]
		r := (*heapArena)(h.heapArenaAlloc.alloc(unsafe.Sizeof(*r), sys.PtrSize, &memstats.gc_sys))
		...
		h.allArenas = h.allArenas[:len(h.allArenas)+1]
		h.allArenas[len(h.allArenas)-1] = ri
		atomic.StorepNoWB(unsafe.Pointer(&l2[ri.l2()]), unsafe.Pointer(r))
	}
	return
}
```

[`runtime.mheap.sysAlloc`](https://draven.co/golang/tree/runtime.mheap.sysAlloc) æ–¹æ³•åœ¨æœ€åä¼šåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ [`runtime.heapArena`](https://draven.co/golang/tree/runtime.heapArena) æ¥ç®¡ç†åˆšåˆšç”³è¯·çš„å†…å­˜ç©ºé—´ï¼Œè¯¥ç»“æ„ä¼šè¢«åŠ å…¥é¡µå †çš„äºŒç»´çŸ©é˜µä¸­ã€‚



#### 73.1.3 å†…å­˜åˆ†é…

å †ä¸Šæ‰€æœ‰çš„å¯¹è±¡éƒ½ä¼šé€šè¿‡è°ƒç”¨ `runtime.newobject` å‡½æ•°åˆ†é…å†…å­˜ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨ `runtime.mallocgc` åˆ†é…æŒ‡å®šå¤§å°çš„å†…å­˜ç©ºé—´ï¼Œè¿™ä¹Ÿæ˜¯ç”¨æˆ·ç¨‹åºå‘å †ä¸Šç”³è¯·å†…å­˜ç©ºé—´çš„å¿…ç»å‡½æ•°ï¼š

```go
func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
	mp := acquirem()
	mp.mallocing = 1

	c := gomcache()
	var x unsafe.Pointer
	noscan := typ == nil || typ.ptrdata == 0
	if size <= maxSmallSize {
		if noscan && size < maxTinySize {
			// å¾®å¯¹è±¡åˆ†é…
		} else {
			// å°å¯¹è±¡åˆ†é…
		}
	} else {
		// å¤§å¯¹è±¡åˆ†é…
	}

	publicationBarrier()
	mp.mallocing = 0
	releasem(mp)

	return x
}
```

ä¸Šè¿°ä»£ç ä½¿ç”¨ [`runtime.gomcache`](https://draven.co/golang/tree/runtime.gomcache) è·å–çº¿ç¨‹ç¼“å­˜å¹¶åˆ¤æ–­ç”³è¯·å†…å­˜çš„ç±»å‹æ˜¯å¦ä¸ºæŒ‡é’ˆã€‚æˆ‘ä»¬ä»è¿™ä¸ªä»£ç ç‰‡æ®µå¯ä»¥çœ‹å‡º [`runtime.mallocgc`](https://draven.co/golang/tree/runtime.mallocgc) ä¼šæ ¹æ®å¯¹è±¡çš„å¤§å°æ‰§è¡Œä¸åŒçš„åˆ†é…é€»è¾‘ï¼Œåœ¨å‰é¢çš„ç« èŠ‚ä¹Ÿæ›¾ç»ä»‹ç»è¿‡è¿è¡Œæ—¶æ ¹æ®å¯¹è±¡å¤§å°å°†å®ƒä»¬åˆ†æˆå¾®å¯¹è±¡ã€å°å¯¹è±¡å’Œå¤§å¯¹è±¡ï¼Œè¿™é‡Œä¼šæ ¹æ®å¤§å°é€‰æ‹©ä¸åŒçš„åˆ†é…é€»è¾‘ï¼š

![](images/image-20250819192552602.png)

- å¾®å¯¹è±¡ `(0, 16B)` â€” å…ˆä½¿ç”¨å¾®å‹åˆ†é…å™¨ï¼Œå†ä¾æ¬¡å°è¯•çº¿ç¨‹ç¼“å­˜ã€ä¸­å¿ƒç¼“å­˜å’Œå †åˆ†é…å†…å­˜ï¼›
- å°å¯¹è±¡ `[16B, 32KB]` â€” ä¾æ¬¡å°è¯•ä½¿ç”¨çº¿ç¨‹ç¼“å­˜ã€ä¸­å¿ƒç¼“å­˜å’Œå †åˆ†é…å†…å­˜ï¼›
- å¤§å¯¹è±¡ `(32KB, +âˆ)` â€” ç›´æ¥åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼›

##### å¾®å¯¹è±¡

Go è¯­è¨€è¿è¡Œæ—¶å°†å°äº 16 å­—èŠ‚çš„å¯¹è±¡åˆ’åˆ†ä¸ºå¾®å¯¹è±¡ï¼Œå®ƒä¼šä½¿ç”¨çº¿ç¨‹ç¼“å­˜ä¸Šçš„å¾®åˆ†é…å™¨æé«˜å¾®å¯¹è±¡åˆ†é…çš„æ€§èƒ½ï¼Œæˆ‘ä»¬ä¸»è¦ä½¿ç”¨å®ƒæ¥åˆ†é…è¾ƒå°çš„å­—ç¬¦ä¸²ä»¥åŠé€ƒé€¸çš„ä¸´æ—¶å˜é‡ã€‚å¾®åˆ†é…å™¨å¯ä»¥å°†å¤šä¸ªè¾ƒå°çš„å†…å­˜åˆ†é…è¯·æ±‚åˆå…¥åŒä¸€ä¸ªå†…å­˜å—ä¸­ï¼Œåªæœ‰å½“å†…å­˜å—ä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½éœ€è¦è¢«å›æ”¶æ—¶ï¼Œæ•´ç‰‡å†…å­˜æ‰å¯èƒ½è¢«å›æ”¶ã€‚

å¾®åˆ†é…å™¨ç®¡ç†çš„å¯¹è±¡ä¸å¯ä»¥æ˜¯æŒ‡é’ˆç±»å‹ï¼Œç®¡ç†å¤šä¸ªå¯¹è±¡çš„å†…å­˜å—å¤§å° `maxTinySize` æ˜¯å¯ä»¥è°ƒæ•´çš„ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå†…å­˜å—çš„å¤§å°ä¸º 16 å­—èŠ‚ã€‚`maxTinySize` çš„å€¼è¶Šå¤§ï¼Œç»„åˆå¤šä¸ªå¯¹è±¡çš„å¯èƒ½æ€§å°±è¶Šé«˜ï¼Œå†…å­˜æµªè´¹ä¹Ÿå°±è¶Šä¸¥é‡ï¼›`maxTinySize` è¶Šå°ï¼Œå†…å­˜æµªè´¹å°±ä¼šè¶Šå°‘ï¼Œä¸è¿‡æ— è®ºå¦‚ä½•è°ƒæ•´ï¼Œ8 çš„å€æ•°éƒ½æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚

![å›¾ 7-20 å¾®åˆ†é…å™¨çš„å·¥ä½œåŸç†](images/image-20250819192715463.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¾®åˆ†é…å™¨å·²ç»åœ¨ 16 å­—èŠ‚çš„å†…å­˜å—ä¸­åˆ†é…äº† 12 å­—èŠ‚çš„å¯¹è±¡ï¼Œå¦‚æœä¸‹ä¸€ä¸ªå¾…åˆ†é…çš„å¯¹è±¡å°äº 4 å­—èŠ‚ï¼Œå®ƒä¼šç›´æ¥ä½¿ç”¨ä¸Šè¿°å†…å­˜å—çš„å‰©ä½™éƒ¨åˆ†ï¼Œå‡å°‘å†…å­˜ç¢ç‰‡ï¼Œä¸è¿‡è¯¥å†…å­˜å—åªæœ‰æ‰€æœ‰å¯¹è±¡éƒ½è¢«æ ‡è®°ä¸ºåƒåœ¾æ—¶æ‰ä¼šå›æ”¶ã€‚

çº¿ç¨‹ç¼“å­˜ [`runtime.mcache`](https://draven.co/golang/tree/runtime.mcache) ä¸­çš„ `tiny` å­—æ®µæŒ‡å‘äº† `maxTinySize` å¤§å°çš„å—ï¼Œå¦‚æœå½“å‰å—ä¸­è¿˜åŒ…å«å¤§å°åˆé€‚çš„ç©ºé—²å†…å­˜ï¼Œè¿è¡Œæ—¶ä¼šé€šè¿‡åŸºåœ°å€å’Œåç§»é‡è·å–å¹¶è¿”å›è¿™å—å†…å­˜ï¼š

```go
func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
	...
	if size <= maxSmallSize {
		if noscan && size < maxTinySize {
			off := c.tinyoffset
			if off+size <= maxTinySize && c.tiny != 0 {
				x = unsafe.Pointer(c.tiny + off)
				c.tinyoffset = off + size
				c.local_tinyallocs++
				releasem(mp)
				return x
			}
			...
		}
		...
	}
	...
}
```

å½“å†…å­˜å—ä¸­ä¸åŒ…å«ç©ºé—²çš„å†…å­˜æ—¶ï¼Œä¸‹é¢çš„è¿™æ®µä»£ç ä¼šå…ˆä»çº¿ç¨‹ç¼“å­˜æ‰¾åˆ°è·¨åº¦ç±»å¯¹åº”çš„å†…å­˜ç®¡ç†å•å…ƒ [`runtime.mspan`](https://draven.co/golang/tree/runtime.mspan)ï¼Œè°ƒç”¨ [`runtime.nextFreeFast`](https://draven.co/golang/tree/runtime.nextFreeFast) è·å–ç©ºé—²çš„å†…å­˜ï¼›å½“ä¸å­˜åœ¨ç©ºé—²å†…å­˜æ—¶ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨ [`runtime.mcache.nextFree`](https://draven.co/golang/tree/runtime.mcache.nextFree) ä»ä¸­å¿ƒç¼“å­˜æˆ–è€…é¡µå †ä¸­è·å–å¯åˆ†é…çš„å†…å­˜å—ï¼š

```go
func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
	...
	if size <= maxSmallSize {
		if noscan && size < maxTinySize {
			...
			span := c.alloc[tinySpanClass]
			v := nextFreeFast(span)
			if v == 0 {
				v, _, _ = c.nextFree(tinySpanClass)
			}
			x = unsafe.Pointer(v)
			(*[2]uint64)(x)[0] = 0
			(*[2]uint64)(x)[1] = 0
			if size < c.tinyoffset || c.tiny == 0 {
				c.tiny = uintptr(x)
				c.tinyoffset = size
			}
			size = maxTinySize
		}
		...
	}
	...
	return x
}
```

è·å–æ–°çš„ç©ºé—²å†…å­˜å—ä¹‹åï¼Œä¸Šè¿°ä»£ç ä¼šæ¸…ç©ºç©ºé—²å†…å­˜ä¸­çš„æ•°æ®ã€æ›´æ–°æ„æˆå¾®å¯¹è±¡åˆ†é…å™¨çš„å‡ ä¸ªå­—æ®µ `tiny` å’Œ `tinyoffset` å¹¶è¿”å›æ–°çš„ç©ºé—²å†…å­˜ã€‚

##### å°å¯¹è±¡

å°å¯¹è±¡æ˜¯æŒ‡å¤§å°ä¸º 16 å­—èŠ‚åˆ° 32,768 å­—èŠ‚çš„å¯¹è±¡ä»¥åŠæ‰€æœ‰å°äº 16 å­—èŠ‚çš„æŒ‡é’ˆç±»å‹çš„å¯¹è±¡ï¼Œå°å¯¹è±¡çš„åˆ†é…å¯ä»¥è¢«åˆ†æˆä»¥ä¸‹çš„ä¸‰ä¸ªæ­¥éª¤ï¼š

1. ç¡®å®šåˆ†é…å¯¹è±¡çš„å¤§å°ä»¥åŠè·¨åº¦ç±» [`runtime.spanClass`](https://draven.co/golang/tree/runtime.spanClass)ï¼›
2. ä»çº¿ç¨‹ç¼“å­˜ã€ä¸­å¿ƒç¼“å­˜æˆ–è€…å †ä¸­è·å–å†…å­˜ç®¡ç†å•å…ƒå¹¶ä»å†…å­˜ç®¡ç†å•å…ƒæ‰¾åˆ°ç©ºé—²çš„å†…å­˜ç©ºé—´ï¼›
3. è°ƒç”¨ [`runtime.memclrNoHeapPointers`](https://draven.co/golang/tree/runtime.memclrNoHeapPointers) æ¸…ç©ºç©ºé—²å†…å­˜ä¸­çš„æ‰€æœ‰æ•°æ®ï¼›

ç¡®å®šå¾…åˆ†é…çš„å¯¹è±¡å¤§å°ä»¥åŠè·¨åº¦ç±»éœ€è¦ä½¿ç”¨é¢„å…ˆè®¡ç®—å¥½çš„ `size_to_class8`ã€`size_to_class128` ä»¥åŠ `class_to_size` å­—å…¸ï¼Œè¿™äº›å­—å…¸èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿè·å–å¯¹åº”çš„å€¼å¹¶æ„å»º [`runtime.spanClass`](https://draven.co/golang/tree/runtime.spanClass)ï¼š

```go
func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
	...
	if size <= maxSmallSize {
		...
		} else {
			var sizeclass uint8
			if size <= smallSizeMax-8 {
				sizeclass = size_to_class8[(size+smallSizeDiv-1)/smallSizeDiv]
			} else {
				sizeclass = size_to_class128[(size-smallSizeMax+largeSizeDiv-1)/largeSizeDiv]
			}
			size = uintptr(class_to_size[sizeclass])
			spc := makeSpanClass(sizeclass, noscan)
			span := c.alloc[spc]
			v := nextFreeFast(span)
			if v == 0 {
				v, span, _ = c.nextFree(spc)
			}
			x = unsafe.Pointer(v)
			if needzero && span.needzero != 0 {
				memclrNoHeapPointers(unsafe.Pointer(v), size)
			}
		}
	} else {
		...
	}
	...
	return x
}
```

åœ¨ä¸Šè¿°ä»£ç ç‰‡æ®µä¸­ï¼Œæˆ‘ä»¬ä¼šé‡ç‚¹åˆ†æä¸¤ä¸ªæ–¹æ³•çš„å®ç°åŸç†ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ [`runtime.nextFreeFast`](https://draven.co/golang/tree/runtime.nextFreeFast) å’Œ [`runtime.mcache.nextFree`](https://draven.co/golang/tree/runtime.mcache.nextFree)ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•ä¼šå¸®åŠ©æˆ‘ä»¬è·å–ç©ºé—²çš„å†…å­˜ç©ºé—´ã€‚[`runtime.nextFreeFast`](https://draven.co/golang/tree/runtime.nextFreeFast) ä¼šåˆ©ç”¨å†…å­˜ç®¡ç†å•å…ƒä¸­çš„ `allocCache` å­—æ®µï¼Œå¿«é€Ÿæ‰¾åˆ°è¯¥å­—æ®µä¸º 1 çš„ä½æ•°ï¼Œæˆ‘ä»¬åœ¨ä¸Šé¢ä»‹ç»è¿‡ 1 è¡¨ç¤ºè¯¥ä½å¯¹åº”çš„å†…å­˜ç©ºé—´æ˜¯ç©ºé—²çš„ï¼š

```go
func nextFreeFast(s *mspan) gclinkptr {
	theBit := sys.Ctz64(s.allocCache)
	if theBit < 64 {
		result := s.freeindex + uintptr(theBit)
		if result < s.nelems {
			freeidx := result + 1
			if freeidx%64 == 0 && freeidx != s.nelems {
				return 0
			}
			s.allocCache >>= uint(theBit + 1)
			s.freeindex = freeidx
			s.allocCount++
			return gclinkptr(result*s.elemsize + s.base())
		}
	}
	return 0
}
```

æ‰¾åˆ°äº†ç©ºé—²çš„å¯¹è±¡åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ›´æ–°å†…å­˜ç®¡ç†å•å…ƒçš„ `allocCache`ã€`freeindex` ç­‰å­—æ®µå¹¶è¿”å›è¯¥ç‰‡å†…å­˜ï¼›å¦‚æœæˆ‘ä»¬æ²¡æœ‰æ‰¾åˆ°ç©ºé—²çš„å†…å­˜ï¼Œè¿è¡Œæ—¶ä¼šé€šè¿‡ [`runtime.mcache.nextFree`](https://draven.co/golang/tree/runtime.mcache.nextFree) æ‰¾åˆ°æ–°çš„å†…å­˜ç®¡ç†å•å…ƒï¼š

```go
func (c *mcache) nextFree(spc spanClass) (v gclinkptr, s *mspan, shouldhelpgc bool) {
	s = c.alloc[spc]
	freeIndex := s.nextFreeIndex()
	if freeIndex == s.nelems {
		c.refill(spc)
		s = c.alloc[spc]
		freeIndex = s.nextFreeIndex()
	}

	v = gclinkptr(freeIndex*s.elemsize + s.base())
	s.allocCount++
	return
}
```

åœ¨ä¸Šè¿°æ–¹æ³•ä¸­ï¼Œå¦‚æœæˆ‘ä»¬åœ¨çº¿ç¨‹ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œä¼šé€šè¿‡å‰é¢ä»‹ç»çš„ [`runtime.mcache.refill`](https://draven.co/golang/tree/runtime.mcache.refill) ä½¿ç”¨ä¸­å¿ƒç¼“å­˜ä¸­çš„å†…å­˜ç®¡ç†å•å…ƒæ›¿æ¢å·²ç»ä¸å­˜åœ¨å¯ç”¨å¯¹è±¡çš„ç»“æ„ä½“ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨æ–°ç»“æ„ä½“çš„ [`runtime.mspan.nextFreeIndex`](https://draven.co/golang/tree/runtime.mspan.nextFreeIndex) è·å–ç©ºé—²çš„å†…å­˜å¹¶è¿”å›ã€‚

##### å¤§å¯¹è±¡

è¿è¡Œæ—¶å¯¹äºå¤§äº 32KB çš„å¤§å¯¹è±¡ä¼šå•ç‹¬å¤„ç†ï¼Œæˆ‘ä»¬ä¸ä¼šä»çº¿ç¨‹ç¼“å­˜æˆ–è€…ä¸­å¿ƒç¼“å­˜ä¸­è·å–å†…å­˜ç®¡ç†å•å…ƒï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨ [`runtime.mcache.allocLarge`](https://draven.co/golang/tree/runtime.mcache.allocLarge) åˆ†é…å¤§ç‰‡å†…å­˜ï¼š

```go
func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
	...
	if size <= maxSmallSize {
		...
	} else {
		var s *mspan
		span = c.allocLarge(size, needzero, noscan)
		span.freeindex = 1
		span.allocCount = 1
		x = unsafe.Pointer(span.base())
		size = span.elemsize
	}

	publicationBarrier()
	mp.mallocing = 0
	releasem(mp)

	return x
}
```

[`runtime.mcache.allocLarge`](https://draven.co/golang/tree/runtime.mcache.allocLarge) ä¼šè®¡ç®—åˆ†é…è¯¥å¯¹è±¡æ‰€éœ€è¦çš„é¡µæ•°ï¼Œå®ƒæŒ‰ç…§ 8KB çš„å€æ•°åœ¨å †ä¸Šç”³è¯·å†…å­˜ï¼š

```go
func (c *mcache) allocLarge(size uintptr, needzero bool, noscan bool) *mspan {
	npages := size >> _PageShift
	if size&_PageMask != 0 {
		npages++
	}
	...
	s := mheap_.alloc(npages, spc, needzero)
	mheap_.central[spc].mcentral.fullSwept(mheap_.sweepgen).push(s)
	s.limit = s.base() + size
	heapBitsForAddr(s.base()).initSpan(s)
	return s
}
```

ç”³è¯·å†…å­˜æ—¶ä¼šåˆ›å»ºä¸€ä¸ªè·¨åº¦ç±»ä¸º 0 çš„ [`runtime.spanClass`](https://draven.co/golang/tree/runtime.spanClass) å¹¶è°ƒç”¨ [`runtime.mheap.alloc`](https://draven.co/golang/tree/runtime.mheap.alloc) åˆ†é…ä¸€ä¸ªç®¡ç†å¯¹åº”å†…å­˜çš„ç®¡ç†å•å…ƒã€‚

#### 73.1.4 å°ç»“

å†…å­˜åˆ†é…æ˜¯ Go è¯­è¨€è¿è¡Œæ—¶å†…å­˜ç®¡ç†çš„æ ¸å¿ƒé€»è¾‘ï¼Œè¿è¡Œæ—¶çš„å†…å­˜åˆ†é…å™¨ä½¿ç”¨ç±»ä¼¼ TCMalloc çš„åˆ†é…ç­–ç•¥å°†å¯¹è±¡æ ¹æ®å¤§å°åˆ†ç±»ï¼Œå¹¶è®¾è®¡å¤šå±‚çº§çš„ç»„ä»¶æé«˜å†…å­˜åˆ†é…å™¨çš„æ€§èƒ½ã€‚æœ¬èŠ‚ä¸ä»…ä»‹ç»äº† Go è¯­è¨€å†…å­˜åˆ†é…å™¨çš„è®¾è®¡ä¸å®ç°åŸç†ï¼ŒåŒæ—¶ä¹Ÿä»‹ç»äº†å†…å­˜åˆ†é…å™¨çš„å¸¸è§è®¾è®¡ï¼Œå¸®åŠ©æˆ‘ä»¬ç†è§£ä¸åŒç¼–ç¨‹è¯­è¨€åœ¨è®¾è®¡å†…å­˜åˆ†é…å™¨æ—¶åšå‡ºçš„ä¸åŒé€‰æ‹©ã€‚

å†…å­˜åˆ†é…å™¨è™½ç„¶éå¸¸é‡è¦ï¼Œä½†æ˜¯å®ƒåªè§£å†³äº†å¦‚ä½•åˆ†é…å†…å­˜çš„é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨æœ¬èŠ‚ä¸­çœç•¥äº†å¾ˆå¤šä¸åƒåœ¾å›æ”¶ç›¸å…³çš„ä»£ç ï¼Œæ²¡æœ‰åˆ†æè¿è¡Œæ—¶åƒåœ¾å›æ”¶çš„å®ç°åŸç†ï¼Œåœ¨ä¸‹ä¸€èŠ‚ä¸­æˆ‘ä»¬å°†è¯¦ç»†åˆ†æ Go è¯­è¨€åƒåœ¾å›æ”¶çš„è®¾è®¡ä¸å®ç°åŸç†ã€‚

### 73.2 åƒåœ¾æ”¶é›†å™¨

ç¼–ç¨‹è¯­è¨€çš„å†…å­˜ç®¡ç†ç³»ç»Ÿé™¤äº†è´Ÿè´£å †å†…å­˜çš„åˆ†é…ä¹‹å¤–ï¼Œå®ƒè¿˜éœ€è¦è´Ÿè´£å›æ”¶ä¸å†ä½¿ç”¨çš„å¯¹è±¡å’Œå†…å­˜ç©ºé—´ã€‚

#### 73.2.1 è®¾è®¡åŸç†

##### æ ‡è®°æ¸…é™¤

==æ ‡è®°æ¸…é™¤ï¼ˆMark-Sweepï¼‰==ç®—æ³•æ˜¯æœ€å¸¸è§çš„åƒåœ¾æ”¶é›†ç®—æ³•ï¼Œæ ‡è®°æ¸…é™¤æ”¶é›†å™¨æ˜¯è·Ÿè¸ªå¼åƒåœ¾æ”¶é›†å™¨ï¼Œå…¶æ‰§è¡Œè¿‡ç¨‹å¯ä»¥åˆ†æˆ==æ ‡è®°ï¼ˆMarkï¼‰==å’Œ==æ¸…é™¤ï¼ˆSweepï¼‰==ä¸¤ä¸ªé˜¶æ®µï¼š

1. æ ‡è®°é˜¶æ®µ â€” ä»æ ¹å¯¹è±¡å‡ºå‘æŸ¥æ‰¾å¹¶æ ‡è®°å †ä¸­æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡ï¼›
2. æ¸…é™¤é˜¶æ®µ â€” éå†å †ä¸­çš„å…¨éƒ¨å¯¹è±¡ï¼Œå›æ”¶æœªè¢«æ ‡è®°çš„åƒåœ¾å¯¹è±¡å¹¶å°†å›æ”¶çš„å†…å­˜åŠ å…¥ç©ºé—²é“¾è¡¨ï¼›

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå†…å­˜ç©ºé—´ä¸­åŒ…å«å¤šä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬ä»æ ¹å¯¹è±¡å‡ºå‘ä¾æ¬¡éå†å¯¹è±¡çš„å­å¯¹è±¡å¹¶å°†ä»æ ¹èŠ‚ç‚¹å¯è¾¾çš„å¯¹è±¡éƒ½æ ‡è®°æˆå­˜æ´»çŠ¶æ€ï¼Œå³ Aã€C å’Œ D ä¸‰ä¸ªå¯¹è±¡ï¼Œå‰©ä½™çš„ Bã€E å’Œ F ä¸‰ä¸ªå¯¹è±¡å› ä¸ºä»æ ¹èŠ‚ç‚¹ä¸å¯è¾¾ï¼Œæ‰€ä»¥ä¼šè¢«å½“åšåƒåœ¾ï¼š

![](images/image-20250819193350495.png)

æ ‡è®°é˜¶æ®µç»“æŸåä¼šè¿›å…¥æ¸…é™¤é˜¶æ®µï¼Œåœ¨è¯¥é˜¶æ®µä¸­æ”¶é›†å™¨ä¼šä¾æ¬¡éå†å †ä¸­çš„æ‰€æœ‰å¯¹è±¡ï¼Œé‡Šæ”¾å…¶ä¸­æ²¡æœ‰è¢«æ ‡è®°çš„ Bã€E å’Œ F ä¸‰ä¸ªå¯¹è±¡å¹¶å°†æ–°çš„ç©ºé—²å†…å­˜ç©ºé—´ä»¥é“¾è¡¨çš„ç»“æ„ä¸²è”èµ·æ¥ï¼Œæ–¹ä¾¿å†…å­˜åˆ†é…å™¨çš„ä½¿ç”¨ã€‚

![](images/image-20250819193416995.png)

è¿™é‡Œä»‹ç»çš„æ˜¯æœ€ä¼ ç»Ÿçš„æ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œåƒåœ¾æ”¶é›†å™¨ä»åƒåœ¾æ”¶é›†çš„æ ¹å¯¹è±¡å‡ºå‘ï¼Œé€’å½’éå†è¿™äº›å¯¹è±¡æŒ‡å‘çš„å­å¯¹è±¡å¹¶å°†æ‰€æœ‰å¯è¾¾çš„å¯¹è±¡æ ‡è®°æˆå­˜æ´»ï¼›æ ‡è®°é˜¶æ®µç»“æŸåï¼Œåƒåœ¾æ”¶é›†å™¨ä¼šä¾æ¬¡éå†å †ä¸­çš„å¯¹è±¡å¹¶æ¸…é™¤å…¶ä¸­çš„åƒåœ¾ï¼Œæ•´ä¸ªè¿‡ç¨‹éœ€è¦æ ‡è®°å¯¹è±¡çš„å­˜æ´»çŠ¶æ€ï¼Œç”¨æˆ·ç¨‹åºåœ¨åƒåœ¾æ”¶é›†çš„è¿‡ç¨‹ä¸­ä¹Ÿä¸èƒ½æ‰§è¡Œï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°æ›´å¤æ‚çš„æœºåˆ¶æ¥è§£å†³ STW çš„é—®é¢˜ã€‚

##### ä¸‰è‰²æŠ½è±¡

ä¸ºäº†è§£å†³åŸå§‹æ ‡è®°æ¸…é™¤ç®—æ³•å¸¦æ¥çš„é•¿æ—¶é—´ STWï¼Œå¤šæ•°ç°ä»£çš„è¿½è¸ªå¼åƒåœ¾æ”¶é›†å™¨éƒ½ä¼šå®ç°ä¸‰è‰²æ ‡è®°ç®—æ³•çš„å˜ç§ä»¥ç¼©çŸ­ STW çš„æ—¶é—´ã€‚ä¸‰è‰²æ ‡è®°ç®—æ³•å°†ç¨‹åºä¸­çš„å¯¹è±¡åˆ†æˆç™½è‰²ã€é»‘è‰²å’Œç°è‰²ä¸‰ç±»ï¼š

- ç™½è‰²å¯¹è±¡ â€” æ½œåœ¨çš„åƒåœ¾ï¼Œå…¶å†…å­˜å¯èƒ½ä¼šè¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶ï¼›
- é»‘è‰²å¯¹è±¡ â€” æ´»è·ƒçš„å¯¹è±¡ï¼ŒåŒ…æ‹¬ä¸å­˜åœ¨ä»»ä½•å¼•ç”¨å¤–éƒ¨æŒ‡é’ˆçš„å¯¹è±¡ä»¥åŠä»æ ¹å¯¹è±¡å¯è¾¾çš„å¯¹è±¡ï¼›
- ç°è‰²å¯¹è±¡ â€” æ´»è·ƒçš„å¯¹è±¡ï¼Œå› ä¸ºå­˜åœ¨æŒ‡å‘ç™½è‰²å¯¹è±¡çš„å¤–éƒ¨æŒ‡é’ˆï¼Œåƒåœ¾æ”¶é›†å™¨ä¼šæ‰«æè¿™äº›å¯¹è±¡çš„å­å¯¹è±¡ï¼›

åœ¨åƒåœ¾æ”¶é›†å™¨å¼€å§‹å·¥ä½œæ—¶ï¼Œç¨‹åºä¸­ä¸å­˜åœ¨ä»»ä½•çš„é»‘è‰²å¯¹è±¡ï¼Œåƒåœ¾æ”¶é›†çš„æ ¹å¯¹è±¡ä¼šè¢«æ ‡è®°æˆ**ç°è‰²**ï¼Œåƒåœ¾æ”¶é›†å™¨åªä¼šä»ç°è‰²å¯¹è±¡é›†åˆä¸­å–å‡ºå¯¹è±¡å¼€å§‹æ‰«æï¼Œå½“ç°è‰²é›†åˆä¸­ä¸å­˜åœ¨ä»»ä½•å¯¹è±¡æ—¶ï¼Œæ ‡è®°é˜¶æ®µå°±ä¼šç»“æŸã€‚

![ä¸‰è‰²æ ‡è®°åƒåœ¾æ”¶é›†å™¨çš„æ‰§è¡Œè¿‡ç¨‹](images/image-20250819193636290.png)

ä¸‰è‰²æ ‡è®°åƒåœ¾æ”¶é›†å™¨çš„å·¥ä½œåŸç†å¾ˆç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶å½’çº³æˆä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

1. ä»ç°è‰²å¯¹è±¡çš„é›†åˆä¸­é€‰æ‹©ä¸€ä¸ªç°è‰²å¯¹è±¡å¹¶å°†å…¶æ ‡è®°æˆé»‘è‰²ï¼›
2. å°†é»‘è‰²å¯¹è±¡æŒ‡å‘çš„æ‰€æœ‰å¯¹è±¡éƒ½æ ‡è®°æˆç°è‰²ï¼Œä¿è¯è¯¥å¯¹è±¡å’Œè¢«è¯¥å¯¹è±¡å¼•ç”¨çš„å¯¹è±¡éƒ½ä¸ä¼šè¢«å›æ”¶ï¼›
3. é‡å¤ä¸Šè¿°ä¸¤ä¸ªæ­¥éª¤ç›´åˆ°å¯¹è±¡å›¾ä¸­ä¸å­˜åœ¨ç°è‰²å¯¹è±¡ï¼›

å½“ä¸‰è‰²çš„æ ‡è®°æ¸…é™¤çš„æ ‡è®°é˜¶æ®µç»“æŸä¹‹åï¼Œåº”ç”¨ç¨‹åºçš„å †ä¸­å°±ä¸å­˜åœ¨ä»»ä½•çš„ç°è‰²å¯¹è±¡ï¼Œæˆ‘ä»¬åªèƒ½çœ‹åˆ°é»‘è‰²çš„å­˜æ´»å¯¹è±¡ä»¥åŠç™½è‰²çš„åƒåœ¾å¯¹è±¡ï¼Œåƒåœ¾æ”¶é›†å™¨å¯ä»¥å›æ”¶è¿™äº›ç™½è‰²çš„åƒåœ¾ï¼Œä¸‹é¢æ˜¯ä½¿ç”¨ä¸‰è‰²æ ‡è®°åƒåœ¾æ”¶é›†å™¨æ‰§è¡Œæ ‡è®°åçš„å †å†…å­˜ï¼Œå †ä¸­åªæœ‰å¯¹è±¡ D ä¸ºå¾…å›æ”¶çš„åƒåœ¾ï¼š

![ä¸‰è‰²æ ‡è®°åçš„å †](images/image-20250819193727108.png)

å› ä¸ºç”¨æˆ·ç¨‹åºå¯èƒ½åœ¨æ ‡è®°æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¿®æ”¹å¯¹è±¡çš„æŒ‡é’ˆï¼Œæ‰€ä»¥ä¸‰è‰²æ ‡è®°æ¸…é™¤ç®—æ³•æœ¬èº«æ˜¯ä¸å¯ä»¥å¹¶å‘æˆ–è€…å¢é‡æ‰§è¡Œçš„ï¼Œå®ƒä»ç„¶éœ€è¦ STWï¼Œåœ¨å¦‚ä¸‹æ‰€ç¤ºçš„ä¸‰è‰²æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·ç¨‹åºå»ºç«‹äº†ä» A å¯¹è±¡åˆ° D å¯¹è±¡çš„å¼•ç”¨ï¼Œä½†æ˜¯å› ä¸ºç¨‹åºä¸­å·²ç»ä¸å­˜åœ¨ç°è‰²å¯¹è±¡äº†ï¼Œæ‰€ä»¥ D å¯¹è±¡ä¼šè¢«åƒåœ¾æ”¶é›†å™¨é”™è¯¯åœ°å›æ”¶ã€‚

![å›¾ 7-27 ä¸‰è‰²æ ‡è®°ä¸ç”¨æˆ·ç¨‹åº](images/image-20250819193808300.png)

æœ¬æ¥ä¸åº”è¯¥è¢«å›æ”¶çš„å¯¹è±¡å´è¢«å›æ”¶äº†ï¼Œè¿™åœ¨å†…å­˜ç®¡ç†ä¸­æ˜¯éå¸¸ä¸¥é‡çš„é”™è¯¯ï¼Œæˆ‘ä»¬å°†è¿™ç§é”™è¯¯ç§°ä¸º**æ‚¬æŒ‚æŒ‡é’ˆ**ï¼Œå³æŒ‡é’ˆæ²¡æœ‰æŒ‡å‘ç‰¹å®šç±»å‹çš„åˆæ³•å¯¹è±¡ï¼Œå½±å“äº†å†…å­˜çš„å®‰å…¨æ€§ï¼Œæƒ³è¦å¹¶å‘æˆ–è€…å¢é‡åœ°æ ‡è®°å¯¹è±¡è¿˜æ˜¯éœ€è¦ä½¿ç”¨å±éšœæŠ€æœ¯ã€‚

##### å±éšœæŠ€æœ¯

å†…å­˜å±éšœæŠ€æœ¯æ˜¯ä¸€ç§å±éšœæŒ‡ä»¤ï¼Œå®ƒå¯ä»¥è®© CPU æˆ–è€…ç¼–è¯‘å™¨åœ¨æ‰§è¡Œå†…å­˜ç›¸å…³æ“ä½œæ—¶éµå¾ªç‰¹å®šçš„çº¦æŸï¼Œç›®å‰å¤šæ•°çš„ç°ä»£å¤„ç†å™¨éƒ½ä¼šä¹±åºæ‰§è¡ŒæŒ‡ä»¤ä»¥æœ€å¤§åŒ–æ€§èƒ½ï¼Œä½†æ˜¯è¯¥æŠ€æœ¯èƒ½å¤Ÿä¿è¯å†…å­˜æ“ä½œçš„é¡ºåºæ€§ï¼Œåœ¨å†…å­˜å±éšœå‰æ‰§è¡Œçš„æ“ä½œä¸€å®šä¼šå…ˆäºå†…å­˜å±éšœåæ‰§è¡Œçš„æ“ä½œã€‚

æƒ³è¦åœ¨å¹¶å‘æˆ–è€…å¢é‡çš„æ ‡è®°ç®—æ³•ä¸­ä¿è¯æ­£ç¡®æ€§ï¼Œæˆ‘ä»¬éœ€è¦è¾¾æˆä»¥ä¸‹ä¸¤ç§ä¸‰è‰²ä¸å˜æ€§ï¼ˆTri-color invariantï¼‰ä¸­çš„ä¸€ç§ï¼š

- å¼ºä¸‰è‰²ä¸å˜æ€§ â€” é»‘è‰²å¯¹è±¡ä¸ä¼šæŒ‡å‘ç™½è‰²å¯¹è±¡ï¼Œåªä¼šæŒ‡å‘ç°è‰²å¯¹è±¡æˆ–è€…é»‘è‰²å¯¹è±¡ï¼›
- å¼±ä¸‰è‰²ä¸å˜æ€§ â€” é»‘è‰²å¯¹è±¡æŒ‡å‘çš„ç™½è‰²å¯¹è±¡å¿…é¡»åŒ…å«ä¸€æ¡ä»ç°è‰²å¯¹è±¡ç»ç”±å¤šä¸ªç™½è‰²å¯¹è±¡çš„å¯è¾¾è·¯å¾„ï¼›

![å›¾ 7-28 ä¸‰è‰²ä¸å˜æ€§](images/image-20250819193945061.png)

ä¸Šå›¾åˆ†åˆ«å±•ç¤ºäº†éµå¾ªå¼ºä¸‰è‰²ä¸å˜æ€§å’Œå¼±ä¸‰è‰²ä¸å˜æ€§çš„å †å†…å­˜ï¼Œéµå¾ªä¸Šè¿°ä¸¤ä¸ªä¸å˜æ€§ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œæˆ‘ä»¬éƒ½èƒ½ä¿è¯åƒåœ¾æ”¶é›†ç®—æ³•çš„æ­£ç¡®æ€§ï¼Œè€Œå±éšœæŠ€æœ¯å°±æ˜¯åœ¨å¹¶å‘æˆ–è€…å¢é‡æ ‡è®°è¿‡ç¨‹ä¸­ä¿è¯ä¸‰è‰²ä¸å˜æ€§çš„é‡è¦æŠ€æœ¯ã€‚

åƒåœ¾æ”¶é›†ä¸­çš„å±éšœæŠ€æœ¯æ›´åƒæ˜¯ä¸€ä¸ªé’©å­æ–¹æ³•ï¼Œå®ƒæ˜¯åœ¨ç”¨æˆ·ç¨‹åºè¯»å–å¯¹è±¡ã€åˆ›å»ºæ–°å¯¹è±¡ä»¥åŠæ›´æ–°å¯¹è±¡æŒ‡é’ˆæ—¶æ‰§è¡Œçš„ä¸€æ®µä»£ç ï¼Œæ ¹æ®æ“ä½œç±»å‹çš„ä¸åŒï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬åˆ†æˆè¯»å±éšœï¼ˆRead barrierï¼‰å’Œå†™å±éšœï¼ˆWrite barrierï¼‰ä¸¤ç§ï¼Œå› ä¸ºè¯»å±éšœéœ€è¦åœ¨è¯»æ“ä½œä¸­åŠ å…¥ä»£ç ç‰‡æ®µï¼Œå¯¹ç”¨æˆ·ç¨‹åºçš„æ€§èƒ½å½±å“å¾ˆå¤§ï¼Œæ‰€ä»¥ç¼–ç¨‹è¯­è¨€å¾€å¾€éƒ½ä¼šé‡‡ç”¨å†™å±éšœä¿è¯ä¸‰è‰²ä¸å˜æ€§ã€‚

æˆ‘ä»¬åœ¨è¿™é‡Œæƒ³è¦ä»‹ç»çš„æ˜¯ Go è¯­è¨€ä¸­ä½¿ç”¨çš„ä¸¤ç§å†™å±éšœæŠ€æœ¯ï¼Œåˆ†åˆ«æ˜¯ Dijkstra æå‡ºçš„æ’å…¥å†™å±éšœå’Œ Yuasa æå‡ºçš„åˆ é™¤å†™å±éšœï¼Œè¿™é‡Œä¼šåˆ†æå®ƒä»¬å¦‚ä½•ä¿è¯ä¸‰è‰²ä¸å˜æ€§å’Œåƒåœ¾æ”¶é›†å™¨çš„æ­£ç¡®æ€§ã€‚

###### æ’å…¥å†™å±éšœğŸ”–



###### åˆ é™¤å†™å±éšœ





##### å¢é‡å’Œå¹¶å‘

###### å¢é‡æ”¶é›†å™¨



###### å¹¶å‘æ”¶é›†å™¨

#### 73.2.2 æ¼”è¿›è¿‡ç¨‹

1. [v1.0](https://github.com/golang/go/blob/go1.0.1/src/pkg/runtime/mgc0.c#L882) â€” å®Œå…¨ä¸²è¡Œçš„æ ‡è®°å’Œæ¸…é™¤è¿‡ç¨‹ï¼Œéœ€è¦æš‚åœæ•´ä¸ªç¨‹åºï¼›
2. [v1.1](https://github.com/golang/go/blob/go1.1/src/pkg/runtime/mgc0.c#L1938) â€” åœ¨å¤šæ ¸ä¸»æœºå¹¶è¡Œæ‰§è¡Œåƒåœ¾æ”¶é›†çš„æ ‡è®°å’Œæ¸…é™¤é˜¶æ®µï¼›
3. [v1.3](https://github.com/golang/go/blob/go1.3/src/pkg/runtime/mgc0.c#L2268) â€” è¿è¡Œæ—¶åŸºäº**åªæœ‰æŒ‡é’ˆç±»å‹çš„å€¼åŒ…å«æŒ‡é’ˆ**çš„å‡è®¾å¢åŠ äº†å¯¹æ ˆå†…å­˜çš„ç²¾ç¡®æ‰«ææ”¯æŒï¼Œå®ç°äº†çœŸæ­£ç²¾ç¡®çš„åƒåœ¾æ”¶é›†ï¼›
   - å°† `unsafe.Pointer` ç±»å‹è½¬æ¢æˆæ•´æ•°ç±»å‹çš„å€¼è®¤å®šä¸ºä¸åˆæ³•çš„ï¼Œå¯èƒ½ä¼šé€ æˆæ‚¬æŒ‚æŒ‡é’ˆç­‰ä¸¥é‡é—®é¢˜ï¼›
4. [v1.5](https://github.com/golang/go/blob/go1.5/src/runtime/mgc.go#L903) â€” å®ç°äº†åŸºäº**ä¸‰è‰²æ ‡è®°æ¸…æ‰«çš„å¹¶å‘**åƒåœ¾æ”¶é›†å™¨ï¼›
   - å¤§å¹…åº¦é™ä½åƒåœ¾æ”¶é›†çš„å»¶è¿Ÿä»å‡ ç™¾ ms é™ä½è‡³ 10ms ä»¥ä¸‹ï¼›
   - è®¡ç®—åƒåœ¾æ”¶é›†å¯åŠ¨çš„åˆé€‚æ—¶é—´å¹¶é€šè¿‡å¹¶å‘åŠ é€Ÿåƒåœ¾æ”¶é›†çš„è¿‡ç¨‹ï¼›
5. [v1.6](https://github.com/golang/go/blob/go1.6/src/runtime/mgc.go#L869) â€” å®ç°äº†**å»ä¸­å¿ƒåŒ–**çš„åƒåœ¾æ”¶é›†åè°ƒå™¨ï¼›
   - åŸºäºæ˜¾å¼çš„çŠ¶æ€æœºä½¿å¾—ä»»æ„ Goroutine éƒ½èƒ½è§¦å‘åƒåœ¾æ”¶é›†çš„çŠ¶æ€è¿ç§»ï¼›
   - ä½¿ç”¨å¯†é›†çš„ä½å›¾æ›¿ä»£ç©ºé—²é“¾è¡¨è¡¨ç¤ºçš„å †å†…å­˜ï¼Œé™ä½æ¸…é™¤é˜¶æ®µçš„ CPU å ç”¨ï¼›
6. [v1.7](https://github.com/golang/go/blob/go1.7/src/runtime/mgc.go#L884) â€” é€šè¿‡**å¹¶è¡Œæ ˆæ”¶ç¼©**å°†åƒåœ¾æ”¶é›†çš„æ—¶é—´ç¼©çŸ­è‡³ 2ms ä»¥å†…ï¼›
7. [v1.8](https://github.com/golang/go/blob/go1.8/src/runtime/mgc.go#L930) â€” ä½¿ç”¨**æ··åˆå†™å±éšœ**å°†åƒåœ¾æ”¶é›†çš„æ—¶é—´ç¼©çŸ­è‡³ 0.5ms ä»¥å†…ï¼›
8. [v1.9](https://github.com/golang/go/blob/go1.9/src/runtime/mgc.go#L1187) â€” å½»åº•ç§»é™¤æš‚åœç¨‹åºçš„é‡æ–°æ‰«ææ ˆçš„è¿‡ç¨‹ï¼›
9. [v1.10](https://github.com/golang/go/blob/go1.10/src/runtime/mgc.go#L1239) â€” æ›´æ–°äº†åƒåœ¾æ”¶é›†è°ƒé¢‘å™¨ï¼ˆPacerï¼‰çš„å®ç°ï¼Œåˆ†ç¦»è½¯ç¡¬å †å¤§å°çš„ç›®æ ‡ï¼›
10. [v1.12](https://github.com/golang/go/blob/go1.12/src/runtime/mgc.go#L1199) â€” ä½¿ç”¨**æ–°çš„æ ‡è®°ç»ˆæ­¢ç®—æ³•**ç®€åŒ–åƒåœ¾æ”¶é›†å™¨çš„å‡ ä¸ªé˜¶æ®µï¼›
11. [v1.13](https://github.com/golang/go/blob/go1.13/src/runtime/mgc.go#L1200) â€” é€šè¿‡æ–°çš„ Scavenger è§£å†³ç¬æ—¶å†…å­˜å ç”¨è¿‡é«˜çš„åº”ç”¨ç¨‹åºå‘æ“ä½œç³»ç»Ÿå½’è¿˜å†…å­˜çš„é—®é¢˜ï¼›
12. [v1.14](https://github.com/golang/go/blob/go1.14/src/runtime/mgc.go#L1221) â€” ä½¿ç”¨å…¨æ–°çš„é¡µåˆ†é…å™¨**ä¼˜åŒ–å†…å­˜åˆ†é…çš„é€Ÿåº¦**ï¼›

##### å¹¶å‘åƒåœ¾æ”¶é›†



##### å›æ”¶å †ç›®æ ‡



##### æ··åˆå†™å±éšœ



#### 73.2.3 å®ç°åŸç†

##### å…¨å±€å˜é‡



##### è§¦å‘æ—¶æœº



##### åƒåœ¾æ”¶é›†å¯åŠ¨



##### å¹¶å‘æ‰«æä¸æ ‡è®°è¾…åŠ©



##### æ ‡è®°ç»ˆæ­¢



##### å†…å­˜æ¸…ç†



### 73.3 æ ˆç©ºé—´ç®¡ç†

#### 73.3.1 è®¾è®¡åŸç†

æ ˆåŒºçš„å†…å­˜ä¸€èˆ¬ç”±ç¼–è¯‘å™¨è‡ªåŠ¨åˆ†é…å’Œé‡Šæ”¾ï¼Œå…¶ä¸­å­˜å‚¨ç€å‡½æ•°çš„å…¥å‚ä»¥åŠå±€éƒ¨å˜é‡ï¼Œè¿™äº›å‚æ•°ä¼šéšç€å‡½æ•°çš„åˆ›å»ºè€Œåˆ›å»ºï¼Œå‡½æ•°çš„è¿”å›è€Œæ¶ˆäº¡ï¼Œä¸€èˆ¬ä¸ä¼šåœ¨ç¨‹åºä¸­é•¿æœŸå­˜åœ¨ï¼Œè¿™ç§çº¿æ€§çš„å†…å­˜åˆ†é…ç­–ç•¥æœ‰ç€æé«˜åœ°æ•ˆç‡ï¼Œä½†æ˜¯å·¥ç¨‹å¸ˆä¹Ÿå¾€å¾€ä¸èƒ½æ§åˆ¶æ ˆå†…å­˜çš„åˆ†é…ï¼Œè¿™éƒ¨åˆ†å·¥ä½œåŸºæœ¬éƒ½æ˜¯ç”±ç¼–è¯‘å™¨å®Œæˆçš„ã€‚

##### å¯„å­˜å™¨

å¯„å­˜å™¨æ˜¯ä¸­å¤®å¤„ç†å™¨ï¼ˆCPUï¼‰ä¸­çš„ç¨€ç¼ºèµ„æºï¼Œå®ƒçš„å­˜å‚¨èƒ½åŠ›éå¸¸æœ‰é™ï¼Œä½†æ˜¯èƒ½æä¾›æœ€å¿«çš„è¯»å†™é€Ÿåº¦ï¼Œå……åˆ†åˆ©ç”¨å¯„å­˜å™¨çš„é€Ÿåº¦å¯ä»¥æ„å»ºé«˜æ€§èƒ½çš„åº”ç”¨ç¨‹åºã€‚å¯„å­˜å™¨åœ¨ç‰©ç†æœºä¸Šéå¸¸æœ‰é™ï¼Œç„¶è€Œæ ˆåŒºçš„æ“ä½œä¼šä½¿ç”¨åˆ°ä¸¤ä¸ªä»¥ä¸Šçš„å¯„å­˜å™¨ï¼Œè¿™è¶³ä»¥è¯´æ˜æ ˆå†…å­˜åœ¨åº”ç”¨ç¨‹åºçš„é‡è¦æ€§ã€‚

**æ ˆå¯„å­˜å™¨æ˜¯ CPU å¯„å­˜å™¨ä¸­çš„ä¸€ç§**ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯**è·Ÿè¸ªå‡½æ•°çš„è°ƒç”¨æ ˆ**ï¼ŒGo è¯­è¨€çš„æ±‡ç¼–ä»£ç åŒ…å« ==BP== å’Œ ==SP== ä¸¤ä¸ªæ ˆå¯„å­˜å™¨ï¼Œå®ƒä»¬åˆ†åˆ«å­˜å‚¨äº†æ ˆçš„**åŸºå€æŒ‡é’ˆå’Œæ ˆé¡¶çš„åœ°å€**ï¼Œæ ˆå†…å­˜ä¸å‡½æ•°è°ƒç”¨çš„å…³ç³»éå¸¸ç´§å¯†ï¼Œæˆ‘ä»¬åœ¨å‡½æ•°è°ƒç”¨ä¸€èŠ‚ä¸­æ›¾ç»ä»‹ç»è¿‡æ ˆåŒºï¼ŒBP å’Œ SP ä¹‹é—´çš„å†…å­˜å°±æ˜¯å½“å‰å‡½æ•°çš„è°ƒç”¨æ ˆã€‚

![å›¾ 7-43 æ ˆå¯„å­˜å™¨ä¸å†…å­˜](images/image-20250819194607279.png)

å› ä¸ºå†å²åŸå› ï¼Œæ ˆåŒºå†…å­˜éƒ½æ˜¯ä»é«˜åœ°å€å‘ä½åœ°å€æ‰©å±•çš„ï¼Œå½“åº”ç”¨ç¨‹åºç”³è¯·æˆ–è€…é‡Šæ”¾æ ˆå†…å­˜æ—¶åªéœ€è¦ä¿®æ”¹ SP å¯„å­˜å™¨çš„å€¼ï¼Œè¿™ç§çº¿æ€§çš„å†…å­˜åˆ†é…æ–¹å¼ä¸å †å†…å­˜ç›¸æ¯”æ›´åŠ å¿«é€Ÿï¼Œä»…ä¼šå¸¦æ¥æå°‘çš„é¢å¤–å¼€é”€ã€‚

##### çº¿ç¨‹æ ˆ

å¦‚æœæˆ‘ä»¬åœ¨ Linux æ“ä½œç³»ç»Ÿä¸­æ‰§è¡Œ `pthread_create` ç³»ç»Ÿè°ƒç”¨ï¼Œè¿›ç¨‹ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰é€šè¿‡è½¯èµ„æºé™åˆ¶ `RLIMIT_STACK` æŒ‡å®šçº¿ç¨‹æ ˆçš„å¤§å°ï¼Œé‚£ä¹ˆæ“ä½œç³»ç»Ÿä¼šæ ¹æ®æ¶æ„é€‰æ‹©ä¸åŒçš„é»˜è®¤æ ˆå¤§å°ã€‚

| æ¶æ„    | é»˜è®¤æ ˆå¤§å° |
| :------ | ---------: |
| i386    |       2 MB |
| IA-64   |      32 MB |
| PowerPC |       4 MB |
| â€¦       |          â€¦ |
| x86_64  |       2 MB |

**è¡¨ 7-4 æ¶æ„å’Œçº¿ç¨‹é»˜è®¤æ ˆå¤§å°**

å¤šæ•°æ¶æ„ä¸Šé»˜è®¤æ ˆå¤§å°éƒ½åœ¨ 2 ~ 4 MB å·¦å³ï¼Œæå°‘æ•°æ¶æ„ä¼šä½¿ç”¨ 32 MB çš„æ ˆï¼Œç”¨æˆ·ç¨‹åºå¯ä»¥åœ¨åˆ†é…çš„æ ˆä¸Šå­˜å‚¨å‡½æ•°å‚æ•°å’Œå±€éƒ¨å˜é‡ã€‚ç„¶è€Œè¿™ä¸ªå›ºå®šçš„æ ˆå¤§å°åœ¨æŸäº›åœºæ™¯ä¸‹ä¸æ˜¯åˆé€‚çš„å€¼ï¼Œå¦‚æœç¨‹åºéœ€è¦åŒæ—¶è¿è¡Œå‡ ç™¾ä¸ªç”šè‡³ä¸Šåƒä¸ªçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹ä¸­çš„å¤§éƒ¨åˆ†éƒ½åªä¼šç”¨åˆ°å¾ˆå°‘çš„æ ˆç©ºé—´ï¼Œå½“å‡½æ•°çš„è°ƒç”¨æ ˆéå¸¸æ·±æ—¶ï¼Œå›ºå®šæ ˆå¤§å°ä¹Ÿæ— æ³•æ»¡è¶³ç”¨æˆ·ç¨‹åºçš„éœ€æ±‚ã€‚

çº¿ç¨‹å’Œè¿›ç¨‹éƒ½æ˜¯ä»£ç æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªåº”ç”¨ç¨‹åºåŒ…å«æˆç™¾ä¸Šåƒä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡å¹¶ä¸”æ¯ä¸ªä¸Šä¸‹æ–‡éƒ½æ˜¯çº¿ç¨‹ï¼Œä¼šå ç”¨å¤§é‡çš„å†…å­˜ç©ºé—´å¹¶å¸¦æ¥å…¶ä»–çš„é¢å¤–å¼€é”€ï¼ŒGo è¯­è¨€åœ¨è®¾è®¡æ—¶è®¤ä¸ºæ‰§è¡Œä¸Šä¸‹æ–‡æ˜¯è½»é‡çº§çš„ï¼Œæ‰€ä»¥å®ƒåœ¨ç”¨æˆ·æ€å®ç° Goroutine ä½œä¸ºæ‰§è¡Œä¸Šä¸‹æ–‡ã€‚

##### é€ƒé€¸åˆ†æ





##### æ ˆå†…å­˜ç©ºé—´

###### åˆ†æ®µæ ˆ

###### è¿ç»­æ ˆ



#### 73.3.2 æ ˆæ“ä½œ

Go è¯­è¨€ä¸­çš„æ‰§è¡Œæ ˆç”± [`runtime.stack`](https://draven.co/golang/tree/runtime.stack) è¡¨ç¤ºï¼Œè¯¥ç»“æ„ä½“ä¸­åªåŒ…å«ä¸¤ä¸ªå­—æ®µï¼Œåˆ†åˆ«è¡¨ç¤ºæ ˆçš„é¡¶éƒ¨å’Œæ ˆçš„åº•éƒ¨ï¼Œæ¯ä¸ªæ ˆç»“æ„ä½“éƒ½è¡¨ç¤ºèŒƒå›´ä¸º `[lo, hi)` çš„å†…å­˜ç©ºé—´ï¼š

```go
type stack struct {
	lo uintptr
	hi uintptr
}
```

æ ˆçš„ç»“æ„è™½ç„¶éå¸¸ç®€å•ï¼Œä½†æ˜¯æƒ³è¦ç†è§£ Goroutine æ ˆçš„å®ç°åŸç†ï¼Œè¿˜æ˜¯éœ€è¦æˆ‘ä»¬ä»ç¼–è¯‘æœŸé—´å’Œè¿è¡Œæ—¶ä¸¤ä¸ªé˜¶æ®µå…¥æ‰‹ï¼š

1. ç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘é˜¶æ®µä¼šé€šè¿‡ [`cmd/internal/obj/x86.stacksplit`](https://draven.co/golang/tree/cmd/internal/obj/x86.stacksplit) åœ¨è°ƒç”¨å‡½æ•°å‰æ’å…¥ [`runtime.morestack`](https://draven.co/golang/tree/runtime.morestack) æˆ–è€… [`runtime.morestack_noctxt`](https://draven.co/golang/tree/runtime.morestack_noctxt) å‡½æ•°ï¼›
2. è¿è¡Œæ—¶åœ¨åˆ›å»ºæ–°çš„ Goroutine æ—¶ä¼šåœ¨ [`runtime.malg`](https://draven.co/golang/tree/runtime.malg) ä¸­è°ƒç”¨ [`runtime.stackalloc`](https://draven.co/golang/tree/runtime.stackalloc) ç”³è¯·æ–°çš„æ ˆå†…å­˜ï¼Œå¹¶åœ¨ç¼–è¯‘å™¨æ’å…¥çš„ [`runtime.morestack`](https://draven.co/golang/tree/runtime.morestack) ä¸­æ£€æŸ¥æ ˆç©ºé—´æ˜¯å¦å……è¶³ï¼›

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒGo è¯­è¨€çš„ç¼–è¯‘å™¨ä¸ä¼šä¸ºæ‰€æœ‰çš„å‡½æ•°æ’å…¥ [`runtime.morestack`](https://draven.co/golang/tree/runtime.morestack)ï¼Œå®ƒåªä¼šåœ¨å¿…è¦æ—¶æ’å…¥æŒ‡ä»¤ä»¥å‡å°‘è¿è¡Œæ—¶çš„é¢å¤–å¼€é”€ï¼Œç¼–è¯‘æŒ‡ä»¤ `nosplit` å¯ä»¥è·³è¿‡æ ˆæº¢å‡ºçš„æ£€æŸ¥ï¼Œè™½ç„¶è¿™èƒ½é™ä½ä¸€äº›å¼€é”€ï¼Œä¸è¿‡å›ºå®šå¤§å°çš„æ ˆä¹Ÿå­˜åœ¨æº¢å‡ºçš„é£é™©ã€‚æœ¬èŠ‚å°†åˆ†åˆ«åˆ†ææ ˆçš„åˆå§‹åŒ–ã€åˆ›å»º Goroutine æ—¶æ ˆçš„åˆ†é…ã€ç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶åä½œå®Œæˆçš„æ ˆæ‰©å®¹ä»¥åŠå½“æ ˆç©ºé—´åˆ©ç”¨ç‡ä¸è¶³æ—¶çš„ç¼©å®¹è¿‡ç¨‹ã€‚

##### æ ˆåˆå§‹åŒ–



##### æ ˆåˆ†é…



##### æ ˆæ‰©å®¹



##### æ ˆç¼©å®¹

