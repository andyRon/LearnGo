Goè¯­è¨€ç¬¬ä¸€è¯¾
---

[Go è¯­è¨€ç¬¬ä¸€è¯¾](https://time.geekbang.org/column/intro/100093501)

å®˜æ–¹ç½‘ç«™ï¼šhttps://golang.google.cn/ or https://go.dev/

å‘å¸ƒæ—¶é—´ï¼š2021-2022

## 0 è¿™æ ·å…¥é—¨Goï¼Œæ‰èƒ½å°‘èµ°å¼¯è·¯

### å…¥å‘Goçš„ä¸‰å¤§ç†ç”±

#### 1 å¯¹åˆå­¦è€…è¶³å¤Ÿå‹å–„ï¼Œèƒ½å¤Ÿå¿«é€Ÿä¸Šæ‰‹

#### 2 ç”Ÿäº§åŠ›ä¸æ€§èƒ½çš„æœ€ä½³ç»“åˆ

Goå·²ç»æˆä¸ºäº†äº‘åŸºç¡€æ¶æ„è¯­è¨€ï¼Œå®ƒåœ¨**äº‘åŸç”ŸåŸºç¡€è®¾æ–½ã€ä¸­é—´ä»¶ä¸äº‘æœåŠ¡**é¢†åŸŸå¤§æ”¾å¼‚å½©ã€‚åŒæ—¶ï¼ŒGOåœ¨**DevOps/SREã€åŒºå—é“¾ã€å‘½ä»¤è¡Œäº¤äº’ç¨‹åºï¼ˆCLIï¼‰ã€WebæœåŠ¡ï¼Œè¿˜æœ‰æ•°æ®å¤„ç†**ç­‰æ–¹é¢ä¹Ÿæœ‰å¤§é‡æ‹¥è¶¸ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥çœ‹åˆ°Goåœ¨**å¾®æ§åˆ¶å™¨ã€æœºå™¨äººã€æ¸¸æˆé¢†åŸŸ**ä¹Ÿæœ‰å¹¿æ³›åº”ç”¨ã€‚

#### 3 å¿«ä¹åˆæœ‰â€œé’±æ™¯â€

ç®€å•çš„è¯­æ³•ã€å¾—å¿ƒåº”æ‰‹çš„å·¥å…·é“¾ã€ä¸°å¯Œå’Œå¥å£®çš„æ ‡å‡†åº“ï¼Œè¿˜æœ‰ç”Ÿäº§åŠ›ä¸æ€§èƒ½çš„å®Œç¾ç»“åˆã€å…é™¤å†…å­˜ç®¡ç†çš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œå¯¹å¹¶å‘è®¾è®¡çš„åŸç”Ÿæ”¯æŒ

# å‰ç½®ç¯‡ï¼šå¿ƒå®šä¹‹æ—…

## 1 å‰ä¸–ä»Šç”Ÿï¼šGoçš„å†å²å’Œç°çŠ¶

äº†è§£ä¸€é—¨ç¼–ç¨‹è¯­è¨€çš„å†å²å’Œç°çŠ¶ï¼Œä»¥åŠæœªæ¥çš„èµ°å‘ï¼Œå¯ä»¥å»ºç«‹èµ·**å­¦ä¹ çš„â€œå®‰å…¨æ„Ÿâ€**ï¼Œç›¸ä¿¡å®ƒèƒ½å¤Ÿç»™ä½ å¸¦æ¥è¶³å¤Ÿçš„ä»·å€¼å’Œæ”¶ç›Šï¼Œæ›´åŠ åšå®šåœ°å­¦ä¹ ä¸‹å»ã€‚

### è¯ç”Ÿ

Goè¯­è¨€çš„åˆ›å§‹äººæœ‰ä¸‰ä½ï¼š

- å›¾çµå¥–è·å¾—è€…ã€Cè¯­æ³•è”åˆå‘æ˜äººã€Unixä¹‹çˆ¶è‚¯Â·æ±¤æ™®æ£®ï¼ˆKen Thompsonï¼‰
- Plan 9æ“ä½œç³»ç»Ÿé¢†å¯¼è€…ã€UTF-8ç¼–ç çš„æœ€åˆè®¾è®¡è€…ç½—ä¼¯Â·æ´¾å…‹ï¼ˆRob Pikeï¼‰
- Javaçš„HotSpotè™šæ‹Ÿæœºå’ŒChromeæµè§ˆå™¨çš„JavaScript V8å¼•æ“çš„è®¾è®¡è€…ä¹‹ä¸€ç½—ä¼¯ç‰¹Â·æ ¼ç‘å²è«ï¼ˆRobert Griesemerï¼‰ã€‚

å¼€å§‹ï¼š

- 2007å¹´9æœˆ20æ—¥ è®¨è®º

ä¸ä¾¿ï¼šC++çš„å·¨å¤§å¤æ‚æ€§ã€ç¼–è¯‘æ„å»ºé€Ÿåº¦æ…¢ä»¥åŠåœ¨ç¼–å†™æœåŠ¡ç«¯ç¨‹åºæ—¶å¯¹å¹¶å‘æ”¯æŒçš„ä¸è¶³

æ€è·¯ï¼šåœ¨Cè¯­è¨€çš„åŸºç¡€ä¸Šï¼Œä¿®æ­£ä¸€äº›æ˜æ˜¾çš„ç¼ºé™·ï¼Œåˆ é™¤ä¸€äº›è¢«è¯Ÿç—…è¾ƒå¤šçš„ç‰¹æ€§ï¼Œå¢åŠ ä¸€äº›ç¼ºå¤±çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼Œä½¿ç”¨importæ›¿ä»£includeã€å»æ‰å®ã€å¢åŠ åƒåœ¾å›æ”¶ã€æ”¯æŒæ¥å£ç­‰ã€‚

9æœˆ25æ—¥ï¼Œç½—ä¼¯Â·æ´¾å…‹ å‘½åä¸ºâ€œgoâ€ã€‚

â€œGolangâ€ä»…åº”ç”¨äºå‘½åGoè¯­è¨€å®˜æ–¹ç½‘ç«™ã€‚

### ä»â€œä¸‰äººè¡Œâ€åˆ°â€œä¼—äººæ‹¾æŸ´â€

- 2008å¹´åˆï¼Œè‚¯Â·æ±¤æ™®æ£®å®ç°äº†ç¬¬ä¸€ç‰ˆGoç¼–è¯‘å™¨ï¼Œç”¨äºéªŒè¯ä¹‹å‰çš„è®¾è®¡ã€‚è¿™ä¸ªç¼–è¯‘å™¨å…ˆå°†Goä»£ç è½¬æ¢ä¸ºCä»£ç ï¼Œå†ç”±Cç¼–è¯‘å™¨ç¼–è¯‘æˆäºŒè¿›åˆ¶æ–‡ä»¶ã€‚

- 2008å¹´å¹´ä¸­ï¼ŒGoçš„ç¬¬ä¸€ç‰ˆè®¾è®¡å°±åŸºæœ¬ç»“æŸäº†ã€‚ä¼Šæ©Â·æ³°å‹’ï¼ˆIan Lance Taylorï¼‰ä¸ºGoè¯­è¨€å®ç°äº†ä¸€ä¸ªgccçš„å‰ç«¯ï¼Œè¿™ä¹Ÿæ˜¯Goè¯­è¨€çš„ç¬¬äºŒä¸ªç¼–è¯‘å™¨ã€‚

ä¹‹åä»–æˆä¸ºäº†Goè¯­è¨€ï¼Œä»¥åŠå…¶å·¥å…·è®¾è®¡å’Œå®ç°çš„æ ¸å¿ƒäººç‰©ä¹‹ä¸€ã€‚

- 2008å¹´ï¼Œç½—æ–¯Â·è€ƒå…‹æ–¯ï¼ˆRuss Coxï¼‰åˆ©ç”¨å‡½æ•°ç±»å‹æ˜¯â€œä¸€ç­‰å…¬æ°‘â€ï¼Œè€Œä¸”å®ƒä¹Ÿå¯ä»¥æ‹¥æœ‰è‡ªå·±çš„æ–¹æ³•è¿™ä¸ªç‰¹æ€§å·§å¦™è®¾è®¡å‡ºäº†httpåŒ…çš„`HandlerFunc`ç±»å‹ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬é€šè¿‡æ˜¾å¼è½¬å‹å°±å¯ä»¥è®©ä¸€ä¸ªæ™®é€šå‡½æ•°æˆä¸ºæ»¡è¶³http.Handleræ¥å£çš„ç±»å‹äº†ã€‚

- 2009å¹´10æœˆ30æ—¥ï¼ŒGoè¯­è¨€ç¬¬ä¸€æ¬¡å…¬ä¹‹äºä¼—ã€‚

- 2009å¹´11æœˆ10æ—¥ï¼Œè°·æ­Œå®˜æ–¹å®£å¸ƒGoè¯­è¨€é¡¹ç›®å¼€æºï¼Œä¹‹åè¿™ä¸€å¤©ä¹Ÿè¢«Goå®˜æ–¹ç¡®å®šä¸ºGoè¯­è¨€çš„è¯ç”Ÿæ—¥ã€‚

â€œå‰ç¥¥ç‰©â€ï¼Œæ˜¯ä¸€åªç”±ç½—ä¼¯Â·æ´¾å…‹å¤«äººèŠ®å¦®Â·å¼—ä¼¦å¥‡ï¼ˆRenee Frenchï¼‰è®¾è®¡çš„åœ°é¼ ï¼Œä»æ­¤åœ°é¼ ï¼ˆgopherï¼‰ä¹Ÿå°±æˆä¸ºäº†ä¸–ç•Œå„åœ°Goç¨‹åºå‘˜çš„è±¡å¾ï¼ŒGoç¨‹åºå‘˜ä¹Ÿè¢«æ˜µç§°ä¸ºGopherã€‚

![](images/image-20240707112359627.png)

- 2012å¹´3æœˆ28æ—¥ï¼ŒGo 1.0ç‰ˆæœ¬æ­£å¼å‘å¸ƒ

![](images/image-20240701100957741.png)

### Goæ˜¯å¦å€¼å¾—æˆ‘ä»¬å­¦ä¹ ï¼Ÿ

ç°ä»£**äº‘è®¡ç®—åŸºç¡€è®¾æ–½è½¯ä»¶**çš„å¤§éƒ¨åˆ†æµè¡Œå’Œå¯é çš„ä½œå“ï¼Œéƒ½æ˜¯ç”¨Goç¼–å†™çš„ï¼Œæ¯”å¦‚ï¼šDockerã€Kubernetesã€Prometheusã€Ethereumï¼ˆä»¥å¤ªåŠï¼‰ã€Istioã€CockroachDBã€InfluxDBã€Terraformã€Etcdã€Consulç­‰ç­‰ã€‚

## 2 Goè¯­è¨€çš„è®¾è®¡å“²å­¦

ç¼–ç¨‹è¯­è¨€çš„è®¾è®¡å“²å­¦ï¼Œå°±æ˜¯æŒ‡å†³å®šè¿™é—¨**è¯­è¨€==æ¼”åŒ–è¿›ç¨‹==çš„é«˜çº§åŸåˆ™å’Œä¾æ®**ã€‚

Goè¯­è¨€çš„è®¾è®¡å“²å­¦æ€»ç»“ä¸ºäº”ç‚¹ï¼šç®€å•ã€æ˜¾å¼ã€ç»„åˆã€å¹¶å‘å’Œé¢å‘å·¥ç¨‹ã€‚

### ç®€å•

> â€œå¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€åˆ›å»ºä¼Šå§‹éƒ½è‡´åŠ›äºæˆä¸ºä¸€é—¨ç®€å•çš„è¯­è¨€ï¼Œä½†æœ€ç»ˆéƒ½åªæ˜¯æ»¡è¶³äºåšä¸€ä¸ªå¼ºå¤§çš„ç¼–ç¨‹è¯­è¨€â€ã€‚

Goè¯­è¨€çš„è®¾è®¡è€…ä»¬åœ¨è¯­è¨€è®¾è®¡ä¹‹åˆï¼Œå°±æ‹’ç»äº†èµ°**è¯­è¨€ç‰¹æ€§èåˆ**çš„é“è·¯ï¼Œé€‰æ‹©äº†â€œåšå‡æ³•â€å¹¶è‡´åŠ›äºæ‰“é€ ä¸€é—¨ç®€å•çš„ç¼–ç¨‹è¯­è¨€ã€‚

å…¶å®ï¼ŒGoè¯­è¨€ä¹Ÿæ²¡å®ƒçœ‹èµ·æ¥é‚£ä¹ˆç®€å•ï¼Œè‡ªèº«å®ç°èµ·æ¥å¹¶ä¸å®¹æ˜“ï¼Œä½†è¿™äº›**å¤æ‚æ€§è¢«Goè¯­è¨€çš„è®¾è®¡è€…ä»¬â€œéšè—â€äº†**ï¼Œæ‰€ä»¥Goè¯­æ³•å±‚é¢ä¸Šå‘ˆç°äº†è¿™æ ·çš„çŠ¶æ€ï¼š

- ä»…æœ‰25ä¸ªå…³é”®å­—ï¼Œä¸»æµç¼–ç¨‹è¯­è¨€æœ€å°‘ï¼›

- å†…ç½®åƒåœ¾æ”¶é›†ï¼Œé™ä½å¼€å‘äººå‘˜å†…å­˜ç®¡ç†çš„å¿ƒæ™ºè´Ÿæ‹…ï¼›

- é¦–å­—æ¯å¤§å°å†™å†³å®šå¯è§æ€§ï¼Œæ— éœ€é€šè¿‡é¢å¤–å…³é”®å­—ä¿®é¥°ï¼›

- å˜é‡åˆå§‹ä¸ºç±»å‹é›¶å€¼ï¼Œé¿å…ä»¥éšæœºå€¼ä½œä¸ºåˆå€¼çš„é—®é¢˜ï¼›

- å†…ç½®æ•°ç»„è¾¹ç•Œæ£€æŸ¥ï¼Œæå¤§å‡å°‘è¶Šç•Œè®¿é—®å¸¦æ¥çš„å®‰å…¨éšæ‚£ï¼›

- å†…ç½®å¹¶å‘æ”¯æŒï¼Œç®€åŒ–å¹¶å‘ç¨‹åºè®¾è®¡ï¼›

- å†…ç½®æ¥å£ç±»å‹ï¼Œä¸ºç»„åˆçš„è®¾è®¡å“²å­¦å¥ å®šåŸºç¡€ï¼›

- åŸç”Ÿæä¾›å®Œå–„çš„å·¥å…·é“¾ï¼Œå¼€ç®±å³ç”¨ï¼›

- â€¦ â€¦

> ä»»ä½•çš„è®¾è®¡éƒ½å­˜åœ¨ç€**æƒè¡¡ä¸æŠ˜ä¸­**ã€‚

> ç®€å•æ„å‘³ç€å¯ä»¥ä½¿ç”¨**æ›´å°‘çš„ä»£ç **å®ç°ç›¸åŒçš„åŠŸèƒ½ï¼›ç®€å•æ„å‘³ç€ä»£ç å…·æœ‰æ›´å¥½çš„**å¯è¯»æ€§**ï¼Œè€Œå¯è¯»æ€§å¥½çš„ä»£ç é€šå¸¸æ„å‘³ç€æ›´å¥½çš„**å¯ç»´æŠ¤æ€§ä»¥åŠå¯é æ€§**ã€‚

### æ˜¾å¼

Goä¸å…è®¸ä¸åŒç±»å‹çš„æ•´å‹å˜é‡è¿›è¡Œæ··åˆè®¡ç®—ï¼Œå®ƒåŒæ ·ä¹Ÿä¸ä¼šå¯¹å…¶è¿›è¡Œéšå¼çš„è‡ªåŠ¨è½¬æ¢ã€‚

Goå¸Œæœ›å¼€å‘äººå‘˜æ˜ç¡®çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆï¼Œè¿™ä¸Cè¯­è¨€çš„â€œä¿¡ä»»ç¨‹åºå‘˜â€åŸåˆ™å®Œå…¨ä¸åŒã€‚

é™¤æ­¤ä¹‹å¤–ï¼ŒGoè®¾è®¡è€…æ‰€å´‡å°šçš„æ˜¾å¼å“²å­¦è¿˜ç›´æ¥å†³å®šäº†Goè¯­è¨€é”™è¯¯å¤„ç†çš„å½¢æ€ï¼šGoè¯­è¨€é‡‡ç”¨äº†æ˜¾å¼çš„åŸºäºå€¼æ¯”è¾ƒçš„é”™è¯¯å¤„ç†æ–¹æ¡ˆï¼Œ**å‡½æ•°/æ–¹æ³•ä¸­çš„é”™è¯¯éƒ½ä¼šé€šè¿‡returnè¯­å¥æ˜¾å¼åœ°è¿”å›**ï¼Œå¹¶ä¸”é€šå¸¸è°ƒç”¨è€…ä¸èƒ½å¿½ç•¥å¯¹è¿”å›çš„é”™è¯¯çš„å¤„ç†ã€‚

### ç»„åˆ

Goè¯­è¨€ä¸åƒC++ã€Javaç­‰ä¸»æµé¢å‘å¯¹è±¡è¯­è¨€ï¼Œåœ¨Goä¸­æ˜¯æ‰¾ä¸åˆ°ç»å…¸çš„é¢å‘å¯¹è±¡è¯­æ³•å…ƒç´ ã€ç±»å‹ä½“ç³»å’Œç»§æ‰¿æœºåˆ¶çš„ï¼ŒGoæ¨å´‡çš„æ˜¯==ç»„åˆ==çš„è®¾è®¡å“²å­¦ã€‚

åœ¨Goè¯­è¨€è®¾è®¡å±‚é¢ï¼ŒGoè®¾è®¡è€…ä¸ºå¼€å‘è€…ä»¬æä¾›äº†**æ­£äº¤çš„è¯­æ³•å…ƒç´ **ï¼Œä»¥ä¾›åç»­ç»„åˆä½¿ç”¨ï¼ŒåŒ…æ‹¬ï¼š

- Goè¯­è¨€**æ— ç±»å‹å±‚æ¬¡ä½“ç³»**ï¼Œå„ç±»å‹ä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œ**æ²¡æœ‰å­ç±»å‹**çš„æ¦‚å¿µï¼›
- æ¯ä¸ªç±»å‹éƒ½å¯ä»¥æœ‰è‡ªå·±çš„æ–¹æ³•é›†åˆï¼Œç±»å‹å®šä¹‰ä¸æ–¹æ³•å®ç°æ˜¯**æ­£äº¤ç‹¬ç«‹**çš„ï¼›
- å®ç°æŸä¸ªæ¥å£æ—¶ï¼Œæ— éœ€åƒJavaé‚£æ ·é‡‡ç”¨ç‰¹å®šå…³é”®å­—ä¿®é¥°ï¼›
- åŒ…ä¹‹é—´æ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ï¼Œ**æ²¡æœ‰å­åŒ…**çš„æ¦‚å¿µã€‚

Goè¯­è¨€ä¸ºæ”¯æ’‘ç»„åˆçš„è®¾è®¡æä¾›äº†==ç±»å‹åµŒå…¥ï¼ˆType Embeddingï¼‰==ã€‚é€šè¿‡ç±»å‹åµŒå…¥ï¼Œæˆ‘ä»¬å¯ä»¥å°†å·²ç»å®ç°çš„åŠŸèƒ½åµŒå…¥åˆ°æ–°ç±»å‹ä¸­ï¼Œä»¥å¿«é€Ÿæ»¡è¶³æ–°ç±»å‹çš„åŠŸèƒ½éœ€æ±‚ï¼Œè¿™ç§æ–¹å¼æœ‰äº›ç±»ä¼¼ç»å…¸é¢å‘å¯¹è±¡è¯­è¨€ä¸­çš„â€œç»§æ‰¿â€æœºåˆ¶ï¼Œä½†åœ¨åŸç†ä¸Šå´ä¸é¢å‘å¯¹è±¡ä¸­çš„ç»§æ‰¿å®Œå…¨ä¸åŒï¼Œè¿™æ˜¯ä¸€ç§Goè®¾è®¡è€…ä»¬ç²¾å¿ƒè®¾è®¡çš„â€œè¯­æ³•ç³–â€ã€‚

è¢«åµŒå…¥çš„ç±»å‹å’Œæ–°ç±»å‹ä¸¤è€…ä¹‹é—´**æ²¡æœ‰ä»»ä½•å…³ç³»**ï¼Œç”šè‡³ç›¸äº’å®Œå…¨**ä¸çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨**ï¼Œæ›´æ²¡æœ‰ç»å…¸é¢å‘å¯¹è±¡è¯­è¨€ä¸­çš„é‚£ç§çˆ¶ç±»ã€å­ç±»çš„å…³ç³»ï¼Œä»¥åŠ==å‘ä¸Šã€å‘ä¸‹è½¬å‹ï¼ˆType Castingï¼‰==ã€‚é€šè¿‡æ–°ç±»å‹å®ä¾‹è°ƒç”¨æ–¹æ³•æ—¶ï¼Œæ–¹æ³•çš„åŒ¹é…ä¸»è¦å–å†³äº**æ–¹æ³•åå­—**ï¼Œè€Œä¸æ˜¯ç±»å‹ã€‚è¿™ç§ç»„åˆæ–¹å¼ï¼Œæˆ‘ç§°ä¹‹ä¸º==å‚ç›´ç»„åˆ==ï¼Œå³é€šè¿‡ç±»å‹åµŒå…¥ï¼Œå¿«é€Ÿè®©ä¸€ä¸ªæ–°ç±»å‹â€œå¤ç”¨â€å…¶ä»–ç±»å‹å·²ç»å®ç°çš„èƒ½åŠ›ï¼Œå®ç°åŠŸèƒ½çš„==å‚ç›´æ‰©å±•==ã€‚

```go
// $GOROOT/src/sync/pool.go
type poolLocal struct {
    private interface{}   
    shared  []interface{}
    Mutex               
    pad     [128]byte  
}
```

åœ¨poolLocalè¿™ä¸ªç»“æ„ä½“ç±»å‹ä¸­åµŒå…¥äº†ç±»å‹Mutexï¼Œè¿™å°±ä½¿å¾—poolLocalè¿™ä¸ªç±»å‹å…·æœ‰äº†äº’æ–¥åŒæ­¥çš„èƒ½åŠ›ï¼Œå¯ä»¥é€šè¿‡poolLocalç±»å‹çš„å˜é‡ï¼Œç›´æ¥è°ƒç”¨Mutexç±»å‹çš„æ–¹æ³•Lockæˆ–Unlockã€‚

```go
// $GOROOT/src/io/io.go
type ReadWriter interface {
    Reader
    Writer
}
```

é€šè¿‡åµŒå…¥æ¥å£ç±»å‹çš„æ–¹å¼æ¥å®ç°æ¥å£è¡Œä¸ºçš„èšåˆï¼Œç»„æˆ==å¤§æ¥å£==ï¼Œè¿™ç§æ–¹å¼åœ¨æ ‡å‡†åº“ä¸­å°¤ä¸ºå¸¸ç”¨ï¼Œå¹¶ä¸”å·²ç»æˆä¸ºäº†Goè¯­è¨€çš„ä¸€ç§æƒ¯ç”¨æ³•ã€‚

å‚ç›´ç»„åˆæœ¬è´¨ä¸Šæ˜¯ä¸€ç§â€œ==èƒ½åŠ›ç»§æ‰¿==â€ï¼Œé‡‡ç”¨åµŒå…¥æ–¹å¼å®šä¹‰çš„æ–°ç±»å‹ç»§æ‰¿äº†åµŒå…¥ç±»å‹çš„èƒ½åŠ›ã€‚Goè¿˜æœ‰ä¸€ç§å¸¸è§çš„ç»„åˆæ–¹å¼ï¼Œå«==æ°´å¹³ç»„åˆ==ã€‚å’Œå‚ç›´ç»„åˆçš„èƒ½åŠ›ç»§æ‰¿ä¸åŒï¼Œæ°´å¹³ç»„åˆæ˜¯ä¸€ç§==èƒ½åŠ›å§”æ‰˜ï¼ˆDelegateï¼‰==ï¼Œé€šå¸¸ä½¿ç”¨æ¥å£ç±»å‹æ¥å®ç°æ°´å¹³ç»„åˆã€‚

Goè¯­è¨€ä¸­çš„æ¥å£åªæ˜¯**æ–¹æ³•é›†åˆ**ï¼Œå¹¶ä¸”å®ƒä¸å®ç°è€…ä¹‹é—´çš„å…³ç³»æ— éœ€é€šè¿‡æ˜¾å¼å…³é”®å­—ä¿®é¥°ï¼Œå®ƒè®©ç¨‹åºå†…éƒ¨å„éƒ¨åˆ†ä¹‹é—´çš„è€¦åˆé™è‡³æœ€ä½ï¼ŒåŒæ—¶å®ƒä¹Ÿæ˜¯è¿æ¥ç¨‹åºå„ä¸ªéƒ¨åˆ†ä¹‹é—´â€œçº½å¸¦â€ã€‚

æ°´å¹³ç»„åˆçš„æ¨¡å¼1ï¸âƒ£ï¼Œé€šè¿‡æ¥å—æ¥å£ç±»å‹å‚æ•°çš„æ™®é€šå‡½æ•°è¿›è¡Œç»„åˆï¼š

```go
// $GOROOT/src/io/ioutil/ioutil.go
func ReadAll(r io.Reader)([]byte, error)

// $GOROOT/src/io/io.go
func Copy(dst Writer, src Reader)(written int64, err error)
```

å‡½æ•°ReadAllé€šè¿‡io.Readerè¿™ä¸ªæ¥å£ï¼Œå°†io.Readerçš„å®ç°ä¸ReadAllæ‰€åœ¨çš„åŒ…ä½è€¦åˆåœ°æ°´å¹³ç»„åˆåœ¨ä¸€èµ·äº†ï¼Œä»è€Œè¾¾åˆ°ä»ä»»æ„å®ç°io.Readerçš„æ•°æ®æºè¯»å–æ‰€æœ‰æ•°æ®çš„ç›®çš„ã€‚ç±»ä¼¼çš„æ°´å¹³ç»„åˆâ€œæ¨¡å¼â€è¿˜æœ‰**ç‚¹ç¼€å™¨ã€ä¸­é—´ä»¶**ç­‰ã€‚

2ï¸âƒ£å°†Goè¯­è¨€å†…ç½®çš„å¹¶å‘èƒ½åŠ›è¿›è¡Œçµæ´»ç»„åˆä»¥å®ç°ï¼Œæ¯”å¦‚ï¼Œé€šè¿‡goroutine+channelçš„ç»„åˆï¼Œå¯ä»¥å®ç°ç±»ä¼¼Unix Pipeçš„èƒ½åŠ›ã€‚

æ€»ä¹‹ï¼Œç»„åˆåŸåˆ™çš„åº”ç”¨å®è´¨ä¸Šæ˜¯å¡‘é€ äº†Goç¨‹åºçš„éª¨æ¶ç»“æ„ã€‚ç±»å‹åµŒå…¥ä¸ºç±»å‹æä¾›äº†å‚ç›´æ‰©å±•èƒ½åŠ›ï¼Œè€Œæ¥å£æ˜¯æ°´å¹³ç»„åˆçš„å…³é”®ã€‚

### å¹¶å‘

> â€œå¹¶å‘â€å‡ºç°çš„èƒŒæ™¯
> 
> CPUéƒ½æ˜¯é æé«˜**ä¸»é¢‘**æ¥æ”¹è¿›æ€§èƒ½çš„ï¼Œä½†æ˜¯ç°åœ¨è¿™ä¸ªåšæ³•å·²ç»é‡åˆ°äº†ç“¶é¢ˆã€‚ä¸»é¢‘æé«˜å¯¼è‡´CPUçš„åŠŸè€—å’Œå‘çƒ­é‡å‰§å¢ï¼Œåè¿‡æ¥åˆ¶çº¦äº†CPUæ€§èƒ½çš„è¿›ä¸€æ­¥æé«˜ã€‚2007å¹´å¼€å§‹ï¼Œå¤„ç†å™¨å‚å•†çš„ç«äº‰ç„¦ç‚¹ä»ä¸»é¢‘è½¬å‘äº†**å¤šæ ¸**ã€‚

Goæ”¾å¼ƒäº†ä¼ ç»Ÿçš„åŸºäº**æ“ä½œç³»ç»Ÿçº¿ç¨‹**çš„å¹¶å‘æ¨¡å‹ï¼Œè€Œé‡‡ç”¨äº†**ç”¨æˆ·å±‚è½»é‡çº§çº¿ç¨‹**ï¼ŒGoå°†ä¹‹ç§°ä¸º==goroutine==ã€‚

goroutineå ç”¨çš„èµ„æºéå¸¸å°ï¼ŒGoè¿è¡Œæ—¶é»˜è®¤ä¸ºæ¯ä¸ªgoroutineåˆ†é…çš„æ ˆç©ºé—´ä»…==2KB==ã€‚goroutineè°ƒåº¦çš„åˆ‡æ¢ä¹Ÿä¸ç”¨**é™·å…¥ï¼ˆtrapï¼‰**æ“ä½œç³»ç»Ÿå†…æ ¸å±‚å®Œæˆï¼Œä»£ä»·å¾ˆä½ã€‚å› æ­¤ï¼Œä¸€ä¸ªGoç¨‹åºä¸­å¯ä»¥åˆ›å»º**æˆåƒä¸Šä¸‡**ä¸ªå¹¶å‘çš„goroutineã€‚è€Œä¸”ï¼Œæ‰€æœ‰çš„Goä»£ç éƒ½åœ¨goroutineä¸­æ‰§è¡Œï¼Œå“ªæ€•æ˜¯goè¿è¡Œæ—¶çš„ä»£ç ä¹Ÿä¸ä¾‹å¤–ã€‚

Goè¿˜åœ¨è¯­è¨€å±‚é¢å†…ç½®äº†è¾…åŠ©å¹¶å‘è®¾è®¡çš„åŸè¯­ï¼š`channel`å’Œ`select`ã€‚å¼€å‘è€…å¯ä»¥é€šè¿‡è¯­è¨€å†…ç½®çš„channel**ä¼ é€’æ¶ˆæ¯æˆ–å®ç°åŒæ­¥**ï¼Œå¹¶é€šè¿‡selectå®ç°**å¤šè·¯channelçš„å¹¶å‘æ§åˆ¶**ã€‚

å¹¶å‘ä¸ç»„åˆçš„å“²å­¦æ˜¯ä¸€è„‰ç›¸æ‰¿çš„ï¼Œ**å¹¶å‘æ˜¯ä¸€ä¸ªæ›´å¤§çš„ç»„åˆçš„æ¦‚å¿µ**ï¼Œå®ƒåœ¨ç¨‹åºè®¾è®¡çš„å…¨å±€å±‚é¢å¯¹ç¨‹åºè¿›è¡Œæ‹†è§£ç»„åˆï¼Œå†æ˜ å°„åˆ°ç¨‹åºæ‰§è¡Œå±‚é¢ä¸Šï¼š**goroutineså„è‡ªæ‰§è¡Œç‰¹å®šçš„å·¥ä½œï¼Œé€šè¿‡channel+selectå°†goroutinesç»„åˆè¿æ¥èµ·æ¥**ã€‚å¹¶å‘çš„å­˜åœ¨é¼“åŠ±ç¨‹åºå‘˜åœ¨ç¨‹åºè®¾è®¡æ—¶è¿›è¡Œ**ç‹¬ç«‹è®¡ç®—çš„åˆ†è§£**ï¼Œè€Œå¯¹å¹¶å‘çš„åŸç”Ÿæ”¯æŒè®©Goè¯­è¨€ä¹Ÿæ›´é€‚åº”ç°ä»£è®¡ç®—ç¯å¢ƒã€‚

### é¢å‘å·¥ç¨‹

Goè¯­è¨€è®¾è®¡çš„åˆè¡·ï¼Œå°±æ˜¯é¢å‘è§£å†³çœŸå®ä¸–ç•Œä¸­Googleå†…éƒ¨å¤§è§„æ¨¡è½¯ä»¶å¼€å‘å­˜åœ¨çš„å„ç§é—®é¢˜ï¼Œä¸ºè¿™äº›é—®é¢˜æä¾›ç­”æ¡ˆï¼Œè¿™äº›é—®é¢˜åŒ…æ‹¬ï¼š**ç¨‹åºæ„å»ºæ…¢ã€ä¾èµ–ç®¡ç†å¤±æ§ã€ä»£ç éš¾äºç†è§£ã€è·¨è¯­è¨€æ„å»ºéš¾**ç­‰ã€‚

Goåœ¨è¯­æ³•è®¾è®¡ç»†èŠ‚ä¸Šåšäº†ç²¾å¿ƒçš„æ‰“ç£¨ã€‚æ¯”å¦‚ï¼š

- é‡æ–°è®¾è®¡**ç¼–è¯‘å•å…ƒå’Œç›®æ ‡æ–‡ä»¶æ ¼å¼**ï¼Œå®ç°Goæºç å¿«é€Ÿæ„å»ºï¼Œè®©å¤§å·¥ç¨‹çš„æ„å»ºæ—¶é—´ç¼©çŸ­åˆ°ç±»ä¼¼åŠ¨æ€è¯­è¨€çš„äº¤äº’å¼è§£é‡Šçš„ç¼–è¯‘é€Ÿåº¦ï¼›
- å¦‚æœæºæ–‡ä»¶å¯¼å…¥å®ƒä¸ä½¿ç”¨çš„åŒ…ï¼Œåˆ™ç¨‹åºå°†æ— æ³•ç¼–è¯‘ã€‚è¿™å¯ä»¥å……åˆ†ä¿è¯ä»»ä½•Goç¨‹åºçš„**ä¾èµ–æ ‘æ˜¯ç²¾ç¡®çš„**ã€‚è¿™ä¹Ÿå¯ä»¥ä¿è¯åœ¨æ„å»ºç¨‹åºæ—¶ä¸ä¼šç¼–è¯‘é¢å¤–çš„ä»£ç ï¼Œä»è€Œæœ€å¤§é™åº¦åœ°ç¼©çŸ­ç¼–è¯‘æ—¶é—´ï¼›
- **å»é™¤åŒ…çš„å¾ªç¯ä¾èµ–**ï¼Œå¾ªç¯ä¾èµ–ä¼šåœ¨å¤§è§„æ¨¡çš„ä»£ç ä¸­å¼•å‘é—®é¢˜ï¼Œå› ä¸ºå®ƒä»¬è¦æ±‚ç¼–è¯‘å™¨åŒæ—¶å¤„ç†æ›´å¤§çš„æºæ–‡ä»¶é›†ï¼Œè¿™ä¼šå‡æ…¢å¢é‡æ„å»ºï¼›
- **åŒ…è·¯å¾„æ˜¯å”¯ä¸€çš„ï¼Œè€ŒåŒ…åä¸å¿…å”¯ä¸€çš„**ã€‚å¯¼å…¥è·¯å¾„å¿…é¡»å”¯ä¸€æ ‡è¯†è¦å¯¼å…¥çš„åŒ…ï¼Œè€Œåç§°åªæ˜¯åŒ…çš„ä½¿ç”¨è€…å¦‚ä½•å¼•ç”¨å…¶å†…å®¹çš„çº¦å®šã€‚â€œåŒ…åç§°ä¸å¿…æ˜¯å”¯ä¸€çš„â€è¿™ä¸ªçº¦å®šï¼Œå¤§å¤§é™ä½äº†å¼€å‘äººå‘˜ç»™åŒ…èµ·å”¯ä¸€åå­—çš„å¿ƒæ™ºè´Ÿæ‹…ï¼›
- æ•…æ„**ä¸æ”¯æŒé»˜è®¤å‡½æ•°å‚æ•°**ã€‚å› ä¸ºåœ¨è§„æ¨¡å·¥ç¨‹ä¸­ï¼Œå¾ˆå¤šå¼€å‘è€…åˆ©ç”¨é»˜è®¤å‡½æ•°å‚æ•°æœºåˆ¶ï¼Œå‘å‡½æ•°æ·»åŠ è¿‡å¤šçš„å‚æ•°ä»¥å¼¥è¡¥å‡½æ•°APIçš„è®¾è®¡ç¼ºé™·ï¼Œè¿™ä¼šå¯¼è‡´å‡½æ•°æ‹¥æœ‰å¤ªå¤šçš„å‚æ•°ï¼Œé™ä½æ¸…æ™°åº¦å’Œå¯è¯»æ€§ï¼›
- å¢åŠ **ç±»å‹åˆ«åï¼ˆtype aliasï¼‰**ï¼Œæ”¯æŒå¤§è§„æ¨¡ä»£ç åº“çš„é‡æ„ã€‚

Go**æ ‡å‡†åº“åŠŸèƒ½ä¸°å¯Œ**ï¼Œå¤šæ•°åŠŸèƒ½ä¸éœ€è¦ä¾èµ–å¤–éƒ¨çš„ç¬¬ä¸‰æ–¹åŒ…æˆ–åº“ã€‚

Goè¯­è¨€å°±æä¾›äº†è¶³ä»¥è®©æ‰€æœ‰å…¶å®ƒä¸»æµè¯­è¨€å¼€å‘äººå‘˜ç¾¡æ…•çš„**å·¥å…·é“¾**ï¼Œæ¶µç›–äº†**ç¼–è¯‘æ„å»ºã€ä»£ç æ ¼å¼åŒ–ã€åŒ…ä¾èµ–ç®¡ç†ã€é™æ€ä»£ç æ£€æŸ¥ã€æµ‹è¯•ã€æ–‡æ¡£ç”Ÿæˆä¸æŸ¥çœ‹ã€æ€§èƒ½å‰–æã€è¯­è¨€æœåŠ¡å™¨ã€è¿è¡Œæ—¶ç¨‹åºè·Ÿè¸ª**ç­‰æ–¹æ–¹é¢é¢ã€‚å…¶ä¸­`gofmt`ç»Ÿä¸€äº†Goè¯­è¨€çš„ä»£ç é£æ ¼

Goåœ¨æ ‡å‡†åº“ä¸­æä¾›äº†å®˜æ–¹çš„**è¯æ³•åˆ†æå™¨ã€è¯­æ³•è§£æå™¨å’Œç±»å‹æ£€æŸ¥å™¨**ç›¸å…³åŒ…ï¼Œå¼€å‘è€…å¯ä»¥åŸºäºè¿™äº›åŒ…å¿«é€Ÿæ„å»ºå¹¶æ‰©å±•Goå·¥å…·é“¾ã€‚

### æ€è€ƒé¢˜

> è¿˜èƒ½ä¸¾å‡ºå“ªäº›ç¬¦åˆGoè¯­è¨€è®¾è®¡å“²å­¦çš„ä¾‹å­å—ï¼Ÿ

# å…¥é—¨ç¯‡ï¼šå‹¤åŠ ç»ƒæ‰‹

## 3 é…å¥½ç¯å¢ƒï¼šé€‰æ‹©ä¸€ç§æœ€é€‚åˆä½ çš„Goå®‰è£…æ–¹æ³•

### é€‰æ‹©Goç‰ˆæœ¬

Goè¯­è¨€çš„ç‰ˆæœ¬å‘å¸ƒç­–ç•¥:

- æ¯å¹´å‘å¸ƒä¸¤æ¬¡å¤§ç‰ˆæœ¬ï¼Œä¸€èˆ¬æ˜¯åœ¨äºŒæœˆä»½å’Œå…«æœˆä»½å‘å¸ƒ

- å¯¹æœ€æ–°çš„ä¸¤ä¸ªGoç¨³å®šå¤§ç‰ˆæœ¬æä¾›æ”¯æŒ

- æ”¯æŒçš„èŒƒå›´ä¸»è¦åŒ…æ‹¬**ä¿®å¤ç‰ˆæœ¬ä¸­å­˜åœ¨çš„é‡å¤§é—®é¢˜ã€æ–‡æ¡£å˜æ›´ä»¥åŠå®‰å…¨é—®é¢˜æ›´æ–°**ç­‰ã€‚

### å®‰è£…Go

### å®‰è£…å¤šä¸ªGoç‰ˆæœ¬ ğŸ”–

### é…ç½®Go

`go env`

![](images/image-20240701182610693.png)

`go help environment`

## 4 åˆçª¥é—¨å¾„ï¼šä¸€ä¸ªGoç¨‹åºçš„ç»“æ„æ˜¯æ€æ ·çš„ï¼Ÿ

Goæºæ–‡ä»¶æ€»æ˜¯ç”¨å…¨å°å†™å­—æ¯å½¢å¼çš„çŸ­å°å•è¯å‘½åï¼Œå¹¶ä¸”ä»¥.goæ‰©å±•åç»“å°¾ã€‚å¤šä¸ªå•è¯å°±ç›´æ¥è¿æ¥èµ·æ¥ï¼Œä¸è¦ç”¨ä¸‹åˆ’çº¿è¿æ¥ï¼ˆä¸‹åˆ’çº¿åœ¨åœ¨Goæºæ–‡ä»¶å‘½åä¸­æœ‰ç‰¹æ®Šä½œç”¨ï¼‰ã€‚

```go
package main

import "fmt"

func main() {
    fmt.Println("hello, world")
} 
```

æ•´ä¸ªGoç¨‹åºä¸­ä»…å…è®¸å­˜åœ¨ä¸€ä¸ªåä¸ºmainçš„åŒ…ã€‚

`Gofmt`æ˜¯Goè¯­è¨€åœ¨è§£å†³è§„æ¨¡åŒ–ï¼ˆscaleï¼‰é—®é¢˜ä¸Šçš„ä¸€ä¸ªæœ€ä½³å®è·µã€‚

import â€œfmtâ€ ä¸€è¡Œä¸­â€œ`fmt`â€ä»£è¡¨çš„æ˜¯åŒ…çš„å¯¼å…¥è·¯å¾„ï¼ˆImportï¼‰ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯æ ‡å‡†åº“ä¸‹çš„fmtç›®å½•ï¼Œæ•´ä¸ªimportå£°æ˜è¯­å¥çš„å«ä¹‰æ˜¯å¯¼å…¥æ ‡å‡†åº“fmtç›®å½•ä¸‹çš„åŒ…ï¼›`fmt.Println`å‡½æ•°è°ƒç”¨ä¸€è¡Œä¸­çš„â€œ`fmt`â€ä»£è¡¨çš„åˆ™æ˜¯åŒ…åã€‚ä¸¤è€…æ˜¯ä¸ä¸€æ ·çš„ã€‚

åœ¨Goè¯­è¨€ä¸­ï¼Œåªæœ‰é¦–å­—æ¯ä¸ºå¤§å†™çš„æ ‡è¯†ç¬¦æ‰æ˜¯å¯¼å‡ºçš„ï¼ˆExportedï¼‰ï¼Œæ‰èƒ½å¯¹åŒ…å¤–çš„ä»£ç å¯è§ã€‚

### Goè¯­è¨€ä¸­ç¨‹åºæ˜¯æ€ä¹ˆç¼–è¯‘çš„ï¼Ÿ

```shell
go build main.go
```

`go run`è¿™ç±»å‘½ä»¤æ›´å¤šç”¨äºå¼€å‘è°ƒè¯•é˜¶æ®µï¼ŒçœŸæ­£çš„äº¤ä»˜æˆæœè¿˜æ˜¯éœ€è¦ä½¿ç”¨go buildå‘½ä»¤æ„å»ºçš„

### å¤æ‚é¡¹ç›®ä¸‹Goç¨‹åºçš„ç¼–è¯‘æ˜¯æ€æ ·çš„

==Go module==æ„å»ºæ¨¡å¼æ˜¯åœ¨Go 1.11ç‰ˆæœ¬æ­£å¼å¼•å…¥çš„ï¼Œä¸ºçš„æ˜¯**å½»åº•è§£å†³Goé¡¹ç›®å¤æ‚ç‰ˆæœ¬ä¾èµ–çš„é—®é¢˜**ï¼Œåœ¨Go 1.16ç‰ˆæœ¬ä¸­ï¼ŒGo moduleå·²ç»æˆä¸ºäº†Goé»˜è®¤çš„**åŒ…ä¾èµ–ç®¡ç†æœºåˆ¶å’ŒGoæºç æ„å»ºæœºåˆ¶**ã€‚

`go mod init github.com/andyron/hellomodule`åˆ›å»º`go.mod`æ–‡ä»¶ï¼š

```
module github.com/andyron/hellomodule

go 1.22.1
```

ä¸€ä¸ªmoduleå°±æ˜¯ä¸€ä¸ªåŒ…çš„é›†åˆï¼Œè¿™äº›åŒ…å’Œmoduleä¸€èµ·æ‰“ç‰ˆæœ¬ã€å‘å¸ƒå’Œåˆ†å‘ã€‚go.modæ‰€åœ¨çš„ç›®å½•è¢«ç§°ä¸ºå®ƒå£°æ˜çš„moduleçš„æ ¹ç›®å½•ã€‚

ç¬¬ä¸€è¡Œå†…å®¹æ˜¯ç”¨äºå£°æ˜==moduleè·¯å¾„ï¼ˆmodule pathï¼‰==çš„ã€‚è€Œä¸”ï¼Œmoduleéšå«äº†ä¸€ä¸ª==å‘½åç©ºé—´==çš„æ¦‚å¿µï¼Œmoduleä¸‹æ¯ä¸ªåŒ…çš„å¯¼å…¥è·¯å¾„éƒ½æ˜¯ç”±**==module path==å’Œ==åŒ…æ‰€åœ¨å­ç›®å½•çš„åå­—==**ç»“åˆåœ¨ä¸€èµ·æ„æˆã€‚æ¯”å¦‚ï¼Œå¦‚æœhellomoduleä¸‹æœ‰å­ç›®å½•pkg/pkg1ï¼Œé‚£ä¹ˆpkg1ä¸‹é¢çš„åŒ…çš„å¯¼å…¥è·¯å¾„å°±æ˜¯ç”±module pathï¼ˆ`github.com/andyron/hellomodule`ï¼‰å’ŒåŒ…æ‰€åœ¨å­ç›®å½•çš„åå­—ï¼ˆpkg/pkg1ï¼‰ç»“åˆè€Œæˆï¼Œä¹Ÿå°±æ˜¯`github.com/andyron/hellomodule/pkg/pkg1`ã€‚

`go 1.22.1`æ˜¯ä¸€ä¸ªGoç‰ˆæœ¬æŒ‡ç¤ºç¬¦ï¼Œç”¨äºè¡¨ç¤ºè¿™ä¸ªmoduleæ˜¯åœ¨æŸä¸ªç‰¹å®šçš„Goç‰ˆæœ¬çš„moduleè¯­ä¹‰çš„åŸºç¡€ä¸Šç¼–å†™çš„ã€‚

> `go mod tidy`ï¼Œç”¨äºæ¸…ç†å’Œç®¡ç†é¡¹ç›®çš„ä¾èµ–å…³ç³»ï¼Œå¯ä»¥ç¡®ä¿ä½ çš„ `go.mod` å’Œ `go.sum` æ–‡ä»¶æ˜¯æœ€æ–°çš„ï¼Œå®ƒä¼šæ‰§è¡Œä¸‹é¢çš„æ“ä½œï¼š
> 
> - **æ·»åŠ ç¼ºå¤±çš„ä¾èµ–**
> - **ç§»é™¤æœªä½¿ç”¨çš„ä¾èµ–**
> - **æ›´æ–°ä¾èµ–çš„ç‰ˆæœ¬**

`go.sum`æ–‡ä»¶è®°å½•äº†hellomoduleçš„**ç›´æ¥ä¾èµ–å’Œé—´æ¥ä¾èµ–åŒ…çš„ç›¸å…³ç‰ˆæœ¬çš„hashå€¼ï¼Œç”¨æ¥æ ¡éªŒæœ¬åœ°åŒ…çš„çœŸå®æ€§**ã€‚åœ¨æ„å»ºçš„æ—¶å€™ï¼Œå¦‚æœæœ¬åœ°ä¾èµ–åŒ…çš„hashå€¼ä¸go.sumæ–‡ä»¶ä¸­è®°å½•çš„ä¸ä¸€è‡´ï¼Œå°±ä¼šè¢«æ‹’ç»æ„å»ºã€‚

## 5 æ ‡å‡†å…ˆè¡Œï¼šGoé¡¹ç›®çš„å¸ƒå±€æ ‡å‡†æ˜¯ä»€ä¹ˆï¼Ÿ

### Goè¯­è¨€â€œåˆ›ä¸–é¡¹ç›®â€ç»“æ„æ˜¯æ€æ ·çš„ï¼Ÿ

â€œGoè¯­è¨€çš„åˆ›ä¸–é¡¹ç›®â€å°±æ˜¯Goè¯­è¨€é¡¹ç›®è‡ªèº«ã€‚

### ç°åœ¨çš„Goé¡¹ç›®çš„å…¸å‹ç»“æ„å¸ƒå±€æ˜¯æ€æ ·çš„ï¼Ÿ

#### 1ï¸âƒ£å¯æ‰§è¡Œç¨‹åºé¡¹ç›®

å…¸å‹äº”ä¸ªéƒ¨åˆ†ï¼š

- æ”¾åœ¨é¡¹ç›®é¡¶å±‚çš„Go Moduleç›¸å…³æ–‡ä»¶ï¼ŒåŒ…æ‹¬go.modå’Œgo.sumï¼›
- cmdç›®å½•ï¼šå­˜æ”¾é¡¹ç›®è¦ç¼–è¯‘æ„å»ºçš„å¯æ‰§è¡Œæ–‡ä»¶æ‰€å¯¹åº”çš„mainåŒ…çš„æºç æ–‡ä»¶ï¼›
- é¡¹ç›®åŒ…ç›®å½•ï¼šæ¯ä¸ªé¡¹ç›®ä¸‹çš„émainåŒ…éƒ½â€œå¹³é“ºâ€åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ï¼Œæ¯ä¸ªç›®å½•å¯¹åº”ä¸€ä¸ªGoåŒ…ï¼›
- internalç›®å½•ï¼šå­˜æ”¾ä»…é¡¹ç›®å†…éƒ¨å¼•ç”¨çš„GoåŒ…ï¼Œè¿™äº›åŒ…æ— æ³•è¢«é¡¹ç›®ä¹‹å¤–å¼•ç”¨ï¼›
- vendorç›®å½•ï¼šè¿™æ˜¯ä¸€ä¸ªå¯é€‰ç›®å½•ï¼Œä¸ºäº†å…¼å®¹Go 1.5å¼•å…¥çš„vendoræ„å»ºæ¨¡å¼è€Œå­˜åœ¨çš„ã€‚è¿™ä¸ªç›®å½•ä¸‹çš„å†…å®¹å‡ç”±Goå‘½ä»¤è‡ªåŠ¨ç»´æŠ¤ï¼Œä¸éœ€è¦å¼€å‘è€…æ‰‹å·¥å¹²é¢„ã€‚

#### 2ï¸âƒ£åº“é¡¹ç›®

å»æ‰cmdç›®å½•å’Œvendorç›®å½•ã€‚

## 6 æ„å»ºæ¨¡å¼ï¼šGoæ˜¯æ€ä¹ˆè§£å†³åŒ…ä¾èµ–ç®¡ç†é—®é¢˜çš„ï¼Ÿ

### Goæ„å»ºæ¨¡å¼æ˜¯æ€ä¹ˆæ¼”åŒ–çš„ï¼Ÿ

Goç¨‹åºç”±GoåŒ…ç»„åˆè€Œæˆçš„ï¼ŒGoç¨‹åºçš„==æ„å»ºè¿‡ç¨‹==å°±æ˜¯**ç¡®å®šåŒ…ç‰ˆæœ¬ã€ç¼–è¯‘åŒ…ä»¥åŠå°†ç¼–è¯‘åå¾—åˆ°çš„ç›®æ ‡æ–‡ä»¶é“¾æ¥åœ¨ä¸€èµ·**çš„è¿‡ç¨‹ã€‚

Goè¯­è¨€çš„æ„å»ºæ¨¡å¼å†ç»äº†ä¸‰ä¸ªè¿­ä»£å’Œæ¼”åŒ–è¿‡ç¨‹ï¼š

### 1ï¸âƒ£æœ€åˆæœŸçš„GOPATH

### 2ï¸âƒ£1.5ç‰ˆæœ¬çš„Vendoræœºåˆ¶

vendoræœºåˆ¶æœ¬è´¨ä¸Šå°±æ˜¯åœ¨Goé¡¹ç›®çš„æŸä¸ªç‰¹å®šç›®å½•ä¸‹ï¼Œå°†é¡¹ç›®çš„æ‰€æœ‰ä¾èµ–åŒ…ç¼“å­˜èµ·æ¥ï¼Œè¿™ä¸ªç‰¹å®šç›®å½•åå°±æ˜¯vendorã€‚

### 3ï¸âƒ£ç°åœ¨çš„Go Module

ä¸€ä¸ªGo Moduleæ˜¯ä¸€ä¸ªGoåŒ…çš„é›†åˆã€‚moduleæ˜¯æœ‰ç‰ˆæœ¬çš„ï¼Œæ‰€ä»¥moduleä¸‹çš„åŒ…ä¹Ÿå°±æœ‰äº†ç‰ˆæœ¬å±æ€§ã€‚è¿™ä¸ªmoduleä¸è¿™äº›åŒ…ä¼šç»„æˆä¸€ä¸ªç‹¬ç«‹çš„ç‰ˆæœ¬å•å…ƒï¼Œå®ƒä»¬ä¸€èµ·æ‰“ç‰ˆæœ¬ã€å‘å¸ƒå’Œåˆ†å‘ã€‚

åœ¨Go Moduleæ¨¡å¼ä¸‹ï¼Œé€šå¸¸ä¸€ä¸ªä»£ç ä»“åº“å¯¹åº”ä¸€ä¸ªGo Moduleã€‚ä¸€ä¸ªGo Moduleçš„é¡¶å±‚ç›®å½•ä¸‹ä¼šæ”¾ç½®ä¸€ä¸ªgo.modæ–‡ä»¶ï¼Œæ¯ä¸ªgo.modæ–‡ä»¶ä¼šå®šä¹‰å”¯ä¸€ä¸€ä¸ªmoduleï¼Œä¹Ÿå°±æ˜¯è¯´Go Moduleä¸go.modæ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚

go.modæ–‡ä»¶æ‰€åœ¨çš„é¡¶å±‚ç›®å½•ä¹Ÿè¢«ç§°ä¸º**moduleçš„æ ¹ç›®å½•**ï¼Œmoduleæ ¹ç›®å½•ä»¥åŠå®ƒå­ç›®å½•ä¸‹çš„æ‰€æœ‰GoåŒ…å‡å½’å±äºè¿™ä¸ªGo Moduleï¼Œè¿™ä¸ªmoduleä¹Ÿè¢«ç§°ä¸º**main module**ã€‚

### åˆ›å»ºä¸€ä¸ªGo Module

æ­¥éª¤ï¼š

1. ç¬¬ä¸€æ­¥ï¼Œé€šè¿‡go mod initåˆ›å»ºgo.modæ–‡ä»¶ï¼Œå°†å½“å‰é¡¹ç›®å˜ä¸ºä¸€ä¸ªGo Moduleï¼›
2. ç¬¬äºŒæ­¥ï¼Œé€šè¿‡go mod tidyå‘½ä»¤è‡ªåŠ¨æ›´æ–°å½“å‰moduleçš„ä¾èµ–ä¿¡æ¯ï¼›
3. ç¬¬ä¸‰æ­¥ï¼Œæ‰§è¡Œgo buildï¼Œæ‰§è¡Œæ–°moduleçš„æ„å»ºã€‚

ç”±`go mod tidy`ä¸‹è½½çš„ä¾èµ–moduleä¼šè¢«æ”¾ç½®åœ¨æœ¬åœ°çš„moduleç¼“å­˜è·¯å¾„ä¸‹ï¼Œé»˜è®¤å€¼ä¸º`$GOPATH[0]/pkg/mod`ï¼ŒGo 1.15åŠä»¥åç‰ˆæœ¬å¯ä»¥é€šè¿‡`GOMODCACHE`ç¯å¢ƒå˜é‡ï¼Œè‡ªå®šä¹‰æœ¬åœ°moduleçš„ç¼“å­˜è·¯å¾„ã€‚

> æ¨èæŠŠgo.modå’Œgo.sumä¸¤ä¸ªæ–‡ä»¶ä¸æºç ï¼Œä¸€å¹¶æäº¤åˆ°ä»£ç ç‰ˆæœ¬æ§åˆ¶æœåŠ¡å™¨ä¸Šã€‚

go buildå‘½ä»¤ä¼šè¯»å–go.modä¸­çš„ä¾èµ–åŠç‰ˆæœ¬ä¿¡æ¯ï¼Œå¹¶åœ¨æœ¬åœ°moduleç¼“å­˜è·¯å¾„ä¸‹æ‰¾åˆ°å¯¹åº”ç‰ˆæœ¬çš„ä¾èµ–moduleï¼Œæ‰§è¡Œç¼–è¯‘å’Œé“¾æ¥ã€‚

é¡¹ç›®æ‰€ä¾èµ–çš„åŒ…æœ‰å¾ˆå¤šç‰ˆæœ¬ï¼ŒGo Moduleæ˜¯å¦‚ä½•é€‰å‡ºæœ€é€‚åˆçš„é‚£ä¸ªç‰ˆæœ¬çš„å‘¢ï¼Ÿ

### æ·±å…¥Go Moduleæ„å»ºæ¨¡å¼

#### è¯­ä¹‰å¯¼å…¥ç‰ˆæœ¬(Semantic Import Versioning)

ç‰ˆæœ¬å·ï¼Œéƒ½ç¬¦åˆ`vX.Y.Z`çš„æ ¼å¼ï¼Œç”±==å‰ç¼€v==å’Œä¸€ä¸ª==æ»¡è¶³è¯­ä¹‰ç‰ˆæœ¬è§„èŒƒçš„ç‰ˆæœ¬å·==ç»„æˆã€‚è¯­ä¹‰ç‰ˆæœ¬å·åˆ†æˆ3éƒ¨åˆ†ï¼šä¸»ç‰ˆæœ¬å·(major)ã€æ¬¡ç‰ˆæœ¬å·(minor)å’Œè¡¥ä¸ç‰ˆæœ¬å·(patch)ã€‚

![](images/image-20240702171216789.png)

å€ŸåŠ©äºè¯­ä¹‰ç‰ˆæœ¬è§„èŒƒï¼ŒGoå‘½ä»¤å¯ä»¥ç¡®å®šåŒä¸€moduleçš„ä¸¤ä¸ªç‰ˆæœ¬å‘å¸ƒçš„å…ˆåæ¬¡åºï¼Œè€Œä¸”å¯ä»¥ç¡®å®šå®ƒä»¬æ˜¯å¦å…¼å®¹ã€‚

æŒ‰ç…§è¯­ä¹‰ç‰ˆæœ¬è§„èŒƒï¼Œ**ä¸»ç‰ˆæœ¬å·ä¸åŒçš„ä¸¤ä¸ªç‰ˆæœ¬æ˜¯ç›¸äº’ä¸å…¼å®¹çš„**ã€‚è€Œä¸”ï¼Œåœ¨ä¸»ç‰ˆæœ¬å·ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œ**æ¬¡ç‰ˆæœ¬å·å¤§éƒ½æ˜¯å‘åå…¼å®¹æ¬¡ç‰ˆæœ¬å·å°çš„ç‰ˆæœ¬ã€‚è¡¥ä¸ç‰ˆæœ¬å·ä¹Ÿä¸å½±å“å…¼å®¹æ€§**ã€‚

è€Œä¸”ï¼ŒGo Moduleè§„å®šï¼š**å¦‚æœåŒä¸€ä¸ªåŒ…çš„æ–°æ—§ç‰ˆæœ¬æ˜¯å…¼å®¹çš„ï¼Œé‚£ä¹ˆå®ƒä»¬çš„åŒ…å¯¼å…¥è·¯å¾„åº”è¯¥æ˜¯ç›¸åŒçš„**ã€‚ä»¥logrusä¸ºä¾‹ï¼Œé€‰å‡ºä¸¤ä¸ªç‰ˆæœ¬v1.7.0å’Œv1.8.1.ã€‚æŒ‰ç…§ä¸Šé¢çš„è¯­ä¹‰ç‰ˆæœ¬è§„åˆ™ï¼Œè¿™ä¸¤ä¸ªç‰ˆæœ¬çš„ä¸»ç‰ˆæœ¬å·ç›¸åŒï¼Œæ–°ç‰ˆæœ¬v1.8.1æ˜¯å…¼å®¹è€ç‰ˆæœ¬v1.7.0çš„ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ï¼Œå¦‚æœä¸€ä¸ªé¡¹ç›®ä¾èµ–logrusï¼Œæ— è®ºå®ƒä½¿ç”¨çš„æ˜¯v1.7.0ç‰ˆæœ¬è¿˜æ˜¯v1.8.1ç‰ˆæœ¬ï¼Œå®ƒéƒ½å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„åŒ…å¯¼å…¥è¯­å¥å¯¼å…¥logrusåŒ…ï¼š

```go
import "github.com/sirupsen/logrus"
```

> æ–°é—®é¢˜ï¼š
> 
> å‡å¦‚åœ¨æœªæ¥çš„æŸä¸€å¤©ï¼Œlogrusçš„ä½œè€…å‘å¸ƒäº†logrus v2.0.0ç‰ˆæœ¬ã€‚é‚£ä¹ˆæ ¹æ®è¯­ä¹‰ç‰ˆæœ¬è§„åˆ™ï¼Œè¯¥ç‰ˆæœ¬çš„ä¸»ç‰ˆæœ¬å·ä¸º2ï¼Œå·²ç»ä¸v1.7.0ã€v1.8.1çš„ä¸»ç‰ˆæœ¬å·ä¸åŒäº†ï¼Œé‚£ä¹ˆv2.0.0ä¸v1.7.0ã€v1.8.1å°±æ˜¯ä¸å…¼å®¹çš„åŒ…ç‰ˆæœ¬ã€‚ç„¶åæˆ‘ä»¬å†æŒ‰ç…§Go Moduleçš„è§„å®šï¼Œå¦‚æœä¸€ä¸ªé¡¹ç›®ä¾èµ–logrus v2.0.0ç‰ˆæœ¬ï¼Œé‚£ä¹ˆå®ƒçš„åŒ…å¯¼å…¥è·¯å¾„å°±ä¸èƒ½å†ä¸ä¸Šé¢çš„å¯¼å…¥æ–¹å¼ç›¸åŒäº†ã€‚é‚£æˆ‘ä»¬åº”è¯¥ä½¿ç”¨ä»€ä¹ˆæ–¹å¼å¯¼å…¥logrus v2.0.0ç‰ˆæœ¬å‘¢ï¼Ÿ

Go Moduleåˆ›æ–°æ€§åœ°ç»™å‡ºäº†ä¸€ä¸ªæ–¹æ³•ï¼š**å°†åŒ…ä¸»ç‰ˆæœ¬å·å¼•å…¥åˆ°åŒ…å¯¼å…¥è·¯å¾„ä¸­**ï¼š

```go
import "github.com/sirupsen/logrus/v2"
```

ç”šè‡³å¯ä»¥åŒæ—¶ä¾èµ–ä¸€ä¸ªåŒ…çš„ä¸¤ä¸ªä¸å…¼å®¹ç‰ˆæœ¬ï¼š

```go
import (
  "github.com/sirupsen/logrus"
  logv2 "github.com/sirupsen/logrus/v2"
)
```

> v0.y.zç‰ˆæœ¬åº”è¯¥ä½¿ç”¨å“ªç§å¯¼å…¥è·¯å¾„å‘¢ï¼Ÿ
> 
> v0.y.zè¿™æ ·çš„ç‰ˆæœ¬å·æ˜¯ç”¨äºé¡¹ç›®åˆå§‹å¼€å‘é˜¶æ®µçš„ç‰ˆæœ¬å·ã€‚åœ¨è¿™ä¸ªé˜¶æ®µä»»ä½•äº‹æƒ…éƒ½æœ‰å¯èƒ½å‘ç”Ÿï¼Œå…¶APIä¹Ÿä¸åº”è¯¥è¢«è®¤ä¸ºæ˜¯ç¨³å®šçš„ã€‚Go Moduleå°†è¿™æ ·çš„ç‰ˆæœ¬(v0)ä¸ä¸»ç‰ˆæœ¬å·v1åšåŒç­‰å¯¹å¾…ï¼Œä¹Ÿå°±æ˜¯é‡‡ç”¨ä¸å¸¦ä¸»ç‰ˆæœ¬å·çš„åŒ…å¯¼å…¥è·¯å¾„ï¼Œè¿™æ ·ä¸€å®šç¨‹åº¦é™ä½äº†Goå¼€å‘äººå‘˜ä½¿ç”¨è¿™æ ·ç‰ˆæœ¬å·åŒ…æ—¶çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚

#### æœ€å°ç‰ˆæœ¬é€‰æ‹©(Minimal Version Selection)

![](images/image-20240702171932253.png)

> myprojectæœ‰ä¸¤ä¸ªç›´æ¥ä¾èµ–Aå’ŒBï¼ŒAå’ŒBæœ‰ä¸€ä¸ªå…±åŒçš„ä¾èµ–åŒ…Cï¼Œä½†Aä¾èµ–Cçš„v1.1.0ç‰ˆæœ¬ï¼Œè€ŒBä¾èµ–çš„æ˜¯Cçš„v1.3.0ç‰ˆæœ¬ï¼Œå¹¶ä¸”æ­¤æ—¶CåŒ…çš„æœ€æ–°å‘å¸ƒç‰ˆä¸ºC v1.7.0ã€‚è¿™ä¸ªæ—¶å€™ï¼ŒGoå‘½ä»¤æ˜¯å¦‚ä½•ä¸ºmyprojecté€‰å‡ºé—´æ¥ä¾èµ–åŒ…Cçš„ç‰ˆæœ¬å‘¢ï¼Ÿé€‰å‡ºçš„ç©¶ç«Ÿæ˜¯v1.7.0ã€v1.1.0è¿˜æ˜¯v1.3.0å‘¢ï¼Ÿ

å½“å‰å­˜åœ¨çš„ä¸»æµç¼–ç¨‹è¯­è¨€ï¼Œä»¥åŠGo Moduleå‡ºç°ä¹‹å‰çš„å¾ˆå¤šGoåŒ…ä¾èµ–ç®¡ç†å·¥å…·éƒ½ä¼šé€‰æ‹©ä¾èµ–é¡¹çš„â€œ**æœ€æ–°æœ€å¤§(Latest Greatest)ç‰ˆæœ¬**â€ï¼Œä¹Ÿå°±æ˜¯v1.7.0ã€‚

Goè®¾è®¡è€…å¦è¾Ÿè¹Šå¾„ï¼Œåœ¨è¯¸å¤šå…¼å®¹æ€§ç‰ˆæœ¬é—´ï¼Œä»–ä»¬ä¸å…‰è¦è€ƒè™‘æœ€æ–°æœ€å¤§çš„ç¨³å®šä¸å®‰å…¨ï¼Œè¿˜è¦å°Šé‡å„ä¸ªmoduleçš„è¿°æ±‚ï¼šAæ˜æ˜è¯´åªè¦æ±‚C v1.1.0ï¼ŒBæ˜æ˜è¯´åªè¦æ±‚C v1.3.0ã€‚æ‰€ä»¥Goä¼šåœ¨è¯¥é¡¹ç›®ä¾èµ–é¡¹çš„æ‰€æœ‰ç‰ˆæœ¬ä¸­ï¼Œé€‰å‡ºç¬¦åˆé¡¹ç›®æ•´ä½“è¦æ±‚çš„â€œæœ€å°ç‰ˆæœ¬â€ã€‚

è¿™ä¸ªä¾‹å­ä¸­ï¼ŒC v1.3.0æ˜¯ç¬¦åˆé¡¹ç›®æ•´ä½“è¦æ±‚çš„ç‰ˆæœ¬é›†åˆä¸­çš„ç‰ˆæœ¬æœ€å°çš„é‚£ä¸ªï¼Œäºæ˜¯Goå‘½ä»¤é€‰æ‹©äº†C v1.3.0ï¼Œè€Œä¸æ˜¯æœ€æ–°æœ€å¤§çš„C v1.7.0ã€‚Goå›¢é˜Ÿè®¤ä¸º**â€œæœ€å°ç‰ˆæœ¬é€‰æ‹©â€ä¸ºGoç¨‹åºå®ç°æŒä¹…çš„å’Œå¯é‡ç°çš„æ„å»ºæä¾›äº†æœ€ä½³çš„æ–¹æ¡ˆ**ã€‚

### Goå„ç‰ˆæœ¬æ„å»ºæ¨¡å¼æœºåˆ¶å’Œåˆ‡æ¢

![](images/image-20240702172417325.png)

## 7 æ„å»ºæ¨¡å¼ï¼šGoModuleçš„6ç±»å¸¸è§„æ“ä½œ

### ä¸ºå½“å‰moduleæ·»åŠ ä¸€ä¸ªä¾èµ–

```go
package main

import "github.com/sirupsen/logrus"
import "github.com/google/uuid"

func main() {
    logrus.Println("hello, go module mode.")
    logrus.Println(uuid.NewString())
}
```

å¯ä»¥`go get github.com/google/uuid`ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`go mod tidy`å‘½ä»¤ï¼Œåœ¨æ‰§è¡Œæ„å»ºå‰è‡ªåŠ¨åˆ†ææºç ä¸­çš„ä¾èµ–å˜åŒ–ï¼Œè¯†åˆ«æ–°å¢ä¾èµ–é¡¹å¹¶ä¸‹è½½å®ƒä»¬ã€‚

### å‡çº§/é™çº§ä¾èµ–çš„ç‰ˆæœ¬

```sh
$ go list -m -versions github.com/sirupsen/logrus
github.com/sirupsen/logrus v0.1.0 v0.1.1 v0.2.0 v0.3.0 v0.4.0 v0.4.1 v0.5.0 v0.5.1 v0.6.0 v0.6.1 v0.6.2 v0.6.3 v0.6.4 v0.6.5 v0.6.6 v0.7.0 v0.7.1 v0.7.2 v0.7.3 v0.8.0 v0.8.1 v0.8.2 v0.8.3 v0.8.4 v0.8.5 v0.8.6 v0.8.7 v0.9.0 v0.10.0 v0.11.0 v0.11.1 v0.11.2 v0.11.3 v0.11.4 v0.11.5 v1.0.0 v1.0.1 v1.0.3 v1.0.4 v1.0.5 v1.0.6 v1.1.0 v1.1.1 v1.2.0 v1.3.0 v1.4.0 v1.4.1 v1.4.2 v1.5.0 v1.6.0 v1.7.0 v1.7.1 v1.8.0 v1.8.1 v1.8.2 v1.8.3 v1.9.0 v1.9.1 v1.9.2 v1.9.3
```

é™çº§ï¼š

```sh
$ go get github.com/google/uuid@v1.7.0
```

æˆ–

```sh
$ go mod edit -require=github.com/sirupsen/logrus@v1.7.0
$ go mod tidy       
go: downloading github.com/sirupsen/logrus v1.7.0
```

å‡çº§ï¼š

```sh
$ go get github.com/google/uuid@v1.7.1
```

åœ¨Go Moduleæ„å»ºæ¨¡å¼ä¸‹ï¼Œå½“ä¾èµ–çš„ä¸»ç‰ˆæœ¬å·ä¸º0æˆ–1çš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨Goæºç ä¸­å¯¼å…¥ä¾èµ–åŒ…ï¼Œä¸éœ€è¦åœ¨åŒ…çš„å¯¼å…¥è·¯å¾„ä¸Šå¢åŠ ç‰ˆæœ¬å·ï¼Œä¹Ÿå°±æ˜¯ï¼š

```go
import github.com/user/repo/v0 ç­‰ä»·äº import github.com/user/repo
import github.com/user/repo/v1 ç­‰ä»·äº import github.com/user/repo
```

### æ·»åŠ ä¸€ä¸ªä¸»ç‰ˆæœ¬å·å¤§äº1çš„ä¾èµ–

è¯­ä¹‰å¯¼å…¥ç‰ˆæœ¬æœºåˆ¶æœ‰ä¸€ä¸ªåŸåˆ™ï¼š**å¦‚æœæ–°æ—§ç‰ˆæœ¬çš„åŒ…ä½¿ç”¨ç›¸åŒçš„å¯¼å…¥è·¯å¾„ï¼Œé‚£ä¹ˆæ–°åŒ…ä¸æ—§åŒ…æ˜¯å…¼å®¹çš„**ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ–°æ—§ä¸¤ä¸ªåŒ…ä¸å…¼å®¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åº”è¯¥é‡‡ç”¨ä¸åŒçš„å¯¼å…¥è·¯å¾„ã€‚

```go
import github.com/user/repo/v2/xxx
```

ä¸»ç‰ˆæœ¬å·å¤§äº1çš„ä¾èµ–ï¼Œ**åœ¨å£°æ˜å®ƒçš„å¯¼å…¥è·¯å¾„çš„åŸºç¡€ä¸Šï¼ŒåŠ ä¸Šç‰ˆæœ¬å·ä¿¡æ¯**ã€‚

### å‡çº§ä¾èµ–ç‰ˆæœ¬åˆ°ä¸€ä¸ªä¸å…¼å®¹ç‰ˆæœ¬

### ç§»é™¤ä¸€ä¸ªä¾èµ–

åˆ—å‡ºå½“å‰moduleçš„æ‰€æœ‰ä¾èµ–ï¼š

```sh
$ go list -m all
```

åˆ é™¤ä»£ç ä¸­å¯¹åŒ…ä¾èµ–ï¼Œç„¶å`go build`æ˜¯ä¸ä¼šä»å½“å‰moduleä¸­ç§»é™¤ç›¸å…³ä¾èµ–çš„ï¼Œéœ€è¦ä½¿ç”¨`go mod tidy`å‘½ä»¤ã€‚

go mod tidyä¼šè‡ªåŠ¨åˆ†ææºç ä¾èµ–ï¼Œè€Œä¸”å°†ä¸å†ä½¿ç”¨çš„ä¾èµ–ä»go.modå’Œgo.sumä¸­ç§»é™¤ã€‚

### ç‰¹æ®Šæƒ…å†µï¼šä½¿ç”¨vendor

vendoræœºåˆ¶è™½ç„¶è¯ç”ŸäºGOPATHæ„å»ºæ¨¡å¼ä¸»å¯¼çš„å¹´ä»£ï¼Œä½†åœ¨Go Moduleæ„å»ºæ¨¡å¼ä¸‹ï¼Œå®ƒä¾æ—§è¢«ä¿ç•™äº†ä¸‹æ¥ï¼Œå¹¶ä¸”æˆä¸ºäº†Go Moduleæ„å»ºæœºåˆ¶çš„ä¸€ä¸ªå¾ˆå¥½çš„**è¡¥å……**ã€‚ç‰¹åˆ«æ˜¯åœ¨ä¸€äº›ä¸æ–¹ä¾¿è®¿é—®å¤–éƒ¨ç½‘ç»œï¼Œå¹¶ä¸”å¯¹Goåº”ç”¨æ„å»ºæ€§èƒ½æ•æ„Ÿçš„ç¯å¢ƒï¼Œæ¯”å¦‚åœ¨ä¸€äº›å†…éƒ¨çš„æŒç»­é›†æˆæˆ–æŒç»­äº¤ä»˜ç¯å¢ƒï¼ˆCI/CDï¼‰ä¸­ï¼Œä½¿ç”¨vendoræœºåˆ¶å¯ä»¥å®ç°ä¸Go Moduleç­‰ä»·çš„æ„å»ºã€‚

å’ŒGOPATHæ„å»ºæ¨¡å¼ä¸åŒï¼ŒGo Moduleæ„å»ºæ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬å†ä¹Ÿæ— éœ€æ‰‹åŠ¨ç»´æŠ¤vendorç›®å½•ä¸‹çš„ä¾èµ–åŒ…äº†ï¼ŒGoæä¾›äº†å¯ä»¥å¿«é€Ÿå»ºç«‹å’Œæ›´æ–°vendorçš„å‘½ä»¤:

```sh
$ go mod vendor
$ tree -LF 2 vendor
vendor
â”œâ”€â”€ github.com/
â”‚   â”œâ”€â”€ google/
â”‚   â”œâ”€â”€ magefile/
â”‚   â””â”€â”€ sirupsen/
â”œâ”€â”€ golang.org/
â”‚   â””â”€â”€ x/
â””â”€â”€ modules.txt
```

`go mod vendor`å‘½ä»¤åœ¨vendorç›®å½•ä¸‹ï¼Œåˆ›å»ºäº†ä¸€ä»½è¿™ä¸ªé¡¹ç›®çš„ä¾èµ–åŒ…çš„å‰¯æœ¬ï¼Œå¹¶ä¸”é€šè¿‡`vendor/modules.txt`è®°å½•äº†vendorä¸‹çš„moduleä»¥åŠç‰ˆæœ¬ã€‚

å¦‚æœæˆ‘ä»¬è¦åŸºäºvendoræ„å»ºï¼Œè€Œä¸æ˜¯åŸºäºæœ¬åœ°ç¼“å­˜çš„Go Moduleæ„å»ºï¼Œæˆ‘ä»¬éœ€è¦åœ¨go buildåé¢åŠ ä¸Š`-mod=vendor`å‚æ•°ã€‚

åœ¨Go 1.14åŠä»¥åç‰ˆæœ¬ä¸­ï¼Œå¦‚æœGoé¡¹ç›®çš„é¡¶å±‚ç›®å½•ä¸‹å­˜åœ¨vendorç›®å½•ï¼Œé‚£ä¹ˆgo build**é»˜è®¤ä¹Ÿä¼šä¼˜å…ˆåŸºäºvendoræ„å»º**ï¼Œé™¤éä½ ç»™go buildä¼ å…¥`-mod=mod`çš„å‚æ•°ã€‚

### æ€è€ƒé¢˜

> å¦‚æœä½ æ˜¯ä¸€ä¸ªå…¬å…±GoåŒ…çš„ä½œè€…ï¼Œåœ¨å‘å¸ƒä½ çš„GoåŒ…æ—¶ï¼Œæœ‰å“ªäº›éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Ÿ

## 8 å…¥å£å‡½æ•°ä¸åŒ…åˆå§‹åŒ–ï¼šææ¸…Goç¨‹åºçš„æ‰§è¡Œæ¬¡åº

### main.mainå‡½æ•°ï¼šGoåº”ç”¨çš„å…¥å£å‡½æ•°

Goè¯­è¨€è¦æ±‚ï¼š**å¯æ‰§è¡Œç¨‹åºçš„mainåŒ…å¿…é¡»å®šä¹‰mainå‡½æ•°ï¼Œå¦åˆ™Goç¼–è¯‘å™¨ä¼šæŠ¥é”™**ã€‚åœ¨å¯åŠ¨äº†å¤šä¸ªGoroutineçš„Goåº”ç”¨ä¸­ï¼Œmain.mainå‡½æ•°å°†åœ¨Goåº”ç”¨çš„ä¸»Goroutineä¸­æ‰§è¡Œã€‚

ä¸è¿‡å¾ˆæœ‰æ„æ€çš„æ˜¯ï¼Œåœ¨å¤šGoroutineçš„Goåº”ç”¨ä¸­ï¼Œç›¸è¾ƒäºmain.mainä½œä¸ºGoåº”ç”¨çš„==å…¥å£==ï¼Œ**main.mainå‡½æ•°==è¿”å›==çš„æ„ä¹‰å…¶å®æ›´å¤§**ï¼Œå› ä¸ºmainå‡½æ•°è¿”å›å°±æ„å‘³ç€**æ•´ä¸ªGoç¨‹åºçš„ç»ˆç»“**ï¼Œè€Œä¸”ä½ ä¹Ÿä¸ç”¨ç®¡è¿™ä¸ªæ—¶å€™æ˜¯å¦è¿˜æœ‰å…¶ä»–å­Goroutineæ­£åœ¨æ‰§è¡Œã€‚

é™¤äº†mainåŒ…å¤–ï¼Œå…¶ä»–åŒ…ä¹Ÿå¯ä»¥æ‹¥æœ‰è‡ªå·±çš„åä¸ºmainçš„å‡½æ•°æˆ–æ–¹æ³•ã€‚ä½†æŒ‰ç…§Goçš„**å¯è§æ€§è§„åˆ™**ï¼ˆå°å†™å­—æ¯å¼€å¤´çš„æ ‡è¯†ç¬¦ä¸ºéå¯¼å‡ºæ ‡è¯†ç¬¦ï¼‰ï¼ŒémainåŒ…ä¸­è‡ªå®šä¹‰çš„mainå‡½æ•°ä»…é™äºåŒ…å†…ä½¿ç”¨ã€‚

> å¯¹äºmainåŒ…çš„mainå‡½æ•°æ¥è¯´ï¼Œè™½ç„¶æ˜¯ç”¨æˆ·å±‚é€»è¾‘çš„å…¥å£å‡½æ•°ï¼Œä½†å®ƒå´**ä¸ä¸€å®šæ˜¯ç”¨æˆ·å±‚ç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œçš„å‡½æ•°**ã€‚

### initå‡½æ•°ï¼šGoåŒ…çš„åˆå§‹åŒ–å‡½æ•°

å¦‚æœmainåŒ…ä¾èµ–çš„åŒ…ä¸­å®šä¹‰äº†initå‡½æ•°ï¼Œæˆ–è€…æ˜¯mainåŒ…è‡ªèº«å®šä¹‰äº†initå‡½æ•°ï¼Œé‚£ä¹ˆGoç¨‹åºåœ¨è¿™ä¸ªåŒ…åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå°±ä¼šè‡ªåŠ¨è°ƒç”¨å®ƒçš„initå‡½æ•°ï¼Œå› æ­¤è¿™äº›initå‡½æ•°çš„æ‰§è¡Œå°±éƒ½ä¼šå‘ç”Ÿåœ¨mainå‡½æ•°ä¹‹å‰ã€‚

æ¯ä¸ªç»„æˆGoåŒ…çš„Goæºæ–‡ä»¶ä¸­ï¼Œå¯ä»¥å®šä¹‰å¤šä¸ªinitå‡½æ•°ã€‚

åœ¨åˆå§‹åŒ–GoåŒ…æ—¶ï¼ŒGoä¼šæŒ‰ç…§ä¸€å®šçš„æ¬¡åºï¼Œ**é€ä¸€ã€é¡ºåºåœ°**è°ƒç”¨è¿™ä¸ªåŒ…çš„initå‡½æ•°ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå…ˆä¼ é€’ç»™Goç¼–è¯‘å™¨çš„æºæ–‡ä»¶ä¸­çš„initå‡½æ•°ï¼Œä¼šå…ˆè¢«æ‰§è¡Œï¼›è€ŒåŒä¸€ä¸ªæºæ–‡ä»¶ä¸­çš„å¤šä¸ªinitå‡½æ•°ï¼Œä¼šæŒ‰**å£°æ˜é¡ºåº**ä¾æ¬¡æ‰§è¡Œã€‚

### GoåŒ…çš„åˆå§‹åŒ–æ¬¡åº

ä»ç¨‹åºé€»è¾‘ç»“æ„è§’åº¦æ¥çœ‹ï¼ŒGoåŒ…æ˜¯ç¨‹åºé€»è¾‘å°è£…çš„åŸºæœ¬å•å…ƒï¼Œæ¯ä¸ªåŒ…éƒ½å¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ªâ€œè‡ªæ²»â€çš„ã€å°è£…è‰¯å¥½çš„ã€å¯¹å¤–éƒ¨æš´éœ²**æœ‰é™æ¥å£**çš„**åŸºæœ¬å•å…ƒ**ã€‚**ä¸€ä¸ªGoç¨‹åºå°±æ˜¯ç”±ä¸€ç»„åŒ…ç»„æˆçš„ï¼Œç¨‹åºçš„åˆå§‹åŒ–å°±æ˜¯è¿™äº›åŒ…çš„åˆå§‹åŒ–**ã€‚æ¯ä¸ªGoåŒ…è¿˜ä¼šæœ‰è‡ªå·±çš„ä¾èµ–åŒ…ã€å¸¸é‡ã€å˜é‡ã€initå‡½æ•°ï¼ˆå…¶ä¸­mainåŒ…æœ‰mainå‡½æ•°ï¼‰ç­‰ã€‚

> æ³¨æ„ğŸ“¢ï¼šæˆ‘ä»¬åœ¨é˜…è¯»å’Œç†è§£ä»£ç çš„æ—¶å€™ï¼Œéœ€è¦çŸ¥é“è¿™äº›å…ƒç´ åœ¨åœ¨ç¨‹åºåˆå§‹åŒ–è¿‡ç¨‹ä¸­çš„åˆå§‹åŒ–é¡ºåºï¼Œè¿™æ ·ä¾¿äºæˆ‘ä»¬ç¡®å®šåœ¨æŸä¸€è¡Œä»£ç å¤„è¿™äº›å…ƒç´ çš„å½“å‰çŠ¶æ€ã€‚

GoåŒ…çš„åˆå§‹åŒ–æ¬¡åºï¼š

![](images/image-20240702182932741.png)

1. é¦–å…ˆï¼ŒmainåŒ…ä¾èµ–pkg1å’Œpkg4ä¸¤ä¸ªåŒ…ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥ï¼ŒGoä¼šæ ¹æ®åŒ…å¯¼å…¥çš„é¡ºåºï¼Œå…ˆå»åˆå§‹åŒ–mainåŒ…çš„ç¬¬ä¸€ä¸ªä¾èµ–åŒ…pkg1ã€‚
2. ç¬¬äºŒæ­¥ï¼ŒGoåœ¨è¿›è¡ŒåŒ…åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œä¼šé‡‡ç”¨â€œ==æ·±åº¦ä¼˜å…ˆ==â€çš„åŸåˆ™ï¼Œé€’å½’åˆå§‹åŒ–å„ä¸ªåŒ…çš„ä¾èµ–åŒ…ã€‚åœ¨ä¸Šå›¾é‡Œï¼Œpkg1åŒ…ä¾èµ–pkg2åŒ…ï¼Œpkg2åŒ…ä¾èµ–pkg3åŒ…ï¼Œpkg3æ²¡æœ‰ä¾èµ–åŒ…ï¼Œäºæ˜¯Goåœ¨pkg3åŒ…ä¸­æŒ‰ç…§â€œ==å¸¸é‡ -> å˜é‡ -> initå‡½æ•°==â€çš„é¡ºåºå…ˆå¯¹pkg3åŒ…è¿›è¡Œåˆå§‹åŒ–ï¼›
3. ç´§æ¥ç€ï¼Œåœ¨pkg3åŒ…åˆå§‹åŒ–å®Œæ¯•åï¼ŒGoä¼šå›åˆ°pkg2åŒ…å¹¶å¯¹pkg2åŒ…è¿›è¡Œåˆå§‹åŒ–ï¼Œæ¥ä¸‹æ¥å†å›åˆ°pkg1åŒ…å¹¶å¯¹pkg1åŒ…è¿›è¡Œåˆå§‹åŒ–ã€‚åœ¨è°ƒç”¨å®Œpkg1åŒ…çš„initå‡½æ•°åï¼ŒGoå°±å®Œæˆäº†mainåŒ…çš„ç¬¬ä¸€ä¸ªä¾èµ–åŒ…pkg1çš„åˆå§‹åŒ–ã€‚
4. æ¥ä¸‹æ¥ï¼ŒGoä¼šåˆå§‹åŒ–mainåŒ…çš„ç¬¬äºŒä¸ªä¾èµ–åŒ…pkg4ï¼Œpkg4åŒ…çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸pkg1åŒ…ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å…ˆåˆå§‹åŒ–å®ƒçš„ä¾èµ–åŒ…pkg5ï¼Œç„¶åå†åˆå§‹åŒ–è‡ªèº«ï¼›ç„¶åï¼Œå½“Goåˆå§‹åŒ–å®Œpkg4åŒ…åä¹Ÿå°±å®Œæˆäº†å¯¹mainåŒ…æ‰€æœ‰ä¾èµ–åŒ…çš„åˆå§‹åŒ–ï¼Œæ¥ä¸‹æ¥åˆå§‹åŒ–mainåŒ…è‡ªèº«ã€‚
5. æœ€åï¼Œåœ¨mainåŒ…ä¸­ï¼ŒGoåŒæ ·ä¼šæŒ‰ç…§â€œå¸¸é‡ -> å˜é‡ -> initå‡½æ•°â€çš„é¡ºåºè¿›è¡Œåˆå§‹åŒ–ï¼Œæ‰§è¡Œå®Œè¿™äº›åˆå§‹åŒ–å·¥ä½œåæ‰æ­£å¼è¿›å…¥ç¨‹åºçš„å…¥å£å‡½æ•°mainå‡½æ•°ã€‚

ğŸ”–  åŒ…å¼•å…¥é”™è¯¯ï¼Ÿå˜é‡å’Œå¸¸é‡çš„æ‰§è¡Œé¡ºåºä¸ºä»€ä¹ˆåäº†ï¼Ÿ  [Go 1.22å¼•å…¥çš„åŒ…çº§å˜é‡åˆå§‹åŒ–æ¬¡åºé—®é¢˜ | Tony Bai](https://tonybai.com/2024/03/29/the-issue-in-pkg-level-var-init-order-in-go-1-22/)

GoåŒ…çš„åˆå§‹åŒ–æ¬¡åºï¼Œä¸‰ç‚¹ï¼š

- ä¾èµ–åŒ…æŒ‰â€œæ·±åº¦ä¼˜å…ˆâ€çš„æ¬¡åºè¿›è¡Œåˆå§‹åŒ–ï¼›
- æ¯ä¸ªåŒ…å†…æŒ‰ä»¥â€œå¸¸é‡ -> å˜é‡ -> initå‡½æ•°â€çš„é¡ºåºè¿›è¡Œåˆå§‹åŒ–ï¼›
- åŒ…å†…çš„å¤šä¸ªinitå‡½æ•°æŒ‰å‡ºç°æ¬¡åºè¿›è¡Œè‡ªåŠ¨è°ƒç”¨ã€‚

### initå‡½æ•°çš„ç”¨é€”

GoåŒ…åˆå§‹åŒ–æ—¶ï¼Œinitå‡½æ•°çš„åˆå§‹åŒ–æ¬¡åºåœ¨å˜é‡ä¹‹åï¼Œè¿™ç»™äº†å¼€å‘äººå‘˜åœ¨initå‡½æ•°ä¸­**å¯¹åŒ…çº§å˜é‡è¿›è¡Œè¿›ä¸€æ­¥æ£€æŸ¥ä¸æ“ä½œ**çš„æœºä¼šã€‚

#### ç”¨é€”1ï¼šé‡ç½®åŒ…çº§å˜é‡å€¼

è´Ÿè´£å¯¹åŒ…å†…éƒ¨ä»¥åŠæš´éœ²åˆ°å¤–éƒ¨çš„åŒ…çº§æ•°æ®ï¼ˆä¸»è¦æ˜¯åŒ…çº§å˜é‡ï¼‰çš„**åˆå§‹çŠ¶æ€è¿›è¡Œæ£€æŸ¥**ã€‚

ä¾‹å¦‚ï¼Œæ ‡å‡†åº“flagåŒ…ï¼šğŸ”–

flagåŒ…å®šä¹‰äº†ä¸€ä¸ªå¯¼å‡ºçš„åŒ…çº§å˜é‡`CommandLine`ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰é€šè¿‡flag.NewFlagSetåˆ›å»ºæ–°çš„ä»£è¡¨å‘½ä»¤è¡Œæ ‡å¿—é›†åˆçš„å®ä¾‹ï¼Œé‚£ä¹ˆCommandLineå°±ä¼šä½œä¸ºflagåŒ…å„ç§å¯¼å‡ºå‡½æ•°èƒŒåï¼Œé»˜è®¤çš„ä»£è¡¨å‘½ä»¤è¡Œæ ‡å¿—é›†åˆçš„å®ä¾‹ã€‚

```go
var CommandLine = NewFlagSet(os.Args[0], ExitOnError)

func NewFlagSet(name string, errorHandling ErrorHandling) *FlagSet {
    f := &FlagSet{
        name:          name,
        errorHandling: errorHandling,
    }
    f.Usage = f.defaultUsage
    return f
}

func (f *FlagSet) defaultUsage() {
    if f.name == "" {
        fmt.Fprintf(f.Output(), "Usage:\n")
    } else {
        fmt.Fprintf(f.Output(), "Usage of %s:\n", f.name)
    }
    f.PrintDefaults()
}
```

åœ¨é€šè¿‡NewFlagSetåˆ›å»ºCommandLineå˜é‡ç»‘å®šçš„FlagSetç±»å‹å®ä¾‹æ—¶ï¼ŒCommandLineçš„Usageå­—æ®µè¢«èµ‹å€¼ä¸ºdefaultUsageã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¿æŒç°çŠ¶ï¼Œé‚£ä¹ˆä½¿ç”¨flagåŒ…é»˜è®¤CommandLineçš„ç”¨æˆ·å°±æ— æ³•è‡ªå®šä¹‰usageçš„è¾“å‡ºäº†ã€‚äºæ˜¯ï¼ŒflagåŒ…åœ¨initå‡½æ•°ä¸­é‡ç½®äº†CommandLineçš„Usageå­—æ®µï¼š

```go
func init() {
    CommandLine.Usage = commandLineUsage // é‡ç½®CommandLineçš„Usageå­—æ®µ
}

func commandLineUsage() {
    Usage()
}

var Usage = func() {
    fmt.Fprintf(CommandLine.Output(), "Usage of %s:\n", os.Args[0])
    PrintDefaults()
}
```

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä¼šå‘ç°ï¼ŒCommandLineçš„Usageå­—æ®µï¼Œè®¾ç½®ä¸ºäº†ä¸€ä¸ªflagåŒ…å†…çš„æœªå¯¼å‡ºå‡½æ•°commandLineUsageï¼Œåè€…åˆ™ç›´æ¥ä½¿ç”¨äº†flagåŒ…çš„å¦å¤–ä¸€ä¸ªå¯¼å‡ºåŒ…å˜é‡Usageã€‚è¿™æ ·ï¼Œå°±å¯ä»¥é€šè¿‡initå‡½æ•°ï¼Œå°†CommandLineä¸åŒ…å˜é‡Usageå…³è”åœ¨ä¸€èµ·äº†ã€‚

ç„¶åï¼Œå½“ç”¨æˆ·å°†è‡ªå®šä¹‰çš„usageèµ‹å€¼ç»™äº†flag.Usageåï¼Œå°±ç›¸å½“äºæ”¹å˜äº†é»˜è®¤ä»£è¡¨å‘½ä»¤è¡Œæ ‡å¿—é›†åˆçš„CommandLineå˜é‡çš„Usageã€‚è¿™æ ·å½“flagåŒ…å®Œæˆåˆå§‹åŒ–åï¼ŒCommandLineå˜é‡ä¾¿å¤„äºä¸€ä¸ªåˆç†å¯ç”¨çš„çŠ¶æ€äº†ã€‚

#### ç”¨é€”2ï¼šå®ç°å¯¹åŒ…çº§å˜é‡çš„å¤æ‚åˆå§‹åŒ–

æœ‰äº›åŒ…çº§å˜é‡éœ€è¦ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œæœ‰äº›æ—¶å€™ï¼Œä½¿ç”¨å®ƒçš„**ç±»å‹é›¶å€¼**ï¼ˆæ¯ä¸ªGoç±»å‹éƒ½å…·æœ‰ä¸€ä¸ªé›¶å€¼å®šä¹‰ï¼‰æˆ–é€šè¿‡ç®€å•åˆå§‹åŒ–è¡¨è¾¾å¼ä¸èƒ½æ»¡è¶³ä¸šåŠ¡é€»è¾‘è¦æ±‚ï¼Œè€Œinitå‡½æ•°åˆ™éå¸¸é€‚åˆå®Œæˆæ­¤é¡¹å·¥ä½œï¼Œæ ‡å‡†åº“httpåŒ…ä¸­å°±æœ‰è¿™æ ·ä¸€ä¸ªå…¸å‹ç¤ºä¾‹ï¼š

```go
// net/http/h2_bundle.go
var (
    http2VerboseLogs    bool // åˆå§‹åŒ–æ—¶é»˜è®¤å€¼ä¸ºfalse
    http2logFrameWrites bool // åˆå§‹åŒ–æ—¶é»˜è®¤å€¼ä¸ºfalse
    http2logFrameReads  bool // åˆå§‹åŒ–æ—¶é»˜è®¤å€¼ä¸ºfalse
    http2inTests        bool // åˆå§‹åŒ–æ—¶é»˜è®¤å€¼ä¸ºfalse
)

func init() {
    e := os.Getenv("GODEBUG")
    if strings.Contains(e, "http2debug=1") {
        http2VerboseLogs = true // åœ¨initä¸­å¯¹http2VerboseLogsçš„å€¼è¿›è¡Œé‡ç½®
    }
    if strings.Contains(e, "http2debug=2") {
        http2VerboseLogs = true // åœ¨initä¸­å¯¹http2VerboseLogsçš„å€¼è¿›è¡Œé‡ç½®
        http2logFrameWrites = true // åœ¨initä¸­å¯¹http2logFrameWritesçš„å€¼è¿›è¡Œé‡ç½®
        http2logFrameReads = true // åœ¨initä¸­å¯¹http2logFrameReadsçš„å€¼è¿›è¡Œé‡ç½®
    }
}
```

httpåŒ…å®šä¹‰äº†ä¸€ç³»åˆ—å¸ƒå°”ç±»å‹çš„ç‰¹æ€§å¼€å…³å˜é‡ï¼Œå¯ä»¥é€šè¿‡GODEBUGç¯å¢ƒå˜é‡çš„å€¼ï¼Œå¼€å¯ç›¸å…³ç‰¹æ€§å¼€å…³ã€‚

#### ç”¨é€”3ï¼šåœ¨initå‡½æ•°ä¸­å®ç°â€œæ³¨å†Œæ¨¡å¼â€ ğŸ”–

lib/pqåŒ…è®¿é—®PostgreSQLæ•°æ®åº“çš„ä»£ç ç¤ºä¾‹ï¼š

```go
import (
    "database/sql"
    _ "github.com/lib/pq"
)

func main() {
    db, err := sql.Open("postgres", "user=pqgotest dbname=pqgotest sslmode=verify-full")
    if err != nil {
        log.Fatal(err)
    }

    age := 21
    rows, err := db.Query("SELECT name FROM users WHERE age = $1", age)
    ...
}
```

ä»¥ç©ºå¯¼å…¥çš„æ–¹å¼å¯¼å…¥[lib/pq](https://github.com/lib/pq)åŒ…çš„ï¼Œmainå‡½æ•°ä¸­æ²¡æœ‰ä½¿ç”¨pqåŒ…çš„ä»»ä½•å˜é‡ã€å‡½æ•°æˆ–æ–¹æ³•ï¼Œè¿™æ ·å°±å®ç°äº†å¯¹PostgreSQLæ•°æ®åº“çš„è®¿é—®ã€‚è€Œè¿™ä¸€åˆ‡çš„å¥¥ç§˜ï¼Œå…¨åœ¨pqåŒ…çš„initå‡½æ•°ä¸­ï¼š

```go
func init() {
    sql.Register("postgres", &Driver{})
}
```

åˆ©ç”¨äº†ç”¨ç©ºå¯¼å…¥çš„æ–¹å¼å¯¼å…¥lib/pqåŒ…æ—¶äº§ç”Ÿçš„ä¸€ä¸ªâ€œå‰¯ä½œç”¨â€ï¼Œä¹Ÿå°±æ˜¯lib/pqåŒ…ä½œä¸ºmainåŒ…çš„ä¾èµ–åŒ…ï¼Œå®ƒçš„initå‡½æ•°ä¼šåœ¨pqåŒ…åˆå§‹åŒ–çš„æ—¶å€™å¾—ä»¥æ‰§è¡Œã€‚

initå‡½æ•°ä¸­ï¼ŒpqåŒ…å°†è‡ªå·±å®ç°çš„sqlé©±åŠ¨æ³¨å†Œåˆ°äº†sqlåŒ…ä¸­ã€‚è¿™æ ·åªè¦åº”ç”¨å±‚ä»£ç åœ¨Openæ•°æ®åº“çš„æ—¶å€™ï¼Œä¼ å…¥é©±åŠ¨çš„åå­—ï¼ˆè¿™é‡Œæ˜¯â€œpostgresâ€)ï¼Œé‚£ä¹ˆé€šè¿‡sql.Openå‡½æ•°ï¼Œè¿”å›çš„æ•°æ®åº“å®ä¾‹å¥æŸ„å¯¹æ•°æ®åº“è¿›è¡Œçš„æ“ä½œï¼Œå®é™…ä¸Šè°ƒç”¨çš„éƒ½æ˜¯pqåŒ…ä¸­ç›¸åº”çš„é©±åŠ¨å®ç°ã€‚

å®é™…ä¸Šï¼Œè¿™ç§**é€šè¿‡åœ¨initå‡½æ•°ä¸­æ³¨å†Œè‡ªå·±çš„å®ç°çš„æ¨¡å¼ï¼Œå°±æœ‰æ•ˆé™ä½äº†GoåŒ…å¯¹å¤–çš„ç›´æ¥æš´éœ²ï¼Œå°¤å…¶æ˜¯åŒ…çº§å˜é‡çš„æš´éœ²**ï¼Œä»è€Œé¿å…äº†å¤–éƒ¨é€šè¿‡åŒ…çº§å˜é‡å¯¹åŒ…çŠ¶æ€çš„æ”¹åŠ¨ã€‚

å¦å¤–ï¼Œä»æ ‡å‡†åº“database/sqlåŒ…çš„è§’åº¦æ¥çœ‹ï¼Œè¿™ç§â€œæ³¨å†Œæ¨¡å¼â€å®è´¨æ˜¯ä¸€ç§**å·¥å‚è®¾è®¡æ¨¡å¼**çš„å®ç°ï¼Œsql.Openå‡½æ•°å°±æ˜¯è¿™ä¸ªæ¨¡å¼ä¸­çš„å·¥å‚æ–¹æ³•ï¼Œå®ƒæ ¹æ®å¤–éƒ¨ä¼ å…¥çš„é©±åŠ¨åç§°â€œç”Ÿäº§â€å‡ºä¸åŒç±»åˆ«çš„æ•°æ®åº“å®ä¾‹å¥æŸ„ã€‚ğŸ”–

è¿™ç§â€œæ³¨å†Œæ¨¡å¼â€åœ¨æ ‡å‡†åº“çš„å…¶ä»–åŒ…ä¸­ä¹Ÿæœ‰å¹¿æ³›åº”ç”¨ï¼Œæ¯”å¦‚è¯´ï¼Œä½¿ç”¨æ ‡å‡†åº“imageåŒ…è·å–å„ç§æ ¼å¼å›¾ç‰‡çš„å®½å’Œé«˜ï¼š

```go
package main

import (
    "fmt"
    "image"
    _ "image/gif"  // ä»¥ç©ºå¯¼å…¥æ–¹å¼æ³¨å…¥gifå›¾ç‰‡æ ¼å¼é©±åŠ¨
    _ "image/jpeg" // ä»¥ç©ºå¯¼å…¥æ–¹å¼æ³¨å…¥jpegå›¾ç‰‡æ ¼å¼é©±åŠ¨
    _ "image/png"  // ä»¥ç©ºå¯¼å…¥æ–¹å¼æ³¨å…¥pngå›¾ç‰‡æ ¼å¼é©±åŠ¨
    "os"
)

func main() {
    width, height, err := imageSize(os.Args[1])
    if err != nil {
        fmt.Println("è·å–å›¾ç‰‡å¤§å°é”™è¯¯ï¼š", err)
        return
    }
    fmt.Printf("å›¾ç‰‡å¤§å°ï¼š[%d, %d]\n", width, height)
}

func imageSize(imageFile string) (int, int, error) {
    f, _ := os.Open(imageFile) // æ‰“å¼€å›¾æ–‡æ–‡ä»¶
    defer f.Close()

    img, _, err := image.Decode(f) // å¯¹æ–‡ä»¶è¿›è¡Œè§£ç ï¼Œå¾—åˆ°å›¾ç‰‡å®ä¾‹
    if err != nil {
        return 0, 0, err
    }

    b := img.Bounds() // è¿”å›å›¾ç‰‡åŒºåŸŸ
    return b.Max.X, b.Max.Y, nil
}
```

ä¸Šé¢è¿™ä¸ªç¤ºä¾‹ç¨‹åºæ”¯æŒpngã€jpegã€gifä¸‰ç§æ ¼å¼çš„å›¾ç‰‡ï¼Œè€Œè¾¾æˆè¿™ä¸€ç›®æ ‡çš„åŸå› ï¼Œæ­£æ˜¯image/pngã€image/jpegå’Œimage/gifåŒ…éƒ½åœ¨å„è‡ªçš„initå‡½æ•°ä¸­ï¼Œå°†è‡ªå·±â€œæ³¨å†Œâ€åˆ°imageçš„æ”¯æŒæ ¼å¼åˆ—è¡¨ä¸­äº†ï¼š

```go
// $GOROOT/src/image/png/reader.go
func init() {
    image.RegisterFormat("png", pngHeader, Decode, DecodeConfig)
}

// $GOROOT/src/image/jpeg/reader.go
func init() {
    image.RegisterFormat("jpeg", "\xff\xd8", Decode, DecodeConfig)
}

// $GOROOT/src/image/gif/reader.go
func init() {
    image.RegisterFormat("gif", "GIF8?a", Decode, DecodeConfig)
}  
```

```sh
$ go run main.go go.png
å›¾ç‰‡å¤§å°ï¼š[276, 348]
```

### æ€è€ƒé¢˜

> å½“initå‡½æ•°åœ¨æ£€æŸ¥åŒ…æ•°æ®åˆå§‹çŠ¶æ€æ—¶é‡åˆ°å¤±è´¥æˆ–é”™è¯¯çš„æƒ…å†µï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ

## 9 å³å­¦å³ç»ƒï¼šæ„å»ºä¸€ä¸ªWebæœåŠ¡å°±æ˜¯è¿™ä¹ˆç®€å•

### æœ€ç®€å•çš„HTTPæœåŠ¡

[Go Developer Survey 2024 H1 Results](https://go.dev/blog/survey2024-h1-results) Goåº”ç”¨æœ€å¹¿æ³›çš„é¢†åŸŸè°ƒæŸ¥ç»“æœå›¾

![](images/image-20240708111713853.png)

ä¸¤ä¸ªwebæœåŠ¡ç›¸å…³ï¼ŒAPI/RPCæœåŠ¡å’ŒWebæœåŠ¡ï¼ˆè¿”å›htmlé¡µé¢ï¼‰ã€‚

```go
package main

import "net/http"

func main() {
    http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
        w.Write([]byte("hello, world!"))
    })
    http.ListenAndServe(":8080", nil)
}
```

`ListenAndServe`

`HandleFunc`

ç¬¬äºŒä¸ªå‚æ•°rä»£è¡¨æ¥è‡ªå®¢æˆ·ç«¯çš„HTTPè¯·æ±‚ï¼Œç¬¬ä¸€ä¸ªå‚æ•°wåˆ™æ˜¯ç”¨æ¥æ“ä½œè¿”å›ç»™å®¢æˆ·ç«¯çš„åº”ç­”çš„ï¼ŒåŸºäºhttpåŒ…å®ç°çš„HTTPæœåŠ¡çš„å¤„ç†å‡½æ•°éƒ½è¦ç¬¦åˆè¿™ä¸€åŸå‹ã€‚

å°†è¯·æ±‚ä¸­çš„URIè·¯å¾„ä¸è®¾ç½®çš„æ¨¡å¼å­—ç¬¦ä¸²è¿›è¡Œ==æœ€é•¿å‰ç¼€åŒ¹é…==ï¼Œå¹¶æ‰§è¡ŒåŒ¹é…åˆ°çš„æ¨¡å¼å­—ç¬¦ä¸²æ‰€å¯¹åº”çš„å¤„ç†å‡½æ•°ã€‚

### å›¾ä¹¦ç®¡ç†APIæœåŠ¡ â¤ï¸

![](images/image-20240703103915037.png)

#### é¡¹ç›®å»ºç«‹ä¸å¸ƒå±€è®¾è®¡

bookstore

æœåŠ¡å¤§ä½“æ‹†åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼š

- ä¸€éƒ¨åˆ†æ˜¯HTTPæœåŠ¡å™¨ï¼Œç”¨æ¥å¯¹å¤–æä¾›APIæœåŠ¡ï¼›
- å¦ä¸€éƒ¨åˆ†æ˜¯å›¾ä¹¦æ•°æ®çš„å­˜å‚¨æ¨¡å—ï¼Œæ‰€æœ‰çš„å›¾ä¹¦æ•°æ®å‡å­˜å‚¨åœ¨è¿™é‡Œã€‚

Goé¡¹ç›®å¸ƒå±€æ ‡å‡†ï¼š

```
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ bookstore/         // æ”¾ç½®bookstore mainåŒ…æºç 
â”‚       â””â”€â”€ main.go
â”œâ”€â”€ go.mod                 // module bookstoreçš„go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ internal/              // å­˜æ”¾é¡¹ç›®å†…éƒ¨åŒ…çš„ç›®å½•
â”‚   â””â”€â”€ store/
â”‚       â””â”€â”€ memstore.go     
â”œâ”€â”€ server/                // HTTPæœåŠ¡å™¨æ¨¡å—
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ middleware.go
â”‚   â””â”€â”€ server.go          
â””â”€â”€ store/                 // å›¾ä¹¦æ•°æ®å­˜å‚¨æ¨¡å—
    â”œâ”€â”€ factory/
    â”‚   â””â”€â”€ factory.go
    â””â”€â”€ store.go
```

#### é¡¹ç›®mainåŒ…

![](images/image-20240703104236493.png)

```go
// cmd/bookstore/main.go
package main

import (
    _ "bookstore/internal/store"
    "bookstore/server"
    "bookstore/store/factory"
    "context"
    "log"
    "os"
    "os/signal"
    "syscall"
    "time"
)

func main() {
    s, err := factory.New("mem") // 1ï¸âƒ£åˆ›å»ºå›¾ä¹¦æ•°æ®å­˜å‚¨æ¨¡å—å®ä¾‹
    if err != nil {
        panic(err)
    }

    srv := server.NewBookStoreServer(":8080", s) // 2ï¸âƒ£åˆ›å»ºhttpæœåŠ¡å®ä¾‹

    errChan, err := srv.ListenAndServe() // è¿è¡ŒhttpæœåŠ¡
    if err != nil {
        log.Println("web server start failed: ", err)
        return
    }
    log.Println("web server start ok")

    // 3ï¸âƒ£é€šè¿‡ç›‘è§†ç³»ç»Ÿä¿¡å·å®ç°äº†httpæœåŠ¡å®ä¾‹çš„ä¼˜é›…é€€å‡º
    c := make(chan os.Signal, 1)
    signal.Notify(c, syscall.SIGINT, syscall.SIGTERM) // æ•è·ç³»ç»Ÿä¿¡å·SIGINTã€SIGTERM

    select { // ç›‘è§†æ¥è‡ªerrChanä»¥åŠcçš„äº‹ä»¶
    case err = <-errChan:
        log.Println("web server run failed:", err)
        return
    case <-c:
        log.Println("bookstore program is exiting...")
        ctx, cf := context.WithTimeout(context.Background(), time.Second)
        defer cf()
        err = srv.Shutdown(ctx) // ä¼˜é›…å…³é—­httpæœåŠ¡å®ä¾‹
    }

    if err != nil {
        log.Println("bookstore program exit error: ", err)
        return
    }
    log.Println("bookstore program exit ok")
}
```

> åœ¨Goä¸­ï¼ŒmainåŒ…æ˜¯æ•´ä¸ªç¨‹åºçš„å…¥å£ï¼Œè¿˜æ˜¯æ•´ä¸ªç¨‹åºä¸­==ä¸»è¦æ¨¡å—åˆå§‹åŒ–ä¸ç»„è£…çš„åœºæ‰€==ã€‚

ä¼˜é›…é€€å‡ºï¼ŒæŒ‡çš„å°±æ˜¯**ç¨‹åºæœ‰æœºä¼šç­‰å¾…å…¶ä»–çš„äº‹æƒ…å¤„ç†å®Œå†é€€å‡º**ã€‚æ¯”å¦‚**å°šæœªå®Œæˆçš„äº‹åŠ¡å¤„ç†ã€æ¸…ç†èµ„æºï¼ˆæ¯”å¦‚å…³é—­æ–‡ä»¶æè¿°ç¬¦ã€å…³é—­socketï¼‰ã€ä¿å­˜å¿…è¦ä¸­é—´çŠ¶æ€ã€å†…å­˜æ•°æ®æŒä¹…åŒ–è½ç›˜**ç­‰ç­‰ã€‚

httpæœåŠ¡å®ä¾‹å†…éƒ¨çš„é€€å‡ºæ¸…ç†å·¥ä½œï¼ŒåŒ…æ‹¬ï¼š**ç«‹å³å…³é—­æ‰€æœ‰listenerã€å…³é—­æ‰€æœ‰ç©ºé—²çš„è¿æ¥ã€ç­‰å¾…å¤„äºæ´»åŠ¨çŠ¶æ€çš„è¿æ¥å¤„ç†å®Œæ¯•**ç­‰ç­‰ã€‚

#### å›¾ä¹¦æ•°æ®å­˜å‚¨æ¨¡å—ï¼ˆstore)

ç”¨æ¥**å­˜å‚¨æ•´ä¸ªbookstoreçš„å›¾ä¹¦æ•°æ®**çš„ã€‚

å›¾ä¹¦æ•°æ®å­˜å‚¨æœ‰å¾ˆå¤šç§å®ç°æ–¹å¼ï¼Œæœ€ç®€å•çš„æ–¹å¼è«è¿‡äºåœ¨å†…å­˜ä¸­åˆ›å»ºä¸€ä¸ªmapï¼Œä»¥å›¾ä¹¦idä½œä¸ºkeyï¼Œæ¥ä¿å­˜å›¾ä¹¦ä¿¡æ¯ã€‚ç”Ÿäº§ç¯å¢ƒï¼Œéœ€è¦é€šè¿‡Nosqlæ•°æ®åº“æˆ–å…³ç³»å‹æ•°æ®åº“ã€‚

è€ƒè™‘åˆ°å¯¹å¤šç§å­˜å‚¨å®ç°æ–¹å¼çš„æ”¯æŒï¼Œå°†é’ˆå¯¹å›¾ä¹¦çš„æœ‰é™ç§å­˜å‚¨æ“ä½œï¼Œæ”¾ç½®åœ¨ä¸€ä¸ªæ¥å£ç±»å‹Storeä¸­ï¼š

```go
// store/store.go
 type Book struct {
     Id      string   `json:"id"`      // å›¾ä¹¦ISBN ID
     Name    string   `json:"name"`    // å›¾ä¹¦åç§°
     Authors []string `json:"authors"` // å›¾ä¹¦ä½œè€…
     Press   string   `json:"press"`   // å‡ºç‰ˆç¤¾
 }

 type Store interface {
     Create(*Book) error        // åˆ›å»ºä¸€ä¸ªæ–°å›¾ä¹¦æ¡ç›®
     Update(*Book) error        // æ›´æ–°æŸå›¾ä¹¦æ¡ç›®
     Get(string) (Book, error)  // è·å–æŸå›¾ä¹¦ä¿¡æ¯
     GetAll() ([]Book, error)   // è·å–æ‰€æœ‰å›¾ä¹¦ä¿¡æ¯
     Delete(string) error       // åˆ é™¤æŸå›¾ä¹¦æ¡ç›®
 }
```

ä¸€ä¸ªå¯¹åº”å›¾ä¹¦æ¡ç›®çš„æŠ½è±¡æ•°æ®ç±»å‹Bookï¼Œä»¥åŠé’ˆå¯¹Bookå­˜å–çš„æ¥å£ç±»å‹Storeã€‚è¿™æ ·ï¼Œå¯¹äºæƒ³è¦è¿›è¡Œå›¾ä¹¦æ•°æ®æ“ä½œçš„ä¸€æ–¹æ¥è¯´ï¼Œä»–åªéœ€è¦å¾—åˆ°ä¸€ä¸ªæ»¡è¶³Storeæ¥å£çš„å®ä¾‹ï¼Œå°±å¯ä»¥å®ç°å¯¹å›¾ä¹¦æ•°æ®çš„å­˜å‚¨æ“ä½œäº†ï¼Œä¸ç”¨å†å…³å¿ƒå›¾ä¹¦æ•°æ®ç©¶ç«Ÿé‡‡ç”¨äº†ä½•ç§å­˜å‚¨æ–¹å¼ã€‚è¿™å°±å®ç°äº†**å›¾ä¹¦å­˜å‚¨æ“ä½œä¸åº•å±‚å›¾ä¹¦æ•°æ®å­˜å‚¨æ–¹å¼çš„è§£è€¦**ã€‚è€Œä¸”ï¼Œè¿™ç§==é¢å‘æ¥å£ç¼–ç¨‹==ä¹Ÿæ˜¯Goç»„åˆè®¾è®¡å“²å­¦çš„ä¸€ä¸ªé‡è¦ä½“ç°ã€‚

> å¦‚ä½•åˆ›å»ºä¸€ä¸ªæ»¡è¶³Storeæ¥å£çš„å®ä¾‹å‘¢ï¼Ÿ

å‚è€ƒã€Šè®¾è®¡æ¨¡å¼ã€‹æä¾›çš„å¤šç§åˆ›å»ºå‹æ¨¡å¼ï¼Œé€‰æ‹©ä¸€ç§Goé£æ ¼çš„å·¥å‚æ¨¡å¼ï¼ˆåˆ›å»ºå‹æ¨¡å¼çš„ä¸€ç§ï¼‰æ¥å®ç°æ»¡è¶³Storeæ¥å£å®ä¾‹çš„åˆ›å»ºã€‚`store/factory`åŒ…:

```go
// store/factory/factory.go
package factory

import (
    "bookstore/store"
    "fmt"
    "sync"
)

var (
    providersMu sync.RWMutex
    providers   = make(map[string]store.Store) // ä½¿ç”¨mapç±»å‹å¯¹å·¥å‚å¯ä»¥â€œç”Ÿäº§â€çš„ã€æ»¡è¶³Storeæ¥å£çš„å®ä¾‹ç±»å‹è¿›è¡Œç®¡ç†
)

// Register è®©å„ä¸ªå®ç°Storeæ¥å£çš„ç±»å‹å¯ä»¥æŠŠè‡ªå·±â€œæ³¨å†Œâ€åˆ°å·¥å‚ä¸­æ¥
func Register(name string, p store.Store) {
    providersMu.Lock()
    defer providersMu.Unlock()
    if p == nil {
        panic("store: Register provider is nil")
    }

    if _, dup := providers[name]; dup {
        panic("store: Register called twice for provider " + name)
    }
    providers[name] = p
}

// New ä¼ å…¥æœŸæœ›ä½¿ç”¨çš„å›¾ä¹¦å­˜å‚¨å®ç°çš„åç§°ï¼Œå¾—åˆ°å¯¹åº”çš„ç±»å‹å®ä¾‹
func New(providerName string) (store.Store, error) {
    providersMu.RLock()
    p, ok := providers[providerName]
    providersMu.RUnlock()
    if !ok {
        return nil, fmt.Errorf("store: unknown provider %s", providerName)
    }
    return p, nil
}
```

ä¸€ä¸ªåŸºäºå†…å­˜mapçš„Storeæ¥å£çš„å®ç°:

```go
// internal/store/memstore.go
package store

import (
    mystore "bookstore/store"
    factory "bookstore/store/factory"
    "sync"
)

func init() {
    factory.Register("mem", &MemStore{
        books: make(map[string]*mystore.Book),
    })
}

// MemStore æ˜¯ä¸€ä¸ªåŸºäºå†…å­˜mapçš„Storeæ¥å£çš„å®ç°
type MemStore struct {
    sync.RWMutex
    books map[string]*mystore.Book
}

// ...å…·ä½“å®ç°æ–¹æ³•
```

initå‡½æ•°ä¸­è°ƒç”¨factoryåŒ…æä¾›çš„Registerå‡½æ•°ï¼ŒæŠŠè‡ªå·±çš„å®ä¾‹ä»¥â€œmemâ€çš„åç§°æ³¨å†Œåˆ°factoryä¸­çš„ã€‚è¿™æ ·åšæœ‰ä¸€ä¸ªå¥½å¤„ï¼Œä¾èµ–Storeæ¥å£è¿›è¡Œå›¾ä¹¦æ•°æ®ç®¡ç†çš„ä¸€æ–¹ï¼Œåªè¦å¯¼å…¥internal/storeè¿™ä¸ªåŒ…ï¼Œå°±å¯ä»¥è‡ªåŠ¨å®Œæˆæ³¨å†ŒåŠ¨ä½œäº†ã€‚

```go
import (
  ... ...
  _ "bookstore/internal/store" // internal/storeå°†è‡ªèº«æ³¨å†Œåˆ°factoryä¸­
)

func main() {
    s, err := factory.New("mem") // åˆ›å»ºåä¸º"mem"çš„å›¾ä¹¦æ•°æ®å­˜å‚¨æ¨¡å—å®ä¾‹
    if err != nil {
        panic(err)
    }
    ... ...
}   
```

#### HTTPæœåŠ¡æ¨¡å—ï¼ˆserverï¼‰

HTTPæœåŠ¡æ¨¡å—çš„èŒè´£æ˜¯**å¯¹å¤–æä¾›HTTP APIæœåŠ¡ï¼Œå¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„å„ç§è¯·æ±‚ï¼Œå¹¶é€šè¿‡Storeæ¥å£å®ä¾‹æ‰§è¡Œé’ˆå¯¹å›¾ä¹¦æ•°æ®çš„ç›¸å…³æ“ä½œ**ã€‚

#### ç¼–è¯‘ã€è¿è¡Œä¸éªŒè¯

```sh
$ curl -X POST -H "Content-Type:application/json" -d '{"id": "978-7-111-55842-2", "name": "The Go Programming Language", "authors":["Alan A.A.Donovan", "Brian W. Kergnighan"],"press": "Pearson Education"}' localhost:8080/book



$ curl -X GET -H "Content-Type:application/json" localhost:8080/book/978-7-111-55842-2
{"id":"978-7-111-55842-2","name":"The Go Programming Language","authors":["Alan A.A.Donovan","Brian W. Kergnighan"],"press":"Pearson Education"}
```

### æ€è€ƒé¢˜ ğŸ”–

> åŸºäºnosqlæ•°æ®åº“ï¼Œæ€ä¹ˆå®ç°ä¸€ä¸ªæ–°store.Storeæ¥å£çš„å®ç°ï¼Ÿ

# åŸºç¡€ç¯‡ï¼šâ€œè„‘å‹¤â€å¤šç†è§£

## 10 å˜é‡å£°æ˜ï¼šé™æ€è¯­è¨€æœ‰åˆ«äºåŠ¨æ€è¯­è¨€çš„é‡è¦ç‰¹å¾

åœ¨ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œä¸ºäº†æ–¹ä¾¿æ“ä½œå†…å­˜ç‰¹å®šä½ç½®çš„æ•°æ®ï¼Œæˆ‘ä»¬**ç”¨ä¸€ä¸ªç‰¹å®šçš„åå­—ä¸ä½äºç‰¹å®šä½ç½®çš„å†…å­˜å—ç»‘å®šåœ¨ä¸€èµ·**ï¼Œè¿™ä¸ªåå­—è¢«ç§°ä¸º==å˜é‡==ã€‚

å˜é‡æ‰€ç»‘å®šçš„å†…å­˜åŒºåŸŸæ˜¯è¦æœ‰ä¸€ä¸ªæ˜ç¡®çš„è¾¹ç•Œçš„ã€‚

> ç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘å™¨æˆ–è§£é‡Šå™¨æ˜¯å¦‚ä½•çŸ¥é“ä¸€ä¸ªå˜é‡æ‰€èƒ½å¼•ç”¨çš„å†…å­˜åŒºåŸŸè¾¹ç•Œå‘¢ï¼Ÿ

åŠ¨æ€è¯­è¨€çš„è§£é‡Šå™¨å¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡å¯¹å˜é‡èµ‹å€¼çš„åˆ†æï¼Œè‡ªåŠ¨ç¡®å®šå˜é‡çš„è¾¹ç•Œã€‚

é™æ€è¯­è¨€é€šè¿‡==å˜é‡å£°æ˜==ï¼Œè¯­è¨€ä½¿ç”¨è€…å¯ä»¥æ˜¾å¼å‘ŠçŸ¥ç¼–è¯‘å™¨ä¸€ä¸ªå˜é‡çš„è¾¹ç•Œä¿¡æ¯ã€‚

### Goè¯­è¨€çš„å˜é‡å£°æ˜æ–¹æ³•

![](images/image-20240703175402113.png)

å˜é‡å£°æ˜åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼š

- varæ˜¯ä¿®é¥°å˜é‡å£°æ˜çš„å…³é”®å­—ï¼›
- aä¸ºå˜é‡åï¼›
- intä¸ºè¯¥å˜é‡çš„ç±»å‹ï¼›
- 10æ˜¯å˜é‡çš„åˆå€¼ã€‚

å¦‚æœæ²¡æœ‰æ˜¾å¼ä¸ºå˜é‡èµ‹äºˆåˆå€¼ï¼ŒGoç¼–è¯‘å™¨ä¼šä¸ºå˜é‡èµ‹äºˆè¿™ä¸ªç±»å‹çš„**é›¶å€¼**ã€‚

![](images/image-20240703175543137.png)

==å˜é‡å£°æ˜å—ï¼ˆblockï¼‰==ï¼š

```go
var (
  a int = 128
  b int8 = 6
  s string = "hello"
  c rune = 'A'
  t bool = true
)
```

```go
var a, b, c int = 5, 6, 7


var (
  a, b, c int = 5, 6, 7
  c, d, e rune = 'C', 'D', 'E'
) 
```

ä¸¤ç§å˜é‡å£°æ˜çš„â€œè¯­æ³•ç³–â€:

1ï¸âƒ£çœç•¥ç±»å‹ä¿¡æ¯çš„å£°æ˜

```go
var b = 13
```

Goç¼–è¯‘å™¨ä¼šæ ¹æ®å³ä¾§å˜é‡åˆå€¼è‡ªåŠ¨æ¨å¯¼å‡ºå˜é‡çš„ç±»å‹ï¼Œå¹¶ç»™è¿™ä¸ªå˜é‡èµ‹äºˆåˆå€¼æ‰€å¯¹åº”çš„é»˜è®¤ç±»å‹ã€‚

```go
var a, b, c = 12, 'A', "hello"
```

2ï¸âƒ£çŸ­å˜é‡å£°æ˜

```go
a := 12
b := 'A'
c := "hello"
```

Goè¯­è¨€çš„å˜é‡å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š

1. ä¸€ç±»ç§°ä¸º==åŒ…çº§å˜é‡(package varible)==ï¼Œä¹Ÿå°±æ˜¯åœ¨åŒ…çº§åˆ«å¯è§çš„å˜é‡ã€‚å¦‚æœæ˜¯å¯¼å‡ºå˜é‡ï¼ˆå¤§å†™å­—æ¯å¼€å¤´ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªåŒ…çº§å˜é‡ä¹Ÿå¯ä»¥è¢«è§†ä¸º==å…¨å±€å˜é‡==ï¼›
2. å¦ä¸€ç±»åˆ™æ˜¯==å±€éƒ¨å˜é‡(local varible)==ï¼Œä¹Ÿå°±æ˜¯Goå‡½æ•°æˆ–æ–¹æ³•ä½“å†…å£°æ˜çš„å˜é‡ï¼Œä»…åœ¨å‡½æ•°æˆ–æ–¹æ³•ä½“å†…å¯è§ã€‚

### åŒ…çº§å˜é‡çš„å£°æ˜å½¢å¼

åŒ…çº§å˜é‡åªèƒ½ä½¿ç”¨å¸¦æœ‰varå…³é”®å­—çš„å˜é‡å£°æ˜å½¢å¼ï¼Œä¸èƒ½ä½¿ç”¨çŸ­å˜é‡å£°æ˜å½¢å¼ï¼Œä½†åœ¨å½¢å¼ç»†èŠ‚ä¸Šå¯ä»¥æœ‰ä¸€å®šçµæ´»åº¦ã€‚

### å±€éƒ¨å˜é‡çš„å£°æ˜å½¢å¼

1. ç¬¬ä¸€ç±»ï¼šå¯¹äºå»¶è¿Ÿåˆå§‹åŒ–çš„å±€éƒ¨å˜é‡å£°æ˜ï¼Œæˆ‘ä»¬é‡‡ç”¨é€šç”¨çš„å˜é‡å£°æ˜å½¢å¼

```go
var err error
```

2. ç¬¬äºŒç±»ï¼šå¯¹äºå£°æ˜ä¸”æ˜¾å¼åˆå§‹åŒ–çš„å±€éƒ¨å˜é‡ï¼Œå»ºè®®ä½¿ç”¨çŸ­å˜é‡å£°æ˜å½¢å¼

å°ç»“ï¼š

![](images/image-20240703180658029.png)

### æ€è€ƒé¢˜

> Goè¯­è¨€å˜é‡å£°æ˜ä¸­ï¼Œç±»å‹æ˜¯æ”¾åœ¨å˜é‡åçš„åé¢çš„ï¼Œæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ

## 11 ä»£ç å—ä¸ä½œç”¨åŸŸï¼šå¦‚ä½•ä¿è¯å˜é‡ä¸ä¼šè¢«é®è”½ï¼Ÿ

==å˜é‡é®è”½ï¼ˆVariable Shadowingï¼‰==

### 11.3 ä»£ç å—ä¸ä½œç”¨åŸŸ

Goè¯­è¨€ä¸­çš„==ä»£ç å—(Block)==æ˜¯åŒ…è£¹åœ¨ä¸€å¯¹å¤§æ‹¬å·å†…éƒ¨çš„å£°æ˜å’Œè¯­å¥åºåˆ—ã€‚

å¦‚æœä¸€å¯¹å¤§æ‹¬å·å†…éƒ¨æ²¡æœ‰ä»»ä½•å£°æ˜æˆ–å…¶ä»–è¯­å¥ï¼Œå«åš==ç©ºä»£ç å—==ã€‚Goä»£ç å—æ”¯æŒåµŒå¥—ã€‚

```go
func foo() { //ä»£ç å—1
    { // ä»£ç å—2
        { // ä»£ç å—3
            { // ä»£ç å—4

            }
        }
    }
}
```

1-4éƒ½æ˜¯==æ˜¾å¼ä»£ç å—ï¼ˆExplicit Blocksï¼‰==

==éšå¼ä»£ç å—ï¼ˆImplicit Blockï¼‰==æ˜¯æ²¡æœ‰æ˜¾å¼ä»£ç å—é‚£æ ·çš„è‚‰çœ¼å¯è§çš„é…å¯¹å¤§æ‹¬å·åŒ…è£¹ï¼Œæ— æ³•é€šè¿‡å¤§æ‹¬å·æ¥è¯†åˆ«éšå¼ä»£ç å—ã€‚

![](images/image-20240708113446638.png)

éšå¼ä»£ç å—ä»å¤§åˆ°å°ï¼š

- ==å®‡å®™ä»£ç å—ï¼ˆUniverse Blockï¼‰==ï¼Œæ‰€æœ‰Goæºç éƒ½åœ¨è¿™ä¸ªéšå¼ä»£ç å—ä¸­

- ==åŒ…ä»£ç å—ï¼ˆPackage Blockï¼‰==ï¼Œæ¯ä¸ªGoåŒ…éƒ½å¯¹åº”ä¸€ä¸ªéšå¼åŒ…ä»£ç å—

- ==æ–‡ä»¶ä»£ç å—ï¼ˆFile Blockï¼‰==ï¼Œ

- æ§åˆ¶è¯­å¥å±‚é¢ï¼ˆifã€forä¸switchï¼‰ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„æ§åˆ¶è¯­å¥éšå¼ä»£ç å—ä¸æ§åˆ¶è¯­å¥ä½¿ç”¨å¤§æ‹¬å·åŒ…è£¹çš„æ˜¾å¼ä»£ç å—å¹¶ä¸æ˜¯ä¸€ä¸ªä»£ç å—ã€‚

- case/defaultå­å¥

==ä½œç”¨åŸŸ(Scope)==çš„æ¦‚å¿µæ˜¯**é’ˆå¯¹æ ‡è¯†ç¬¦çš„ï¼Œä¸å±€é™äºå˜é‡**ã€‚æ¯ä¸ªæ ‡è¯†ç¬¦éƒ½æœ‰è‡ªå·±çš„ä½œç”¨åŸŸï¼Œè€Œ**ä¸€ä¸ªæ ‡è¯†ç¬¦çš„ä½œç”¨åŸŸå°±æ˜¯æŒ‡è¿™ä¸ªæ ‡è¯†ç¬¦åœ¨è¢«å£°æ˜åå¯ä»¥è¢«æœ‰æ•ˆä½¿ç”¨çš„æºç åŒºåŸŸ**ã€‚

ä½œç”¨åŸŸæ˜¯ä¸€ä¸ªç¼–è¯‘æœŸçš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç¼–è¯‘å™¨åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šå¯¹æ¯ä¸ªæ ‡è¯†ç¬¦çš„ä½œç”¨åŸŸè¿›è¡Œæ£€æŸ¥ï¼Œå¯¹äºåœ¨æ ‡è¯†ç¬¦ä½œç”¨åŸŸå¤–ä½¿ç”¨è¯¥æ ‡è¯†ç¬¦çš„è¡Œä¸ºä¼šç»™å‡ºç¼–è¯‘é”™è¯¯çš„æŠ¥é”™ã€‚

**å£°æ˜äºå¤–å±‚ä»£ç å—ä¸­çš„æ ‡è¯†ç¬¦ï¼Œå…¶ä½œç”¨åŸŸåŒ…æ‹¬æ‰€æœ‰å†…å±‚ä»£ç å—**ã€‚

- é¦–å…ˆçœ‹çœ‹ä½äºæœ€å¤–å±‚çš„å®‡å®™éšå¼ä»£ç å—çš„æ ‡è¯†ç¬¦ã€‚

æˆ‘ä»¬å¹¶ä¸èƒ½å£°æ˜è¿™ä¸€å—çš„æ ‡è¯†ç¬¦ï¼Œå› ä¸ºè¿™ä¸€åŒºåŸŸæ˜¯Goè¯­è¨€==é¢„å®šä¹‰æ ‡è¯†ç¬¦==ï¼š

![](images/image-20240703182641189.png)

ç”±äºè¿™äº›é¢„å®šä¹‰æ ‡è¯†ç¬¦ä½äºåŒ…ä»£ç å—çš„å¤–å±‚ï¼Œæ‰€ä»¥å®ƒä»¬çš„ä½œç”¨åŸŸæ˜¯èŒƒå›´æœ€å¤§çš„ï¼Œå¯¹äºå¼€å‘è€…è€Œè¨€ï¼Œå®ƒä»¬çš„ä½œç”¨åŸŸå°±æ˜¯æºä»£ç ä¸­çš„ä»»ä½•ä½ç½®ã€‚ä¸è¿‡ï¼Œ**è¿™äº›é¢„å®šä¹‰æ ‡è¯†ç¬¦ä¸æ˜¯å…³é”®å­—**ï¼Œæˆ‘ä»¬**åŒæ ·å¯ä»¥åœ¨å†…å±‚ä»£ç å—ä¸­å£°æ˜åŒåçš„æ ‡è¯†ç¬¦**ã€‚

- ç¬¬äºŒä¸ªé—®é¢˜ï¼šæ—¢ç„¶å®‡å®™ä»£ç å—é‡Œå­˜åœ¨é¢„å®šä¹‰æ ‡è¯†ç¬¦ï¼Œè€Œä¸”å®‡å®™ä»£ç å—çš„ä¸‹ä¸€å±‚æ˜¯åŒ…ä»£ç å—ï¼Œé‚£è¿˜æœ‰å“ªäº›æ ‡è¯†ç¬¦å…·æœ‰åŒ…ä»£ç å—çº§ä½œç”¨åŸŸå‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼Œ**åŒ…é¡¶å±‚å£°æ˜**ä¸­çš„å¸¸é‡ã€ç±»å‹ã€å˜é‡æˆ–å‡½æ•°ï¼ˆä¸åŒ…æ‹¬æ–¹æ³•ï¼‰å¯¹åº”çš„æ ‡è¯†ç¬¦çš„ä½œç”¨åŸŸæ˜¯åŒ…ä»£ç å—ã€‚

ä¸è¿‡ï¼Œå¯¹äºä½œç”¨åŸŸä¸ºåŒ…ä»£ç å—çš„æ ‡è¯†ç¬¦ï¼Œæˆ‘éœ€è¦ä½ çŸ¥é“ä¸€ä¸ªç‰¹æ®Šæƒ…å†µã€‚é‚£å°±æ˜¯å½“ä¸€ä¸ªåŒ…Aå¯¼å…¥å¦å¤–ä¸€ä¸ªåŒ…Båï¼ŒåŒ…Aä»…å¯ä»¥ä½¿ç”¨è¢«å¯¼å…¥åŒ…åŒ…Bä¸­çš„==å¯¼å‡ºæ ‡è¯†ç¬¦ï¼ˆExported Identifierï¼‰==ã€‚

> ä»€ä¹ˆæ˜¯å¯¼å‡ºæ ‡è¯†ç¬¦å‘¢ï¼Ÿ
> 
> æŒ‰ç…§Goè¯­è¨€å®šä¹‰ï¼Œä¸€ä¸ªæ ‡è¯†ç¬¦è¦æˆä¸ºå¯¼å‡ºæ ‡è¯†ç¬¦éœ€åŒæ—¶å…·å¤‡ä¸¤ä¸ªæ¡ä»¶ï¼š
> 
> - ä¸€æ˜¯è¿™ä¸ªæ ‡è¯†ç¬¦å£°æ˜åœ¨åŒ…ä»£ç å—ä¸­ï¼Œæˆ–è€…å®ƒæ˜¯ä¸€ä¸ªå­—æ®µåæˆ–æ–¹æ³•åï¼›
> - äºŒæ˜¯å®ƒåå­—ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯ä¸€ä¸ªå¤§å†™çš„Unicodeå­—ç¬¦ã€‚
> 
> è¿™ä¸¤ä¸ªæ¡ä»¶ç¼ºä¸€ä¸å¯ã€‚

ğŸ”–

```go
func (t T) M1(x int) (err error) {
// ä»£ç å—1
    m := 13

    // ä»£ç å—1æ˜¯åŒ…å«mã€tã€xå’Œerrä¸‰ä¸ªæ ‡è¯†ç¬¦çš„æœ€å†…éƒ¨ä»£ç å—
    { // ä»£ç å—2

        // "ä»£ç å—2"æ˜¯åŒ…å«ç±»å‹baræ ‡è¯†ç¬¦çš„æœ€å†…éƒ¨çš„é‚£ä¸ªåŒ…å«ä»£ç å—
        type bar struct {} // ç±»å‹æ ‡è¯†ç¬¦barçš„ä½œç”¨åŸŸå§‹äºæ­¤
        { // ä»£ç å—3

            // "ä»£ç å—3"æ˜¯åŒ…å«å˜é‡aæ ‡è¯†ç¬¦çš„æœ€å†…éƒ¨çš„é‚£ä¸ªåŒ…å«ä»£ç å—
            a := 5 // aä½œç”¨åŸŸå¼€å§‹äºæ­¤
            {  // ä»£ç å—4 
                //... ...
            }
            // aä½œç”¨åŸŸç»ˆæ­¢äºæ­¤
        }
        // ç±»å‹æ ‡è¯†ç¬¦barçš„ä½œç”¨åŸŸç»ˆæ­¢äºæ­¤
    }
    // mã€tã€xå’Œerrçš„ä½œç”¨åŸŸç»ˆæ­¢äºæ­¤
}
```

ä¸Šé¢ç¤ºä¾‹ä¸­å®šä¹‰äº†ç±»å‹Tçš„ä¸€ä¸ªæ–¹æ³•M1ï¼Œæ–¹æ³•æ¥æ”¶å™¨(receiver)å˜é‡tã€å‡½æ•°å‚æ•°xï¼Œä»¥åŠè¿”å›å€¼å˜é‡errå¯¹åº”çš„æ ‡è¯†ç¬¦çš„ä½œç”¨åŸŸèŒƒå›´æ˜¯M1å‡½æ•°ä½“å¯¹åº”çš„æ˜¾å¼ä»£ç å—1ã€‚è™½ç„¶tã€xå’Œerrå¹¶æ²¡æœ‰è¢«å‡½æ•°ä½“çš„å¤§æ‹¬å·æ‰€æ˜¾å¼åŒ…è£¹ï¼Œä½†å®ƒä»¬å±äºå‡½æ•°å®šä¹‰çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥ä½œç”¨åŸŸä¾æ—§æ˜¯ä»£ç å—1ã€‚

**å‡½æ•°å†…éƒ¨å£°æ˜çš„å¸¸é‡æˆ–å˜é‡å¯¹åº”çš„æ ‡è¯†ç¬¦**çš„ä½œç”¨åŸŸèŒƒå›´å¼€å§‹äºå¸¸é‡æˆ–å˜é‡å£°æ˜è¯­å¥çš„æœ«å°¾ï¼Œå¹¶ç»ˆæ­¢äºå…¶æœ€å†…éƒ¨çš„é‚£ä¸ªåŒ…å«å—çš„æœ«å°¾ã€‚åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œå˜é‡mã€è‡ªå®šä¹‰ç±»å‹barä»¥åŠåœ¨ä»£ç å—3ä¸­å£°æ˜çš„å˜é‡aå‡ç¬¦åˆè¿™ä¸ªåˆ’åˆ†è§„åˆ™ã€‚

ä½äºæ§åˆ¶è¯­å¥éšå¼ä»£ç å—ä¸­çš„æ ‡è¯†ç¬¦çš„ä½œç”¨åŸŸåˆ’åˆ†

```go
func bar() {
  if a := 1; false {
  } else if b := 2; false {
  } else if c := 3; false {
  } else {
    println(a, b, c)
  }
} 
```

å°†ä¸Šé¢ç¤ºä¾‹ä¸­éšå¼ä»£ç å—è½¬æ¢ä¸ºæ˜¾å¼ä»£ç å—å:

```go
func bar() {
    { // ç­‰ä»·äºç¬¬ä¸€ä¸ªifçš„éšå¼ä»£ç å—
        a := 1 // å˜é‡aä½œç”¨åŸŸå§‹äºæ­¤
        if false {

        } else {
            { // ç­‰ä»·äºç¬¬ä¸€ä¸ªelse ifçš„éšå¼ä»£ç å—
                b := 2 // å˜é‡bçš„ä½œç”¨åŸŸå§‹äºæ­¤
                if false {

                } else {
                    { // ç­‰ä»·äºç¬¬äºŒä¸ªelse ifçš„éšå¼ä»£ç å—
                        c := 3 // å˜é‡cä½œç”¨åŸŸå§‹äºæ­¤
                        if false {

                        } else {
                            println(a, b, c)
                        }
                        // å˜é‡cçš„ä½œç”¨åŸŸç»ˆæ­¢äºæ­¤
                    }
                }
                // å˜é‡bçš„ä½œç”¨åŸŸç»ˆæ­¢äºæ­¤
            }
        }
        // å˜é‡aä½œç”¨åŸŸç»ˆæ­¢äºæ­¤
    }
}
```

### 11.2 é¿å…å˜é‡é®è”½çš„åŸåˆ™

**ä¸€ä¸ªå˜é‡çš„ä½œç”¨åŸŸèµ·å§‹äºå…¶å£°æ˜æ‰€åœ¨çš„ä»£ç å—ï¼Œå¹¶ä¸”å¯ä»¥ä¸€ç›´æ‰©å±•åˆ°åµŒå…¥åˆ°è¯¥ä»£ç å—ä¸­çš„æ‰€æœ‰å†…å±‚ä»£ç å—**ï¼Œè€Œæ­£æ˜¯è¿™æ ·çš„ä½œç”¨åŸŸè§„åˆ™ï¼Œæˆä¸ºäº†æ»‹ç”Ÿâ€œå˜é‡é®è”½é—®é¢˜â€çš„åœŸå£¤ã€‚

å˜é‡é®è”½é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼Œå°±æ˜¯**å†…å±‚ä»£ç å—ä¸­å£°æ˜äº†ä¸€ä¸ªä¸å¤–å±‚ä»£ç å—åŒåä¸”åŒç±»å‹çš„å˜é‡**ã€‚

ğŸ”–

### 11.3 åˆ©ç”¨å·¥å…·æ£€æµ‹å˜é‡é®è”½é—®é¢˜

`go vet`

## 12 åŸºæœ¬æ•°æ®ç±»å‹ï¼šGoåŸç”Ÿæ”¯æŒçš„æ•°å€¼ç±»å‹æœ‰å“ªäº›ï¼Ÿ

ç±»å‹ä¸ä»…æ˜¯é™æ€è¯­è¨€ç¼–è¯‘å™¨çš„è¦æ±‚ï¼Œæ›´æ˜¯æˆ‘ä»¬**å¯¹ç°å®äº‹ç‰©è¿›è¡ŒæŠ½è±¡çš„åŸºç¡€**ã€‚

Goè¯­è¨€çš„ç±»å‹å¤§ä½“å¯åˆ†ä¸ºä¸‰ç§ï¼š==åŸºæœ¬æ•°æ®ç±»å‹==ã€==å¤åˆæ•°æ®ç±»å‹==å’Œ==æ¥å£ç±»å‹==ã€‚

Goè¯­è¨€åŸç”Ÿæ”¯æŒçš„==æ•°å€¼ç±»å‹==åŒ…æ‹¬**æ•´å‹ã€æµ®ç‚¹å‹ä»¥åŠå¤æ•°ç±»å‹**ã€‚

### è¢«å¹¿æ³›ä½¿ç”¨çš„æ•´å‹

Goè¯­è¨€çš„æ•´å‹ï¼Œä¸»è¦ç”¨æ¥è¡¨ç¤ºç°å®ä¸–ç•Œä¸­æ•´å‹æ•°é‡ï¼Œæ¯”å¦‚ï¼šäººçš„å¹´é¾„ã€ç­çº§äººæ•°ç­‰ã€‚

å®ƒå¯ä»¥åˆ†ä¸º==å¹³å°æ— å…³æ•´å‹==å’Œ==å¹³å°ç›¸å…³æ•´å‹==ï¼ŒåŒºåˆ«æ˜¯åœ¨**ä¸åŒCPUæ¶æ„æˆ–æ“ä½œç³»ç»Ÿä¸‹é•¿åº¦æ˜¯å¦æ˜¯ä¸€è‡´**ã€‚

#### å¹³å°æ— å…³æ•´å‹

![](images/image-20240703183721386.png)

![](images/image-20240703183955257.png)

Goé‡‡ç”¨**2çš„è¡¥ç ï¼ˆTwoâ€™s Complementï¼‰**ä½œä¸ºæ•´å‹çš„æ¯”ç‰¹ä½ç¼–ç æ–¹æ³•ã€‚å› æ­¤ï¼Œä¸èƒ½ç®€å•åœ°å°†æœ€é«˜æ¯”ç‰¹ä½çœ‹æˆè´Ÿå·ï¼ŒæŠŠå…¶ä½™æ¯”ç‰¹ä½è¡¨ç¤ºçš„å€¼çœ‹æˆè´Ÿå·åé¢çš„æ•°å€¼ã€‚Goçš„è¡¥ç æ˜¯é€šè¿‡**åŸç é€ä½å–ååå†åŠ 1**å¾—åˆ°çš„ï¼Œæ¯”å¦‚ï¼Œä»¥-127è¿™ä¸ªå€¼ä¸ºä¾‹ï¼Œå®ƒçš„è¡¥ç è½¬æ¢è¿‡ç¨‹å°±æ˜¯è¿™æ ·çš„ï¼š

![](images/image-20240708154448556.png)

#### å¹³å°ç›¸å…³æ•´å‹

![](images/image-20240703183824577.png)

ä¸‰ä¸ªå¹³å°ç›¸å…³æ•´å‹ï¼š`int`ã€`uint`ä¸`uintptr`ã€‚

**åœ¨ç¼–å†™æœ‰ç§»æ¤æ€§è¦æ±‚çš„ä»£ç æ—¶ï¼Œåƒä¸‡ä¸è¦å¼ºä¾èµ–è¿™äº›ç±»å‹çš„é•¿åº¦**ã€‚

```go
    var a, b = int(5), uint(6)
    var p uintptr = 0x12345678
    fmt.Println("signed integer a's length is", unsafe.Sizeof(a))   // 8
    fmt.Println("unsigned integer b's length is", unsafe.Sizeof(b)) // 8
    fmt.Println("uintptr's length is", unsafe.Sizeof(p))            // 8
```

#### æ•´å‹çš„æº¢å‡ºé—®é¢˜

ç”±äºæ•´å‹æ— æ³•è¡¨ç¤ºå®ƒæº¢å‡ºåçš„é‚£ä¸ªâ€œç»“æœâ€ï¼Œæ‰€ä»¥å‡ºç°æº¢å‡ºæƒ…å†µåï¼Œå¯¹åº”çš„æ•´å‹å˜é‡çš„å€¼ä¾ç„¶ä¼šè½åˆ°å®ƒçš„å–å€¼èŒƒå›´å†…ï¼Œåªæ˜¯ç»“æœå€¼ä¸é¢„æœŸä¸ç¬¦ï¼Œå¯¼è‡´ç¨‹åºé€»è¾‘å‡ºé”™ã€‚

```go
var s int8 = 127
s += 1 // é¢„æœŸ128ï¼Œå®é™…ç»“æœ-128

var u uint8 = 1
u -= 2 // é¢„æœŸ-1ï¼Œå®é™…ç»“æœ255
```

æœ€å®¹æ˜“å‘ç”Ÿåœ¨**å¾ªç¯è¯­å¥çš„ç»“æŸæ¡ä»¶åˆ¤æ–­**ä¸­ã€‚

#### å­—é¢å€¼ä¸æ ¼å¼åŒ–è¾“å‡º

Goè¯­è¨€åœ¨è®¾è®¡å¼€å§‹ï¼Œç»§æ‰¿äº†Cè¯­è¨€çš„==æ•°å€¼å­—é¢å€¼ï¼ˆNumber Literalï¼‰==çš„è¯­æ³•å½¢å¼ï¼š

```go
a := 53        // åè¿›åˆ¶
b := 0700      // å…«è¿›åˆ¶ï¼Œä»¥"0"ä¸ºå‰ç¼€
c1 := 0xaabbcc // åå…­è¿›åˆ¶ï¼Œä»¥"0x"ä¸ºå‰ç¼€
c2 := 0Xddeeff // åå…­è¿›åˆ¶ï¼Œä»¥"0X"ä¸ºå‰ç¼€
```

Go1.13ç‰ˆæœ¬åˆå¢åŠ äº†å¯¹äºŒè¿›åˆ¶å­—é¢å€¼çš„æ”¯æŒå’Œä¸¤ç§å…«è¿›åˆ¶å­—é¢å€¼çš„å½¢å¼:

```go
d1 := 0b10000001 // äºŒè¿›åˆ¶ï¼Œä»¥"0b"ä¸ºå‰ç¼€
d2 := 0B10000001 // äºŒè¿›åˆ¶ï¼Œä»¥"0B"ä¸ºå‰ç¼€
e1 := 0o700      // å…«è¿›åˆ¶ï¼Œä»¥"0o"ä¸ºå‰ç¼€
e2 := 0O700      // å…«è¿›åˆ¶ï¼Œä»¥"0O"ä¸ºå‰ç¼€ 
```

ä¸ºæå‡å­—é¢å€¼çš„å¯è¯»æ€§ï¼ŒGo 1.13ç‰ˆæœ¬è¿˜æ”¯æŒåœ¨å­—é¢å€¼ä¸­å¢åŠ æ•°å­—åˆ†éš”ç¬¦â€œ`_`â€:

```go
a := 5_3_7   // åè¿›åˆ¶: 537
b := 0b_1000_0111  // äºŒè¿›åˆ¶ä½è¡¨ç¤ºä¸º10000111 
c1 := 0_700  // å…«è¿›åˆ¶: 0700
c2 := 0o_700 // å…«è¿›åˆ¶: 0700
d1 := 0x_5c_6d // åå…­è¿›åˆ¶ï¼š0x5c6d
```

é€šè¿‡æ ‡å‡†åº“fmtåŒ…çš„æ ¼å¼åŒ–è¾“å‡ºå‡½æ•°ï¼Œå°†ä¸€ä¸ªæ•´å‹å˜é‡è¾“å‡ºä¸ºä¸åŒè¿›åˆ¶çš„å½¢å¼ã€‚

### æµ®ç‚¹å‹

å’Œä½¿ç”¨å¹¿æ³›çš„æ•´å‹ç›¸æ¯”ï¼Œæµ®ç‚¹å‹çš„ä½¿ç”¨åœºæ™¯å°±ç›¸å¯¹èšç„¦äº†ï¼Œä¸»è¦é›†ä¸­åœ¨**ç§‘å­¦æ•°å€¼è®¡ç®—ã€å›¾å½¢å›¾åƒå¤„ç†å’Œä»¿çœŸã€å¤šåª’ä½“æ¸¸æˆä»¥åŠäººå·¥æ™ºèƒ½**ç­‰é¢†åŸŸã€‚

#### æµ®ç‚¹å‹çš„äºŒè¿›åˆ¶è¡¨ç¤º

[IEEE 754æ ‡å‡†](https://zh.wikipedia.org/wiki/IEEE_754)æ˜¯IEEEåˆ¶å®šçš„äºŒè¿›åˆ¶æµ®ç‚¹æ•°ç®—æœ¯æ ‡å‡†ï¼Œå®ƒæ˜¯20ä¸–çºª80å¹´ä»£ä»¥æ¥æœ€å¹¿æ³›ä½¿ç”¨çš„æµ®ç‚¹æ•°è¿ç®—æ ‡å‡†ï¼Œè¢«è®¸å¤šCPUä¸æµ®ç‚¹è¿ç®—å™¨é‡‡ç”¨ã€‚ç°å­˜çš„å¤§éƒ¨åˆ†ä¸»æµç¼–ç¨‹è¯­è¨€ï¼ŒåŒ…æ‹¬Goè¯­è¨€ï¼Œéƒ½æä¾›äº†ç¬¦åˆIEEE 754æ ‡å‡†çš„æµ®ç‚¹æ•°æ ¼å¼ä¸ç®—æœ¯è¿ç®—ã€‚

EE 754æ ‡å‡†è§„å®šäº†å››ç§è¡¨ç¤ºæµ®ç‚¹æ•°å€¼çš„æ–¹å¼ï¼š**å•ç²¾åº¦ï¼ˆ32ä½ï¼‰ã€åŒç²¾åº¦ï¼ˆ64ä½ï¼‰**ã€æ‰©å±•å•ç²¾åº¦ï¼ˆ43æ¯”ç‰¹ä»¥ä¸Šï¼‰ä¸æ‰©å±•åŒç²¾åº¦ï¼ˆ79æ¯”ç‰¹ä»¥ä¸Šï¼Œé€šå¸¸ä»¥80ä½å®ç°ï¼‰ã€‚åä¸¤ç§å…¶å®å¾ˆå°‘ä½¿ç”¨

`float32`ä¸`float64`ï¼ˆæ²¡æœ‰`float`ï¼‰ï¼Œé»˜è®¤å€¼éƒ½ä¸º`0.0`ï¼Œå ç”¨çš„å†…å­˜**ç©ºé—´å¤§å°**ä¸åŒï¼Œå¯ä»¥è¡¨ç¤ºçš„æµ®ç‚¹æ•°çš„**èŒƒå›´ä¸ç²¾åº¦**ä¹Ÿä¸åŒã€‚

IEEE 754è§„èŒƒç»™å‡ºäº†åœ¨å†…å­˜ä¸­å­˜å‚¨å’Œè¡¨ç¤ºä¸€ä¸ªæµ®ç‚¹æ•°çš„æ ‡å‡†å½¢å¼ï¼š

![](images/image-20240703185755005.png)

ç¬¦å·ä½ã€é˜¶ç ï¼ˆå³ç»è¿‡æ¢ç®—çš„æŒ‡æ•°ï¼‰ï¼Œä»¥åŠå°¾æ•°

![](images/image-20240703185844655.png)

å½“ç¬¦å·ä½ä¸º1æ—¶ï¼Œæµ®ç‚¹å€¼ä¸ºè´Ÿå€¼ï¼›å½“ç¬¦å·ä½ä¸º0æ—¶ï¼Œæµ®ç‚¹å€¼ä¸ºæ­£å€¼ã€‚å…¬å¼ä¸­offsetè¢«ç§°ä¸º==é˜¶ç åç§»å€¼==ã€‚

![](images/image-20240703185935111.png)

- å•ç²¾åº¦æµ®ç‚¹ç±»å‹ï¼ˆfloat32ï¼‰ä¸ºç¬¦å·ä½åˆ†é…äº†1ä¸ªbitï¼Œä¸ºé˜¶ç åˆ†é…äº†8ä¸ªbitï¼Œå‰©ä¸‹çš„23ä¸ªbitåˆ†ç»™äº†å°¾æ•°ã€‚
- åŒç²¾åº¦æµ®ç‚¹ç±»å‹ï¼Œé™¤äº†ç¬¦å·ä½çš„é•¿åº¦ä¸å•ç²¾åº¦ä¸€æ ·ä¹‹å¤–ï¼Œå…¶ä½™ä¸¤ä¸ªéƒ¨åˆ†çš„é•¿åº¦éƒ½è¦è¿œå¤§äºå•ç²¾åº¦æµ®ç‚¹å‹ï¼Œé˜¶ç å¯ç”¨çš„bitä½æ•°é‡ä¸º11ï¼Œå°¾æ•°åˆ™æ›´æ˜¯æ‹¥æœ‰äº†52ä¸ªbitä½ã€‚

ğŸ”–

#### å­—é¢å€¼ä¸æ ¼å¼åŒ–è¾“å‡º

1. ä¸€ç±»æ˜¯ç›´ç™½åœ°ç”¨åè¿›åˆ¶è¡¨ç¤ºçš„æµ®ç‚¹å€¼å½¢å¼

```go
3.1415
.15  // æ•´æ•°éƒ¨åˆ†å¦‚æœä¸º0ï¼Œæ•´æ•°éƒ¨åˆ†å¯ä»¥çœç•¥ä¸å†™
81.80
82. // å°æ•°éƒ¨åˆ†å¦‚æœä¸º0ï¼Œå°æ•°ç‚¹åçš„0å¯ä»¥çœç•¥ä¸å†™
```

2. å¦ä¸€ç±»åˆ™æ˜¯ç§‘å­¦è®¡æ•°æ³•å½¢å¼

```go
6674.28e-2 // 6674.28 * 10^(-2) = 66.742800
.12345E+5  // 0.12345 * 10^5 = 12345.000000


0x2.p10  // 2.0 * 2^10 = 2048.000000
0x1.Fp+0 // 1.9375 * 2^0 = 1.937500
```

```go
var f float64 = 123.45678
fmt.Printf("%f\n", f) // 123.456780

fmt.Printf("%e\n", f) // 1.234568e+02
fmt.Printf("%x\n", f) // 0x1.edd3be22e5de1p+06
```

### å¤æ•°ç±»å‹

ğŸ”–

### å»¶å±•ï¼šåˆ›å»ºè‡ªå®šä¹‰çš„æ•°å€¼ç±»å‹

- å¯ä»¥é€šè¿‡typeå…³é”®å­—åŸºäºåŸç”Ÿæ•°å€¼ç±»å‹æ¥å£°æ˜ä¸€ä¸ªæ–°ç±»å‹:

```go
type MyInt int32
```

MyIntç±»å‹çš„åº•å±‚ç±»å‹æ˜¯int32ï¼Œå®ƒçš„æ•°å€¼æ€§è´¨ä¸int32å®Œå…¨ç›¸åŒï¼Œä½†å®ƒä»¬ä»ç„¶æ˜¯**å®Œå…¨ä¸åŒçš„ä¸¤ç§ç±»å‹**ã€‚

```go
var m int = 5
var n int32 = 6
var a MyInt = m // é”™è¯¯ï¼šåœ¨èµ‹å€¼ä¸­ä¸èƒ½å°†mï¼ˆintç±»å‹ï¼‰ä½œä¸ºMyIntç±»å‹ä½¿ç”¨
var a MyInt = n // é”™è¯¯ï¼šåœ¨èµ‹å€¼ä¸­ä¸èƒ½å°†nï¼ˆint32ç±»å‹ï¼‰ä½œä¸ºMyIntç±»å‹ä½¿ç”¨   
```

- ä¹Ÿå¯ä»¥é€šè¿‡Goæä¾›çš„**ç±»å‹åˆ«åï¼ˆType Aliasï¼‰**è¯­æ³•æ¥è‡ªå®šä¹‰æ•°å€¼ç±»å‹ã€‚

å’Œä¸Šé¢ä½¿ç”¨æ ‡å‡†typeè¯­æ³•çš„å®šä¹‰ä¸åŒçš„æ˜¯ï¼Œé€šè¿‡ç±»å‹åˆ«åè¯­æ³•å®šä¹‰çš„æ–°ç±»å‹ä¸åŸç±»å‹åˆ«æ— äºŒè‡´ï¼Œå¯ä»¥å®Œå…¨ç›¸äº’æ›¿ä»£ã€‚

```go
type MyInt = int32

var n int32 = 6
var a MyInt = n // ok
```

### æ€è€ƒé¢˜

> ä¸‹é¢ä¾‹å­ä¸­f1ä¸ºä½•ä¼šä¸f2ç›¸ç­‰ï¼Ÿ
> 
> ```go
> var f1 float32 = 16777216.0
> var f2 float32 = 16777217.0
> f1 == f2 // true
> ```

## 13 åŸºæœ¬æ•°æ®ç±»å‹ï¼šä¸ºä»€ä¹ˆGoè¦åŸç”Ÿæ”¯æŒå­—ç¬¦ä¸²ç±»å‹ï¼Ÿ

### 13.1 åŸç”Ÿæ”¯æŒå­—ç¬¦ä¸²æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ

Cè¯­è¨€æ²¡æœ‰æä¾›å¯¹å­—ç¬¦ä¸²ç±»å‹çš„åŸç”Ÿæ”¯æŒï¼Œå­—ç¬¦ä¸²æ˜¯ä»¥å­—ç¬¦ä¸²å­—é¢å€¼æˆ–ä»¥â€™`\0`â€™ç»“å°¾çš„å­—ç¬¦ç±»å‹æ•°ç»„æ¥å‘ˆç°çš„ã€‚

```c
#define GO_SLOGAN "less is more"
const char * s1 = "hello, gopher"
char s2[] = "I love go"   
```

è¿™æ ·å®šä¹‰çš„éåŸç”Ÿå­—ç¬¦ä¸²åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šæœ‰å¾ˆå¤šé—®é¢˜ï¼Œæ¯”å¦‚ï¼š

- ä¸æ˜¯åŸç”Ÿç±»å‹ï¼Œç¼–è¯‘å™¨ä¸ä¼šå¯¹å®ƒè¿›è¡Œç±»å‹æ ¡éªŒï¼Œå¯¼è‡´ç±»å‹å®‰å…¨æ€§å·®ï¼›
- å­—ç¬¦ä¸²æ“ä½œæ—¶è¦æ—¶åˆ»è€ƒè™‘ç»“å°¾çš„â€™\0â€™ï¼Œé˜²æ­¢ç¼“å†²åŒºæº¢å‡ºï¼›
- ä»¥å­—ç¬¦æ•°ç»„å½¢å¼å®šä¹‰çš„â€œå­—ç¬¦ä¸²â€ï¼Œå®ƒçš„å€¼æ˜¯å¯å˜çš„ï¼Œåœ¨å¹¶å‘åœºæ™¯ä¸­éœ€è¦è€ƒè™‘åŒæ­¥é—®é¢˜ï¼›
- è·å–ä¸€ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦ä»£ä»·è¾ƒå¤§ï¼Œé€šå¸¸æ˜¯O(n)æ—¶é—´å¤æ‚åº¦ï¼›
- Cè¯­è¨€æ²¡æœ‰å†…ç½®å¯¹éASCIIå­—ç¬¦ï¼ˆå¦‚ä¸­æ–‡å­—ç¬¦ï¼‰çš„æ”¯æŒã€‚

Goè¯­è¨€é€šè¿‡stringç±»å‹ç»Ÿä¸€äº†å¯¹â€œå­—ç¬¦ä¸²â€çš„æŠ½è±¡ã€‚è¿™æ ·æ— è®ºæ˜¯**å­—ç¬¦ä¸²å¸¸é‡ã€å­—ç¬¦ä¸²å˜é‡**æˆ–æ˜¯ä»£ç ä¸­å‡ºç°çš„**å­—ç¬¦ä¸²å­—é¢å€¼**ï¼Œå®ƒä»¬çš„ç±»å‹éƒ½è¢«ç»Ÿä¸€è®¾ç½®ä¸º`string`ã€‚

```go
const (
    GO_SLOGAN = "less is more" // GO_SLOGANæ˜¯stringç±»å‹å¸¸é‡
    s1 = "hello, gopher"       // s1æ˜¯stringç±»å‹å¸¸é‡
)

var s2 = "I love go" // s2æ˜¯stringç±»å‹å˜é‡
```

è¿™æ ·çš„è®¾è®¡å¸¦æ¥çš„å¥½å¤„ï¼š

- ç¬¬ä¸€ç‚¹ï¼šstringç±»å‹çš„æ•°æ®æ˜¯**==ä¸å¯å˜==**çš„ï¼Œæé«˜äº†å­—ç¬¦ä¸²çš„==å¹¶å‘å®‰å…¨æ€§==å’Œ==å­˜å‚¨åˆ©ç”¨ç‡==ã€‚

Goå­—ç¬¦ä¸²å¯ä»¥è¢«å¤šä¸ªGoroutineå…±äº«ï¼Œå¼€å‘è€…ä¸ç”¨å› ä¸ºæ‹…å¿ƒå¹¶å‘å®‰å…¨é—®é¢˜ã€‚

ç”±äºå­—ç¬¦ä¸²çš„ä¸å¯å˜æ€§ï¼Œé’ˆå¯¹åŒä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œæ— è®ºå®ƒåœ¨ç¨‹åºçš„å‡ ä¸ªä½ç½®è¢«ä½¿ç”¨ï¼ŒGoç¼–è¯‘å™¨åªéœ€è¦ä¸ºå®ƒåˆ†é…ä¸€å—å­˜å‚¨å°±å¥½äº†ï¼Œå¤§å¤§æé«˜äº†å­˜å‚¨åˆ©ç”¨ç‡ã€‚

- ç¬¬äºŒç‚¹ï¼šæ²¡æœ‰ç»“å°¾â€™\0â€™ï¼Œè€Œä¸”è·å–é•¿åº¦çš„æ—¶é—´å¤æ‚åº¦æ˜¯å¸¸æ•°æ—¶é—´ï¼Œæ¶ˆé™¤äº†è·å–å­—ç¬¦ä¸²é•¿åº¦çš„å¼€é”€ã€‚ 

åœ¨Cè¯­è¨€ä¸­ï¼Œè·å–ä¸€ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦å¯ä»¥è°ƒç”¨æ ‡å‡†åº“çš„strlenå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„å®ç°åŸç†æ˜¯éå†å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦å¹¶åšè®¡æ•°ï¼Œç›´åˆ°é‡åˆ°å­—ç¬¦ä¸²çš„ç»“å°¾â€™\0â€™åœæ­¢ã€‚æ˜¾ç„¶è¿™æ˜¯ä¸€ä¸ªçº¿æ€§æ—¶é—´å¤æ‚åº¦çš„ç®—æ³•ï¼Œæ‰§è¡Œæ—¶é—´ä¸å­—ç¬¦ä¸²ä¸­å­—ç¬¦ä¸ªæ•°æˆæ­£æ¯”ã€‚å¹¶ä¸”ï¼Œå®ƒå­˜åœ¨ä¸€ä¸ªçº¦æŸï¼Œé‚£å°±æ˜¯ä¼ å…¥çš„å­—ç¬¦ä¸²å¿…é¡»æœ‰ç»“å°¾â€™\0â€™ï¼Œç»“å°¾â€™\0â€™æ˜¯å­—ç¬¦ä¸²çš„ç»“æŸæ ‡å¿—ã€‚

Goå­—ç¬¦ä¸²ä¸­æ²¡æœ‰ç»“å°¾â€™\0â€™ï¼Œè·å–å­—ç¬¦ä¸²é•¿åº¦æ›´ä¸éœ€è¦ç»“å°¾â€™\0â€™ä½œä¸ºç»“æŸæ ‡å¿—ã€‚å¹¶ä¸”ï¼ŒGoè·å–å­—ç¬¦ä¸²é•¿åº¦æ˜¯ä¸€ä¸ªå¸¸æ•°çº§æ—¶é—´å¤æ‚åº¦ï¼Œæ— è®ºå­—ç¬¦ä¸²ä¸­å­—ç¬¦ä¸ªæ•°æœ‰å¤šå°‘ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥å¿«é€Ÿå¾—åˆ°å­—ç¬¦ä¸²çš„é•¿åº¦å€¼ã€‚

- ç¬¬ä¸‰ç‚¹ï¼šåŸç”Ÿæ”¯æŒâ€œæ‰€è§å³æ‰€å¾—â€çš„åŸå§‹å­—ç¬¦ä¸²ï¼Œå¤§å¤§é™ä½æ„é€ å¤šè¡Œå­—ç¬¦ä¸²æ—¶çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚

```go
var s string = `         ,_---~~~~~----._
    _,,_,*^____      _____*g*\"*,--,
   / __/ /'     ^.  /      \ ^@q   f
  [  @f | @))    |  | @))   l  0 _/
   \/   \~____ / __ \_____/     \
    |           _l__l_           I
    }          [______]           I
    ]            | | |            |
    ]             ~ ~             |
    |                            |
     |                           |`
fmt.Println(s)
```

- ç¬¬å››ç‚¹ï¼šå¯¹éASCIIå­—ç¬¦æä¾›åŸç”Ÿæ”¯æŒï¼Œæ¶ˆé™¤äº†æºç åœ¨ä¸åŒç¯å¢ƒä¸‹æ˜¾ç¤ºä¹±ç çš„å¯èƒ½ã€‚

Goå­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦éƒ½æ˜¯ä¸€ä¸ªUnicodeå­—ç¬¦ï¼Œå¹¶ä¸”è¿™äº›Unicodeå­—ç¬¦æ˜¯ä»¥UTF-8ç¼–ç æ ¼å¼å­˜å‚¨åœ¨å†…å­˜å½“ä¸­çš„ã€‚

### 13.2 Goå­—ç¬¦ä¸²çš„ç»„æˆ

Goè¯­è¨€åœ¨çœ‹å¾…Goå­—ç¬¦ä¸²ç»„æˆè¿™ä¸ªé—®é¢˜ä¸Šï¼Œæœ‰ä¸¤ç§è§†è§’ã€‚

ä¸€ç§æ˜¯**å­—èŠ‚è§†è§’**ï¼Œä¹Ÿå°±æ˜¯å’Œæ‰€æœ‰å…¶å®ƒæ”¯æŒå­—ç¬¦ä¸²çš„ä¸»æµè¯­è¨€ä¸€æ ·ï¼ŒGoè¯­è¨€ä¸­çš„å­—ç¬¦ä¸²å€¼ä¹Ÿæ˜¯ä¸€ä¸ªå¯ç©ºçš„==å­—èŠ‚åºåˆ—==ï¼Œå­—èŠ‚åºåˆ—ä¸­çš„å­—èŠ‚ä¸ªæ•°ç§°ä¸ºè¯¥å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚ä¸€ä¸ªä¸ªçš„å­—èŠ‚åªæ˜¯å­¤ç«‹æ•°æ®ï¼Œä¸è¡¨æ„ã€‚

```go
var s = "ä¸­å›½äºº"
fmt.Printf("the length of s = %d\n", len(s)) // 9

for i := 0; i < len(s); i++ {
    fmt.Printf("0x%x ", s[i]) // 0xe4 0xb8 0xad 0xe5 0x9b 0xbd 0xe4 0xba 0xba
}
fmt.Printf("\n")
```

å¦‚æœè¦è¡¨æ„ï¼Œå°±éœ€è¦ä»å­—ç¬¦ä¸²çš„å¦å¤–ä¸€ä¸ªè§†è§’æ¥çœ‹ï¼šå­—ç¬¦ä¸²æ˜¯ç”±ä¸€ä¸ªå¯ç©ºçš„==å­—ç¬¦åºåˆ—==æ„æˆã€‚

```go
var s = "ä¸­å›½äºº"
fmt.Println("the character count in s is", utf8.RuneCountInString(s)) // 3

for _, c := range s {
    fmt.Printf("0x%x ", c) // 0x4e2d 0x56fd 0x4eba
}
fmt.Printf("\n")
```

Goé‡‡ç”¨çš„æ˜¯Unicodeå­—ç¬¦é›†ï¼Œæ¯ä¸ªå­—ç¬¦éƒ½æ˜¯ä¸€ä¸ªUnicodeå­—ç¬¦ï¼Œé‚£ä¹ˆè¿™é‡Œè¾“å‡ºçš„0x4e2dã€0x56fdå’Œ0x4ebaå°±åº”è¯¥æ˜¯æŸç§Unicodeå­—ç¬¦çš„è¡¨ç¤ºäº†ã€‚ä»¥0x4e2dä¸ºä¾‹ï¼Œå®ƒæ˜¯æ±‰å­—â€œä¸­â€åœ¨Unicodeå­—ç¬¦é›†è¡¨ä¸­çš„==ç ç‚¹ï¼ˆCode Pointï¼‰==ã€‚

> Unicodeå­—ç¬¦é›†ä¸­çš„æ¯ä¸ªå­—ç¬¦ï¼Œéƒ½è¢«åˆ†é…äº†ç»Ÿä¸€ä¸”å”¯ä¸€çš„å­—ç¬¦ç¼–å·ã€‚æ‰€è°“**Unicodeç ç‚¹**ï¼Œå°±æ˜¯æŒ‡å°†Unicodeå­—ç¬¦é›†ä¸­çš„æ‰€æœ‰å­—ç¬¦â€œæ’æˆä¸€é˜Ÿâ€ï¼Œå­—ç¬¦åœ¨è¿™ä¸ªâ€œé˜Ÿä¼â€ä¸­çš„**ä½æ¬¡**ï¼Œå°±æ˜¯å®ƒåœ¨Unicodeå­—ç¬¦é›†ä¸­çš„ç ç‚¹ã€‚ä¹Ÿå°±è¯´ï¼Œä¸€ä¸ªç ç‚¹å”¯ä¸€å¯¹åº”ä¸€ä¸ªå­—ç¬¦ã€‚

#### runeç±»å‹ä¸å­—ç¬¦å­—é¢å€¼

Goä½¿ç”¨`rune`è¿™ä¸ªç±»å‹æ¥è¡¨ç¤ºä¸€ä¸ªUnicodeç ç‚¹ã€‚runeæœ¬è´¨ä¸Šæ˜¯int32ç±»å‹çš„åˆ«åç±»å‹ï¼Œå®ƒä¸int32ç±»å‹æ˜¯å®Œå…¨ç­‰ä»·çš„ï¼š

```go
// $GOROOT/src/builtin.go
type rune = int32
```

**ä¸€ä¸ªruneå®ä¾‹å°±æ˜¯ä¸€ä¸ªUnicodeå­—ç¬¦ï¼Œä¸€ä¸ªGoå­—ç¬¦ä¸²ä¹Ÿå¯ä»¥è¢«è§†ä¸ºruneå®ä¾‹çš„é›†åˆã€‚å¯ä»¥é€šè¿‡å­—ç¬¦å­—é¢å€¼æ¥åˆå§‹åŒ–ä¸€ä¸ªruneå˜é‡ã€‚**

å­—ç¬¦å­—é¢å€¼æœ‰å¤šç§è¡¨ç¤ºæ³•:

- å•å¼•å·æ‹¬èµ·çš„å­—ç¬¦å­—é¢å€¼

```go
'a'  // ASCIIå­—ç¬¦
'ä¸­' // Unicodeå­—ç¬¦é›†ä¸­çš„ä¸­æ–‡å­—ç¬¦
'\n' // æ¢è¡Œå­—ç¬¦
'\'' // å•å¼•å·å­—ç¬¦
```

- Unicodeä¸“ç”¨çš„è½¬ä¹‰å­—ç¬¦\uæˆ–\Uä½œä¸ºå‰ç¼€

```go
'\u4e2d'     // å­—ç¬¦ï¼šä¸­
'\U00004e2d' // å­—ç¬¦ï¼šä¸­
'\u0027'     // å•å¼•å·å­—ç¬¦
```

`\u`åé¢æ¥ä¸¤ä¸ªåå…­è¿›åˆ¶æ•°ã€‚å¦‚æœæ˜¯ç”¨ä¸¤ä¸ªåå…­è¿›åˆ¶æ•°æ— æ³•è¡¨ç¤ºçš„Unicodeå­—ç¬¦ï¼Œå¯ä»¥ä½¿ç”¨`\U`ï¼Œ\Uåé¢å¯ä»¥æ¥å››ä¸ªåå…­è¿›åˆ¶æ•°æ¥è¡¨ç¤ºä¸€ä¸ªUnicodeå­—ç¬¦ã€‚

- ç”±äºè¡¨ç¤ºç ç‚¹çš„runeæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªæ•´å‹æ•°ï¼Œè¿˜å¯**ç”¨æ•´å‹å€¼æ¥ç›´æ¥ä½œä¸ºå­—ç¬¦å­—é¢å€¼ç»™runeå˜é‡èµ‹å€¼**

```go
'\x27'  // ä½¿ç”¨åå…­è¿›åˆ¶è¡¨ç¤ºçš„å•å¼•å·å­—ç¬¦
'\047'  // ä½¿ç”¨å…«è¿›åˆ¶è¡¨ç¤ºçš„å•å¼•å·å­—ç¬¦
```

#### å­—ç¬¦ä¸²å­—é¢å€¼

**æŠŠè¡¨ç¤ºå•ä¸ªå­—ç¬¦çš„å•å¼•å·ï¼Œæ¢ä¸ºè¡¨ç¤ºå¤šä¸ªå­—ç¬¦ç»„æˆçš„å­—ç¬¦ä¸²çš„åŒå¼•å·**

```go
"abc\n"
"ä¸­å›½äºº"
"\u4e2d\u56fd\u4eba" // ä¸­å›½äºº
"\U00004e2d\U000056fd\U00004eba" // ä¸­å›½äºº
"ä¸­\u56fd\u4eba" // ä¸­å›½äººï¼Œä¸åŒå­—ç¬¦å­—é¢å€¼å½¢å¼æ··åˆåœ¨ä¸€èµ·
"\xe4\xb8\xad\xe5\x9b\xbd\xe4\xba\xba" // åå…­è¿›åˆ¶è¡¨ç¤ºçš„å­—ç¬¦ä¸²å­—é¢å€¼ï¼šä¸­å›½äºº
```

> æœ€åä¸€è¡Œä½¿ç”¨çš„æ˜¯åå…­è¿›åˆ¶å½¢å¼çš„å­—ç¬¦ä¸²å­—é¢å€¼ï¼Œä½†æ¯ä¸ªå­—èŠ‚çš„å€¼ä¸å‰é¢å‡ è¡Œçš„ç ç‚¹å€¼å®Œå…¨å¯¹åº”ä¸ä¸Šå•Šï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ
> 
> utf8

#### UTF-8ç¼–ç æ–¹æ¡ˆ

UTF-8ç¼–ç è§£å†³çš„æ˜¯**Unicodeç ç‚¹å€¼åœ¨è®¡ç®—æœºä¸­å¦‚ä½•å­˜å‚¨å’Œè¡¨ç¤ºï¼ˆä½æ¨¡å¼ï¼‰çš„é—®é¢˜**ã€‚

> ç ç‚¹å”¯ä¸€ç¡®å®šä¸€ä¸ªUnicodeå­—ç¬¦ï¼Œç›´æ¥ç”¨ç ç‚¹å€¼ä¸è¡Œä¹ˆï¼Ÿ

è¿™çš„ç¡®æ˜¯å¯ä»¥çš„ï¼Œå¹¶ä¸”UTF-32ç¼–ç æ ‡å‡†å°±æ˜¯é‡‡ç”¨çš„è¿™ä¸ªæ–¹æ¡ˆã€‚UTF-32ç¼–ç æ–¹æ¡ˆå›ºå®šä½¿ç”¨4ä¸ªå­—èŠ‚è¡¨ç¤ºæ¯ä¸ªUnicodeå­—ç¬¦ç ç‚¹ï¼Œè¿™å¸¦æ¥çš„å¥½å¤„å°±æ˜¯ç¼–è§£ç ç®€å•ï¼Œä½†ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œä¸»è¦æœ‰ä¸‹é¢å‡ ç‚¹ï¼š

- è¿™ç§ç¼–ç æ–¹æ¡ˆä½¿ç”¨4ä¸ªå­—èŠ‚å­˜å‚¨å’Œä¼ è¾“ä¸€ä¸ªæ•´å‹æ•°çš„æ—¶å€™ï¼Œéœ€è¦è€ƒè™‘ä¸åŒå¹³å°çš„å­—èŠ‚åºé—®é¢˜;
- ç”±äºé‡‡ç”¨4å­—èŠ‚çš„å›ºå®šé•¿åº¦ç¼–ç ï¼Œä¸é‡‡ç”¨1å­—èŠ‚ç¼–ç çš„ASCIIå­—ç¬¦é›†æ— æ³•å…¼å®¹ï¼›
- æ‰€æœ‰Unicodeå­—ç¬¦ç ç‚¹éƒ½ç”¨4å­—èŠ‚ç¼–ç ï¼Œæ˜¾ç„¶ç©ºé—´åˆ©ç”¨ç‡å¾ˆå·®ã€‚

é’ˆå¯¹è¿™äº›é—®é¢˜ï¼ŒGoè¯­è¨€ä¹‹çˆ¶Rob Pikeå‘æ˜äº†UTF-8ç¼–ç æ–¹æ¡ˆã€‚å’ŒUTF-32æ–¹æ¡ˆä¸åŒï¼ŒUTF-8æ–¹æ¡ˆä½¿ç”¨**å˜é•¿åº¦å­—èŠ‚**ï¼Œå¯¹Unicodeå­—ç¬¦çš„ç ç‚¹è¿›è¡Œç¼–ç ã€‚ç¼–ç é‡‡ç”¨çš„å­—èŠ‚æ•°é‡ä¸Unicodeå­—ç¬¦åœ¨ç ç‚¹è¡¨ä¸­çš„åºå·æœ‰å…³ï¼š**è¡¨ç¤ºåºå·ï¼ˆç ç‚¹ï¼‰å°çš„å­—ç¬¦ä½¿ç”¨çš„å­—èŠ‚æ•°é‡å°‘ï¼Œè¡¨ç¤ºåºå·ï¼ˆç ç‚¹ï¼‰å¤§çš„å­—ç¬¦ä½¿ç”¨çš„å­—èŠ‚æ•°å¤šã€‚**

UTF-8ç¼–ç ä½¿ç”¨çš„å­—èŠ‚æ•°é‡ä»1ä¸ªåˆ°4ä¸ªä¸ç­‰ã€‚

- å‰128ä¸ªä¸ASCIIå­—ç¬¦é‡åˆçš„ç ç‚¹ï¼ˆU+0000~U+007Fï¼‰ä½¿ç”¨1ä¸ªå­—èŠ‚è¡¨ç¤ºï¼›
- å¸¦å˜éŸ³ç¬¦å·çš„æ‹‰ä¸æ–‡ã€å¸Œè…Šæ–‡ã€è¥¿é‡Œå°”å­—æ¯ã€é˜¿æ‹‰ä¼¯æ–‡ç­‰ä½¿ç”¨2ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºï¼›
- è€Œä¸œäºšæ–‡å­—ï¼ˆåŒ…æ‹¬æ±‰å­—ï¼‰ä½¿ç”¨3ä¸ªå­—èŠ‚è¡¨ç¤ºï¼›
- å…¶ä»–æå°‘ä½¿ç”¨çš„è¯­è¨€çš„å­—ç¬¦åˆ™ä½¿ç”¨4ä¸ªå­—èŠ‚è¡¨ç¤ºã€‚

è¿™æ ·çš„ç¼–ç æ–¹æ¡ˆæ˜¯å…¼å®¹ASCIIå­—ç¬¦å†…å­˜è¡¨ç¤ºçš„ï¼Œè¿™æ„å‘³ç€é‡‡ç”¨UTF-8æ–¹æ¡ˆåœ¨å†…å­˜ä¸­è¡¨ç¤ºUnicodeå­—ç¬¦æ—¶ï¼Œå·²æœ‰çš„ASCIIå­—ç¬¦å¯ä»¥è¢«ç›´æ¥å½“æˆUnicodeå­—ç¬¦è¿›è¡Œå­˜å‚¨å’Œä¼ è¾“ï¼Œä¸ç”¨å†åšä»»ä½•æ”¹å˜ã€‚

æ­¤å¤–ï¼ŒUTF-8çš„ç¼–ç å•å…ƒä¸ºä¸€ä¸ªå­—èŠ‚ï¼ˆä¹Ÿå°±æ˜¯ä¸€æ¬¡ç¼–è§£ç ä¸€ä¸ªå­—èŠ‚ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å¤„ç†UTF-8æ–¹æ¡ˆè¡¨ç¤ºçš„Unicodeå­—ç¬¦çš„æ—¶å€™ï¼Œå°±ä¸éœ€è¦åƒUTF-32æ–¹æ¡ˆé‚£æ ·è€ƒè™‘å­—èŠ‚åºé—®é¢˜äº†ã€‚ç›¸å¯¹äºUTF-32æ–¹æ¡ˆï¼ŒUTF-8æ–¹æ¡ˆçš„**ç©ºé—´åˆ©ç”¨ç‡**ä¹Ÿæ˜¯æœ€é«˜çš„ã€‚

ç°åœ¨ï¼ŒUTF-8ç¼–ç æ–¹æ¡ˆå·²ç»æˆä¸ºUnicodeå­—ç¬¦ç¼–ç æ–¹æ¡ˆçš„äº‹å®æ ‡å‡†ï¼Œå„ä¸ªå¹³å°ã€æµè§ˆå™¨ç­‰é»˜è®¤å‡ä½¿ç”¨UTF-8ç¼–ç æ–¹æ¡ˆå¯¹Unicodeå­—ç¬¦è¿›è¡Œç¼–ã€è§£ç ã€‚Goè¯­è¨€ä¹Ÿä¸ä¾‹å¤–ï¼Œé‡‡ç”¨äº†UTF-8ç¼–ç æ–¹æ¡ˆå­˜å‚¨Unicodeå­—ç¬¦ï¼Œæˆ‘ä»¬åœ¨å‰é¢æŒ‰å­—èŠ‚è¾“å‡ºä¸€ä¸ªå­—ç¬¦ä¸²å€¼æ—¶çœ‹åˆ°çš„å­—èŠ‚åºåˆ—ï¼Œå°±æ˜¯å¯¹å­—ç¬¦è¿›è¡ŒUTF-8ç¼–ç åçš„å€¼ã€‚

ä½¿ç”¨Goåœ¨æ ‡å‡†åº“ä¸­æä¾›çš„UTF-8åŒ…ï¼Œå¯¹Unicodeå­—ç¬¦ï¼ˆruneï¼‰è¿›è¡Œç¼–è§£ç :

```go
// rune -> []byte
func encodeRune() {
    var r rune = 0x4e2d
    fmt.Printf("è¿™ä¸ªunicodeå­—ç¬¦æ˜¯ï¼š%c\n", r)
    buf := make([]byte, 3)
    _ = utf8.EncodeRune(buf, r) // å¯¹runeè¿›è¡Œutf8ç¼–ç 
    fmt.Printf("è¿™ä¸ªå­—ç¬¦çš„utf8æè¿°ä¸ºï¼š0x%X\n", buf)
}

// []byte -> rune
func decodeRune() {
    var buf = []byte{0xe4, 0xb8, 0xad}
    r, _ := utf8.DecodeRune(buf) // å¯¹bufè¿›è¡Œutf8è§£ç 
    fmt.Printf("å­—èŠ‚åºåˆ—è§£ç åçš„unicodeå­—ç¬¦æ˜¯ï¼š%s\n", string(r))
}
```

### 13.3 Goå­—ç¬¦ä¸²ç±»å‹çš„å†…éƒ¨è¡¨ç¤º

Goå­—ç¬¦ä¸²ç±»å‹çš„ä¼˜ç§€çš„æ€§è´¨ï¼Œä¸å…¶åœ¨**ç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶ä¸­çš„å†…éƒ¨è¡¨ç¤º**æ˜¯åˆ†ä¸å¼€çš„ã€‚

```go
// $GOROOT/src/reflect/value.go

// StringHeaderæ˜¯ä¸€ä¸ªstringçš„è¿è¡Œæ—¶è¡¨ç¤º
type StringHeader struct {
    Data uintptr
    Len  int
}
```

stringç±»å‹å…¶å®æ˜¯ä¸€ä¸ªâ€œæè¿°ç¬¦â€ï¼Œå®ƒæœ¬èº«å¹¶ä¸çœŸæ­£å­˜å‚¨å­—ç¬¦ä¸²æ•°æ®ï¼Œè€Œä»…æ˜¯ç”±ä¸€ä¸ª**æŒ‡å‘åº•å±‚å­˜å‚¨çš„æŒ‡é’ˆå’Œå­—ç¬¦ä¸²çš„é•¿åº¦**å­—æ®µç»„æˆçš„ã€‚

![](images/image-20240708164110090.png)

Goç¼–è¯‘å™¨æŠŠæºç ä¸­çš„stringç±»å‹æ˜ å°„ä¸ºè¿è¡Œæ—¶çš„ä¸€ä¸ª**äºŒå…ƒç»„ï¼ˆData, Lenï¼‰**ï¼ŒçœŸå®çš„å­—ç¬¦ä¸²å€¼æ•°æ®å°±å­˜å‚¨åœ¨ä¸€ä¸ªè¢«DataæŒ‡å‘çš„åº•å±‚æ•°ç»„ä¸­ã€‚

```go
// å­—ç¬¦ä¸²å†…éƒ¨è¡¨ç¤º
func str4() {
    var s = "hello"
    hdr := (*reflect.StringHeader)(unsafe.Pointer(&s)) // å°†stringç±»å‹å˜é‡åœ°å€æ˜¾å¼è½¬å‹ä¸ºreflect.StringHeader
    fmt.Printf("0x%x\n", hdr.Data)                     // 0x10a30e0
    p := (*[5]byte)(unsafe.Pointer(hdr.Data))          // è·å–Dataå­—æ®µæ‰€æŒ‡å‘çš„æ•°ç»„çš„æŒ‡é’ˆ
    dumpBytesArray((*p)[:])                            // [h e l l o ]   // è¾“å‡ºåº•å±‚æ•°ç»„çš„å†…å®¹
}
func dumpBytesArray(arr []byte) {
    fmt.Printf("[")
    for _, b := range arr {
        fmt.Printf("%c ", b)
    }
    fmt.Printf("]\n")
}
```

ğŸ”– æ–°ç‰ˆæœ¬reflect.StringHeaderè¿‡æœŸ

### 13.4 Goå­—ç¬¦ä¸²ç±»å‹çš„å¸¸è§æ“ä½œ

#### ä¸‹æ ‡æ“ä½œ

#### å­—ç¬¦è¿­ä»£

å¸¸è§„forè¿­ä»£ä¸for rangeè¿­ä»£

> æ³¨æ„ï¼Œè¿™ä¸¤ç§å½¢å¼çš„è¿­ä»£å¯¹å­—ç¬¦ä¸²è¿›è¡Œæ“ä½œå¾—åˆ°çš„ç»“æœæ˜¯ä¸åŒçš„ã€‚

#### å­—ç¬¦ä¸²è¿æ¥

`+`/`+=`

#### å­—ç¬¦ä¸²æ¯”è¾ƒ

`==`ã€`!=` ã€`>=`ã€`<=`ã€`>` å’Œ `<`

#### å­—ç¬¦ä¸²è½¬æ¢

Goæ”¯æŒå­—ç¬¦ä¸²ä¸å­—èŠ‚åˆ‡ç‰‡ã€å­—ç¬¦ä¸²ä¸runeåˆ‡ç‰‡çš„åŒå‘è½¬æ¢ï¼Œå¹¶ä¸”è¿™ç§è½¬æ¢æ— éœ€è°ƒç”¨ä»»ä½•å‡½æ•°ï¼Œåªéœ€ä½¿ç”¨æ˜¾å¼ç±»å‹è½¬æ¢å°±å¯ä»¥äº†ã€‚

```go
var s string = "ä¸­å›½äºº"

// string -> []rune
rs := []rune(s) 
fmt.Printf("%x\n", rs) // [4e2d 56fd 4eba]

// string -> []byte
bs := []byte(s) 
fmt.Printf("%x\n", bs) // e4b8ade59bbde4baba

// []rune -> string
s1 := string(rs)
fmt.Println(s1) // ä¸­å›½äºº

// []byte -> string
s2 := string(bs)
fmt.Println(s2) // ä¸­å›½äºº
```

### æ€è€ƒé¢˜

> Goæä¾›å¤šç§å­—ç¬¦ä¸²è¿æ¥æœåŠ¡ï¼ŒåŒ…æ‹¬åŸºäº+/+=çš„å­—ç¬¦è¿æ¥ã€åŸºäºstrings.Builderã€strings.Joinã€fmt.Sprintfç­‰å‡½æ•°æ¥è¿›è¡Œå­—ç¬¦ä¸²è¿æ¥æ“ä½œã€‚é‚£ä¹ˆï¼Œå“ªç§è¿æ¥æ–¹å¼æ˜¯æ€§èƒ½æœ€é«˜çš„å‘¢ï¼Ÿ

## 14 å¸¸é‡ï¼šGoåœ¨â€œå¸¸é‡â€è®¾è®¡ä¸Šçš„åˆ›æ–°æœ‰å“ªäº›ï¼Ÿ

Goè¯­è¨€åœ¨å¸¸é‡æ–¹é¢çš„åˆ›æ–°ï¼š

- æ”¯æŒæ— ç±»å‹å¸¸é‡ï¼›
- æ”¯æŒéšå¼è‡ªåŠ¨è½¬å‹ï¼›
- å¯ç”¨äºå®ç°æšä¸¾ã€‚

### å¸¸é‡ä»¥åŠGoåŸç”Ÿæ”¯æŒå¸¸é‡çš„å¥½å¤„

Goè¯­è¨€çš„å¸¸é‡æ˜¯ä¸€ç§**åœ¨æºç ç¼–è¯‘æœŸé—´è¢«åˆ›å»ºçš„è¯­æ³•å…ƒç´ **ã€‚

```go
const Pi float64 = 3.14159265358979323846 // å•è¡Œå¸¸é‡å£°æ˜

// ä»¥constä»£ç å—å½¢å¼å£°æ˜å¸¸é‡
const (
    size int64 = 4096
    i, j, s = 13, 14, "bar" // å•è¡Œå£°æ˜å¤šä¸ªå¸¸é‡
)
```

Goå¸¸é‡çš„ç±»å‹åªå±€é™äºåŸºæœ¬æ•°æ®ç±»å‹ï¼ŒåŒ…æ‹¬**æ•°å€¼ç±»å‹ã€å­—ç¬¦ä¸²ç±»å‹ï¼Œä»¥åŠåªæœ‰ä¸¤ä¸ªå–å€¼ï¼ˆtrueå’Œfalseï¼‰çš„å¸ƒå°”ç±»å‹**ã€‚

> åŸç”Ÿä¸æ”¯æŒå¸¸é‡çš„Cè¯­è¨€
> 
> åœ¨Cè¯­è¨€ä¸­ï¼Œ**å­—é¢å€¼æ‹…è´Ÿç€å¸¸é‡çš„è§’è‰²**ï¼Œå¯ä»¥ä½¿ç”¨æ•°å€¼å‹ã€å­—ç¬¦ä¸²å‹å­—é¢å€¼æ¥åº”å¯¹ä¸åŒåœºåˆå¯¹å¸¸é‡çš„éœ€æ±‚ã€‚
> 
> ä¸ºäº†ä¸è®©è¿™äº›å­—é¢å€¼ä»¥â€œé­”æ•°ï¼ˆMagic Numberï¼‰â€çš„å½¢å¼åˆ†å¸ƒäºæºç å„å¤„ï¼Œæ—©æœŸCè¯­è¨€çš„å¸¸ç”¨å®è·µæ˜¯ä½¿ç”¨**å®ï¼ˆmacroï¼‰**å®šä¹‰è®°å·æ¥æŒ‡ä»£è¿™äº›å­—é¢å€¼ï¼Œè¿™ç§å®šä¹‰æ–¹å¼è¢«ç§°ä¸º**å®å®šä¹‰å¸¸é‡**ï¼Œæ¯”å¦‚ï¼š
> 
> ```c
> #define FILE_MAX_LEN 0x22334455
> #define PI 3.1415926
> #define GO_GREETING "Hello, Gopher"
> #define A_CHAR 'a'
> ```
> 
> **å®å®šä¹‰çš„å¸¸é‡ä¼šæœ‰å¾ˆå¤šé—®é¢˜**ã€‚æ¯”å¦‚ï¼Œå®ƒæ˜¯ä¸€ç§ä»…åœ¨é¢„ç¼–è¯‘é˜¶æ®µè¿›è¡Œæ›¿æ¢çš„å­—é¢å€¼ï¼Œç»§æ‰¿äº†å®æ›¿æ¢çš„å¤æ‚æ€§å’Œæ˜“é”™æ€§ï¼Œè€Œä¸”è¿˜æœ‰ç±»å‹ä¸å®‰å…¨ã€æ— æ³•åœ¨è°ƒè¯•æ—¶é€šè¿‡å®åå­—è¾“å‡ºå¸¸é‡çš„å€¼ï¼Œç­‰ç­‰é—®é¢˜ã€‚
> 
> åç»­Cæ ‡å‡†ä¸­æä¾›çš„constå…³é”®å­—ä¿®é¥°çš„æ ‡è¯†ç¬¦ï¼Œä¹Ÿä¾ç„¶ä¸æ˜¯ä¸€ç§åœ†æ»¡æ–¹æ¡ˆã€‚å› ä¸ºconstå…³é”®å­—ä¿®é¥°çš„æ ‡è¯†ç¬¦æœ¬è´¨ä¸Šä¾æ—§æ˜¯å˜é‡ï¼Œå®ƒç”šè‡³æ— æ³•ç”¨ä½œæ•°ç»„å˜é‡å£°æ˜ä¸­çš„åˆå§‹é•¿åº¦ï¼ˆé™¤éç”¨GNUæ‰©å±•Cï¼‰ã€‚
> 
> ```c
> const int size = 5;
> int a[size] = {1,2,3,4,5}; // sizeæœ¬è´¨ä¸æ˜¯å¸¸é‡ï¼Œè¿™å°†å¯¼è‡´ç¼–è¯‘å™¨é”™è¯¯ 
> ```

### æ— ç±»å‹å¸¸é‡

Goè¯­è¨€å¯¹ç±»å‹å®‰å…¨æ˜¯æœ‰ä¸¥æ ¼è¦æ±‚çš„ï¼š**å³ä¾¿ä¸¤ä¸ªç±»å‹æ‹¥æœ‰ç€ç›¸åŒçš„åº•å±‚ç±»å‹ï¼Œä½†å®ƒä»¬ä»ç„¶æ˜¯ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œä¸å¯ä»¥è¢«ç›¸äº’æ¯”è¾ƒæˆ–æ··åœ¨ä¸€ä¸ªè¡¨è¾¾å¼ä¸­è¿›è¡Œè¿ç®—**ã€‚

è¿™ä¸€è¦æ±‚ä¸ä»…ä»…é€‚ç”¨äºå˜é‡ï¼Œä¹ŸåŒæ ·é€‚ç”¨äºæœ‰ç±»å‹å¸¸é‡ï¼ˆTyped Constantï¼‰ã€‚

```go
type myInt int
const n myInt = 13
const m int = n + 5 // ç¼–è¯‘å™¨æŠ¥é”™ï¼šcannot use n + 5 (type myInt) as type int in const initializer

func main() {
    var a int = 5
    fmt.Println(a + n) // ç¼–è¯‘å™¨æŠ¥é”™ï¼šinvalid operation: a + n (mismatched types int and myInt)
}
```

è€Œä¸”ï¼Œ**æœ‰ç±»å‹å¸¸é‡ä¸å˜é‡æ··åˆåœ¨ä¸€èµ·è¿›è¡Œè¿ç®—æ±‚å€¼çš„æ—¶å€™ï¼Œä¹Ÿå¿…é¡»éµå®ˆç±»å‹ç›¸åŒè¿™ä¸€è¦æ±‚**ï¼Œå¦åˆ™æˆ‘ä»¬åªèƒ½é€šè¿‡æ˜¾å¼è½¬å‹æ‰èƒ½è®©ä¸Šé¢ä»£ç æ­£å¸¸å·¥ä½œï¼š

```go
type myInt int
const n myInt = 13
const m int = int(n) + 5  // OK

func main() {
    var a int = 5
    fmt.Println(a + int(n))  // è¾“å‡ºï¼š18
}
```

ä¹Ÿå¯ä»¥ä½¿ç”¨Goä¸­çš„==æ— ç±»å‹å¸¸é‡ï¼ˆUntyped Constantï¼‰==æ¥å®ç°ï¼š

```go
type myInt int
const n = 13

func main() {
    var a myInt = 5
    fmt.Println(a + n)  // è¾“å‡ºï¼š18
} 
```

å¸¸é‡nçš„é»˜è®¤ç±»å‹intä¸myIntå¹¶ä¸æ˜¯åŒä¸€ä¸ªç±»å‹å•Šï¼Œä¸ºä»€ä¹ˆå¯ä»¥æ”¾åœ¨ä¸€ä¸ªè¡¨è¾¾å¼ä¸­è®¡ç®—è€Œæ²¡æœ‰æŠ¥ç¼–è¯‘é”™è¯¯å‘¢ï¼Ÿ

### éšå¼è½¬å‹

å¯¹äºæ— ç±»å‹å¸¸é‡å‚ä¸çš„è¡¨è¾¾å¼æ±‚å€¼ï¼ŒGoç¼–è¯‘å™¨ä¼šæ ¹æ®ä¸Šä¸‹æ–‡ä¸­çš„ç±»å‹ä¿¡æ¯ï¼ŒæŠŠæ— ç±»å‹å¸¸é‡è‡ªåŠ¨è½¬æ¢ä¸ºç›¸åº”çš„ç±»å‹åï¼Œå†å‚ä¸æ±‚å€¼è®¡ç®—ï¼Œè¿™ä¸€è½¬å‹åŠ¨ä½œæ˜¯éšå¼è¿›è¡Œçš„ã€‚

ä½†ç”±äºè½¬å‹çš„å¯¹è±¡æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œæ‰€ä»¥è¿™å¹¶ä¸ä¼šå¼•å‘ç±»å‹å®‰å…¨é—®é¢˜ï¼ŒGoç¼–è¯‘å™¨ä¼šä¿è¯è¿™ä¸€è½¬å‹çš„å®‰å…¨æ€§ã€‚

å¦‚æœGoç¼–è¯‘å™¨åœ¨åšéšå¼è½¬å‹æ—¶ï¼Œå‘ç°æ— æ³•å°†å¸¸é‡è½¬æ¢ä¸ºç›®æ ‡ç±»å‹ï¼ŒGoç¼–è¯‘å™¨ä¹Ÿä¼šæŠ¥é”™ï¼š

```go
const m = 1333333333

var k int8 = 1
j := k + m // ç¼–è¯‘å™¨æŠ¥é”™ï¼šconstant 1333333333 overflows int8 
```

### å®ç°æšä¸¾

Goè¯­è¨€å…¶å®å¹¶æ²¡æœ‰åŸç”Ÿæä¾›æšä¸¾ç±»å‹ã€‚

Goè¯­è¨€ä¸­ï¼Œå¯ä»¥ä½¿ç”¨**constä»£ç å—**å®šä¹‰çš„å¸¸é‡é›†åˆï¼Œæ¥å®ç°æšä¸¾ã€‚è¿™æ˜¯å› ä¸ºæšä¸¾ç±»å‹æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªç”±**æœ‰é™æ•°é‡å¸¸é‡**æ‰€æ„æˆçš„é›†åˆã€‚

Goå°†Cè¯­è¨€æšä¸¾ç±»å‹çš„è¿™ç§åŸºäºå‰ä¸€ä¸ªæšä¸¾å€¼åŠ 1çš„ç‰¹æ€§ï¼Œåˆ†è§£æˆäº†Goä¸­çš„ä¸¤ä¸ªç‰¹æ€§ï¼š**è‡ªåŠ¨é‡å¤ä¸Šä¸€è¡Œï¼Œä»¥åŠå¼•å…¥constå—ä¸­çš„è¡Œåç§»é‡æŒ‡ç¤ºå™¨`iota`**ï¼Œè¿™æ ·å®ƒä»¬å°±å¯ä»¥åˆ†åˆ«ç‹¬ç«‹ä½¿ç”¨äº†ã€‚

- Goçš„constè¯­æ³•æä¾›äº†â€œéšå¼é‡å¤å‰ä¸€ä¸ªéç©ºè¡¨è¾¾å¼â€çš„æœºåˆ¶

```go
const (
  Apple, Banana = 11, 22
  Strawberry, Grape 
  Pear, Watermelon 
)
```

è¿™é‡Œå¸¸é‡å®šä¹‰çš„åä¸¤è¡Œå¹¶æ²¡æœ‰è¢«æ˜¾å¼åœ°èµ‹äºˆåˆå§‹å€¼ï¼Œæ‰€ä»¥Goç¼–è¯‘å™¨å°±ä¸ºå®ƒä»¬è‡ªåŠ¨ä½¿ç”¨ä¸Šä¸€è¡Œçš„è¡¨è¾¾å¼ï¼Œä¹Ÿå°±è·å¾—äº†ä¸‹é¢è¿™ä¸ªç­‰ä»·çš„ä»£ç ï¼š

```go
const (
  Apple, Banana = 11, 22
  Strawberry, Grape  = 11, 22 // ä½¿ç”¨ä¸Šä¸€è¡Œçš„åˆå§‹åŒ–è¡¨è¾¾å¼
  Pear, Watermelon  = 11, 22 // ä½¿ç”¨ä¸Šä¸€è¡Œçš„åˆå§‹åŒ–è¡¨è¾¾å¼
) 
```

- `iota`

iotaæ˜¯Goè¯­è¨€çš„ä¸€ä¸ª==é¢„å®šä¹‰æ ‡è¯†ç¬¦==ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯constå£°æ˜å—ï¼ˆåŒ…æ‹¬å•è¡Œå£°æ˜ï¼‰ä¸­ï¼Œæ¯ä¸ªå¸¸é‡æ‰€å¤„ä½ç½®åœ¨å—ä¸­çš„**åç§»å€¼**ï¼ˆä»é›¶å¼€å§‹ï¼‰ã€‚

åŒæ—¶ï¼Œæ¯ä¸€è¡Œä¸­çš„iotaè‡ªèº«ä¹Ÿæ˜¯ä¸€ä¸ªæ— ç±»å‹å¸¸é‡ï¼Œå¯ä»¥åƒå‰é¢æˆ‘ä»¬æåˆ°çš„æ— ç±»å‹å¸¸é‡é‚£æ ·ï¼Œè‡ªåŠ¨å‚ä¸åˆ°ä¸åŒç±»å‹çš„æ±‚å€¼è¿‡ç¨‹ä¸­æ¥ï¼Œä¸éœ€è¦æˆ‘ä»¬å†å¯¹å®ƒè¿›è¡Œæ˜¾å¼è½¬å‹æ“ä½œã€‚

æ¯”å¦‚Goæ ‡å‡†åº“ä¸­sync/mutex.goä¸­çš„ä¸€æ®µåŸºäºiotaçš„æšä¸¾å¸¸é‡çš„å®šä¹‰ï¼š

```go
// $GOROOT/src/sync/mutex.go 
const ( 
    mutexLocked = 1 << iota
    mutexWoken
    mutexStarving
    mutexWaiterShift = iota
    starvationThresholdNs = 1e6
)
```

- é¦–å…ˆï¼Œè¿™ä¸ªconstå£°æ˜å—çš„ç¬¬ä¸€è¡Œæ˜¯`mutexLocked = 1 << iota` ï¼Œiotaçš„å€¼æ˜¯è¿™è¡Œåœ¨constå—ä¸­çš„åç§»ï¼Œå› æ­¤iotaçš„å€¼ä¸º0ï¼Œå¾—åˆ°`mutexLocked`è¿™ä¸ªå¸¸é‡çš„å€¼ä¸º`1 << 0`ï¼Œä¹Ÿå°±æ˜¯1ã€‚

- æ¥ç€ï¼Œç¬¬äºŒè¡Œï¼šmutexWorken ã€‚å› ä¸ºè¿™ä¸ªconstå£°æ˜å—ä¸­å¹¶æ²¡æœ‰æ˜¾å¼çš„å¸¸é‡åˆå§‹åŒ–è¡¨è¾¾å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬æ ¹æ®constå£°æ˜å—é‡Œâ€œ**éšå¼é‡å¤å‰ä¸€ä¸ªéç©ºè¡¨è¾¾å¼**â€çš„æœºåˆ¶ï¼Œè¿™ä¸€è¡Œå°±ç­‰ä»·äºmutexWorken = 1 << iotaã€‚è€Œä¸”ï¼Œåˆå› ä¸ºè¿™ä¸€è¡Œæ˜¯constå—ä¸­çš„ç¬¬äºŒè¡Œï¼Œæ‰€ä»¥å®ƒçš„åç§»é‡iotaçš„å€¼ä¸º1ï¼Œæˆ‘ä»¬å¾—åˆ°mutexWorkenè¿™ä¸ªå¸¸é‡çš„å€¼ä¸º1 << 1ï¼Œä¹Ÿå°±æ˜¯2ã€‚

- ç„¶åæ˜¯mutexStarvingã€‚è¿™ä¸ªå¸¸é‡åŒmutexWorkenä¸€æ ·ï¼Œè¿™ä¸€è¡Œç­‰ä»·äºmutexStarving = 1 << iotaã€‚è€Œä¸”ï¼Œä¹Ÿå› ä¸ºè¿™è¡Œçš„iotaçš„å€¼ä¸º2ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°mutexStarvingè¿™ä¸ªå¸¸é‡çš„å€¼ä¸º 1 << 2ï¼Œä¹Ÿå°±æ˜¯4;

- å†ç„¶åçœ‹mutexWaiterShift = iota è¿™ä¸€è¡Œï¼Œè¿™ä¸€è¡Œä¸ºå¸¸é‡mutexWaiterShiftåšäº†æ˜¾å¼åˆå§‹åŒ–ï¼Œè¿™æ ·å°±ä¸ç”¨å†é‡å¤å‰ä¸€è¡Œäº†ã€‚ç”±äºè¿™ä¸€è¡Œæ˜¯ç¬¬å››è¡Œï¼Œè€Œä¸”ä½œä¸ºè¡Œåç§»å€¼çš„iotaçš„å€¼ä¸º3ï¼Œå› æ­¤mutexWaiterShiftçš„å€¼å°±ä¸º3ã€‚

- æœ€åä¸€è¡Œï¼Œä»£ç ä¸­ç›´æ¥ç”¨äº†ä¸€ä¸ªå…·ä½“å€¼1e6ç»™å¸¸é‡starvationThresholdNsè¿›è¡Œäº†èµ‹å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªå¸¸é‡å€¼å°±æ˜¯1e6æœ¬èº«äº†ã€‚

> æé†’:ä½äºåŒä¸€è¡Œçš„iotaå³ä¾¿å‡ºç°å¤šæ¬¡ï¼Œå¤šä¸ªiotaçš„å€¼ä¹Ÿæ˜¯ä¸€æ ·çš„.
> 
> ```go
> const (
>   Apple, Banana = iota, iota + 10 // 0, 10 (iota = 0)
>   Strawberry, Grape // 1, 11 (iota = 1)
>   Pear, Watermelon  // 2, 12 (iota = 2)
> )
> ```

```go
// $GOROOT/src/syscall/net_js.go
const (
    _ = iota
    IPV6_V6ONLY  // 1
    SOMAXCONN    // 2
    SO_ERROR     // 3
)
```

æšä¸¾å¸¸é‡å€¼å¹¶ä¸è¿ç»­æ—¶ï¼Œä¹Ÿå¯ä»¥å€ŸåŠ©ç©ºç™½æ ‡è¯†ç¬¦æ¥å®ç°ï¼š

```go
const (
  _ = iota // 0
  Pin1
  Pin2
  Pin3
  _
  Pin5    // 5   
) 
```

iotaç‰¹æ€§è®©**ç»´æŠ¤æšä¸¾å¸¸é‡åˆ—è¡¨å˜å¾—æ›´åŠ å®¹æ˜“**ã€‚

æ¯”å¦‚ä½¿ç”¨ä¼ ç»Ÿçš„æšä¸¾å¸¸é‡å£°æ˜æ–¹å¼ï¼Œæ¥å£°æ˜ä¸€ç»„æŒ‰é¦–å­—æ¯æ’åºçš„â€œé¢œè‰²â€å¸¸é‡ï¼š

```go
const ( 
  Black  = 1 
  Red    = 2
  Yellow = 3
)
```

è¦å¢åŠ ä¸€ä¸ªæ–°é¢œè‰²Blue:

```go
const (
  Blue   = 1
  Black  = 2
  Red    = 3
  Yellow = 4
)
```

ä½¿ç”¨iotaé‡æ–°å®šä¹‰:

```go
const (
  _ = iota     
  Blue
  black
  Red 
  Yellow     
) 
```

è¿™æ ·ï¼Œæ— è®ºåæœŸæˆ‘ä»¬éœ€è¦å¢åŠ å¤šå°‘ç§é¢œè‰²ï¼Œåªéœ€å°†å¸¸é‡åæ’å…¥åˆ°å¯¹åº”ä½ç½®å°±å¯ä»¥ï¼Œå…¶ä»–å°±ä¸éœ€è¦å†åšä»»ä½•æ‰‹å·¥è°ƒæ•´äº†ã€‚

å¦‚æœä¸€ä¸ªGoæºæ–‡ä»¶ä¸­æœ‰å¤šä¸ªconstä»£ç å—å®šä¹‰çš„ä¸åŒæšä¸¾ï¼Œæ¯ä¸ªconstä»£ç å—ä¸­çš„iotaä¹Ÿæ˜¯ç‹¬ç«‹å˜åŒ–çš„:

```go
const (
  a = iota + 1 // 1, iota = 0
  b            // 2, iota = 1
  c            // 3, iota = 2
)

const (
    i = iota << 1 // 0, iota = 0
    j             // 2, iota = 1
    k             // 4, iota = 2
)
```

### æ€è€ƒé¢˜

> è™½ç„¶iotaå¸¦æ¥äº†çµæ´»æ€§ä¸ä¾¿åˆ©ï¼Œä½†æ˜¯å¦å­˜åœ¨ä¸€äº›åœºåˆï¼Œåœ¨å®šä¹‰æšä¸¾å¸¸é‡æ—¶ä½¿ç”¨æ˜¾å¼å­—é¢å€¼æ›´ä¸ºé€‚åˆå‘¢ï¼Ÿ

## 15 åŒæ„å¤åˆç±»å‹ï¼šä»å®šé•¿æ•°ç»„åˆ°å˜é•¿åˆ‡ç‰‡

==å¤åˆç±»å‹==ï¼šç”±å¤šä¸ª**åŒæ„ç±»å‹ï¼ˆç›¸åŒç±»å‹ï¼‰**æˆ–**å¼‚æ„ç±»å‹ï¼ˆä¸åŒç±»å‹ï¼‰**çš„å…ƒç´ çš„å€¼ç»„åˆè€Œæˆã€‚

GoåŸç”Ÿå†…ç½®äº†å¤šç§å¤åˆæ•°æ®ç±»å‹ï¼ŒåŒ…æ‹¬**æ•°ç»„ã€åˆ‡ç‰‡ï¼ˆsliceï¼‰ã€mapã€ç»“æ„ä½“ï¼Œä»¥åŠchannel**ç­‰ã€‚

### 15.1 æ•°ç»„æœ‰å“ªäº›åŸºæœ¬ç‰¹æ€§ï¼Ÿ

Goè¯­è¨€çš„æ•°ç»„æ˜¯ä¸€ä¸ªé•¿åº¦å›ºå®šçš„ã€ç”±åŒæ„ç±»å‹å…ƒç´ ç»„æˆçš„è¿ç»­åºåˆ—ã€‚

ä¸¤ä¸ªé‡è¦å±æ€§ï¼š==å…ƒç´ çš„ç±»å‹==å’Œ==æ•°ç»„é•¿åº¦==ã€‚

```go
var arr [N]T
```

æ•°ç»„å…ƒç´ çš„ç±»å‹å¯ä»¥ä¸º**ä»»æ„çš„GoåŸç”Ÿç±»å‹æˆ–è‡ªå®šä¹‰ç±»å‹**ã€‚

å¦‚æœä¸¤ä¸ªæ•°ç»„ç±»å‹çš„å…ƒç´ ç±»å‹Tä¸æ•°ç»„é•¿åº¦Néƒ½æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ª**æ•°ç»„ç±»å‹æ˜¯ç­‰ä»·**çš„ï¼Œå¦‚æœæœ‰ä¸€ä¸ªå±æ€§ä¸åŒï¼Œå®ƒä»¬å°±æ˜¯ä¸¤ä¸ªä¸åŒçš„æ•°ç»„ç±»å‹ã€‚

**æ•°ç»„ç±»å‹ä¸ä»…æ˜¯é€»è¾‘ä¸Šçš„è¿ç»­åºåˆ—ï¼Œè€Œä¸”åœ¨å®é™…å†…å­˜åˆ†é…æ—¶ä¹Ÿå æ®ç€ä¸€æ•´å—å†…å­˜**ã€‚

![](images/image-20240708185652161.png)

é¢„å®šä¹‰å‡½æ•°`len`å¯ä»¥ç”¨äºè·å–ä¸€ä¸ªæ•°ç»„ç±»å‹å˜é‡çš„é•¿åº¦ï¼Œé€šè¿‡unsafeåŒ…æä¾›çš„`Sizeof`å‡½æ•°å¯ä»¥è·å¾—ä¸€ä¸ªæ•°ç»„å˜é‡çš„æ€»å¤§å°ï¼š

```go
var arr = [6]int{1, 2, 3, 4, 5, 6}
fmt.Println("æ•°ç»„é•¿åº¦ï¼š", len(arr))           // 6
fmt.Println("æ•°ç»„å¤§å°ï¼š", unsafe.Sizeof(arr)) // 48 
```

æ•°ç»„å¤§å°å°±æ˜¯æ‰€æœ‰å…ƒç´ çš„å¤§å°ä¹‹å’Œã€‚

å£°æ˜ä¸€ä¸ªæ•°ç»„ç±»å‹å˜é‡ï¼Œå¦‚æœä¸è¿›è¡Œæ˜¾å¼åˆå§‹åŒ–ï¼Œé‚£ä¹ˆæ•°ç»„ä¸­çš„å…ƒç´ å€¼å°±æ˜¯å®ƒç±»å‹çš„é›¶å€¼ã€‚

```go
var arr1 [6]int // [0 0 0 0 0 0]
```

æ˜¾ç¤ºåˆå§‹åŒ–ï¼š

```go
var arr2 = [6]int {
  11, 12, 13, 14, 15, 16,
} // [11 12 13 14 15 16]

var arr3 = [...]int {
    21, 22, 23,
} // [21 22 23]
fmt.Printf("%T\n", arr3) // [3]int
```

å¯ä»¥å¿½ç•¥æ‰å³å€¼åˆå§‹åŒ–è¡¨è¾¾å¼ä¸­æ•°ç»„ç±»å‹çš„é•¿åº¦ï¼Œç”¨â€œ`â€¦`â€æ›¿ä»£ï¼ŒGoç¼–è¯‘å™¨ä¼šæ ¹æ®æ•°ç»„å…ƒç´ çš„ä¸ªæ•°ï¼Œè‡ªåŠ¨è®¡ç®—å‡ºæ•°ç»„é•¿åº¦ã€‚

å¯¹ä¸€ä¸ªé•¿åº¦è¾ƒå¤§çš„ç¨€ç–æ•°ç»„è¿›è¡Œæ˜¾å¼åˆå§‹åŒ–ï¼š

```go
var arr4 = [...]int{
  99: 39, // å°†ç¬¬100ä¸ªå…ƒç´ (ä¸‹æ ‡å€¼ä¸º99)çš„å€¼èµ‹å€¼ä¸º39ï¼Œå…¶ä½™å…ƒç´ å€¼å‡ä¸º0
}
fmt.Printf("%T\n", arr4) // [100]int
```

### 15.2 å¤šç»´æ•°ç»„

```go
var mArr [2][3][4]int
```

![](images/image-20240704072318759.png)

æ•°ç»„ç±»å‹å˜é‡æ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œè¿™å°±æ„å‘³ç€**ä¸€ä¸ªæ•°ç»„å˜é‡è¡¨ç¤ºçš„æ˜¯æ•´ä¸ªæ•°ç»„**ã€‚è¿™ç‚¹ä¸Cè¯­è¨€å®Œå…¨ä¸åŒï¼Œåœ¨Cè¯­è¨€ä¸­ï¼Œ**æ•°ç»„å˜é‡å¯è§†ä¸ºæŒ‡å‘æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆ**ã€‚

è¿™æ ·ä¸€æ¥ï¼Œæ— è®ºæ˜¯å‚ä¸è¿­ä»£ï¼Œè¿˜æ˜¯ä½œä¸ºå®é™…å‚æ•°ä¼ ç»™ä¸€ä¸ªå‡½æ•°/æ–¹æ³•ï¼ŒGoä¼ é€’æ•°ç»„çš„æ–¹å¼éƒ½æ˜¯çº¯ç²¹çš„**å€¼æ‹·è´**ï¼Œè¿™ä¼šå¸¦æ¥è¾ƒå¤§çš„å†…å­˜æ‹·è´å¼€é”€ã€‚è§£å†³åŠæ³•ï¼šæŒ‡é’ˆæˆ–åˆ‡ç‰‡ã€‚

### 15.3 åˆ‡ç‰‡â¤ï¸

æ•°ç»„ä¸¤ç‚¹ä¸è¶³ï¼š**å›ºå®šçš„å…ƒç´ ä¸ªæ•°ï¼Œä»¥åŠä¼ å€¼æœºåˆ¶ä¸‹å¯¼è‡´çš„å¼€é”€è¾ƒå¤§**ã€‚

==åˆ‡ç‰‡ï¼ˆsliceï¼‰==ï¼Œæ¥å¼¥è¡¥æ•°ç»„çš„è¿™ä¸¤å¤„ä¸è¶³ã€‚

åˆ‡ç‰‡çš„å£°æ˜å¹¶åˆå§‹åŒ–ï¼Œç›¸å¯¹äºæ•°ç»„å°‘äº†é•¿åº¦ï¼š

```go
var nums = []int{1,2,3,4,5,6}
```

```go
fmt.Println(len(nums)) // 6

nums = append(nums, 7) // åˆ‡ç‰‡å˜ä¸º[1 2 3 4 5 6 7]
fmt.Println(len(nums)) // 7
```

#### Goæ˜¯å¦‚ä½•å®ç°åˆ‡ç‰‡ç±»å‹çš„ï¼Ÿ

Goåˆ‡ç‰‡åœ¨è¿è¡Œæ—¶å…¶å®æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ç»“æ„:

```go
// runtime/slice.go
type slice struct {
    array unsafe.Pointer
    len   int
    cap   int
}
```

- array: æ˜¯æŒ‡å‘åº•å±‚æ•°ç»„çš„æŒ‡é’ˆï¼›
- len: æ˜¯åˆ‡ç‰‡çš„é•¿åº¦ï¼Œå³åˆ‡ç‰‡ä¸­å½“å‰å…ƒç´ çš„ä¸ªæ•°ï¼›
- cap: æ˜¯åº•å±‚æ•°ç»„çš„é•¿åº¦ï¼Œä¹Ÿæ˜¯åˆ‡ç‰‡çš„æœ€å¤§å®¹é‡ï¼Œcapå€¼æ°¸è¿œå¤§äºç­‰äºlenå€¼ã€‚

![](images/image-20240704073320719.png)

**Goç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªæ–°åˆ›å»ºçš„åˆ‡ç‰‡**ï¼Œå»ºç«‹ä¸€ä¸ªåº•å±‚æ•°ç»„ï¼Œé»˜è®¤åº•å±‚æ•°ç»„çš„é•¿åº¦ä¸åˆ‡ç‰‡åˆå§‹å…ƒç´ ä¸ªæ•°ç›¸åŒã€‚

åˆ›å»ºåˆ‡ç‰‡çš„å…¶ä»–æ–¹å¼ï¼š

- æ–¹æ³•ä¸€ï¼šé€šè¿‡`make`å‡½æ•°æ¥åˆ›å»ºåˆ‡ç‰‡ï¼Œå¹¶æŒ‡**å®šåº•å±‚æ•°ç»„çš„é•¿åº¦**ã€‚

```go
sl := make([]byte, 6, 10) // å…¶ä¸­10ä¸ºcapå€¼ï¼Œå³åº•å±‚æ•°ç»„é•¿åº¦ï¼Œ6ä¸ºåˆ‡ç‰‡çš„åˆå§‹é•¿åº¦

sl := make([]byte, 6) // cap = len = 6
```

- æ–¹æ³•äºŒï¼šé‡‡ç”¨`array[low : high : max]`è¯­æ³•åŸºäºä¸€ä¸ªå·²å­˜åœ¨çš„æ•°ç»„åˆ›å»ºåˆ‡ç‰‡ã€‚è¿™ç§æ–¹å¼è¢«ç§°ä¸º==æ•°ç»„çš„åˆ‡ç‰‡åŒ–==

```go
arr := [10]int{1, 2, 3, 4, 5, 6, 7, 8, 9, 10}
sl := arr[3:7:9]
```

![](images/image-20240704074015623.png)

åŸºäºæ•°ç»„åˆ›å»ºçš„åˆ‡ç‰‡ï¼Œå®ƒçš„èµ·å§‹å…ƒç´ ä»lowæ‰€æ ‡è¯†çš„ä¸‹æ ‡å€¼å¼€å§‹ï¼Œåˆ‡ç‰‡çš„é•¿åº¦ï¼ˆlenï¼‰æ˜¯high - lowï¼Œå®ƒçš„å®¹é‡æ˜¯max - lowã€‚è€Œä¸”ï¼Œç”±äºåˆ‡ç‰‡slçš„åº•å±‚æ•°ç»„å°±æ˜¯æ•°ç»„arrï¼Œå¯¹åˆ‡ç‰‡slä¸­å…ƒç´ çš„ä¿®æ”¹å°†ç›´æ¥å½±å“æ•°ç»„arrå˜é‡ã€‚æ¯”å¦‚ï¼Œå¦‚æœæˆ‘ä»¬å°†åˆ‡ç‰‡çš„ç¬¬ä¸€ä¸ªå…ƒç´ åŠ 10ï¼Œé‚£ä¹ˆæ•°ç»„arrçš„ç¬¬å››ä¸ªå…ƒç´ å°†å˜ä¸º14ï¼š

```go
sl[0] += 10
fmt.Println("arr[3] =", arr[3]) // 14
```

è¿™æ ·çœ‹æ¥ï¼Œ**åˆ‡ç‰‡å¥½æ¯”æ‰“å¼€äº†ä¸€ä¸ªè®¿é—®ä¸ä¿®æ”¹æ•°ç»„çš„â€œçª—å£â€**ï¼Œé€šè¿‡è¿™ä¸ªçª—å£ï¼Œå¯ä»¥ç›´æ¥æ“ä½œåº•å±‚æ•°ç»„ä¸­çš„**éƒ¨åˆ†å…ƒç´ **ã€‚è¿™æœ‰äº›ç±»ä¼¼äºæ“ä½œæ–‡ä»¶ä¹‹å‰æ‰“å¼€çš„â€œ**æ–‡ä»¶æè¿°ç¬¦**â€ï¼ˆWindowsä¸Šç§°ä¸º**å¥æŸ„**ï¼‰ï¼Œé€šè¿‡æ–‡ä»¶æè¿°ç¬¦æˆ‘ä»¬å¯ä»¥å¯¹åº•å±‚çš„çœŸå®æ–‡ä»¶è¿›è¡Œç›¸å…³æ“ä½œã€‚å¯ä»¥è¯´ï¼Œ**åˆ‡ç‰‡ä¹‹äºæ•°ç»„å°±åƒæ˜¯æ–‡ä»¶æè¿°ç¬¦ä¹‹äºæ–‡ä»¶**ã€‚

åœ¨Goè¯­è¨€ä¸­ï¼Œæ•°ç»„æ›´å¤šæ˜¯â€œé€€å±…å¹•åâ€ï¼Œæ‰¿æ‹…çš„æ˜¯**åº•å±‚å­˜å‚¨ç©ºé—´**çš„è§’è‰²ã€‚åˆ‡ç‰‡å°±æ˜¯æ•°ç»„çš„â€œæè¿°ç¬¦â€ï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºè¿™ä¸€ç‰¹æ€§ï¼Œåˆ‡ç‰‡æ‰èƒ½åœ¨å‡½æ•°å‚æ•°ä¼ é€’æ—¶**é¿å…è¾ƒå¤§æ€§èƒ½å¼€é”€**ã€‚å› ä¸ºä¼ é€’çš„å¹¶ä¸æ˜¯æ•°ç»„æœ¬èº«ï¼Œè€Œæ˜¯æ•°ç»„çš„â€œæè¿°ç¬¦â€ï¼Œè€Œè¿™ä¸ª**æè¿°ç¬¦çš„å¤§å°æ˜¯å›ºå®šçš„**ï¼ˆè§ä¸Šé¢çš„ä¸‰å…ƒç»„ç»“æ„ï¼‰ï¼Œæ— è®ºåº•å±‚çš„æ•°ç»„æœ‰å¤šå¤§ï¼Œåˆ‡ç‰‡æ‰“å¼€çš„â€œçª—å£â€é•¿åº¦æœ‰å¤šé•¿ï¼Œå®ƒéƒ½æ˜¯ä¸å˜çš„ã€‚æ­¤å¤–ï¼Œåœ¨è¿›è¡Œæ•°ç»„åˆ‡ç‰‡åŒ–çš„æ—¶å€™ï¼Œé€šå¸¸çœç•¥maxï¼Œè€Œmaxçš„é»˜è®¤å€¼ä¸ºæ•°ç»„çš„é•¿åº¦ã€‚

å¦å¤–ï¼Œé’ˆå¯¹ä¸€ä¸ªå·²å­˜åœ¨çš„æ•°ç»„ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å»ºç«‹å¤šä¸ªæ“ä½œæ•°ç»„çš„åˆ‡ç‰‡ï¼Œè¿™äº›åˆ‡ç‰‡å…±äº«åŒä¸€åº•å±‚æ•°ç»„ï¼Œåˆ‡ç‰‡å¯¹åº•å±‚æ•°ç»„çš„æ“ä½œä¹ŸåŒæ ·ä¼š**åæ˜ åˆ°å…¶ä»–åˆ‡ç‰‡ä¸­**ã€‚

![](images/image-20240704074617178.png)

- æ–¹æ³•ä¸‰ï¼šåŸºäºåˆ‡ç‰‡åˆ›å»ºåˆ‡ç‰‡ã€‚

è¿™ç§åˆ‡ç‰‡çš„è¿è¡Œæ—¶è¡¨ç¤ºåŸç†ä¸ä¸Šé¢çš„æ˜¯ä¸€æ ·çš„ã€‚

#### åˆ‡ç‰‡çš„åŠ¨æ€æ‰©å®¹

â€œåŠ¨æ€æ‰©å®¹â€æŒ‡å½“é€šè¿‡`append`æ“ä½œå‘åˆ‡ç‰‡è¿½åŠ æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœè¿™æ—¶åˆ‡ç‰‡çš„lenå€¼å’Œcapå€¼æ˜¯ç›¸ç­‰çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åˆ‡ç‰‡**åº•å±‚æ•°ç»„å·²ç»æ²¡æœ‰ç©ºé—²ç©ºé—´**å†æ¥å­˜å‚¨è¿½åŠ çš„å€¼äº†ï¼ŒGoè¿è¡Œæ—¶å°±ä¼šå¯¹è¿™ä¸ªåˆ‡ç‰‡åšæ‰©å®¹æ“ä½œï¼Œæ¥ä¿è¯åˆ‡ç‰‡å§‹ç»ˆèƒ½å­˜å‚¨ä¸‹è¿½åŠ çš„æ–°å€¼ã€‚ä¹Ÿå°±æ˜¯ä¼šé‡æ–°åˆ†é…äº†å…¶åº•å±‚æ•°ç»„ã€‚

```go
var s []int
s = append(s, 11) 
fmt.Println(len(s), cap(s)) //1 1
s = append(s, 12) 
fmt.Println(len(s), cap(s)) //2 2
s = append(s, 13) 
fmt.Println(len(s), cap(s)) //3 4
s = append(s, 14) 
fmt.Println(len(s), cap(s)) //4 4
s = append(s, 15) 
fmt.Println(len(s), cap(s)) //5 8
```

- æœ€å¼€å§‹ï¼Œsåˆå€¼ä¸ºé›¶å€¼ï¼ˆnilï¼‰ï¼Œè¿™ä¸ªæ—¶å€™sæ²¡æœ‰â€œç»‘å®šâ€åº•å±‚æ•°ç»„ã€‚å…ˆé€šè¿‡appendæ“ä½œå‘åˆ‡ç‰‡sæ·»åŠ ä¸€ä¸ªå…ƒç´ 11ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œappendä¼šå…ˆåˆ†é…åº•å±‚æ•°ç»„u1ï¼ˆæ•°ç»„é•¿åº¦1ï¼‰ï¼Œç„¶åå°†så†…éƒ¨è¡¨ç¤ºä¸­çš„arrayæŒ‡å‘u1ï¼Œå¹¶è®¾ç½®len = 1, cap = 1;
- æ¥ç€ï¼Œæˆ‘ä»¬é€šè¿‡appendæ“ä½œå‘åˆ‡ç‰‡så†æ·»åŠ ç¬¬äºŒä¸ªå…ƒç´ 12ï¼Œè¿™ä¸ªæ—¶å€™len(s) = 1ï¼Œcap(s) = 1ï¼Œappendåˆ¤æ–­åº•å±‚æ•°ç»„å‰©ä½™ç©ºé—´å·²ç»ä¸èƒ½å¤Ÿæ»¡è¶³æ·»åŠ æ–°å…ƒç´ çš„è¦æ±‚äº†ï¼Œäºæ˜¯å®ƒå°±åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„åº•å±‚æ•°ç»„u2ï¼Œé•¿åº¦ä¸º2ï¼ˆu1æ•°ç»„é•¿åº¦çš„2å€ï¼‰ï¼Œå¹¶æŠŠu1ä¸­çš„å…ƒç´ æ‹·è´åˆ°u2ä¸­ï¼Œæœ€åå°†så†…éƒ¨è¡¨ç¤ºä¸­çš„arrayæŒ‡å‘u2ï¼Œå¹¶è®¾ç½®len = 2, cap = 2ï¼›
- ç„¶åï¼Œç¬¬ä¸‰æ­¥ï¼Œæˆ‘ä»¬é€šè¿‡appendæ“ä½œå‘åˆ‡ç‰‡sæ·»åŠ äº†ç¬¬ä¸‰ä¸ªå…ƒç´ 13ï¼Œè¿™æ—¶len(s) = 2ï¼Œcap(s) = 2ï¼Œappendåˆ¤æ–­åº•å±‚æ•°ç»„å‰©ä½™ç©ºé—´ä¸èƒ½æ»¡è¶³æ·»åŠ æ–°å…ƒç´ çš„è¦æ±‚äº†ï¼Œäºæ˜¯åˆåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„åº•å±‚æ•°ç»„u3ï¼Œé•¿åº¦ä¸º4ï¼ˆu2æ•°ç»„é•¿åº¦çš„2å€ï¼‰ï¼Œå¹¶æŠŠu2ä¸­çš„å…ƒç´ æ‹·è´åˆ°u3ä¸­ï¼Œæœ€åæŠŠså†…éƒ¨è¡¨ç¤ºä¸­çš„arrayæŒ‡å‘u3ï¼Œå¹¶è®¾ç½®len = 3, capä¸ºu3æ•°ç»„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯4ï¼›
- ç¬¬å››æ­¥ï¼Œæˆ‘ä»¬ä¾ç„¶é€šè¿‡appendæ“ä½œå‘åˆ‡ç‰‡sæ·»åŠ ç¬¬å››ä¸ªå…ƒç´ 14ï¼Œæ­¤æ—¶len(s) = 3,cap(s) = 4ï¼Œappendåˆ¤æ–­åº•å±‚æ•°ç»„å‰©ä½™ç©ºé—´å¯ä»¥æ»¡è¶³æ·»åŠ æ–°å…ƒç´ çš„è¦æ±‚ï¼Œæ‰€ä»¥å°±æŠŠ14æ”¾åœ¨ä¸‹ä¸€ä¸ªå…ƒç´ çš„ä½ç½®(æ•°ç»„u3æœ«å°¾ï¼‰ï¼Œå¹¶æŠŠså†…éƒ¨è¡¨ç¤ºä¸­çš„lenåŠ 1ï¼Œå˜ä¸º4ï¼›
- ç¬¬äº”æ­¥åˆé€šè¿‡appendæ“ä½œï¼Œå‘åˆ‡ç‰‡sæ·»åŠ æœ€åä¸€ä¸ªå…ƒç´ 15ï¼Œè¿™æ—¶len(s) = 4ï¼Œcap(s) = 4ï¼Œappendåˆ¤æ–­åº•å±‚æ•°ç»„å‰©ä½™ç©ºé—´åˆä¸å¤Ÿäº†ï¼Œäºæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„åº•å±‚æ•°ç»„u4ï¼Œé•¿åº¦ä¸º8ï¼ˆu3æ•°ç»„é•¿åº¦çš„2å€ï¼‰ï¼Œå¹¶å°†u3ä¸­çš„å…ƒç´ æ‹·è´åˆ°u4ä¸­ï¼Œæœ€åå°†så†…éƒ¨è¡¨ç¤ºä¸­çš„arrayæŒ‡å‘u4ï¼Œå¹¶è®¾ç½®len = 5, capä¸ºu4æ•°ç»„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯8ã€‚

æ€»ç»“ï¼Œé’ˆå¯¹å…ƒç´ æ˜¯intå‹çš„æ•°ç»„ï¼Œæ–°æ•°ç»„çš„å®¹é‡æ˜¯å½“å‰æ•°ç»„çš„**==2å€==**ã€‚æ–°æ•°ç»„å»ºç«‹åï¼Œappendä¼šæŠŠæ—§æ•°ç»„ä¸­çš„æ•°æ®æ‹·è´åˆ°æ–°æ•°ç»„ä¸­ï¼Œä¹‹åæ–°æ•°ç»„ä¾¿æˆä¸ºäº†åˆ‡ç‰‡çš„åº•å±‚æ•°ç»„ï¼Œæ—§æ•°ç»„ä¼šè¢«åƒåœ¾å›æ”¶æ‰ã€‚

ä¸è¿‡appendæ“ä½œçš„è¿™ç§è‡ªåŠ¨æ‰©å®¹è¡Œä¸ºï¼Œæœ‰äº›æ—¶å€™ä¼šç»™æˆ‘ä»¬å¼€å‘è€…å¸¦æ¥ä¸€äº›å›°æƒ‘ï¼Œæ¯”å¦‚åŸºäºä¸€ä¸ªå·²æœ‰æ•°ç»„å»ºç«‹çš„åˆ‡ç‰‡ï¼Œä¸€æ—¦è¿½åŠ çš„æ•°æ®æ“ä½œè§¦ç¢°åˆ°åˆ‡ç‰‡çš„å®¹é‡ä¸Šé™ï¼ˆå®è´¨ä¸Šä¹Ÿæ˜¯æ•°ç»„å®¹é‡çš„ä¸Šç•Œ)ï¼Œåˆ‡ç‰‡å°±ä¼šå’ŒåŸæ•°ç»„==è§£é™¤â€œç»‘å®šâ€==ï¼Œåç»­å¯¹åˆ‡ç‰‡çš„ä»»ä½•ä¿®æ”¹éƒ½ä¸ä¼šåæ˜ åˆ°åŸæ•°ç»„ä¸­äº†ã€‚

```go
u := [...]int{11, 12, 13, 14, 15}
fmt.Println("array:", u) // [11, 12, 13, 14, 15]
s := u[1:3]
fmt.Printf("slice(len=%d, cap=%d): %v\n", len(s), cap(s), s) // [12, 13]
s = append(s, 24)
fmt.Println("after append 24, array:", u)
fmt.Printf("after append 24, slice(len=%d, cap=%d): %v\n", len(s), cap(s), s)
s = append(s, 25)
fmt.Println("after append 25, array:", u)
fmt.Printf("after append 25, slice(len=%d, cap=%d): %v\n", len(s), cap(s), s)
s = append(s, 26)
fmt.Println("after append 26, array:", u)
fmt.Printf("after append 26, slice(len=%d, cap=%d): %v\n", len(s), cap(s), s)

s[0] = 22
fmt.Println("after reassign 1st elem of slice, array:", u)
fmt.Printf("after reassign 1st elem of slice, slice(len=%d, cap=%d): %v\n", len(s), cap(s), s)
```

ç»“æœï¼š

```go
array: [11 12 13 14 15]
slice(len=2, cap=4): [12 13]
after append 24, array: [11 12 13 24 15]
after append 24, slice(len=3, cap=4): [12 13 24]
after append 25, array: [11 12 13 24 25]
after append 25, slice(len=4, cap=4): [12 13 24 25]
after append 26, array: [11 12 13 24 25]
after append 26, slice(len=5, cap=8): [12 13 24 25 26]
after reassign 1st elem of slice, array: [11 12 13 24 25]
after reassign 1st elem of slice, slice(len=5, cap=8): [22 13 24 25 26]
```

### æ€è€ƒé¢˜

ä¸‹ä¸‹é¢è¿™ä¸¤ä¸ªåˆ‡ç‰‡å˜é‡sl1ä¸sl2çš„å·®å¼‚:

```go
var sl1 []int
var sl2 = []int{}
```

`sl1` æ˜¯ä¸€ä¸ªæœªåˆå§‹åŒ–çš„åˆ‡ç‰‡ï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªç©ºæ•°ç»„ï¼Œè€Œ `sl2` æ˜¯ä¸€ä¸ªåˆå§‹åŒ–çš„åˆ‡ç‰‡ï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªè™½ç„¶ä¸ºç©ºä½†å®é™…å­˜åœ¨çš„æ•°ç»„ã€‚åœ¨ä½¿ç”¨åˆ‡ç‰‡æ—¶ï¼Œéœ€è¦ç¡®ä¿å…¶ä¸ä¸º `nil`ï¼Œå› ä¸º `nil` åˆ‡ç‰‡æ— æ³•è¢«ç´¢å¼•ï¼Œä¹Ÿä¸èƒ½è¿›è¡Œå…¶ä»–æ“ä½œã€‚

## 16 å¤åˆæ•°æ®ç±»å‹ï¼šåŸç”Ÿmapç±»å‹çš„å®ç°æœºåˆ¶æ˜¯æ€æ ·çš„ï¼Ÿ

map(æ˜ å°„ã€å“ˆå¸Œè¡¨æˆ–å­—å…¸)

mapæ˜¯åˆ‡ç‰‡ä¹‹åï¼Œç¬¬äºŒä¸ªç”±**Goç¼–è¯‘å™¨ä¸è¿è¡Œæ—¶è”åˆå®ç°**çš„å¤åˆæ•°æ®ç±»å‹ï¼Œå®ƒæœ‰ç€**å¤æ‚çš„å†…éƒ¨å®ç°**ï¼Œä½†å´æä¾›äº†ååˆ†ç®€å•å‹å¥½çš„å¼€å‘è€…ä½¿ç”¨æ¥å£ã€‚

### ä»€ä¹ˆæ˜¯mapç±»å‹ï¼Ÿ

```go
map[key_type]value_type
```

```go
map[string]string // keyä¸valueå…ƒç´ çš„ç±»å‹ç›¸åŒ
map[int]string    // keyä¸valueå…ƒç´ çš„ç±»å‹ä¸åŒ
```

å¦‚æœä¸¤ä¸ªmapç±»å‹çš„keyå…ƒç´ ç±»å‹ç›¸åŒï¼Œvalueå…ƒç´ ç±»å‹ä¹Ÿç›¸åŒï¼Œé‚£ä¹ˆå®ƒä»¬æ˜¯**åŒä¸€ä¸ªmapç±»å‹**ï¼Œå¦åˆ™å°±æ˜¯ä¸åŒçš„mapç±»å‹ã€‚

mapç±»å‹å¯¹valueçš„ç±»å‹æ²¡æœ‰é™åˆ¶ï¼Œä½†æ˜¯å¯¹keyçš„ç±»å‹å´æœ‰ä¸¥æ ¼è¦æ±‚ï¼Œå› ä¸ºmapç±»å‹è¦ä¿è¯**keyçš„==å”¯ä¸€æ€§==**ï¼Œ**keyçš„ç±»å‹å¿…é¡»æ”¯æŒâ€œ==â€å’Œâ€œ!=â€ä¸¤ç§æ¯”è¾ƒæ“ä½œç¬¦**ã€‚

åœ¨Goè¯­è¨€ä¸­ï¼Œ**å‡½æ•°ç±»å‹ã€mapç±»å‹è‡ªèº«ï¼Œä»¥åŠåˆ‡ç‰‡**åªæ”¯æŒä¸nilçš„æ¯”è¾ƒï¼Œè€Œä¸æ”¯æŒåŒç±»å‹ä¸¤ä¸ªå˜é‡çš„æ¯”è¾ƒï¼Œä¸èƒ½ä½œä¸ºmapçš„keyç±»å‹çš„ã€‚

```go
s1 := make([]int, 1)
s2 := make([]int, 2)
f1 := func() {}
f2 := func() {}
m1 := make(map[int]string)
m2 := make(map[int]string)
println(s1 == s2) // é”™è¯¯ï¼šinvalid operation: s1 == s2 (slice can only be compared to nil)
println(f1 == f2) // é”™è¯¯ï¼šinvalid operation: f1 == f2 (func can only be compared to nil)
println(m1 == m2) // é”™è¯¯ï¼šinvalid operation: m1 == m2 (map can only be compared to nil)
```

### mapå˜é‡çš„å£°æ˜å’Œåˆå§‹åŒ–

```go
var m map[string]int // ä¸€ä¸ªmap[string]intç±»å‹çš„å˜é‡
```

æœ‰æ˜¾å¼åœ°èµ‹äºˆmapå˜é‡åˆå€¼ï¼Œmapç±»å‹å˜é‡çš„é»˜è®¤å€¼ä¸ºnilã€‚

åˆå€¼ä¸ºé›¶å€¼nilçš„åˆ‡ç‰‡ç±»å‹å˜é‡ï¼Œå¯ä»¥å€ŸåŠ©å†…ç½®çš„appendçš„å‡½æ•°è¿›è¡Œæ“ä½œï¼Œè¿™ç§åœ¨Goè¯­è¨€ä¸­è¢«ç§°ä¸ºâ€œ==é›¶å€¼å¯ç”¨==â€ã€‚å®šä¹‰â€œé›¶å€¼å¯ç”¨â€çš„ç±»å‹ï¼Œå¯ä»¥æå‡å¼€å‘è€…çš„ä½¿ç”¨ä½“éªŒï¼Œä¸ç”¨å†æ‹…å¿ƒå˜é‡çš„åˆå§‹çŠ¶æ€æ˜¯å¦æœ‰æ•ˆã€‚

ä½†mapç±»å‹ï¼Œå› ä¸ºå®ƒ**å†…éƒ¨å®ç°çš„å¤æ‚æ€§ï¼Œæ— æ³•â€œé›¶å€¼å¯ç”¨â€**ã€‚æ‰€ä»¥ï¼Œå¦‚æœå¯¹å¤„äºé›¶å€¼çŠ¶æ€çš„mapå˜é‡ç›´æ¥è¿›è¡Œæ“ä½œï¼Œå°±ä¼šå¯¼è‡´è¿è¡Œæ—¶å¼‚å¸¸ï¼ˆpanicï¼‰ï¼Œä»è€Œå¯¼è‡´ç¨‹åºè¿›ç¨‹å¼‚å¸¸é€€å‡ºï¼š

```go
var m map[string]int // m = nil
m["key"] = 1         // å‘ç”Ÿè¿è¡Œæ—¶å¼‚å¸¸ï¼španic: assignment to entry in nil map
```

æ‰€ä»¥ï¼Œ**å¿…é¡»å¯¹mapç±»å‹å˜é‡è¿›è¡Œæ˜¾å¼åˆå§‹åŒ–åæ‰èƒ½ä½¿ç”¨**ã€‚

ä¸ºmapç±»å‹å˜é‡æ˜¾å¼èµ‹å€¼æœ‰ä¸¤ç§æ–¹å¼:

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨å¤åˆå­—é¢å€¼åˆå§‹åŒ–mapç±»å‹å˜é‡

```go
m := map[int]string{}
```

æ­¤æ—¶mä¸æ˜¯nilï¼Œå¯¹å…¶è¿›è¡Œé”®å€¼å¯¹æ“ä½œï¼Œä¸ä¼šå¼•å‘è¿è¡Œæ—¶å¼‚å¸¸

```go
m1 := map[int][]string{
  1: []string{"val1_1", "val1_2"},
  3: []string{"val3_1", "val3_2", "val3_3"},
  7: []string{"val7_1"},
}
```

```go
type Position struct { 
  x float64 
  y float64
}

m2 := map[Position]string{
  Position{29.935523, 52.568915}: "school",
  Position{25.352594, 113.304361}: "shopping-mall",
  Position{73.224455, 111.804306}: "hospital",
}
```

â€œè¯­æ³•ç³–â€ï¼Œå…è®¸çœç•¥å­—é¢å€¼ä¸­çš„å…ƒç´ ç±»å‹ï¼Œç®€å†™ä¸ºï¼š

```go
m2 := map[Position]string{
  {29.935523, 52.568915}: "school",
  {25.352594, 113.304361}: "shopping-mall",
  {73.224455, 111.804306}: "hospital",
}
```

#### æ–¹æ³•äºŒï¼šä½¿ç”¨makeä¸ºmapç±»å‹å˜é‡è¿›è¡Œæ˜¾å¼åˆå§‹åŒ–

```go
m1 := make(map[int]string) // æœªæŒ‡å®šåˆå§‹å®¹é‡
m2 := make(map[int]string, 8) // æŒ‡å®šåˆå§‹å®¹é‡ä¸º8
```

### mapçš„åŸºæœ¬æ“ä½œ

#### 1ï¸âƒ£æ’å…¥æ–°é”®å€¼å¯¹

```go
m := make(map[int]string)
m[1] = "value1"
m[2] = "value2"
m[3] = "value3"


m := map[string]int {
    "key1" : 1,
    "key2" : 2,
}

m["key1"] = 11 // 11ä¼šè¦†ç›–æ‰"key1"å¯¹åº”çš„æ—§å€¼1
m["key3"] = 3  // æ­¤æ—¶mä¸ºmap[key1:11 key2:2 key3:3]
```

#### 2ï¸âƒ£è·å–é”®å€¼å¯¹æ•°é‡

```go
m := map[string]int {
    "key1" : 1,
    "key2" : 2,
}

fmt.Println(len(m)) // 2
m["key3"] = 3  
fmt.Println(len(m)) // 3 
```

> ä¸èƒ½å¯¹mapç±»å‹å˜é‡è°ƒç”¨capï¼Œæ¥è·å–å½“å‰å®¹é‡

#### 3ï¸âƒ£æŸ¥æ‰¾å’Œæ•°æ®è¯»å–

```go
m := make(map[string]int)
v := m["key1"]  // å¦‚æœè¿™ä¸ªé”®åœ¨mapä¸­å¹¶ä¸å­˜åœ¨ï¼Œä¹Ÿä¼šå¾—åˆ°ä¸€ä¸ªå€¼ï¼švalueå…ƒç´ ç±»å‹çš„é›¶å€¼ã€‚
```

ä¸èƒ½ç”¨ä¸Šé¢çš„æ–¹æ³•åˆ¤æ–­æŸä¸ªkeyæ˜¯å¦åœ¨mapä¸­ã€‚

Goè¯­è¨€çš„mapç±»å‹æ”¯æŒé€šè¿‡ç”¨ä¸€ç§åä¸ºâ€œ==comma ok==â€çš„æƒ¯ç”¨æ³•ï¼Œè¿›è¡Œå¯¹æŸä¸ªkeyçš„æŸ¥è¯¢ã€‚

```go
m := make(map[string]int)
v, ok := m["key1"]
if !ok {
    // "key1"ä¸åœ¨mapä¸­
}

// "key1"åœ¨mapä¸­ï¼Œvå°†è¢«èµ‹äºˆ"key1"é”®å¯¹åº”çš„value
```

#### 4ï¸âƒ£åˆ é™¤æ•°æ®

```go
delete(m, "key2")
```

deleteå‡½æ•°æ˜¯ä»mapä¸­åˆ é™¤é”®çš„å”¯ä¸€æ–¹æ³•ã€‚

#### 5ï¸âƒ£éå†mapä¸­çš„é”®å€¼æ•°æ®

åœ¨Goä¸­ï¼Œéå†mapçš„é”®å€¼å¯¹åªæœ‰ä¸€ç§æ–¹æ³•ï¼Œé‚£å°±æ˜¯åƒå¯¹å¾…åˆ‡ç‰‡é‚£æ ·é€šè¿‡**for range**è¯­å¥å¯¹mapæ•°æ®è¿›è¡Œéå†ã€‚

```go
package main

import "fmt"

func main() {
    m := map[int]int{
        1: 11,
        2: 12,
        3: 13,
    }

    fmt.Printf("{ ")
    for k, v := range m {
        fmt.Printf("[%d, %d] ", k, v)
    }
    fmt.Printf("}\n")
} 
```

> ç¨‹åºé€»è¾‘åƒä¸‡ä¸è¦ä¾èµ–éå†mapæ‰€å¾—åˆ°çš„çš„å…ƒç´ æ¬¡åºã€‚

### mapå˜é‡çš„ä¼ é€’å¼€é”€

```go
package main

import "fmt"

func foo(m map[string]int) {
    m["key1"] = 11
    m["key2"] = 12
}

func main() {
    m := map[string]int{
        "key1": 1,
        "key2": 2,
    }

    fmt.Println(m) // map[key1:1 key2:2]  
    foo(m)
    fmt.Println(m) // map[key1:11 key2:12] 
}
```

### mapçš„å†…éƒ¨å®ç° ğŸ”–

Goè¿è¡Œæ—¶ä½¿ç”¨ä¸€å¼ å“ˆå¸Œè¡¨æ¥å®ç°æŠ½è±¡çš„mapç±»å‹ã€‚è¿è¡Œæ—¶å®ç°äº†mapç±»å‹æ“ä½œçš„æ‰€æœ‰åŠŸèƒ½ï¼ŒåŒ…æ‹¬æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤ç­‰ã€‚åœ¨ç¼–è¯‘é˜¶æ®µï¼ŒGoç¼–è¯‘å™¨ä¼šå°†Goè¯­æ³•å±‚é¢çš„mapæ“ä½œï¼Œé‡å†™æˆè¿è¡Œæ—¶å¯¹åº”çš„å‡½æ•°è°ƒç”¨ã€‚å¤§è‡´çš„å¯¹åº”å…³ç³»æ˜¯è¿™æ ·çš„ï¼š

```go
// åˆ›å»ºmapç±»å‹å˜é‡å®ä¾‹
m := make(map[keyType]valType, capacityhint) â†’ m := runtime.makemap(maptype, capacityhint, m)

// æ’å…¥æ–°é”®å€¼å¯¹æˆ–ç»™é”®é‡æ–°èµ‹å€¼
m["key"] = "value" â†’ v := runtime.mapassign(maptype, m, "key") væ˜¯ç”¨äºåç»­å­˜å‚¨valueçš„ç©ºé—´çš„åœ°å€

// è·å–æŸé”®çš„å€¼ 
v := m["key"]      â†’ v := runtime.mapaccess1(maptype, m, "key")
v, ok := m["key"]  â†’ v, ok := runtime.mapaccess2(maptype, m, "key")

// åˆ é™¤æŸé”®
delete(m, "key")   â†’ runtime.mapdelete(maptype, m, â€œkeyâ€)
```

mapç±»å‹åœ¨Goè¿è¡Œæ—¶å±‚å®ç°çš„ç¤ºæ„å›¾ï¼š

![](images/image-20240704110944559.png)

#### 1ï¸âƒ£åˆå§‹çŠ¶æ€

![](images/image-20240704111147145.png)

##### tophashåŒºåŸŸ

![](images/image-20240704111237832.png)

##### keyå­˜å‚¨åŒºåŸŸ

```go
type maptype struct {
  typ        _type
  key        *_type
  elem       *_type
  bucket     *_type // internal type representing a hash bucket
  keysize    uint8  // size of key slot
  elemsize   uint8  // size of elem slot
  bucketsize uint16 // size of bucket
  flags      uint32
} 
```

Goè¿è¡Œæ—¶å°±æ˜¯åˆ©ç”¨maptypeå‚æ•°ä¸­çš„ä¿¡æ¯ç¡®å®škeyçš„ç±»å‹å’Œå¤§å°çš„ã€‚

##### valueå­˜å‚¨åŒºåŸŸ

![](images/image-20240704111348684.png)

#### 2ï¸âƒ£mapæ‰©å®¹

mapä¼šå¯¹åº•å±‚ä½¿ç”¨çš„å†…å­˜è¿›è¡Œè‡ªåŠ¨ç®¡ç†ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå½“æ’å…¥å…ƒç´ ä¸ªæ•°è¶…å‡ºä¸€å®šæ•°å€¼åï¼Œmapä¸€å®šä¼šå­˜åœ¨è‡ªåŠ¨æ‰©å®¹çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æ€ä¹ˆæ‰©å……bucketçš„æ•°é‡ï¼Œå¹¶é‡æ–°åœ¨bucketé—´å‡è¡¡åˆ†é…æ•°æ®çš„é—®é¢˜ã€‚

![](images/image-20240708190713060.png)

#### 3ï¸âƒ£mapä¸å¹¶å‘

### æ€è€ƒé¢˜

> å¯¹mapç±»å‹è¿›è¡Œéå†æ‰€å¾—åˆ°çš„é”®çš„æ¬¡åºæ˜¯éšæœºçš„ï¼Œå®ç°ä¸€ä¸ªæ–¹æ³•ï¼Œè®©èƒ½å¯¹mapçš„è¿›è¡Œç¨³å®šæ¬¡åºéå†ï¼Ÿ

## 17 å¤åˆæ•°æ®ç±»å‹ï¼šç”¨ç»“æ„ä½“å»ºç«‹å¯¹çœŸå®ä¸–ç•Œçš„æŠ½è±¡

> ç¼–å†™ç¨‹åºçš„ç›®çš„å°±æ˜¯ä¸çœŸå®ä¸–ç•Œäº¤äº’ï¼Œè§£å†³çœŸå®ä¸–ç•Œçš„é—®é¢˜ï¼Œå¸®åŠ©çœŸå®ä¸–ç•Œæé«˜è¿è¡Œæ•ˆç‡ä¸æ”¹å–„è¿è¡Œè´¨é‡ã€‚

ä¹‹å‰æœ‰åŸºæœ¬æ•°æ®ç±»å‹å’Œä¸‰ä¸ªå¤åˆæ•°æ®ç±»å‹ï¼Œè¿˜ç¼ºå°‘ä¸€ç§**==é€šç”¨çš„ã€å¯¹å®ä½“å¯¹è±¡è¿›è¡ŒèšåˆæŠ½è±¡==**çš„èƒ½åŠ›ã€‚==ç»“æ„ä½“ç±»å‹==ï¼ˆ`struct`ï¼‰

### 17.1 å¦‚ä½•è‡ªå®šä¹‰ä¸€ä¸ªæ–°ç±»å‹ï¼Ÿ

1. ç¬¬ä¸€ç§æ˜¯==ç±»å‹å®šä¹‰==ï¼ˆType Definitionï¼‰

```go
type T S // å®šä¹‰ä¸€ä¸ªæ–°ç±»å‹T
```

Så¯ä»¥æ˜¯ä»»ä½•ä¸€ä¸ªå·²å®šä¹‰çš„ç±»å‹ï¼ŒåŒ…æ‹¬GoåŸç”Ÿç±»å‹æˆ–è€…è‡ªå®šä¹‰ç±»å‹

```go
type T1 int 
type T2 T1  
```

å¦‚æœä¸€ä¸ªæ–°ç±»å‹æ˜¯åŸºäºæŸä¸ªGoåŸç”Ÿç±»å‹å®šä¹‰çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªGoåŸç”Ÿç±»å‹ä¸ºæ–°ç±»å‹çš„==åº•å±‚ç±»å‹ï¼ˆUnderlying Type)==ã€‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒT1ã€T2çš„åº•å±‚ç±»å‹éƒ½æ˜¯intã€‚

> ä¸ºä»€ä¹ˆè¦æåˆ°åº•å±‚ç±»å‹è¿™ä¸ªæ¦‚å¿µå‘¢ï¼Ÿ
> 
> å› ä¸ºåº•å±‚ç±»å‹åœ¨Goè¯­è¨€ä¸­æœ‰é‡è¦ä½œç”¨ï¼Œå®ƒè¢«ç”¨æ¥==åˆ¤æ–­ä¸¤ä¸ªç±»å‹æœ¬è´¨ä¸Šæ˜¯å¦ç›¸åŒ==ï¼ˆIdenticalï¼‰ã€‚

T1å’ŒT2çš„åº•å±‚ç±»å‹éƒ½æ˜¯ç±»å‹intï¼Œæ‰€ä»¥å®ƒä»¬åœ¨æœ¬è´¨ä¸Šæ˜¯ç›¸åŒçš„ã€‚è€Œ**æœ¬è´¨ä¸Šç›¸åŒçš„ä¸¤ä¸ªç±»å‹ï¼Œå®ƒä»¬çš„å˜é‡å¯ä»¥é€šè¿‡æ˜¾å¼è½¬å‹è¿›è¡Œç›¸äº’èµ‹å€¼ï¼Œç›¸åï¼Œå¦‚æœæœ¬è´¨ä¸Šæ˜¯ä¸åŒçš„ä¸¤ä¸ªç±»å‹ï¼Œå®ƒä»¬çš„å˜é‡é—´è¿æ˜¾å¼è½¬å‹éƒ½ä¸å¯èƒ½ï¼Œæ›´ä¸è¦è¯´ç›¸äº’èµ‹å€¼äº†**ã€‚

é™¤äº†åŸºäºå·²æœ‰ç±»å‹å®šä¹‰æ–°ç±»å‹ä¹‹å¤–ï¼Œè¿˜å¯ä»¥**==åŸºäºç±»å‹å­—é¢å€¼==**æ¥å®šä¹‰æ–°ç±»å‹ï¼Œè¿™ç§æ–¹å¼å¤šç”¨äºè‡ªå®šä¹‰ä¸€ä¸ªæ–°çš„å¤åˆç±»å‹ï¼š

```go
type M map[int]string
type S []string
```

ç±»å‹å®šä¹‰ä¹Ÿæ”¯æŒé€šè¿‡typeå—çš„æ–¹å¼:

```go
type (
   T1 int
   T2 T1
   T3 string
)
```

2. ç¬¬äºŒç§æ˜¯ç±»å‹åˆ«åï¼ˆType Aliasï¼‰ã€‚è¿™ç§ç±»å‹å®šä¹‰æ–¹å¼é€šå¸¸ç”¨åœ¨é¡¹ç›®çš„**æ¸è¿›å¼é‡æ„**ï¼Œè¿˜æœ‰å¯¹å·²æœ‰åŒ…çš„**äºŒæ¬¡å°è£…æ–¹é¢**ã€‚

```go
type T = S // type alias
```

ç±»å‹åˆ«åå¹¶æ²¡æœ‰å®šä¹‰å‡ºæ–°ç±»å‹ï¼ŒTä¸Så®é™…ä¸Šå°±æ˜¯**åŒä¸€ç§ç±»å‹**ã€‚

### 17.2 å¦‚ä½•å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ç±»å‹ï¼Ÿ

å¤åˆç±»å‹çš„å®šä¹‰ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡ç±»å‹å­—é¢å€¼çš„æ–¹å¼æ¥è¿›è¡Œçš„ï¼Œä½œä¸ºå¤åˆç±»å‹ä¹‹ä¸€çš„ç»“æ„ä½“ç±»å‹ä¹Ÿä¸ä¾‹å¤–:

```go
type T struct {
    Field1 T1
    Field2 T2
    ... ...
    FieldN Tn
}
```

è¿˜å¯ä»¥ç”¨**ç©ºæ ‡è¯†ç¬¦â€œ`_`â€ä½œä¸ºç»“æ„ä½“ç±»å‹å®šä¹‰ä¸­çš„å­—æ®µåç§°**ã€‚è¿™æ ·ä»¥ç©ºæ ‡è¯†ç¬¦ä¸ºåç§°çš„å­—æ®µï¼Œä¸èƒ½è¢«å¤–éƒ¨åŒ…å¼•ç”¨ï¼Œç”šè‡³æ— æ³•è¢«ç»“æ„ä½“æ‰€åœ¨çš„åŒ…ä½¿ç”¨ã€‚

å…¶ä»–å‡ ç§ç‰¹æ®Šæƒ…å†µï¼š

#### ç©ºç»“æ„ä½“

```go
type Empty struct{} // Emptyæ˜¯ä¸€ä¸ªä¸åŒ…å«ä»»ä½•å­—æ®µçš„ç©ºç»“æ„ä½“ç±»å‹
```

ç©ºç»“æ„ä½“ç±»å‹æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ

```go
var s Empty
println(unsafe.Sizeof(s)) // 0
```

ç©ºç»“æ„ä½“ç±»å‹å˜é‡çš„å†…å­˜å ç”¨ä¸º0ã€‚åŸºäº**ç©ºç»“æ„ä½“ç±»å‹å†…å­˜é›¶å¼€é”€**è¿™æ ·çš„ç‰¹æ€§ï¼Œåœ¨æ—¥å¸¸Goå¼€å‘ä¸­ä¼šç»å¸¸ä½¿ç”¨ç©ºç»“æ„ä½“ç±»å‹å…ƒç´ ï¼Œä½œä¸º**ä¸€ç§â€œäº‹ä»¶â€ä¿¡æ¯**è¿›è¡ŒGoroutineä¹‹é—´çš„é€šä¿¡:

```go
var c = make(chan Empty) // å£°æ˜ä¸€ä¸ªå…ƒç´ ç±»å‹ä¸ºEmptyçš„channel
c<-Empty{}               // å‘channelå†™å…¥ä¸€ä¸ªâ€œäº‹ä»¶â€
```

è¿™ç§ä»¥ç©ºç»“æ„ä½“ä¸ºå…ƒç´ ç±»å»ºç«‹çš„channelï¼Œæ˜¯ç›®å‰èƒ½å®ç°çš„ã€å†…å­˜å ç”¨æœ€å°çš„Goroutineé—´é€šä¿¡æ–¹å¼ã€‚

#### ä½¿ç”¨å…¶ä»–ç»“æ„ä½“ä½œä¸ºè‡ªå®šä¹‰ç»“æ„ä½“ä¸­å­—æ®µçš„ç±»å‹

```go
type Person struct {
  Name string
  Phone string
  Addr string
}

type Book struct {
  Title string
  Author Person
  ... ...
}  
```

åµŒå…¥å­—æ®µï¼ˆEmbedded Fieldï¼‰ 

### 17.3 ç»“æ„ä½“å˜é‡çš„å£°æ˜ä¸åˆå§‹åŒ–

#### é›¶å€¼åˆå§‹åŒ–

å¦‚æœä¸€ç§ç±»å‹é‡‡ç”¨é›¶å€¼åˆå§‹åŒ–å¾—åˆ°çš„**é›¶å€¼å˜é‡**ï¼Œæ˜¯æœ‰æ„ä¹‰çš„ï¼Œè€Œä¸”æ˜¯ç›´æ¥å¯ç”¨çš„ï¼Œæˆ‘ç§°è¿™ç§ç±»å‹ä¸º**â€œé›¶å€¼å¯ç”¨â€ç±»å‹**ã€‚

åœ¨Goè¯­è¨€æ ‡å‡†åº“å’Œè¿è¡Œæ—¶çš„ä»£ç ä¸­ï¼Œæœ‰å¾ˆå¤šè·µè¡Œâ€œé›¶å€¼å¯ç”¨â€ç†å¿µçš„å¥½ä¾‹å­ï¼Œæœ€å…¸å‹çš„è«è¿‡äºsyncåŒ…çš„`Mutex`ç±»å‹äº†ã€‚Mutexæ˜¯Goæ ‡å‡†åº“ä¸­æä¾›çš„ã€ç”¨äº**å¤šä¸ªå¹¶å‘Goroutineä¹‹é—´è¿›è¡ŒåŒæ­¥çš„äº’æ–¥é”**ã€‚

è¿ç”¨â€œé›¶å€¼å¯ç”¨â€ç±»å‹ï¼Œç»™Goè¯­è¨€ä¸­çš„çº¿ç¨‹äº’æ–¥é”å¸¦æ¥äº†ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿæ¨ªå‘å¯¹æ¯”ä¸€ä¸‹Cè¯­è¨€ï¼Œè¦åœ¨Cè¯­è¨€ä¸­ä½¿ç”¨çº¿ç¨‹äº’æ–¥é”ï¼Œé€šå¸¸éœ€è¦ï¼š

```c
pthread_mutex_t mutex; 
pthread_mutex_init(&mutex, NULL);

pthread_mutex_lock(&mutex); 
... ...
pthread_mutex_unlock(&mutex); 
```

åœ¨Cä¸­ä½¿ç”¨äº’æ–¥é”ï¼Œéœ€è¦é¦–å…ˆå£°æ˜ä¸€ä¸ªmutexå˜é‡ï¼Œè¿˜å¿…é¡»ä½¿ç”¨pthread_mutex_initå‡½æ•°å¯¹å…¶è¿›è¡Œä¸“é—¨çš„åˆå§‹åŒ–æ“ä½œåï¼Œå®ƒæ‰èƒ½å¤„äºå¯ç”¨çŠ¶æ€ã€‚

goè¯­è¨€ï¼š

```go
var mu sync.Mutex
mu.Lock()
mu.Unlock()  
```

å¦ä¸€ä¸ªä¾‹å­ï¼Œæ ‡å‡†åº“ä¸­çš„bytes.Bufferç»“æ„ä½“ç±»å‹ï¼š

```go
var b bytes.Buffer
b.Write([]byte("Hello, Go"))
fmt.Println(b.String()) // è¾“å‡ºï¼šHello, Go 
```

#### ä½¿ç”¨å¤åˆå­—é¢å€¼

æœ€ç®€å•çš„å¯¹ç»“æ„ä½“å˜é‡è¿›è¡Œæ˜¾å¼åˆå§‹åŒ–çš„æ–¹å¼ï¼Œå°±æ˜¯**æŒ‰é¡ºåºä¾æ¬¡ç»™æ¯ä¸ªç»“æ„ä½“å­—æ®µè¿›è¡Œèµ‹å€¼**ã€‚

```go
type Book struct {
    Title string              // ä¹¦å
    Pages int                 // ä¹¦çš„é¡µæ•°
    Indexes map[string]int    // ä¹¦çš„ç´¢å¼•
}

var book = Book{"The Go Programming Language", 700, make(map[string]int)}
```

è¿™æ ·ä¾æ¬¡èµ‹å€¼çš„é—®é¢˜ï¼š

- å½“ç»“æ„ä½“ç±»å‹å®šä¹‰ä¸­çš„å­—æ®µé¡ºåºå‘ç”Ÿå˜åŒ–ï¼Œæˆ–è€…å­—æ®µå‡ºç°å¢åˆ æ“ä½œæ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦æ‰‹åŠ¨è°ƒæ•´è¯¥ç»“æ„ä½“ç±»å‹å˜é‡çš„æ˜¾å¼åˆå§‹åŒ–ä»£ç ï¼Œè®©èµ‹å€¼é¡ºåºä¸è°ƒæ•´åçš„å­—æ®µé¡ºåºä¸€è‡´ã€‚

- å½“ä¸€ä¸ªç»“æ„ä½“çš„å­—æ®µè¾ƒå¤šæ—¶ï¼Œè¿™ç§é€ä¸€å­—æ®µèµ‹å€¼çš„æ–¹å¼å®æ–½èµ·æ¥å°±ä¼šæ¯”è¾ƒå›°éš¾

- ä¸€æ—¦ç»“æ„ä½“ä¸­åŒ…å«éå¯¼å‡ºå­—æ®µï¼Œé‚£ä¹ˆè¿™ç§é€ä¸€å­—æ®µèµ‹å€¼çš„æ–¹å¼å°±ä¸å†è¢«æ”¯æŒäº†ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™

> äº‹å®ä¸Šï¼ŒGoè¯­è¨€å¹¶ä¸æ¨èæŒ‰å­—æ®µé¡ºåºå¯¹ä¸€ä¸ªç»“æ„ä½“ç±»å‹å˜é‡è¿›è¡Œæ˜¾å¼åˆå§‹åŒ–ï¼Œç”šè‡³Goå®˜æ–¹è¿˜åœ¨æä¾›çš„`go vet`å·¥å…·ä¸­ä¸“é—¨å†…ç½®äº†ä¸€æ¡æ£€æŸ¥è§„åˆ™ï¼šâ€œ`composites`â€ï¼Œç”¨æ¥é™æ€æ£€æŸ¥ä»£ç ä¸­ç»“æ„ä½“å˜é‡åˆå§‹åŒ–æ˜¯å¦ä½¿ç”¨äº†è¿™ç§æ–¹æ³•ï¼Œä¸€æ—¦å‘ç°ï¼Œå°±ä¼šç»™å‡ºè­¦å‘Šã€‚

æ¨èä½¿ç”¨**â€œ`field:value`â€å½¢å¼çš„å¤åˆå­—é¢å€¼**ï¼š

```go
var t = T{
  F2: "hello",
  F1: 11,
  F4: 14,
} 
```

#### ä½¿ç”¨ç‰¹å®šçš„æ„é€ å‡½æ•°

```go
// $GOROOT/src/time/sleep.go
type runtimeTimer struct {
    pp       uintptr
    when     int64
    period   int64
    f        func(interface{}, uintptr) 
    arg      interface{}
    seq      uintptr
    nextwhen int64
    status   uint32
}

type Timer struct {
    C <-chan Time
    r runtimeTimer
}

// Timerç»“æ„ä½“ä¸“ç”¨çš„æ„é€ å‡½æ•°
func NewTimer(d Duration) *Timer {
    c := make(chan Time, 1)
    t := &Timer{
        C: c,
        r: runtimeTimer{
            when: when(d),
            f:    sendTime,
            arg:  c,
        },
    }
    startTimer(&t.r)
    return t
}
```

### 17.4 ç»“æ„ä½“ç±»å‹çš„å†…å­˜å¸ƒå±€

Goç»“æ„ä½“ç±»å‹æ˜¯æ—¢æ•°ç»„ç±»å‹ä¹‹åï¼Œç¬¬äºŒä¸ªå°†å®ƒçš„å…ƒç´ ï¼ˆç»“æ„ä½“å­—æ®µï¼‰ä¸€ä¸ªæ¥ç€ä¸€ä¸ªä»¥â€œå¹³é“ºâ€å½¢å¼ï¼Œå­˜æ”¾åœ¨ä¸€ä¸ªè¿**ç»­å†…å­˜å—**ä¸­çš„ã€‚

![](images/image-20240704120037598.png)

åœ¨çœŸå®æƒ…å†µä¸‹ï¼Œè™½ç„¶Goç¼–è¯‘å™¨æ²¡æœ‰åœ¨ç»“æ„ä½“å˜é‡å ç”¨çš„å†…å­˜ç©ºé—´ä¸­æ’å…¥é¢å¤–å­—æ®µï¼Œä½†ç»“æ„ä½“å­—æ®µå®é™…ä¸Šå¯èƒ½å¹¶ä¸æ˜¯ç´§å¯†ç›¸è¿çš„ï¼Œä¸­é—´å¯èƒ½å­˜åœ¨â€œç¼éš™â€ã€‚è¿™äº›â€œç¼éš™â€åŒæ ·æ˜¯ç»“æ„ä½“å˜é‡å ç”¨çš„å†…å­˜ç©ºé—´çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä»¬æ˜¯Goç¼–è¯‘å™¨æ’å…¥çš„â€œ==å¡«å……ç‰©ï¼ˆPaddingï¼‰==â€ã€‚

![](images/image-20240708193452381.png)

å¡«å……ç‰©æ˜¯å› ä¸ºéœ€è¦==å†…å­˜å¯¹é½==ï¼ŒæŒ‡çš„å°±æ˜¯å„ç§å†…å­˜å¯¹è±¡çš„å†…å­˜åœ°å€ä¸æ˜¯éšæ„ç¡®å®šçš„ï¼Œå¿…é¡»æ»¡è¶³ç‰¹å®šè¦æ±‚ã€‚

å¯¹äºå„ç§**åŸºæœ¬æ•°æ®ç±»å‹**æ¥è¯´ï¼Œå®ƒçš„å˜é‡çš„å†…å­˜åœ°å€å€¼å¿…é¡»æ˜¯**å…¶ç±»å‹æœ¬èº«å¤§å°çš„æ•´æ•°å€**ï¼Œæ¯”å¦‚ï¼Œä¸€ä¸ªint64ç±»å‹çš„å˜é‡çš„å†…å­˜åœ°å€ï¼Œåº”è¯¥èƒ½è¢«int64ç±»å‹è‡ªèº«çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯8æ•´é™¤ï¼›ä¸€ä¸ªuint16ç±»å‹çš„å˜é‡çš„å†…å­˜åœ°å€ï¼Œåº”è¯¥èƒ½è¢«uint16ç±»å‹è‡ªèº«çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯2æ•´é™¤ã€‚

å¯¹äºç»“æ„ä½“è€Œè¨€ï¼Œå®ƒçš„å˜é‡çš„å†…å­˜åœ°å€ï¼Œåªè¦æ˜¯**å®ƒæœ€é•¿å­—æ®µé•¿åº¦ä¸ç³»ç»Ÿå¯¹é½ç³»æ•°ä¸¤è€…ä¹‹é—´è¾ƒå°çš„é‚£ä¸ªçš„æ•´æ•°å€**å°±å¯ä»¥äº†ã€‚ä½†å¯¹äºç»“æ„ä½“ç±»å‹æ¥è¯´ï¼Œè¿˜è¦è®©å®ƒ**æ¯ä¸ªå­—æ®µçš„å†…å­˜åœ°å€éƒ½ä¸¥æ ¼æ»¡è¶³å†…å­˜å¯¹é½è¦æ±‚**ã€‚

```go
type T struct {
   b byte
   i int64
   u uint16
}
```

è®¡ç®—è¿‡ç¨‹ï¼š

![](images/image-20240708194400125.png)

æ•´ä¸ªè®¡ç®—è¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µã€‚

ç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯**å¯¹é½ç»“æ„ä½“çš„å„ä¸ªå­—æ®µ**ã€‚

- é¦–å…ˆï¼Œç¬¬ä¸€ä¸ªå­—æ®µbæ˜¯é•¿åº¦1ä¸ªå­—èŠ‚çš„byteç±»å‹å˜é‡ï¼Œè¿™æ ·å­—æ®µbæ”¾åœ¨ä»»æ„åœ°å€ä¸Šéƒ½å¯ä»¥è¢«1æ•´é™¤ï¼Œæ‰€ä»¥å®ƒæ˜¯å¤©ç”Ÿå¯¹é½çš„ã€‚ç”¨ä¸€ä¸ªsumæ¥è¡¨ç¤ºå½“å‰å·²ç»å¯¹é½çš„å†…å­˜ç©ºé—´çš„å¤§å°ï¼Œè¿™ä¸ªæ—¶å€™sum=1ï¼›
- æ¥ä¸‹æ¥ï¼Œç¬¬äºŒä¸ªå­—æ®µiæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º8ä¸ªå­—èŠ‚çš„int64ç±»å‹å˜é‡ã€‚æŒ‰ç…§å†…å­˜å¯¹é½è¦æ±‚ï¼Œå®ƒåº”è¯¥è¢«æ”¾åœ¨å¯ä»¥è¢«8æ•´é™¤çš„åœ°å€ä¸Šã€‚ä½†æ˜¯ï¼Œå¦‚æœæŠŠiç´§é‚»bè¿›è¡Œåˆ†é…ï¼Œå½“içš„åœ°å€å¯ä»¥è¢«8æ•´é™¤æ—¶ï¼Œbçš„åœ°å€å°±æ— æ³•è¢«8æ•´é™¤ã€‚è¿™ä¸ªæ—¶å€™ï¼Œéœ€è¦åœ¨bä¸iä¹‹é—´åšä¸€äº›å¡«å……ï¼Œä½¿å¾—içš„åœ°å€å¯ä»¥è¢«8æ•´é™¤æ—¶ï¼Œbçš„åœ°å€ä¹Ÿå§‹ç»ˆå¯ä»¥è¢«8æ•´é™¤ï¼Œäºæ˜¯æˆ‘ä»¬åœ¨iä¸bä¹‹é—´å¡«å……äº†7ä¸ªå­—èŠ‚ï¼Œæ­¤æ—¶æ­¤åˆ»sum=1+7+8ï¼›
- å†ä¸‹æ¥ï¼Œç¬¬ä¸‰ä¸ªå­—æ®µuæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º2ä¸ªå­—èŠ‚çš„uint16ç±»å‹å˜é‡ï¼ŒæŒ‰ç…§å†…å­˜å¯¹å…¶è¦æ±‚ï¼Œå®ƒåº”è¯¥è¢«æ”¾åœ¨å¯ä»¥è¢«2æ•´é™¤çš„åœ°å€ä¸Šã€‚æœ‰äº†å¯¹å…¶çš„iä½œä¸ºåŸºç¡€ï¼Œç°åœ¨çŸ¥é“å°†uä¸iç›¸é‚»è€Œæ”¾ï¼Œæ˜¯å¯ä»¥æ»¡è¶³å…¶åœ°å€çš„å¯¹é½è¦æ±‚çš„ã€‚iä¹‹åçš„é‚£ä¸ªå­—èŠ‚çš„åœ°å€è‚¯å®šå¯ä»¥è¢«8æ•´é™¤ï¼Œä¹Ÿä¸€å®šå¯ä»¥è¢«2æ•´é™¤ã€‚äºæ˜¯æˆ‘ä»¬æŠŠuç›´æ¥æ”¾åœ¨içš„åé¢ï¼Œä¸­é—´ä¸éœ€è¦å¡«å……ï¼Œæ­¤æ—¶æ­¤åˆ»ï¼Œsum=1+7+8+2ã€‚

ç°åœ¨ç»“æ„ä½“Tçš„æ‰€æœ‰å­—æ®µéƒ½å·²ç»å¯¹é½äº†ï¼Œå¼€å§‹ç¬¬äºŒä¸ªé˜¶æ®µï¼Œä¹Ÿå°±æ˜¯**å¯¹é½æ•´ä¸ªç»“æ„ä½“**ã€‚

ç»“æ„ä½“çš„å†…å­˜åœ°å€ä¸ºminï¼ˆç»“æ„ä½“æœ€é•¿å­—æ®µçš„é•¿åº¦ï¼Œç³»ç»Ÿå†…å­˜å¯¹é½ç³»æ•°ï¼‰çš„æ•´æ•°å€ï¼Œé‚£ä¹ˆè¿™é‡Œç»“æ„ä½“Tæœ€é•¿å­—æ®µä¸ºiï¼Œå®ƒçš„é•¿åº¦ä¸º8ï¼Œè€Œ64bitç³»ç»Ÿä¸Šçš„ç³»ç»Ÿå†…å­˜å¯¹é½ç³»æ•°ä¸€èˆ¬ä¸º8ï¼Œä¸¤è€…ç›¸åŒï¼Œæˆ‘ä»¬å–8å°±å¯ä»¥äº†ã€‚é‚£ä¹ˆæ•´ä¸ªç»“æ„ä½“çš„å¯¹é½ç³»æ•°å°±æ˜¯8ã€‚

> ä¸ºä»€ä¹ˆä¸Šé¢çš„ç¤ºæ„å›¾è¿˜è¦åœ¨ç»“æ„ä½“çš„å°¾éƒ¨å¡«å……äº†6ä¸ªå­—èŠ‚å‘¢ï¼Ÿ

ç»“æ„ä½“Tçš„å¯¹é½ç³»æ•°æ˜¯8ï¼Œé‚£ä¹ˆå°±è¦ä¿è¯æ¯ä¸ªç»“æ„ä½“Tçš„å˜é‡çš„å†…å­˜åœ°å€ï¼Œéƒ½èƒ½è¢«8æ•´é™¤ã€‚å¦‚æœåªåˆ†é…ä¸€ä¸ªTç±»å‹å˜é‡ï¼Œä¸å†ç»§ç»­å¡«å……ï¼Œä¹Ÿå¯èƒ½ä¿è¯å…¶å†…å­˜åœ°å€ä¸º8çš„å€æ•°ã€‚ä½†å¦‚æœè€ƒè™‘æˆ‘ä»¬åˆ†é…çš„æ˜¯ä¸€ä¸ªå…ƒç´ ä¸ºTç±»å‹çš„æ•°ç»„ï¼Œæ¯”å¦‚ä¸‹é¢è¿™è¡Œä»£ç ï¼Œæˆ‘ä»¬è™½ç„¶å¯ä»¥ä¿è¯T[0]è¿™ä¸ªå…ƒç´ åœ°å€å¯ä»¥è¢«8æ•´é™¤ï¼Œä½†èƒ½ä¿è¯T[1]çš„åœ°å€ä¹Ÿå¯ä»¥è¢«8æ•´é™¤å—ï¼Ÿ

```go
var array [10]T
```

æ•°ç»„æ˜¯å…ƒç´ è¿ç»­å­˜å‚¨çš„ä¸€ç§ç±»å‹ï¼Œå…ƒç´ T[1]çš„åœ°å€ä¸ºT[0]åœ°å€+Tçš„å¤§å°(18)ï¼Œæ˜¾ç„¶æ— æ³•è¢«8æ•´é™¤ï¼Œè¿™å°†å¯¼è‡´T[1]åŠåç»­å…ƒç´ çš„åœ°å€éƒ½æ— æ³•å¯¹é½ï¼Œè¿™æ˜¾ç„¶ä¸èƒ½æ»¡è¶³å†…å­˜å¯¹é½çš„è¦æ±‚ã€‚åŠ 6å˜æˆ24ï¼Œå°±èƒ½è¢«8æ•´é™¤äº†ã€‚

> ä¸ºä»€ä¹ˆä¼šå‡ºç°å†…å­˜å¯¹é½çš„è¦æ±‚å‘¢ï¼Ÿ

å‡ºäºå¯¹å¤„ç†å™¨**å­˜å–æ•°æ®æ•ˆç‡**çš„è€ƒè™‘ã€‚åœ¨æ—©æœŸçš„ä¸€äº›å¤„ç†å™¨ä¸­ï¼Œæ¯”å¦‚Sunå…¬å¸çš„Sparcå¤„ç†å™¨ä»…æ”¯æŒå†…å­˜å¯¹é½çš„åœ°å€ï¼Œå¦‚æœå®ƒé‡åˆ°æ²¡æœ‰å¯¹é½çš„å†…å­˜åœ°å€ï¼Œä¼šå¼•å‘æ®µé”™è¯¯ï¼Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚æˆ‘ä»¬å¸¸è§çš„x86-64æ¶æ„å¤„ç†å™¨è™½ç„¶å¤„ç†æœªå¯¹é½çš„å†…å­˜åœ°å€ä¸ä¼šå‡ºç°æ®µé”™è¯¯ï¼Œä½†æ•°æ®çš„å­˜å–æ€§èƒ½ä¹Ÿä¼šå—åˆ°å½±å“ã€‚

ä»ä¸Šå¯çœ‹å‡ºï¼ŒGoè¯­è¨€ä¸­ç»“æ„ä½“ç±»å‹çš„å¤§å°å—å†…å­˜å¯¹é½çº¦æŸçš„å½±å“ã€‚ä¸**åŒçš„å­—æ®µæ’åˆ—é¡ºåºä¹Ÿä¼šå½±å“åˆ°â€œå¡«å……å­—èŠ‚â€çš„å¤šå°‘ï¼Œä»è€Œå½±å“åˆ°æ•´ä¸ªç»“æ„ä½“å¤§å°**ã€‚

```go
type T struct {
    b byte
    i int64
    u uint16
}

type S struct {
    b byte
    u uint16
    i int64
}

func main() {
    var t T
    println(unsafe.Sizeof(t)) // 24
    var s S
    println(unsafe.Sizeof(s)) // 16
}
```

æ‰€ä»¥ï¼Œåœ¨æ—¥å¸¸å®šä¹‰ç»“æ„ä½“æ—¶ï¼Œä¸€å®šè¦æ³¨æ„**ç»“æ„ä½“ä¸­å­—æ®µé¡ºåº**ï¼Œå°½é‡åˆç†æ’åºï¼Œé™ä½ç»“æ„ä½“å¯¹å†…å­˜ç©ºé—´çš„å ç”¨ã€‚

æœ‰äº›æ—¶å€™ï¼Œä¸ºäº†ä¿è¯æŸä¸ªå­—æ®µçš„å†…å­˜åœ°å€æœ‰æ›´ä¸ºä¸¥æ ¼çš„çº¦æŸï¼Œä¹Ÿä¼šåš**ä¸»åŠ¨å¡«å……**ã€‚æ¯”å¦‚runtimeåŒ…ä¸­çš„mstatsç»“æ„ä½“å®šä¹‰å°±é‡‡ç”¨äº†ä¸»åŠ¨å¡«å……ï¼š

```go
// $GOROOT/src/runtime/mstats.go
type mstats struct {
    ... ...
    // Add an uint32 for even number of size classes to align below fields
    // to 64 bits for atomic operations on 32 bit platforms.
    _ [1 - _NumSizeClasses%2]uint32 // è¿™é‡Œåšäº†ä¸»åŠ¨å¡«å……

    last_gc_nanotime uint64 // last gc (monotonic time)
    last_heap_inuse  uint64 // heap_inuse at mark termination of the previous GC
    ... ...
}
```

é€šè¿‡ç©ºæ ‡è¯†ç¬¦æ¥è¿›è¡Œä¸»åŠ¨å¡«å……ã€‚

### æ€è€ƒé¢˜

> Goè¯­è¨€ä¸æ”¯æŒåœ¨ç»“æ„ä½“ç±»å‹å®šä¹‰ä¸­ï¼Œé€’å½’åœ°æ”¾å…¥å…¶è‡ªèº«ç±»å‹å­—æ®µï¼Œä½†å´å¯ä»¥æ‹¥æœ‰è‡ªèº«ç±»å‹çš„æŒ‡é’ˆç±»å‹ã€ä»¥è‡ªèº«ç±»å‹ä¸ºå…ƒç´ ç±»å‹çš„åˆ‡ç‰‡ç±»å‹ï¼Œä»¥åŠä»¥è‡ªèº«ç±»å‹ä½œä¸ºvalueç±»å‹çš„mapç±»å‹çš„å­—æ®µï¼Œä½ èƒ½æ€è€ƒä¸€ä¸‹å…¶ä¸­çš„åŸå› å—ï¼Ÿ

## 18 æ§åˆ¶ç»“æ„ï¼šifçš„â€œå¿«ä¹è·¯å¾„â€åŸåˆ™

Goä¸­ç¨‹åºçš„åˆ†æ”¯ç»“æ„ï¼šifå’Œswitch-caseä¸¤ç§è¯­å¥å½¢å¼ï¼›å¾ªç¯ç»“æ„ï¼šåªæœ‰forã€‚

![](images/image-20240709105248548.png)

## 19 æ§åˆ¶ç»“æ„ï¼šGoçš„forå¾ªç¯ï¼Œä»…æ­¤ä¸€ç§

### forè¯­å¥çš„ç»å…¸ä½¿ç”¨å½¢å¼

### for range

### å¸¦labelçš„continueè¯­å¥

ğŸ”–

### breakè¯­å¥çš„ä½¿ç”¨

### forè¯­å¥çš„å¸¸è§â€œå‘â€ä¸é¿å‘æ–¹æ³•

#### 1ï¸âƒ£å¾ªç¯å˜é‡çš„é‡ç”¨

#### 2ï¸âƒ£å‚ä¸å¾ªç¯çš„æ˜¯rangeè¡¨è¾¾å¼çš„å‰¯æœ¬

#### 3ï¸âƒ£éå†mapä¸­å…ƒç´ çš„éšæœºæ€§

## 20 æ§åˆ¶ç»“æ„ï¼šGoä¸­çš„switchè¯­å¥æœ‰å“ªäº›å˜åŒ–ï¼Ÿ

### switchè¯­å¥çš„çµæ´»æ€§

**é¦–å…ˆï¼Œswitchè¯­å¥å„è¡¨è¾¾å¼çš„æ±‚å€¼ç»“æœå¯ä»¥ä¸ºå„ç§ç±»å‹å€¼ï¼Œåªè¦å®ƒçš„ç±»å‹æ”¯æŒæ¯”è¾ƒæ“ä½œå°±å¯ä»¥äº†ã€‚**

**ç¬¬äºŒç‚¹ï¼šswitchè¯­å¥æ”¯æŒå£°æ˜ä¸´æ—¶å˜é‡ã€‚**

**ç¬¬ä¸‰ç‚¹ï¼šcaseè¯­å¥æ”¯æŒè¡¨è¾¾å¼åˆ—è¡¨ã€‚**

**ç¬¬å››ç‚¹ï¼šå–æ¶ˆäº†é»˜è®¤æ‰§è¡Œä¸‹ä¸€ä¸ªcaseä»£ç é€»è¾‘çš„è¯­ä¹‰ã€‚**

### type switch

```go
func main() {
    var x interface{} = 13
    switch x.(type) {
    case nil:
        println("x is nil")
    case int:
        println("the type of x is int")
    case string:
        println("the type of x is string")
    case bool:
        println("the type of x is string")
    default:
        println("don't support the type")
    }
}
```

switchå…³é”®å­—åé¢è·Ÿç€çš„è¡¨è¾¾å¼ä¸º`x.(type)`ï¼Œè¿™ç§è¡¨è¾¾å¼å½¢å¼æ˜¯switchè¯­å¥**ä¸“æœ‰çš„**ï¼Œè€Œä¸”ä¹Ÿåªèƒ½åœ¨switchè¯­å¥ä¸­ä½¿ç”¨ã€‚è¿™ä¸ªè¡¨è¾¾å¼ä¸­çš„**xå¿…é¡»æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹å˜é‡**ï¼Œè¡¨è¾¾å¼çš„æ±‚å€¼ç»“æœæ˜¯è¿™ä¸ªæ¥å£ç±»å‹å˜é‡å¯¹åº”çš„**åŠ¨æ€ç±»å‹**ã€‚

caseå…³é”®å­—åé¢æ¥çš„å°±ä¸æ˜¯æ™®é€šæ„ä¹‰ä¸Šçš„è¡¨è¾¾å¼äº†ï¼Œè€Œæ˜¯ä¸€ä¸ªä¸ª**å…·ä½“çš„ç±»å‹**ã€‚

### è·³ä¸å‡ºå¾ªç¯çš„break

## 21 å‡½æ•°ï¼šè¯·å«æˆ‘â€œä¸€ç­‰å…¬æ°‘â€

å‡½æ•°æ˜¯ç°ä»£ç¼–ç¨‹è¯­è¨€çš„åŸºæœ¬è¯­æ³•å…ƒç´ ï¼Œæ— è®ºæ˜¯åœ¨å‘½ä»¤å¼è¯­è¨€ã€é¢å‘å¯¹è±¡è¯­è¨€è¿˜æ˜¯åŠ¨æ€è„šæœ¬è¯­è¨€ä¸­ï¼Œå‡½æ•°éƒ½ä½åˆ—Cä½ã€‚

åœ¨Goè¯­è¨€ä¸­ï¼Œ**å‡½æ•°æ˜¯å”¯ä¸€ä¸€ç§åŸºäºç‰¹å®šè¾“å…¥ï¼Œå®ç°ç‰¹å®šä»»åŠ¡å¹¶å¯è¿”å›ä»»åŠ¡æ‰§è¡Œç»“æœçš„ä»£ç å—**ï¼ˆGoè¯­è¨€ä¸­çš„æ–¹æ³•æœ¬è´¨ä¸Šä¹Ÿæ˜¯å‡½æ•°ï¼‰ã€‚

å¦‚æœå¿½ç•¥GoåŒ…åœ¨Goä»£ç ç»„ç»‡å±‚é¢çš„ä½œç”¨ï¼Œå¯ä»¥è¯´**Goç¨‹åºå°±æ˜¯ä¸€ç»„å‡½æ•°çš„é›†åˆ**ã€‚

### 21.1 Goå‡½æ•°ä¸å‡½æ•°å£°æ˜

æ™®é€šGoå‡½æ•°çš„å£°æ˜ï¼š

![](images/image-20240704122156576.png)

==å˜é•¿å‚æ•°==ï¼Œåœ¨ç±»å‹å‰é¢å¢åŠ äº†ä¸€ä¸ªâ€œ`â€¦`â€ç¬¦å·ã€‚

**å…·åè¿”å›å€¼**

æŠŠä¸Šé¢çš„å‡½æ•°å£°æ˜ç­‰ä»·è½¬æ¢ä¸ºå˜é‡å£°æ˜çš„å½¢å¼ï¼š

![](images/image-20240704122531758.png)

**è¿™ä¸å°±æ˜¯åœ¨å£°æ˜ä¸€ä¸ªç±»å‹ä¸ºå‡½æ•°ç±»å‹çš„å˜é‡å—**ï¼

**å‡½æ•°å£°æ˜ä¸­çš„å‡½æ•°åå…¶å®å°±æ˜¯å˜é‡å**ï¼Œå‡½æ•°å£°æ˜ä¸­çš„**funcå…³é”®å­—ã€å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼åˆ—è¡¨**å…±åŒæ„æˆäº†**==å‡½æ•°ç±»å‹==**ã€‚è€Œå‚æ•°åˆ—è¡¨ä¸è¿”å›å€¼åˆ—è¡¨çš„ç»„åˆä¹Ÿè¢«ç§°ä¸º**==å‡½æ•°ç­¾å==**ï¼Œå®ƒæ˜¯å†³å®šä¸¤ä¸ªå‡½æ•°ç±»å‹æ˜¯å¦ç›¸åŒçš„å†³å®šå› ç´ ã€‚å› æ­¤ï¼Œå‡½æ•°ç±»å‹ä¹Ÿå¯ä»¥çœ‹æˆæ˜¯ç”±funcå…³é”®å­—ä¸å‡½æ•°ç­¾åç»„åˆè€Œæˆçš„ã€‚

é€šå¸¸ï¼Œåœ¨è¡¨è¿°å‡½æ•°ç±»å‹æ—¶ä¼šçœç•¥å‡½æ•°ç­¾åå‚æ•°åˆ—è¡¨ä¸­çš„å‚æ•°åï¼Œä»¥åŠè¿”å›å€¼åˆ—è¡¨ä¸­çš„è¿”å›å€¼å˜é‡åï¼š

```go
func(io.Writer, string, ...interface{}) (int, error)
```

è¿™æ ·ï¼Œå¦‚æœä¸¤ä¸ªå‡½æ•°ç±»å‹çš„å‡½æ•°ç­¾åæ˜¯ç›¸åŒçš„ï¼Œå³ä¾¿å‚æ•°åˆ—è¡¨ä¸­çš„å‚æ•°åï¼Œä»¥åŠè¿”å›å€¼åˆ—è¡¨ä¸­çš„è¿”å›å€¼å˜é‡åéƒ½æ˜¯ä¸åŒçš„ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå‡½æ•°ç±»å‹ä¹Ÿæ˜¯ç›¸åŒç±»å‹ã€‚

ç»“è®ºï¼š**æ¯ä¸ªå‡½æ•°å£°æ˜æ‰€å®šä¹‰çš„å‡½æ•°ï¼Œä»…ä»…æ˜¯å¯¹åº”çš„å‡½æ•°ç±»å‹çš„ä¸€ä¸ªå®ä¾‹**ï¼Œå°±åƒvar a int = 13è¿™ä¸ªå˜é‡å£°æ˜è¯­å¥ä¸­aæ˜¯intç±»å‹çš„ä¸€ä¸ªå®ä¾‹ä¸€æ ·ã€‚

ç±»ä¼¼17ä¸­ï¼Œä½¿ç”¨å¤åˆç±»å‹å­—é¢å€¼å¯¹ç»“æ„ä½“ç±»å‹å˜é‡è¿›è¡Œæ˜¾å¼åˆå§‹åŒ–çš„å†…å®¹

```go
s := T{}      // ä½¿ç”¨å¤åˆç±»å‹å­—é¢å€¼å¯¹ç»“æ„ä½“ç±»å‹Tçš„å˜é‡è¿›è¡Œæ˜¾å¼åˆå§‹åŒ–
f := func(){} // ä½¿ç”¨å˜é‡å£°æ˜å½¢å¼çš„å‡½æ•°å£°æ˜
```

`T{}`è¢«ä¸º==å¤åˆç±»å‹å­—é¢å€¼==ï¼›`func(){}`å°±å«â€œ==å‡½æ•°å­—é¢å€¼ï¼ˆFunction Literalï¼‰==â€ï¼Œå®ƒç‰¹åˆ«åƒä¸€ä¸ªæ²¡æœ‰å‡½æ•°åçš„å‡½æ•°å£°æ˜ï¼Œå› æ­¤ä¹Ÿå«å®ƒ==åŒ¿åå‡½æ•°==ã€‚

#### å‡½æ•°å‚æ•°çš„é‚£äº›äº‹å„¿

ç”±äºå‡½æ•°åˆ†ä¸º**å£°æ˜**ä¸**ä½¿ç”¨**ä¸¤ä¸ªé˜¶æ®µï¼Œåœ¨ä¸åŒé˜¶æ®µï¼Œå‚æ•°çš„ç§°è°“ä¹Ÿæœ‰ä¸åŒã€‚åœ¨å‡½æ•°å£°æ˜é˜¶æ®µï¼ŒæŠŠå‚æ•°åˆ—è¡¨ä¸­çš„å‚æ•°å«åš**å½¢å¼å‚æ•°**ï¼ˆParameterï¼Œç®€ç§°å½¢å‚ï¼‰ï¼Œåœ¨å‡½æ•°ä½“ä¸­ï¼Œä½¿ç”¨çš„éƒ½æ˜¯å½¢å‚ï¼›è€Œåœ¨å‡½æ•°å®é™…è°ƒç”¨æ—¶ä¼ å…¥çš„å‚æ•°è¢«ç§°ä¸º**å®é™…å‚æ•°**ï¼ˆArgumentï¼Œç®€ç§°å®å‚ï¼‰ã€‚

![](images/image-20240704123547073.png)

å½“å®é™…è°ƒç”¨å‡½æ•°çš„æ—¶å€™ï¼Œå®å‚ä¼šä¼ é€’ç»™å‡½æ•°ï¼Œå¹¶å’Œå½¢å¼å‚æ•°é€ä¸€ç»‘å®šï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®å„ä¸ªå½¢å‚çš„ç±»å‹ä¸æ•°é‡ï¼Œæ¥æ£€æŸ¥ä¼ å…¥çš„å®å‚çš„ç±»å‹ä¸æ•°é‡æ˜¯å¦åŒ¹é…ã€‚åªæœ‰åŒ¹é…ï¼Œç¨‹åºæ‰èƒ½ç»§ç»­æ‰§è¡Œå‡½æ•°è°ƒç”¨ï¼Œå¦åˆ™ç¼–è¯‘å™¨å°±ä¼šæŠ¥é”™ã€‚

Goè¯­è¨€ä¸­ï¼Œå‡½æ•°å‚æ•°ä¼ é€’é‡‡ç”¨æ˜¯å€¼ä¼ é€’çš„æ–¹å¼ã€‚æ‰€è°“â€œ**å€¼ä¼ é€’**â€ï¼Œå°±æ˜¯å°†å®é™…å‚æ•°åœ¨å†…å­˜ä¸­çš„è¡¨ç¤º**==é€ä½æ‹·è´==ï¼ˆBitwise Copyï¼‰**åˆ°å½¢å¼å‚æ•°ä¸­ã€‚å¯¹äºåƒ**æ•´å‹ã€æ•°ç»„ã€ç»“æ„ä½“**è¿™ç±»ç±»å‹ï¼Œå®ƒä»¬çš„å†…å­˜è¡¨ç¤ºå°±æ˜¯å®ƒä»¬è‡ªèº«çš„æ•°æ®å†…å®¹ï¼Œå› æ­¤å½“è¿™äº›ç±»å‹ä½œä¸ºå®å‚ç±»å‹æ—¶ï¼Œå€¼ä¼ é€’æ‹·è´çš„å°±æ˜¯å®ƒä»¬è‡ªèº«ï¼Œä¼ é€’çš„å¼€é”€ä¹Ÿä¸å®ƒä»¬è‡ªèº«çš„å¤§å°æˆæ­£æ¯”ã€‚

ä½†æ˜¯åƒ**stringã€åˆ‡ç‰‡ã€map**è¿™äº›ç±»å‹å°±ä¸æ˜¯äº†ï¼Œå®ƒä»¬çš„å†…å­˜è¡¨ç¤ºå¯¹åº”çš„æ˜¯å®ƒä»¬æ•°æ®å†…å®¹çš„â€œæè¿°ç¬¦â€ã€‚å½“è¿™äº›ç±»å‹ä½œä¸ºå®å‚ç±»å‹æ—¶ï¼Œå€¼ä¼ é€’æ‹·è´çš„ä¹Ÿæ˜¯å®ƒä»¬æ•°æ®å†…å®¹çš„â€œæè¿°ç¬¦â€ï¼Œä¸åŒ…æ‹¬æ•°æ®å†…å®¹æœ¬èº«ï¼Œæ‰€ä»¥è¿™äº›ç±»å‹ä¼ é€’çš„å¼€é”€æ˜¯**å›ºå®š**çš„ï¼Œä¸æ•°æ®å†…å®¹å¤§å°æ— å…³ã€‚è¿™ç§åªæ‹·è´â€œæè¿°ç¬¦â€ï¼Œä¸æ‹·è´å®é™…æ•°æ®å†…å®¹çš„æ‹·è´è¿‡ç¨‹ï¼Œä¹Ÿè¢«ç§°ä¸ºâ€œ**æµ…æ‹·è´**â€ã€‚

ä¸è¿‡å‡½æ•°å‚æ•°çš„ä¼ é€’ä¹Ÿæœ‰ä¸¤ä¸ªä¾‹å¤–ï¼Œå½“å‡½æ•°çš„å½¢å‚ä¸º**æ¥å£ç±»å‹**ï¼Œæˆ–è€…å½¢å‚æ˜¯**å˜é•¿å‚æ•°**æ—¶ï¼Œç®€å•çš„å€¼ä¼ é€’å°±ä¸èƒ½æ»¡è¶³è¦æ±‚äº†ï¼Œè¿™æ—¶Goç¼–è¯‘å™¨ä¼šä»‹å…¥ï¼šå¯¹äºç±»å‹ä¸ºæ¥å£ç±»å‹çš„å½¢å‚ï¼ŒGoç¼–è¯‘å™¨ä¼šæŠŠä¼ é€’çš„å®å‚èµ‹å€¼ç»™å¯¹åº”çš„æ¥å£ç±»å‹å½¢å‚ï¼›å¯¹äºä¸ºå˜é•¿å‚æ•°çš„å½¢å‚ï¼ŒGoç¼–è¯‘å™¨ä¼šå°†é›¶ä¸ªæˆ–å¤šä¸ªå®å‚æŒ‰ä¸€å®šå½¢å¼è½¬æ¢ä¸ºå¯¹åº”çš„å˜é•¿å½¢å‚ã€‚

é‚£ä¹ˆè¿™é‡Œï¼Œé›¶ä¸ªæˆ–å¤šä¸ªä¼ é€’ç»™å˜é•¿å½¢å¼å‚æ•°çš„å®å‚ï¼Œè¢«Goç¼–è¯‘å™¨è½¬æ¢ä¸ºä½•ç§å½¢å¼äº†å‘¢ï¼Ÿ

```go
func myAppend(sl []int, elems ...int) []int {
    fmt.Printf("%T\n", elems) // []int
    if len(elems) == 0 {
        println("no elems to append")
        return sl
    }

    sl = append(sl, elems...)
    return sl
}

func main() {
    sl := []int{1, 2, 3}
    sl = myAppend(sl) // no elems to append
    fmt.Println(sl) // [1 2 3]
    sl = myAppend(sl, 4, 5, 6)
    fmt.Println(sl) // [1 2 3 4 5 6]
}
```

åœ¨Goä¸­ï¼Œ**å˜é•¿å‚æ•°å®é™…ä¸Šæ˜¯é€šè¿‡åˆ‡ç‰‡æ¥å®ç°çš„**ã€‚æ‰€ä»¥ï¼Œåœ¨å‡½æ•°ä½“ä¸­ï¼Œå°±å¯ä»¥**ä½¿ç”¨åˆ‡ç‰‡æ”¯æŒçš„æ‰€æœ‰æ“ä½œæ¥æ“ä½œå˜é•¿å‚æ•°**ï¼Œè¿™ä¼šå¤§å¤§ç®€åŒ–äº†å˜é•¿å‚æ•°çš„ä½¿ç”¨å¤æ‚åº¦ã€‚æ¯”å¦‚myAppendä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨lenå‡½æ•°å°±å¯ä»¥è·å–åˆ°ä¼ ç»™å˜é•¿å‚æ•°çš„å®å‚ä¸ªæ•°ã€‚

#### å‡½æ•°æ”¯æŒå¤šè¿”å›å€¼

```go
func foo()                       // æ— è¿”å›å€¼
func foo() error                 // ä»…æœ‰ä¸€ä¸ªè¿”å›å€¼
func foo() (int, string, error)  // æœ‰2æˆ–2ä¸ªä»¥ä¸Šè¿”å›å€¼
```

==å…·åè¿”å›å€¼==ï¼ˆNamed Return Valueï¼‰å˜é‡å¯ä»¥åƒå‡½æ•°ä½“ä¸­å£°æ˜çš„å±€éƒ¨å˜é‡ä¸€æ ·åœ¨å‡½æ•°ä½“å†…ä½¿ç”¨ã€‚

> æ—¥å¸¸ç¼–ç ä¸­ï¼Œç©¶ç«Ÿè¯¥ä½¿ç”¨æ™®é€šè¿”å›å€¼å½¢å¼ï¼Œè¿˜æ˜¯å…·åè¿”å›å€¼å½¢å¼å‘¢ï¼Ÿ
> 
> **Goæ ‡å‡†åº“ä»¥åŠå¤§å¤šæ•°é¡¹ç›®ä»£ç ä¸­çš„å‡½æ•°ï¼Œéƒ½é€‰æ‹©äº†ä½¿ç”¨æ™®é€šçš„éå…·åè¿”å›å€¼å½¢å¼**ã€‚ä½†åœ¨ä¸€äº›ç‰¹å®šåœºæ™¯ä¸‹ï¼Œå…·åè¿”å›å€¼ä¹Ÿä¼šå¾—åˆ°åº”ç”¨ã€‚æ¯”å¦‚ï¼Œå½“å‡½æ•°ä½¿ç”¨deferï¼Œè€Œä¸”è¿˜åœ¨deferå‡½æ•°ä¸­ä¿®æ”¹å¤–éƒ¨å‡½æ•°è¿”å›å€¼æ—¶ï¼Œå…·åè¿”å›å€¼å¯ä»¥è®©ä»£ç æ˜¾å¾—æ›´ä¼˜é›…æ¸…æ™°ã€‚
> 
> å½“å‡½æ•°çš„è¿”å›å€¼ä¸ªæ•°è¾ƒå¤šæ—¶ï¼Œæ¯æ¬¡æ˜¾å¼ä½¿ç”¨returnè¯­å¥æ—¶éƒ½ä¼šæ¥ä¸€é•¿ä¸²è¿”å›å€¼ï¼Œè¿™æ—¶ï¼Œç”¨å…·åè¿”å›å€¼å¯ä»¥è®©å‡½æ•°å®ç°çš„å¯è¯»æ€§æ›´å¥½ä¸€äº›:
> 
> ```go
> // $GOROOT/src/time/format.go
> func parseNanoseconds(value string, nbytes int) (ns int, rangeErrString string, err error) {
>     if !commaOrPeriod(value[0]) {
>         err = errBad
>         return
>     }
>     if ns, err = atoi(value[1:nbytes]); err != nil {
>         return
>     }
>     if ns < 0 || 1e9 <= ns {
>         rangeErrString = "fractional second"
>         return
>     }
> 
>     scaleDigits := 10 - nbytes
>     for i := 0; i < scaleDigits; i++ {
>         ns *= 10
>     }
>     return
> }  
> ```

### 21.2 å‡½æ•°æ˜¯â€œä¸€ç­‰å…¬æ°‘â€

> wikiå‘æ˜äººã€C2ç«™ç‚¹ä½œè€…[æ²ƒå¾·Â·åå®å®‰(Ward Cunningham)](http://c2.com/)å¯¹â€œä¸€ç­‰å…¬æ°‘â€çš„[è§£é‡Š](http://wiki.c2.com//?FirstClass)ï¼š
> 
> å¦‚æœä¸€é—¨ç¼–ç¨‹è¯­è¨€å¯¹æŸç§è¯­è¨€å…ƒç´ çš„åˆ›å»ºå’Œä½¿ç”¨æ²¡æœ‰é™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åƒå¯¹å¾…å€¼ï¼ˆvalueï¼‰ä¸€æ ·å¯¹å¾…è¿™ç§è¯­æ³•å…ƒç´ ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç§°è¿™ç§è¯­æ³•å…ƒç´ æ˜¯è¿™é—¨ç¼–ç¨‹è¯­è¨€çš„â€œä¸€ç­‰å…¬æ°‘â€ã€‚æ‹¥æœ‰â€œä¸€ç­‰å…¬æ°‘â€å¾…é‡çš„è¯­æ³•å…ƒç´ å¯ä»¥å­˜å‚¨åœ¨å˜é‡ä¸­ï¼Œå¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°ï¼Œå¯ä»¥åœ¨å‡½æ•°å†…éƒ¨åˆ›å»ºå¹¶å¯ä»¥ä½œä¸ºè¿”å›å€¼ä»å‡½æ•°è¿”å›ã€‚

#### ç‰¹å¾ä¸€ï¼šGoå‡½æ•°å¯ä»¥å­˜å‚¨åœ¨å˜é‡ä¸­

```go
var (
    myFprintf = func(w io.Writer, format string, a ...interface{}) (int, error) {
        return fmt.Fprintf(w, format, a...)
    }
)

func main() {
    fmt.Printf("%T\n", myFprintf) // func(io.Writer, string, ...interface {}) (int, error)
    myFprintf(os.Stdout, "%s\n", "Hello, Go") // è¾“å‡ºHelloï¼ŒGo
}
```

#### ç‰¹å¾äºŒï¼šæ”¯æŒåœ¨å‡½æ•°å†…åˆ›å»ºå¹¶é€šè¿‡è¿”å›å€¼è¿”å›ã€‚

```go
func setup(task string) func() {
    println("do some setup stuff for", task)
    return func() {
        println("do some teardown stuff for", task)
    }
}

func main() {
    teardown := setup("demo")
    defer teardown()
    println("do some bussiness stuff")
}
```

è¿™ä¸ªä¾‹å­ï¼Œæ¨¡æ‹Ÿäº†æ‰§è¡Œä¸€äº›é‡è¦é€»è¾‘ä¹‹å‰çš„ä¸Šä¸‹æ–‡å»ºç«‹ï¼ˆsetupï¼‰ï¼Œä»¥åŠä¹‹åçš„ä¸Šä¸‹æ–‡æ‹†é™¤ï¼ˆteardownï¼‰ã€‚åœ¨ä¸€äº›å•å…ƒæµ‹è¯•çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿç»å¸¸ä¼šåœ¨æ‰§è¡ŒæŸäº›ç”¨ä¾‹ä¹‹å‰ï¼Œå»ºç«‹æ­¤æ¬¡æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ï¼ˆsetupï¼‰ï¼Œå¹¶åœ¨è¿™äº›ç”¨ä¾‹æ‰§è¡Œåæ‹†é™¤ä¸Šä¸‹æ–‡ï¼ˆteardownï¼‰ï¼Œé¿å…è¿™æ¬¡æ‰§è¡Œå¯¹åç»­ç”¨ä¾‹æ‰§è¡Œçš„å¹²æ‰°ã€‚

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œåœ¨setupå‡½æ•°ä¸­åˆ›å»ºäº†è¿™æ¬¡æ‰§è¡Œçš„ä¸Šä¸‹æ–‡æ‹†é™¤å‡½æ•°ï¼Œå¹¶é€šè¿‡è¿”å›å€¼çš„å½¢å¼ï¼Œå°†è¿™ä¸ªæ‹†é™¤å‡½æ•°è¿”å›ç»™äº†setupå‡½æ•°çš„è°ƒç”¨è€…ã€‚setupå‡½æ•°çš„è°ƒç”¨è€…ï¼Œåœ¨æ‰§è¡Œå®Œå¯¹åº”è¿™æ¬¡æ‰§è¡Œä¸Šä¸‹æ–‡çš„é‡è¦é€»è¾‘åï¼Œå†è°ƒç”¨setupå‡½æ•°è¿”å›çš„æ‹†é™¤å‡½æ•°ï¼Œå°±å¯ä»¥å®Œæˆå¯¹ä¸Šä¸‹æ–‡çš„æ‹†é™¤äº†ã€‚

setupå‡½æ•°ä¸­åˆ›å»ºçš„æ‹†é™¤å‡½æ•°ä¹Ÿæ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œä½†å’Œå‰é¢çœ‹åˆ°çš„åŒ¿åå‡½æ•°æœ‰ä¸€ä¸ªä¸åŒï¼Œè¿™ä¸ªä¸åŒå°±åœ¨äºè¿™ä¸ªåŒ¿åå‡½æ•°**ä½¿ç”¨äº†å®šä¹‰å®ƒçš„å‡½æ•°setupçš„å±€éƒ¨å˜é‡task**ï¼Œè¿™æ ·çš„åŒ¿åå‡½æ•°åœ¨Goä¸­ä¹Ÿè¢«ç§°ä¸º==é—­åŒ…ï¼ˆClosureï¼‰==ã€‚

é—­åŒ…æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª**åŒ¿åå‡½æ•°æˆ–å«å‡½æ•°å­—é¢å€¼**ï¼Œå®ƒä»¬å¯ä»¥å¼•ç”¨å®ƒçš„åŒ…**è£¹å‡½æ•°**ï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºå®ƒä»¬çš„å‡½æ•°ä¸­å®šä¹‰çš„**å˜**é‡ã€‚ç„¶åï¼Œè¿™äº›å˜é‡åœ¨åŒ…è£¹å‡½æ•°å’ŒåŒ¿åå‡½æ•°ä¹‹é—´**å…±äº«**ï¼Œåªè¦é—­åŒ…å¯ä»¥è¢«è®¿é—®ï¼Œè¿™äº›å…±äº«çš„å˜é‡å°±ä¼šç»§ç»­å­˜åœ¨ã€‚

#### ç‰¹å¾ä¸‰ï¼šä½œä¸ºå‚æ•°ä¼ å…¥å‡½æ•°ã€‚

```go
time.AfterFunc(time.Second*2, func() { println("timer fired") })
```

#### ç‰¹å¾å››ï¼šæ‹¥æœ‰è‡ªå·±çš„ç±»å‹ã€‚

æ¯ä¸ªå‡½æ•°éƒ½å’Œæ•´å‹å€¼ã€å­—ç¬¦ä¸²å€¼ç­‰ä¸€ç­‰å…¬æ°‘ä¸€æ ·ï¼Œæ‹¥æœ‰è‡ªå·±çš„ç±»å‹ï¼Œä¹Ÿå°±æ˜¯==å‡½æ•°ç±»å‹==ã€‚

ä¹Ÿå¯ä»¥åŸºäºå‡½æ•°ç±»å‹æ¥è‡ªå®šä¹‰ç±»å‹ï¼Œå°±åƒåŸºäºæ•´å‹ã€å­—ç¬¦ä¸²ç±»å‹ç­‰ç±»å‹æ¥è‡ªå®šä¹‰ç±»å‹ä¸€æ ·ã€‚

```go
// $GOROOT/src/net/http/server.go
type HandlerFunc func(ResponseWriter, *Request)

// $GOROOT/src/sort/genzfunc.go
type visitFunc func(ast.Node) ast.Visitor
```

### 21.3 å‡½æ•°â€œä¸€ç­‰å…¬æ°‘â€ç‰¹æ€§çš„é«˜æ•ˆè¿ç”¨ğŸ”–

#### åº”ç”¨ä¸€ï¼šå‡½æ•°ç±»å‹çš„å¦™ç”¨

å‡½æ•°ä¹Ÿå¯ä»¥è¢«æ˜¾å¼è½¬å‹ã€‚

#### åº”ç”¨äºŒï¼šåˆ©ç”¨é—­åŒ…ç®€åŒ–å‡½æ•°è°ƒç”¨ã€‚

### æ€è€ƒé¢˜

> è¿˜èƒ½åˆ—ä¸¾å‡ºå…¶ä»–çš„é«˜æ•ˆè¿ç”¨å‡½æ•°â€œä¸€ç­‰å…¬æ°‘â€ç‰¹æ€§çš„ä¾‹å­å—ï¼Ÿ

## 22 å‡½æ•°ï¼šæ€ä¹ˆç»“åˆå¤šè¿”å›å€¼è¿›è¡Œé”™è¯¯å¤„ç†ï¼Ÿ

å¤šè¿”å›å€¼æ˜¯Goè¯­è¨€å‡½æ•°ï¼ŒåŒºåˆ«äºå…¶ä»–ä¸»æµé™æ€ç¼–ç¨‹è¯­è¨€ä¸­å‡½æ•°çš„ä¸€ä¸ªé‡è¦ç‰¹ç‚¹ã€‚

### 22.1 Goè¯­è¨€æ˜¯å¦‚ä½•è¿›è¡Œé”™è¯¯å¤„ç†çš„ï¼Ÿ

Cè¯­è¨€çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œé€šå¸¸ç”¨ä¸€ä¸ªç±»å‹ä¸º**æ•´å‹çš„å‡½æ•°è¿”å›å€¼ä½œä¸ºé”™è¯¯çŠ¶æ€æ ‡è¯†**ï¼Œå‡½æ•°è°ƒç”¨è€…ä¼šåŸºäºå€¼æ¯”è¾ƒçš„æ–¹å¼ï¼Œå¯¹è¿™ä¸€ä»£è¡¨é”™è¯¯çŠ¶æ€çš„è¿”å›å€¼è¿›è¡Œæ£€è§†ã€‚é€šå¸¸ï¼Œè¿™ä¸ªè¿”å›å€¼ä¸º0ï¼Œå°±ä»£è¡¨å‡½æ•°è°ƒç”¨æˆåŠŸï¼›å¦‚æœè¿™ä¸ªè¿”å›å€¼æ˜¯å…¶å®ƒå€¼ï¼Œé‚£å°±ä»£è¡¨å‡½æ•°è°ƒç”¨å‡ºç°é”™è¯¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**å‡½æ•°è°ƒç”¨è€…éœ€è¦æ ¹æ®è¿™ä¸ªè¿”å›å€¼ä»£è¡¨çš„é”™è¯¯çŠ¶æ€ï¼Œæ¥å†³å®šåç»­æ‰§è¡Œå“ªæ¡é”™è¯¯å¤„ç†è·¯å¾„ä¸Šçš„ä»£ç **ã€‚

Cè¯­è¨€çš„è¿™ç§ç®€å•çš„ã€åŸºäºé”™è¯¯å€¼æ¯”è¾ƒçš„é”™è¯¯å¤„ç†æœºåˆ¶æœ‰ä»€ä¹ˆä¼˜ç‚¹å‘¢ï¼Ÿ

- é¦–å…ˆï¼Œå®ƒè®©æ¯ä¸ªå¼€å‘äººå‘˜å¿…é¡»**æ˜¾å¼åœ°å»å…³æ³¨å’Œå¤„ç†æ¯ä¸ªé”™è¯¯**ï¼Œç»è¿‡æ˜¾å¼é”™è¯¯å¤„ç†çš„ä»£ç ä¼šæ›´å¥å£®ï¼Œä¹Ÿä¼šè®©å¼€å‘äººå‘˜å¯¹è¿™äº›ä»£ç æ›´æœ‰ä¿¡å¿ƒã€‚
- å¦å¤–ï¼Œè¿™äº›é”™è¯¯å°±æ˜¯**æ™®é€šçš„å€¼**ï¼Œæ‰€ä»¥ä¸éœ€è¦ç”¨é¢å¤–çš„è¯­è¨€æœºåˆ¶å»å¤„ç†å®ƒä»¬ï¼Œåªéœ€åˆ©ç”¨å·²æœ‰çš„è¯­è¨€æœºåˆ¶ï¼Œåƒå¤„ç†å…¶ä»–æ™®é€šç±»å‹å€¼ä¸€æ ·çš„å»å¤„ç†é”™è¯¯å°±å¯ä»¥äº†ï¼Œè¿™ä¹Ÿè®©ä»£ç æ›´å®¹æ˜“è°ƒè¯•ï¼Œæ›´å®¹æ˜“é’ˆå¯¹æ¯ä¸ªé”™è¯¯å¤„ç†çš„å†³ç­–åˆ†æ”¯è¿›è¡Œæµ‹è¯•è¦†ç›–ã€‚ã€Goç»§æ‰¿äº†è¿™ç§ç®€å•ä¸æ˜¾ç¤ºç»“åˆçš„ç‰¹å¾ã€‘

Cè¿™ç§é”™è¯¯å¤„ç†æœºåˆ¶çš„ç¼ºç‚¹ï¼š

- Cçš„å‡½æ•°æœ€å¤šä»…æ”¯æŒä¸€ä¸ªè¿”å›å€¼ï¼Œå¾ˆå¤šå¼€å‘è€…ä¼šæŠŠè¿™å•ä¸€çš„è¿”å›å€¼â€œä¸€å€¼å¤šç”¨â€ã€‚ä¸€ä¸ªè¿”å›å€¼ï¼Œä¸ä»…è¦æ‰¿è½½å‡½æ•°è¦è¿”å›ç»™**è°ƒç”¨è€…çš„ä¿¡æ¯**ï¼Œåˆè¦æ‰¿è½½å‡½æ•°è°ƒç”¨çš„**æœ€ç»ˆé”™è¯¯çŠ¶æ€**ã€‚
  
  æ¯”å¦‚Cæ ‡å‡†åº“ä¸­çš„fprintfå‡½æ•°ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œå®ƒçš„è¿”å›å€¼è¡¨ç¤ºè¾“å‡ºåˆ°FILEæµä¸­çš„å­—ç¬¦æ•°é‡ï¼Œä½†å¦‚æœå‡ºç°é”™è¯¯ï¼Œè¿™ä¸ªè¿”å›å€¼å°±å˜æˆäº†ä¸€ä¸ªè´Ÿæ•°ï¼Œä»£è¡¨å…·ä½“çš„é”™è¯¯å€¼ã€‚
  
  ```c
  // stdio.h
  int fprintf(FILE * restrict stream, const char * restrict format, ...);
  ```
  
  ç‰¹åˆ«æ˜¯å½“è¿”å›å€¼ä¸ºå…¶ä»–ç±»å‹ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œè¿˜å¾ˆéš¾å°†å®ƒä¸é”™è¯¯çŠ¶æ€èåˆåˆ°ä¸€èµ·ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå¾ˆå¤šCå¼€å‘äººå‘˜è¦ä¹ˆä½¿ç”¨è¾“å‡ºå‚æ•°ï¼Œæ‰¿è½½è¦è¿”å›ç»™è°ƒç”¨è€…çš„ä¿¡æ¯ï¼Œè¦ä¹ˆè‡ªå®šä¹‰ä¸€ä¸ªåŒ…å«è¿”å›ä¿¡æ¯ä¸é”™è¯¯çŠ¶æ€çš„ç»“æ„ä½“ï¼Œä½œä¸ºè¿”å›å€¼ç±»å‹ã€‚å¤§å®¶åšæ³•ä¸ä¸€ï¼Œå°±å¾ˆéš¾å½¢æˆç»Ÿä¸€çš„é”™è¯¯å¤„ç†ç­–ç•¥ã€‚

ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼ŒGoå‡½æ•°å¢åŠ äº†å¤šè¿”å›å€¼æœºåˆ¶ã€‚

```go
// fmtåŒ…
func Fprintf(w io.Writer, format string, a ...interface{}) (n int, err error)
```

Goè¯­è¨€æƒ¯ç”¨æ³•ï¼Œæ˜¯ä½¿ç”¨errorè¿™ä¸ªæ¥å£ç±»å‹è¡¨ç¤ºé”™è¯¯ï¼Œå¹¶ä¸”æŒ‰æƒ¯ä¾‹ï¼Œé€šå¸¸å°†errorç±»å‹è¿”å›å€¼æ”¾**åœ¨è¿”å›å€¼åˆ—è¡¨çš„æœ«å°¾**ã€‚

### 22.2 errorç±»å‹ä¸é”™è¯¯å€¼æ„é€ 

> `error`æ¥å£ç±»å‹ç©¶ç«Ÿå¦‚ä½•è¡¨ç¤ºé”™è¯¯ï¼Ÿ

```go
// $GOROOT/src/builtin/builtin.go
type interface error {
    Error() string
}
```

ä»»ä½•å®ç°äº†errorçš„Erroræ–¹æ³•çš„ç±»å‹çš„å®ä¾‹ï¼Œéƒ½å¯ä»¥ä½œä¸ºé”™è¯¯å€¼èµ‹å€¼ç»™erroræ¥å£å˜é‡ã€‚

ä¸¤ç§æ„é€ é”™è¯¯å€¼çš„æ–¹æ³•ï¼š `errors.New`å’Œ`fmt.Errorf`:

```go
err := errors.New("your first demo error")
errWithCtx = fmt.Errorf("index %d is out of bounds", i)
```

æœªå¯¼å‡ºçš„ç±»å‹å°±æ˜¯`errors.errorString`:

```go
// $GOROOT/src/errors/errors.go
type errorString struct {
    s string
}

func (e *errorString) Error() string {
    return e.s
}
```

ä½†åœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œé”™è¯¯å¤„ç†è€…éœ€è¦ä»é”™è¯¯å€¼ä¸­æå–å‡º**æ›´å¤šä¿¡æ¯**ï¼Œå¸®åŠ©ä»–é€‰æ‹©é”™è¯¯å¤„ç†è·¯å¾„ï¼Œæ˜¾ç„¶è¿™ä¸¤ç§æ–¹æ³•å°±ä¸èƒ½æ»¡è¶³äº†ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥è‡ªå®šä¹‰é”™è¯¯ç±»å‹æ¥æ»¡è¶³è¿™ä¸€éœ€æ±‚ã€‚æ¯”å¦‚ï¼šæ ‡å‡†åº“ä¸­çš„netåŒ…å°±å®šä¹‰äº†ä¸€ç§æºå¸¦é¢å¤–é”™è¯¯ä¸Šä¸‹æ–‡çš„é”™è¯¯ç±»å‹ï¼š

```go
// $GOROOT/src/net/net.go
type OpError struct {
    Op string
    Net string
    Source Addr
    Addr Addr
    Err error
}
```

è¿™æ ·ï¼Œé”™è¯¯å¤„ç†è€…å°±å¯ä»¥æ ¹æ®è¿™ä¸ªç±»å‹çš„é”™è¯¯å€¼æä¾›çš„**é¢å¤–ä¸Šä¸‹æ–‡ä¿¡æ¯**ï¼Œæ¯”å¦‚Opã€Netã€Sourceç­‰ï¼Œåšå‡ºé”™è¯¯å¤„ç†è·¯å¾„çš„é€‰æ‹©ï¼Œæ¯”å¦‚ä¸‹é¢æ ‡å‡†åº“ä¸­çš„ä»£ç ï¼š

```go
// $GOROOT/src/net/http/server.go
func isCommonNetReadError(err error) bool {
    if err == io.EOF {
        return true
    }
    if neterr, ok := err.(net.Error); ok && neterr.Timeout() {
        return true
    }
    if oe, ok := err.(*net.OpError); ok && oe.Op == "read" {
        return true
    }
    return false
}
```

è¿™æ®µä»£ç åˆ©ç”¨==ç±»å‹æ–­è¨€ï¼ˆType Assertionï¼‰==ï¼Œåˆ¤æ–­errorç±»å‹å˜é‡errçš„**åŠ¨æ€ç±»å‹**æ˜¯å¦ä¸º`*net.OpError`æˆ– `net.Error`ã€‚å¦‚æœerrçš„åŠ¨æ€ç±»å‹æ˜¯ `*net.OpError`ï¼Œé‚£ä¹ˆç±»å‹æ–­è¨€å°±ä¼šè¿”å›è¿™ä¸ªåŠ¨æ€ç±»å‹çš„å€¼ï¼ˆå­˜å‚¨åœ¨oeä¸­ï¼‰ï¼Œä»£ç å°±å¯ä»¥é€šè¿‡åˆ¤æ–­å®ƒçš„Opå­—æ®µæ˜¯å¦ä¸º"read"æ¥åˆ¤æ–­å®ƒæ˜¯å¦ä¸ºCommonNetReadç±»å‹çš„é”™è¯¯ã€‚

ä½¿ç”¨errorç±»å‹ï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„æ•´å‹æˆ–å…¶ä»–ç±»å‹ä½œä¸ºé”™è¯¯ç±»å‹ï¼Œä¸‰ç‚¹å¥½å¤„ï¼š

- ç¬¬ä¸€ç‚¹ï¼šç»Ÿä¸€äº†é”™è¯¯ç±»å‹ã€‚
- ç¬¬äºŒç‚¹ï¼šé”™è¯¯æ˜¯å€¼ã€‚ å¯ä»¥åƒæ•´å‹å€¼é‚£æ ·å¯¹é”™è¯¯åšâ€œ==â€å’Œâ€œ!=â€çš„é€»è¾‘æ¯”è¾ƒã€‚
- ç¬¬ä¸‰ç‚¹ï¼šæ˜“æ‰©å±•ï¼Œæ”¯æŒè‡ªå®šä¹‰é”™è¯¯ä¸Šä¸‹æ–‡ã€‚

erroræ¥å£æ˜¯é”™è¯¯å€¼çš„æä¾›è€…ä¸é”™è¯¯å€¼çš„æ£€è§†è€…ä¹‹é—´çš„**å¥‘çº¦**ã€‚erroræ¥å£çš„å®ç°è€…è´Ÿè´£æä¾›**é”™è¯¯ä¸Šä¸‹æ–‡**ï¼Œä¾›è´Ÿè´£é”™è¯¯å¤„ç†çš„ä»£ç ä½¿ç”¨ã€‚è¿™ç§**é”™è¯¯å…·ä½“ä¸Šä¸‹æ–‡ä¸ä½œä¸ºé”™è¯¯å€¼ç±»å‹çš„erroræ¥å£ç±»å‹çš„è§£è€¦**ï¼Œä¹Ÿä½“ç°äº†Goç»„åˆè®¾è®¡å“²å­¦ä¸­â€œ==æ­£äº¤==â€çš„ç†å¿µã€‚

Goè¯­è¨€çš„å‡ ç§é”™è¯¯å¤„ç†çš„æƒ¯ç”¨ç­–ç•¥ï¼Œå­¦ä¹ è¿™äº›ç­–ç•¥å°†æœ‰åŠ©äºæˆ‘ä»¬æå‡å‡½æ•°é”™è¯¯å¤„ç†è®¾è®¡çš„èƒ½åŠ›ã€‚

### ç­–ç•¥ä¸€ï¼šé€æ˜é”™è¯¯å¤„ç†ç­–ç•¥

ç®€å•æ¥è¯´ï¼ŒGoè¯­è¨€ä¸­çš„é”™è¯¯å¤„ç†ï¼Œå°±æ˜¯**æ ¹æ®å‡½æ•°/æ–¹æ³•è¿”å›çš„errorç±»å‹å˜é‡ä¸­æºå¸¦çš„é”™è¯¯å€¼ä¿¡æ¯åšå†³ç­–ï¼Œå¹¶é€‰æ‹©åç»­ä»£ç æ‰§è¡Œè·¯å¾„çš„è¿‡ç¨‹**ã€‚

æœ€ç®€å•çš„é”™è¯¯ç­–ç•¥è«è¿‡äº**å®Œå…¨ä¸å…³å¿ƒè¿”å›é”™è¯¯å€¼æºå¸¦çš„å…·ä½“ä¸Šä¸‹æ–‡ä¿¡æ¯**ï¼Œåªè¦å‘ç”Ÿé”™è¯¯å°±è¿›å…¥å”¯ä¸€çš„é”™è¯¯å¤„ç†æ‰§è¡Œè·¯å¾„ï¼š

```go
err := doSomething()
if err != nil {
    // ä¸å…³å¿ƒerrå˜é‡åº•å±‚é”™è¯¯å€¼æ‰€æºå¸¦çš„å…·ä½“ä¸Šä¸‹æ–‡ä¿¡æ¯
    // æ‰§è¡Œç®€å•é”™è¯¯å¤„ç†é€»è¾‘å¹¶è¿”å›
    ... ...
    return err
}
```

è¿™ä¹Ÿæ˜¯Goè¯­è¨€ä¸­**æœ€å¸¸è§çš„é”™è¯¯å¤„ç†ç­–ç•¥**ï¼Œ80%ä»¥ä¸Šçš„Goé”™è¯¯å¤„ç†æƒ…å½¢éƒ½å¯ä»¥å½’ç±»åˆ°è¿™ç§ç­–ç•¥ä¸‹ã€‚

æ­¤ç§æƒ…å†µï¼Œé”™è¯¯å€¼çš„æ„é€ æ–¹ï¼ˆå¦‚ä¸Šé¢çš„å‡½æ•°doSomethingï¼‰å¯ä»¥ç›´æ¥ä½¿ç”¨Goæ ‡å‡†åº“æä¾›çš„ä¸¤ä¸ªåŸºæœ¬é”™è¯¯å€¼æ„é€ æ–¹æ³•errors.Newå’Œfmt.Errorfæ¥æ„é€ é”™è¯¯å€¼ï¼š

```go
func doSomething(...) error {
    ... ...
    return errors.New("some error occurred")
}
```

è¿™æ ·æ„é€ å‡ºçš„é”™è¯¯å€¼ä»£è¡¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¯¹é”™è¯¯å¤„ç†æ–¹æ˜¯é€æ˜çš„ï¼Œå› æ­¤è¿™ç§ç­–ç•¥ç§°ä¸ºâ€œ**é€æ˜é”™è¯¯å¤„ç†ç­–ç•¥**â€ã€‚

### ç­–ç•¥äºŒï¼šâ€œå“¨å…µâ€é”™è¯¯å¤„ç†ç­–ç•¥ ğŸ”–

å½“é”™è¯¯å¤„ç†æ–¹ä¸èƒ½åªæ ¹æ®â€œé€æ˜çš„é”™è¯¯å€¼â€å°±åšå‡ºé”™è¯¯å¤„ç†è·¯å¾„é€‰å–çš„æƒ…å†µä¸‹ï¼Œé”™è¯¯å¤„ç†æ–¹ä¼šå°è¯•å¯¹è¿”å›çš„é”™è¯¯å€¼è¿›è¡Œæ£€è§†ï¼Œäºæ˜¯å°±æœ‰å¯èƒ½å‡ºç°ä¸‹é¢ä»£ç ä¸­çš„**åæ¨¡å¼**ï¼š

```go
data, err := b.Peek(1)
if err != nil {
    switch err.Error() {
    case "bufio: negative count":
        // ... ...
        return
    case "bufio: buffer full":
        // ... ...
        return
    case "bufio: invalid use of UnreadByte":
        // ... ...
        return
    default:
        // ... ...
        return
    }
}
```

ç®€å•æ¥è¯´ï¼Œåæ¨¡å¼å°±æ˜¯ï¼Œ**é”™è¯¯å¤„ç†æ–¹ä»¥é€æ˜é”™è¯¯å€¼æ‰€èƒ½æä¾›çš„å”¯ä¸€ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆæè¿°é”™è¯¯çš„å­—ç¬¦ä¸²ï¼‰ï¼Œä½œä¸ºé”™è¯¯å¤„ç†è·¯å¾„é€‰æ‹©çš„ä¾æ®**ã€‚

ä½†è¿™ç§â€œåæ¨¡å¼â€ä¼šé€ æˆä¸¥é‡çš„**éšå¼è€¦åˆ**ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œé”™è¯¯å€¼æ„é€ æ–¹ä¸ç»æ„é—´çš„ä¸€æ¬¡é”™è¯¯æè¿°å­—ç¬¦ä¸²çš„æ”¹åŠ¨ï¼Œéƒ½ä¼šé€ æˆé”™è¯¯å¤„ç†æ–¹å¤„ç†è¡Œä¸ºçš„å˜åŒ–ï¼Œå¹¶ä¸”è¿™ç§é€šè¿‡å­—ç¬¦ä¸²æ¯”è¾ƒçš„æ–¹å¼ï¼Œå¯¹é”™è¯¯å€¼è¿›è¡Œæ£€è§†çš„æ€§èƒ½ä¹Ÿå¾ˆå·®ã€‚

é‚£è¿™æœ‰ä»€ä¹ˆåŠæ³•å—ï¼Ÿ

Goæ ‡å‡†åº“é‡‡ç”¨äº†å®šä¹‰å¯¼å‡ºçš„ï¼ˆExportedï¼‰â€œå“¨å…µâ€é”™è¯¯å€¼çš„æ–¹å¼ï¼Œæ¥è¾…åŠ©é”™è¯¯å¤„ç†æ–¹æ£€è§†ï¼ˆinspectï¼‰é”™è¯¯å€¼å¹¶åšå‡ºé”™è¯¯å¤„ç†åˆ†æ”¯çš„å†³ç­–ï¼Œæ¯”å¦‚ä¸‹é¢çš„bufioåŒ…ä¸­å®šä¹‰çš„â€œå“¨å…µé”™è¯¯â€ï¼š

```go
// $GOROOT/src/bufio/bufio.go
var (
    ErrInvalidUnreadByte = errors.New("bufio: invalid use of UnreadByte")
    ErrInvalidUnreadRune = errors.New("bufio: invalid use of UnreadRune")
    ErrBufferFull        = errors.New("bufio: buffer full")
    ErrNegativeCount     = errors.New("bufio: negative count")
)
```

```go
data, err := b.Peek(1)
if err != nil {
    switch err {
    case bufio.ErrNegativeCount:
        // ... ...
        return
    case bufio.ErrBufferFull:
        // ... ...
        return
    case bufio.ErrInvalidUnreadByte:
        // ... ...
        return
    default:
        // ... ...
        return
    }
}
```

ä¸€èˆ¬â€œå“¨å…µâ€é”™è¯¯å€¼å˜é‡ä»¥ErrXXXæ ¼å¼å‘½åã€‚å’Œé€æ˜é”™è¯¯ç­–ç•¥ç›¸æ¯”ï¼Œâ€œå“¨å…µâ€ç­–ç•¥è®©é”™è¯¯å¤„ç†æ–¹åœ¨æœ‰æ£€è§†é”™è¯¯å€¼çš„éœ€æ±‚æ—¶å€™ï¼Œå¯ä»¥â€œæœ‰çš„æ”¾çŸ¢â€ã€‚

ä¸è¿‡ï¼Œå¯¹äºAPIçš„å¼€å‘è€…è€Œè¨€ï¼Œæš´éœ²â€œå“¨å…µâ€é”™è¯¯å€¼ä¹Ÿæ„å‘³ç€è¿™äº›**é”™è¯¯å€¼å’ŒåŒ…çš„å…¬å…±å‡½æ•°/æ–¹æ³•ä¸€èµ·æˆä¸ºäº†APIçš„ä¸€éƒ¨åˆ†**ã€‚ä¸€æ—¦å‘å¸ƒå‡ºå»ï¼Œå¼€å‘è€…å°±è¦å¯¹å®ƒè¿›è¡Œå¾ˆå¥½çš„ç»´æŠ¤ã€‚è€Œâ€œå“¨å…µâ€é”™è¯¯å€¼ä¹Ÿè®©ä½¿ç”¨è¿™äº›å€¼çš„é”™è¯¯å¤„ç†æ–¹å¯¹å®ƒäº§ç”Ÿäº†ä¾èµ–ã€‚

ä»Go 1.13ç‰ˆæœ¬å¼€å§‹ï¼Œæ ‡å‡†åº“errorsåŒ…æä¾›äº†`Is`å‡½æ•°ç”¨äºé”™è¯¯å¤„ç†æ–¹å¯¹é”™è¯¯å€¼çš„æ£€è§†ã€‚Iså‡½æ•°ç±»ä¼¼äºæŠŠä¸€ä¸ªerrorç±»å‹å˜é‡ä¸â€œå“¨å…µâ€é”™è¯¯å€¼è¿›è¡Œæ¯”è¾ƒ:

```go
// ç±»ä¼¼ if err == ErrOutOfBounds{ â€¦ }
if errors.Is(err, ErrOutOfBounds) {
    // è¶Šç•Œçš„é”™è¯¯å¤„ç†
} 
```

ä¸åŒçš„æ˜¯ï¼Œå¦‚æœerrorç±»å‹å˜é‡çš„åº•å±‚é”™è¯¯å€¼æ˜¯ä¸€ä¸ª**åŒ…è£…é”™è¯¯ï¼ˆWrapped Errorï¼‰**ï¼Œerrors.Isæ–¹æ³•ä¼šæ²¿ç€è¯¥åŒ…è£…é”™è¯¯æ‰€åœ¨**é”™è¯¯é“¾ï¼ˆError Chain)**ï¼Œä¸é“¾ä¸Šæ‰€æœ‰è¢«åŒ…è£…çš„é”™è¯¯ï¼ˆWrapped Errorï¼‰è¿›è¡Œæ¯”è¾ƒï¼Œç›´è‡³æ‰¾åˆ°ä¸€ä¸ªåŒ¹é…çš„é”™è¯¯ä¸ºæ­¢ã€‚

```go
var ErrSentinel = errors.New("the underlying sentinel error")

func main() {
    err1 := fmt.Errorf("wrap sentinel: %w", ErrSentinel)
    err2 := fmt.Errorf("wrap err1: %w", err1)
  println(err2 == ErrSentinel) //false
    if errors.Is(err2, ErrSentinel) {
        println("err2 is ErrSentinel")
        return
    }

    println("err2 is not ErrSentinel")
}
```

è¿™é‡Œé€šè¿‡fmt.Errorfå‡½æ•°ï¼Œå¹¶ä¸”ä½¿ç”¨%wåˆ›å»ºåŒ…è£…é”™è¯¯å˜é‡err1å’Œerr2ï¼Œå…¶ä¸­err1å®ç°äº†å¯¹ErrSentinelè¿™ä¸ªâ€œå“¨å…µé”™è¯¯å€¼â€çš„åŒ…è£…ï¼Œè€Œerr2åˆå¯¹err1è¿›è¡Œäº†åŒ…è£…ï¼Œè¿™æ ·å°±å½¢æˆäº†ä¸€æ¡é”™è¯¯é“¾ã€‚ä½äºé”™è¯¯é“¾æœ€ä¸Šå±‚çš„æ˜¯err2ï¼Œä½äºæœ€åº•å±‚çš„æ˜¯ErrSentinelã€‚ä¹‹åï¼Œå†åˆ†åˆ«é€šè¿‡å€¼æ¯”è¾ƒå’Œerrors.Isè¿™ä¸¤ç§æ–¹æ³•ï¼Œåˆ¤æ–­err2ä¸ErrSentinelçš„å…³ç³»ã€‚

### ç­–ç•¥ä¸‰ï¼šé”™è¯¯å€¼ç±»å‹æ£€è§†ç­–ç•¥

å¦‚æœé‡åˆ°é”™è¯¯å¤„ç†æ–¹éœ€è¦é”™è¯¯å€¼æä¾›æ›´å¤šçš„â€œé”™è¯¯ä¸Šä¸‹æ–‡â€çš„æƒ…å†µï¼Œé‚£ä¹ˆå°±é€šè¿‡**è‡ªå®šä¹‰é”™è¯¯ç±»å‹çš„æ„é€ é”™è¯¯å€¼**çš„æ–¹å¼æ¥å®ç°ã€‚

ç”±äºé”™è¯¯å€¼éƒ½é€šè¿‡erroræ¥å£å˜é‡ç»Ÿä¸€å‘ˆç°ï¼Œè¦å¾—åˆ°åº•å±‚é”™è¯¯ç±»å‹æºå¸¦çš„é”™è¯¯ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œé”™è¯¯å¤„ç†æ–¹éœ€è¦ä½¿ç”¨Goæä¾›çš„==ç±»å‹æ–­è¨€æœºåˆ¶ï¼ˆType Assertionï¼‰==æˆ–==ç±»å‹é€‰æ‹©æœºåˆ¶ï¼ˆType Switchï¼‰==ï¼Œè¿™ç§é”™è¯¯å¤„ç†æ–¹å¼ï¼Œå¯ç§°ä¹‹ä¸º**é”™è¯¯å€¼ç±»å‹æ£€è§†ç­–ç•¥**ã€‚

```go
// $GOROOT/src/encoding/json/decode.go
type UnmarshalTypeError struct {
    Value  string       
    Type   reflect.Type 
    Offset int64        
    Struct string       
    Field  string      
}

func (d *decodeState) addErrorContext(err error) error {
    if d.errorContext.Struct != nil || len(d.errorContext.FieldStack) > 0 {
        switch err := err.(type) {
        case *UnmarshalTypeError:
            err.Struct = d.errorContext.Struct.Name()
            err.Field = strings.Join(d.errorContext.FieldStack, ".")
            return err
        }
    }
    return err
} 
```

è¿™æ®µä»£ç é€šè¿‡ç±»å‹switchè¯­å¥å¾—åˆ°äº†errå˜é‡ä»£è¡¨çš„åŠ¨æ€ç±»å‹å’Œå€¼ï¼Œç„¶ååœ¨åŒ¹é…çš„caseåˆ†æ”¯ä¸­åˆ©ç”¨é”™è¯¯ä¸Šä¸‹æ–‡ä¿¡æ¯è¿›è¡Œå¤„ç†ã€‚

ä»Go 1.13ç‰ˆæœ¬å¼€å§‹ï¼Œæ ‡å‡†åº“errorsåŒ…æä¾›äº†`As`å‡½æ•°ç»™é”™è¯¯å¤„ç†æ–¹æ£€è§†é”™è¯¯å€¼ã€‚Aså‡½æ•°ç±»ä¼¼äºé€šè¿‡ç±»å‹æ–­è¨€åˆ¤æ–­ä¸€ä¸ªerrorç±»å‹å˜é‡æ˜¯å¦ä¸ºç‰¹å®šçš„è‡ªå®šä¹‰é”™è¯¯ç±»å‹:

```go
// ç±»ä¼¼ if e, ok := err.(*MyError); ok { â€¦ }
var e *MyError
if errors.As(err, &e) {
    // å¦‚æœerrç±»å‹ä¸º*MyErrorï¼Œå˜é‡eå°†è¢«è®¾ç½®ä¸ºå¯¹åº”çš„é”™è¯¯å€¼
}
```

ä¸åŒçš„æ˜¯ï¼Œå¦‚æœerrorç±»å‹å˜é‡çš„åŠ¨æ€é”™è¯¯å€¼æ˜¯ä¸€ä¸ªåŒ…è£…é”™è¯¯ï¼Œerrors.Aså‡½æ•°ä¼šæ²¿ç€è¯¥åŒ…è£…é”™è¯¯æ‰€åœ¨é”™è¯¯é“¾ï¼Œä¸é“¾ä¸Šæ‰€æœ‰è¢«åŒ…è£…çš„é”™è¯¯çš„ç±»å‹è¿›è¡Œæ¯”è¾ƒï¼Œç›´è‡³æ‰¾åˆ°ä¸€ä¸ªåŒ¹é…çš„é”™è¯¯ç±»å‹ï¼Œå°±åƒerrors.Iså‡½æ•°é‚£æ ·ã€‚

```go
type MyError struct {
    e string
}

func (e *MyError) Error() string {
    return e.e
}

func main() {
    var err = &MyError{"MyError error demo"}
    err1 := fmt.Errorf("wrap err: %w", err)
    err2 := fmt.Errorf("wrap err1: %w", err1)
    var e *MyError
    if errors.As(err2, &e) {
        println("MyError is on the chain of err2")
        println(e == err)                  
        return                             
    }                                      
    println("MyError is not on the chain of err2")
} 
```

### ç­–ç•¥å››ï¼šé”™è¯¯è¡Œä¸ºç‰¹å¾æ£€è§†ç­–ç•¥

é™¤äº†ç¬¬ä¸€ç§ç­–ç•¥æœ‰æ•ˆé™ä½äº†é”™è¯¯çš„æ„é€ æ–¹ä¸é”™è¯¯å¤„ç†æ–¹ä¸¤è€…ä¹‹é—´çš„è€¦åˆã€‚å…¶å®ƒä¸¤ç§ç­–ç•¥ä¾ç„¶åœ¨é”™è¯¯çš„æ„é€ æ–¹ä¸é”™è¯¯å¤„ç†æ–¹ä¸¤è€…ä¹‹é—´å»ºç«‹äº†è€¦åˆã€‚

é”™è¯¯è¡Œä¸ºç‰¹å¾æ£€è§†ç­–ç•¥ï¼š**å°†æŸä¸ªåŒ…ä¸­çš„é”™è¯¯ç±»å‹å½’ç±»ï¼Œç»Ÿä¸€æå–å‡ºä¸€äº›å…¬å…±çš„é”™è¯¯è¡Œä¸ºç‰¹å¾ï¼Œå¹¶å°†è¿™äº›é”™è¯¯è¡Œä¸ºç‰¹å¾æ”¾å…¥ä¸€ä¸ªå…¬å¼€çš„æ¥å£ç±»å‹ä¸­**ã€‚

ä»¥æ ‡å‡†åº“ä¸­çš„netåŒ…ä¸ºä¾‹ï¼Œå®ƒå°†åŒ…å†…çš„æ‰€æœ‰é”™è¯¯ç±»å‹çš„å…¬å…±è¡Œä¸ºç‰¹å¾æŠ½è±¡å¹¶æ”¾å…¥net.Errorè¿™ä¸ªæ¥å£ä¸­ï¼š

```go
// $GOROOT/src/net/net.go
type Error interface {
    error
    Timeout() bool  
    Temporary() bool
}
```

net.Erroræ¥å£åŒ…å«ä¸¤ä¸ªç”¨äºåˆ¤æ–­é”™è¯¯è¡Œä¸ºç‰¹å¾çš„æ–¹æ³•ï¼šTimeoutç”¨æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è¶…æ—¶ï¼ˆTimeoutï¼‰é”™è¯¯ï¼ŒTemporaryç”¨äºåˆ¤æ–­æ˜¯å¦æ˜¯ä¸´æ—¶ï¼ˆTemporaryï¼‰é”™è¯¯ã€‚

è€Œé”™è¯¯å¤„ç†æ–¹åªéœ€è¦ä¾èµ–è¿™ä¸ªå…¬å…±æ¥å£ï¼Œå°±å¯ä»¥æ£€è§†å…·ä½“é”™è¯¯å€¼çš„é”™è¯¯è¡Œä¸ºç‰¹å¾ä¿¡æ¯ï¼Œå¹¶æ ¹æ®è¿™äº›ä¿¡æ¯åšå‡ºåç»­é”™è¯¯å¤„ç†åˆ†æ”¯é€‰æ‹©çš„å†³ç­–ã€‚

```go
// $GOROOT/src/net/http/server.go
func (srv *Server) Serve(l net.Listener) error {
    ... ...
    for {
        rw, e := l.Accept()
        if e != nil {
            select {
            case <-srv.getDoneChan():
                return ErrServerClosed
            default:
            }
            if ne, ok := e.(net.Error); ok && ne.Temporary() {
                // æ³¨ï¼šè¿™é‡Œå¯¹ä¸´æ—¶æ€§(temporary)é”™è¯¯è¿›è¡Œå¤„ç†
                ... ...
                time.Sleep(tempDelay)
                continue
            }
            return e
        }
        ...
    }
    ... ...
}
```

Acceptæ–¹æ³•å®é™…ä¸Šè¿”å›çš„é”™è¯¯ç±»å‹ä¸º*OpErrorï¼Œå®ƒæ˜¯netåŒ…ä¸­çš„ä¸€ä¸ªè‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼Œå®ƒå®ç°äº†é”™è¯¯å…¬å…±ç‰¹å¾æ¥å£net.Error:

```go
// $GOROOT/src/net/net.go
type OpError struct {
    ... ...
    // Err is the error that occurred during the operation.
    Err error
}

type temporary interface {
    Temporary() bool
}

func (e *OpError) Temporary() bool {
  if ne, ok := e.Err.(*os.SyscallError); ok {
      t, ok := ne.Err.(temporary)
      return ok && t.Temporary()
  }
  t, ok := e.Err.(temporary)
  return ok && t.Temporary()
}
```

é”™è¯¯å¤„ç†ç­–ç•¥é€‰æ‹©ä¸Šçš„å»ºè®®ï¼š

- è¯·å°½é‡ä½¿ç”¨â€œé€æ˜é”™è¯¯â€å¤„ç†ç­–ç•¥ï¼Œé™ä½é”™è¯¯å¤„ç†æ–¹ä¸é”™è¯¯å€¼æ„é€ æ–¹ä¹‹é—´çš„è€¦åˆï¼›
- å¦‚æœå¯ä»¥é€šè¿‡é”™è¯¯å€¼ç±»å‹çš„ç‰¹å¾è¿›è¡Œé”™è¯¯æ£€è§†ï¼Œé‚£ä¹ˆè¯·å°½é‡ä½¿ç”¨â€œé”™è¯¯è¡Œä¸ºç‰¹å¾æ£€è§†ç­–ç•¥â€;
- åœ¨ä¸Šè¿°ä¸¤ç§ç­–ç•¥æ— æ³•å®æ–½çš„æƒ…å†µä¸‹ï¼Œå†ä½¿ç”¨â€œå“¨å…µâ€ç­–ç•¥å’Œâ€œé”™è¯¯å€¼ç±»å‹æ£€è§†â€ç­–ç•¥ï¼›
- Go 1.13åŠåç»­ç‰ˆæœ¬ä¸­ï¼Œå°½é‡ç”¨errors.Iså’Œerrors.Aså‡½æ•°æ›¿æ¢åŸå…ˆçš„é”™è¯¯æ£€è§†æ¯”è¾ƒè¯­å¥ã€‚

## 23 å‡½æ•°ï¼šæ€ä¹ˆè®©å‡½æ•°æ›´ç®€æ´å¥å£®ï¼Ÿ

å¥å£®çš„å‡½æ•°æ„å‘³ç€ï¼Œ**æ— è®ºè°ƒç”¨è€…å¦‚ä½•ä½¿ç”¨ä½ çš„å‡½æ•°ï¼Œå®ƒéƒ½èƒ½ä»¥åˆç†çš„æ–¹å¼å¤„ç†è°ƒç”¨è€…çš„ä»»ä½•è¾“å…¥ï¼Œå¹¶ç»™è°ƒç”¨è€…è¿”å›é¢„è®¾çš„ã€æ¸…æ™°çš„é”™è¯¯å€¼**ã€‚å³ä¾¿ä½ çš„å‡½æ•°å‘ç”Ÿå†…éƒ¨å¼‚å¸¸ï¼Œå‡½æ•°ä¹Ÿä¼šå°½åŠ›ä»å¼‚å¸¸ä¸­æ¢å¤ï¼Œå°½å¯èƒ½åœ°ä¸è®©å¼‚å¸¸è”“å»¶åˆ°æ•´ä¸ªç¨‹åºã€‚

è€Œç®€æ´ä¼˜é›…ï¼Œåˆ™æ„å‘³ç€å‡½æ•°çš„å®ç°æ˜“è¯»ã€æ˜“ç†è§£ã€æ›´æ˜“ç»´æŠ¤ï¼ŒåŒæ—¶ç®€æ´ä¹Ÿæ„å‘³ç€ç»Ÿè®¡æ„ä¹‰ä¸Šçš„æ›´å°‘çš„bugã€‚

### 23.1 å¥å£®æ€§çš„â€œä¸‰ä¸è¦â€åŸåˆ™

- åŸåˆ™ä¸€ï¼šä¸è¦ç›¸ä¿¡ä»»ä½•å¤–éƒ¨è¾“å…¥çš„å‚æ•°ã€‚
- åŸåˆ™äºŒï¼šä¸è¦å¿½ç•¥ä»»ä½•ä¸€ä¸ªé”™è¯¯ã€‚

å¯¹åº”å‡½æ•°å®ç°ä¸­ï¼Œå¯¹æ ‡å‡†åº“æˆ–ç¬¬ä¸‰æ–¹åŒ…æä¾›çš„å‡½æ•°æˆ–æ–¹æ³•è°ƒç”¨ï¼Œä¸èƒ½å‡å®šå®ƒä¸€å®šä¼šæˆåŠŸï¼Œ**ä¸€å®šè¦æ˜¾å¼åœ°æ£€æŸ¥è¿™äº›è°ƒç”¨è¿”å›çš„é”™è¯¯å€¼**ã€‚ä¸€æ—¦å‘ç°é”™è¯¯ï¼Œè¦åŠæ—¶ç»ˆæ­¢å‡½æ•°æ‰§è¡Œï¼Œé˜²æ­¢é”™è¯¯ç»§ç»­ä¼ æ’­ã€‚

- åŸåˆ™ä¸‰ï¼šä¸è¦å‡å®šå¼‚å¸¸ä¸ä¼šå‘ç”Ÿã€‚

**å¼‚å¸¸ä¸æ˜¯é”™è¯¯**ã€‚é”™è¯¯æ˜¯å¯é¢„æœŸçš„ï¼Œä¹Ÿæ˜¯ç»å¸¸ä¼šå‘ç”Ÿçš„ï¼Œæˆ‘ä»¬æœ‰å¯¹åº”çš„å…¬å¼€é”™è¯¯ç å’Œé”™è¯¯å¤„ç†é¢„æ¡ˆï¼Œä½†å¼‚å¸¸å´æ˜¯å°‘è§çš„ã€æ„æ–™ä¹‹å¤–çš„ã€‚é€šå¸¸æ„ä¹‰ä¸Šçš„å¼‚å¸¸ï¼ŒæŒ‡çš„æ˜¯ç¡¬ä»¶å¼‚å¸¸ã€æ“ä½œç³»ç»Ÿå¼‚å¸¸ã€è¯­è¨€è¿è¡Œæ—¶å¼‚å¸¸ï¼Œè¿˜æœ‰æ›´å¤§å¯èƒ½æ˜¯ä»£ç ä¸­æ½œåœ¨bugå¯¼è‡´çš„å¼‚å¸¸ï¼Œæ¯”å¦‚ä»£ç ä¸­å‡ºç°äº†ä»¥0ä½œä¸ºåˆ†æ¯ï¼Œæˆ–è€…æ˜¯æ•°ç»„è¶Šç•Œè®¿é—®ç­‰æƒ…å†µã€‚

### 23.2 è®¤è¯†Goè¯­è¨€ä¸­çš„å¼‚å¸¸ï¼španic

åœ¨Goä¸­ï¼Œpanicä¸»è¦æœ‰ä¸¤ç±»æ¥æºï¼Œä¸€ç±»æ˜¯æ¥è‡ª**Goè¿è¡Œæ—¶**ï¼Œå¦ä¸€ç±»åˆ™æ˜¯**Goå¼€å‘äººå‘˜é€šè¿‡panicå‡½æ•°ä¸»åŠ¨è§¦å‘çš„**ã€‚

æ— è®ºæ˜¯å“ªç§ï¼Œä¸€æ—¦panicè¢«è§¦å‘ï¼Œåç»­Goç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¿™ä¸ªè¿‡ç¨‹è¢«Goè¯­è¨€ç§°ä¸º**==panicking==**ã€‚

å½“å‡½æ•°Fè°ƒç”¨panicå‡½æ•°æ—¶ï¼Œå‡½æ•°Fçš„æ‰§è¡Œå°†åœæ­¢ã€‚ä¸è¿‡ï¼Œå‡½æ•°Fä¸­å·²è¿›è¡Œæ±‚å€¼çš„deferredå‡½æ•°éƒ½ä¼šå¾—åˆ°æ­£å¸¸æ‰§è¡Œï¼Œæ‰§è¡Œå®Œè¿™äº›deferredå‡½æ•°åï¼Œå‡½æ•°Fæ‰ä¼šæŠŠæ§åˆ¶æƒè¿”è¿˜ç»™å…¶è°ƒç”¨è€…ã€‚

å¯¹äºå‡½æ•°Fçš„è°ƒç”¨è€…è€Œè¨€ï¼Œå‡½æ•°Fä¹‹åçš„è¡Œä¸ºå°±å¦‚åŒè°ƒç”¨è€…è°ƒç”¨çš„å‡½æ•°æ˜¯panicä¸€æ ·ï¼Œè¯¥panickingè¿‡ç¨‹å°†ç»§ç»­åœ¨æ ˆä¸Šè¿›è¡Œä¸‹å»ï¼Œç›´åˆ°å½“å‰Goroutineä¸­çš„æ‰€æœ‰å‡½æ•°éƒ½è¿”å›ä¸ºæ­¢ï¼Œç„¶åGoç¨‹åºå°†å´©æºƒé€€å‡ºã€‚

```go
func foo() {
    println("call foo")
    bar()
    println("exit foo")
}

func bar() {
    println("call bar")
    panic("panic occurs in bar")  // è°ƒç”¨panicå‡½æ•°æ‰‹åŠ¨è§¦å‘äº†panic
    zoo()
    println("exit bar")
}

func zoo() {
    println("call zoo")
    println("exit zoo")
}

func main() {
    println("call main")
    foo()
    println("exit main")
}
```

å‡½æ•°çš„è°ƒç”¨æ¬¡åºä¾æ¬¡ä¸ºmain -> foo ->bar -> zooã€‚åœ¨barå‡½æ•°ä¸­ï¼Œè°ƒç”¨panicå‡½æ•°æ‰‹åŠ¨è§¦å‘äº†panicã€‚ç»“æœä¸ºï¼š

```
call main
call foo
call bar
panic: panic occurs in bar
```

panickingè¿‡ç¨‹:

- ç¨‹åºä»å…¥å£å‡½æ•°mainå¼€å§‹ä¾æ¬¡è°ƒç”¨äº†fooã€barå‡½æ•°ï¼Œåœ¨barå‡½æ•°ä¸­ï¼Œä»£ç åœ¨è°ƒç”¨zooå‡½æ•°ä¹‹å‰è°ƒç”¨äº†panicå‡½æ•°è§¦å‘äº†å¼‚å¸¸ã€‚é‚£ç¤ºä¾‹çš„panickingè¿‡ç¨‹å°±ä»è¿™å¼€å§‹äº†ã€‚barå‡½æ•°è°ƒç”¨panicå‡½æ•°ä¹‹åï¼Œå®ƒè‡ªèº«çš„æ‰§è¡Œå°±æ­¤åœæ­¢äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿæ²¡æœ‰çœ‹åˆ°ä»£ç ç»§ç»­è¿›å…¥zooå‡½æ•°æ‰§è¡Œã€‚å¹¶ä¸”ï¼Œbarå‡½æ•°æ²¡æœ‰æ•æ‰è¿™ä¸ªpanicï¼Œè¿™æ ·è¿™ä¸ªpanicå°±ä¼šæ²¿ç€å‡½æ•°è°ƒç”¨æ ˆå‘ä¸Šèµ°ï¼Œæ¥åˆ°äº†barå‡½æ•°çš„è°ƒç”¨è€…fooå‡½æ•°ä¸­ã€‚
- ä»fooå‡½æ•°çš„è§†è§’æ¥çœ‹ï¼Œ**è¿™å°±å¥½æ¯”å°†å®ƒå¯¹barå‡½æ•°çš„è°ƒç”¨ï¼Œæ¢æˆäº†å¯¹panicå‡½æ•°çš„è°ƒç”¨ä¸€æ ·**ã€‚è¿™æ ·ä¸€æ¥ï¼Œfooå‡½æ•°çš„æ‰§è¡Œä¹Ÿè¢«åœæ­¢äº†ã€‚ç”±äºfooå‡½æ•°ä¹Ÿæ²¡æœ‰æ•æ‰panicï¼Œäºæ˜¯panicç»§ç»­æ²¿ç€å‡½æ•°è°ƒç”¨æ ˆå‘ä¸Šèµ°ï¼Œæ¥åˆ°äº†fooå‡½æ•°çš„è°ƒç”¨è€…mainå‡½æ•°ä¸­ã€‚
- åŒç†ï¼Œä»mainå‡½æ•°çš„è§†è§’æ¥çœ‹ï¼Œè¿™å°±å¥½æ¯”å°†å®ƒå¯¹fooå‡½æ•°çš„è°ƒç”¨ï¼Œæ¢æˆäº†å¯¹panicå‡½æ•°çš„è°ƒç”¨ä¸€æ ·ã€‚ç»“æœå°±æ˜¯ï¼Œmainå‡½æ•°çš„æ‰§è¡Œä¹Ÿè¢«ç»ˆæ­¢äº†ï¼Œäºæ˜¯æ•´ä¸ªç¨‹åºå¼‚å¸¸é€€å‡ºï¼Œæ—¥å¿—"exit main"ä¹Ÿæ²¡æœ‰å¾—åˆ°è¾“å‡ºçš„æœºä¼šã€‚

å¯ä»¥é€šè¿‡`recover`å‡½æ•°æ¥å®ç°æ•æ‰panicå¹¶æ¢å¤ç¨‹åºæ­£å¸¸æ‰§è¡Œç§©åº:

```go
func bar() {
    defer func() {
        if e := recover(); e != nil {
            fmt.Println("recover the panic:", e)
        }
    }()

    println("call bar")
    panic("panic occurs in bar")
    zoo()
    println("exit bar")
}
```

### 23.3 å¦‚ä½•åº”å¯¹panicï¼Ÿ

#### ç¬¬ä¸€ç‚¹ï¼šè¯„ä¼°ç¨‹åºå¯¹panicçš„å¿å—åº¦

**ä¸åŒåº”ç”¨å¯¹å¼‚å¸¸å¼•èµ·çš„ç¨‹åºå´©æºƒé€€å‡ºçš„å¿å—åº¦æ˜¯ä¸ä¸€æ ·çš„ã€‚**

æ¯”å¦‚ï¼Œä¸€ä¸ªå•æ¬¡è¿è¡Œäºæ§åˆ¶å°çª—å£ä¸­çš„å‘½ä»¤è¡Œäº¤äº’ç±»ç¨‹åºï¼ˆCLIï¼‰ï¼Œå’Œä¸€ä¸ªå¸¸é©»å†…å­˜çš„åç«¯HTTPæœåŠ¡å™¨ç¨‹åºï¼Œå¯¹å¼‚å¸¸å´©æºƒçš„å¿å—åº¦å°±æ˜¯ä¸åŒçš„ã€‚

å‰è€…å³ä¾¿å› å¼‚å¸¸å´©æºƒï¼Œå¯¹ç”¨æˆ·æ¥è¯´ä¹Ÿä»…ä»…æ˜¯å†é‡æ–°è¿è¡Œä¸€æ¬¡è€Œå·²ã€‚ä½†åè€…ä¸€æ—¦å´©æºƒï¼Œå°±å¾ˆå¯èƒ½å¯¼è‡´æ•´ä¸ªç½‘ç«™åœæ­¢æœåŠ¡ã€‚

æ‰€ä»¥ï¼Œ**é’ˆå¯¹å„ç§åº”ç”¨å¯¹panicå¿å—åº¦çš„å·®å¼‚ï¼Œé‡‡å–çš„åº”å¯¹panicçš„ç­–ç•¥ä¹Ÿåº”è¯¥æœ‰ä¸åŒ**ã€‚

ğŸ”–

#### ç¬¬äºŒç‚¹ï¼šæç¤ºæ½œåœ¨bug

ğŸ”–

åœ¨Goæ ‡å‡†åº“ä¸­ï¼Œ**å¤§å¤šæ•°panicçš„ä½¿ç”¨éƒ½æ˜¯å……å½“ç±»ä¼¼æ–­è¨€çš„ä½œç”¨çš„**ã€‚

#### ç¬¬ä¸‰ç‚¹ï¼šä¸è¦æ··æ·†å¼‚å¸¸ä¸é”™è¯¯

### 23.4 ä½¿ç”¨deferç®€åŒ–å‡½æ•°å®ç°

Goè¯­è¨€å¼•å…¥deferçš„åˆè¡·ï¼Œå°±æ˜¯è§£å†³è¿™äº›é—®é¢˜ã€‚é‚£ä¹ˆï¼Œdeferå…·ä½“æ˜¯æ€ä¹ˆè§£å†³è¿™äº›é—®é¢˜çš„å‘¢ï¼Ÿæˆ–è€…è¯´ï¼Œdeferå…·ä½“çš„è¿ä½œæœºåˆ¶æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ

![](images/image-20240710100648693.png)

### 23.5 deferä½¿ç”¨çš„å‡ ä¸ªæ³¨æ„äº‹é¡¹

deferä¸ä»…å¯ä»¥ç”¨æ¥**æ•æ‰å’Œæ¢å¤panic**ï¼Œè¿˜èƒ½è®©å‡½æ•°å˜å¾—**æ›´ç®€æ´å’Œå¥å£®**ã€‚

#### ç¬¬ä¸€ç‚¹ï¼šæ˜ç¡®å“ªäº›å‡½æ•°å¯ä»¥ä½œä¸ºdeferredå‡½æ•°

#### ç¬¬äºŒç‚¹ï¼šæ³¨æ„deferå…³é”®å­—åé¢è¡¨è¾¾å¼çš„æ±‚å€¼æ—¶æœº

#### ç¬¬ä¸‰ç‚¹ï¼šçŸ¥æ™“deferå¸¦æ¥çš„æ€§èƒ½æŸè€—

## 24 æ–¹æ³•ï¼šç†è§£â€œæ–¹æ³•â€çš„æœ¬è´¨

å‡½æ•°æ˜¯Goä»£ç ä¸­çš„åŸºæœ¬åŠŸèƒ½é€»è¾‘å•å…ƒï¼Œå®ƒæ‰¿è½½äº†**Goç¨‹åºçš„æ‰€æœ‰æ‰§è¡Œé€»**è¾‘ã€‚å¯ä»¥è¯´ï¼ŒGoç¨‹åºçš„æ‰§è¡Œæµæœ¬è´¨ä¸Šå°±æ˜¯**åœ¨å‡½æ•°è°ƒç”¨æ ˆä¸­ä¸Šä¸‹æµåŠ¨ï¼Œä»ä¸€ä¸ªå‡½æ•°åˆ°å¦ä¸€ä¸ªå‡½æ•°**ã€‚

### è®¤è¯†Goæ–¹æ³•

Goå¼•å…¥æ–¹æ³•è¿™ä¸€å…ƒç´ ï¼Œå¹¶ä¸æ˜¯è¦æ”¯æŒé¢å‘å¯¹è±¡ç¼–ç¨‹èŒƒå¼ï¼Œè€Œæ˜¯Goè·µè¡Œç»„åˆè®¾è®¡å“²å­¦çš„ä¸€ç§å®ç°å±‚é¢çš„éœ€è¦ã€‚

![](images/image-20240704132750133.png)

**è¿™ä¸ª`receiver`å‚æ•°ä¹Ÿæ˜¯æ–¹æ³•ä¸ç±»å‹ä¹‹é—´çš„çº½å¸¦ï¼Œä¹Ÿæ˜¯æ–¹æ³•ä¸å‡½æ•°çš„æœ€å¤§ä¸åŒã€‚**

Goä¸­çš„æ–¹æ³•å¿…é¡»æ˜¯å½’å±äºä¸€ä¸ªç±»å‹çš„ï¼Œè€Œreceiverå‚æ•°çš„ç±»å‹å°±æ˜¯è¿™ä¸ªæ–¹æ³•å½’å±çš„ç±»å‹ï¼Œæˆ–è€…è¯´è¿™ä¸ªæ–¹æ³•å°±æ˜¯è¿™ä¸ªç±»å‹çš„ä¸€ä¸ªæ–¹æ³•ã€‚

æ–¹æ³•çš„ä¸€èˆ¬å£°æ˜å½¢å¼ï¼š

```go
func (t *Tæˆ–T) MethodName(å‚æ•°åˆ—è¡¨) (è¿”å›å€¼åˆ—è¡¨) {
    // æ–¹æ³•ä½“
}
```

æ— è®ºreceiverå‚æ•°çš„ç±»å‹ä¸º`*T`è¿˜æ˜¯Tï¼Œéƒ½æŠŠä¸€èˆ¬å£°æ˜å½¢å¼ä¸­çš„Tå«åšreceiverå‚æ•°tçš„==åŸºç±»å‹==ã€‚

å¦‚æœtçš„ç±»å‹ä¸ºTï¼Œé‚£ä¹ˆè¯´è¿™ä¸ªæ–¹æ³•æ˜¯ç±»å‹`T`çš„ä¸€ä¸ªæ–¹æ³•ï¼›å¦‚æœtçš„ç±»å‹ä¸º`*T`ï¼Œé‚£ä¹ˆå°±è¯´è¿™ä¸ªæ–¹æ³•æ˜¯ç±»å‹`*T`çš„ä¸€ä¸ªæ–¹æ³•ã€‚

æ¯ä¸ªæ–¹æ³•åªèƒ½æœ‰ä¸€ä¸ªreceiverå‚æ•°ã€‚

> æ–¹æ³•æ¥æ”¶å™¨ï¼ˆreceiverï¼‰å‚æ•°ã€å‡½æ•°/æ–¹æ³•å‚æ•°ï¼Œä»¥åŠè¿”å›å€¼å˜é‡å¯¹åº”çš„ä½œç”¨åŸŸèŒƒå›´ï¼Œéƒ½æ˜¯å‡½æ•°/æ–¹æ³•ä½“å¯¹åº”çš„æ˜¾å¼ä»£ç å—ã€‚

è¿™å°±æ„å‘³ç€ï¼Œreceiveréƒ¨åˆ†çš„å‚æ•°åä¸èƒ½ä¸æ–¹æ³•å‚æ•°åˆ—è¡¨ä¸­çš„å½¢å‚åï¼Œä»¥åŠå…·åè¿”å›å€¼ä¸­çš„å˜é‡åå­˜åœ¨å†²çªï¼Œå¿…é¡»åœ¨è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨åŸŸä¸­å…·æœ‰å”¯ä¸€æ€§ã€‚

å¦‚æœåœ¨æ–¹æ³•ä½“ä¸­ï¼Œæ²¡æœ‰ç”¨åˆ°receiverå‚æ•°ï¼Œä¹Ÿå¯ä»¥çœç•¥receiverçš„å‚æ•°åã€‚

**receiverå‚æ•°çš„åŸºç±»å‹æœ¬èº«ä¸èƒ½ä¸ºæŒ‡é’ˆç±»å‹æˆ–æ¥å£ç±»å‹ã€‚**

```go
type MyInt *int
func (r MyInt) String() string { // rçš„åŸºç±»å‹ä¸ºMyIntï¼Œç¼–è¯‘å™¨æŠ¥é”™ï¼šinvalid receiver type MyInt (MyInt is a pointer type)
    return fmt.Sprintf("%d", *(*int)(r))
}

type MyReader io.Reader
func (r MyReader) Read(p []byte) (int, error) { // rçš„åŸºç±»å‹ä¸ºMyReaderï¼Œç¼–è¯‘å™¨æŠ¥é”™ï¼šinvalid receiver type MyReader (MyReader is an interface type)
    return r.Read(p)
}
```

Goè¦æ±‚ï¼Œ**æ–¹æ³•å£°æ˜(çš„ä½ç½®)è¦ä¸receiverå‚æ•°çš„åŸºç±»å‹å£°æ˜æ”¾åœ¨åŒä¸€ä¸ªåŒ…å†…**ã€‚åŸºäºè¿™ä¸ªçº¦æŸå¯ä»¥å¾—åˆ°ä¸¤ä¸ªæ¨è®ºï¼š

1. ä¸èƒ½ä¸ºåŸç”Ÿç±»å‹ï¼ˆè¯¸å¦‚intã€float64ã€mapç­‰ï¼‰æ·»åŠ æ–¹æ³•ã€‚

```go
func (i int) Foo() string { // ç¼–è¯‘å™¨æŠ¥é”™ï¼šcannot define new methods on non-local type int
    return fmt.Sprintf("%d", i) 
}
```

2. ä¸èƒ½è·¨è¶ŠGoåŒ…ä¸ºå…¶ä»–åŒ…çš„ç±»å‹å£°æ˜æ–°æ–¹æ³•ã€‚

```go
import "net/http"

func (s http.Server) Foo() { // ç¼–è¯‘å™¨æŠ¥é”™ï¼šcannot define new methods on non-local type http.Server
} 
```

ğŸ”–

### æ–¹æ³•çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼ŸğŸ”–

Goè¯­è¨€ä¸­çš„æ–¹æ³•çš„æœ¬è´¨å°±æ˜¯ï¼Œ**ä¸€ä¸ªä»¥æ–¹æ³•çš„receiverå‚æ•°ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°çš„æ™®é€šå‡½æ•°**ã€‚

å·§è§£éš¾é¢˜

## 25 æ–¹æ³•ï¼šæ–¹æ³•é›†åˆä¸å¦‚ä½•é€‰æ‹©receiverç±»å‹ï¼ŸğŸ”–

ç”±äºåœ¨Goè¯­è¨€ä¸­ï¼Œ**æ–¹æ³•æœ¬è´¨ä¸Šå°±æ˜¯å‡½æ•°**ï¼Œæ‰€ä»¥ä¹‹å‰å…³äºå‡½æ•°è®¾è®¡çš„å†…å®¹å¯¹æ–¹æ³•ä¹ŸåŒæ ·é€‚ç”¨ï¼Œæ¯”å¦‚é”™è¯¯å¤„ç†è®¾è®¡ã€é’ˆå¯¹å¼‚å¸¸çš„å¤„ç†ç­–ç•¥ã€ä½¿ç”¨deferæå‡ç®€æ´æ€§ï¼Œç­‰ç­‰ã€‚

### 25.1 receiverå‚æ•°ç±»å‹å¯¹Goæ–¹æ³•çš„å½±å“

### 25.1 é€‰æ‹©receiverå‚æ•°ç±»å‹çš„ç¬¬ä¸€ä¸ªåŸåˆ™

å¦‚æœGoæ–¹æ³•è¦æŠŠå¯¹receiverå‚æ•°ä»£è¡¨çš„ç±»å‹å®ä¾‹çš„ä¿®æ”¹ï¼Œåæ˜ åˆ°åŸç±»å‹å®ä¾‹ä¸Šï¼Œé‚£ä¹ˆåº”è¯¥é€‰æ‹©*Tä½œä¸ºreceiverå‚æ•°çš„ç±»å‹ã€‚

### 25.1 é€‰æ‹©receiverå‚æ•°ç±»å‹çš„ç¬¬äºŒä¸ªåŸåˆ™

### 25.1 æ–¹æ³•é›†åˆ

### 25.1 é€‰æ‹©receiverå‚æ•°ç±»å‹çš„ç¬¬ä¸‰ä¸ªåŸåˆ™

## 26 æ–¹æ³•ï¼šå¦‚ä½•ç”¨ç±»å‹åµŒå…¥æ¨¡æ‹Ÿå®ç°â€œç»§æ‰¿â€ï¼Ÿ

==ç‹¬ç«‹çš„è‡ªå®šä¹‰ç±»å‹==å°±æ˜¯è¿™ä¸ªç±»å‹çš„æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯è‡ªå·±æ˜¾å¼å®ç°çš„ã€‚

Goè¯­è¨€ä¸æ”¯æŒç»å…¸é¢å‘å¯¹è±¡çš„ç¼–ç¨‹èŒƒå¼ä¸è¯­æ³•å…ƒç´ ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œåªæ˜¯å€Ÿç”¨äº†â€œç»§æ‰¿â€è¿™ä¸ªè¯æ±‡è€Œå·²ï¼Œè¯´æ˜¯â€œç»§æ‰¿â€ï¼Œå®åˆ™ä¾æ—§æ˜¯ä¸€ç§**ç»„åˆ**çš„æ€æƒ³ã€‚

è€Œè¿™ç§â€œç»§æ‰¿â€ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡Goè¯­è¨€çš„ç±»å‹åµŒå…¥ï¼ˆType Embeddingï¼‰æ¥å®ç°çš„ã€‚

### 26.1 ä»€ä¹ˆæ˜¯ç±»å‹åµŒå…¥

==ç±»å‹åµŒå…¥ï¼ˆType Embeddingï¼‰==æŒ‡çš„å°±æ˜¯åœ¨ä¸€ä¸ªç±»å‹çš„å®šä¹‰ä¸­åµŒå…¥äº†å…¶ä»–ç±»å‹ã€‚Goè¯­è¨€æ”¯æŒä¸¤ç§ç±»å‹åµŒå…¥ï¼Œåˆ†åˆ«æ˜¯==æ¥å£ç±»å‹çš„ç±»å‹åµŒå…¥==å’Œ==ç»“æ„ä½“ç±»å‹çš„ç±»å‹åµŒå…¥==ã€‚

#### æ¥å£ç±»å‹çš„ç±»å‹åµŒå…¥

```go
type E interface {
  M1()
  M2()
}
```

```go
type I interface {
  M1()
  M2()
  M3()
}
```

```go
type I interface {
  E
  M3()
}
```

æ¥å£ç±»å‹åµŒå…¥çš„è¯­ä¹‰å°±æ˜¯æ–°æ¥å£ç±»å‹ï¼ˆå¦‚æ¥å£ç±»å‹Iï¼‰å°†åµŒå…¥çš„æ¥å£ç±»å‹ï¼ˆå¦‚æ¥å£ç±»å‹Eï¼‰çš„æ–¹æ³•é›†åˆï¼Œå¹¶å…¥åˆ°è‡ªå·±çš„æ–¹æ³•é›†åˆä¸­ã€‚

#### ç»“æ„ä½“ç±»å‹çš„ç±»å‹åµŒå…¥

```go
type T1 int
type t2 struct{
    n int
    m int
}

type I interface {
    M1()
}

type S1 struct {
    T1
    *t2
    I            
    a int
    b string
}
```

ç»“æ„ä½“S1å®šä¹‰ä¸­æœ‰ä¸‰ä¸ªâ€œéå¸¸è§„å½¢å¼â€çš„æ ‡è¯†ç¬¦ï¼Œåˆ†åˆ«æ˜¯T1ã€t2å’ŒIï¼Œå®ƒä»¬**æ—¢ä»£è¡¨å­—æ®µçš„åå­—ï¼Œä¹Ÿä»£è¡¨å­—æ®µçš„ç±»å‹**ã€‚

è¿™ç§ä»¥æŸä¸ªç±»å‹åã€ç±»å‹çš„æŒ‡é’ˆç±»å‹åæˆ–æ¥å£ç±»å‹åï¼Œç›´æ¥ä½œä¸ºç»“æ„ä½“å­—æ®µçš„æ–¹å¼å°±å«åšç»“**æ„ä½“çš„ç±»å‹åµŒå…¥**ï¼Œè¿™äº›å­—æ®µä¹Ÿè¢«å«åš**åµŒå…¥å­—æ®µ**ï¼ˆEmbedded Fieldï¼‰ã€‚

ğŸ”–

#### â€œå®ç°ç»§æ‰¿â€çš„åŸç†

### 26.2 ç±»å‹åµŒå…¥ä¸æ–¹æ³•é›†åˆ

- ç»“æ„ä½“ç±»å‹ä¸­åµŒå…¥æ¥å£ç±»å‹
- ç»“æ„ä½“ç±»å‹ä¸­åµŒå…¥ç»“æ„ä½“ç±»å‹

### 26.3 ç±»å‹ä¸aliasç±»å‹çš„æ–¹æ³•é›†åˆ

Goè¯­è¨€ä¸­ï¼Œå‡¡é€šè¿‡ç±»å‹å£°æ˜è¯­æ³•å£°æ˜çš„ç±»å‹éƒ½è¢«ç§°ä¸º==definedç±»å‹==ã€‚

```go
type I interface {
  M1()
  M2()
}
type T int
type NT T // åŸºäºå·²å­˜åœ¨çš„ç±»å‹Tåˆ›å»ºæ–°çš„definedç±»å‹NT
type NI I // åŸºäºå·²å­˜åœ¨çš„æ¥å£ç±»å‹Iåˆ›å»ºæ–°definedæ¥å£ç±»å‹NI
```

## 27 å³å­¦å³ç»ƒï¼šè·Ÿè¸ªå‡½æ•°è°ƒç”¨é“¾ï¼Œç†è§£ä»£ç æ›´ç›´è§‚

### 27.1 å¼•å­

ä½¿ç”¨deferå¯ä»¥è·Ÿè¸ªå‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹ã€‚

```go
package main

func main() {
    defer Trace("main")()
    foo()
}

func Trace(name string) func() {
    println("enter: ", name)
    return func() {
        println("exit: ", name)
    }
}

func foo() {
    defer Trace("foo")()
    bar()
}

func bar() {
    defer Trace("bar")()
}
```

å‡½æ•°è°ƒç”¨è·Ÿè¸ªï¼š

```
enter:  main
enter:  foo
enter:  bar
exit:  bar
exit:  foo
exit:  main
```

ç¨‹åºæŒ‰main -> foo -> barçš„å‡½æ•°è°ƒç”¨æ¬¡åºæ‰§è¡Œï¼Œä»£ç åœ¨å‡½æ•°çš„å…¥å£ä¸å‡ºå£å¤„åˆ†åˆ«è¾“å‡ºäº†è·Ÿè¸ªæ—¥å¿—ã€‚

ä¸è¶³ä¹‹å¤„ï¼š

- è°ƒç”¨Traceæ—¶éœ€æ‰‹åŠ¨æ˜¾å¼ä¼ å…¥è¦è·Ÿè¸ªçš„å‡½æ•°åï¼›
- å¦‚æœæ˜¯å¹¶å‘åº”ç”¨ï¼Œä¸åŒGoroutineä¸­å‡½æ•°é“¾è·Ÿè¸ªæ··åœ¨ä¸€èµ·æ— æ³•åˆ†è¾¨ï¼›
- è¾“å‡ºçš„è·Ÿè¸ªç»“æœç¼ºå°‘å±‚æ¬¡æ„Ÿï¼Œè°ƒç”¨å…³ç³»ä¸æ˜“è¯†åˆ«ï¼›
- å¯¹è¦è·Ÿè¸ªçš„å‡½æ•°ï¼Œéœ€æ‰‹åŠ¨è°ƒç”¨Traceå‡½æ•°ã€‚

> ç›®æ ‡ï¼š**å®ç°ä¸€ä¸ªè‡ªåŠ¨æ³¨å…¥è·Ÿè¸ªä»£ç ï¼Œå¹¶è¾“å‡ºæœ‰å±‚æ¬¡æ„Ÿçš„å‡½æ•°è°ƒç”¨é“¾è·Ÿè¸ªå‘½ä»¤è¡Œå·¥å…·**ã€‚

### 27.2 è‡ªåŠ¨è·å–æ‰€è·Ÿè¸ªå‡½æ•°çš„å‡½æ•°å

### 27.3 å¢åŠ Goroutineæ ‡è¯† ğŸ”–

### 27.4 è®©è¾“å‡ºçš„è·Ÿè¸ªä¿¡æ¯æ›´å…·å±‚æ¬¡æ„Ÿ ğŸ”–

å¯¹äºç¨‹åºå‘˜æ¥è¯´ï¼Œç¼©è¿›æ˜¯æœ€èƒ½ä½“ç°å‡ºâ€œå±‚æ¬¡æ„Ÿâ€çš„æ–¹æ³•ã€‚

### 27.5 åˆ©ç”¨ä»£ç ç”Ÿæˆè‡ªåŠ¨æ³¨å…¥Traceå‡½æ•° ğŸ”–

#### å°†Traceå‡½æ•°æ”¾å…¥ä¸€ä¸ªç‹¬ç«‹çš„moduleä¸­

#### è‡ªåŠ¨æ³¨å…¥Traceå‡½æ•°

#### åˆ©ç”¨instrumentå·¥å…·æ³¨å…¥è·Ÿè¸ªä»£ç 

# æ ¸å¿ƒç¯‡ï¼šâ€œè„‘å‹¤+â€æ´å½»æ ¸å¿ƒ

æ ¸å¿ƒç¯‡ä¸»è¦æ¶µç›–**æ¥å£ç±»å‹è¯­æ³•ä¸GoåŸç”Ÿæä¾›çš„ä¸‰ä¸ªå¹¶å‘åŸè¯­ï¼ˆGoroutineã€channelä¸selectï¼‰**ï¼Œä¹‹æ‰€ä»¥å°†å®ƒä»¬æ”¾åœ¨æ ¸å¿ƒè¯­æ³•çš„ä½ç½®ï¼Œæ˜¯å› ä¸ºå®ƒä»¬ä¸ä»…ä»£è¡¨äº†Goè¯­è¨€åœ¨**ç¼–ç¨‹è¯­è¨€é¢†åŸŸçš„åˆ›æ–°**ï¼Œæ›´æ˜¯å½±å“Go**==åº”ç”¨éª¨æ¶==ï¼ˆApplication Skeletonï¼‰**è®¾è®¡çš„é‡è¦å…ƒç´ ã€‚

æ‰€è°“åº”ç”¨éª¨æ¶ï¼Œå°±æ˜¯æŒ‡å°†åº”ç”¨ä»£ç ä¸­çš„**ä¸šåŠ¡é€»è¾‘ã€ç®—æ³•å®ç°é€»è¾‘ã€é”™è¯¯å¤„ç†é€»è¾‘**ç­‰â€œçš®è‚‰â€é€ä¸€æ­å»åæ‰€å‘ˆç°å‡ºçš„åº”ç”¨ç»“æ„ã€‚

![](images/image-20240711195856322.png)

ä»é™æ€è§’åº¦å»çœ‹ï¼Œæˆ‘ä»¬èƒ½æ¸…æ™°åœ°çœ‹åˆ°åº”ç”¨ç¨‹åºçš„ç»„æˆéƒ¨åˆ†ä»¥åŠå„ä¸ªéƒ¨åˆ†ä¹‹é—´çš„è¿æ¥ï¼›ä»åŠ¨æ€è§’åº¦å»çœ‹ï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°è¿™å¹…éª¨æ¶ä¸Šå¯ç‹¬ç«‹è¿åŠ¨çš„å‡ å¤§æœºæ„ã€‚

å‰è€…æˆ‘ä»¬å¯ä»¥å°†å…¶ç†è§£ä¸ºGoåº”ç”¨å†…éƒ¨çš„è€¦åˆè®¾è®¡ï¼Œè€Œåè€…æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºåº”ç”¨çš„å¹¶å‘è®¾è®¡ã€‚

## 28 æ¥å£ï¼šæ¥å£å³å¥‘çº¦ â¤ï¸

### 28.1 è®¤è¯†æ¥å£ç±»å‹

**==æ¥å£ç±»å‹==æ˜¯ç”±typeå’Œinterfaceå…³é”®å­—å®šä¹‰çš„ä¸€ç»„æ–¹æ³•é›†åˆ**ï¼Œå…¶ä¸­ï¼Œæ–¹æ³•é›†åˆå”¯ä¸€ç¡®å®šäº†è¿™ä¸ªæ¥å£ç±»å‹æ‰€è¡¨ç¤ºçš„æ¥å£ã€‚

```go
type MyInterface interface {
    M1(int) error
    M2(io.Writer, ...string)
}
```

æ¥å£ç±»å‹MyInterfaceæ‰€è¡¨ç¤ºçš„æ¥å£çš„æ–¹æ³•é›†åˆï¼ŒåŒ…å«ä¸¤ä¸ªæ–¹æ³•M1å’ŒM2ã€‚ä¹‹æ‰€ä»¥ç§°M1å’ŒM2ä¸ºâ€œæ–¹æ³•â€ï¼Œæ›´å¤šæ˜¯**ä»è¿™ä¸ªæ¥å£çš„å®ç°è€…çš„è§’åº¦è€ƒè™‘çš„**ã€‚ä½†ä»ä¸Šé¢æ¥å£ç±»å‹å£°æ˜ä¸­å„ä¸ªâ€œæ–¹æ³•â€çš„å½¢å¼ä¸Šæ¥çœ‹ï¼Œè¿™æ›´åƒæ˜¯**ä¸å¸¦æœ‰funcå…³é”®å­—çš„å‡½æ•°å+å‡½æ•°ç­¾åï¼ˆå‚æ•°åˆ—è¡¨+è¿”å›å€¼åˆ—è¡¨ï¼‰**çš„ç»„åˆã€‚

å¹¶ä¸”ï¼Œæ¥å£ç±»å‹çš„æ–¹æ³•é›†åˆä¸­å£°æ˜çš„æ–¹æ³•ï¼Œå®ƒçš„**å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼åˆ—è¡¨éƒ½ä¸éœ€è¦å†™å‡ºå½¢å‚åå­—**ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ä¸­å½¢å‚åå­—ä¸è¿”å›å€¼åˆ—è¡¨ä¸­çš„å…·åè¿”å›å€¼ï¼Œéƒ½ä¸ä½œä¸ºåŒºåˆ†ä¸¤ä¸ªæ–¹æ³•çš„å‡­æ®**ã€‚æ¯”å¦‚ï¼Œä¸‹é¢ä¸¤ä¸ªç­‰ä»·ï¼š

```go
type MyInterface interface {
    M1(a int) error
    M2(w io.Writer, strs ...string)
}

type MyInterface interface {
    M1(n int) error
    M2(w io.Writer, args ...string)
} 
```

ä¸è¿‡ï¼ŒGoè¯­è¨€è¦æ±‚æ¥å£ç±»å‹å£°æ˜ä¸­çš„**æ–¹æ³•å¿…é¡»æ˜¯å…·åçš„**ï¼Œå¹¶ä¸”æ–¹æ³•åå­—åœ¨è¿™ä¸ªæ¥å£ç±»å‹çš„æ–¹æ³•é›†åˆä¸­æ˜¯**å”¯ä¸€**çš„ã€‚

Goæ¥å£ç±»å‹å…è®¸åµŒå…¥çš„ä¸åŒæ¥å£ç±»å‹çš„æ–¹æ³•é›†åˆå­˜åœ¨**äº¤é›†**ï¼Œä½†å‰ææ˜¯äº¤é›†ä¸­çš„æ–¹æ³•ä¸ä»…åå­—è¦ä¸€æ ·ï¼Œå®ƒçš„å‡½æ•°ç­¾åéƒ¨åˆ†ä¹Ÿè¦ä¿æŒä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯å‚æ•°åˆ—è¡¨ä¸è¿”å›å€¼åˆ—è¡¨ä¹Ÿè¦ç›¸åŒï¼Œå¦åˆ™Goç¼–è¯‘å™¨ç…§æ ·ä¼šæŠ¥é”™ã€‚

```go
type Interface1 interface {
    M1()
}
type Interface2 interface {
    M1(string) 
    M2()
}

type Interface3 interface{
    Interface1
    Interface2 // ç¼–è¯‘å™¨æŠ¥é”™ï¼šduplicate method M1
    M3()
}
```

åœ¨Goæ¥å£ç±»å‹çš„æ–¹æ³•é›†åˆä¸­æ”¾å…¥é¦–å­—æ¯å°å†™çš„**éå¯¼å‡ºæ–¹æ³•**ä¹Ÿæ˜¯åˆæ³•çš„ã€‚

```go
// $GOROOT/src/context.go

// A canceler is a context type that can be canceled directly. The
// implementations are *cancelCtx and *timerCtx.
type canceler interface {
    cancel(removeFromParent bool, err error)
    Done() <-chan struct{}
}
```

å¦‚æœæ¥å£ç±»å‹çš„æ–¹æ³•é›†åˆä¸­åŒ…å«éå¯¼å‡ºæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¥å£ç±»å‹è‡ªèº«é€šå¸¸ä¹Ÿæ˜¯éå¯¼å‡ºçš„ï¼Œå®ƒçš„åº”ç”¨èŒƒå›´ä¹Ÿä»…å±€é™äºåŒ…å†…ã€‚ã€å¾ˆå°‘ä¼šç”¨è¿™ç§å¸¦æœ‰éå¯¼å‡ºæ–¹æ³•çš„æ¥å£ç±»å‹ã€‘

==ç©ºæ¥å£ç±»å‹== `interface{}`

æ¥å£ç±»å‹ä¸€æ—¦è¢«å®šä¹‰åï¼Œå®ƒå°±å’Œå…¶ä»–Goç±»å‹ä¸€æ ·å¯ä»¥ç”¨äºå£°æ˜å˜é‡:

```go
var err error   // erræ˜¯ä¸€ä¸ªerroræ¥å£ç±»å‹çš„å®ä¾‹å˜é‡
var r io.Reader // ræ˜¯ä¸€ä¸ªio.Readeræ¥å£ç±»å‹çš„å®ä¾‹å˜é‡ 
```

è¿™äº›ç±»å‹ä¸ºæ¥å£ç±»å‹çš„å˜é‡è¢«ç§°ä¸º**==æ¥å£ç±»å‹å˜é‡==**ï¼Œå¦‚æœæ²¡æœ‰è¢«æ˜¾å¼èµ‹äºˆåˆå€¼ï¼Œæ¥å£ç±»å‹å˜é‡çš„é»˜è®¤å€¼ä¸ºnilã€‚å¦‚æœè¦ä¸ºæ¥å£ç±»å‹å˜é‡æ˜¾å¼èµ‹äºˆåˆå€¼ï¼Œæˆ‘ä»¬å°±è¦ä¸ºæ¥å£ç±»å‹å˜é‡é€‰æ‹©åˆæ³•çš„å³å€¼ã€‚

Goè§„å®šï¼š**å¦‚æœä¸€ä¸ªç±»å‹Tçš„æ–¹æ³•é›†åˆæ˜¯æŸæ¥å£ç±»å‹Içš„æ–¹æ³•é›†åˆçš„ç­‰ä»·é›†åˆæˆ–è¶…é›†ï¼Œæˆ‘ä»¬å°±è¯´ç±»å‹Tå®ç°äº†æ¥å£ç±»å‹Iï¼Œé‚£ä¹ˆç±»å‹Tçš„å˜é‡å°±å¯ä»¥ä½œä¸ºåˆæ³•çš„å³å€¼èµ‹å€¼ç»™æ¥å£ç±»å‹Içš„å˜é‡ã€‚**

å¯ä»¥å°†ä»»ä½•ç±»å‹çš„å€¼ä½œä¸ºå³å€¼ï¼Œèµ‹å€¼ç»™ç©ºæ¥å£ç±»å‹çš„å˜é‡ã€‚

```go
var i interface{} = 15 // ok
i = "hello, golang" // ok
type T struct{}
var t T
i = t  // ok
i = &t // ok
```

ç©ºæ¥å£ç±»å‹çš„è¿™ä¸€å¯æ¥å—ä»»æ„ç±»å‹å˜é‡å€¼ä½œä¸ºå³å€¼çš„ç‰¹æ€§ï¼Œè®©ä»–æˆä¸ºGoåŠ å…¥æ³›å‹è¯­æ³•ä¹‹å‰**å”¯ä¸€ä¸€ç§å…·æœ‰â€œæ³›å‹â€èƒ½åŠ›çš„è¯­æ³•å…ƒç´ **ã€‚

Goè¯­è¨€è¿˜æ”¯æŒæ¥å£ç±»å‹å˜é‡èµ‹å€¼çš„â€œ**é€†æ“ä½œ**â€ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡æ¥å£ç±»å‹å˜é‡â€œè¿˜åŸâ€å®ƒçš„å³å€¼çš„ç±»å‹ä¸å€¼ä¿¡æ¯ï¼Œè¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºâ€œ**==ç±»å‹æ–­è¨€==ï¼ˆType Assertionï¼‰**â€ï¼š

```go
v, ok := i.(T) 
```

å…¶ä¸­iæ˜¯æŸä¸€ä¸ªæ¥å£ç±»å‹å˜é‡ï¼Œå¦‚æœTæ˜¯ä¸€ä¸ªéæ¥å£ç±»å‹ä¸”Tæ˜¯æƒ³è¦è¿˜åŸçš„ç±»å‹ï¼Œé‚£ä¹ˆè¿™å¥ä»£ç çš„å«ä¹‰å°±æ˜¯**æ–­è¨€å­˜å‚¨åœ¨æ¥å£ç±»å‹å˜é‡iä¸­çš„å€¼çš„ç±»å‹ä¸ºT**ã€‚

å¦‚æœæ¥å£ç±»å‹å˜é‡iä¹‹å‰è¢«èµ‹äºˆçš„å€¼ç¡®ä¸ºTç±»å‹çš„å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªè¯­å¥æ‰§è¡Œåï¼Œå·¦ä¾§â€œcomma, okâ€è¯­å¥ä¸­çš„å˜é‡okçš„å€¼å°†ä¸ºtrueï¼Œå˜é‡vçš„ç±»å‹ä¸ºTï¼Œå®ƒå€¼ä¼šæ˜¯ä¹‹å‰å˜é‡içš„å³å€¼ã€‚å¦‚æœiä¹‹å‰è¢«èµ‹äºˆçš„å€¼ä¸æ˜¯Tç±»å‹çš„å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªè¯­å¥æ‰§è¡Œåï¼Œå˜é‡okçš„å€¼ä¸ºfalseï¼Œ**å˜é‡vçš„ç±»å‹è¿˜æ˜¯é‚£ä¸ªè¦è¿˜åŸçš„ç±»å‹ï¼Œä½†å®ƒçš„å€¼æ˜¯ç±»å‹Tçš„é›¶å€¼**ã€‚

```go
var a int64 = 13
var i interface{} = a
v1, ok := i.(int64) 
fmt.Printf("v1=%d, the type of v1 is %T, ok=%t\n", v1, v1, ok) // v1=13, the type of v1 is int64, ok=true
v2, ok := i.(string)
fmt.Printf("v2=%s, the type of v2 is %T, ok=%t\n", v2, v2, ok) // v2=, the type of v2 is string, ok=false
v3 := i.(int64) 
fmt.Printf("v3=%d, the type of v3 is %T\n", v3, v3) // v3=13, the type of v3 is int64
v4 := i.([]int) // panic: interface conversion: interface {} is int64, not []int
fmt.Printf("the type of v4 is %T\n", v4)
```

å¦‚æœ`v, ok := i.(T)`ä¸­çš„Tæ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼Œé‚£ä¹ˆç±»å‹æ–­è¨€çš„è¯­ä¹‰å°±ä¼šå˜æˆï¼š**æ–­è¨€içš„å€¼å®ç°äº†æ¥å£ç±»å‹T**ã€‚å¦‚æœæ–­è¨€æˆåŠŸï¼Œå˜é‡vçš„ç±»å‹ä¸ºiçš„å€¼çš„ç±»å‹ï¼Œè€Œå¹¶éæ¥å£ç±»å‹Tã€‚å¦‚æœæ–­è¨€å¤±è´¥ï¼Œvçš„ç±»å‹ä¿¡æ¯ä¸ºæ¥å£ç±»å‹Tï¼Œå®ƒçš„å€¼ä¸ºnilã€‚

```go
type MyInterface interface {
    M1()
}

type T int

func (T) M1() {
    println("T's M1")
}              

func main() {  
    var t T    
    var i interface{} = t
    v1, ok := i.(MyInterface)
    if !ok {   
        panic("the value of i is not MyInterface")
    }          
    v1.M1()    
    fmt.Printf("the type of v1 is %T\n", v1) // the type of v1 is main.T

    i = int64(13)
    v2, ok := i.(MyInterface)
    fmt.Printf("the type of v2 is %T\n", v2) // the type of v2 is <nil>
    // v2 = 13 //  cannot use 1 (type int) as type MyInterface in assignment: int does not implement MyInterface (missing M1   method) 
}
```



### 28.2 å°½é‡å®šä¹‰â€œå°æ¥å£â€

- éšå¼å¥‘çº¦ï¼Œæ— éœ€ç­¾ç½²ï¼Œè‡ªåŠ¨ç”Ÿæ•ˆ

Goè¯­è¨€ä¸­æ¥å£ç±»å‹ä¸å®ƒçš„å®ç°è€…ä¹‹é—´çš„å…³ç³»æ˜¯**éšå¼**çš„ï¼Œä¸éœ€è¦åƒå…¶ä»–è¯­è¨€ï¼ˆæ¯”å¦‚Javaï¼‰é‚£æ ·è¦æ±‚å®ç°è€…æ˜¾å¼æ”¾ç½®â€œimplementsâ€è¿›è¡Œä¿®é¥°ï¼Œå®ç°è€…åªéœ€è¦å®ç°æ¥å£æ–¹æ³•é›†åˆä¸­çš„å…¨éƒ¨æ–¹æ³•ä¾¿ç®—æ˜¯éµå®ˆäº†å¥‘çº¦ï¼Œå¹¶ç«‹å³ç”Ÿæ•ˆäº†ã€‚

- æ›´å€¾å‘äºâ€œå°å¥‘çº¦â€

Goé€‰æ‹©äº†ä½¿ç”¨â€œå°å¥‘çº¦â€ï¼Œè¡¨ç°åœ¨ä»£ç ä¸Šå°±æ˜¯å°½é‡å®šä¹‰å°æ¥å£ï¼Œå³**æ–¹æ³•ä¸ªæ•°åœ¨1~3ä¸ªä¹‹é—´çš„æ¥å£**ã€‚

æ—©æœŸç‰ˆæœ¬çš„Goæ ‡å‡†åº“ï¼ˆGo 1.13ç‰ˆæœ¬ï¼‰ã€Dockeré¡¹ç›®ï¼ˆDocker 19.03ç‰ˆæœ¬ï¼‰ä»¥åŠKubernetesé¡¹ç›®ï¼ˆKubernetes 1.17ç‰ˆæœ¬ï¼‰ä¸­å®šä¹‰çš„æ¥å£ç±»å‹æ–¹æ³•é›†åˆä¸­æ–¹æ³•æ•°é‡ï¼š

![](images/image-20240711203002095.png)

### 28.3 å°æ¥å£æœ‰å“ªäº›ä¼˜åŠ¿ï¼Ÿ

#### ç¬¬ä¸€ç‚¹ï¼šæ¥å£è¶Šå°ï¼ŒæŠ½è±¡ç¨‹åº¦è¶Šé«˜

è®¡ç®—æœºç¨‹åºæœ¬èº«å°±æ˜¯å¯¹çœŸå®ä¸–ç•Œçš„==æŠ½è±¡ä¸å†å»ºæ„==ã€‚æŠ½è±¡å°±æ˜¯**å¯¹åŒç±»äº‹ç‰©å»é™¤å®ƒå…·ä½“çš„ã€æ¬¡è¦çš„æ–¹é¢ï¼ŒæŠ½å–å®ƒç›¸åŒçš„ã€ä¸»è¦çš„æ–¹é¢**ã€‚ä¸åŒçš„æŠ½è±¡ç¨‹åº¦ï¼Œä¼šå¯¼è‡´æŠ½è±¡å‡ºçš„æ¦‚å¿µå¯¹åº”çš„äº‹ç‰©çš„é›†åˆä¸åŒã€‚**æŠ½è±¡ç¨‹åº¦è¶Šé«˜ï¼Œå¯¹åº”çš„é›†åˆç©ºé—´å°±è¶Šå¤§ï¼›æŠ½è±¡ç¨‹åº¦è¶Šä½ï¼Œä¹Ÿå°±æ˜¯è¶Šå…·åƒåŒ–ï¼Œæ›´æ¥è¿‘äº‹ç‰©çœŸå®é¢è²Œï¼Œå¯¹åº”çš„é›†åˆç©ºé—´è¶Šå°ã€‚**

å¯¹ç”Ÿæ´»ä¸­ä¸åŒæŠ½è±¡ç¨‹åº¦çš„å½¢è±¡è¯ é‡Šï¼š

![](images/image-20240711203233701.png)

è¿™å¼ å›¾ä¸­æˆ‘ä»¬åˆ†åˆ«å»ºç«‹äº†ä¸‰ä¸ªæŠ½è±¡ï¼š

- ä¼šé£çš„ã€‚è¿™ä¸ªæŠ½è±¡å¯¹åº”çš„äº‹ç‰©é›†åˆåŒ…æ‹¬ï¼šè´è¶ã€èœœèœ‚ã€éº»é›€ã€å¤©é¹…ã€é¸³é¸¯ã€æµ·é¸¥å’Œä¿¡å¤©ç¿ï¼›
- ä¼šæ¸¸æ³³çš„ã€‚é¸­å­ã€æµ·è±šã€äººç±»ã€å¤©é¹…ã€é¸³é¸¯ã€æµ·é¸¥å’Œä¿¡å¤©ç¿ï¼›
- ä¼šé£ä¸”ä¼šæ¸¸æ³³çš„ã€‚å¤©é¹…ã€é¸³é¸¯ã€æµ·é¸¥å’Œä¿¡å¤©ç¿ã€‚

â€œä¼šé£çš„â€ã€â€œä¼šæ¸¸æ³³çš„â€è¿™ä¸¤ä¸ªæŠ½è±¡å¯¹åº”çš„äº‹ç‰©é›†åˆï¼Œè¦å¤§äºâ€œä¼šé£ä¸”ä¼šæ¸¸æ³³çš„â€æ‰€å¯¹åº”çš„äº‹ç‰©é›†åˆç©ºé—´ï¼Œä¹Ÿå°±æ˜¯è¯´â€œä¼šé£çš„â€ã€â€œä¼šæ¸¸æ³³çš„â€è¿™ä¸¤ä¸ªæŠ½è±¡ç¨‹åº¦æ›´é«˜ã€‚

```go
// ä¼šé£çš„
type Flyable interface {
    Fly()
}

// ä¼šæ¸¸æ³³çš„
type Swimable interface {
    Swim()
}

// ä¼šé£ä¸”ä¼šæ¸¸æ³³çš„
type FlySwimable interface {
    Flyable
    Swimable
}
```

![](images/image-20240711203516982.png)

Flyableåªæœ‰ä¸€ä¸ªFlyæ–¹æ³•ï¼ŒFlySwimableåˆ™åŒ…å«ä¸¤ä¸ªæ–¹æ³•Flyå’ŒSwimã€‚æˆ‘ä»¬çœ‹åˆ°ï¼Œå…·æœ‰æ›´å°‘æ–¹æ³•çš„Flyableçš„æŠ½è±¡ç¨‹åº¦ç›¸å¯¹äºFlySwimableè¦é«˜ï¼ŒåŒ…å«çš„äº‹ç‰©é›†åˆï¼ˆ7ç§åŠ¨ç‰©ï¼‰ä¹Ÿè¦æ¯”FlySwimableçš„äº‹ç‰©é›†åˆï¼ˆ4ç§åŠ¨ç‰©ï¼‰å¤§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¥å£è¶Šå°ï¼ˆæ¥å£æ–¹æ³•å°‘)ï¼ŒæŠ½è±¡ç¨‹åº¦è¶Šé«˜ï¼Œå¯¹åº”çš„äº‹ç‰©é›†åˆè¶Šå¤§ã€‚

#### ç¬¬äºŒç‚¹ï¼šå°æ¥å£æ˜“äºå®ç°å’Œæµ‹è¯•

#### ç¬¬ä¸‰ç‚¹ï¼šå°æ¥å£è¡¨ç¤ºçš„â€œå¥‘çº¦â€èŒè´£å•ä¸€ï¼Œæ˜“äºå¤ç”¨ç»„åˆ

Goæ¨å´‡é€šè¿‡ç»„åˆçš„æ–¹å¼æ„å»ºç¨‹åºã€‚Goå¼€å‘äººå‘˜ä¸€èˆ¬ä¼šå°è¯•é€šè¿‡åµŒå…¥å…¶ä»–å·²æœ‰æ¥å£ç±»å‹çš„æ–¹å¼æ¥æ„å»ºæ–°æ¥å£ç±»å‹ï¼Œå°±åƒé€šè¿‡åµŒå…¥io.Readerå’Œio.Writeræ„å»ºio.ReadWriteré‚£æ ·ã€‚

é‚£æ„å»ºæ—¶ï¼Œå¦‚æœæœ‰ä¼—å¤šå€™é€‰æ¥å£ç±»å‹ä¾›æˆ‘ä»¬é€‰æ‹©ï¼Œæˆ‘ä»¬ä¼šæ€ä¹ˆé€‰æ‹©å‘¢ï¼Ÿ

æ˜¾ç„¶ï¼Œæˆ‘ä»¬ä¼šé€‰æ‹©é‚£äº›**æ–°æ¥å£ç±»å‹éœ€è¦çš„å¥‘çº¦èŒè´£ï¼ŒåŒæ—¶ä¹Ÿè¦æ±‚ä¸è¦å¼•å…¥æˆ‘ä»¬ä¸éœ€è¦çš„å¥‘çº¦èŒè´£**ã€‚åœ¨è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œæ‹¥æœ‰å•ä¸€æˆ–å°‘æ•°æ–¹æ³•çš„å°æ¥å£ä¾¿æ›´æœ‰å¯èƒ½æˆä¸ºæˆ‘ä»¬çš„ç›®æ ‡ï¼Œè€Œé‚£äº›æ‹¥æœ‰è¾ƒå¤šæ–¹æ³•çš„å¤§æ¥å£ï¼Œå¯èƒ½ä¼šå› å¼•å…¥äº†è¯¸å¤šä¸éœ€è¦çš„å¥‘çº¦èŒè´£è€Œè¢«æ”¾å¼ƒã€‚ç”±æ­¤å¯è§ï¼Œå°æ¥å£æ›´å¥‘åˆGoçš„ç»„åˆæ€æƒ³ï¼Œä¹Ÿæ›´å®¹æ˜“å‘æŒ¥å‡ºç»„åˆçš„å¨åŠ›ã€‚

### 28.4 å®šä¹‰å°æ¥å£ï¼Œä½ å¯ä»¥éµå¾ªçš„å‡ ç‚¹

- é¦–å…ˆï¼Œ**åˆ«ç®¡æ¥å£å¤§å°ï¼Œå…ˆæŠ½è±¡å‡ºæ¥å£**ã€‚

å°½ç®¡æ¥å£ä¸æ˜¯Goç‹¬æœ‰çš„ï¼Œä½†**ä¸“æ³¨äºæ¥å£æ˜¯ç¼–å†™å¼ºå¤§è€Œçµæ´»çš„Goä»£ç çš„å…³é”®**ã€‚å› æ­¤ï¼Œåœ¨å®šä¹‰å°æ¥å£ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆé’ˆå¯¹==é—®é¢˜é¢†åŸŸ==è¿›è¡Œæ·±å…¥ç†è§£ï¼Œèšç„¦æŠ½è±¡å¹¶å‘ç°æ¥å£ï¼Œå°±åƒä¸‹å›¾æ‰€å±•ç¤ºçš„é‚£æ ·ï¼Œå…ˆé’ˆå¯¹é¢†åŸŸå¯¹è±¡çš„è¡Œä¸ºè¿›è¡ŒæŠ½è±¡ï¼Œå½¢æˆä¸€ä¸ªæ¥å£é›†åˆï¼š

![](images/image-20240704184513581.png)

**åˆæœŸï¼Œæˆ‘ä»¬å…ˆä¸è¦ä»‹æ„è¿™ä¸ªæ¥å£é›†åˆä¸­æ–¹æ³•çš„æ•°é‡**ï¼Œå› ä¸ºå¯¹é—®é¢˜åŸŸçš„ç†è§£æ˜¯å¾ªåºæ¸è¿›çš„ï¼Œåœ¨ç¬¬ä¸€ç‰ˆä»£ç ä¸­ç›´æ¥å®šä¹‰å‡ºå°æ¥å£å¯èƒ½å¹¶ä¸ç°å®ã€‚è€Œä¸”ï¼Œæ ‡å‡†åº“ä¸­çš„io.Readerå’Œio.Writerä¹Ÿä¸æ˜¯åœ¨Goåˆšè¯ç”Ÿæ—¶å°±æœ‰çš„ï¼Œè€Œæ˜¯åœ¨å‘ç°å¯¹ç½‘ç»œã€æ–‡ä»¶ã€å…¶ä»–å­—èŠ‚æ•°æ®å¤„ç†çš„å®ç°ååˆ†ç›¸ä¼¼ä¹‹åæ‰æŠ½è±¡å‡ºæ¥çš„ã€‚å¹¶ä¸”è¶Šåå‘ä¸šåŠ¡å±‚ï¼ŒæŠ½è±¡éš¾åº¦å°±è¶Šé«˜ï¼Œè¿™æˆ–è®¸ä¹Ÿæ˜¯å‰é¢å›¾ä¸­Goæ ‡å‡†åº“å°æ¥å£ï¼ˆ1~3ä¸ªæ–¹æ³•ï¼‰å æ¯”ç•¥é«˜äºDockerå’ŒKubernetesçš„åŸå› ã€‚

- ç¬¬äºŒï¼Œå°†å¤§æ¥å£æ‹†åˆ†ä¸ºå°æ¥å£ã€‚

![](images/image-20240704184559349.png)

- æœ€åï¼Œæˆ‘ä»¬è¦æ³¨æ„æ¥å£çš„**å•ä¸€å¥‘çº¦èŒè´£**ã€‚

## 29 æ¥å£ï¼šä¸ºä»€ä¹ˆnilæ¥å£ä¸ç­‰äºnilï¼Ÿ

æ¥å£æ˜¯Goè¿™é—¨é™æ€è¯­è¨€ä¸­å”¯ä¸€â€œ==åŠ¨é™å…¼å¤‡==â€çš„è¯­æ³•ç‰¹æ€§ã€‚

### 29.1 æ¥å£çš„é™æ€ç‰¹æ€§ä¸åŠ¨æ€ç‰¹æ€§

æ¥å£çš„**é™æ€ç‰¹æ€§**ä½“ç°åœ¨**æ¥å£ç±»å‹å˜é‡å…·æœ‰é™æ€ç±»å‹**ï¼Œæ¯”å¦‚`var err error`ä¸­å˜é‡errçš„é™æ€ç±»å‹ä¸ºerrorã€‚æ‹¥æœ‰é™æ€ç±»å‹ï¼Œé‚£å°±æ„å‘³ç€ç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘é˜¶æ®µå¯¹æ‰€æœ‰æ¥å£ç±»å‹å˜é‡çš„èµ‹å€¼æ“ä½œè¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œç¼–è¯‘å™¨ä¼š**æ£€æŸ¥å³å€¼çš„ç±»å‹æ˜¯å¦å®ç°äº†è¯¥æ¥å£æ–¹æ³•é›†åˆä¸­çš„æ‰€æœ‰æ–¹æ³•**ã€‚å¦‚æœä¸æ»¡è¶³ï¼Œå°±ä¼šæŠ¥é”™ï¼š

```go
var err error = 1 // cannot use 1 (type int) as type error in assignment: int does not implement error (missing Error method)
```

è€Œæ¥å£çš„**åŠ¨æ€ç‰¹æ€§**ï¼Œå°±ä½“ç°åœ¨**æ¥å£ç±»å‹å˜é‡åœ¨è¿è¡Œæ—¶è¿˜å­˜å‚¨äº†å³å€¼çš„==çœŸå®ç±»å‹ä¿¡æ¯==**ï¼Œè¿™ä¸ªå³å€¼çš„çœŸå®ç±»å‹è¢«ç§°ä¸ºæ¥å£ç±»å‹å˜é‡çš„==åŠ¨æ€ç±»å‹==ã€‚

```go
var err error
err = errors.New("error1")
fmt.Printf("%T\n", err)  // *errors.errorString
```

è¿™ä¸ªç¤ºä¾‹é€šè¿‡`errros.New`æ„é€ äº†ä¸€ä¸ªé”™è¯¯å€¼ï¼Œèµ‹å€¼ç»™äº†erroræ¥å£ç±»å‹å˜é‡errï¼Œå¹¶é€šè¿‡fmt.Printfå‡½æ•°è¾“å‡ºæ¥å£ç±»å‹å˜é‡errçš„åŠ¨æ€ç±»å‹ä¸º`*errors.errorString`ã€‚

æ¥å£çš„è¿™ç§â€œåŠ¨é™çš†å¤‡â€çš„ç‰¹æ€§çš„å¥½å¤„æ˜¯ï¼š

- é¦–å…ˆï¼Œæ¥å£ç±»å‹å˜é‡åœ¨ç¨‹åº**è¿è¡Œæ—¶å¯ä»¥è¢«èµ‹å€¼ä¸ºä¸åŒçš„åŠ¨æ€ç±»å‹å˜é‡**ï¼Œæ¯æ¬¡èµ‹å€¼åï¼Œæ¥å£ç±»å‹å˜é‡ä¸­å­˜å‚¨çš„åŠ¨æ€ç±»å‹ä¿¡æ¯éƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™è®©Goè¯­è¨€å¯ä»¥åƒåŠ¨æ€è¯­è¨€ï¼ˆæ¯”å¦‚Pythonï¼‰é‚£æ ·æ‹¥æœ‰ä½¿ç”¨Duck Typingï¼ˆé¸­å­ç±»å‹ï¼‰çš„çµæ´»æ€§ã€‚æ‰€è°“==é¸­å­ç±»å‹==ï¼Œå°±æ˜¯æŒ‡æŸç±»å‹æ‰€è¡¨ç°å‡ºçš„ç‰¹æ€§ï¼ˆæ¯”å¦‚æ˜¯å¦å¯ä»¥ä½œä¸ºæŸæ¥å£ç±»å‹çš„å³å€¼ï¼‰ï¼Œä¸æ˜¯ç”±å…¶**åŸºå› **ï¼ˆæ¯”å¦‚C++ä¸­çš„çˆ¶ç±»ï¼‰å†³å®šçš„ï¼Œè€Œæ˜¯ç”±ç±»å‹æ‰€è¡¨ç°å‡ºæ¥çš„**è¡Œä¸º**ï¼ˆæ¯”å¦‚ç±»å‹æ‹¥æœ‰çš„æ–¹æ³•ï¼‰å†³å®šçš„ã€‚

```go
type QuackableAnimal interface {
    Quack()
}

type Duck struct{}

func (Duck) Quack() {
    println("duck quack!")
}

type Dog struct{}

func (Dog) Quack() {
    println("dog quack!")
}

type Bird struct{}

func (Bird) Quack() {
    println("bird quack!")
}                         
                          
func AnimalQuackInForest(a QuackableAnimal) {
    a.Quack()             
}                         
                          
func main() {             
    animals := []QuackableAnimal{new(Duck), new(Dog), new(Bird)}
    for _, animal := range animals {
        AnimalQuackInForest(animal)
    }  
}
```

æ¥å£ç±»å‹QuackableAnimalæ¥ä»£è¡¨å…·æœ‰â€œä¼šå«â€è¿™ä¸€ç‰¹å¾çš„åŠ¨ç‰©ï¼Œè€ŒDuckã€Birdå’ŒDogç±»å‹å„è‡ªéƒ½å…·æœ‰è¿™æ ·çš„ç‰¹å¾ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸‰ä¸ªç±»å‹çš„å˜é‡èµ‹å€¼ç»™QuackableAnimalæ¥å£ç±»å‹å˜é‡aã€‚æ¯æ¬¡èµ‹å€¼ï¼Œå˜é‡aä¸­å­˜å‚¨çš„åŠ¨æ€ç±»å‹ä¿¡æ¯éƒ½ä¸åŒï¼ŒQuackæ–¹æ³•çš„æ‰§è¡Œç»“æœå°†æ ¹æ®å˜é‡aä¸­å­˜å‚¨çš„åŠ¨æ€ç±»å‹ä¿¡æ¯è€Œå®šã€‚

è¿™é‡Œçš„Duckã€Birdã€Dogéƒ½æ˜¯â€œé¸­å­ç±»å‹â€ï¼Œä½†å®ƒä»¬ä¹‹é—´å¹¶æ²¡æœ‰ä»€ä¹ˆè”ç³»ï¼Œä¹‹æ‰€ä»¥èƒ½ä½œä¸ºå³å€¼èµ‹å€¼ç»™QuackableAnimalç±»å‹å˜é‡ï¼Œåªæ˜¯å› ä¸ºä»–ä»¬è¡¨ç°å‡ºäº†QuackableAnimalæ‰€è¦æ±‚çš„ç‰¹å¾ç½¢äº†ã€‚

ä¸è¿‡ï¼Œä¸åŠ¨æ€è¯­è¨€ä¸åŒçš„æ˜¯ï¼ŒGoæ¥å£è¿˜å¯ä»¥**ä¿è¯â€œåŠ¨æ€ç‰¹æ€§â€ä½¿ç”¨æ—¶çš„å®‰å…¨æ€§**ã€‚æ¯”å¦‚ï¼Œç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸå°±å¯ä»¥æ•æ‰åˆ°å°†intç±»å‹å˜é‡ä¼ ç»™QuackableAnimalæ¥å£ç±»å‹å˜é‡è¿™æ ·çš„æ˜æ˜¾é”™è¯¯ï¼Œå†³ä¸ä¼šè®©è¿™æ ·çš„é”™è¯¯é—æ¼åˆ°è¿è¡Œæ—¶æ‰è¢«å‘ç°ã€‚

### 29.2 nil errorå€¼ != nil

```go
type MyError struct {
    error
}

var ErrBad = MyError{
    error: errors.New("bad things happened"),
}

func bad() bool {
    return false
}

func returnsError() error {
    var p *MyError = nil
    if bad() {
        p = &ErrBad
    }
    return p
}

func main() {
    err := returnsError()
    if err != nil {
        fmt.Printf("error occur: %+v\n", err)  // ç»“æœ
        return
    }
    fmt.Println("ok")
}
```





### 29.3 æ¥å£ç±»å‹å˜é‡çš„å†…éƒ¨è¡¨ç¤º â¤ï¸

æ¥å£ç±»å‹â€œåŠ¨é™å…¼å¤‡â€çš„ç‰¹æ€§ä¹Ÿå†³å®šäº†å®ƒçš„å˜é‡çš„å†…éƒ¨è¡¨ç¤ºç»ä¸åƒä¸€ä¸ªé™æ€ç±»å‹å˜é‡ï¼ˆå¦‚intã€float64ï¼‰é‚£æ ·ç®€å•ã€‚

åœ¨`$GOROOT/src/runtime/runtime2.go`ä¸­æ‰¾åˆ°æ¥å£ç±»å‹å˜é‡åœ¨è¿è¡Œæ—¶çš„è¡¨ç¤ºï¼š

```go
// $GOROOT/src/runtime/runtime2.go
type iface struct {
    tab  *itab
    data unsafe.Pointer
}

type eface struct {
    _type *_type
    data  unsafe.Pointer
} 
```

åœ¨è¿è¡Œæ—¶å±‚é¢ï¼Œæ¥å£ç±»å‹å˜é‡æœ‰ä¸¤ç§å†…éƒ¨è¡¨ç¤º:

- `eface`ç”¨äºè¡¨ç¤ºæ²¡æœ‰æ–¹æ³•çš„ç©ºæ¥å£ï¼ˆempty interfaceï¼‰ç±»å‹å˜é‡ï¼Œä¹Ÿå°±æ˜¯`interface{}`ç±»å‹çš„å˜é‡ï¼›
- `iface`ç”¨äºè¡¨ç¤ºå…¶ä½™æ‹¥æœ‰æ–¹æ³•çš„æ¥å£interfaceç±»å‹å˜é‡ã€‚

è¿™ä¸¤ä¸ªç»“æ„çš„å…±åŒç‚¹æ˜¯å®ƒä»¬**éƒ½æœ‰ä¸¤ä¸ªæŒ‡é’ˆå­—æ®µ**ï¼Œå¹¶ä¸”ç¬¬äºŒä¸ªæŒ‡é’ˆå­—æ®µçš„åŠŸèƒ½ç›¸åŒï¼Œéƒ½æ˜¯æŒ‡å‘**å½“å‰èµ‹å€¼ç»™è¯¥æ¥å£ç±»å‹å˜é‡çš„åŠ¨æ€ç±»å‹å˜é‡çš„å€¼**ã€‚

ä¸åŒç‚¹å°±åœ¨äºefaceè¡¨ç¤ºçš„ç©ºæ¥å£ç±»å‹å¹¶**æ²¡æœ‰æ–¹æ³•åˆ—è¡¨**ï¼Œå› æ­¤å®ƒçš„ç¬¬ä¸€ä¸ªæŒ‡é’ˆå­—æ®µæŒ‡å‘ä¸€ä¸ª`_type`ç±»å‹ç»“æ„ï¼Œè¿™ä¸ªç»“æ„ä¸ºè¯¥æ¥å£ç±»å‹å˜é‡çš„**==åŠ¨æ€ç±»å‹çš„ä¿¡æ¯==**ï¼Œå®ƒçš„å®šä¹‰æ˜¯è¿™æ ·çš„ï¼š

```go
// $GOROOT/src/runtime/type.go
type _type struct {
    size       uintptr
    ptrdata    uintptr // size of memory prefix holding all pointers
    hash       uint32
    tflag      tflag
    align      uint8
    fieldAlign uint8
    kind       uint8
    // function for comparing objects of this type
    // (ptr to object A, ptr to object B) -> ==?
    equal func(unsafe.Pointer, unsafe.Pointer) bool
    // gcdata stores the GC type data for the garbage collector.
    // If the KindGCProg bit is set in kind, gcdata is a GC program.
    // Otherwise it is a ptrmask bitmap. See mbitmap.go for details.
    gcdata    *byte
    str       nameOff
    ptrToThis typeOff
}
```

è€Œifaceé™¤äº†è¦å­˜å‚¨åŠ¨æ€ç±»å‹ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜è¦å­˜å‚¨**æ¥å£æœ¬èº«çš„ä¿¡æ¯**ï¼ˆ**==æ¥å£çš„ç±»å‹ä¿¡æ¯ã€æ–¹æ³•åˆ—è¡¨ä¿¡æ¯==**ç­‰ï¼‰ä»¥åŠ**==åŠ¨æ€ç±»å‹æ‰€å®ç°çš„æ–¹æ³•çš„ä¿¡æ¯==**ï¼Œå› æ­¤ifaceçš„ç¬¬ä¸€ä¸ªå­—æ®µæŒ‡å‘ä¸€ä¸ªitabç±»å‹ç»“æ„ã€‚

```go
// $GOROOT/src/runtime/runtime2.go
type itab struct {
    inter *interfacetype
    _type *_type
    hash  uint32 // copy of _type.hash. Used for type switches.
    _     [4]byte
    fun   [1]uintptr // variable sized. fun[0]==0 means _type does not implement inter.
}
```

`interfacetype`ç»“æ„ï¼Œå­˜å‚¨ç€è¿™ä¸ªæ¥å£ç±»å‹è‡ªèº«çš„ä¿¡æ¯ï¼Œç”±**ç±»å‹ä¿¡æ¯ï¼ˆtypï¼‰ã€åŒ…è·¯å¾„åï¼ˆpkgpathï¼‰å’Œæ¥å£æ–¹æ³•é›†åˆåˆ‡ç‰‡ï¼ˆmhdrï¼‰**ç»„æˆã€‚

```go
// $GOROOT/src/runtime/type.go
type interfacetype struct {
    typ     _type
    pkgpath name
    mhdr    []imethod
}
```

å­—æ®µ`_type`åˆ™å­˜å‚¨ç€è¿™ä¸ªæ¥å£ç±»å‹å˜é‡çš„åŠ¨æ€ç±»å‹çš„ä¿¡æ¯ï¼Œå­—æ®µ`fun`åˆ™æ˜¯åŠ¨æ€ç±»å‹**å·²å®ç°çš„æ¥å£æ–¹æ³•çš„è°ƒç”¨åœ°å€æ•°ç»„**ã€‚

ä¸€ä¸ªç”¨efaceè¡¨ç¤ºçš„ç©ºæ¥å£ç±»å‹å˜é‡çš„ä¾‹å­ï¼š

```go
type T struct {
    n int
    s string
}

func main() {
    var t = T {
        n: 17,
        s: "hello, interface",
    }
    
    var ei interface{} = t // Goè¿è¡Œæ—¶ä½¿ç”¨efaceç»“æ„è¡¨ç¤ºei
}
```

è¿™ä¸ªä¾‹å­ä¸­çš„ç©ºæ¥å£ç±»å‹å˜é‡eiåœ¨Goè¿è¡Œæ—¶çš„è¡¨ç¤ºæ˜¯è¿™æ ·çš„ï¼š

![](images/image-20240711225025399.png)

ç©ºæ¥å£ç±»å‹çš„è¡¨ç¤ºè¾ƒä¸ºç®€å•ï¼Œå›¾ä¸­ä¸ŠåŠéƒ¨åˆ†_typeå­—æ®µæŒ‡å‘å®ƒçš„åŠ¨æ€ç±»å‹Tçš„ç±»å‹ä¿¡æ¯ï¼Œä¸‹åŠéƒ¨åˆ†çš„dataåˆ™æ˜¯æŒ‡å‘ä¸€ä¸ªTç±»å‹çš„å®ä¾‹å€¼ã€‚

æ›´å¤æ‚çš„ç”¨ifaceè¡¨ç¤ºéç©ºæ¥å£ç±»å‹å˜é‡çš„ä¾‹å­ï¼š

```go
type T struct {
    n int
    s string
}

func (T) M1() {}
func (T) M2() {}

type NonEmptyInterface interface {
    M1()
    M2()
}

func main() {
    var t = T{
        n: 18,
        s: "hello, interface",
    }
    var i NonEmptyInterface = t
} 
```

NonEmptyInterfaceæ¥å£ç±»å‹å˜é‡åœ¨Goè¿è¡Œæ—¶è¡¨ç¤ºçš„ç¤ºæ„å›¾ï¼š

![](images/image-20240711225301398.png)

æ¯ä¸ªæ¥å£ç±»å‹å˜é‡åœ¨è¿è¡Œæ—¶çš„è¡¨ç¤ºéƒ½æ˜¯ç”±ä¸¤éƒ¨åˆ†ç»„æˆçš„ï¼Œé’ˆå¯¹ä¸åŒæ¥å£ç±»å‹æˆ‘ä»¬å¯ä»¥ç®€åŒ–è®°ä½œï¼š`eface(_type, data)`å’Œ`iface(tab, data)`ã€‚

efaceå’Œifaceçš„ç¬¬ä¸€ä¸ªå­—æ®µtabå’Œ_typeå¯ä»¥ç»Ÿä¸€çœ‹ä½œæ˜¯**åŠ¨æ€ç±»å‹çš„ç±»å‹ä¿¡æ¯**ã€‚

Goè¯­è¨€ä¸­æ¯ç§ç±»å‹éƒ½ä¼šæœ‰å”¯ä¸€çš„`_type`ä¿¡æ¯ï¼Œæ— è®ºæ˜¯å†…ç½®åŸç”Ÿç±»å‹ï¼Œè¿˜æ˜¯è‡ªå®šä¹‰ç±»å‹éƒ½æœ‰ã€‚Goè¿è¡Œæ—¶ä¼šä¸ºç¨‹åºå†…çš„å…¨éƒ¨ç±»å‹å»ºç«‹åªè¯»çš„å…±äº«`_type`ä¿¡æ¯è¡¨ï¼Œå› æ­¤æ‹¥æœ‰ç›¸åŒåŠ¨æ€ç±»å‹çš„åŒç±»æ¥å£ç±»å‹å˜é‡çš„`_type/tab`ä¿¡æ¯æ˜¯ç›¸åŒçš„ã€‚

è€Œæ¥å£ç±»å‹å˜é‡çš„dataéƒ¨åˆ†åˆ™æ˜¯æŒ‡å‘ä¸€ä¸ª**åŠ¨æ€åˆ†é…çš„å†…å­˜ç©ºé—´**ï¼Œè¿™ä¸ªå†…å­˜ç©ºé—´å­˜å‚¨çš„æ˜¯èµ‹å€¼ç»™æ¥å£ç±»å‹å˜é‡çš„åŠ¨æ€ç±»å‹å˜é‡çš„å€¼ã€‚æœªæ˜¾å¼åˆå§‹åŒ–çš„æ¥å£ç±»å‹å˜é‡çš„å€¼ä¸ºnilï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªå˜é‡çš„`_type/tab`å’Œdataéƒ½ä¸ºnilã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åˆ¤æ–­ä¸¤ä¸ªæ¥å£ç±»å‹å˜é‡æ˜¯å¦ç›¸åŒï¼Œåªéœ€è¦åˆ¤æ–­_type/tabæ˜¯å¦ç›¸åŒï¼Œä»¥åŠdataæŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ç©ºé—´æ‰€å­˜å‚¨çš„æ•°æ®å€¼æ˜¯å¦ç›¸åŒå°±å¯ä»¥äº†ã€‚è¿™é‡Œè¦æ³¨æ„ä¸æ˜¯dataæŒ‡é’ˆçš„å€¼ç›¸åŒå™¢ã€‚

ç”±äºefaceå’Œifaceæ˜¯runtimeåŒ…ä¸­çš„éå¯¼å‡ºç»“æ„ä½“å®šä¹‰ï¼Œä¸èƒ½ç›´æ¥åœ¨åŒ…å¤–ä½¿ç”¨ï¼Œæ‰€ä»¥ä¹Ÿå°±æ— æ³•ç›´æ¥è®¿é—®åˆ°ä¸¤ä¸ªç»“æ„ä½“ä¸­çš„æ•°æ®ã€‚ä¸è¿‡ï¼ŒGoè¯­è¨€æä¾›äº†`println`é¢„å®šä¹‰å‡½æ•°ï¼Œå¯ä»¥ç”¨æ¥è¾“å‡ºefaceæˆ–ifaceçš„ä¸¤ä¸ªæŒ‡é’ˆå­—æ®µçš„å€¼ã€‚

åœ¨ç¼–è¯‘é˜¶æ®µï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®è¦è¾“å‡ºçš„å‚æ•°çš„ç±»å‹å°†printlnæ›¿æ¢ä¸ºç‰¹å®šçš„å‡½æ•°:

```go
// $GOROOT/src/runtime/print.go
func printeface(e eface) {
    print("(", e._type, ",", e.data, ")")
}

func printiface(i iface) {
    print("(", i.tab, ",", i.data, ")")
}
```



ä½¿ç”¨printlnå‡½æ•°è¾“å‡ºå„ç±»æ¥å£ç±»å‹å˜é‡çš„å†…éƒ¨è¡¨ç¤ºä¿¡æ¯ï¼Œå¹¶ç»“åˆè¾“å‡ºç»“æœï¼Œè§£ææ¥å£ç±»å‹å˜é‡çš„ç­‰å€¼æ¯”è¾ƒæ“ä½œ:

#### ç¬¬ä¸€ç§ï¼šnilæ¥å£å˜é‡

```go
func printNilInterface() {
	// nilæ¥å£å˜é‡
	var i interface{} // ç©ºæ¥å£ç±»å‹
	var err error     // éç©ºæ¥å£ç±»å‹
	println(i)
	println(err)
	println("i = nil:", i == nil)
	println("err = nil:", err == nil)
	println("i = err:", i == err)
}

/*
(0x0,0x0)
(0x0,0x0)
i = nil: true
err = nil: true
i = err: true
*/
```

æ— è®ºæ˜¯ç©ºæ¥å£ç±»å‹è¿˜æ˜¯éç©ºæ¥å£ç±»å‹å˜é‡ï¼Œä¸€æ—¦å˜é‡å€¼ä¸ºnilï¼Œé‚£ä¹ˆå®ƒä»¬å†…éƒ¨è¡¨ç¤ºå‡ä¸º(0x0,0x0)ï¼Œä¹Ÿå°±æ˜¯ç±»å‹ä¿¡æ¯ã€æ•°æ®å€¼ä¿¡æ¯å‡ä¸ºç©ºã€‚

#### ç¬¬äºŒç§ï¼šç©ºæ¥å£ç±»å‹å˜é‡

```go
func printEmptyInterface() {
   var eif1 interface{} // ç©ºæ¥å£ç±»å‹
   var eif2 interface{} // ç©ºæ¥å£ç±»å‹
   var n, m int = 17, 18

   eif1 = n
   eif2 = m

   println("eif1:", eif1)
   println("eif2:", eif2)
   println("eif1 = eif2:", eif1 == eif2) // false

   eif2 = 17
   println("eif1:", eif1)
   println("eif2:", eif2)
   println("eif1 = eif2:", eif1 == eif2) // true

   eif2 = int64(17)
   println("eif1:", eif1)
   println("eif2:", eif2)
   println("eif1 = eif2:", eif1 == eif2) // false
}
```

å¯¹äºç©ºæ¥å£ç±»å‹å˜é‡ï¼Œåªæœ‰_typeå’Œdataæ‰€æŒ‡æ•°æ®å†…å®¹ä¸€è‡´çš„æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªç©ºæ¥å£ç±»å‹å˜é‡ä¹‹é—´æ‰èƒ½åˆ’ç­‰å·ã€‚

#### ç¬¬ä¸‰ç§ï¼šéç©ºæ¥å£ç±»å‹å˜é‡

```go
type T int

func (t T) Error() string {
	return "bad error"
}
func printNonEmptyInterface() {
	var err1 error // éç©ºæ¥å£ç±»å‹
	var err2 error // éç©ºæ¥å£ç±»å‹
	err1 = (*T)(nil)
	println("err1:", err1)
	println("err1 = nil:", err1 == nil)

	err1 = T(5)
	err2 = T(6)
	println("err1:", err1)
	println("err2:", err2)
	println("err1 = err2:", err1 == err2)

	err2 = fmt.Errorf("%d\n", 5)
	println("err1:", err1)
	println("err2:", err2)
	println("err1 = err2:", err1 == err2)
}
/**
err1: (0x102e30558,0x0)
err1 = nil: false
err1: (0x102e30578,0x102e0feb8)
err2: (0x102e30578,0x102e0fec0)
err1 = err2: false
err1: (0x102e30578,0x102e0feb8)
err2: (0x102e305d8,0x14000010040)
err1 = err2: false
 */
```

ç¬¬ä¸€ä¸ªè¾“å‡ºerr1æ˜¯`(0x102e30558,0x0)`ï¼Œä¹Ÿå°±æ˜¯**éç©ºæ¥å£ç±»å‹å˜é‡çš„ç±»å‹ä¿¡æ¯å¹¶ä¸ä¸ºç©ºï¼Œæ•°æ®æŒ‡é’ˆä¸ºç©º**ï¼Œå› æ­¤å®ƒä¸`nilï¼ˆ0x0,0x0ï¼‰`ä¹‹é—´ä¸èƒ½åˆ’ç­‰å·ã€‚

è¿™å°±è§£é‡Šäº†[29.2](#29.2 nil errorå€¼ != nil)ä¸­çš„é—®é¢˜ã€‚

#### ç¬¬å››ç§ï¼šç©ºæ¥å£ç±»å‹å˜é‡ä¸éç©ºæ¥å£ç±»å‹å˜é‡çš„ç­‰å€¼æ¯”è¾ƒ

```go
func printEmptyInterfaceAndNonEmptyInterface() {
	var eif interface{} = T(5)
	var err error = T(5)
	println("eif:", eif)
	println("err:", err)
	println("eif = err:", eif == err) // true

	err = T(6)
	println("eif:", eif)
	println("err:", err)
	println("eif = err:", eif == err) // false
}
```

æ¥å£ç±»å‹å˜é‡å’Œéç©ºæ¥å£ç±»å‹å˜é‡å†…éƒ¨è¡¨ç¤ºçš„ç»“æ„æœ‰æ‰€ä¸åŒï¼ˆç¬¬ä¸€ä¸ªå­—æ®µï¼š`_type` vs. `tab`)ï¼Œä¸¤è€…ä¼¼ä¹ä¸€å®šä¸èƒ½ç›¸ç­‰ã€‚ä½†Goåœ¨è¿›è¡Œç­‰å€¼æ¯”è¾ƒæ—¶ï¼Œç±»å‹æ¯”è¾ƒä½¿ç”¨çš„æ˜¯efaceçš„`_type`å’Œifaceçš„`tab._type`ã€‚

### 29.4 è¾“å‡ºæ¥å£ç±»å‹å˜é‡å†…éƒ¨è¡¨ç¤ºçš„è¯¦ç»†ä¿¡æ¯ â¤ï¸

printlnè¾“å‡ºçš„æ¥å£ç±»å‹å˜é‡çš„å†…éƒ¨è¡¨ç¤ºä¿¡æ¯ï¼Œæœ‰äº›æ—¶å€™åˆæ˜¾å¾—è¿‡äºç®€ç•¥ã€‚

é€šè¿‡â€œ**å¤åˆ¶ä»£ç **â€çš„æ–¹å¼å°†å®ƒä»¬æ‹¿åˆ°runtimeåŒ…å¤–é¢æ¥



### 29.5 æ¥å£ç±»å‹çš„è£…ç®±ï¼ˆboxingï¼‰åŸç†

==è£…ç®±ï¼ˆboxingï¼‰==æ˜¯ç¼–ç¨‹è¯­è¨€é¢†åŸŸçš„ä¸€ä¸ªåŸºç¡€æ¦‚å¿µï¼Œä¸€èˆ¬æ˜¯æŒ‡**æŠŠä¸€ä¸ªå€¼ç±»å‹è½¬æ¢æˆå¼•ç”¨ç±»å‹**ï¼Œæ¯”å¦‚åœ¨æ”¯æŒè£…ç®±æ¦‚å¿µçš„Javaè¯­è¨€ä¸­ï¼Œå°†ä¸€ä¸ªintå˜é‡è½¬æ¢æˆIntegerå¯¹è±¡å°±æ˜¯ä¸€ä¸ªè£…ç®±æ“ä½œã€‚

åœ¨Goè¯­è¨€ä¸­ï¼Œ**å°†ä»»æ„ç±»å‹èµ‹å€¼ç»™ä¸€ä¸ªæ¥å£ç±»å‹å˜é‡**ä¹Ÿæ˜¯è£…ç®±æ“ä½œã€‚

```go
// interface_internal.go
  type T struct {
      n int
      s string
  }
  
  func (T) M1() {}
  func (T) M2() {}
  
  type NonEmptyInterface interface {
      M1()
      M2()
  }
  
  func main() {
      var t = T{
          n: 17,
          s: "hello, interface",
      }
      var ei interface{}
      ei = t
 
      var i NonEmptyInterface
      i = t
      fmt.Println(ei)
      fmt.Println(i)
  }
```



```sh
go tool compile -S interface_internal.go > interface_internal.s
```

> é—®é¢˜ï¼š ğŸ”–
>
> `could not import fmt (file not found)`
>
> å¯èƒ½åŸå› ï¼šhttps://github.com/golang/go/issues/58629



## 30 æ¥å£ï¼šGoä¸­æœ€å¼ºå¤§çš„é­”æ³•

### 30.1 ä¸€åˆ‡çš†ç»„åˆ

å¦‚æœC++å’ŒJavaæ˜¯å…³äºç±»å‹**å±‚æ¬¡**ç»“æ„å’Œç±»å‹**åˆ†ç±»**çš„è¯­è¨€ï¼Œé‚£ä¹ˆGoåˆ™æ˜¯å…³äº**ç»„åˆ**çš„è¯­è¨€ã€‚

å¦‚æœæŠŠGoåº”ç”¨ç¨‹åºæ¯”ä½œæ˜¯ä¸€å°æœºå™¨çš„è¯ï¼Œé‚£ä¹ˆç»„åˆå…³æ³¨çš„å°±æ˜¯å¦‚ä½•å°†æ•£è½åœ¨å„ä¸ªåŒ…ä¸­çš„â€œé›¶ä»¶â€å…³è”å¹¶ç»„è£…åˆ°ä¸€èµ·ã€‚

æ­£äº¤æ€§

> ==æ­£äº¤ï¼ˆOrthogonalityï¼‰==æ˜¯ä»å‡ ä½•å­¦ä¸­å€Ÿç”¨çš„æœ¯è¯­ï¼Œè¯´çš„æ˜¯å¦‚æœä¸¤æ¡çº¿ä»¥ç›´è§’ç›¸äº¤ï¼Œé‚£ä¹ˆè¿™ä¸¤æ¡çº¿å°±æ˜¯æ­£äº¤çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨ä»£æ•°è¯¾ç¨‹ä¸­ç»å¸¸ç”¨åˆ°çš„åæ ‡è½´å°±æ˜¯è¿™æ ·ã€‚ç”¨å‘é‡æœ¯è¯­è¯´ï¼Œ**è¿™ä¸¤æ¡ç›´çº¿äº’ä¸ä¾èµ–ï¼Œæ²¿ç€æŸä¸€æ¡ç›´çº¿ç§»åŠ¨ï¼Œä½ æŠ•å½±åˆ°å¦ä¸€æ¡ç›´çº¿ä¸Šçš„ä½ç½®ä¸å˜ã€‚**

åœ¨è®¡ç®—æœºæŠ€æœ¯ä¸­ï¼Œæ­£äº¤æ€§ç”¨äºè¡¨ç¤ºæŸç§**ä¸ç›¸ä¾èµ–æ€§æˆ–æ˜¯è§£è€¦æ€§**ã€‚å¦‚æœä¸¤ä¸ªæˆ–æ›´å¤šäº‹ç‰©ä¸­çš„ä¸€ä¸ªå‘ç”Ÿå˜åŒ–ï¼Œä¸ä¼šå½±å“å…¶ä»–äº‹ç‰©ï¼Œé‚£ä¹ˆè¿™äº›äº‹ç‰©å°±æ˜¯æ­£äº¤çš„ã€‚æ¯”å¦‚ï¼Œåœ¨è®¾è®¡è‰¯å¥½çš„ç³»ç»Ÿä¸­ï¼Œæ•°æ®åº“ä»£ç ä¸ç”¨æˆ·ç•Œé¢æ˜¯æ­£äº¤çš„ï¼šä½ å¯ä»¥æ”¹åŠ¨ç•Œé¢ï¼Œè€Œä¸å½±å“æ•°æ®åº“ï¼›æ›´æ¢æ•°æ®åº“ï¼Œè€Œä¸ç”¨æ”¹åŠ¨ç•Œé¢ã€‚

**ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•å…ƒç´ é—´å’Œè¯­è¨€ç‰¹æ€§ä¹Ÿå­˜åœ¨ç€æ­£äº¤çš„æƒ…å†µï¼Œå¹¶ä¸”é€šè¿‡å°†è¿™äº›æ­£äº¤çš„ç‰¹æ€§ç»„åˆèµ·æ¥ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°æ›´ä¸ºé«˜çº§çš„ç‰¹æ€§**ã€‚åœ¨è¯­è¨€è®¾è®¡å±‚é¢ï¼ŒGoè¯­è¨€å°±ä¸ºå¹¿å¤§Gopheræä¾›äº†è¯¸å¤š**æ­£äº¤çš„è¯­æ³•å…ƒç´ **ä¾›åç»­ç»„åˆä½¿ç”¨ï¼ŒåŒ…æ‹¬ï¼šğŸ”–

- Goè¯­è¨€æ— ç±»å‹ä½“ç³»ï¼ˆType Hierarchyï¼‰ï¼Œæ²¡æœ‰çˆ¶å­ç±»çš„æ¦‚å¿µï¼Œç±»å‹å®šä¹‰æ˜¯æ­£äº¤ç‹¬ç«‹çš„ï¼›
- æ–¹æ³•å’Œç±»å‹æ˜¯æ­£äº¤çš„ï¼Œæ¯ç§ç±»å‹éƒ½å¯ä»¥æ‹¥æœ‰è‡ªå·±çš„æ–¹æ³•é›†åˆï¼Œæ–¹æ³•æœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ªå°†receiverå‚æ•°ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°çš„å‡½æ•°è€Œå·²ï¼›
- æ¥å£ä¸å®ƒçš„å®ç°è€…ä¹‹é—´æ— â€œæ˜¾å¼å…³è”â€ï¼Œä¹Ÿå°±è¯´æ¥å£ä¸Goè¯­è¨€å…¶ä»–éƒ¨åˆ†ä¹Ÿæ˜¯æ­£äº¤çš„ã€‚

åœ¨è¿™äº›æ­£äº¤è¯­æ³•å…ƒç´ å½“ä¸­ï¼Œæ¥å£ä½œä¸º**Goè¯­è¨€æä¾›çš„å…·æœ‰å¤©ç„¶æ­£äº¤æ€§çš„è¯­æ³•å…ƒç´ **ï¼Œåœ¨Goç¨‹åºçš„é™æ€ç»“æ„æ­å»ºä¸è€¦åˆè®¾è®¡ä¸­æ‰®æ¼”ç€è‡³å…³é‡è¦çš„è§’è‰²ã€‚

![](images/image-20240704185654091.png)

### 30.2 å‚ç›´ç»„åˆ

ç±»å‹åµŒå…¥ï¼ˆType Embeddingï¼‰

#### ç¬¬ä¸€ç§ï¼šé€šè¿‡åµŒå…¥æ¥å£æ„å»ºæ¥å£

```go
// $GOROOT/src/io/io.go
type ReadWriter interface {
    Reader
    Writer
}
```

#### ç¬¬äºŒç§ï¼šé€šè¿‡åµŒå…¥æ¥å£æ„å»ºç»“æ„ä½“ç±»å‹

```go
type MyReader struct {
	io.Reader // underlying reader
	N int64   // max bytes remaining
}
```

#### ç¬¬ä¸‰ç§ï¼šé€šè¿‡åµŒå…¥ç»“æ„ä½“ç±»å‹æ„å»ºæ–°ç»“æ„ä½“ç±»å‹

### 30.3 æ°´å¹³ç»„åˆ ğŸ”–

æ¥å£åˆ†ç¦»åŸåˆ™ï¼ˆISPåŸåˆ™ï¼ŒInterface Segregation Principleï¼‰



```go
func Save(f *os.File, data []byte) error
```

æ”¹æˆï¼š

```go
func Save(w io.Writer, data []byte) error
```

io.Writerä»…åŒ…å«ä¸€ä¸ªWriteæ–¹æ³•ï¼Œè€Œä¸”è¿™ä¸ªæ–¹æ³•æ°æ°æ˜¯Saveå”¯ä¸€éœ€è¦çš„æ–¹æ³•ã€‚

ä»¥io.Writeræ¥å£ç±»å‹è¡¨ç¤ºæ•°æ®å†™å…¥çš„ç›®çš„åœ°ï¼Œæ—¢å¯ä»¥æ”¯æŒå‘ç£ç›˜å†™å…¥ï¼Œä¹Ÿå¯ä»¥æ”¯æŒå‘ç½‘ç»œå­˜å‚¨å†™å…¥ï¼Œå¹¶æ”¯æŒä»»ä½•å®ç°äº†Writeæ–¹æ³•çš„å†™å…¥è¡Œä¸ºï¼Œè¿™è®©Saveå‡½æ•°çš„**æ‰©å±•æ€§**å¾—åˆ°äº†è´¨çš„æå‡ã€‚

å¯¹Saveå‡½æ•°çš„æµ‹è¯•ä¹Ÿå°†å˜å¾—ååˆ†å®¹æ˜“:

```go
func TestSave(t *testing.T) {
    b := make([]byte, 0, 128)
    buf := bytes.NewBuffer(b)
    data := []byte("hello, golang")
    err := Save(buf, data)
    if err != nil {
        t.Errorf("want nil, actual %s", err.Error())
    }

    saved := buf.Bytes()
    if !reflect.DeepEqual(saved, data) {
        t.Errorf("want %s, actual %s", string(data), string(saved))
    }
}
```

ç”±äºbytes.Bufferå®ç°äº†Writeæ–¹æ³•ï¼Œè¿›è€Œå®ç°äº†io.Writeræ¥å£ï¼Œå¯ä»¥åˆæ³•åœ°å°†å˜é‡bufä¼ é€’ç»™Saveå‡½æ•°ã€‚æ­¤åè¿‡ç¨‹ä¸­ï¼Œä¸éœ€è¦åˆ›å»ºä»»ä½•ç£ç›˜æ–‡ä»¶æˆ–å»ºç«‹ä»»ä½•ç½‘ç»œè¿æ¥ã€‚

### 30.4 æ¥å£åº”ç”¨çš„å‡ ç§æ¨¡å¼

é€šè¿‡æ¥å£è¿›è¡Œæ°´å¹³ç»„åˆçš„åŸºæœ¬æ¨¡å¼å°±æ˜¯ï¼š**ä½¿ç”¨æ¥å—æ¥å£ç±»å‹å‚æ•°çš„å‡½æ•°æˆ–æ–¹æ³•**ã€‚åœ¨è¿™ä¸ªåŸºæœ¬æ¨¡å¼åŸºç¡€ä¸Šï¼Œè¿˜æœ‰å…¶ä»–å‡ ç§â€œè¡ç”Ÿå“â€ã€‚

#### åŸºæœ¬æ¨¡å¼

æ¥å—æ¥å£ç±»å‹å‚æ•°çš„å‡½æ•°æˆ–æ–¹æ³•æ˜¯æ°´å¹³ç»„åˆçš„åŸºæœ¬è¯­æ³•:

```go
func YourFuncName(param YourInterfaceType)
```

![](images/image-20240711233617283.png)

å‡½æ•°/æ–¹æ³•å‚æ•°ä¸­çš„æ¥å£ç±»å‹ä½œä¸ºâ€œå…³èŠ‚ï¼ˆè¿æ¥ç‚¹ï¼‰â€ï¼Œæ”¯æŒå°†ä½äºå¤šä¸ªåŒ…ä¸­çš„å¤šä¸ªç±»å‹ä¸YourFuncNameå‡½æ•°è¿æ¥åˆ°ä¸€èµ·ï¼Œå…±åŒå®ç°æŸä¸€æ–°ç‰¹æ€§ã€‚

åŒæ—¶ï¼Œæ¥å£ç±»å‹å’Œå®ƒçš„å®ç°è€…ä¹‹é—´éšå¼çš„å…³ç³»å´åœ¨ä¸ç»æ„é—´æ»¡è¶³äº†ï¼šä¾èµ–æŠ½è±¡ï¼ˆDIPï¼‰ã€é‡Œæ°æ›¿æ¢åŸåˆ™ï¼ˆLSPï¼‰ã€æ¥å£éš”ç¦»ï¼ˆISPï¼‰ç­‰ä»£ç è®¾è®¡åŸåˆ™ï¼Œè¿™åœ¨å…¶ä»–è¯­è¨€ä¸­æ˜¯éœ€è¦å¾ˆâ€œåˆ»æ„â€åœ°è®¾è®¡è°‹åˆ’çš„ï¼Œä½†å¯¹Goæ¥å£æ¥çœ‹ï¼Œè¿™ä¸€åˆ‡å´æ˜¯è‡ªç„¶è€Œç„¶çš„ã€‚

#### åˆ›å»ºæ¨¡å¼

Goç¤¾åŒºæµä¼ ä¸€ä¸ªç»éªŒæ³•åˆ™ï¼šâ€œ**æ¥å—æ¥å£ï¼Œè¿”å›ç»“æ„ä½“ï¼ˆAccept interfaces, return structsï¼‰**â€ï¼Œè¿™å…¶å®å°±æ˜¯ä¸€ç§æŠŠæ¥å£ä½œä¸ºâ€œå…³èŠ‚â€çš„åº”ç”¨æ¨¡å¼ã€‚æˆ‘è¿™é‡ŒæŠŠå®ƒå«åš**åˆ›å»ºæ¨¡å¼**ï¼Œæ˜¯å› ä¸ºè¿™ä¸ªç»éªŒæ³•åˆ™å¤šç”¨äºåˆ›å»ºæŸä¸€ç»“æ„ä½“ç±»å‹çš„å®ä¾‹ã€‚

```go
// $GOROOT/src/sync/cond.go
type Cond struct {
    ... ...
    L Locker
}

func NewCond(l Locker) *Cond {
    return &Cond{L: l}
}

// $GOROOT/src/log/log.go
type Logger struct {
    mu     sync.Mutex 
    prefix string     
    flag   int        
    out    io.Writer  
    buf    []byte    
}

func New(out io.Writer, prefix string, flag int) *Logger {
    return &Logger{out: out, prefix: prefix, flag: flag}
}

// $GOROOT/src/log/log.go
type Writer struct {
    err error
    buf []byte
    n   int
    wr  io.Writer
}

func NewWriterSize(w io.Writer, size int) *Writer {
    // Is it already a Writer?
    b, ok := w.(*Writer)
    if ok && len(b.buf) >= size {
        return b
    }
    if size <= 0 {
        size = defaultBufSize
    }
    return &Writer{
        buf: make([]byte, size),
        wr:  w,
    }
} 
```



#### åŒ…è£…å™¨æ¨¡å¼

åœ¨åŸºæœ¬æ¨¡å¼çš„åŸºç¡€ä¸Šï¼Œå½“è¿”å›å€¼çš„ç±»å‹ä¸å‚æ•°ç±»å‹ç›¸åŒæ—¶:

```go
func YourWrapperFunc(param YourInterfaceType) YourInterfaceType
```

é€šè¿‡è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°å¯¹è¾“å…¥å‚æ•°çš„ç±»å‹çš„åŒ…è£…ï¼Œå¹¶åœ¨ä¸æ”¹å˜è¢«åŒ…è£…ç±»å‹ï¼ˆè¾“å…¥å‚æ•°ç±»å‹ï¼‰çš„å®šä¹‰çš„æƒ…å†µä¸‹ï¼Œè¿”å›å…·å¤‡æ–°åŠŸèƒ½ç‰¹æ€§çš„ã€å®ç°ç›¸åŒæ¥å£ç±»å‹çš„æ–°ç±»å‹ã€‚è¿™ç§æ¥å£åº”ç”¨æ¨¡å¼æˆ‘ä»¬å«å®ƒ**åŒ…è£…å™¨æ¨¡å¼**ï¼Œä¹Ÿå«**è£…é¥°å™¨æ¨¡å¼**ã€‚åŒ…è£…å™¨å¤šç”¨äº**å¯¹è¾“å…¥æ•°æ®çš„è¿‡æ»¤ã€å˜æ¢ç­‰**æ“ä½œã€‚

```go
// $GOROOT/src/io/io.go
func LimitReader(r Reader, n int64) Reader { return &LimitedReader{r, n} }

type LimitedReader struct {
    R Reader // underlying reader
    N int64  // max bytes remaining
}

func (l *LimitedReader) Read(p []byte) (n int, err error) {
    // ... ...
}
```



#### é€‚é…å™¨æ¨¡å¼

é€‚é…å™¨æ¨¡å¼ä¸æ˜¯åŸºæœ¬æ¨¡å¼çš„ç›´æ¥è¡ç”Ÿæ¨¡å¼ï¼Œä½†è¿™ç§æ¨¡å¼æ˜¯ä¸­é—´ä»¶æ¨¡å¼çš„å‰æã€‚

é€‚é…å™¨æ¨¡å¼çš„æ ¸å¿ƒæ˜¯**é€‚é…å™¨å‡½æ•°ç±»å‹ï¼ˆAdapter Function Typeï¼‰**ï¼Œå®ƒæ˜¯ä¸€ä¸ªè¾…åŠ©æ°´å¹³ç»„åˆå®ç°çš„â€œå·¥å…·â€ç±»å‹ã€‚



#### ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰

ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰è¿™ä¸ªè¯çš„å«ä¹‰å¯å¤§å¯å°ã€‚åœ¨Go Webç¼–ç¨‹ä¸­ï¼Œâ€œä¸­é—´ä»¶â€å¸¸å¸¸æŒ‡çš„æ˜¯ä¸€ä¸ªå®ç°äº†http.Handleræ¥å£çš„http.HandlerFuncç±»å‹å®ä¾‹ã€‚å®è´¨ä¸Šï¼Œè¿™é‡Œçš„**ä¸­é—´ä»¶å°±æ˜¯åŒ…è£…æ¨¡å¼å’Œé€‚é…å™¨æ¨¡å¼ç»“åˆçš„äº§ç‰©**ã€‚



### 30.5 å°½é‡é¿å…ä½¿ç”¨ç©ºæ¥å£ä½œä¸ºå‡½æ•°å‚æ•°ç±»å‹

> ç©ºæ¥å£ä¸æä¾›ä»»ä½•ä¿¡æ¯ï¼ˆThe empty interface says nothingï¼‰ã€‚



## 31 å¹¶å‘ï¼šGoçš„å¹¶å‘æ–¹æ¡ˆå®ç°æ–¹æ¡ˆæ˜¯æ€æ ·çš„ï¼Ÿ

Goçš„è®¾è®¡è€…å°†é¢å‘å¤šæ ¸ã€**åŸç”Ÿæ”¯æŒå¹¶å‘**ä½œä¸ºäº†Goè¯­è¨€çš„è®¾è®¡ç›®æ ‡ä¹‹ä¸€ï¼Œå¹¶å°†é¢å‘å¹¶å‘ä½œä¸ºGoçš„è®¾è®¡å“²å­¦ã€‚

### 31.1 ä»€ä¹ˆæ˜¯å¹¶å‘ï¼Ÿ

å¹¶å‘ï¼ˆconcurrencyï¼‰

å¹¶è¡Œï¼ˆparallelismï¼‰

å¾ˆä¹…ä»¥å‰ï¼Œé¢å‘å¤§ä¼—æ¶ˆè´¹è€…çš„ä¸»æµå¤„ç†å™¨ï¼ˆCPUï¼‰éƒ½æ˜¯å•æ ¸çš„ï¼Œæ“ä½œç³»ç»Ÿçš„**åŸºæœ¬è°ƒåº¦ä¸æ‰§è¡Œå•å…ƒ**æ˜¯==è¿›ç¨‹ï¼ˆprocessï¼‰==ã€‚è¿™ä¸ªæ—¶å€™ï¼Œ**ç”¨æˆ·å±‚çš„åº”ç”¨**æœ‰ä¸¤ç§è®¾è®¡æ–¹å¼ï¼Œä¸€ç§æ˜¯==å•è¿›ç¨‹åº”ç”¨==ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡å¯åŠ¨ä¸€ä¸ªåº”ç”¨ï¼Œæ“ä½œç³»ç»Ÿéƒ½åªå¯åŠ¨ä¸€ä¸ªè¿›ç¨‹æ¥è¿è¡Œè¿™ä¸ªåº”ç”¨ã€‚

å•è¿›ç¨‹åº”ç”¨çš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·å±‚åº”ç”¨ã€æ“ä½œç³»ç»Ÿè¿›ç¨‹ä»¥åŠå¤„ç†å™¨ä¹‹é—´çš„å…³ç³»:

![](images/image-20240711234318877.png)

è¿™ä¸ªè®¾è®¡ä¸‹ï¼Œæ¯ä¸ªå•è¿›ç¨‹åº”ç”¨å¯¹åº”ä¸€ä¸ªæ“ä½œç³»ç»Ÿè¿›ç¨‹ï¼Œæ“ä½œç³»ç»Ÿå†…çš„å¤šä¸ªè¿›ç¨‹æŒ‰æ—¶é—´ç‰‡å¤§å°ï¼Œè¢«è½®æµè°ƒåº¦åˆ°ä»…æœ‰çš„ä¸€é¢—å•æ ¸å¤„ç†å™¨ä¸Šæ‰§è¡Œã€‚æ¢å¥è¯è¯´ï¼Œè¿™é¢—å•æ ¸å¤„ç†å™¨åœ¨æŸä¸ªæ—¶åˆ»åªèƒ½æ‰§è¡Œä¸€ä¸ªè¿›ç¨‹å¯¹åº”çš„ç¨‹åºä»£ç ï¼Œä¸¤ä¸ªè¿›ç¨‹ä¸å­˜åœ¨å¹¶è¡Œæ‰§è¡Œçš„å¯èƒ½ã€‚

**å¹¶è¡Œï¼ˆparallelismï¼‰ï¼ŒæŒ‡çš„å°±æ˜¯åœ¨åŒä¸€æ—¶åˆ»ï¼Œæœ‰ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„ä»»åŠ¡ï¼ˆè¿™é‡ŒæŒ‡è¿›ç¨‹ï¼‰çš„ä»£ç åœ¨å¤„ç†å™¨ä¸Šæ‰§è¡Œ**ã€‚ä»è¿™ä¸ªæ¦‚å¿µæˆ‘ä»¬ä¹Ÿå¯ä»¥çŸ¥é“ï¼Œå¤šä¸ªå¤„ç†å™¨æˆ–å¤šæ ¸å¤„ç†å™¨æ˜¯å¹¶è¡Œæ‰§è¡Œçš„å¿…è¦æ¡ä»¶ã€‚

æ€»çš„æ¥è¯´ï¼Œå•è¿›ç¨‹åº”ç”¨çš„è®¾è®¡æ¯”è¾ƒç®€å•ï¼Œå®ƒçš„å†…éƒ¨ä»…æœ‰ä¸€æ¡ä»£ç æ‰§è¡Œæµï¼Œä»£ç ä»å¤´æ‰§è¡Œåˆ°å°¾ï¼Œ**ä¸å­˜åœ¨ç«æ€ï¼Œæ— éœ€è€ƒè™‘åŒæ­¥é—®é¢˜**ã€‚

ç”¨æˆ·å±‚çš„å¦å¤–ä¸€ç§è®¾è®¡æ–¹å¼ï¼Œå°±æ˜¯==å¤šè¿›ç¨‹åº”ç”¨==ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨é€šè¿‡forkç­‰ç³»ç»Ÿè°ƒç”¨åˆ›å»ºå¤šä¸ªå­è¿›ç¨‹ï¼Œå…±åŒå®ç°åº”ç”¨çš„åŠŸèƒ½ã€‚å¤šè¿›ç¨‹åº”ç”¨çš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·å±‚åº”ç”¨ã€æ“ä½œç³»ç»Ÿè¿›ç¨‹ä»¥åŠå¤„ç†å™¨ä¹‹é—´çš„å…³ç³»:

![](images/image-20240711234429579.png)

ä»¥å›¾ä¸­çš„App1ä¸ºä¾‹ï¼Œè¿™ä¸ªåº”ç”¨è®¾è®¡è€…å°†åº”ç”¨å†…éƒ¨åˆ’åˆ†ä¸ºå¤šä¸ªæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—ç”¨ä¸€ä¸ªè¿›ç¨‹æ‰¿è½½æ‰§è¡Œï¼Œæ¯ä¸ªæ¨¡å—éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„æ‰§è¡Œæµï¼Œè¿™æ ·ï¼ŒApp1å†…éƒ¨å°±æœ‰äº†å¤šä¸ªç‹¬ç«‹çš„ä»£ç æ‰§è¡Œæµã€‚

ä½†é™äºå½“å‰ä»…æœ‰ä¸€é¢—å•æ ¸å¤„ç†å™¨ï¼Œè¿™äº›è¿›ç¨‹ï¼ˆæ‰§è¡Œæµï¼‰ä¾æ—§æ— æ³•å¹¶è¡Œæ‰§è¡Œï¼Œæ— è®ºæ˜¯App1å†…éƒ¨çš„æŸä¸ªæ¨¡å—å¯¹åº”çš„è¿›ç¨‹ï¼Œè¿˜æ˜¯å…¶ä»–Appå¯¹åº”çš„è¿›ç¨‹ï¼Œéƒ½å¾—é€ä¸ªæŒ‰æ—¶é—´ç‰‡è¢«æ“ä½œç³»ç»Ÿè°ƒåº¦åˆ°å¤„ç†å™¨ä¸Šæ‰§è¡Œã€‚

**ç²—ç•¥çœ‹èµ·æ¥ï¼Œå¤šè¿›ç¨‹åº”ç”¨ä¸å•è¿›ç¨‹åº”ç”¨ç›¸æ¯”å¹¶æ²¡æœ‰ä»€ä¹ˆè´¨çš„æå‡ã€‚é‚£æˆ‘ä»¬ä¸ºä»€ä¹ˆè¿˜è¦å°†åº”ç”¨è®¾è®¡ä¸ºå¤šè¿›ç¨‹å‘¢ï¼Ÿ**

è¿™æ›´å¤šæ˜¯ä»**åº”ç”¨çš„ç»“æ„**è§’åº¦å»è€ƒè™‘çš„ï¼Œå¤šè¿›ç¨‹åº”ç”¨ç”±äº**å°†åŠŸèƒ½èŒè´£åšäº†åˆ’åˆ†**ï¼Œå¹¶æŒ‡å®šä¸“é—¨çš„æ¨¡å—æ¥è´Ÿè´£ï¼Œæ‰€ä»¥ä»ç»“æ„ä¸Šæ¥çœ‹ï¼Œè¦æ¯”å•è¿›ç¨‹æ›´ä¸ºæ¸…æ™°ç®€æ´ï¼Œå¯è¯»æ€§ä¸å¯ç»´æŠ¤æ€§ä¹Ÿæ›´å¥½ã€‚**è¿™ç§å°†ç¨‹åºåˆ†æˆå¤šä¸ªå¯ç‹¬ç«‹æ‰§è¡Œçš„éƒ¨åˆ†çš„ç»“æ„åŒ–ç¨‹åºçš„è®¾è®¡æ–¹æ³•ï¼Œå°±æ˜¯==å¹¶å‘è®¾è®¡==**ã€‚é‡‡ç”¨äº†å¹¶å‘è®¾è®¡çš„åº”ç”¨ä¹Ÿå¯ä»¥çœ‹æˆæ˜¯**ä¸€ç»„ç‹¬ç«‹æ‰§è¡Œçš„æ¨¡å—çš„ç»„åˆ**ã€‚



ä¸è¿‡ï¼Œè¿›ç¨‹å¹¶ä¸é€‚åˆç”¨äºæ‰¿è½½é‡‡ç”¨äº†å¹¶å‘è®¾è®¡çš„åº”ç”¨çš„æ¨¡å—æ‰§è¡Œæµã€‚å› ä¸ºè¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿä¸­èµ„æºæ‹¥æœ‰çš„åŸºæœ¬å•ä½ï¼Œå®ƒä¸ä»…åŒ…å«åº”ç”¨çš„ä»£ç å’Œæ•°æ®ï¼Œè¿˜æœ‰ç³»ç»Ÿçº§çš„èµ„æºï¼Œæ¯”å¦‚æ–‡ä»¶æè¿°ç¬¦ã€å†…å­˜åœ°å€ç©ºé—´ç­‰ç­‰ã€‚è¿›ç¨‹çš„â€œåŒ…è¢±â€å¤ªé‡ï¼Œè¿™å¯¼è‡´å®ƒçš„åˆ›å»ºã€åˆ‡æ¢ä¸æ’¤é”€çš„ä»£ä»·éƒ½å¾ˆå¤§ã€‚

äºæ˜¯çº¿ç¨‹ä¾¿èµ°å…¥äº†äººä»¬çš„è§†é‡ï¼Œ==çº¿ç¨‹==å°±æ˜¯**è¿è¡Œäºè¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­çš„æ›´è½»é‡çº§çš„æ‰§è¡Œæµ**ã€‚åŒæ—¶éšç€å¤„ç†å™¨æŠ€æœ¯çš„å‘å±•ï¼Œå¤šæ ¸å¤„ç†å™¨ç¡¬ä»¶æˆä¸ºäº†ä¸»æµï¼Œè¿™è®©çœŸæ­£çš„å¹¶è¡Œæˆä¸ºäº†å¯èƒ½ï¼Œäºæ˜¯ä¸»æµçš„åº”ç”¨è®¾è®¡æ¨¡å‹å˜æˆäº†è¿™æ ·ï¼š

![](images/image-20240717152619145.png)

åŸºäºçº¿ç¨‹çš„åº”ç”¨é€šå¸¸é‡‡ç”¨**å•è¿›ç¨‹å¤šçº¿ç¨‹çš„æ¨¡å‹**ï¼Œä¸€ä¸ªåº”ç”¨å¯¹åº”ä¸€ä¸ªè¿›ç¨‹ï¼Œåº”ç”¨é€šè¿‡å¹¶å‘è®¾è®¡å°†è‡ªå·±**åˆ’åˆ†ä¸ºå¤šä¸ªæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—ç”±ä¸€ä¸ªçº¿ç¨‹ç‹¬ç«‹æ‰¿è½½æ‰§è¡Œ**ã€‚å¤šä¸ªçº¿ç¨‹å…±äº«è¿™ä¸ªè¿›ç¨‹æ‰€æ‹¥æœ‰çš„èµ„æºï¼Œä½†çº¿ç¨‹ä½œä¸ºæ‰§è¡Œå•å…ƒå¯è¢«ç‹¬ç«‹è°ƒåº¦åˆ°å¤„ç†å™¨ä¸Šè¿è¡Œã€‚

çº¿ç¨‹çš„åˆ›å»ºã€åˆ‡æ¢ä¸æ’¤é”€çš„ä»£ä»·ç›¸å¯¹äºè¿›ç¨‹æ˜¯è¦å°å¾—å¤šã€‚å½“è¿™ä¸ªåº”ç”¨çš„å¤šä¸ªçº¿ç¨‹åŒæ—¶è¢«è°ƒåº¦åˆ°ä¸åŒçš„å¤„ç†å™¨æ ¸ä¸Šæ‰§è¡Œæ—¶ï¼Œæˆ‘ä»¬å°±è¯´è¿™ä¸ªåº”ç”¨æ˜¯å¹¶è¡Œçš„ã€‚

> Rob Pikeï¼š**å¹¶å‘ä¸æ˜¯å¹¶è¡Œï¼Œå¹¶å‘å…³ä¹ç»“æ„ï¼Œå¹¶è¡Œå…³ä¹æ‰§è¡Œ**ã€‚

æ€»çš„æ¥è¯´ï¼Œå¹¶å‘æ˜¯**åœ¨åº”ç”¨è®¾è®¡ä¸å®ç°é˜¶æ®µè¦è€ƒè™‘çš„é—®é¢˜**ã€‚å¹¶å‘è€ƒè™‘çš„æ˜¯å¦‚ä½•å°†åº”ç”¨åˆ’åˆ†ä¸ºå¤šä¸ªäº’ç›¸é…åˆçš„ã€å¯ç‹¬ç«‹æ‰§è¡Œçš„æ¨¡å—çš„é—®é¢˜ã€‚é‡‡ç”¨å¹¶å‘è®¾è®¡çš„ç¨‹åºå¹¶ä¸ä¸€å®šæ˜¯å¹¶è¡Œæ‰§è¡Œçš„ã€‚

åœ¨ä¸æ»¡è¶³å¹¶è¡Œå¿…è¦æ¡ä»¶çš„æƒ…å†µä¸‹ï¼ˆä¹Ÿå°±æ˜¯ä»…æœ‰ä¸€ä¸ªå•æ ¸CPUçš„æƒ…å†µä¸‹ï¼‰ï¼Œå³ä¾¿æ˜¯é‡‡ç”¨å¹¶å‘è®¾è®¡çš„ç¨‹åºï¼Œä¾æ—§ä¸å¯ä»¥å¹¶è¡Œæ‰§è¡Œã€‚è€Œåœ¨æ»¡è¶³å¹¶è¡Œå¿…è¦æ¡ä»¶çš„æƒ…å†µä¸‹ï¼Œé‡‡ç”¨å¹¶å‘è®¾è®¡çš„ç¨‹åºæ˜¯å¯ä»¥å¹¶è¡Œæ‰§è¡Œçš„ã€‚è€Œé‚£äº›æ²¡æœ‰é‡‡ç”¨å¹¶å‘è®¾è®¡çš„åº”ç”¨ç¨‹åºï¼Œé™¤éæ˜¯å¯åŠ¨å¤šä¸ªç¨‹åºå®ä¾‹ï¼Œå¦åˆ™æ˜¯æ— æ³•å¹¶è¡Œæ‰§è¡Œçš„ã€‚

åœ¨å¤šæ ¸å¤„ç†å™¨æˆä¸ºä¸»æµçš„æ—¶ä»£ï¼Œå³ä½¿é‡‡ç”¨å¹¶å‘è®¾è®¡çš„åº”ç”¨ç¨‹åºä»¥å•å®ä¾‹çš„æ–¹å¼è¿è¡Œï¼Œå…¶ä¸­çš„æ¯ä¸ªå†…éƒ¨æ¨¡å—ä¹Ÿéƒ½æ˜¯è¿è¡Œäºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­çš„ï¼Œå¤šæ ¸èµ„æºä¹Ÿå¯ä»¥å¾—åˆ°å……åˆ†åˆ©ç”¨ã€‚è€Œä¸”ï¼Œ**å¹¶å‘è®©å¹¶è¡Œå˜å¾—æ›´åŠ å®¹æ˜“**ï¼Œé‡‡ç”¨å¹¶å‘è®¾è®¡çš„åº”ç”¨å¯ä»¥å°†è´Ÿè½½è‡ªç„¶æ‰©å±•åˆ°å„ä¸ªCPUæ ¸ä¸Šï¼Œä»è€Œæå‡å¤„ç†å™¨çš„åˆ©ç”¨æ•ˆç‡ã€‚



åœ¨ä¼ ç»Ÿç¼–ç¨‹è¯­è¨€ï¼ˆå¦‚Cã€C++ç­‰ï¼‰ä¸­ï¼ŒåŸºäº**å¤šçº¿ç¨‹æ¨¡å‹**çš„åº”ç”¨è®¾è®¡å°±æ˜¯ä¸€ç§å…¸å‹çš„å¹¶å‘ç¨‹åºè®¾è®¡ã€‚ä½†ä¼ ç»Ÿç¼–ç¨‹è¯­è¨€å¹¶éé¢å‘å¹¶å‘è€Œç”Ÿï¼Œæ²¡æœ‰å¯¹å¹¶å‘è®¾è®¡æä¾›è¿‡å¤šçš„å¸®åŠ©ã€‚å¹¶ä¸”ï¼Œè¿™äº›è¯­è¨€å¤šä»¥æ“ä½œç³»ç»Ÿçº¿ç¨‹ä½œä¸ºæ‰¿è½½åˆ†è§£åçš„ä»£ç ç‰‡æ®µï¼ˆæ¨¡å—ï¼‰çš„æ‰§è¡Œå•å…ƒï¼Œç”±æ“ä½œç³»ç»Ÿæ‰§è¡Œè°ƒåº¦ã€‚ä¼ ç»Ÿæ”¯æŒå¹¶å‘çš„æ–¹å¼çš„ä¸è¶³ï¼š

- é¦–å…ˆå°±æ˜¯å¤æ‚ã€‚

  åˆ›å»ºå®¹æ˜“**é€€å‡ºéš¾**ã€‚å¦‚æœä½ åšè¿‡C/C++ç¼–ç¨‹ï¼Œé‚£ä½ è‚¯å®šçŸ¥é“ï¼Œå¦‚æœæˆ‘ä»¬è¦åˆ©ç”¨libpthreadåº“ä¸­æä¾›çš„APIåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè™½ç„¶è¦ä¼ å…¥çš„å‚æ•°ä¸ªæ•°ä¸å°‘ï¼Œä½†å¥½æ­¹è¿˜æ˜¯å¯ä»¥æ¥å—çš„ã€‚ä½†ä¸€æ—¦æ¶‰åŠçº¿ç¨‹çš„é€€å‡ºï¼Œå°±è¦è€ƒè™‘æ–°åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦è¦ä¸ä¸»çº¿ç¨‹åˆ†ç¦»ï¼ˆdetachï¼‰ï¼Œè¿˜æ˜¯éœ€è¦ä¸»çº¿ç¨‹ç­‰å¾…å­çº¿ç¨‹ç»ˆæ­¢ï¼ˆjoinï¼‰å¹¶è·å–å…¶ç»ˆæ­¢çŠ¶æ€ï¼Ÿåˆæˆ–è€…æ˜¯å¦éœ€è¦åœ¨æ–°çº¿ç¨‹ä¸­è®¾ç½®å–æ¶ˆç‚¹ï¼ˆcancel pointï¼‰æ¥ä¿è¯è¢«ä¸»çº¿ç¨‹å–æ¶ˆï¼ˆcancelï¼‰çš„æ—¶å€™èƒ½é¡ºåˆ©é€€å‡ºã€‚

  è€Œä¸”ï¼Œå¹¶å‘æ‰§è¡Œå•å…ƒé—´çš„é€šä¿¡å›°éš¾ä¸”æ˜“é”™ã€‚å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡è™½ç„¶æœ‰å¤šç§æœºåˆ¶å¯é€‰ï¼Œä½†ç”¨èµ·æ¥ä¹Ÿæ˜¯ç›¸å½“å¤æ‚ã€‚å¹¶ä¸”ä¸€æ—¦æ¶‰åŠå…±äº«å†…å­˜ï¼Œå°±ä¼šç”¨åˆ°å„ç§é”äº’æ–¥æœºåˆ¶ï¼Œæ­»é”ä¾¿æˆä¸ºå®¶å¸¸ä¾¿é¥­ã€‚å¦å¤–ï¼Œçº¿ç¨‹æ ˆå¤§å°ä¹Ÿéœ€è¦è®¾å®šï¼Œå¼€å‘äººå‘˜éœ€è¦é€‰æ‹©ä½¿ç”¨é»˜è®¤çš„ï¼Œè¿˜æ˜¯è‡ªå®šä¹‰è®¾ç½®

- ç¬¬äºŒå°±æ˜¯éš¾äºè§„æ¨¡åŒ–ï¼ˆscaleï¼‰ã€‚æ¯ä¸ªçº¿ç¨‹å ç”¨çš„èµ„æºä¸å°ä¹‹ï¼Œæ“ä½œç³»ç»Ÿè°ƒåº¦åˆ‡æ¢çº¿ç¨‹çš„ä»£ä»·ä¹Ÿä¸å°ã€‚

  å¯¹äºå¾ˆå¤šç½‘ç»œæœåŠ¡ç¨‹åºæ¥è¯´ï¼Œç”±äºä¸èƒ½å¤§é‡åˆ›å»ºçº¿ç¨‹ï¼Œåªèƒ½é€‰æ‹©åœ¨å°‘é‡çº¿ç¨‹é‡Œåšç½‘ç»œå¤šè·¯å¤ç”¨çš„æ–¹æ¡ˆï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨epoll/kqueue/IoCompletionPortè¿™å¥—æœºåˆ¶ï¼Œå³ä¾¿æœ‰åƒ[libevent](https://github.com/libevent/libevent)å’Œ[libev](http://software.schmorp.de/pkg/libev.html)è¿™æ ·çš„ç¬¬ä¸‰æ–¹åº“å¸®å¿™ï¼Œå†™èµ·è¿™æ ·çš„ç¨‹åºä¹Ÿæ˜¯å¾ˆä¸å®¹æ˜“çš„ï¼Œå­˜åœ¨å¤§é‡é’©å­å›è°ƒï¼Œç»™å¼€å‘äººå‘˜å¸¦æ¥ä¸å°çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚



### 31.2 Goçš„å¹¶å‘æ–¹æ¡ˆï¼šgoroutine

Goå¹¶æ²¡æœ‰ä½¿ç”¨æ“ä½œç³»ç»Ÿçº¿ç¨‹ä½œä¸ºæ‰¿è½½åˆ†è§£åçš„ä»£ç ç‰‡æ®µï¼ˆæ¨¡å—ï¼‰çš„åŸºæœ¬æ‰§è¡Œå•å…ƒï¼Œè€Œæ˜¯å®ç°äº†`goroutine`è¿™ä¸€**ç”±Goè¿è¡Œæ—¶ï¼ˆruntimeï¼‰è´Ÿè´£è°ƒåº¦çš„ã€è½»é‡çš„ç”¨æˆ·çº§çº¿ç¨‹**ï¼Œä¸ºå¹¶å‘ç¨‹åºè®¾è®¡æä¾›åŸç”Ÿæ”¯æŒã€‚

ç›¸æ¯”ä¼ ç»Ÿæ“ä½œç³»ç»Ÿçº¿ç¨‹æ¥è¯´ï¼Œgoroutineçš„ä¼˜åŠ¿ä¸»è¦æ˜¯ï¼š

- èµ„æºå ç”¨å°ï¼Œæ¯ä¸ªgoroutineçš„**åˆå§‹æ ˆ**å¤§å°ä»…ä¸º2kï¼›
- ç”±Goè¿è¡Œæ—¶è€Œä¸æ˜¯æ“ä½œç³»ç»Ÿè°ƒåº¦ï¼Œgoroutineä¸Šä¸‹æ–‡åˆ‡æ¢åœ¨ç”¨æˆ·å±‚å®Œæˆï¼Œå¼€é”€æ›´å°ï¼›
- åœ¨**è¯­è¨€å±‚**é¢è€Œä¸æ˜¯é€šè¿‡æ ‡å‡†åº“æä¾›ã€‚goroutineç”±`go`å…³é”®å­—åˆ›å»ºï¼Œ**ä¸€é€€å‡ºå°±ä¼šè¢«å›æ”¶æˆ–é”€æ¯**ï¼Œå¼€å‘ä½“éªŒæ›´ä½³ï¼›
- è¯­è¨€å†…ç½®`channel`ä½œä¸ºgoroutineé—´é€šä¿¡åŸè¯­ï¼Œä¸ºå¹¶å‘è®¾è®¡æä¾›äº†å¼ºå¤§æ”¯æ’‘ã€‚

é€šè¿‡å¹¶å‘è®¾è®¡çš„Goåº”ç”¨å¯ä»¥æ›´å¥½åœ°ã€æ›´è‡ªç„¶åœ°é€‚åº”**è§„æ¨¡åŒ–ï¼ˆscaleï¼‰**ã€‚

æ¯”å¦‚ï¼Œå½“åº”ç”¨è¢«åˆ†é…åˆ°æ›´å¤šè®¡ç®—èµ„æºï¼Œæˆ–è€…è®¡ç®—å¤„ç†ç¡¬ä»¶å¢é…åï¼ŒGoåº”ç”¨ä¸éœ€è¦å†è¿›è¡Œç»“æ„è°ƒæ•´ï¼Œå°±å¯ä»¥å……åˆ†åˆ©ç”¨æ–°å¢çš„è®¡ç®—èµ„æºã€‚è€Œä¸”ï¼Œç»è¿‡å¹¶å‘è®¾è®¡åçš„Goåº”ç”¨ä¹Ÿä¼šæ›´åŠ å¥‘åˆGopherä»¬çš„å¼€å‘åˆ†å·¥åä½œã€‚

#### goroutineçš„åŸºæœ¬ç”¨æ³•

**å¹¶å‘**æ˜¯ä¸€ç§èƒ½åŠ›ï¼Œå®ƒè®©ä½ çš„ç¨‹åºå¯ä»¥ç”±è‹¥å¹²ä¸ªä»£ç ç‰‡æ®µ**ç»„åˆ**è€Œæˆï¼Œå¹¶ä¸”æ¯ä¸ªç‰‡æ®µéƒ½æ˜¯ç‹¬ç«‹è¿è¡Œçš„ã€‚

æ— è®ºæ˜¯==Goè‡ªèº«è¿è¡Œæ—¶ä»£ç ==è¿˜æ˜¯==ç”¨æˆ·å±‚Goä»£ç ==ï¼Œéƒ½æ— ä¸€ä¾‹å¤–åœ°è¿è¡Œåœ¨goroutineä¸­ã€‚

Goè¯­è¨€é€šè¿‡`goå…³é”®å­—+å‡½æ•°/æ–¹æ³•`çš„æ–¹å¼åˆ›å»ºä¸€ä¸ªgoroutineã€‚åˆ›å»ºåï¼Œæ–°goroutineå°†æ‹¥æœ‰ç‹¬ç«‹çš„ä»£ç æ‰§è¡Œæµï¼Œå¹¶ä¸åˆ›å»ºå®ƒçš„goroutineä¸€èµ·è¢«Goè¿è¡Œæ—¶è°ƒåº¦ã€‚

```go
go fmt.Println("I am a goroutine")

var c = make(chan int)
go func(a, b int) {
    c <- a + b
}(3,4)
 
// $GOROOT/src/net/http/server.go
c := srv.newConn(rw)
go c.serve(connCtx)
```



å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦è€ƒè™‘å¯¹goroutineçš„é€€å‡ºè¿›è¡Œæ§åˆ¶ï¼š**goroutineçš„æ‰§è¡Œå‡½æ•°çš„è¿”å›ï¼Œå°±æ„å‘³ç€goroutineé€€å‡ºã€‚**

å¦‚æœmain goroutineé€€å‡ºäº†ï¼Œé‚£ä¹ˆä¹Ÿæ„å‘³ç€æ•´ä¸ªåº”ç”¨ç¨‹åºçš„é€€å‡ºã€‚æ­¤å¤–ï¼Œä½ è¿˜è¦æ³¨æ„çš„æ˜¯ï¼Œ**goroutineæ‰§è¡Œçš„å‡½æ•°æˆ–æ–¹æ³•å³ä¾¿æœ‰è¿”å›å€¼ï¼ŒGoä¹Ÿä¼šå¿½ç•¥è¿™äº›è¿”å›å€¼**ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ è¦è·å–goroutineæ‰§è¡Œåçš„è¿”å›å€¼ï¼Œä½ éœ€è¦å¦è¡Œè€ƒè™‘å…¶ä»–æ–¹æ³•ï¼Œæ¯”å¦‚é€šè¿‡goroutineé—´çš„é€šä¿¡æ¥å®ç°ã€‚

#### goroutineé—´çš„é€šä¿¡

ä¼ ç»Ÿçš„ç¼–ç¨‹è¯­è¨€ï¼ˆæ¯”å¦‚ï¼šC++ã€Javaã€Pythonç­‰ï¼‰å¹¶éé¢å‘å¹¶å‘è€Œç”Ÿçš„ï¼Œæ‰€ä»¥ä»–ä»¬é¢å¯¹å¹¶å‘çš„é€»è¾‘å¤šæ˜¯**åŸºäºæ“ä½œç³»ç»Ÿçš„çº¿ç¨‹**ã€‚å¹¶å‘çš„æ‰§è¡Œå•å…ƒï¼ˆçº¿ç¨‹ï¼‰ä¹‹é—´çš„é€šä¿¡ï¼Œåˆ©ç”¨çš„ä¹Ÿæ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„çº¿ç¨‹æˆ–è¿›ç¨‹é—´é€šä¿¡çš„åŸè¯­ï¼Œæ¯”å¦‚ï¼š**å…±äº«å†…å­˜ã€ä¿¡å·ï¼ˆsignalï¼‰ã€ç®¡é“ï¼ˆpipeï¼‰ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å¥—æ¥å­—ï¼ˆsocketï¼‰**ç­‰ã€‚

åœ¨è¿™äº›é€šä¿¡åŸè¯­ä¸­ï¼Œä½¿ç”¨æœ€å¤šã€æœ€å¹¿æ³›çš„ï¼ˆä¹Ÿæ˜¯æœ€é«˜æ•ˆçš„ï¼‰æ˜¯ç»“åˆäº†çº¿ç¨‹åŒæ­¥åŸè¯­ï¼ˆæ¯”å¦‚ï¼šé”ä»¥åŠæ›´ä¸ºä½çº§çš„åŸå­æ“ä½œï¼‰çš„å…±äº«å†…å­˜æ–¹å¼ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è¯´ä¼ ç»Ÿè¯­è¨€çš„å¹¶å‘æ¨¡å‹æ˜¯**åŸºäºå¯¹å†…å­˜çš„å…±äº«çš„**ã€‚

ä¸è¿‡ï¼Œè¿™ç§ä¼ ç»Ÿçš„åŸºäºå…±äº«å†…å­˜çš„å¹¶å‘æ¨¡å‹å¾ˆ**éš¾ç”¨**ï¼Œä¸”**æ˜“é”™**ï¼Œå°¤å…¶æ˜¯åœ¨å¤§å‹æˆ–å¤æ‚ç¨‹åºä¸­ï¼Œå¼€å‘äººå‘˜åœ¨è®¾è®¡å¹¶å‘ç¨‹åºæ—¶ï¼Œéœ€è¦æ ¹æ®çº¿ç¨‹æ¨¡å‹å¯¹ç¨‹åºè¿›è¡Œå»ºæ¨¡ï¼ŒåŒæ—¶è§„åˆ’çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æ–¹å¼ã€‚å¦‚æœé€‰æ‹©çš„æ˜¯é«˜æ•ˆçš„åŸºäºå…±äº«å†…å­˜çš„æœºåˆ¶ï¼Œé‚£ä¹ˆä»–ä»¬è¿˜è¦èŠ±è´¹å¤§é‡å¿ƒæ€è®¾è®¡**çº¿ç¨‹é—´çš„åŒæ­¥æœºåˆ¶**ï¼Œå¹¶ä¸”åœ¨è®¾è®¡åŒæ­¥æœºåˆ¶çš„æ—¶å€™ï¼Œè¿˜è¦è€ƒè™‘å¤šçº¿ç¨‹é—´å¤æ‚çš„å†…å­˜ç®¡ç†ï¼Œä»¥åŠå¦‚ä½•é˜²æ­¢æ­»é”ç­‰æƒ…å†µã€‚

è¿™ç§æƒ…å†µä¸‹ï¼Œå¼€å‘äººå‘˜æ‰¿å—ç€å·¨å¤§çš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œå¹¶ä¸”åŸºäºè¿™ç±»ä¼ ç»Ÿå¹¶å‘æ¨¡å‹çš„ç¨‹åºéš¾äºç¼–å†™ã€é˜…è¯»ã€ç†è§£å’Œç»´æŠ¤ã€‚ä¸€æ—¦ç¨‹åºå‘ç”Ÿé—®é¢˜ï¼ŒæŸ¥æ‰¾Bugçš„è¿‡ç¨‹æ›´æ˜¯æ¼«é•¿å’Œè‰°è¾›ã€‚

Goè¯­è¨€ä»è®¾è®¡ä¼Šå§‹ï¼Œå°±å°†è§£å†³ä¸Šé¢è¿™ä¸ªä¼ ç»Ÿå¹¶å‘æ¨¡å‹çš„é—®é¢˜ä½œä¸ºGoçš„ä¸€ä¸ªç›®æ ‡ï¼Œå¹¶åœ¨æ–°å¹¶å‘æ¨¡å‹è®¾è®¡ä¸­å€Ÿé‰´äº†è‘—åè®¡ç®—æœºç§‘å­¦å®¶[Tony Hoare](https://en.wikipedia.org/wiki/Tony_Hoare)æå‡ºçš„**==CSP==ï¼ˆCommunicating Sequential Processesï¼Œé€šä¿¡é¡ºåºè¿›ç¨‹ï¼‰**å¹¶å‘æ¨¡å‹ã€‚

CSPæ¨¡å‹æ—¨åœ¨ç®€åŒ–å¹¶å‘ç¨‹åºçš„ç¼–å†™ï¼Œè®©å¹¶å‘ç¨‹åºçš„ç¼–å†™ä¸ç¼–å†™é¡ºåºç¨‹åºä¸€æ ·ç®€å•ã€‚Tony Hoareè®¤ä¸ºè¾“å…¥è¾“å‡ºåº”è¯¥æ˜¯åŸºæœ¬çš„ç¼–ç¨‹åŸè¯­ï¼Œ**æ•°æ®å¤„ç†é€»è¾‘**ï¼ˆä¹Ÿå°±æ˜¯CSPä¸­çš„Pï¼‰<u>åªéœ€è°ƒç”¨è¾“å…¥åŸè¯­è·å–æ•°æ®ï¼Œé¡ºåºåœ°å¤„ç†æ•°æ®ï¼Œå¹¶å°†ç»“æœæ•°æ®é€šè¿‡è¾“å‡ºåŸè¯­è¾“å‡ºå°±å¯ä»¥äº†ã€‚</u>

å› æ­¤ï¼Œåœ¨Tony Hoareçœ¼ä¸­ï¼Œ**ä¸€ä¸ªç¬¦åˆCSPæ¨¡å‹çš„å¹¶å‘ç¨‹åºåº”è¯¥æ˜¯ä¸€ç»„é€šè¿‡è¾“å…¥è¾“å‡ºåŸè¯­è¿æ¥èµ·æ¥çš„Pçš„é›†åˆ**ã€‚ä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼ŒCSPç†è®ºä¸ä»…æ˜¯ä¸€ä¸ªå¹¶å‘å‚è€ƒæ¨¡å‹ï¼Œä¹Ÿæ˜¯ä¸€ç§**å¹¶å‘ç¨‹åºçš„ç¨‹åºç»„ç»‡æ–¹æ³•**ã€‚å®ƒçš„ç»„åˆæ€æƒ³ä¸Goçš„è®¾è®¡å“²å­¦ä¸è°‹è€Œåˆã€‚

Tony Hoareçš„CSPç†è®ºä¸­çš„Pï¼Œä¹Ÿå°±æ˜¯â€œProcessï¼ˆè¿›ç¨‹ï¼‰â€ï¼Œæ˜¯ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œå®ƒä»£è¡¨**ä»»ä½•é¡ºåºå¤„ç†é€»è¾‘çš„å°è£…**ï¼Œå®ƒè·å–è¾“å…¥æ•°æ®ï¼ˆæˆ–ä»å…¶ä»–Pçš„è¾“å‡ºè·å–ï¼‰ï¼Œå¹¶ç”Ÿäº§å‡ºå¯ä»¥è¢«å…¶ä»–Pæ¶ˆè´¹çš„è¾“å‡ºæ•°æ®ã€‚CSPé€šä¿¡æ¨¡å‹çš„ç¤ºæ„å›¾ï¼š

![](images/image-20240711235319311.png)

è¿™é‡Œçš„På¹¶ä¸ä¸€å®šä¸æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹æˆ–çº¿ç¨‹åˆ’ç­‰å·ã€‚åœ¨Goä¸­ï¼Œä¸â€œProcessâ€å¯¹åº”çš„æ˜¯`goroutine`ã€‚ä¸ºäº†å®ç°CSPå¹¶å‘æ¨¡å‹ä¸­çš„è¾“å…¥å’Œè¾“å‡ºåŸè¯­ï¼ŒGoè¿˜å¼•å…¥äº†**goroutineï¼ˆPï¼‰ä¹‹é—´çš„é€šä¿¡åŸè¯­**`channel`ã€‚goroutineå¯ä»¥ä»channelè·å–è¾“å…¥æ•°æ®ï¼Œå†å°†å¤„ç†åå¾—åˆ°çš„ç»“æœæ•°æ®é€šè¿‡channelè¾“å‡ºã€‚é€šè¿‡channelå°†goroutineï¼ˆPï¼‰ç»„åˆè¿æ¥åœ¨ä¸€èµ·ï¼Œè®©è®¾è®¡å’Œç¼–å†™å¤§å‹å¹¶å‘ç³»ç»Ÿå˜å¾—æ›´åŠ ç®€å•å’Œæ¸…æ™°ã€‚

ä¸Šé¢æåˆ°çš„è·å–goroutineçš„é€€å‡ºçŠ¶æ€ï¼Œå°±å¯ä»¥ä½¿ç”¨channelåŸè¯­å®ç°ï¼š

```go
func spawn(f func() error) <-chan error {
    c := make(chan error)

    go func() {
        c <- f()
    }()

    return c
}

func main() {
    c := spawn(func() error {
        time.Sleep(2 * time.Second)
        return errors.New("timeout")
    })
    fmt.Println(<-c)
}
```

åœ¨main goroutineä¸å­goroutineä¹‹é—´å»ºç«‹äº†ä¸€ä¸ªå…ƒç´ ç±»å‹ä¸ºerrorçš„channelï¼Œå­goroutineé€€å‡ºæ—¶ï¼Œä¼šå°†å®ƒæ‰§è¡Œçš„å‡½æ•°çš„é”™è¯¯è¿”å›å€¼å†™å…¥è¿™ä¸ªchannelï¼Œmain goroutineå¯ä»¥é€šè¿‡è¯»å–channelçš„å€¼æ¥è·å–å­goroutineçš„é€€å‡ºçŠ¶æ€ã€‚



ç„¶CSPæ¨¡å‹å·²ç»æˆä¸ºGoè¯­è¨€æ”¯æŒçš„ä¸»æµå¹¶å‘æ¨¡å‹ï¼Œä½†Goä¹Ÿæ”¯æŒä¼ ç»Ÿçš„ã€åŸºäºå…±äº«å†…å­˜çš„å¹¶å‘æ¨¡å‹ï¼Œå¹¶æä¾›äº†åŸºæœ¬çš„ä½çº§åˆ«åŒæ­¥åŸè¯­ï¼ˆä¸»è¦æ˜¯syncåŒ…ä¸­çš„äº’æ–¥é”ã€æ¡ä»¶å˜é‡ã€è¯»å†™é”ã€åŸå­æ“ä½œç­‰ï¼‰ã€‚

**Goå§‹ç»ˆæ¨èä»¥CSPå¹¶å‘æ¨¡å‹é£æ ¼æ„å»ºå¹¶å‘ç¨‹åº**ã€‚ä¸è¿‡ï¼Œå¯¹äºå±€éƒ¨æƒ…å†µï¼Œæ¯”å¦‚æ¶‰åŠæ€§èƒ½æ•æ„Ÿçš„åŒºåŸŸæˆ–éœ€è¦ä¿æŠ¤çš„ç»“æ„ä½“æ•°æ®æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ›´ä¸ºé«˜æ•ˆçš„ä½çº§åŒæ­¥åŸè¯­ï¼ˆå¦‚mutexï¼‰ï¼Œä¿è¯goroutineå¯¹æ•°æ®çš„åŒæ­¥è®¿é—®ã€‚



## 32 å¹¶å‘ï¼šèŠèŠGoroutineè°ƒåº¦å™¨çš„åŸç†

> Goè¿è¡Œæ—¶æ˜¯å¦‚ä½•å°†ä¸€ä¸ªä¸ªGoroutineè°ƒåº¦åˆ°CPUä¸Šæ‰§è¡Œçš„ï¼Ÿ

### 32.1 Goroutineè°ƒåº¦å™¨

å°†è¿™äº›GoroutineæŒ‰ç…§ä¸€å®šç®—æ³•æ”¾åˆ°==â€œCPUâ€==ä¸Šæ‰§è¡Œçš„ç¨‹åºï¼Œå°±è¢«ç§°ä¸º==Goroutineè°ƒåº¦å™¨ï¼ˆGoroutine Schedulerï¼‰==ã€‚

ä¸€ä¸ªGoç¨‹åºå¯¹äºæ“ä½œç³»ç»Ÿæ¥è¯´åªæ˜¯ä¸€ä¸ª**ç”¨æˆ·å±‚ç¨‹åº**ï¼Œæ“ä½œç³»ç»Ÿçœ¼ä¸­åªæœ‰çº¿ç¨‹ã€‚

ä¸€ä¸ªGoç¨‹åºä¸­ï¼šç”¨æˆ·å±‚ä»£ç  + Goè¿è¡Œæ—¶ã€‚

Goroutineä»¬è¦ç«äº‰çš„â€œCPUâ€èµ„æºå°±æ˜¯**æ“ä½œç³»ç»Ÿçº¿ç¨‹**ã€‚

Goroutineè°ƒåº¦å™¨çš„ä»»åŠ¡ä¹Ÿå°±æ˜ç¡®äº†ï¼š**å°†GoroutineæŒ‰ç…§ä¸€å®šç®—æ³•æ”¾åˆ°ä¸åŒçš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸­å»æ‰§è¡Œ**ã€‚



### 32.2 Goroutineè°ƒåº¦å™¨æ¨¡å‹ä¸æ¼”åŒ–è¿‡ç¨‹

Goroutineè°ƒåº¦å™¨çš„å®ç°ä¸æ˜¯ä¸€è¹´è€Œå°±çš„ï¼Œå®ƒçš„è°ƒåº¦æ¨¡å‹ä¸ç®—æ³•ä¹Ÿæ˜¯å‡ ç»æ¼”åŒ–ï¼Œ**ä»æœ€åˆçš„G-Mæ¨¡å‹ã€åˆ°G-P-Mæ¨¡å‹ï¼Œä»ä¸æ”¯æŒæŠ¢å ï¼Œåˆ°æ”¯æŒåä½œå¼æŠ¢å ï¼Œå†åˆ°æ”¯æŒåŸºäºä¿¡å·çš„å¼‚æ­¥æŠ¢å **ï¼ŒGoroutineè°ƒåº¦å™¨ç»å†äº†ä¸æ–­åœ°ä¼˜åŒ–ä¸æ‰“ç£¨ã€‚

#### G-Mæ¨¡å‹

2012å¹´3æœˆ28æ—¥ï¼ŒGo 1.0

åœ¨è¿™ä¸ªè°ƒåº¦å™¨ä¸­ï¼Œæ¯ä¸ªGoroutineå¯¹åº”äºè¿è¡Œæ—¶ä¸­çš„ä¸€ä¸ªæŠ½è±¡ç»“æ„ï¼š==G==(Goroutine)ï¼›è€Œè¢«è§†ä½œâ€œç‰©ç†CPUâ€çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹è¢«æŠ½è±¡ä¸ºï¼š==M==(machine)ã€‚

è°ƒåº¦å™¨çš„å·¥ä½œå°±æ˜¯å°†Gè°ƒåº¦åˆ°Mä¸Šå»è¿è¡Œã€‚

G-Mæ¨¡å‹çš„ä¸€ä¸ªé‡è¦ä¸è¶³ï¼š**é™åˆ¶äº†Goå¹¶å‘ç¨‹åºçš„ä¼¸ç¼©æ€§ï¼Œå°¤å…¶æ˜¯å¯¹é‚£äº›æœ‰é«˜ååæˆ–å¹¶è¡Œè®¡ç®—éœ€æ±‚çš„æœåŠ¡ç¨‹åº**ã€‚è¿™ä¸ªé—®é¢˜ä¸»è¦ä½“ç°åœ¨ï¼š

- å•ä¸€å…¨å±€äº’æ–¥é”`(Sched.Lock)` å’Œé›†ä¸­çŠ¶æ€å­˜å‚¨çš„å­˜åœ¨ï¼Œå¯¼è‡´æ‰€æœ‰Goroutineç›¸å…³æ“ä½œï¼Œæ¯”å¦‚åˆ›å»ºã€é‡æ–°è°ƒåº¦ç­‰ï¼Œéƒ½è¦ä¸Šé”ï¼›
- Goroutineä¼ é€’é—®é¢˜ï¼šMç»å¸¸åœ¨Mä¹‹é—´ä¼ é€’â€œå¯è¿è¡Œâ€çš„Goroutineï¼Œè¿™å¯¼è‡´è°ƒåº¦å»¶è¿Ÿå¢å¤§ï¼Œä¹Ÿå¢åŠ äº†é¢å¤–çš„æ€§èƒ½æŸè€—ï¼›
- æ¯ä¸ªMéƒ½åšå†…å­˜ç¼“å­˜ï¼Œå¯¼è‡´å†…å­˜å ç”¨è¿‡é«˜ï¼Œæ•°æ®å±€éƒ¨æ€§è¾ƒå·®ï¼›
- ç”±äºç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰è€Œå½¢æˆçš„é¢‘ç¹çš„å·¥ä½œçº¿ç¨‹é˜»å¡å’Œè§£é™¤é˜»å¡ï¼Œå¯¼è‡´é¢å¤–çš„æ€§èƒ½æŸè€—ã€‚



#### G-P-Mè°ƒåº¦æ¨¡å‹

Go 1.1

[work stealingç®—æ³•](http://supertech.csail.mit.edu/papers/steal.pdf)

å¾·ç±³ç‰¹é‡ŒÂ·ç»´å°¤ç§‘å¤«é€šè¿‡å‘G-Mæ¨¡å‹ä¸­å¢åŠ äº†ä¸€ä¸ªPï¼Œè®©Goè°ƒåº¦å™¨å…·æœ‰å¾ˆå¥½çš„ä¼¸ç¼©æ€§ã€‚

Pæ˜¯ä¸€ä¸ªâ€œé€»è¾‘Proccessorâ€ï¼Œæ¯ä¸ªGï¼ˆGoroutineï¼‰è¦æƒ³çœŸæ­£è¿è¡Œèµ·æ¥ï¼Œé¦–å…ˆéœ€è¦è¢«åˆ†é…ä¸€ä¸ªPï¼Œä¹Ÿå°±æ˜¯è¿›å…¥åˆ°Pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ï¼ˆlocal runqï¼‰ä¸­ã€‚å¯¹äºGæ¥è¯´ï¼ŒPå°±æ˜¯è¿è¡Œå®ƒçš„â€œCPUâ€ï¼Œå¯ä»¥è¯´ï¼š**åœ¨Gçš„çœ¼é‡Œåªæœ‰P**ã€‚ä½†ä»Goè°ƒåº¦å™¨çš„è§†è§’æ¥çœ‹ï¼ŒçœŸæ­£çš„â€œCPUâ€æ˜¯Mï¼Œåªæœ‰å°†På’ŒMç»‘å®šï¼Œæ‰èƒ½è®©Pçš„runqä¸­çš„GçœŸæ­£è¿è¡Œèµ·æ¥ã€‚



![](images/b5d81e17e041461ea7e78ae159f6ea3c.jpg)



æ­¤æ—¶ï¼Œè°ƒåº¦å™¨ä»ç„¶æœ‰ä¸€ä¸ªä»¤äººå¤´ç–¼çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯**ä¸æ”¯æŒæŠ¢å å¼è°ƒåº¦**ï¼Œè¿™å¯¼è‡´ä¸€æ—¦æŸä¸ªGä¸­å‡ºç°æ­»å¾ªç¯çš„ä»£ç é€»è¾‘ï¼Œé‚£ä¹ˆGå°†æ°¸ä¹…å ç”¨åˆ†é…ç»™å®ƒçš„På’ŒMï¼Œè€Œä½äºåŒä¸€ä¸ªPä¸­çš„å…¶ä»–Gå°†å¾—ä¸åˆ°è°ƒåº¦ï¼Œå‡ºç°â€œ**é¥¿æ­»**â€çš„æƒ…å†µã€‚

#### â€œæŠ¢å å¼â€è°ƒåº¦

å¾·ç±³ç‰¹é‡ŒÂ·ç»´å°¤ç§‘å¤«åœ¨Go 1.2ä¸­å®ç°äº†åŸºäºåä½œçš„â€œæŠ¢å å¼â€è°ƒåº¦ã€‚

è¿™ä¸ªæŠ¢å å¼è°ƒåº¦çš„åŸç†å°±æ˜¯ï¼ŒGoç¼–è¯‘å™¨åœ¨æ¯ä¸ªå‡½æ•°æˆ–æ–¹æ³•çš„å…¥å£å¤„åŠ ä¸Šäº†ä¸€æ®µé¢å¤–çš„ä»£ç (`runtime.morestack_noctxt`)ï¼Œè®©è¿è¡Œæ—¶æœ‰æœºä¼šåœ¨è¿™æ®µä»£ç ä¸­æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰§è¡ŒæŠ¢å è°ƒåº¦ã€‚

è¿™ç§è§£å†³æ–¹æ¡ˆåªèƒ½è¯´å±€éƒ¨è§£å†³äº†â€œé¥¿æ­»â€é—®é¢˜ï¼Œåªåœ¨æœ‰å‡½æ•°è°ƒç”¨çš„åœ°æ–¹æ‰èƒ½æ’å…¥â€œæŠ¢å â€ä»£ç ï¼ˆåŸ‹ç‚¹ï¼‰ï¼Œå¯¹äºæ²¡æœ‰å‡½æ•°è°ƒç”¨è€Œæ˜¯çº¯ç®—æ³•å¾ªç¯è®¡ç®—çš„Gï¼ŒGoè°ƒåº¦å™¨ä¾ç„¶æ— æ³•æŠ¢å ã€‚

æ¯”å¦‚ï¼Œæ­»å¾ªç¯ç­‰å¹¶æ²¡æœ‰ç»™ç¼–è¯‘å™¨æ’å…¥æŠ¢å ä»£ç çš„æœºä¼šï¼Œè¿™å°±ä¼šå¯¼è‡´GCåœ¨ç­‰å¾…æ‰€æœ‰Goroutineåœæ­¢æ—¶çš„ç­‰å¾…æ—¶é—´è¿‡é•¿ï¼Œä»è€Œ[å¯¼è‡´GCå»¶è¿Ÿ](https://github.com/golang/go/issues/10958)ï¼Œå†…å­˜å ç”¨ç¬é—´å†²é«˜ï¼›ç”šè‡³åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå¯¼è‡´åœ¨STWï¼ˆstop the worldï¼‰æ—¶æ­»é”ã€‚

ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼ŒGoåœ¨1.14ç‰ˆæœ¬ä¸­æ¥å—äº†å¥¥æ–¯æ±€Â·å…‹è±é—¨èŒ¨ï¼ˆAustin Clementsï¼‰çš„[ææ¡ˆ](https://go.googlesource.com/proposal/+/master/design/24543-non-cooperative-preemption.md)ï¼Œå¢åŠ äº†**å¯¹éåä½œçš„æŠ¢å å¼è°ƒåº¦çš„æ”¯æŒ**ï¼Œè¿™ç§æŠ¢å å¼è°ƒåº¦æ˜¯åŸºäºç³»ç»Ÿä¿¡å·çš„ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡å‘çº¿ç¨‹å‘é€ä¿¡å·çš„æ–¹å¼æ¥æŠ¢å æ­£åœ¨è¿è¡Œçš„Goroutineã€‚

é™¤äº†è¿™äº›å¤§çš„è¿­ä»£å¤–ï¼ŒGoroutineçš„è°ƒåº¦å™¨è¿˜æœ‰ä¸€äº›å°çš„ä¼˜åŒ–æ”¹åŠ¨ï¼Œæ¯”å¦‚**é€šè¿‡æ–‡ä»¶I/O pollerå‡å°‘Mçš„é˜»å¡ç­‰**ã€‚

Goè¿è¡Œæ—¶å·²ç»å®ç°äº†netpollerï¼Œè¿™ä½¿å¾—å³ä¾¿Gå‘èµ·ç½‘ç»œI/Oæ“ä½œï¼Œä¹Ÿä¸ä¼šå¯¼è‡´Mè¢«é˜»å¡ï¼ˆä»…é˜»å¡Gï¼‰ï¼Œä¹Ÿå°±ä¸ä¼šå¯¼è‡´å¤§é‡çº¿ç¨‹ï¼ˆMï¼‰è¢«åˆ›å»ºå‡ºæ¥ã€‚

ä½†æ˜¯å¯¹äºæ–‡ä»¶I/Oæ“ä½œæ¥è¯´ï¼Œä¸€æ—¦é˜»å¡ï¼Œé‚£ä¹ˆçº¿ç¨‹ï¼ˆMï¼‰å°†è¿›å…¥æŒ‚èµ·çŠ¶æ€ï¼Œç­‰å¾…I/Oè¿”å›åè¢«å”¤é†’ã€‚è¿™ç§æƒ…å†µä¸‹På°†ä¸æŒ‚èµ·çš„Måˆ†ç¦»ï¼Œå†é€‰æ‹©ä¸€ä¸ªå¤„äºç©ºé—²çŠ¶æ€ï¼ˆidleï¼‰çš„Mã€‚å¦‚æœæ­¤æ—¶æ²¡æœ‰ç©ºé—²çš„Mï¼Œå°±ä¼šæ–°åˆ›å»ºä¸€ä¸ªMï¼ˆçº¿ç¨‹ï¼‰ï¼Œæ‰€ä»¥ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¤§é‡I/Oæ“ä½œä»ç„¶ä¼šå¯¼è‡´å¤§é‡çº¿ç¨‹è¢«åˆ›å»ºã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒGoå¼€å‘å›¢é˜Ÿçš„ä¼Šæ©Â·å…°æ–¯Â·æ³°å‹’ï¼ˆIan Lance Taylorï¼‰åœ¨Go 1.9ä¸­å¢åŠ äº†ä¸€ä¸ª[é’ˆå¯¹æ–‡ä»¶I/Oçš„Poller](https://groups.google.com/forum/#!topic/golang-dev/tT8SoKfHty0)çš„åŠŸèƒ½ï¼Œè¿™ä¸ªåŠŸèƒ½å¯ä»¥åƒnetpolleré‚£æ ·ï¼Œåœ¨Gæ“ä½œé‚£äº›æ”¯æŒç›‘å¬ï¼ˆpollableï¼‰çš„æ–‡ä»¶æè¿°ç¬¦æ—¶ï¼Œä»…ä¼šé˜»å¡Gï¼Œè€Œä¸ä¼šé˜»å¡Mã€‚ä¸è¿‡è¿™ä¸ªåŠŸèƒ½ä¾ç„¶ä¸èƒ½å¯¹å¸¸è§„æ–‡ä»¶æœ‰æ•ˆï¼Œå¸¸è§„æ–‡ä»¶æ˜¯ä¸æ”¯æŒç›‘å¬çš„ï¼ˆpollableï¼‰ã€‚ä½†å¯¹äºGoè°ƒåº¦å™¨è€Œè¨€ï¼Œè¿™ä¹Ÿç®—æ˜¯ä¸€ä¸ªä¸å°çš„è¿›æ­¥äº†ã€‚

ä»Go 1.2ä»¥åï¼ŒGoè°ƒåº¦å™¨å°±ä¸€ç›´ç¨³å®šåœ¨G-P-Mè°ƒåº¦æ¨¡å‹ä¸Šï¼Œå°½ç®¡æœ‰å„ç§ä¼˜åŒ–å’Œæ”¹è¿›ï¼Œä½†ä¹Ÿéƒ½æ˜¯åŸºäºè¿™ä¸ªæ¨¡å‹ä¹‹ä¸Šçš„ã€‚é‚£æœªæ¥çš„Goè°ƒåº¦å™¨ä¼šå¾€å“ªæ–¹é¢å‘å±•å‘¢ï¼Ÿå¾·ç±³ç‰¹é‡ŒÂ·ç»´å°¤ç§‘å¤«åœ¨2014å¹´9æœˆæå‡ºäº†ä¸€ä¸ªæ–°çš„è®¾è®¡è‰æ¡ˆæ–‡æ¡£ï¼šã€Š[NUMAâ€aware scheduler for Go](https://docs.google.com/document/u/0/d/1d3iI2QWURgDIsSR6G2275vMeQ_X7w-qxM2Vp7iGwwuM/pub)ã€‹ï¼Œä½œä¸ºå¯¹æœªæ¥Goroutineè°ƒåº¦å™¨æ¼”è¿›æ–¹å‘çš„ä¸€ä¸ªæè®®ï¼Œä¸è¿‡è‡³ä»Šä¼¼ä¹è¿™ä¸ªæè®®ä¹Ÿæ²¡æœ‰åˆ—å…¥å¼€å‘è®¡åˆ’ã€‚

### 32.3 æ·±å…¥G-P-Mæ¨¡å‹ 

Goè¯­è¨€ä¸­Goroutineçš„è°ƒåº¦ã€GCã€å†…å­˜ç®¡ç†ç­‰æ˜¯Goè¯­è¨€åŸç†æœ€å¤æ‚ã€æœ€éš¾æ‡‚çš„åœ°æ–¹ï¼Œå¹¶ä¸”è¿™ä¸‰æ–¹é¢çš„å†…å®¹éšç€Goç‰ˆæœ¬çš„æ¼”è¿›ä¹Ÿåœ¨ä¸æ–­æ›´æ–°ã€‚

#### Gã€På’ŒM

`$GOROOT/src/runtime/runtime2.go`

- G: ä»£è¡¨Goroutineï¼Œå­˜å‚¨äº†Goroutineçš„æ‰§è¡Œæ ˆä¿¡æ¯ã€GoroutineçŠ¶æ€ä»¥åŠGoroutineçš„ä»»åŠ¡å‡½æ•°ç­‰ï¼Œè€Œä¸”Gå¯¹è±¡æ˜¯å¯ä»¥é‡ç”¨çš„ï¼›
- P: ä»£è¡¨é€»è¾‘processorï¼ŒPçš„æ•°é‡å†³å®šäº†ç³»ç»Ÿå†…æœ€å¤§å¯å¹¶è¡Œçš„Gçš„æ•°é‡ï¼ŒPçš„æœ€å¤§ä½œç”¨è¿˜æ˜¯å…¶æ‹¥æœ‰çš„å„ç§Gå¯¹è±¡é˜Ÿåˆ—ã€é“¾è¡¨ã€ä¸€äº›ç¼“å­˜å’ŒçŠ¶æ€ï¼›
- M: Mä»£è¡¨ç€çœŸæ­£çš„æ‰§è¡Œè®¡ç®—èµ„æºã€‚åœ¨ç»‘å®šæœ‰æ•ˆçš„Påï¼Œè¿›å…¥ä¸€ä¸ªè°ƒåº¦å¾ªç¯ï¼Œè€Œè°ƒåº¦å¾ªç¯çš„æœºåˆ¶å¤§è‡´æ˜¯**ä»Pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä»¥åŠå…¨å±€é˜Ÿåˆ—ä¸­è·å–Gï¼Œåˆ‡æ¢åˆ°Gçš„æ‰§è¡Œæ ˆä¸Šå¹¶æ‰§è¡ŒGçš„å‡½æ•°ï¼Œè°ƒç”¨goexitåšæ¸…ç†å·¥ä½œå¹¶å›åˆ°Mï¼Œå¦‚æ­¤åå¤**ã€‚Må¹¶ä¸ä¿ç•™GçŠ¶æ€ï¼Œè¿™æ˜¯Gå¯ä»¥è·¨Mè°ƒåº¦çš„åŸºç¡€ã€‚

```go
//src/runtime/runtime2.go
type g struct {
    stack      stack   // offset known to runtime/cgo
    sched      gobuf
    goid       int64
    gopc       uintptr // pc of go statement that created this goroutine
    startpc    uintptr // pc of goroutine function
    ... ...
}

type p struct {
    lock mutex

    id          int32
    status      uint32 // one of pidle/prunning/...
  
    mcache      *mcache
    racectx     uintptr

    // Queue of runnable goroutines. Accessed without lock.
    runqhead uint32
    runqtail uint32
    runq     [256]guintptr

    runnext guintptr

    // Available G's (status == Gdead)
    gfree    *g
    gfreecnt int32

    ... ...
}



type m struct {
    g0            *g     // goroutine with scheduling stack
    mstartfn      func()
    curg          *g     // current running goroutine
    ... ...
}
```



#### Gè¢«æŠ¢å è°ƒåº¦

å¦‚æœæŸä¸ªGæ²¡æœ‰è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰ã€æ²¡æœ‰è¿›è¡ŒI/Oæ“ä½œã€æ²¡æœ‰é˜»å¡åœ¨ä¸€ä¸ªchannelæ“ä½œä¸Šï¼Œ**è°ƒåº¦å™¨æ˜¯å¦‚ä½•è®©Gåœä¸‹æ¥å¹¶è°ƒåº¦ä¸‹ä¸€ä¸ªå¯è¿è¡Œçš„Gçš„å‘¢**ï¼Ÿ

ç­”æ¡ˆå°±æ˜¯ï¼š**Gæ˜¯è¢«æŠ¢å è°ƒåº¦çš„**ã€‚

ğŸ”–



é™¤äº†è¿™ä¸ªå¸¸è§„è°ƒåº¦ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªç‰¹æ®Šæƒ…å†µä¸‹Gçš„è°ƒåº¦æ–¹æ³•:

- ç¬¬ä¸€ç§ï¼šchannelé˜»å¡æˆ–ç½‘ç»œI/Oæƒ…å†µä¸‹çš„è°ƒåº¦ã€‚
- ç¬¬äºŒç§ï¼šç³»ç»Ÿè°ƒç”¨é˜»å¡æƒ…å†µä¸‹çš„è°ƒåº¦ã€‚





## 33 å¹¶å‘ï¼šå°channelä¸­è•´å«å¤§æ™ºæ…§

Goè¯­è¨€çš„CSPæ¨¡å‹çš„å®ç°åŒ…å«ä¸¤ä¸ªä¸»è¦ç»„æˆéƒ¨åˆ†ï¼š

- ä¸€ä¸ªæ˜¯Goroutineï¼Œå®ƒæ˜¯Goåº”ç”¨å¹¶å‘è®¾è®¡çš„åŸºæœ¬æ„å»ºä¸æ‰§è¡Œå•å…ƒï¼›
- å¦ä¸€ä¸ªå°±æ˜¯channelï¼Œå®ƒåœ¨å¹¶å‘æ¨¡å‹ä¸­æ‰®æ¼”ç€é‡è¦çš„è§’è‰²ã€‚

channelæ—¢å¯ä»¥ç”¨æ¥å®ç°Goroutineé—´çš„==é€šä¿¡==ï¼Œè¿˜å¯ä»¥å®ç°Goroutineé—´çš„==åŒæ­¥==ã€‚

### 33.1 ä½œä¸ºä¸€ç­‰å…¬æ°‘çš„channel

å¯ä»¥åƒä½¿ç”¨æ™®é€šå˜é‡é‚£æ ·ä½¿ç”¨channelã€‚

#### åˆ›å»ºchannel

å’Œåˆ‡ç‰‡ã€ç»“æ„ä½“ã€mapç­‰ä¸€æ ·ï¼Œchannelä¹Ÿæ˜¯ä¸€ç§å¤åˆæ•°æ®ç±»å‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åœ¨å£°æ˜ä¸€ä¸ªchannelç±»å‹å˜é‡æ—¶ï¼Œå¿…é¡»ç»™å‡ºå…¶å…·ä½“çš„å…ƒç´ ç±»å‹ã€‚

```go
var ch chan int  // å£°æ˜äº†ä¸€ä¸ªå…ƒç´ ä¸ºintç±»å‹çš„channelç±»å‹å˜é‡ch
```

ä¸ºchannelç±»å‹å˜é‡èµ‹åˆå€¼çš„å”¯ä¸€æ–¹æ³•å°±æ˜¯`make`:

```go
ch1 := make(chan int)     // æ— ç¼“å†²channel
ch2 := make(chan int, 5)   // å¸¦ç¼“å†²channel
```



#### å‘é€ä¸æ¥æ”¶

`<-`æ“ä½œç¬¦ç”¨äºå¯¹channelç±»å‹å˜é‡è¿›è¡Œå‘é€ä¸æ¥æ”¶æ“ä½œï¼š

```go
ch1 <- 13    // å°†æ•´å‹å­—é¢å€¼13å‘é€åˆ°æ— ç¼“å†²channelç±»å‹å˜é‡ch1ä¸­
n := <- ch1  // ä»æ— ç¼“å†²channelç±»å‹å˜é‡ch1ä¸­æ¥æ”¶ä¸€ä¸ªæ•´å‹å€¼å­˜å‚¨åˆ°æ•´å‹å˜é‡nä¸­
ch2 <- 17    // å°†æ•´å‹å­—é¢å€¼17å‘é€åˆ°å¸¦ç¼“å†²channelç±»å‹å˜é‡ch2ä¸­
m := <- ch2  // ä»å¸¦ç¼“å†²channelç±»å‹å˜é‡ch2ä¸­æ¥æ”¶ä¸€ä¸ªæ•´å‹å€¼å­˜å‚¨åˆ°æ•´å‹å˜é‡mä¸­
```

1ï¸âƒ£ç”±äºæ— ç¼“å†²channelçš„è¿è¡Œæ—¶å±‚å®ç°ä¸å¸¦æœ‰ç¼“å†²åŒºï¼Œæ‰€ä»¥Goroutineå¯¹æ— ç¼“å†²channelçš„æ¥æ”¶å’Œå‘é€æ“ä½œæ˜¯åŒæ­¥çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹åŒä¸€ä¸ªæ— ç¼“å†²channelï¼Œåªæœ‰å¯¹å®ƒè¿›è¡Œæ¥æ”¶æ“ä½œçš„Goroutineå’Œå¯¹å®ƒè¿›è¡Œå‘é€æ“ä½œçš„Goroutineéƒ½å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œé€šä¿¡æ‰èƒ½å¾—ä»¥è¿›è¡Œï¼Œå¦åˆ™å•æ–¹é¢çš„æ“ä½œä¼šè®©å¯¹åº”çš„Goroutineé™·å…¥æŒ‚èµ·çŠ¶æ€ï¼Œå¦‚ï¼š

```go
func main() {
    ch1 := make(chan int)
    ch1 <- 13 // fatal error: all goroutines are asleep - deadlock!
    n := <-ch1
    println(n)
}
```

åˆ›å»ºäº†ä¸€ä¸ªæ— ç¼“å†²çš„channelç±»å‹å˜é‡ch1ï¼Œå¯¹ch1çš„è¯»å†™éƒ½æ”¾åœ¨äº†ä¸€ä¸ªGoroutineä¸­ã€‚

åªéœ€è¦å°†æ¥æ”¶æ“ä½œï¼Œæˆ–è€…å‘é€æ“ä½œæ”¾åˆ°å¦å¤–ä¸€ä¸ªGoroutineä¸­å°±å¯ä»¥äº†ï¼š

```go
func main() {
    ch1 := make(chan int)
    go func() {
        ch1 <- 13 // å°†å‘é€æ“ä½œæ”¾å…¥ä¸€ä¸ªæ–°goroutineä¸­æ‰§è¡Œ
    }()
    n := <-ch1
    println(n)
}
```

ç»“è®ºï¼š**å¯¹æ— ç¼“å†²channelç±»å‹çš„å‘é€ä¸æ¥æ”¶æ“ä½œï¼Œä¸€å®šè¦æ”¾åœ¨ä¸¤ä¸ªä¸åŒçš„Goroutineä¸­è¿›è¡Œï¼Œå¦åˆ™ä¼šå¯¼è‡´deadlock**ã€‚

2ï¸âƒ£å’Œæ— ç¼“å†²channelç›¸åï¼Œå¸¦ç¼“å†²channelçš„è¿è¡Œæ—¶å±‚å®ç°å¸¦æœ‰ç¼“å†²åŒºï¼Œå› æ­¤ï¼Œå¯¹å¸¦ç¼“å†²channelçš„å‘é€æ“ä½œåœ¨ç¼“å†²åŒºæœªæ»¡ã€æ¥æ”¶æ“ä½œåœ¨ç¼“å†²åŒºéç©ºçš„æƒ…å†µä¸‹æ˜¯**å¼‚æ­¥**çš„ï¼ˆå‘é€æˆ–æ¥æ”¶ä¸éœ€è¦é˜»å¡ç­‰å¾…ï¼‰ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹ä¸€ä¸ªå¸¦ç¼“å†²channelæ¥è¯´ï¼Œåœ¨ç¼“å†²åŒºæœªæ»¡çš„æƒ…å†µä¸‹ï¼Œå¯¹å®ƒè¿›è¡Œå‘é€æ“ä½œçš„Goroutineå¹¶ä¸ä¼šé˜»å¡æŒ‚èµ·ï¼›åœ¨ç¼“å†²åŒºæœ‰æ•°æ®çš„æƒ…å†µä¸‹ï¼Œå¯¹å®ƒè¿›è¡Œæ¥æ”¶æ“ä½œçš„Goroutineä¹Ÿä¸ä¼šé˜»å¡æŒ‚èµ·ã€‚

ä½†å½“ç¼“å†²åŒºæ»¡äº†çš„æƒ…å†µä¸‹ï¼Œå¯¹å®ƒè¿›è¡Œå‘é€æ“ä½œçš„Goroutineå°±ä¼šé˜»å¡æŒ‚èµ·ï¼›å½“ç¼“å†²åŒºä¸ºç©ºçš„æƒ…å†µä¸‹ï¼Œå¯¹å®ƒè¿›è¡Œæ¥æ”¶æ“ä½œçš„Goroutineä¹Ÿä¼šé˜»å¡æŒ‚èµ·ã€‚

å‡ ä¸ªå…³äºå¸¦ç¼“å†²channelçš„æ“ä½œçš„ä¾‹å­:

```go
ch2 := make(chan int, 1)
n := <-ch2 // ç”±äºæ­¤æ—¶ch2çš„ç¼“å†²åŒºä¸­æ— æ•°æ®ï¼Œå› æ­¤å¯¹å…¶è¿›è¡Œæ¥æ”¶æ“ä½œå°†å¯¼è‡´goroutineæŒ‚èµ·

ch3 := make(chan int, 1)
ch3 <- 17  // å‘ch3å‘é€ä¸€ä¸ªæ•´å‹æ•°17
ch3 <- 27  // ç”±äºæ­¤æ—¶ch3ä¸­ç¼“å†²åŒºå·²æ»¡ï¼Œå†å‘ch3å‘é€æ•°æ®ä¹Ÿå°†å¯¼è‡´goroutineæŒ‚èµ·
```

æ“ä½œç¬¦`<-`è¿˜å¯ä»¥å£°æ˜**åªå‘é€channelç±»å‹**ï¼ˆsend-onlyï¼‰å’Œ**åªæ¥æ”¶channelç±»å‹**ï¼ˆrecv-onlyï¼‰: ğŸ”–

```go
ch1 := make(chan<- int, 1) // åªå‘é€channelç±»å‹
ch2 := make(<-chan int, 1) // åªæ¥æ”¶channelç±»å‹

<-ch1       // invalid operation: <-ch1 (receive from send-only type chan<- int)
ch2 <- 13   // invalid operation: ch2 <- 13 (send to receive-only type <-chan int)
```

**è¯•å›¾ä»ä¸€ä¸ªåªå‘é€channelç±»å‹å˜é‡ä¸­æ¥æ”¶æ•°æ®ï¼Œæˆ–è€…å‘ä¸€ä¸ªåªæ¥æ”¶channelç±»å‹å‘é€æ•°æ®ï¼Œéƒ½ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯**ã€‚

é€šå¸¸åªå‘é€channelç±»å‹å’Œåªæ¥æ”¶channelç±»å‹ï¼Œä¼šè¢«ç”¨ä½œå‡½æ•°çš„å‚æ•°ç±»å‹æˆ–è¿”å›å€¼ï¼Œç”¨äºé™åˆ¶å¯¹channelå†…çš„æ“ä½œï¼Œæˆ–è€…æ˜¯æ˜ç¡®å¯å¯¹channelè¿›è¡Œçš„æ“ä½œçš„ç±»å‹ï¼Œä¾‹å­ï¼š

```go
func produce(ch chan<- int) {
    for i := 0; i < 10; i++ {
        ch <- i + 1
        time.Sleep(time.Second)
    }
    close(ch)
}

func consume(ch <-chan int) {
    for n := range ch {
        println(n)
    }
}

func main() {
    ch := make(chan int, 5)
    var wg sync.WaitGroup
    wg.Add(2)
    go func() {
        produce(ch)
        wg.Done()
    }()

    go func() {
        consume(ch)
        wg.Done()
    }()

    wg.Wait()
}
```

å¯åŠ¨äº†ä¸¤ä¸ªGoroutineï¼Œåˆ†åˆ«ä»£è¡¨ç”Ÿäº§è€…ï¼ˆproduceï¼‰ä¸æ¶ˆè´¹è€…ï¼ˆconsumeï¼‰ã€‚ç”Ÿäº§è€…åªèƒ½å‘channelä¸­å‘é€æ•°æ®ï¼Œæˆ‘ä»¬ä½¿ç”¨`chan<- int`ä½œä¸ºproduceå‡½æ•°çš„å‚æ•°ç±»å‹ï¼›æ¶ˆè´¹è€…åªèƒ½ä»channelä¸­æ¥æ”¶æ•°æ®ï¼Œæˆ‘ä»¬ä½¿ç”¨`<-chan int`ä½œä¸ºconsumeå‡½æ•°çš„å‚æ•°ç±»å‹ã€‚

åœ¨æ¶ˆè´¹è€…å‡½æ•°consumeä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†for rangeå¾ªç¯è¯­å¥æ¥ä»channelä¸­æ¥æ”¶æ•°æ®ï¼Œfor rangeä¼šé˜»å¡åœ¨å¯¹channelçš„æ¥æ”¶æ“ä½œä¸Šï¼Œç›´åˆ°channelä¸­æœ‰æ•°æ®å¯æ¥æ”¶æˆ–channelè¢«å…³é—­å¾ªç¯ï¼Œæ‰ä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚channelè¢«å…³é—­åï¼Œfor rangeå¾ªç¯ä¹Ÿå°±ç»“æŸäº†ã€‚

#### å…³é—­channel



```go
ch := make(chan int, 5)
close(ch)
ch <- 13 // panic: send on closed channel
```



#### select

åŒæ—¶å¯¹å¤šä¸ªchannelè¿›è¡Œæ“ä½œæ—¶

é€šè¿‡selectï¼Œå¯ä»¥åŒæ—¶åœ¨å¤šä¸ªchannelä¸Šè¿›è¡Œå‘é€/æ¥æ”¶æ“ä½œï¼š

```go
select {
case x := <-ch1:     // ä»channel ch1æ¥æ”¶æ•°æ®
	... ...

case y, ok := <-ch2: // ä»channel ch2æ¥æ”¶æ•°æ®ï¼Œå¹¶æ ¹æ®okå€¼åˆ¤æ–­ch2æ˜¯å¦å·²ç»å…³é—­
	... ...

case ch3 <- z:       // å°†zå€¼å‘é€åˆ°channel ch3ä¸­:
	... ...

default:             // å½“ä¸Šé¢caseä¸­çš„channelé€šä¿¡å‡æ— æ³•å®æ–½æ—¶ï¼Œæ‰§è¡Œè¯¥é»˜è®¤åˆ†æ”¯
}
```

å½“selectè¯­å¥ä¸­æ²¡æœ‰defaultåˆ†æ”¯ï¼Œè€Œä¸”æ‰€æœ‰caseä¸­çš„channelæ“ä½œéƒ½é˜»å¡äº†çš„æ—¶å€™ï¼Œæ•´ä¸ªselectè¯­å¥éƒ½å°†è¢«é˜»å¡ï¼Œç›´åˆ°æŸä¸€ä¸ªcaseä¸Šçš„channelå˜æˆå¯å‘é€ï¼Œæˆ–è€…æŸä¸ªcaseä¸Šçš„channelå˜æˆå¯æ¥æ”¶ï¼Œselectè¯­å¥æ‰å¯ä»¥ç»§ç»­è¿›è¡Œä¸‹å»ã€‚



### 33.2 æ— ç¼“å†²channelçš„æƒ¯ç”¨æ³• ğŸ”–

æ— ç¼“å†²channelå…¼å…·é€šä¿¡å’ŒåŒæ­¥ç‰¹æ€§ï¼Œåœ¨å¹¶å‘ç¨‹åºä¸­åº”ç”¨é¢‡ä¸ºå¹¿æ³›ã€‚

#### ç¬¬ä¸€ç§ç”¨æ³•ï¼šç”¨ä½œä¿¡å·ä¼ é€’

- 1å¯¹1é€šçŸ¥ä¿¡å·



- 1å¯¹né€šçŸ¥ä¿¡å·

#### ç¬¬äºŒç§ç”¨æ³•ï¼šç”¨äºæ›¿ä»£é”æœºåˆ¶

- ä¸€ä¸ªä¼ ç»Ÿçš„ã€åŸºäºâ€œå…±äº«å†…å­˜â€+â€œäº’æ–¥é”â€çš„Goroutineå®‰å…¨çš„è®¡æ•°å™¨



- æ— ç¼“å†²channelæ›¿ä»£é”

### 33.3 å¸¦ç¼“å†²channelçš„æƒ¯ç”¨æ³• ğŸ”–

#### ç¬¬ä¸€ç§ç”¨æ³•ï¼šç”¨ä½œæ¶ˆæ¯é˜Ÿåˆ—



#### ç¬¬äºŒç§ç”¨æ³•ï¼šç”¨ä½œè®¡æ•°ä¿¡å·é‡ï¼ˆcounting semaphoreï¼‰





#### len(channel)çš„åº”ç”¨





### 33.4 nil channelçš„å¦™ç”¨

å¦‚æœä¸€ä¸ªchannelç±»å‹å˜é‡çš„å€¼ä¸ºnilï¼Œç§°å®ƒä¸º**nil channel**ã€‚nil channelæœ‰ä¸€ä¸ªç‰¹æ€§ï¼Œé‚£å°±æ˜¯**å¯¹nil channelçš„è¯»å†™éƒ½ä¼šå‘ç”Ÿé˜»å¡**ã€‚



### 33.5 ä¸selectç»“åˆä½¿ç”¨çš„ä¸€äº›æƒ¯ç”¨æ³•

#### ç¬¬ä¸€ç§ç”¨æ³•ï¼šåˆ©ç”¨defaultåˆ†æ”¯é¿å…é˜»å¡



#### ç¬¬äºŒç§ç”¨æ³•ï¼šå®ç°è¶…æ—¶æœºåˆ¶



#### ç¬¬ä¸‰ç§ç”¨æ³•ï¼šå®ç°å¿ƒè·³æœºåˆ¶



## 34 å¹¶å‘ï¼šå¦‚ä½•ä½¿ç”¨å…±äº«å˜é‡ï¼Ÿ

> Rob Pikeï¼šâ€œä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œåº”è¯¥é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ï¼ˆDonâ€™t communicate by sharing memory, share memory by communicatingï¼‰â€

Goä¸»æµé£æ ¼ï¼š**ä½¿ç”¨channelè¿›è¡Œä¸åŒGoroutineé—´çš„é€šä¿¡**ã€‚

ä¸è¿‡ï¼ŒGoä¹Ÿå¹¶æ²¡æœ‰å½»åº•æ”¾å¼ƒåŸºäºå…±äº«å†…å­˜çš„å¹¶å‘æ¨¡å‹ï¼Œè€Œæ˜¯åœ¨æä¾›CSPå¹¶å‘æ¨¡å‹åŸè¯­çš„åŒæ—¶ï¼Œè¿˜é€šè¿‡æ ‡å‡†åº“çš„syncåŒ…ï¼Œæä¾›äº†é’ˆå¯¹ä¼ ç»Ÿçš„ã€åŸºäºå…±äº«å†…å­˜å¹¶å‘æ¨¡å‹çš„ä½çº§åŒæ­¥åŸè¯­ï¼ŒåŒ…æ‹¬ï¼šäº’æ–¥é”ï¼ˆ`sync.Mutex`ï¼‰ã€è¯»å†™é”ï¼ˆsync.RWMutexï¼‰ã€æ¡ä»¶å˜é‡ï¼ˆ`sync.Cond`ï¼‰ç­‰ï¼Œå¹¶é€šè¿‡atomicåŒ…æä¾›äº†åŸå­æ“ä½œåŸè¯­ç­‰ç­‰ã€‚

### syncåŒ…ä½çº§åŒæ­¥åŸè¯­å¯ä»¥ç”¨åœ¨å“ªï¼Ÿ

- é¦–å…ˆæ˜¯éœ€è¦é«˜æ€§èƒ½çš„ä¸´ç•ŒåŒºï¼ˆcritical sectionï¼‰åŒæ­¥æœºåˆ¶åœºæ™¯ã€‚
- ç¬¬äºŒç§å°±æ˜¯åœ¨ä¸æƒ³è½¬ç§»ç»“æ„ä½“å¯¹è±¡æ‰€æœ‰æƒï¼Œä½†åˆè¦ä¿è¯ç»“æ„ä½“å†…éƒ¨çŠ¶æ€æ•°æ®çš„åŒæ­¥è®¿é—®çš„åœºæ™¯ã€‚

### syncåŒ…ä¸­åŒæ­¥åŸè¯­ä½¿ç”¨çš„æ³¨æ„äº‹é¡¹



### äº’æ–¥é”ï¼ˆMutexï¼‰è¿˜æ˜¯è¯»å†™é”ï¼ˆRWMutexï¼‰ï¼Ÿ



### æ¡ä»¶å˜é‡



### åŸå­æ“ä½œï¼ˆatomic operationsï¼‰





### å°ç»“

å¦‚æœè€ƒè™‘ä½¿ç”¨ä½çº§åŒæ­¥åŸè¯­ï¼Œä¸€èˆ¬éƒ½æ˜¯å› ä¸ºä½çº§åŒæ­¥åŸè¯­å¯ä»¥æä¾›**æ›´ä½³çš„æ€§èƒ½è¡¨ç°**ï¼Œæ€§èƒ½åŸºå‡†æµ‹è¯•ç»“æœå‘Šè¯‰æˆ‘ä»¬ï¼Œä½¿ç”¨ä½çº§åŒæ­¥åŸè¯­çš„æ€§èƒ½å¯ä»¥é«˜å‡ºchannelè®¸å¤šå€ã€‚åœ¨æ€§èƒ½æ•æ„Ÿçš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ä¾ç„¶ç¦»ä¸å¼€è¿™äº›ä½çº§åŒæ­¥åŸè¯­ã€‚

åœ¨ä½¿ç”¨syncåŒ…æä¾›çš„åŒæ­¥åŸè¯­ä¹‹å‰ï¼Œä¸€å®šè¦ç‰¢è®°è¿™äº›åŸè¯­ä½¿ç”¨çš„æ³¨æ„äº‹é¡¹ï¼š**ä¸è¦å¤åˆ¶é¦–æ¬¡ä½¿ç”¨åçš„Mutex/RWMutex/Condç­‰**ã€‚ä¸€æ—¦å¤åˆ¶ï¼Œä½ å°†å¾ˆå¤§å¯èƒ½å¾—åˆ°æ„æ–™ä¹‹å¤–çš„è¿è¡Œç»“æœã€‚

syncåŒ…ä¸­çš„ä½çº§åŒæ­¥åŸè¯­å„æœ‰å„çš„æ“…é•¿é¢†åŸŸï¼š

- åœ¨å…·æœ‰ä¸€å®šå¹¶å‘é‡ä¸”è¯»å¤šå†™å°‘çš„åœºåˆä½¿ç”¨RWMutexï¼›
- åœ¨éœ€è¦â€œç­‰å¾…æŸä¸ªæ¡ä»¶æˆç«‹â€çš„åœºæ™¯ä¸‹ä½¿ç”¨Condï¼›
- å½“ä½ ä¸ç¡®å®šä½¿ç”¨ä»€ä¹ˆåŸè¯­æ—¶ï¼Œé‚£å°±ä½¿ç”¨Mutexå§ã€‚

å¦‚æœä½ å¯¹åŒæ­¥çš„æ€§èƒ½æœ‰æè‡´è¦æ±‚ï¼Œä¸”å¹¶å‘é‡è¾ƒå¤§ï¼Œè¯»å¤šå†™å°‘ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä¸€ä¸‹atomicåŒ…æä¾›çš„åŸå­æ“ä½œå‡½æ•°ã€‚





## 35 å³å­¦å³ç»ƒï¼šå¦‚ä½•å®ç°ä¸€ä¸ªè½»é‡çº§çº¿ç¨‹æ± ï¼Ÿ

### ä¸ºä»€ä¹ˆè¦ç”¨åˆ°Goroutineæ± ï¼Ÿ

**Goroutineçš„å¼€é”€è™½ç„¶â€œå»‰ä»·â€ï¼Œä½†ä¹Ÿä¸æ˜¯å…è´¹çš„**ã€‚

æœ€æ˜æ˜¾çš„ï¼Œä¸€æ—¦è§„æ¨¡åŒ–åï¼Œè¿™ç§éé›¶æˆæœ¬ä¹Ÿä¼šæˆä¸ºç“¶é¢ˆã€‚æˆ‘ä»¬ä»¥ä¸€ä¸ªGoroutineåˆ†é…2KBæ‰§è¡Œæ ˆä¸ºä¾‹ï¼Œ100w Goroutineå°±æ˜¯2GBçš„å†…å­˜æ¶ˆè€—ã€‚

å…¶æ¬¡ï¼ŒGoroutineä»[Go 1.4ç‰ˆæœ¬](https://go.dev/doc/go1.4)å¼€å§‹é‡‡ç”¨äº†è¿ç»­æ ˆçš„æ–¹æ¡ˆï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªGoroutineçš„æ‰§è¡Œæ ˆéƒ½æ˜¯ä¸€å—è¿ç»­å†…å­˜ï¼Œå¦‚æœç©ºé—´ä¸è¶³ï¼Œè¿è¡Œæ—¶ä¼šåˆ†é…ä¸€ä¸ªæ›´å¤§çš„è¿ç»­å†…å­˜ç©ºé—´ä½œä¸ºè¿™ä¸ªGoroutineçš„æ‰§è¡Œæ ˆï¼Œå°†åŸæ ˆå†…å®¹æ‹·è´åˆ°æ–°åˆ†é…çš„ç©ºé—´ä¸­æ¥ã€‚

è¿ç»­æ ˆçš„æ–¹æ¡ˆï¼Œè™½ç„¶èƒ½é¿å…Go 1.3é‡‡ç”¨çš„åˆ†æ®µæ ˆä¼šå¯¼è‡´çš„[â€œhot splitâ€é—®é¢˜](https://docs.google.com/document/d/1wAaf1rYoM4S4gtnPh0zOlGzWtrZFQ5suE8qr2sD8uWQ/pub)ï¼Œä½†è¿ç»­æ ˆçš„åŸç†ä¹Ÿå†³å®šäº†ï¼Œä¸€æ—¦Goroutineçš„æ‰§è¡Œæ ˆå‘ç”Ÿäº†growï¼Œé‚£ä¹ˆå³ä¾¿è¿™ä¸ªGoroutineä¸å†éœ€è¦é‚£ä¹ˆå¤§çš„æ ˆç©ºé—´ï¼Œè¿™ä¸ªGoroutineçš„æ ˆç©ºé—´ä¹Ÿä¸ä¼šè¢«Shrinkï¼ˆæ”¶ç¼©ï¼‰äº†ï¼Œè¿™äº›ç©ºé—´å¯èƒ½ä¼šå¤„äºé•¿æ—¶é—´é—²ç½®çš„çŠ¶æ€ï¼Œç›´åˆ°Goroutineé€€å‡ºã€‚

å¦å¤–ï¼Œéšç€Goroutineæ•°é‡çš„å¢åŠ ï¼ŒGoè¿è¡Œæ—¶è¿›è¡ŒGoroutineè°ƒåº¦çš„å¤„ç†å™¨æ¶ˆè€—ï¼Œä¹Ÿä¼šéšä¹‹å¢åŠ ï¼Œæˆä¸ºé˜»ç¢Goåº”ç”¨æ€§èƒ½æå‡çš„é‡è¦å› ç´ ã€‚



é¢å¯¹è¿™æ ·çš„é—®é¢˜ï¼ŒGoroutineæ± å°±æ˜¯ä¸€ç§å¸¸è§çš„è§£å†³æ–¹æ¡ˆã€‚è¿™ä¸ªæ–¹æ¡ˆçš„æ ¸å¿ƒæ€æƒ³æ˜¯å¯¹Goroutineçš„é‡ç”¨ï¼Œä¹Ÿå°±æ˜¯æŠŠMä¸ªè®¡ç®—ä»»åŠ¡è°ƒåº¦åˆ°Nä¸ªGoroutineä¸Šï¼Œè€Œä¸æ˜¯ä¸ºæ¯ä¸ªè®¡ç®—ä»»åŠ¡åˆ†é…ä¸€ä¸ªç‹¬äº«çš„Goroutineï¼Œä»è€Œæé«˜è®¡ç®—èµ„æºçš„åˆ©ç”¨ç‡ã€‚



### workerpoolçš„å®ç°åŸç†

é‡‡ç”¨å®Œå…¨åŸºäºchannel+selectçš„å®ç°æ–¹æ¡ˆï¼Œä¸ä½¿ç”¨å…¶ä»–æ•°æ®ç»“æ„ï¼Œä¹Ÿä¸ä½¿ç”¨syncåŒ…æä¾›çš„å„ç§åŒæ­¥ç»“æ„

workerpoolçš„å®ç°ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š

- poolçš„åˆ›å»ºä¸é”€æ¯ï¼›
- poolä¸­workerï¼ˆGoroutineï¼‰çš„ç®¡ç†ï¼›
- taskçš„æäº¤ä¸è°ƒåº¦ã€‚

![](images/image-20240729115211470.png)

capacityæ˜¯poolçš„ä¸€ä¸ªå±æ€§ï¼Œä»£è¡¨æ•´ä¸ªpoolä¸­workerçš„æœ€å¤§å®¹é‡ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå¸¦ç¼“å†²çš„channelï¼šactiveï¼Œä½œä¸ºworkerçš„â€œè®¡æ•°å™¨â€ï¼Œè¿™ç§channelä½¿ç”¨æ¨¡å¼å°±æ˜¯[33]()ä¸­çš„**è®¡æ•°ä¿¡å·é‡**ã€‚

å½“active channelå¯å†™æ—¶ï¼Œæˆ‘ä»¬å°±åˆ›å»ºä¸€ä¸ªworkerï¼Œç”¨äºå¤„ç†ç”¨æˆ·é€šè¿‡Scheduleå‡½æ•°æäº¤çš„å¾…å¤„ç†çš„è¯·æ±‚ã€‚å½“active channelæ»¡äº†çš„æ—¶å€™ï¼Œpoolå°±ä¼šåœæ­¢workerçš„åˆ›å»ºï¼Œç›´åˆ°æŸä¸ªworkerå› æ•…é€€å‡ºï¼Œactive channelåˆç©ºå‡ºä¸€ä¸ªä½ç½®æ—¶ï¼Œpoolæ‰ä¼šåˆ›å»ºæ–°çš„workerå¡«è¡¥é‚£ä¸ªç©ºä½ã€‚

è¿™å¼ å›¾é‡Œï¼Œæˆ‘ä»¬æŠŠç”¨æˆ·è¦æäº¤ç»™workerpoolæ‰§è¡Œçš„è¯·æ±‚æŠ½è±¡ä¸ºä¸€ä¸ªTaskã€‚Taskçš„æäº¤ä¸è°ƒåº¦ä¹Ÿå¾ˆç®€å•ï¼šTaské€šè¿‡Scheduleå‡½æ•°æäº¤åˆ°ä¸€ä¸ªtask channelä¸­ï¼Œå·²ç»åˆ›å»ºçš„workerå°†ä»è¿™ä¸ªtask channelä¸­è¯»å–taskå¹¶æ‰§è¡Œã€‚



### workerpoolçš„ä¸€ä¸ªæœ€å°å¯è¡Œå®ç°



### æ·»åŠ åŠŸèƒ½é€‰é¡¹æœºåˆ¶









# å®æˆ˜ç¯‡ï¼šæ‰“é€šâ€œæœ€åä¸€å…¬é‡Œâ€

## 36 æ‰“ç¨³æ ¹åŸºï¼šæ€ä¹ˆå®ç°ä¸€ä¸ªTCPæœåŠ¡å™¨ï¼Ÿï¼ˆä¸Šï¼‰

![](images/image-20240704191921768.png)

### ä»€ä¹ˆæ˜¯ç½‘ç»œç¼–ç¨‹

åŸºäºTCPåè®®ï¼Œæˆ‘ä»¬å®ç°äº†å„ç§å„æ ·çš„æ»¡è¶³ç”¨æˆ·éœ€æ±‚çš„åº”ç”¨å±‚åè®®ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„HTTPåè®®å°±æ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ç§ï¼Œè€Œä¸”æ˜¯ä½¿ç”¨å¾—æœ€å¹¿æ³›çš„ä¸€ç§ã€‚è€ŒåŸºäºHTTPçš„Webç¼–ç¨‹å°±æ˜¯ä¸€ç§**é’ˆå¯¹åº”ç”¨å±‚çš„ç½‘ç»œç¼–ç¨‹**ã€‚æˆ‘ä»¬è¿˜å¯ä»¥**åŸºäºä¼ è¾“å±‚æš´éœ²ç»™å¼€å‘è€…çš„ç¼–ç¨‹æ¥å£ï¼Œå®ç°åº”ç”¨å±‚çš„è‡ªå®šä¹‰åº”ç”¨åè®®**ã€‚

ç›®å‰å„å¤§ä¸»æµæ“ä½œç³»ç»Ÿå¹³å°ä¸­ï¼Œæœ€å¸¸ç”¨çš„ä¼ è¾“å±‚æš´éœ²ç»™ç”¨æˆ·çš„ç½‘ç»œç¼–ç¨‹æ¥å£ï¼Œå°±æ˜¯==å¥—æ¥å­—ï¼ˆsocketï¼‰==ã€‚**ç›´æ¥åŸºäºsocketç¼–ç¨‹å®ç°åº”ç”¨å±‚é€šä¿¡ä¸šåŠ¡ï¼Œä¹Ÿæ˜¯æœ€å¸¸è§çš„ä¸€ç§ç½‘ç»œç¼–ç¨‹å½¢å¼ã€‚**

### é—®é¢˜æè¿°

> å®ç°ä¸€ä¸ªåŸºäºTCPçš„**è‡ªå®šä¹‰**åº”ç”¨å±‚åè®®çš„é€šä¿¡æœåŠ¡ç«¯ã€‚

åŸºäºTCPçš„è‡ªå®šä¹‰åº”ç”¨å±‚åè®®é€šå¸¸æœ‰ä¸¤ç§å¸¸è§çš„å®šä¹‰æ¨¡å¼ï¼š

- ==äºŒè¿›åˆ¶æ¨¡å¼==ï¼šé‡‡ç”¨é•¿åº¦å­—æ®µæ ‡è¯†ç‹¬ç«‹æ•°æ®åŒ…çš„è¾¹ç•Œã€‚é‡‡ç”¨è¿™ç§æ–¹å¼å®šä¹‰çš„å¸¸è§åè®®åŒ…æ‹¬**MQTT**ï¼ˆç‰©è”ç½‘æœ€å¸¸ç”¨çš„åº”ç”¨å±‚åè®®ä¹‹ä¸€ï¼‰ã€**SMPP**ï¼ˆçŸ­ä¿¡ç½‘å…³ç‚¹å¯¹ç‚¹æ¥å£åè®®ï¼‰ç­‰ï¼›
- ==æ–‡æœ¬æ¨¡å¼==ï¼šé‡‡ç”¨ç‰¹å®šåˆ†éš”ç¬¦æ ‡è¯†æµä¸­çš„æ•°æ®åŒ…çš„è¾¹ç•Œï¼Œå¸¸è§çš„åŒ…æ‹¬HTTPåè®®ç­‰ã€‚

ç›¸æ¯”ä¹‹ä¸‹ï¼ŒäºŒè¿›åˆ¶æ¨¡å¼è¦æ¯”æ–‡æœ¬æ¨¡å¼ç¼–ç æ›´ç´§å‡‘ä¹Ÿæ›´é«˜æ•ˆï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™ä¸ªé—®é¢˜ä¸­çš„è‡ªå®šä¹‰åè®®ä¹Ÿé‡‡ç”¨äº†äºŒè¿›åˆ¶æ¨¡å¼ï¼Œåè®®è§„èŒƒå†…å®¹å¦‚ä¸‹å›¾ï¼š

![](images/image-20240704192638336.png)

è¿™ä¸ªåè®®çš„é€šä¿¡ä¸¤ç«¯çš„é€šä¿¡æµç¨‹ï¼š

![](images/image-20240704192738073.png)

è€Œæˆ‘ä»¬çš„ä»»åŠ¡ï¼Œå°±æ˜¯å®ç°æ”¯æŒè¿™ä¸ªåè®®é€šä¿¡çš„æœåŠ¡ç«¯ã€‚

### TCP Socketç¼–ç¨‹æ¨¡å‹

å¸¸ç”¨çš„ç½‘ç»œI/Oæ¨¡å‹:

- é˜»å¡I/O(Blocking I/O)

![](images/image-20240704192907447.png)

- éé˜»å¡I/Oï¼ˆNon-Blocking I/Oï¼‰

![](images/image-20240704192928299.png)

- I/Oå¤šè·¯å¤ç”¨ï¼ˆI/O Multiplexingï¼‰

![](images/image-20240704192946825.png)

### Goè¯­è¨€socketç¼–ç¨‹æ¨¡å‹

### socketç›‘å¬ï¼ˆlistenï¼‰ä¸æ¥æ”¶è¿æ¥ï¼ˆacceptï¼‰

### å‘æœåŠ¡ç«¯å»ºç«‹TCPè¿æ¥

- ç¬¬ä¸€ç§æƒ…å†µï¼šç½‘ç»œä¸å¯è¾¾æˆ–å¯¹æ–¹æœåŠ¡æœªå¯åŠ¨ã€‚
- ç¬¬äºŒç§æƒ…å†µï¼šå¯¹æ–¹æœåŠ¡çš„listen backlogé˜Ÿåˆ—æ»¡ã€‚
- ç¬¬ä¸‰ç§æƒ…å†µï¼šè‹¥ç½‘ç»œå»¶è¿Ÿè¾ƒå¤§ï¼ŒDialå°†é˜»å¡å¹¶è¶…æ—¶ã€‚

### å…¨åŒå·¥é€šä¿¡

### Socketè¯»æ“ä½œ

- é¦–å…ˆæ˜¯Socketä¸­æ— æ•°æ®çš„åœºæ™¯ã€‚
- ç¬¬äºŒç§æƒ…å†µæ˜¯Socketä¸­æœ‰éƒ¨åˆ†æ•°æ®ã€‚
- ç¬¬ä¸‰ç§æƒ…å†µæ˜¯Socketä¸­æœ‰è¶³å¤Ÿæ•°æ®ã€‚
- æœ€åä¸€ç§æƒ…å†µæ˜¯è®¾ç½®è¯»æ“ä½œè¶…æ—¶ã€‚

### Socketå†™æ“ä½œ

- ç¬¬ä¸€ç§æƒ…å†µï¼šå†™é˜»å¡ã€‚
- ç¬¬äºŒç§æƒ…å†µï¼šå†™å…¥éƒ¨åˆ†æ•°æ®ã€‚
- ç¬¬ä¸‰ç§æƒ…å†µï¼šå†™å…¥è¶…æ—¶ã€‚

### å¹¶å‘Socketè¯»å†™

### Socketå…³é—­

## 37 ä»£ç æ“ç»ƒï¼šæ€ä¹ˆå®ç°ä¸€ä¸ªTCPæœåŠ¡å™¨ï¼Ÿï¼ˆä¸­ï¼‰

### 1 å»ºç«‹å¯¹åè®®çš„æŠ½è±¡

#### æ·±å…¥åè®®å­—æ®µ

#### å»ºç«‹Frameå’ŒPacketæŠ½è±¡

### 2 åè®®çš„è§£åŒ…ä¸æ‰“åŒ…

#### Frameçš„å®ç°

#### Packetçš„å®ç°

### 3 æœåŠ¡ç«¯çš„ç»„è£…

### 4 éªŒè¯æµ‹è¯•

## 38 æˆæœä¼˜åŒ–ï¼šæ€ä¹ˆå®ç°ä¸€ä¸ªTCPæœåŠ¡å™¨ï¼Ÿï¼ˆä¸‹ï¼‰

### 1 Goç¨‹åºä¼˜åŒ–çš„åŸºæœ¬å¥—è·¯

Goç¨‹åºçš„ä¼˜åŒ–ï¼Œä¹Ÿæœ‰ç€å›ºå®šçš„å¥—è·¯å¯å¾ª:

![](images/image-20240704193459259.png)

- é¦–å…ˆæˆ‘ä»¬è¦å»ºç«‹æ€§èƒ½åŸºå‡†ã€‚è¦æƒ³å¯¹ç¨‹åºå®æ–½ä¼˜åŒ–ï¼Œæˆ‘ä»¬é¦–å…ˆè¦æœ‰ä¸€ä¸ªåˆå§‹â€œå‚ç…§ç‰©â€ï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½åœ¨æ‰§è¡Œä¼˜åŒ–æªæ–½åï¼Œæ£€éªŒä¼˜åŒ–æªæ–½æ˜¯å¦æœ‰æ•ˆï¼Œæ‰€ä»¥è¿™æ˜¯ä¼˜åŒ–å¾ªç¯çš„ç¬¬ä¸€æ­¥ã€‚
- ç¬¬äºŒæ­¥æ˜¯æ€§èƒ½å‰–æã€‚è¦æƒ³ä¼˜åŒ–ç¨‹åºï¼Œæˆ‘ä»¬é¦–å…ˆè¦æ‰¾åˆ°å¯èƒ½å½±å“ç¨‹åºæ€§èƒ½çš„â€œç“¶é¢ˆç‚¹â€ï¼Œè¿™ä¸€æ­¥çš„ä»»åŠ¡ï¼Œå°±æ˜¯é€šè¿‡å„ç§å·¥å…·å’Œæ–¹æ³•æ‰¾åˆ°è¿™äº›â€œç“¶é¢ˆç‚¹â€ã€‚
- ç¬¬ä¸‰æ­¥æ˜¯ä»£ç ä¼˜åŒ–ã€‚æˆ‘ä»¬è¦é’ˆå¯¹ä¸Šä¸€æ­¥æ‰¾åˆ°çš„â€œç“¶é¢ˆç‚¹â€è¿›è¡Œåˆ†æï¼Œæ‰¾å‡ºå®ƒä»¬æˆä¸ºç“¶é¢ˆçš„åŸå› ï¼Œå¹¶æœ‰é’ˆå¯¹æ€§åœ°å®æ–½ä¼˜åŒ–ã€‚
- ç¬¬å››æ­¥æ˜¯ä¸åŸºå‡†æ¯”è¾ƒï¼Œç¡®å®šä¼˜åŒ–æ•ˆæœã€‚è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬ä¼šé‡‡é›†ä¼˜åŒ–åçš„ç¨‹åºçš„æ€§èƒ½æ•°æ®ï¼Œä¸ç¬¬ä¸€æ­¥çš„æ€§èƒ½åŸºå‡†è¿›è¡Œæ¯”è¾ƒï¼Œçœ‹æ‰§è¡Œä¸Šè¿°çš„ä¼˜åŒ–æªæ–½åï¼Œæ˜¯å¦æå‡äº†ç¨‹åºçš„æ€§èƒ½ã€‚

### 2 å»ºç«‹æ€§èƒ½åŸºå‡†

#### å»ºç«‹è§‚æµ‹è®¾æ–½

#### é…ç½®Grafana

#### åœ¨æœåŠ¡ç«¯åŸ‹å…¥åº¦é‡æ•°æ®é‡‡é›†ç‚¹

å“ªäº›åº¦é‡æ•°æ®èƒ½åæ˜ å‡ºæœåŠ¡ç«¯çš„æ€§èƒ½æŒ‡æ ‡å‘¢ï¼Ÿ

- å½“å‰å·²è¿æ¥çš„å®¢æˆ·ç«¯æ•°é‡ï¼ˆclient_connectedï¼‰ï¼›
- æ¯ç§’æ¥æ”¶æ¶ˆæ¯è¯·æ±‚çš„æ•°é‡ï¼ˆreq_recv_rateï¼‰ï¼›
- æ¯ç§’å‘é€æ¶ˆæ¯å“åº”çš„æ•°é‡ï¼ˆrsp_send_rateï¼‰ã€‚

#### ç¬¬ä¸€ç‰ˆæ€§èƒ½åŸºå‡†

### 3 å°è¯•ç”¨pprofå‰–æ

### 4 ä»£ç ä¼˜åŒ–

#### å¸¦ç¼“å­˜çš„ç½‘ç»œI/O

#### é‡ç”¨å†…å­˜å¯¹è±¡

# æ³›å‹ç¯‡

## Goæ³›å‹è¯ç”Ÿè¿‡ç¨‹

[Go 1.18 Beta2ç‰ˆæœ¬](https://go.dev/blog/go1.18beta2)

### ä¸ºä»€ä¹ˆè¦åŠ å…¥æ³›å‹ï¼Ÿ

[ç»´åŸºç™¾ç§‘-æ³›å‹ç¼–ç¨‹](https://en.wikipedia.org/wiki/Generic_programming)ï¼Œæœ€åˆæ³›å‹ç¼–ç¨‹æ¦‚å¿µçš„æ–‡ç« ä¸­ç»™äº†è§£é‡Šï¼šâ€œ**æ³›å‹ç¼–ç¨‹çš„ä¸­å¿ƒæ€æƒ³æ˜¯å¯¹å…·ä½“çš„ã€é«˜æ•ˆçš„ç®—æ³•è¿›è¡ŒæŠ½è±¡ï¼Œä»¥è·å¾—é€šç”¨çš„ç®—æ³•ï¼Œç„¶åè¿™äº›ç®—æ³•å¯ä»¥ä¸ä¸åŒçš„æ•°æ®è¡¨ç¤ºæ³•ç»“åˆèµ·æ¥ï¼Œäº§ç”Ÿå„ç§å„æ ·æœ‰ç”¨çš„è½¯ä»¶**â€ã€‚

å°†**ç®—æ³•ä¸ç±»å‹è§£è€¦**

### Goæ³›å‹è®¾è®¡çš„ç®€å²



### Goæ³›å‹çš„åŸºæœ¬è¯­æ³•

#### ç±»å‹å‚æ•°ï¼ˆtype parameterï¼‰

ç±»å‹å‚æ•°æ˜¯åœ¨å‡½æ•°å£°æ˜ã€æ–¹æ³•å£°æ˜çš„receiveréƒ¨åˆ†æˆ–ç±»å‹å®šä¹‰çš„ç±»å‹å‚æ•°åˆ—è¡¨ä¸­ï¼Œå£°æ˜çš„ï¼ˆéé™å®šï¼‰ç±»å‹åç§°ã€‚ç±»å‹å‚æ•°åœ¨å£°æ˜ä¸­å……å½“äº†ä¸€ä¸ªæœªçŸ¥ç±»å‹çš„å ä½ç¬¦ï¼ˆplaceholderï¼‰ï¼Œåœ¨æ³›å‹å‡½æ•°æˆ–æ³›å‹ç±»å‹å®ä¾‹åŒ–æ—¶ï¼Œç±»å‹å‚æ•°ä¼šè¢«ä¸€ä¸ªç±»å‹å®å‚æ›¿æ¢ã€‚



#### çº¦æŸï¼ˆconstraintï¼‰

çº¦æŸï¼ˆconstraintï¼‰è§„å®šäº†ä¸€ä¸ªç±»å‹å®å‚ï¼ˆtype argumentï¼‰å¿…é¡»æ»¡è¶³çš„æ¡ä»¶è¦æ±‚ã€‚å¦‚æœæŸä¸ªç±»å‹æ»¡è¶³äº†æŸä¸ªçº¦æŸè§„å®šçš„æ‰€æœ‰æ¡ä»¶è¦æ±‚ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯è¿™ä¸ªçº¦æŸä¿®é¥°çš„ç±»å‹å½¢å‚çš„ä¸€ä¸ªåˆæ³•çš„ç±»å‹å®å‚ã€‚



#### ç±»å‹å…·åŒ–ï¼ˆinstantiationï¼‰

#### æ³›å‹ç±»å‹



### Goæ³›å‹çš„æ€§èƒ½



### Goæ³›å‹çš„ä½¿ç”¨å»ºè®®

ä»€ä¹ˆæƒ…å†µé€‚åˆä½¿ç”¨æ³›å‹
ä»€ä¹ˆæƒ…å†µä¸å®œä½¿ç”¨æ³›å‹





## 39 ç±»å‹å‚æ•°

Goçš„æ³›å‹ä¸å…¶ä»–ä¸»æµç¼–ç¨‹è¯­è¨€çš„æ³›å‹ä¸åŒç‚¹ï¼ˆ[ä¸æ”¯æŒçš„è‹¥å¹²ç‰¹æ€§](https://github.com/golang/proposal/blob/master/design/43651-type-parameters.md#omissions)ï¼‰ï¼š

- **ä¸æ”¯æŒæ³›å‹ç‰¹åŒ–ï¼ˆspecializationï¼‰**ï¼Œå³ä¸æ”¯æŒç¼–å†™ä¸€ä¸ªæ³›å‹å‡½æ•°é’ˆå¯¹æŸä¸ªå…·ä½“ç±»å‹çš„ç‰¹æ®Šç‰ˆæœ¬ï¼›
- **ä¸æ”¯æŒå…ƒç¼–ç¨‹ï¼ˆmetaprogrammingï¼‰**ï¼Œå³ä¸æ”¯æŒç¼–å†™åœ¨ç¼–è¯‘æ—¶æ‰§è¡Œçš„ä»£ç æ¥ç”Ÿæˆåœ¨è¿è¡Œæ—¶æ‰§è¡Œçš„ä»£ç ï¼›
- **ä¸æ”¯æŒæ“ä½œç¬¦æ–¹æ³•ï¼ˆoperator methodï¼‰**ï¼Œå³åªèƒ½ç”¨æ™®é€šçš„æ–¹æ³•ï¼ˆmethodï¼‰æ“ä½œç±»å‹å®ä¾‹ï¼ˆæ¯”å¦‚ï¼šgetIndex(k)ï¼‰ï¼Œè€Œä¸èƒ½å°†æ“ä½œç¬¦è§†ä¸ºæ–¹æ³•å¹¶è‡ªå®šä¹‰å…¶å®ç°ï¼Œæ¯”å¦‚ä¸€ä¸ªå®¹å™¨ç±»å‹çš„ä¸‹æ ‡è®¿é—®c[k]ï¼›
- **ä¸æ”¯æŒå˜é•¿çš„ç±»å‹å‚æ•°ï¼ˆtype parametersï¼‰**ï¼›
- â€¦



### ä¾‹å­ï¼šè¿”å›åˆ‡ç‰‡ä¸­å€¼æœ€å¤§çš„å…ƒç´ 



Goè¯­è¨€æä¾›çš„anyï¼ˆinterface{}çš„åˆ«åï¼‰

### ç±»å‹å‚æ•°ï¼ˆtype parametersï¼‰

#### æ³›å‹å‡½æ•°

è°ƒç”¨æ³›å‹å‡½æ•°
æ³›å‹å‡½æ•°å®ä¾‹åŒ–ï¼ˆinstantiationï¼‰

#### æ³›å‹ç±»å‹

ä½¿ç”¨æ³›å‹ç±»å‹
æ³›å‹æ–¹æ³•



## 40 å®šä¹‰æ³›å‹çº¦æŸ

è™½ç„¶æ³›å‹æ˜¯å¼€å‘äººå‘˜è¡¨è¾¾â€œé€šç”¨ä»£ç â€çš„ä¸€ç§é‡è¦æ–¹å¼ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€æ‰€æœ‰æ³›å‹ä»£ç å¯¹æ‰€æœ‰ç±»å‹éƒ½é€‚ç”¨ã€‚æ›´å¤šçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ³›å‹å‡½æ•°çš„ç±»å‹å‚æ•°ä»¥åŠæ³›å‹å‡½æ•°ä¸­çš„å®ç°ä»£ç **è®¾ç½®é™åˆ¶**ã€‚æ³›å‹å‡½æ•°è°ƒç”¨è€…åªèƒ½ä¼ é€’æ»¡è¶³é™åˆ¶æ¡ä»¶çš„ç±»å‹å®å‚ï¼Œæ³›å‹å‡½æ•°å†…éƒ¨ä¹Ÿåªèƒ½ä»¥ç±»å‹å‚æ•°å…è®¸çš„æ–¹å¼ä½¿ç”¨è¿™äº›ç±»å‹å®å‚å€¼ã€‚åœ¨Goæ³›å‹è¯­æ³•ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨**ç±»å‹å‚æ•°çº¦æŸ**ï¼ˆtype parameter constraintï¼‰ï¼ˆä»¥ä¸‹ç®€ç§°**çº¦æŸ**ï¼‰æ¥è¡¨è¾¾è¿™ç§é™åˆ¶æ¡ä»¶ã€‚

çº¦æŸä¹‹äºç±»å‹å‚æ•°å°±å¥½æ¯”å‡½æ•°å‚æ•°åˆ—è¡¨ä¸­çš„ç±»å‹ä¹‹äºå‚æ•°ï¼š

![](images/image-20240721151712110.png)

### æœ€å®½æ¾çš„çº¦æŸï¼šany



### æ”¯æŒæ¯”è¾ƒæ“ä½œçš„å†…ç½®çº¦æŸï¼šcomparable



### è‡ªå®šä¹‰çº¦æŸ



### ç±»å‹é›†åˆï¼ˆtype setï¼‰

![](images/image-20240721152001159.png)



![](images/image-20240721152035052.png)

### ç®€åŒ–ç‰ˆçš„çº¦æŸå½¢å¼



### çº¦æŸçš„ç±»å‹æ¨æ–­



## 41 æ˜ç¡®ä½¿ç”¨æ—¶æœº

### ä½•æ—¶é€‚åˆä½¿ç”¨æ³›å‹ï¼Ÿ

#### åœºæ™¯ä¸€ï¼šç¼–å†™é€šç”¨æ•°æ®ç»“æ„æ—¶

#### åœºæ™¯äºŒï¼šå‡½æ•°æ“ä½œçš„æ˜¯GoåŸç”Ÿçš„å®¹å™¨ç±»å‹æ—¶

#### åœºæ™¯ä¸‰ï¼šä¸åŒç±»å‹å®ç°ä¸€äº›æ–¹æ³•çš„é€»è¾‘ç›¸åŒæ—¶



### Goæ³›å‹å®ç°åŸç†ç®€ä»‹

#### Stencilingæ–¹æ¡ˆ

#### Dictionariesæ–¹æ¡ˆ

#### Goæœ€ç»ˆé‡‡ç”¨çš„æ–¹æ¡ˆï¼šGC Shape Stencilingæ–¹æ¡ˆ



### æ³›å‹å¯¹æ‰§è¡Œæ•ˆç‡çš„å½±å“



# è¡¥å……

## å¦‚ä½•æ‹‰å–ç§æœ‰çš„GoModuleï¼Ÿ

### å¯¼å…¥æœ¬åœ°module



### æ‹‰å–ç§æœ‰moduleçš„éœ€æ±‚ä¸å‚è€ƒæ–¹æ¡ˆ

#### ç¬¬ä¸€ä¸ªæ–¹æ¡ˆæ˜¯é€šè¿‡ç›´è¿ç»„ç»‡å…¬å¸å†…éƒ¨çš„ç§æœ‰Go ModuleæœåŠ¡å™¨æ‹‰å–ã€‚

#### ç¬¬äºŒç§æ–¹æ¡ˆï¼Œæ˜¯å°†å¤–éƒ¨Go Moduleä¸ç§æœ‰Go Moduleéƒ½äº¤ç»™å†…éƒ¨ç»Ÿä¸€çš„GOPROXYæœåŠ¡å»å¤„ç†ï¼š



### ç»Ÿä¸€Goproxyæ–¹æ¡ˆçš„å®ç°æ€è·¯ä¸æ­¥éª¤

#### é€‰æ‹©ä¸€ä¸ªGOPROXYå®ç°

#### è‡ªå®šä¹‰åŒ…å¯¼å…¥è·¯å¾„å¹¶å°†å…¶æ˜ å°„åˆ°å†…éƒ¨çš„vcsä»“åº“

#### å¼€å‘æœº(å®¢æˆ·ç«¯)çš„è®¾ç½®

#### æ–¹æ¡ˆçš„â€œä¸è¶³â€

##### ç¬¬ä¸€ç‚¹ï¼šå¼€å‘è€…è¿˜æ˜¯éœ€è¦é¢å¤–é…ç½®GONOSUMDBå˜é‡ã€‚

###### ç¬¬äºŒç‚¹ï¼šæ–°å¢ç§æœ‰Go Moduleï¼Œvanity.yamléœ€è¦æ‰‹å·¥åŒæ­¥æ›´æ–°ã€‚

###### ç¬¬ä¸‰ç‚¹ï¼šæ— æ³•åˆ’åˆ†æƒé™ã€‚







## ä½œä¸ºGoModuleçš„ä½œè€…ï¼Œä½ åº”è¯¥çŸ¥é“çš„å‡ ä»¶äº‹

### ä»“åº“å¸ƒå±€ï¼šæ˜¯å•moduleè¿˜æ˜¯å¤šmodule

### å‘å¸ƒGo Module

### ä½œåºŸç‰¹å®šç‰ˆæœ¬çš„Go Module

#### ä¿®å¤brokenç‰ˆæœ¬å¹¶é‡æ–°å‘å¸ƒ

#### å‘å¸ƒmoduleçš„æ–°patchç‰ˆæœ¬



### å‡çº§moduleçš„majorç‰ˆæœ¬å·

#### ç¬¬ä¸€ç§æƒ…å†µï¼šrepoä¸‹çš„æ‰€æœ‰moduleç»Ÿä¸€è¿›è¡Œç‰ˆæœ¬å‘å¸ƒã€‚

#### ç¬¬äºŒä¸ªæƒ…å†µï¼šrepoä¸‹çš„moduleå„è‡ªç‹¬ç«‹è¿›è¡Œç‰ˆæœ¬å‘å¸ƒã€‚



## GoæŒ‡é’ˆ

### ä»€ä¹ˆæ˜¯æŒ‡é’ˆç±»å‹

**å¦‚æœæˆ‘ä»¬æ‹¥æœ‰ä¸€ä¸ªç±»å‹Tï¼Œé‚£ä¹ˆä»¥Tä½œä¸ºåŸºç±»å‹çš„æŒ‡é’ˆç±»å‹ä¸º\*T**ã€‚

unsafe.Pointerç±»ä¼¼äºCè¯­è¨€ä¸­çš„void*ï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ªé€šç”¨æŒ‡é’ˆç±»å‹ï¼Œä¹Ÿå°±æ˜¯**ä»»ä½•æŒ‡é’ˆç±»å‹éƒ½å¯ä»¥æ˜¾å¼è½¬æ¢ä¸ºä¸€ä¸ªunsafe.Pointerï¼Œè€Œunsafe.Pointerä¹Ÿå¯ä»¥æ˜¾å¼è½¬æ¢ä¸ºä»»æ„æŒ‡é’ˆç±»å‹**ï¼Œå¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼š

```go
var p *T
var p1 = unsafe.Pointer(p) // ä»»æ„æŒ‡é’ˆç±»å‹æ˜¾å¼è½¬æ¢ä¸ºunsafe.Pointer
p = (*T)(p1)               // unsafe.Pointerä¹Ÿå¯ä»¥æ˜¾å¼è½¬æ¢ä¸ºä»»æ„æŒ‡é’ˆç±»å‹
```



### äºŒçº§æŒ‡é’ˆ



### Goä¸­çš„æŒ‡é’ˆç”¨é€”ä¸ä½¿ç”¨é™åˆ¶

#### é™åˆ¶ä¸€ï¼šé™åˆ¶äº†æ˜¾å¼æŒ‡é’ˆç±»å‹è½¬æ¢ã€‚

#### é™åˆ¶äºŒï¼šä¸æ”¯æŒæŒ‡é’ˆè¿ç®—ã€‚





## Goè¯­è¨€å­¦ä¹ èµ„æ–™







## æœªæ¥

![](images/image-20240704194647473.png)

å­—èŠ‚çš„å¼€æºç»„ç»‡ï¼šhttps://github.com/cloudwego
